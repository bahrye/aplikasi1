<script>
  /**
   * Manajer sederhana untuk melacak riwayat Undo/Redo
   */
  const undoManager = {
    history: [],
    historyIndex: -1,
    
    /**
     * @param {Array<Object>} changes - Array objek {input, oldValue, newValue}
     */
    pushState: function(changes) {
      if (!changes || changes.length === 0) return;
      
      // Hapus riwayat "redo" jika kita membuat perubahan baru
      if (this.historyIndex < this.history.length - 1) {
        this.history = this.history.slice(0, this.historyIndex + 1);
      }
      
      this.history.push(changes);
      this.historyIndex = this.history.length - 1;
      
      // Batasi riwayat agar tidak terlalu besar (opsional)
      if (this.history.length > 50) {
        this.history.shift();
        this.historyIndex--;
      }
    },
    
    clearHistory: function() {
      this.history = [];
      this.historyIndex = -1;
    },

    undo: function() {
      if (this.historyIndex < 0) return;
      isFormDirty = true; 
      
      const changes = this.history[this.historyIndex];
      const affectedSiswaIds = new Set();
      
      for (let i = changes.length - 1; i >= 0; i--) {
        const change = changes[i];
        change.input.value = change.oldValue;
        affectedSiswaIds.add(change.input.dataset.siswaId);
      }
      
      this.historyIndex--;
      this.triggerTotalUpdates(changes[0].input, affectedSiswaIds);
    },
    
    redo: function() {
      if (this.historyIndex >= this.history.length - 1) return;
      isFormDirty = true; 
      
      this.historyIndex++;
      const changes = this.history[this.historyIndex];
      const affectedSiswaIds = new Set();
      
      for (const change of changes) {
        change.input.value = change.newValue;
        affectedSiswaIds.add(change.input.dataset.siswaId);
      }
      
      this.triggerTotalUpdates(changes[0].input, affectedSiswaIds);
    },
    
    triggerTotalUpdates: function(anyInput, siswaIds) {
      const page = anyInput.closest('.container');
      
      if (page.id === 'halaman-input-nilai-detail') {
        const mapelCount = globalGridData.mapelList.length;
        siswaIds.forEach(siswaId => updateRowTotals(siswaId, mapelCount));
      } else if (page.id === 'halaman-input-rapor-detail') {
        const tabPane = anyInput.closest('.tab-content');
        const tipeNilai = (tabPane.id === 'tab-keterampilan-content') ? 'K' : 'P';
        const data = (tipeNilai === 'P') ? globalRaporData.P : globalRaporData.K;
        const mapelCount = data.mapelList.length;
        siswaIds.forEach(siswaId => updateRowTotalsRapor(siswaId, mapelCount, tipeNilai));
      }
    }
  };

  let jenjangBaseCache = '';
  let jenjangPilihanCache = '';
  const LAST_PAGE_KEY = 'lastVisitedPageId';
  let siswaTelahDiImport = false;
  let nilaiTelahDiUpload = false;
  let nilaiRaporTelahDiUpload = false; 
  let guruTelahDiImport = false;
  let globalSiswaList = [];
  let isSiswaOrderDirty = false;
  let globalKelasListCache = [];
  let globalBobotCache = null;
  let globalPreviewScores = [];
  // --- TAMBAHKAN INI ---
  let globalDonasiStatus = 'NONE';
  let globalDonasiDetail = {}; // Cache untuk detail (file url, alasan)
  // --- AKHIR TAMBAHAN ---
  let isMapelTipeDirty = false;
  let globalMapelList = [];
  let isMapelOrderDirty = false;
  let globalGridData = {
    siswaList: [],
    mapelList: [],
    nilaiData: {}
  };

  // --- TAMBAHKAN DUA BARIS DI BAWAH INI ---
  let globalNilaiGridCacheUM = null;
  let globalNilaiGridCachePraktek = null;
  // --- AKHIR TAMBAHAN ---

  // --- TAMBAHKAN BARIS DI BAWAH INI ---
  let globalNilaiRaporGridCache = new Map();
  // --- AKHIR TAMBAHAN ---

  let globalRaporData = {
    P: { siswaList: [], mapelList: [], nilaiData: {} },
    K: { siswaList: [], mapelList: [], nilaiData: {} },
    Rekap: { siswaList: [], mapelList: [], nilaiRekapData: {} }
  };

  let currentProsesToast = null;

  let isImpersonatingCache = false;
  let currentUserRole = ''
  let guruHasPraktek = false;
  let guruHasMadrasah = false;
  let globalAppUrl = '';

  // --- TAMBAHAN BARU ---
  let inactivityTimer = null;
  const INACTIVITY_TIMEOUT_MS = 3 * 60 * 60 * 1000; // 3 Jam
  // --- AKHIR TAMBAHAN BARU ---

  let originalButtonContent = new Map();

  let globalIjazahData = {
    siswaList: [],
    mapelList: [],
    dataUjian: {},
    dataRapor: {},
    dataIjazah: {}
  };

  let lastDashboardScrollPosition = 0;

  let showWeightedUjian = true;
  let showWeightedRapor = true;

  let globalPenempatanData = {
    siswaData: [],
    mapelList: [],
    guruList: [],
    mapelAssignments: []
  };
  let globalTaList = [];
  let globalDataSekolahCache = null;
  let globalSemesterCache = null;
  let globalPengaturanCetakCache = null;
  let isPenempatanSiswaDirty = false;
  let isPenempatanMapelDirty = false;

  let currentPenempatanTab = 'siswa';

  // --- TAMBAHKAN INI ---
  let isFormDirty = false;
  // --- AKHIR TAMBAHAN ---

  let globalSetTaData = []; // Cache lokal untuk data modal Set TA
  let isSetTaDirty = false;

  // --- [VARIABEL BARU UNTUK PAGINASI] ---
  let currentNilaiPage = 1;
  const ROWS_PER_PAGE = 50; // Batas aman render di HP
  // --------------------------------------

  function getToken() {
    return localStorage.getItem('sessionToken');
  }

  function handleKeyDown(e) {
    // Ctrl+Z untuk Undo
    if (e.ctrlKey && e.key === 'z') {
      e.preventDefault();
      undoManager.undo();
    }
    // Ctrl+Y atau Ctrl+Shift+Z untuk Redo
    if (e.ctrlKey && (e.key === 'y' || (e.shiftKey && e.key === 'Z'))) {
      e.preventDefault();
      undoManager.redo();
    }
  }

  function handlePasteEvent(e) {
    const anchorInput = e.target;
    
    if (!anchorInput || !anchorInput.classList.contains('input-nilai')) {
      return;
    }
    
    e.preventDefault();
    
    const pasteData = (e.clipboardData || window.clipboardData).getData('text');
    if (!pasteData) return;

    const dataRows = pasteData.replace(/\r/g, '').split('\n').map(row => row.split('\t'));
    
    const table = anchorInput.closest('.input-nilai-table');
    if (!table) return;

    const visibleRows = Array.from(table.querySelectorAll('tbody tr'));
    const visibleInputsGrid = visibleRows.map(row => Array.from(row.querySelectorAll('.input-nilai')));
    
    let anchorRowIndex = -1;
    let anchorColIndex = -1;
    
    for (let i = 0; i < visibleInputsGrid.length; i++) {
      const j = visibleInputsGrid[i].indexOf(anchorInput);
      if (j > -1) {
        anchorRowIndex = i;
        anchorColIndex = j;
        break;
      }
    }
    
    if (anchorRowIndex === -1) return; 
    
    const changes = [];
    const affectedSiswaIds = new Set();
    
    for (let i = 0; i < dataRows.length; i++) {
      const targetRowIndex = anchorRowIndex + i;
      
      if (!visibleInputsGrid[targetRowIndex]) break; 
      
      const dataCells = dataRows[i];
      
      for (let j = 0; j < dataCells.length; j++) {
        const targetColIndex = anchorColIndex + j;
        
        const targetInput = visibleInputsGrid[targetRowIndex][targetColIndex];
        if (!targetInput) break; 
        
        let newValue = dataCells[j].trim().replace(/[^\d]/g, ''); 
        
        if (newValue !== '') {
          let numValue = parseInt(newValue, 10);
          if (numValue > 100) numValue = 100; 
          if (numValue < 0) numValue = 0;   
          newValue = numValue.toString();
        }
        
        const oldValue = targetInput.value;
        
        if (oldValue !== newValue) {
          targetInput.value = newValue;
          changes.push({ input: targetInput, oldValue, newValue });
          affectedSiswaIds.add(targetInput.dataset.siswaId);
        }
      }
    }
    
    if (changes.length > 0) {
      undoManager.pushState(changes);
      isFormDirty = true;
    }
    
    const page = anchorInput.closest('.container');
    if (page.id === 'halaman-input-nilai-detail') {
      const mapelCount = globalGridData.mapelList.length;
      affectedSiswaIds.forEach(siswaId => updateRowTotals(siswaId, mapelCount));
    } else if (page.id === 'halaman-input-rapor-detail') {
      const tabPane = anchorInput.closest('.tab-content');
      const tipeNilai = (tabPane.id === 'tab-keterampilan-content') ? 'K' : 'P';
      const data = (tipeNilai === 'P') ? globalRaporData.P : globalRaporData.K;
      const mapelCount = data.mapelList.length;
      affectedSiswaIds.forEach(siswaId => updateRowTotalsRapor(siswaId, mapelCount, tipeNilai));
    }
  }

  /**
   * Menampilkan status loading di dalam tombol.
   * @param {HTMLElement} button Tombol yang akan diubah.
   * @param {string} loadingText Teks yang ditampilkan saat loading.
   */
  function setButtonLoading(button, loadingText = "Memproses...") {
    if (!button) return;
    
    // Simpan konten asli jika belum disimpan
    if (!originalButtonContent.has(button.id)) {
      originalButtonContent.set(button.id, button.innerHTML);
    }
    
    // Nonaktifkan tombol dan tambahkan class
    button.disabled = true;
    button.classList.add('loading');
    
    // Set konten loading baru
    button.innerHTML = `
      <span class="spinner-inline"></span>
      <span>${loadingText}</span>
    `;
  }

  /**
   * Mengembalikan tombol ke status semula.
   * @param {HTMLElement} button Tombol yang akan dikembalikan.
   */
  function resetButtonLoading(button) {
    if (!button) return;
    
    // Kembalikan konten asli
    if (originalButtonContent.has(button.id)) {
      button.innerHTML = originalButtonContent.get(button.id);
      originalButtonContent.delete(button.id);
    }
    
    // Aktifkan kembali
    button.disabled = false;
    button.classList.remove('loading');
  }

  // Salin dan GANTI fungsi showToast() Anda dengan yang ini
  function showToast(message, type = 'proses', duration = 4000) {
      const container = document.getElementById('global-toast-container');
      if (!container) return;

      let toast = null;
      let isRecycled = false;

      // --- PERUBAHAN LOGIKA DAUR ULANG DI SINI ---
      // 1. CEK APAKAH BISA RECYCLE
      if (currentProsesToast && document.body.contains(currentProsesToast)) {
          
          if (type === 'proses') {
            // Jika kita memanggil 'proses' dan 'proses' sudah ada -> RECYCLE
            toast = currentProsesToast;
            isRecycled = true;
          } else {
            // Jika kita memanggil 'sukses'/'gagal' TAPI 'proses' aktif:
            // JANGAN RECYCLE. BUAT TOAST BARU (Sesuai permintaan Anda)
            toast = document.createElement('div');
            attachSwipeListeners(toast);
            container.prepend(toast);
            isRecycled = false;
          }
          
      } else {
          // Jika tidak ada currentProsesToast yang aktif, buat baru (logika asli)
          toast = document.createElement('div');
          attachSwipeListeners(toast);
          container.prepend(toast);
      }
      // --- AKHIR PERUBAHAN ---

      // 2. UPDATE TAMPILAN INSTAN (MORPHING)
      if (isRecycled) {
        // Reset status agar tidak hilang tiba-tiba
        toast.classList.remove('hide');
        toast.isDismissing = false;
        if (toast.dismissTimer) clearTimeout(toast.dismissTimer);
      }
      
      toast.classList.remove('toast-proses', 'toast-sukses', 'toast-gagal');
      toast.classList.add('global-toast', `toast-${type}`);
      
      if (!toast.classList.contains('show')) {
          void toast.offsetWidth; 
          toast.classList.add('show');
      }

      let iconHtml = '';
      if (type === 'proses') {
        iconHtml = '<div class="spinner-toast"></div>';
        duration = 0; 
      } else if (type === 'sukses') {
        iconHtml = '<i class="fas fa-check-circle"></i>';
      } else if (type === 'gagal') {
        iconHtml = '<i class="fas fa-exclamation-circle"></i>';
        duration = 5000; 
      }

      toast.innerHTML = `
        <div class="toast-icon">${iconHtml}</div>
        <div class="toast-message">${message}</div>
        <div class="toast-close"><i class="fas fa-times"></i></div>
      `;

      // 3. UPDATE POINTER GLOBAL
      if (type === 'proses') {
          currentProsesToast = toast; // Selalu set/reset pointer 'proses'
      }
      // (Kita tidak lagi membutuhkan logika 'else if (isRecycled ...)' di sini)

      // 4. FUNGSI TUTUP LOKAL
      const dismiss = () => {
          if (toast.isDismissing) return;
          toast.isDismissing = true;
          
          // --- PERUBAHAN: Hanya hapus pointer jika toast ini ADALAH toast proses ---
          if (toast === currentProsesToast) {
            currentProsesToast = null;
          }
          // --- AKHIR PERUBAHAN ---

          toast.classList.remove('show');
          toast.classList.add('hide');
          
          toast.addEventListener('animationend', (e) => {
              if (e.target === toast && toast.parentNode) {
                  toast.parentNode.removeChild(toast);
              }
          }, { once: true });
      };

      toast.dismissFunc = dismiss;

      const closeBtn = toast.querySelector('.toast-close');
      if (closeBtn) {
          const handleClose = (e) => {
              e.stopPropagation();
              e.preventDefault(); 
              if (toast.dismissTimer) clearTimeout(toast.dismissTimer);
              dismiss();
          };
          closeBtn.addEventListener('click', handleClose);
          closeBtn.addEventListener('touchstart', handleClose, { passive: false });
      }

      // 5. JALANKAN TIMER AUTO-CLOSE (Jika bukan tipe proses)
      if (duration > 0) {
          toast.dismissTimer = setTimeout(dismiss, duration);
      }
  }

  // --- FUNGSI BANTUAN: SWIPE LISTENER ---
  // Dipisahkan agar kode lebih rapi dan hanya dipasang sekali per elemen notifikasi
  function attachSwipeListeners(toastElement) {
      let touchStartX = 0;
      let isSwiping = false;

      toastElement.addEventListener('touchstart', (e) => {
          touchStartX = e.touches[0].clientX;
          isSwiping = true;
          // Stop timer saat disentuh agar user punya waktu membaca
          if (toastElement.dismissTimer) clearTimeout(toastElement.dismissTimer);
          toastElement.style.transition = 'none'; // Matikan transisi agar geseran instan
      }, { passive: true });

      toastElement.addEventListener('touchmove', (e) => {
          if (!isSwiping) return;
          const diffX = e.touches[0].clientX - touchStartX;
          toastElement.style.transform = `translateX(${diffX}px)`;
          // Efek memudar saat digeser
          toastElement.style.opacity = `${1 - Math.abs(diffX) / 150}`;
      }, { passive: true });

      toastElement.addEventListener('touchend', (e) => {
          isSwiping = false;
          toastElement.style.transition = 'transform 0.3s ease-out, opacity 0.3s ease-out';
          const diffX = e.changedTouches[0].clientX - touchStartX;
          
          if (Math.abs(diffX) > 70) { // Jika digeser cukup jauh (>70px) -> Tutup
              if (toastElement.dismissFunc) toastElement.dismissFunc();
              // Lanjutkan animasi geser keluar agar mulus
              toastElement.style.transform = `translateX(${diffX > 0 ? '100%' : '-100%'})`;
              toastElement.style.opacity = '0';
          } else { // Jika geser sedikit -> Kembalikan ke posisi semula
              toastElement.style.transform = 'translateX(0)';
              toastElement.style.opacity = '1';
          }
      });
  }

  function autoScrollToBottom() {
    // Gunakan timeout kecil untuk memberi waktu DOM render/paint
    // sebelum kita menghitung tinggi halaman.
    setTimeout(() => {
      window.scrollTo({
          top: document.body.scrollHeight,
          behavior: 'auto' // 'auto' untuk instan
      });
    }, 100); 
  }

  function jalankanLogin() {
    hideMessage('login-error'); 
    
    const email = document.getElementById('login-email').value.trim();
    const pass = document.getElementById('login-password').value;
    
    if (!email || !pass) {
      showToast("Email dan Password harus dilengkapi.", 'gagal');
      return; 
    }
    
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
      showToast("Format email yang dimasukkan tidak valid.", 'gagal');
      return; 
    }
    
    // --- GANTI BARIS INI ---
    // setLoading(true, 'Login...', false);
    // --- MENJADI INI ---
    setButtonLoading(document.getElementById('btn-login'), 'Login...');
    
    google.script.run
      .withSuccessHandler(hasilLogin)
      .withFailureHandler(onGagal)
      .prosesLogin(email, pass);
  }

  function hideToast() {
    // PERBAIKAN: Jangan hanya mengandalkan variabel currentProsesToast.
    // Cari SEMUA toast tipe 'proses' yang mungkin masih nyangkut dan hilangkan mereka.
    const container = document.getElementById('global-toast-container');
    if (!container) return;

    const prosesToasts = container.querySelectorAll('.toast-proses');
    prosesToasts.forEach(toast => {
      if (!toast.isDismissing) {
        toast.isDismissing = true;
        toast.classList.remove('show');
        toast.classList.add('hide');
        
        // Paksa hapus jika animasi macet (fallback safety)
        setTimeout(() => {
           if (toast.parentNode) toast.parentNode.removeChild(toast);
        }, 500); 

        toast.addEventListener('animationend', () => {
          if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
          }
        });
      }
    });
    
    currentProsesToast = null;
  }

  function setLoading(isLoading, message = 'Memuat data...', blockUI = true, showLoadingToast = true) {
    document.getElementById('loader').style.display = 'none';
    
    const uiBlocker = document.getElementById('global-ui-blocker');

    if (isLoading) {
      
      // --- PERUBAHAN DI SINI ---
      // Hanya tampilkan toast jika showLoadingToast adalah true
      if (showLoadingToast) {
        showToast(message, 'proses');
      }
      // --- AKHIR PERUBAHAN ---
      
      if (uiBlocker && blockUI) {
        uiBlocker.style.display = 'block';
      }
    } else {
      hideToast();
      if (uiBlocker) {
        uiBlocker.style.display = 'none';
      }
    }
  }

  function toProperCase(str) {
    if (!str) return '';
    return str.toLowerCase().replace(/\b\w/g, char => char.toUpperCase());
  }

  function formatNamaSiswa(namaLengkap) {
    if (!namaLengkap) return '';
    const parts = namaLengkap.split(' ');
    if (parts.length >= 3) {
      const barisSatu = parts.slice(0, 2).join(' ');
      const barisDua = parts.slice(2).join(' ');
      // Ganti <br> dengan dua span yang bisa di-styling
      return `<span class="nama-baris-1">${barisSatu}</span> <span class="nama-baris-2">${barisDua}</span>`;
    }
    return namaLengkap;
  }

  function showMessage(elementId, message, isError) {
    if (typeof isError === 'undefined' || isError === null) {
      isError = true;
    }

    if (isError) {
      showToast(message, 'gagal');
    } else {
      showToast(message, 'sukses');
    }
  }

  function hideMessage(elementId) {
  }

  function tampilHalaman(idHalaman) {
    // --- [PERBAIKAN BARU V2] ---
    // BLOK KODE UNTUK SCROLL DIPINDAHKAN DARI SINI
    // --- [AKHIR PERBAIKAN BARU V2] ---

    /* --- =================================== --- */
    /* ---      TAMBAHAN BARU: Hentikan Video    --- */
    /* --- =================================== --- */
    // Cek apakah player video donasi (ytPlayerDonasi) ada
    // dan memiliki fungsi stopVideo.
    if (ytPlayerDonasi && typeof ytPlayerDonasi.stopVideo === 'function') {
      
      // Jika halaman yang dituju BUKAN halaman donasi,
      // panggil .stopVideo() untuk menghentikannya.
      if (idHalaman !== 'halaman-donasi') {
        ytPlayerDonasi.stopVideo();
        
        // Pastikan juga navigasi slider muncul kembali
        const sliderEl = document.querySelector('.donasi-slider');
        if (sliderEl) {
            sliderEl.classList.remove('video-is-playing');
        }
      }
    }
    /* --- =================================== --- */
    /* ---      AKHIR TAMBAHAN BARU            --- */
    /* --- =================================== --- */

    const allPages = [
      'auth-container', 'halaman-utama', 'halaman-mapel',
      'halaman-data-sekolah', 'halaman-bobot', 'halaman-kelas', 'halaman-siswa',
      'halaman-input-ujian', 'halaman-input-nilai-detail',
      'halaman-rekap-nilai', 'halaman-semester',
      'halaman-input-rapor', 'halaman-input-rapor-detail', 'halaman-rekap-rapor',
      'halaman-nilai-ijazah', 'halaman-validasi-nilai',
      'halaman-superadmin',
      'halaman-kelola-kelulusan', 'halaman-hasil-siswa',
      'halaman-guru', 'halaman-donasi',
      'halaman-proses-kelulusan', 'halaman-tahun-ajaran', 'halaman-penempatan',
      'halaman-pengaturan-cetak', 'halaman-kelola-nilai-guru'
    ];
    
    const authSubPages = [
      'halaman-login', 
      'halaman-registrasi',
      'halaman-login-siswa',
      'halaman-login-guru' // <-- Pastikan ini ada
    ];

    allPages.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.style.display = 'none';
    });
    hideMessage('login-error');
    hideMessage('reg-message');
    hideMessage('data-sekolah-message');
    hideMessage('bobot-message');
    hideMessage('kelas-message');
    hideMessage('siswa-message');
    hideMessage('input-nilai-message');
    hideMessage('mapel-message');
    hideMessage('template-message');
    hideMessage('template-nilai-message');
    hideMessage('rekap-nilai-message');
    hideMessage('semester-message');
    hideMessage('input-rapor-message');
    hideMessage('rekap-rapor-message');
    hideMessage('nilai-ijazah-message');
    hideMessage('validasi-message');
    hideMessage('superadmin-message'); 
    hideMessage('modal-sekolah-error'); 
    hideMessage('kelulusan-message');
    hideMessage('login-siswa-error');
    
    // --- TAMBAHAN BARU ---
    hideMessage('pengaturan-guru-message');
    hideMessage('proses-kelulusan-message');
    hideMessage('ta-message');
    hideMessage('penempatan-message');
    hideMessage('pengaturan-cetak-message');
    hideMessage('kelola-nilai-guru-message');
    // --- AKHIR TAMBAHAN ---

    const targetElement = document.getElementById(idHalaman);
    if (targetElement) {
        if (authSubPages.includes(idHalaman)) {
            document.getElementById('auth-container').style.display = 'block';
            
            // Sembunyikan semua sub-halaman dulu
            authSubPages.forEach(subId => {
                const subEl = document.getElementById(subId);
                if (subEl) subEl.style.display = 'none';
            });

            // Tampilkan target
            targetElement.style.display = 'block';
            localStorage.removeItem(LAST_PAGE_KEY);

            // --- PERBAIKAN LOGIKA DI SINI ---
            // Logika ini HANYA untuk mengubah teks tombol "Login Admin"
            // JANGAN atur tab aktif di sini. activateAuthTab() akan menanganinya.
            const adminTab = document.getElementById('tab-btn-admin');
            if (adminTab) {
              if (idHalaman === 'halaman-registrasi') {
                adminTab.innerText = 'Buat Akun';
                // Hapus logika .classList.add('active') dari sini
              } else if (idHalaman === 'halaman-login') {
                adminTab.innerText = 'Login Admin';
                // Hapus logika .classList.add('active') dari sini
              }
            }
            // --- AKHIR PERBAIKAN ---

            // --- TAMBAHAN: Pastikan halaman auth juga scroll ke atas ---
            window.scrollTo({ top: 0, behavior: 'auto' });
            // --- AKHIR TAMBAHAN ---

        } else {
            targetElement.style.display = 'block';
            localStorage.setItem(LAST_PAGE_KEY, idHalaman);
            
            // --- [PERBAIKAN V3] LOGIKA SCROLL DIPINDAHKAN KE SINI ---
            if (idHalaman === 'halaman-utama') {
              // Kita KEMBALI ke dashboard, pulihkan scroll
              window.scrollTo({ top: lastDashboardScrollPosition, behavior: 'auto' });
            } else {
              // Kita pergi ke halaman LAIN, scroll ke atas
              window.scrollTo({ top: 0, behavior: 'auto' });
            }
            // --- [AKHIR PERBAIKAN V3] ---
        }
    } else {
        console.warn("Halaman tidak ditemukan:", idHalaman, ". Menampilkan dashboard.");
        document.getElementById('halaman-utama').style.display = 'block';
        localStorage.setItem(LAST_PAGE_KEY, 'halaman-utama');
    }
  }

  function setFormDisabled(formId, isDisabled) {
    const form = document.getElementById(formId);
    if (!form) return;

    const inputs = form.querySelectorAll('input, select, textarea');
    inputs.forEach(input => {
      if (input.id !== 'data-nama-sekolah' && input.id !== 'data-npsn') { // <-- TAMBAHKAN INI
        input.disabled = isDisabled;
      }
    });

    const submitButton = form.querySelector('button[type="submit"]');
    if (submitButton) {
      submitButton.disabled = isDisabled;
    }
  }

  function showConfirmationModal(title, message, onConfirmCallback, okButtonType = 'danger') {
    const modal = document.getElementById('confirmation-modal');
    document.getElementById('confirm-modal-title').innerText = title;
    document.getElementById('confirm-modal-body').innerHTML = message;

    const okButton = document.getElementById('btn-confirm-ok');

    if (okButtonType === 'danger') {
      okButton.style.backgroundColor = 'var(--danger-color)';
    } else {
      okButton.style.backgroundColor = 'var(--primary-color)';
    }

    modal.onConfirm = onConfirmCallback;

    modal.classList.add('show');
  }

  function hideConfirmationModal() {
    const modal = document.getElementById('confirmation-modal');
    modal.classList.remove('show');
    modal.onConfirm = null;
  }

  function showInfoModal(title, message, isError, onOkCallback) {
    showToast(message, isError ? 'gagal' : 'sukses');

    if (!isError && typeof onOkCallback === 'function') {
      setTimeout(onOkCallback, 500); 
    }
  }

  function hideInfoModal() {
    const modal = document.getElementById('info-modal');
    modal.classList.remove('show');

    if (typeof modal.onOk === 'function') {
      modal.onOk();
    }
    modal.onOk = null;
  }

  let dynamicTooltipTimer = null;

  function hideDynamicTooltip() {
    if (dynamicTooltipTimer) {
      clearTimeout(dynamicTooltipTimer);
      dynamicTooltipTimer = null;
    }
    const existingTooltip = document.getElementById('dynamic-tooltip'); 
    if (existingTooltip) {
      existingTooltip.classList.remove('show');
      setTimeout(() => {
         const currentTooltip = document.getElementById('dynamic-tooltip');
         if(currentTooltip) {
           currentTooltip.remove();
         }
      }, 200);
    }
  }

  function showDynamicTooltip(targetElement, textToShow) {
    hideDynamicTooltip();

    const tooltip = document.createElement('div');
    tooltip.id = 'dynamic-tooltip';
    tooltip.className = 'dynamic-tooltip';
    tooltip.innerText = textToShow;

    tooltip.addEventListener('click', (e) => {
      e.stopPropagation(); 
      hideDynamicTooltip();
    });

    document.body.appendChild(tooltip);

    const rect = targetElement.getBoundingClientRect();
    const tooltipRect = tooltip.getBoundingClientRect();
    const scrollY = window.scrollY;
    const scrollX = window.scrollX;

    let top = rect.top + scrollY - tooltipRect.height - 8;
    let left = rect.left + scrollX + (rect.width / 2) - (tooltipRect.width / 2);

    if (left < scrollX + 8) left = scrollX + 8;
    if (left + tooltipRect.width > scrollX + window.innerWidth - 8) {
      left = scrollX + window.innerWidth - tooltipRect.width - 8;
    }
    
    if (top < scrollY + 8) {
      top = rect.bottom + scrollY + 8;
      tooltip.classList.add('bottom');
    } else {
      tooltip.classList.add('top');
    }

    tooltip.style.top = `${top}px`;
    tooltip.style.left = `${left}px`;

    requestAnimationFrame(() => {
      tooltip.classList.add('show');
    });

    dynamicTooltipTimer = setTimeout(() => {
      hideDynamicTooltip();
    }, 3000); 
  }

  function bukaHalamanTersimpan(pageId) {
    switch (pageId) {
        case 'halaman-utama':
            tampilHalaman('halaman-utama');
            break;
        case 'halaman-mapel':
            bukaHalamanMapel();
            break;
        case 'halaman-data-sekolah':
            bukaHalamanDataSekolah();
            break;
        case 'halaman-bobot':
            bukaHalamanBobot();
            break;
        case 'halaman-kelas':
            bukaHalamanKelas();
            break;
        case 'halaman-siswa':
            bukaHalamanSiswa();
            break;
        case 'halaman-input-ujian':
            bukaHalamanInputUjian();
            break;
        case 'halaman-input-nilai-detail':
            bukaHalamanInputUjian(); 
            break;
        case 'halaman-rekap-nilai':
            bukaHalamanInputUjian();
            break;
        case 'halaman-semester':
            bukaHalamanSemester();
            break;
        case 'halaman-input-rapor':
            bukaHalamanInputRapor();
            break;
        case 'halaman-input-rapor-detail':
            bukaHalamanInputRapor();
            break;
        case 'halaman-rekap-rapor':
            bukaHalamanInputRapor();
            break;
        case 'halaman-nilai-ijazah':
            bukaHalamanNilaiIjazah();
            break;
        case 'halaman-validasi-nilai':
            bukaHalamanValidasi();
            break;
        case 'halaman-tahun-ajaran':
            bukaHalamanTahunAjaran();
            break;
        case 'halaman-penempatan':
            bukaHalamanPenempatan();
            break;
        case 'halaman-kelola-nilai-guru':
            bukaHalamanKelolaNilaiGuru();
            break;
        default:
            console.warn("ID halaman tersimpan tidak valid:", pageId, ". Menampilkan dashboard.");
            tampilHalaman('halaman-utama');
    }
  }

  function setMapelTipeDirty(isDirty) {
    isMapelTipeDirty = isDirty;
    updateMapelFloatingActions();
  }

  document.addEventListener('DOMContentLoaded', (event) => {

    // --- TAMBAHAN BARU: Set Tahun di Footer ---
    try {
      const yearSpan = document.getElementById('footer-year');
      if (yearSpan) {
        yearSpan.innerText = new Date().getFullYear();
      }
    } catch (e) {
      console.error("Gagal set tahun footer:", e);
    }
    // --- AKHIR TAMBAHAN ---

    document.getElementById('btn-login').addEventListener('click', jalankanLogin);

    /* --- =================================== --- */
    /* ---      MODIFIKASI: Jebak Tombol Back --- */
    /* --- =================================== --- */
    window.addEventListener('popstate', function(event) {
      // Cek apakah kita masih di dalam aplikasi (token masih ada)
      const token = localStorage.getItem('sessionToken');
      
      if (token) {
        // Pengguna menekan "back".
        
        // 1. Dorong kembali state "jebakan" kita
        //    untuk "mengunci" pengguna di aplikasi.
        history.pushState(null, "", location.href);
        
        // 2. [TAMBAHAN BARU] Atasi "halaman kosong" di mobile
        //    dengan memuat ulang UI halaman saat ini.
        const currentPageId = localStorage.getItem(LAST_PAGE_KEY);
        
        if (currentPageId && currentPageId !== 'halaman-login' && currentPageId !== 'halaman-registrasi') {
          // Panggil ulang fungsi navigasi yang sesuai untuk
          // me-render ulang halaman yang sedang dilihat.
          
          // Note: Kita tidak bisa panggil bukaHalamanTersimpan() karena
          // itu akan memanggil setLoading(true), yang tidak kita inginkan di sini.
          // Kita panggil tampilHalaman() secara langsung.
          tampilHalaman(currentPageId);
          
        } else {
          // Jika tidak ada halaman tersimpan, pastikan kita ada di dashboard
          // (atau di halaman superadmin jika itu perannya)
          if (currentUserRole === 'superadmin') {
             tampilHalaman('halaman-superadmin');
          } else if (currentUserRole === 'admin' || currentUserRole === 'guru') {
             tampilHalaman('halaman-utama');
          }
        }
      }
      // Jika token tidak ada (sudah logout), biarkan "back" berfungsi normal.
    });
    /* --- =================================== --- */
    /* ---      AKHIR MODIFIKASI            --- */
    /* --- =================================== --- */

    document.getElementById('btn-registrasi').addEventListener('click', () => {
      const btnReg = document.getElementById('btn-registrasi');

      hideMessage('reg-message');

      const namaSekolah = document.getElementById('reg-nama-sekolah').value.toUpperCase();
      const npsn = document.getElementById('reg-npsn').value.trim();
      const jenjang = document.getElementById('reg-jenjang').value;
      const email = document.getElementById('reg-email').value;
      const password = document.getElementById('reg-password').value;

      if (!namaSekolah || !npsn || !jenjang || !email || !password) {
        showMessage('reg-message', "Semua field wajib diisi.", true);
        return;
      }

      if (!validateEmailFormat()) {
        showMessage('reg-message', 'Format email yang Anda masukkan tidak valid.', true);
        return;
      }

      if (password.length < 8) {
        showMessage('reg-message', "Password minimal harus 8 karakter.", true);
        return;
      }
      if (!/[a-z]/.test(password)) {
        showMessage('reg-message', "Password harus mengandung minimal satu huruf kecil.", true);
        return;
      }
      if (!/[A-Z]/.test(password)) {
        showMessage('reg-message', "Password harus mengandung minimal satu huruf besar.", true);
        return;
      }
      if (!/\d/.test(password)) {
        showMessage('reg-message', "Password harus mengandung minimal satu angka.", true);
        return;
      }
      if (!/[^a-zA-Z0-9]/.test(password)) {
        showMessage('reg-message', "Password harus mengandung minimal satu simbol.", true);
        return;
      }

      const confirmPassword = document.getElementById('reg-password-confirm').value;
      if (password !== confirmPassword) {
        showMessage('reg-message', 'Password dan Konfirmasi Password tidak cocok.', true);

        const tooltip = document.getElementById('reg-password-confirm-tooltip');
        if (tooltip) tooltip.classList.add('show');

        return;
      }

      setButtonLoading(btnReg, 'Mendaftar...');
      google.script.run
        .withSuccessHandler(hasilRegistrasi)
        .withFailureHandler(onGagal)
        .prosesRegistrasi(namaSekolah, npsn, jenjang, email, password);
    });

    // Ganti listener untuk tombol Logout di dalam 'DOMContentLoaded'
    document.getElementById('btn-logout').addEventListener('click', () => {
      if (isFormDirty) {
        const callback = function() {
          isFormDirty = false;
          forceLogoutInstan();
          google.script.run.prosesLogout(getToken());
        };
        showConfirmationModal(
          "Perubahan Belum Disimpan",
          "Anda memiliki <strong>perubahan nilai yang belum disimpan</strong>. Jika logout, perubahan akan hilang.<br><br>Yakin tetap logout?",
          callback,
          'danger'
        );
        return;
      }
      forceLogoutInstan();
      google.script.run.prosesLogout(getToken());
    });

    // Ganti listener untuk tombol Logout Superadmin di dalam 'DOMContentLoaded'
    document.getElementById('btn-superadmin-logout').addEventListener('click', () => {
      forceLogoutInstan();
      google.script.run.prosesLogout(getToken());
    });

    document.getElementById('btn-buka-kelola-kelulusan').addEventListener('click', (e) => {
        // MODIFIKASI: Selalu buka halaman kelola kelulusan.
        // Logika read-only/premium sekarang ditangani DI DALAM bukaHalamanKelolaKelulusan().
        handleNavigationConfirm(bukaHalamanKelolaKelulusan);
    });
    document.getElementById('btn-kembali-ke-dashboard-11').addEventListener('click', () => {
      handleNavigationConfirm(() => tampilHalaman('halaman-utama'));
    });
    document.getElementById('btn-publikasikan-hasil').addEventListener('click', konfirmasiPublishKelulusan);
    document.getElementById('btn-tarik-publikasi').addEventListener('click', konfirmasiTarikKelulusan);
    
    document.getElementById('tab-btn-admin').addEventListener('click', () => activateAuthTab('admin'));
    document.getElementById('tab-btn-siswa').addEventListener('click', () => activateAuthTab('siswa'));

    document.getElementById('tab-btn-guru').addEventListener('click', () => activateAuthTab('guru'));

    document.getElementById('login-guru-form').addEventListener('submit', (e) => {
      e.preventDefault();
      jalankanLoginGuru();
    });

    document.getElementById('toggle-login-guru-password').addEventListener('click', function() {
      const passwordInput = document.getElementById('login-guru-password');
      const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
      passwordInput.setAttribute('type', type);
      this.classList.toggle('fa-eye');
      this.classList.toggle('fa-eye-slash');
    });

    document.getElementById('btn-tutup-alasan-tolak-modal').addEventListener('click', tutupAlasanTolakModal);
    document.getElementById('btn-batal-alasan-tolak-modal').addEventListener('click', tutupAlasanTolakModal);
    document.getElementById('btn-kirim-alasan-tolak-modal').addEventListener('click', submitRejection);
    
    document.getElementById('btn-tutup-preview-modal').addEventListener('click', tutupPreviewModal);
    document.getElementById('btn-batal-preview-modal').addEventListener('click', tutupPreviewModal);

    document.getElementById('preview-filter-kelas').addEventListener('change', renderPreviewTable);
    document.getElementById('preview-filter-nama').addEventListener('input', renderPreviewTable);
    
    document.getElementById('pending-scores-container').addEventListener('click', (e) => {
      const approveBtn = e.target.closest('.btn-approve-score');
      if (approveBtn) {
        const key = approveBtn.dataset.key;
        const mapel = approveBtn.dataset.mapel;
        const callback = function() {
          setLoading(true, 'Menyetujui dan menyalin nilai...');
          google.script.run
            .withSuccessHandler(onScoreApproved)
            .withFailureHandler(onGagal)
            .approveTeacherScore(getToken(), key);
        };
        showConfirmationModal(
          "Setujui Nilai",
          `Anda yakin ingin menyetujui kiriman nilai untuk mapel <strong>${mapel}</strong>? Nilai ini akan menggantikan data nilai ujian yang ada di Aplikasi 1.`,
          callback,
          'success'
        );
        return;
      }
      
      const rejectBtn = e.target.closest('.btn-reject-score');
      if (rejectBtn) {
        const key = rejectBtn.dataset.key;
        const mapel = rejectBtn.dataset.mapel;
        const guru = rejectBtn.dataset.guru;
        showAlasanTolakModal(key, mapel, guru);
        return;
      }
      
      const previewBtn = e.target.closest('.btn-preview-score');
      if (previewBtn) {
        const key = previewBtn.dataset.key;
        const mapel = previewBtn.dataset.mapel;
        const guru = previewBtn.dataset.guru;
        bukaPreviewModal(key, mapel, guru);
        return;
      }
    });

    // --- [TAMBAHAN BARU] Event Listener Fase Capture untuk Halaman Guru ---

    document.getElementById('btn-buka-kelola-nilai-guru').addEventListener('click', (e) => {
        handleNavigationConfirm(bukaHalamanKelolaNilaiGuru);
    });
    
    document.getElementById('btn-kembali-ke-dashboard-17').addEventListener('click', () => {
      handleNavigationConfirm(() => tampilHalaman('halaman-utama'));
    });
    
    document.getElementById('btn-tutup-alasan-tolak-modal').addEventListener('click', tutupAlasanTolakModal);
    document.getElementById('btn-batal-alasan-tolak-modal').addEventListener('click', tutupAlasanTolakModal);
    document.getElementById('btn-kirim-alasan-tolak-modal').addEventListener('click', submitRejection);
    
    document.getElementById('pending-scores-container').addEventListener('click', (e) => {
      const approveBtn = e.target.closest('.btn-approve-score');
      if (approveBtn) {
        const key = approveBtn.dataset.key;
        const mapel = approveBtn.dataset.mapel;
        const callback = function() {
          setLoading(true, 'Menyetujui dan menyalin nilai...');
          google.script.run
            .withSuccessHandler(onScoreApproved)
            .withFailureHandler(onGagal)
            .approveTeacherScore(getToken(), key);
        };
        showConfirmationModal(
          "Setujui Nilai",
          `Anda yakin ingin menyetujui kiriman nilai untuk mapel <strong>${mapel}</strong>? Nilai ini akan menggantikan data nilai ujian yang ada di Aplikasi 1.`,
          callback,
          'success'
        );
        return;
      }
      
      const rejectBtn = e.target.closest('.btn-reject-score');
      if (rejectBtn) {
        const key = rejectBtn.dataset.key;
        const mapel = rejectBtn.dataset.mapel;
        const guru = rejectBtn.dataset.guru;
        showAlasanTolakModal(key, mapel, guru);
        return;
      }
    });

    // --- [MODIFIKASI DI SINI: Hapus bukaHalamanDonasi] ---
    document.getElementById('halaman-guru').addEventListener('click', (e) => {
      const halaman = e.currentTarget;

      if (halaman.classList.contains('non-premium-readonly')) {
        const targetButton = e.target.closest('button');
        const targetInput = e.target.closest('input, select, textarea');
        const targetSwitch = e.target.closest('.switch');

        const interactiveTarget = targetButton || targetInput || targetSwitch;

        if (interactiveTarget && interactiveTarget.id !== 'btn-kembali-ke-dashboard-guru') {
          e.preventDefault();
          e.stopPropagation();

          // Tampilkan toast, JANGAN redirect
          // showToast("Fitur Premium. Silakan Donasi untuk mengaktifkan.", 'gagal', 2500);
        }
      }
    }, true); 
    // --- [AKHIR MODIFIKASI] ---

    // Listener Tab Kelola Nilai Guru
    document.getElementById('kelola-nilai-tab-bar').addEventListener('click', (e) => {
        const target = e.target.closest('.tab-link');
        if (target) {
            const tabName = target.dataset.tab;
            activateKelolaNilaiTab(tabName);
        }
    });

    document.getElementById('btn-tampilkan-riwayat').addEventListener('click', loadRiwayatNilaiGuru);
    
    // Listener untuk tombol Unduh PDF di tabel Riwayat (Delegasi Event)
    document.getElementById('riwayat-scores-container').addEventListener('click', (e) => {
        const btnPdf = e.target.closest('.btn-unduh-pdf-admin');
        const btnDetail = e.target.closest('.btn-lihat-rekap-admin');
        
        if (btnPdf) {
            const key = btnPdf.dataset.key;
            handleAdminDownloadPdf(key, btnPdf);
        } else if (btnDetail) {
            const key = btnDetail.dataset.key;
            const mapel = btnDetail.dataset.mapel;
            const guru = btnDetail.dataset.guru;
            // Gunakan modal preview yang sudah ada untuk melihat rekap
            bukaPreviewModal(key, mapel, guru);
        }
    });

    // --- [TAMBAHAN BARU UNTUK KELOLA KELULUSAN] ---
    // Tambahkan listener fase capture untuk halaman kelulusan
    document.getElementById('halaman-kelola-kelulusan').addEventListener('click', (e) => {
      const halaman = e.currentTarget;
      
      // Cek apakah mode read-only aktif
      if (halaman.classList.contains('non-premium-readonly')) {
        // Cari tombol interaktif yang diklik
        const targetButton = e.target.closest('button');
        const targetInput = e.target.closest('input, select, textarea');
        
        const interactiveTarget = targetButton || targetInput;

        // Jangan blokir tombol 'Kembali ke Dasbor'
        if (interactiveTarget && interactiveTarget.id !== 'btn-kembali-ke-dashboard-11') {
          // Cegah aksi default (submit, dll.)
          e.preventDefault();
          e.stopPropagation();
          
          // Arahkan ke halaman Donasi
          bukaHalamanDonasi();
        }
      }
      // Jika tidak dalam mode read-only, biarkan event berjalan normal
    }, true); // <-- Gunakan fase CAPTURE (true)
    // --- [AKHIR TAMBAHAN BARU] ---

    // Listener untuk Tombol Buka Modal
    document.getElementById('btn-set-tahun-ajar-siswa').addEventListener('click', bukaModalSetTahunAjar);

    // Listener Modal Set TA
    document.getElementById('btn-tutup-modal-set-ta').addEventListener('click', tutupModalSetTahunAjar);
    document.getElementById('btn-batal-modal-set-ta').addEventListener('click', tutupModalSetTahunAjar);

    // Listener Dropdown TA (Load Data)
    document.getElementById('set-ta-select').addEventListener('change', (e) => {
        const taId = e.target.value;
        if(taId) loadDataForSetTahunAjar(taId);
    });

    // Listener Filter (Lokal)
    document.getElementById('set-ta-filter-kelas').addEventListener('change', renderTableSetTahunAjar);
    document.getElementById('set-ta-search').addEventListener('input', renderTableSetTahunAjar);

    // Listener Tombol Tandai/Batal
    document.getElementById('btn-set-ta-tandai').addEventListener('click', () => toggleSetTaCheckboxes(true));
    document.getElementById('btn-set-ta-batal').addEventListener('click', () => toggleSetTaCheckboxes(false));

    // Update listener ini di dalam blok DOMContentLoaded
    document.getElementById('set-ta-table-container').addEventListener('input', (e) => {
        // HAPUS pengecekan 'enroll-noujian-input'
        if (e.target.classList.contains('enroll-checkbox') || 
            e.target.classList.contains('enroll-ruang-input')) { 
            
            isSetTaDirty = true;
            document.getElementById('btn-simpan-set-ta').disabled = false;
            
            // Update state global agar tidak hilang saat filter
            const tr = e.target.closest('tr');
            const id = tr.dataset.id;
            const siswa = globalSetTaData.find(s => s.id === id);
            if(siswa) {
                if(e.target.classList.contains('enroll-checkbox')) siswa.isEnrolled = e.target.checked;
                if(e.target.classList.contains('enroll-ruang-input')) siswa.ruang_ujian = e.target.value;
            }

            // Auto-enable/disable input ruang
            if(e.target.classList.contains('enroll-checkbox')) {
                const inputs = tr.querySelectorAll('.enroll-ruang-input');
                inputs.forEach(inp => inp.disabled = !e.target.checked);
            }
        }
    });

    // Listener Simpan
    document.getElementById('btn-simpan-set-ta').addEventListener('click', simpanSetTahunAjar);

    // --- [TAMBAHAN BARU UNTUK PENGATURAN CETAK] ---
    document.getElementById('halaman-pengaturan-cetak').addEventListener('click', (e) => {
      const halaman = e.currentTarget;
      if (halaman.classList.contains('non-premium-readonly')) {
        // Target interaktif termasuk tombol, input, select, zona upload, dan toggle
        const interactiveTarget = e.target.closest('button, input, select, .file-upload-zone, .form-group-toggle');
        // Jangan blokir tombol 'Kembali'
        if (interactiveTarget && interactiveTarget.id !== 'btn-kembali-ke-dashboard-16') {
          e.preventDefault();
          e.stopPropagation();
          // Tampilkan toast (sesuai permintaan sebelumnya)
          showToast("Fitur Premium. Silakan Donasi untuk mengaktifkan.", 'gagal', 2500);
        }
      }
    }, true); // Gunakan fase CAPTURE
    // --- [AKHIR TAMBAHAN BARU] ---

    // --- [TAMBAHAN BARU UNTUK HALAMAN LAIN] ---

    // Listener untuk Halaman Proses Kelulusan
    document.getElementById('halaman-proses-kelulusan').addEventListener('click', (e) => {
      const halaman = e.currentTarget;
      if (halaman.classList.contains('non-premium-readonly')) {
        const interactiveTarget = e.target.closest('button, input');
        if (interactiveTarget && interactiveTarget.id !== 'btn-kembali-ke-dashboard-13') {
          e.preventDefault();
          e.stopPropagation();
          showToast("Fitur Premium. Silakan Donasi untuk mengaktifkan.", 'gagal', 2500);
        }
      }
    }, true);

    // Listener untuk Halaman Tahun Ajaran
    document.getElementById('halaman-tahun-ajaran').addEventListener('click', (e) => {
      const halaman = e.currentTarget;
      if (halaman.classList.contains('non-premium-readonly')) {
        const interactiveTarget = e.target.closest('button, input');
        if (interactiveTarget && interactiveTarget.id !== 'btn-kembali-ke-dashboard-14') {
          e.preventDefault();
          e.stopPropagation();
          showToast("Fitur Premium. Silakan Donasi untuk mengaktifkan.", 'gagal', 2500);
        }
      }
    }, true);

    // Listener untuk Halaman Penempatan
    document.getElementById('halaman-penempatan').addEventListener('click', (e) => {
      const halaman = e.currentTarget;
      if (halaman.classList.contains('non-premium-readonly')) {
        const interactiveTarget = e.target.closest('button, input, select');
        if (interactiveTarget && 
            interactiveTarget.id !== 'btn-kembali-ke-dashboard-15' &&
            interactiveTarget.id !== 'penempatan-ta-select') { // Izinkan ganti TA
          e.preventDefault();
          e.stopPropagation();
          showToast("Fitur Premium. Silakan Donasi untuk mengaktifkan.", 'gagal', 2500);
        }
      }
    }, true);
    // --- [AKHIR TAMBAHAN BARU] ---

    // --- Event Listeners untuk Guru ---
    document.getElementById('btn-buka-guru').addEventListener('click', (e) => {
        // Selalu buka halaman guru. Logika premium akan ditangani di dalam bukaHalamanGuru()
        handleNavigationConfirm(bukaHalamanGuru);
    });
    document.getElementById('btn-kembali-ke-dashboard-guru').addEventListener('click', () => {
        handleNavigationConfirm(() => tampilHalaman('halaman-utama'));
    });
    document.getElementById('btn-tambah-guru-baru').addEventListener('click', () => {
        showModalGuru('add');
    });
    document.getElementById('btn-tutup-modal-guru').addEventListener('click', tutupModalGuru);
    document.getElementById('btn-batal-modal-guru').addEventListener('click', tutupModalGuru);
    document.getElementById('btn-simpan-guru').addEventListener('click', simpanGuru);

    // --- TAMBAHAN BARU: Listener untuk Cetak Kartu ---
    document.getElementById('btn-cetak-kartu-guru').addEventListener('click', konfirmasiCetakKartu);
    document.getElementById('btn-tutup-halaman-cetak').addEventListener('click', () => {
      document.getElementById('halaman-cetak-kartu').style.display = 'none';
      document.getElementById('kartu-container').innerHTML = ''; // Kosongkan kartu
    });
    document.getElementById('btn-print-kartu').addEventListener('click', () => window.print());
    // --- AKHIR TAMBAHAN ---
    
    document.getElementById('toggle-guru-password').addEventListener('click', function() {
      const passwordInput = document.getElementById('modal-guru-password');
      const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
      passwordInput.setAttribute('type', type);
      this.classList.toggle('fa-eye');
      this.classList.toggle('fa-eye-slash');
    });

    // Listener untuk tombol Edit/Hapus di tabel guru
    document.getElementById('guru-table-container').addEventListener('click', (e) => {
        const target = e.target.closest('button');
        if (!target) return;

        if (target.classList.contains('btn-edit-guru')) {
            const dataStr = target.dataset.guru;
            try {
                const guruData = JSON.parse(dataStr); // Kita akan simpan data lengkap di atribut data-guru
                showModalGuru('edit', guruData);
            } catch(e) { console.error("Gagal parse data guru", e); }
        } else if (target.classList.contains('btn-delete-guru')) {
            const email = target.dataset.email;
            const nama = target.dataset.nama;
            konfirmasiHapusGuru(email, nama);
        }
    });

    // --- TAMBAHKAN BLOK BARU INI TEPAT SETELAHNYA ---
    // Listener untuk form pengaturan guru
    document.getElementById('toggle-waktu-input').addEventListener('change', (e) => {
        const container = document.getElementById('container-tanggal-input-guru');
        if (e.target.checked) {
          container.style.display = 'block';
        } else {
          container.style.display = 'none';
        }
    });
    
    document.getElementById('btn-simpan-pengaturan-guru').addEventListener('click', simpanPengaturanGuru);
    // --- AKHIR TAMBAHAN ---

    const mapelSearchInput = document.getElementById('modal-guru-mapel-search');
    const mapelSuggestionsContainer = document.getElementById('modal-guru-mapel-suggestions');
    const mapelSelectedContainer = document.getElementById('modal-guru-mapel-selected');

    mapelSearchInput.addEventListener('input', updateMapelSuggestions);
    mapelSearchInput.addEventListener('focus', updateMapelSuggestions);

    mapelSearchInput.addEventListener('blur', () => {
      setTimeout(() => {
        document.getElementById('modal-guru-mapel-suggestions').style.display = 'none';
      }, 150);
    });

    mapelSuggestionsContainer.addEventListener('mousedown', (e) => {
      const target = e.target.closest('.mapel-suggestion-item');
      if (target) {
        e.preventDefault();
        const mapelId = target.dataset.id;
        const mapelNama = target.dataset.nama;
        addSelectedMapelTag(mapelId, mapelNama); // UI Lama
      }
    });

    mapelSelectedContainer.addEventListener('click', (e) => {
      const target = e.target.closest('.selected-mapel-tag-remove');
      if (target) {
        const mapelId = target.dataset.id;
        removeSelectedMapelTag(mapelId);
        updateMapelSuggestions();
      }
    });

    // TAMBAHKAN LISTENER BARU DI SINI
    document.getElementById('btn-sync-guru-kelas').addEventListener('click', konfirmasiSyncGuruKelas);

    // --- TAMBAHAN BARU: Listener untuk Cetak Kartu ---
    document.getElementById('btn-cetak-kartu-guru').addEventListener('click', konfirmasiCetakKartu);



    // [MODIFIKASI] Tambahkan listener untuk modal baru
    document.getElementById('btn-tutup-modal-import-penempatan').addEventListener('click', tutupModalImportPenempatan);
    document.getElementById('btn-batal-modal-import-penempatan').addEventListener('click', tutupModalImportPenempatan);
    document.getElementById('btn-download-template-penempatan').addEventListener('click', downloadTemplatePenempatan);
    document.getElementById('btn-proses-import-penempatan').addEventListener('click', prosesImportFilePenempatan);

    const fileUploadZonePenempatan = document.getElementById('file-upload-zone-penempatan');
    const fileUploadInputPenempatan = document.getElementById('file-upload-penempatan');
    const fileUploadTextPenempatan = document.getElementById('file-upload-text-penempatan');
    const btnProsesImportPenempatan = document.getElementById('btn-proses-import-penempatan');

    fileUploadInputPenempatan.addEventListener('change', (e) => {
        const fileInput = e.target;
        if (fileInput.files.length > 0) {
            const fileName = fileInput.files[0].name;
            if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                fileUploadTextPenempatan.innerText = `File dipilih: ${fileName}`;
                fileUploadTextPenempatan.classList.add('file-chosen');
                btnProsesImportPenempatan.disabled = false;
                hideMessage('template-penempatan-message');
            } else {
                fileUploadTextPenempatan.innerText = 'File harus berekstensi .xlsx atau .xls';
                fileUploadTextPenempatan.classList.remove('file-chosen');
                btnProsesImportPenempatan.disabled = true;
            }
        } else {
            fileUploadTextPenempatan.innerText = 'Klik untuk memilih file atau seret & letakkan di sini.';
            fileUploadTextPenempatan.classList.remove('file-chosen');
            btnProsesImportPenempatan.disabled = true;
        }
    });

    fileUploadZonePenempatan.addEventListener('dragover', (e) => { e.preventDefault(); fileUploadZonePenempatan.classList.add('drag-over'); });
    fileUploadZonePenempatan.addEventListener('dragleave', (e) => { e.preventDefault(); fileUploadZonePenempatan.classList.remove('drag-over'); });
    fileUploadZonePenempatan.addEventListener('drop', (e) => {
        e.preventDefault();
        fileUploadZonePenempatan.classList.remove('drag-over');
        if (e.dataTransfer.files.length > 0) {
          fileUploadInputPenempatan.files = e.dataTransfer.files;
          const changeEvent = new Event('change');
          fileUploadInputPenempatan.dispatchEvent(changeEvent);
        }
    });
    // [AKHIR MODIFIKASI]

    // --- ============================================= ---
    // --- ===== LISTENER BARU UNTUK UI MULTI-KELAS ==== ---
    // --- ============================================= ---
    const mapelKelasSearchInput = document.getElementById('modal-guru-mapel-kelas-search');
    const mapelKelasSuggestionsContainer = document.getElementById('modal-guru-mapel-kelas-suggestions');
    const mapelKelasListContainer = document.getElementById('modal-guru-mapel-kelas-list');

    mapelKelasSearchInput.addEventListener('input', updateMapelSuggestions);
    mapelKelasSearchInput.addEventListener('focus', updateMapelSuggestions);

    mapelKelasSearchInput.addEventListener('blur', () => {
      setTimeout(() => {
        mapelKelasSuggestionsContainer.style.display = 'none';
      }, 150);
    });

    // Saat mengklik saran di UI BARU
    mapelKelasSuggestionsContainer.addEventListener('mousedown', (e) => {
      const target = e.target.closest('.mapel-suggestion-item');
      if (target) {
        e.preventDefault();
        const mapelId = target.dataset.id;
        const mapelNama = target.dataset.nama;
        addMapelKelasRow(mapelId, mapelNama); // Panggil fungsi UI BARU
      }
    });

    // Saat mengklik tombol Hapus (X) di list UI BARU
    mapelKelasListContainer.addEventListener('click', (e) => {
      const target = e.target.closest('.mapel-kelas-remove');
      if (target) {
        const row = target.closest('.mapel-kelas-row');
        if (row) {
          row.remove();
          updateMapelSuggestions(); // Perbarui saran
        }
      }
    });
    // --- ============================================= ---
    // --- =====         AKHIR LISTENER BARU         ===== ---
    // --- ============================================= ---
    
    document.getElementById('btn-cek-kelulusan').addEventListener('click', jalankanCekKelulusan);
    document.getElementById('btn-logout-siswa').addEventListener('click', () => tampilHalaman('halaman-login-siswa'));
    document.getElementById('btn-logout-siswa-2').addEventListener('click', () => tampilHalaman('halaman-login-siswa'));
    document.getElementById('btn-logout-siswa-3').addEventListener('click', () => tampilHalaman('halaman-login-siswa'));

    // Ganti listener tombol 'Kembali ke Superadmin' di dalam 'DOMContentLoaded'
    document.getElementById('btn-kembali-ke-superadmin').addEventListener('click', () => {
      setLoading(true, 'Kembali ke Superadmin...', true);
      google.script.run
        .withSuccessHandler(onReturnToSuperadmin)
        .withFailureHandler(onGagal)
        .superadminReturn(getToken());
    });

    // --- TAMBAHKAN BLOK BARU INI ---
    document.getElementById('btn-buka-donasi').addEventListener('click', () => {
      handleNavigationConfirm(bukaHalamanDonasi);
    });
    document.getElementById('btn-kembali-ke-dashboard-12').addEventListener('click', () => {
      handleNavigationConfirm(() => tampilHalaman('halaman-utama'));
    });
    document.getElementById('btn-kirim-donasi').addEventListener('click', submitDonasiForm);
    document.getElementById('btn-batalkan-donasi').addEventListener('click', konfirmasiBatalkanDonasi);
    document.getElementById('btn-lihat-file-donasi').addEventListener('click', () => {
      if (globalDonasiDetail.fileUrl) {
        window.open(globalDonasiDetail.fileUrl, '_blank');
      } else {
        showToast("Link file tidak ditemukan.", 'gagal');
      }
    });

    document.getElementById('btn-buka-proses-kelulusan').addEventListener('click', (e) => {
        // MODIFIKASI: Selalu buka halaman proses kelulusan.
        // Logika read-only/premium akan ditangani DI DALAM bukaHalamanProsesKelulusan().
        // (Kita akan tambahkan logika itu selanjutnya jika halaman ini juga perlu read-only)
        
        // Untuk saat ini, kita akan buat agar selalu bisa diklik, 
        // dan logika di `bukaHalamanProsesKelulusan` akan menangani sisanya.
        // Jika Anda ingin halaman ini juga read-only, kita perlu memodifikasi `bukaHalamanProsesKelulusan`
        // seperti yang kita lakukan pada `bukaHalamanKelolaKelulusan`.
        
        // Untuk SEKARANG, logika ini akan mengarahkan ke donasi jika non-premium (seperti sebelumnya)
        // KARENA kita belum menambahkan logic read-only di `bukaHalamanProsesKelulusan`.
        // Mari kita terapkan logika yang sama:
        handleNavigationConfirm(bukaHalamanProsesKelulusan);
    });
    document.getElementById('btn-kembali-ke-dashboard-13').addEventListener('click', () => tampilHalaman('halaman-utama'));
    document.getElementById('input-konfirmasi-nama-sekolah').addEventListener('input', validasiKonfirmasiNamaSekolah);
    document.getElementById('btn-proses-kelulusan').addEventListener('click', jalankanProsesKelulusan);

    document.getElementById('btn-cetak-kartu-siswa').addEventListener('click', (e) => {
      // Hanya jalankan jika tombol TIDAK dalam mode disabled (premium aktif)
      if (!e.currentTarget.classList.contains('card-disabled')) {
        konfirmasiCetakKartuSiswa();
      }
      // Jika .card-disabled (non-premium), tidak terjadi apa-apa,
      // sesuai permintaan "tidak bisa diklik" dan "tidak mengarah ke donasi".
    });

    // --- [BARU] Listener untuk Pengaturan Cetak ---
    document.getElementById('btn-buka-pengaturan-cetak').addEventListener('click', () => {
      handleNavigationConfirm(bukaHalamanPengaturanCetak);
    });
    document.getElementById('btn-kembali-ke-dashboard-16').addEventListener('click', () => {
      handleNavigationConfirm(() => tampilHalaman('halaman-utama'));
    });
    document.getElementById('btn-simpan-pengaturan-cetak').addEventListener('click', simpanPengaturanCetak);
    document.getElementById('btn-hapus-kop-surat').addEventListener('click', hapusGambarKop);

    const fileUploadZoneKop = document.getElementById('file-upload-zone-kop');
    const fileUploadInputKop = document.getElementById('file-upload-kop');
    const fileUploadTextKop = document.getElementById('file-upload-text-kop');

    // Listener untuk input file
    fileUploadInputKop.addEventListener('change', (e) => {
        const fileInput = e.target;
        if (fileInput.files.length > 0) {
            const file = fileInput.files[0];
            // Validasi tipe file
            if (!['image/png', 'image/jpeg', 'image/gif'].includes(file.type)) {
              showToast("File harus berupa gambar (PNG, JPG, GIF).", 'gagal');
              fileInput.value = null; // Kosongkan input
              return;
            }
            // Tampilkan preview
            tampilkanPreviewKop(file);
            document.getElementById('kop-surat-status').value = 'new'; // Tandai ada file baru
            fileUploadTextKop.innerText = `File dipilih: ${file.name}`;
            fileUploadTextKop.classList.add('file-chosen');
            document.getElementById('btn-simpan-pengaturan-cetak').disabled = false;
        }
    });

    // Listener Drag & Drop
    fileUploadZoneKop.addEventListener('dragover', (e) => { e.preventDefault(); fileUploadZoneKop.classList.add('drag-over'); });
    fileUploadZoneKop.addEventListener('dragleave', (e) => { e.preventDefault(); fileUploadZoneKop.classList.remove('drag-over'); });
    fileUploadZoneKop.addEventListener('drop', (e) => {
        e.preventDefault();
        fileUploadZoneKop.classList.remove('drag-over');
        if (e.dataTransfer.files.length > 0) {
          fileUploadInputKop.files = e.dataTransfer.files;
          const changeEvent = new Event('change');
          fileUploadInputKop.dispatchEvent(changeEvent);
        }
    });

    // Listener untuk form
    document.getElementById('pengaturan-tanggal-cetak').addEventListener('input', () => {
      document.getElementById('btn-simpan-pengaturan-cetak').disabled = false;
    });
    document.getElementById('pengaturan-tempat-ttd').addEventListener('input', () => {
      document.getElementById('btn-simpan-pengaturan-cetak').disabled = false;
    });
    // [BARU] Listener untuk dropdown mode tanggal
    document.getElementById('pengaturan-tanggal-mode').addEventListener('change', (e) => {
      const manualContainer = document.getElementById('pengaturan-tanggal-manual-container');
      if (e.target.value === 'manual') {
        manualContainer.style.display = 'block';
      } else {
        manualContainer.style.display = 'none';
      }
      document.getElementById('btn-simpan-pengaturan-cetak').disabled = false;
    });

    document.getElementById('pengaturan-reset-doc-id').addEventListener('click', (e) => {
      e.preventDefault();
      if (globalPengaturanCetakCache && globalPengaturanCetakCache.data) {
        
        // --- [MODIFIKASI PERBAIKAN] ---
        const defaultId = globalPengaturanCetakCache.data.defaultTemplateDocID;
        
        if (defaultId) { // Cek jika defaultId ada isinya (tidak null, undefined, atau blank)
          document.getElementById('pengaturan-template-doc-id').value = defaultId;
          document.getElementById('btn-simpan-pengaturan-cetak').disabled = false;
          showToast('ID Template Laporan Nilai telah direset ke default.', 'sukses', 2000);
        } else {
          // ID-nya KOSONG di cache. Ini adalah error dari Master_Config.
          document.getElementById('pengaturan-template-doc-id').value = ''; // Set ke kosong (seperti yg terjadi)
          document.getElementById('btn-simpan-pengaturan-cetak').disabled = false; // Tetap aktifkan simpan
          // Tampilkan pesan error yang lebih spesifik
          showToast('Reset gagal: ID Default Laporan Nilai tidak ditemukan di Master_Config.', 'gagal', 4000);
        }
        // --- [AKHIR MODIFIKASI] ---

      } else {
        showToast('Gagal me-reset. Data cache tidak ditemukan.', 'gagal');
      }
    });

    document.getElementById('pengaturan-reset-rekap-id').addEventListener('click', (e) => {
      e.preventDefault();
      if (globalPengaturanCetakCache && globalPengaturanCetakCache.data) {
        
        // --- [MODIFIKASI PERBAIKAN] ---
        const defaultId = globalPengaturanCetakCache.data.defaultTemplateRekapID;
        
        if (defaultId) { // Cek jika defaultId ada isinya
          document.getElementById('pengaturan-template-rekap-id').value = defaultId;
          document.getElementById('btn-simpan-pengaturan-cetak').disabled = false; 
          showToast('ID Template Rekapitulasi telah direset ke default.', 'sukses', 2000);
        } else {
          // ID-nya KOSONG di cache.
          document.getElementById('pengaturan-template-rekap-id').value = '';
          document.getElementById('btn-simpan-pengaturan-cetak').disabled = false;
          // Tampilkan pesan error yang lebih spesifik
          showToast('Reset gagal: ID Default Rekapitulasi tidak ditemukan di Master_Config.', 'gagal', 4000);
        }
        // --- [AKHIR MODIFIKASI] ---
        
      } else {
        showToast('Gagal me-reset. Data cache tidak ditemukan.', 'gagal');
      }
    });
    // --- AKHIR TAMBAHAN BARU ---

    // --- [BARU] Listener untuk Tutorial Template ---
    document.getElementById('btn-tutorial-template-doc').addEventListener('click', (e) => {
      e.preventDefault();
      showTemplateTutorialModal('doc');
    });
    
    document.getElementById('btn-tutorial-template-rekap').addEventListener('click', (e) => {
      e.preventDefault();
      showTemplateTutorialModal('rekap');
    });
    // --- AKHIR TAMBAHAN ---

    // --- [BARU] Listener untuk Tutorial Dapat ID ---
    document.getElementById('btn-tutorial-dapat-id').addEventListener('click', (e) => {
      e.preventDefault();
      
      const title = "Cara Mendapatkan ID Spreadsheet";
      const message = `
        <div style="text-align: left; line-height: 1.6;">
          <p>ID Spreadsheet adalah kode unik di dalam URL Google Sheet Anda.</p>
          <ol style="padding-left: 20px; margin-top: 15px;">
            <li style="margin-bottom: 10px;">Buka file Google Sheet template Anda (atau contoh dari kami).</li>
            <li style="margin-bottom: 10px;">Lihat pada <strong>address bar (URL)</strong> browser Anda.</li>
            <li style="margin-bottom: 10px;">URL akan terlihat seperti ini:<br>
              <code style="font-size: 12px; background: #eee; padding: 2px 4px; border-radius: 4px;">.../spreadsheets/d/</code><strong style="color: var(--danger-color); background: #fdeeee; padding: 2px 0;">1muEmaMfisM4T...GL4NzwUS17w</strong><code style="font-size: 12px; background: #eee; padding: 2px 4px; border-radius: 4px;">/edit</code>
            </li>
            <li>Salin (copy) kode panjang yang berada di antara <strong>/d/</strong> dan <strong>/edit</strong>. Itulah ID Spreadsheet Anda.</li>
          </ol>
        </div>
      `;
      
      // Panggil modal info yang sudah ada di index.html
      const modal = document.getElementById('info-modal');
      document.getElementById('info-modal-title').innerText = title;
      document.getElementById('info-modal-body').innerHTML = message;
      document.getElementById('info-modal-body').classList.remove('error');
      
      modal.onOk = null; // Tidak ada aksi khusus saat OK
      modal.classList.add('show'); // Tampilkan modal
    });
    // --- [AKHIR TAMBAHAN BARU] ---

    document.getElementById('pengaturan-template-kustom-toggle').addEventListener('change', (e) => {
      const container = document.getElementById('pengaturan-template-kustom-container');
      if (e.target.checked) {
        container.style.display = 'block';
      } else {
        container.style.display = 'none';
      }
      document.getElementById('btn-simpan-pengaturan-cetak').disabled = false; // Aktifkan simpan
    });

    document.getElementById('pengaturan-template-doc-id').addEventListener('input', () => {
      document.getElementById('btn-simpan-pengaturan-cetak').disabled = false;
      document.getElementById('pengaturan-template-doc-id').classList.remove('input-error');
    });

    document.getElementById('pengaturan-template-rekap-id').addEventListener('input', () => {
      document.getElementById('btn-simpan-pengaturan-cetak').disabled = false;
      document.getElementById('pengaturan-template-rekap-id').classList.remove('input-error');
    });
    // --- AKHIR LISTENER BARU ---

    // Listener dinamis untuk tombol verifikasi Superadmin
    document.getElementById('superadmin-donasi-list').addEventListener('click', (e) => {
      const target = e.target.closest('button');
      if (!target) return;
      
      const sekolahID = target.dataset.id;
      if (target.classList.contains('btn-donasi-setujui')) {
        handleDonasiVerify(sekolahID, true);
      // --- BLOK INI AKAN DIMODIFIKASI ---
      } else if (target.classList.contains('btn-donasi-tolak')) {
        // Ambil nama sekolah dari card terdekat
        const card = target.closest('.donasi-card');
        const namaSekolah = card ? card.querySelector('h4').innerText : 'Sekolah';

        const title = "Konfirmasi Penolakan Donasi";
        const message = `Masukkan alasan penolakan untuk sekolah: <strong><span id="alasan-modal-nama-sekolah"></span></strong>`;

        // Siapkan callback yang akan dieksekusi oleh modal
        const callback = function(id, alasan) {
            setLoading(true, 'Menolak donasi...');
            google.script.run
              .withSuccessHandler(onDonasiDiverifikasi)
              .withFailureHandler(onGagal)
              .verifikasiDonasi(getToken(), id, false, alasan); // Kirim isApproved = false
        };
        
        // Panggil modal kustom, bukan prompt()
        showAlasanModal(title, message, sekolahID, namaSekolah, callback);
        
      // --- AKHIR MODIFIKASI ---
      } else if (target.classList.contains('btn-donasi-lihat')) {
        window.open(target.dataset.url, '_blank');
      }
    });
    // --- AKHIR BLOK BARU ---

    document.getElementById('link-ke-registrasi').addEventListener('click', (e) => {
      e.preventDefault();
      handleNavigationConfirm(() => tampilHalaman('halaman-registrasi'));
    });

    document.getElementById('link-ke-login').addEventListener('click', (e) => {
      e.preventDefault();
      handleNavigationConfirm(() => tampilHalaman('halaman-login'));
    });
    
    document.getElementById('login-form').addEventListener('submit', (e) => {
      e.preventDefault();
      jalankanLogin(); 
    });

    document.getElementById('login-password').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.keyCode === 13) {
        e.preventDefault(); 
        jalankanLogin();    
      }
    });

    document.getElementById('login-email').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.keyCode === 13) {
        
        const passInput = document.getElementById('login-password');
        
        if (passInput.value === "") {
          e.preventDefault();
          passInput.focus();
        } else {
          e.preventDefault();
          jalankanLogin();
        }
      }
    });

    document.getElementById('reg-form').addEventListener('submit', (e) => {
      e.preventDefault();
    });

    document.getElementById('toggle-login-password').addEventListener('click', function() {
      const passwordInput = document.getElementById('login-password');
      const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
      passwordInput.setAttribute('type', type);
      this.classList.toggle('fa-eye');
      this.classList.toggle('fa-eye-slash');
    });

    document.getElementById('toggle-reg-password').addEventListener('click', function() {
      const passwordInput = document.getElementById('reg-password');
      const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
      passwordInput.setAttribute('type', type);
      this.classList.toggle('fa-eye');
      this.classList.toggle('fa-eye-slash');
    });

    // --- TAMBAHAN BARU: Event listener untuk Email ---
    const regEmailInput = document.getElementById('reg-email');
    if (regEmailInput) {
      // Tampilkan error saat pengguna pindah (blur)
      regEmailInput.addEventListener('blur', validateEmailFormat);

      // Sembunyikan error saat pengguna mulai mengetik lagi untuk memperbaiki
      regEmailInput.addEventListener('input', () => {
        const tooltip = document.getElementById('reg-email-tooltip');
        if (tooltip) {
          tooltip.classList.remove('show');
        }
      });
    }
    // --- AKHIR TAMBAHAN ---

    // --- TAMBAHAN BARU: Event listener untuk tooltip password ---
    const regPassInput = document.getElementById('reg-password');
    const regPassTooltip = document.getElementById('reg-password-tooltip');

    if (regPassInput && regPassTooltip) {
      // Panggil validasi saat pengguna mengetik
      regPassInput.addEventListener('input', validatePasswordTooltip);

      // --- TAMBAHAN BARU ---
      // Panggil juga validasi "match" jika password utama diubah
      regPassInput.addEventListener('input', validatePasswordMatch);
      // --- AKHIR TAMBAHAN ---

      // Tampilkan tooltip saat fokus
      regPassInput.addEventListener('focus', () => {
        // Validasi status saat ini
        validatePasswordTooltip();
        // Tampilkan tooltip (CSS akan menanganinya via :focus)
      });

      // Biarkan CSS menangani show/hide via :focus
    }
    // --- AKHIR TAMBAHAN ---

    // --- ============================================= ---
    // ---       TAMBAHKAN BLOK BARU INI DI SINI       ---
    // --- ============================================= ---
    // --- Listener untuk Konfirmasi Password ---
    const regPassConfirmInput = document.getElementById('reg-password-confirm');
    if (regPassConfirmInput) {
      // Validasi kecocokan setiap kali mengetik di kotak konfirmasi
      regPassConfirmInput.addEventListener('input', validatePasswordMatch);
    }

    // Toggle untuk ikon mata konfirmasi
    document.getElementById('toggle-reg-confirm-password').addEventListener('click', function() {
      const passwordInput = document.getElementById('reg-password-confirm');
      const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
      passwordInput.setAttribute('type', type);
      this.classList.toggle('fa-eye');
      this.classList.toggle('fa-eye-slash');
    });
    // --- ============================================= ---
    // ---             AKHIR BLOK TAMBAHAN             ---
    // --- ============================================= ---

    document.getElementById('btn-buka-data-sekolah').addEventListener('click', () => {
      handleNavigationConfirm(bukaHalamanDataSekolah);
    });
    document.getElementById('btn-kembali-ke-dashboard-2').addEventListener('click', () => {
      handleNavigationConfirm(() => tampilHalaman('halaman-utama'));
    });

    document.getElementById('btn-buka-bobot').addEventListener('click', () => {
      handleNavigationConfirm(bukaHalamanBobot);
    });
    document.getElementById('btn-kembali-ke-dashboard-3').addEventListener('click', () => {
      handleNavigationConfirm(() => tampilHalaman('halaman-utama'));
    });

    document.getElementById('btn-buka-kelas').addEventListener('click', () => {
      handleNavigationConfirm(bukaHalamanKelas);
    });
    document.getElementById('btn-kembali-ke-dashboard-4').addEventListener('click', () => {
      handleNavigationConfirm(() => tampilHalaman('halaman-utama'));
    });

    document.getElementById('btn-buka-siswa').addEventListener('click', () => {
      handleNavigationConfirm(bukaHalamanSiswa);
    });
    document.getElementById('btn-kembali-ke-dashboard-5').addEventListener('click', () => {
      handleNavigationConfirm(() => tampilHalaman('halaman-utama'));
    });

    document.getElementById('btn-buka-input-ujian').addEventListener('click', () => {
      handleNavigationConfirm(bukaHalamanInputUjian);
    });
    document.getElementById('btn-kembali-ke-dashboard-6').addEventListener('click', () => {
      handleNavigationConfirm(() => tampilHalaman('halaman-utama'));
    });
    document.getElementById('btn-kembali-ke-input-ujian').addEventListener('click', () => {
      handleNavigationConfirm(bukaHalamanInputUjian);
    });
    document.getElementById('btn-kembali-ke-input-ujian-2').addEventListener('click', () => {
      handleNavigationConfirm(bukaHalamanInputUjian);
    });
    document.getElementById('btn-buka-upload-nilai').addEventListener('click', bukaModalUploadNilai);

    document.getElementById('btn-buka-input-um').addEventListener('click', () => {
      handleNavigationConfirm(() => bukaHalamanInputNilaiDetail('UM'));
    });
    document.getElementById('btn-buka-input-praktek').addEventListener('click', () => {
      handleNavigationConfirm(() => bukaHalamanInputNilaiDetail('Praktek'));
    });
    document.getElementById('btn-buka-rekap-nilai').addEventListener('click', () => {
      handleNavigationConfirm(bukaHalamanRekapNilai);
    });
    document.getElementById('btn-buka-semester').addEventListener('click', () => {
      handleNavigationConfirm(bukaHalamanSemester);
    });

    // --- TAMBAHKAN LISTENER BARU ---
    document.getElementById('btn-buka-tahun-ajaran').addEventListener('click', () => {
      handleNavigationConfirm(bukaHalamanTahunAjaran);
    });

    document.getElementById('btn-buka-tahun-ajaran').addEventListener('click', (e) => {
        // MODIFIKASI: Selalu buka halaman tahun ajaran.
        // Logika read-only akan ditangani DI DALAM bukaHalamanTahunAjaran().
        handleNavigationConfirm(bukaHalamanTahunAjaran);
    });

    document.getElementById('btn-kembali-ke-dashboard-14').addEventListener('click', () => {
      handleNavigationConfirm(() => tampilHalaman('halaman-utama'));
    });
    document.getElementById('form-ta').addEventListener('submit', (e) => {
      e.preventDefault();
      simpanTahunAjaran();
    });
    
    // Tambahkan listener dinamis untuk add/remove row T.A.
    document.getElementById('ta-list-container').addEventListener('click', (e) => {
      const target = e.target;

      if (target.classList.contains('btn-add-ta-row') || target.classList.contains('btn-remove-ta-row')) {
        isFormDirty = true;
      }
      
      if (target.classList.contains('btn-add-ta-row')) {
        const currentList = getCurrentTahunAjaranList();
        currentList.push({ id: '', deskripsi: '', isLocked: false, isUsed: false }); // Tambah baris baru
        renderTahunAjaranList(currentList);
        
        // Fokus ke input ID di baris terakhir
        const lastInput = document.querySelector('#ta-list-container .ta-input-row:last-child input[type="text"]');
        if (lastInput) {
          lastInput.focus();
        }
      
      } 
      else if (target.classList.contains('btn-remove-ta-row')) {
        
        const rowToRemove = target.closest('.ta-input-row');
        // 'allRows' menyertakan baris HEADER (yang juga punya kelas .ta-input-row)
        const allRows = Array.from(document.querySelectorAll('#ta-list-container .ta-input-row')); 
        const indexToRemoveInDOM = allRows.indexOf(rowToRemove);
        
        // 'currentList' HANYA berisi data (TIDAK termasuk header)
        const currentList = getCurrentTahunAjaranList(); 
        
        // --- PERBAIKAN BUG DI SINI ---
        // Kita harus mengonversi indeks DOM (yang ada header) 
        // ke indeks data (tanpa header) dengan mengurangi 1.
        const indexToRemoveInData = indexToRemoveInDOM - 1; 

        // Pastikan indeksnya valid (bukan header (indeks -1) dan ada di dalam list)
        if (indexToRemoveInData > -1 && indexToRemoveInData < currentList.length) { 
          currentList.splice(indexToRemoveInData, 1); // Hapus item yang benar
        }
        // --- AKHIR PERBAIKAN ---
        
        renderTahunAjaranList(currentList); // Render ulang
      }
    });
    
    document.getElementById('ta-list-container').addEventListener('input', (e) => {
      if (e.target.tagName === 'INPUT') {
        isFormDirty = true;
      }
    });
    // --- AKHIR TAMBAHAN ---

    // --- TAMBAHKAN LISTENER BARU ---
    document.getElementById('btn-buka-penempatan').addEventListener('click', () => {
      handleNavigationConfirm(bukaHalamanPenempatan);
    });

    document.getElementById('btn-buka-penempatan').addEventListener('click', (e) => {
        // MODIFIKASI: Selalu buka halaman penempatan.
        // Logika read-only akan ditangani DI DALAM bukaHalamanPenempatan().
        handleNavigationConfirm(bukaHalamanPenempatan);
    });

    document.getElementById('btn-kembali-ke-dashboard-15').addEventListener('click', () => {
      handleNavigationConfirm(() => tampilHalaman('halaman-utama'));
    });
    
    // Listener untuk filter T.A. utama di halaman penempatan
    document.getElementById('penempatan-ta-select').addEventListener('change', (e) => {
      const selectedTaId = e.target.value;
      if (selectedTaId) {
        // Panggil data untuk T.A. yang baru dipilih
        loadPenempatanData(selectedTaId);
      } else {
        // Sembunyikan tab jika T.A. tidak dipilih
        document.getElementById('penempatan-tab-bar').style.display = 'none';
        document.getElementById('tab-penempatan-siswa').style.display = 'none';
        document.getElementById('tab-penempatan-mapel').style.display = 'none';
      }
    });

    // [MODIFIKASI] Tambahkan listener untuk tombol import baru
    document.getElementById('btn-import-penempatan').addEventListener('click', bukaModalImportPenempatan);
    // [AKHIR MODIFIKASI]

    // Listener untuk tab penempatan
    document.getElementById('penempatan-tab-bar').addEventListener('click', (e) => {
      if (e.target.classList.contains('tab-link')) {
        const tabName = e.target.dataset.tab;
        activatePenempatanTab(tabName);
      }
    });
    
    // Listener untuk filter dan aksi di Tab Siswa
    document.getElementById('penempatan-siswa-search').addEventListener('input', () => renderPenempatanSiswaTable());
    document.getElementById('penempatan-siswa-filter-kelas').addEventListener('change', () => renderPenempatanSiswaTable());
    document.getElementById('btn-penempatan-siswa-tandai').addEventListener('click', () => toggleEnrollAll(true));
    document.getElementById('btn-penempatan-siswa-batal').addEventListener('click', () => toggleEnrollAll(false));
    document.getElementById('btn-simpan-penempatan-siswa').addEventListener('click', simpanPenempatanSiswa);
    
    // Listener dinamis untuk tabel siswa
    document.getElementById('penempatan-siswa-container').addEventListener('input', (e) => {
      
      // --- MODIFIKASI DI SINI ---
      // Menambahkan '.enroll-noujian-input' ke dalam kondisi
      if (e.target.classList.contains('enroll-checkbox') || e.target.classList.contains('enroll-ruang-input') || e.target.classList.contains('enroll-noujian-input')) {
      // --- AKHIR MODIFIKASI ---
      
        isPenempatanSiswaDirty = true;
        document.getElementById('btn-simpan-penempatan-siswa').disabled = false;
        
        // Logika ini tetap (hanya panggil update state saat checkbox diubah)
        if(e.target.classList.contains('enroll-checkbox')) {
          updateNomorUjianApp2(e.target);
        }
      }
    });

    // Listener untuk aksi di Tab Mapel
    document.getElementById('btn-buka-modal-mapel-app2').addEventListener('click', bukaModalTambahMapelApp2);
    document.getElementById('btn-simpan-penempatan-mapel').addEventListener('click', simpanPenempatanMapel);
    document.getElementById('btn-tutup-modal-mapel-app2').addEventListener('click', tutupModalMapelApp2);
    document.getElementById('btn-batal-modal-mapel-app2').addEventListener('click', tutupModalMapelApp2);
    document.getElementById('btn-simpan-modal-mapel-app2').addEventListener('click', tambahkanMapelKeTabel);

    // ##### TAMBAHAN BARU (PERBAIKAN DARI ANDA) #####
    // Listener internal untuk modal Penempatan Mapel
    const searchInputPenempatan = document.getElementById('modal-penempatan-mapel-search');
    const suggestionsContainerPenempatan = document.getElementById('modal-penempatan-mapel-suggestions');
    const selectedContainerPenempatan = document.getElementById('modal-penempatan-mapel-selected');

    if (searchInputPenempatan && suggestionsContainerPenempatan && selectedContainerPenempatan) {
      searchInputPenempatan.addEventListener('input', updatePenempatanMapelSuggestions);
      searchInputPenempatan.addEventListener('focus', updatePenempatanMapelSuggestions);

      searchInputPenempatan.addEventListener('blur', () => {
        setTimeout(() => {
          suggestionsContainerPenempatan.style.display = 'none';
        }, 150); // Jeda agar klik pada saran masih bisa terdeteksi
      });

      suggestionsContainerPenempatan.addEventListener('mousedown', (e) => {
        const target = e.target.closest('.mapel-suggestion-item');
        if (target) {
          e.preventDefault(); // Mencegah 'blur' dari input search
          const mapelId = target.dataset.id;
          const mapelNama = target.dataset.nama;
          addSelectedPenempatanMapelTag(mapelId, mapelNama);
        }
      });

      selectedContainerPenempatan.addEventListener('click', (e) => {
        const target = e.target.closest('.selected-mapel-tag-remove');
        if (target) {
          const mapelId = target.dataset.id;
          removeSelectedPenempatanMapelTag(mapelId);
          updatePenempatanMapelSuggestions(); // Perbarui saran setelah menghapus
        }
      });
    }
    // ##### AKHIR TAMBAHAN BARU #####


    // Listener dinamis untuk hapus baris mapel
    document.getElementById('penempatan-mapel-container').addEventListener('click', (e) => {
      const target = e.target.closest('.btn-remove-mapel-app2');
      if (target) {
        target.closest('tr').remove();
        isPenempatanMapelDirty = true;
        document.getElementById('btn-simpan-penempatan-mapel').disabled = false;
      }
    });
    // --- AKHIR TAMBAHAN ---

    // [MODIFIKASI] Menambahkan event listener 'change' untuk dropdown kelas
    document.getElementById('penempatan-mapel-container').addEventListener('change', (e) => {
      const target = e.target;
      if (target.classList.contains('penempatan-mapel-kelas-select')) {
        isPenempatanMapelDirty = true;
        document.getElementById('btn-simpan-penempatan-mapel').disabled = false;
      }
    });
    // [AKHIR MODIFIKASI]

    document.getElementById('btn-kembali-ke-dashboard-7').addEventListener('click', () => {
      handleNavigationConfirm(() => tampilHalaman('halaman-utama'));
    });
    document.getElementById('form-semester').addEventListener('submit', (e) => {
      e.preventDefault();
      simpanSemester();
    });
    document.getElementById('btn-simpan-input-nilai').addEventListener('click', simpanInputNilai);
    
    document.getElementById('btn-bersihkan-input-nilai').addEventListener('click', konfirmasiBersihkanNilai);

    document.getElementById('halaman-input-nilai-detail').addEventListener('input', (e) => {
      if (e.target.classList.contains('input-nilai')) {
        isFormDirty = true; 
        
        let input = e.target;
        let value = input.value;
        
        let cleanedValue = value.replace(/[^\d]/g, ''); 
        
        if (cleanedValue !== value) {
          input.value = cleanedValue;
        }
        
        if (cleanedValue !== '') {
          let numValue = parseInt(cleanedValue, 10);
          
          if (numValue > 100) {
            input.value = ''; 
          } else {
            input.value = numValue.toString();
          }
        }
        
        const siswaId = e.target.dataset.siswaId;
        const table = e.target.closest('.input-nilai-table');
        
        const mapelCount = table.querySelectorAll('th.col-mapel').length;
        
        updateRowTotals(siswaId, mapelCount);
      }
    });

    document.getElementById('halaman-rekap-nilai').addEventListener('click', (e) => {
      e.stopPropagation();
      
      const targetNama = e.target.closest('.clickable-nama-siswa');
      if (targetNama) {
        const nisn = targetNama.dataset.nisn;
        showDynamicTooltip(targetNama, `NISN: ${nisn}`);
        return; 
      }

      const targetMapel = e.target.closest('.clickable-mapel-header');
      if (targetMapel) {
        const namaMapel = targetMapel.dataset.mapelNama;
        showDynamicTooltip(targetMapel, namaMapel);
      }
    });

    document.getElementById('halaman-input-nilai-detail').addEventListener('click', (e) => {
      e.stopPropagation();
      
      const targetNama = e.target.closest('.clickable-nama-siswa');
      if (targetNama) {
        const nisn = targetNama.dataset.nisn;
        showDynamicTooltip(targetNama, `NISN: ${nisn}`);
        return; 
      }

      const targetMapel = e.target.closest('.clickable-mapel-header');
      if (targetMapel) {
        const namaMapel = targetMapel.dataset.mapelNama;
        showDynamicTooltip(targetMapel, namaMapel);
      }
    });

    document.getElementById('input-nilai-filter-kelas').addEventListener('change', () => {
        currentNilaiPage = 1; // Reset ke halaman 1 saat filter berubah
        renderNilaiGridTable();
    });

    document.getElementById('rekap-nilai-filter-kelas').addEventListener('change', renderRekapNilaiTable);

    document.getElementById('btn-buka-mapel').addEventListener('click', () => {
      handleNavigationConfirm(bukaHalamanMapel);
    });
     document.getElementById('btn-kembali-ke-dashboard').addEventListener('click', () => {
      handleNavigationConfirm(() => tampilHalaman('halaman-utama'));
    });

    document.getElementById('form-data-sekolah').addEventListener('submit', (e) => {
      e.preventDefault();
      simpanDataSekolah();
    });

    document.getElementById('data-jenjang-pilihan').addEventListener('change', updateTampilanNSM);

    document.getElementById('form-data-sekolah').addEventListener('input', () => {
      isFormDirty = true;
    });

    const dataSekolahFieldsToWatch = [
      'data-jenjang-pilihan', 'data-npsn', 'data-alamat', 'data-kepsek', 'data-nsm'
    ];
    
    dataSekolahFieldsToWatch.forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        const eventType = (el.tagName.toLowerCase() === 'select') ? 'change' : 'input';
        el.addEventListener(eventType, () => {
          el.classList.remove('input-error');
        });
      }
    });

    const modalSiswaFieldsToWatch = [
      'modal-siswa-nama', 
      'modal-siswa-nisn', 
      'modal-siswa-jk', 
      'modal-siswa-kelas'
    ];
    
    modalSiswaFieldsToWatch.forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        const eventType = (el.tagName.toLowerCase() === 'select') ? 'change' : 'input';
        el.addEventListener(eventType, () => {
          el.classList.remove('input-error');
        });
      }
    });

    // --- TAMBAHKAN BLOK LISTENER BARU DI SINI ---
    const modalNisnInput = document.getElementById('modal-siswa-nisn');
    if (modalNisnInput) {
      modalNisnInput.addEventListener('input', validateNisnFormat);
      modalNisnInput.addEventListener('blur', validateNisnFormat);
    }
    
    const modalNisLokalInput = document.getElementById('modal-siswa-nis-lokal');
    if (modalNisLokalInput) {
      modalNisLokalInput.addEventListener('input', validateNisLokalFormat);
      modalNisLokalInput.addEventListener('blur', validateNisLokalFormat);
    }

    // --- TAMBAHKAN BLOK LISTENER BARU DI SINI ---
    const modalMapelIdInput = document.getElementById('modal-mapel-id');
    if (modalMapelIdInput) {
      modalMapelIdInput.addEventListener('input', validateMapelIdFormat);
      modalMapelIdInput.addEventListener('blur', validateMapelIdFormat);
    }
    // --- AKHIR BLOK BARU ---

    document.getElementById('form-bobot').addEventListener('submit', (e) => {
      e.preventDefault();
      simpanBobot();
    });
    document.getElementById('form-bobot').addEventListener('input', () => {
      isFormDirty = true;
    });
    document.getElementById('bobot-rapor').addEventListener('input', () => { sinkronkanBobot('rapor'); });
    document.getElementById('bobot-ujian').addEventListener('input', () => { sinkronkanBobot('ujian'); });

    document.getElementById('form-kelas').addEventListener('submit', (e) => {
      e.preventDefault();
      simpanKelas();
    });
    
    
    document.getElementById('kelas-list-container').addEventListener('click', (e) => {
      const target = e.target;

      if (target.classList.contains('btn-add-kelas') || target.classList.contains('btn-remove-kelas')) {
        isFormDirty = true;
      }
      
      if (target.classList.contains('btn-add-kelas')) {
        
        // --- PERBAIKAN DI SINI: Gunakan getCurrentKelasList() ---
        // 1. Panggil fungsi yang sudah benar untuk mendapatkan data objek
        const currentData = getCurrentKelasList();
        
        // 2. Ubah kembali ke format yang diharapkan oleh renderKelasList
        const currentList = currentData.map(item => {
           const lockedStatus = globalKelasListCache.find(k => k.nama === item.oldName);
           return {
             nama: item.newName, // Kirim nama yang baru diedit (jika ada)
             isLocked: lockedStatus ? lockedStatus.isLocked : false
           };
        });
        // --- AKHIR PERBAIKAN ---

        currentList.push({ nama: '', isLocked: false });
        renderKelasList(currentList);
        
        const lastInput = document.querySelector('#kelas-list-container .kelas-input-row:last-child input');
        if (lastInput) {
          lastInput.focus();
        }
      
      } 
      else if (target.classList.contains('btn-remove-kelas')) {
        
        const rowToRemove = target.parentElement;
        const allRows = Array.from(document.querySelectorAll('#kelas-list-container .kelas-input-row'));
        const indexToRemove = allRows.indexOf(rowToRemove);

        // --- PERBAIKAN DI SINI: Gunakan getCurrentKelasList() ---
        const currentData = getCurrentKelasList();
        const currentList = currentData.map(item => {
           const lockedStatus = globalKelasListCache.find(k => k.nama === item.oldName);
           return {
             nama: item.newName,
             isLocked: lockedStatus ? lockedStatus.isLocked : false
           };
        });
        // --- AKHIR PERBAIKAN ---
        
        if (indexToRemove > -1) {
          currentList.splice(indexToRemove, 1);
        }
        
        renderKelasList(currentList);
      }
    });

    document.getElementById('kelas-list-container').addEventListener('input', (e) => {
      if (e.target.tagName === 'INPUT') {
        isFormDirty = true;
      }
    });

    document.getElementById('btn-recalculate-ijazah').addEventListener('click', jalankanRekalkulasiIjazah);

    document.getElementById('btn-buka-validasi-nilai').addEventListener('click', () => {
      handleNavigationConfirm(bukaHalamanValidasi);
    });
    document.getElementById('btn-kembali-ke-dashboard-10').addEventListener('click', () => {
      handleNavigationConfirm(() => tampilHalaman('halaman-utama'));
    });
    // ===== MODIFIKASI DI BAWAH INI =====
    // Listener filter sekarang memanggil fungsi render yang baru
    document.getElementById('validasi-filter-kelas').addEventListener('change', renderValidasiTableBySiswa);

    // TAMBAHKAN LISTENER TAB BARU
    document.getElementById('validasi-tab-bar').addEventListener('click', (e) => {
      if (e.target.classList.contains('tab-link')) {
        const tabName = e.target.dataset.tab;
        activateValidasiTab(tabName);
      }
    });
    // ===== AKHIR MODIFIKASI =====

    // ===== TAMBAHKAN BLOK EVENT LISTENER BARU DI BAWAH INI =====
    // [BARU] Listener untuk klik pada sel tabel "Validasi per Mapel"
    document.getElementById('validasi-mapel-table-container').addEventListener('click', (e) => {
      const targetCell = e.target.closest('td');
      
      // Pastikan yang diklik adalah sel data (bukan header atau sel mapel pertama)
      if (!targetCell || targetCell.cellIndex === 0) return;

      const mapelId = targetCell.dataset.mapelId;
      const componentId = targetCell.dataset.componentId;
      
      if (mapelId && componentId) {
        showMissingStudentsTooltip(targetCell, mapelId, componentId);
      }
    });
    // ===== AKHIR BLOK BARU =====

    document.getElementById('btn-import-siswa').addEventListener('click', bukaModalImportSiswa);
    document.getElementById('btn-tambah-siswa-baru').addEventListener('click', () => { showModalSiswa('add', {}); });
    document.getElementById('btn-hapus-semua-siswa').addEventListener('click', hapusSemuaSiswa);
    document.getElementById('btn-simpan-siswa').addEventListener('click', simpanSiswa);
    document.getElementById('btn-tutup-modal-siswa').addEventListener('click', tutupModalSiswa);
    document.getElementById('btn-batal-modal-siswa').addEventListener('click', tutupModalSiswa);
    document.getElementById('siswa-table-container').addEventListener('click', (e) => {
      const target = e.target.closest('button');
      if (!target) return;

      if (target.classList.contains('btn-edit-siswa')) {
          const dataset = target.dataset;
          const siswaData = { id: dataset.id, nama: dataset.nama, nisn: dataset.nisn, nisLokal: dataset.nisLokal, jk: dataset.jk, tempatLahir: dataset.tempatLahir, tglLahir: dataset.tglLahir, kelas: dataset.kelas };
          showModalSiswa('edit', siswaData);
      
      } else if (target.classList.contains('btn-delete-siswa')) {
          const id = target.getAttribute('data-id');
          const nama = target.getAttribute('data-nama');
          hapusSiswa(id, nama);
      
      } 
      else if (target.classList.contains('btn-move-up') || target.classList.contains('btn-move-down')) {
          
          const siswaID = target.dataset.id;
          const direction = target.classList.contains('btn-move-up') ? 'up' : 'down';

          const targetSiswa = globalSiswaList.find(s => s.id === siswaID);
          if (!targetSiswa) return;

          const classmates = globalSiswaList
                              .filter(s => s.kelas === targetSiswa.kelas)
                              .sort((a,b) => a.urutan - b.urutan);
          
          const targetIndexInClass = classmates.findIndex(s => s.id === siswaID);

          let swapSiswa = null;
          if (direction === 'up' && targetIndexInClass > 0) {
            swapSiswa = classmates[targetIndexInClass - 1];
          } else if (direction === 'down' && targetIndexInClass < classmates.length - 1) {
            swapSiswa = classmates[targetIndexInClass + 1];
          }

          if (swapSiswa) {
            const tempUrutan = targetSiswa.urutan;
            targetSiswa.urutan = swapSiswa.urutan;
            swapSiswa.urutan = tempUrutan;
            
            applySiswaFiltersAndRender();
            checkSiswaDirtyState();
          }
      }
    });

    document.getElementById('btn-batal-siswa-actions').addEventListener('click', cancelSiswaChanges);

    // Update listener 'Simpan Urutan Siswa'
    document.getElementById('btn-simpan-urutan-siswa').addEventListener('click', () => {
      setLoading(true, 'Menyimpan urutan...');
      hideMessage('siswa-message');
      const urutanData = globalSiswaList.map(siswa => ({ id: siswa.id, urutan: siswa.urutan }));
      google.script.run.withSuccessHandler(onSiswaUrutanSaved).withFailureHandler(onGagal).saveSiswaUrutanBatch(getToken(), urutanData);
    });

    document.getElementById('siswa-filter-kelas').addEventListener('change', applySiswaFiltersAndRender);
    document.getElementById('siswa-sort-by').addEventListener('change', applySiswaFiltersAndRender);

    // Update listener untuk tombol 'Ambil Mapel Default'
    document.getElementById('btn-ambil-default').addEventListener('click', () => {
      const title = "Ambil Mapel Default";
      const message = "Lanjutkan sinkronisasi mapel default?";
      const callback = function() { setLoading(true, 'Sinkronisasi...'); google.script.run.withSuccessHandler(onTableRefreshed).withFailureHandler(onGagal).syncDefaultMapel(getToken()); };
      showConfirmationModal(title, message, callback, 'primary');
    });

    // Update listener untuk tombol 'Hapus Semua Mapel'
    document.getElementById('btn-hapus-semua').addEventListener('click', () => {
      const title = "PERINGATAN!";
      const message = "Hapus SEMUA mata pelajaran? Tidak bisa dibatalkan.";
      const callback = function() { setLoading(true, 'Menghapus semua...'); google.script.run.withSuccessHandler(onTableRefreshed).withFailureHandler(onGagal).deleteAllMapel(getToken()); };
      showConfirmationModal(title, message, callback, 'danger');
    });

    document.getElementById('btn-tambah-mapel-baru').addEventListener('click', () => { showModalMapel('add'); });
    document.getElementById('btn-tutup-modal').addEventListener('click', tutupModalMapel);
    document.getElementById('btn-batal-modal').addEventListener('click', tutupModalMapel);
    document.getElementById('btn-simpan-mapel').addEventListener('click', simpanMapel);
    document.getElementById('btn-simpan-tipe-ujian').addEventListener('click', simpanTipeUjian);

    // Update listener 'Simpan Urutan Mapel'
    document.getElementById('btn-simpan-urutan-mapel').addEventListener('click', () => {
      setLoading(true, 'Menyimpan urutan...');
      hideMessage('mapel-message');
      const urutanData = globalMapelList.map(mapel => ({ id: mapel.id, urutan: mapel.urutan }));
      google.script.run.withSuccessHandler(onMapelUrutanSaved).withFailureHandler(onGagal).saveMapelUrutanBatch(getToken(), urutanData);
    });

    document.getElementById('btn-batal-mapel-actions').addEventListener('click', cancelMapelChanges);

    document.getElementById('mapel-table-container').addEventListener('change', (e) => {
        if (e.target.classList.contains('mapel-tipe-cek')) {
          checkMapelDirtyState();
        }
    });

    document.getElementById('mapel-table-container').addEventListener('click', (e) => {
        const target = e.target.closest('button');
        if (!target) return;
        
        if (target.classList.contains('btn-edit')) {
            const id = target.getAttribute('data-id');
            const nama = target.getAttribute('data-nama');
            showModalMapel('edit', id, nama);
        } else if (target.classList.contains('btn-delete')) {
            const id = target.getAttribute('data-id');
            hapusMapel(id);
        } else if (target.classList.contains('btn-move-up-mapel') || target.classList.contains('btn-move-down-mapel')) {
          
          const mapelID = target.dataset.id;
          const direction = target.classList.contains('btn-move-up-mapel') ? 'up' : 'down';

          const targetIndex = globalMapelList.findIndex(s => s.id === mapelID);
          if (targetIndex === -1) return;
          
          let swapIndex = -1;
          if (direction === 'up' && targetIndex > 0) {
            swapIndex = targetIndex - 1;
          } else if (direction === 'down' && targetIndex < globalMapelList.length - 1) {
            swapIndex = targetIndex + 1;
          }

          if (swapIndex > -1) {
            const targetMapel = globalMapelList[targetIndex];
            const swapMapel = globalMapelList[swapIndex];

            const tempUrutan = targetMapel.urutan;
            targetMapel.urutan = swapMapel.urutan;
            swapMapel.urutan = tempUrutan;
            
            globalMapelList.sort((a,b) => a.urutan - b.urutan);
            
            onMapelLoaded({ status: "sukses", mapel: globalMapelList, isReRender: true });
            
            checkMapelDirtyState();
          }
        }
    });

    document.getElementById('btn-confirm-cancel').addEventListener('click', hideConfirmationModal);
    document.getElementById('btn-confirm-close').addEventListener('click', hideConfirmationModal);
    document.getElementById('btn-confirm-ok').addEventListener('click', () => {
        const modal = document.getElementById('confirmation-modal');
        if (typeof modal.onConfirm === 'function') { modal.onConfirm(); }
        hideConfirmationModal();
    });
    document.getElementById('btn-info-close').addEventListener('click', hideInfoModal);
    document.getElementById('btn-info-ok').addEventListener('click', hideInfoModal);

    document.getElementById('btn-tutup-modal-import-siswa').addEventListener('click', tutupModalImportSiswa);
    document.getElementById('btn-batal-modal-import-siswa').addEventListener('click', tutupModalImportSiswa);
    document.getElementById('btn-download-template-siswa').addEventListener('click', downloadTemplateSiswa);
    document.getElementById('btn-proses-import-siswa').addEventListener('click', prosesImportFileSiswa);

    const fileUploadZone = document.getElementById('file-upload-zone');
    const fileUploadInput = document.getElementById('file-upload-siswa');
    const fileUploadText = document.getElementById('file-upload-text');
    const btnProsesImport = document.getElementById('btn-proses-import-siswa');

    fileUploadInput.addEventListener('change', (e) => {
        const fileInput = e.target;
        if (fileInput.files.length > 0) {
            const fileName = fileInput.files[0].name;
            if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                fileUploadText.innerText = `File dipilih: ${fileName}`;
                fileUploadText.classList.add('file-chosen');
                btnProsesImport.disabled = false;
                hideMessage('template-message');
            } else {
                fileUploadText.innerText = 'File harus berekstensi .xlsx atau .xls';
                fileUploadText.classList.remove('file-chosen');
                btnProsesImport.disabled = true;
            }
        } else {
            fileUploadText.innerText = 'Klik untuk memilih file atau seret & letakkan di sini.';
            fileUploadText.classList.remove('file-chosen');
            btnProsesImport.disabled = true;
        }
    });

    fileUploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        fileUploadZone.classList.add('drag-over');
    });

    fileUploadZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        fileUploadZone.classList.remove('drag-over');
    });

    fileUploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        fileUploadZone.classList.remove('drag-over');
        
        if (e.dataTransfer.files.length > 0) {
          fileUploadInput.files = e.dataTransfer.files;
          const changeEvent = new Event('change');
          fileUploadInput.dispatchEvent(changeEvent);
        }
    });

    document.getElementById('btn-import-guru').addEventListener('click', bukaModalImportGuru);
    document.getElementById('btn-tutup-modal-import-guru').addEventListener('click', tutupModalImportGuru);
    document.getElementById('btn-batal-modal-import-guru').addEventListener('click', tutupModalImportGuru);
    document.getElementById('btn-download-template-guru').addEventListener('click', downloadTemplateGuru);
    document.getElementById('btn-proses-import-guru').addEventListener('click', prosesImportFileGuru);

    const fileUploadZoneGuru = document.getElementById('file-upload-zone-guru');
    const fileUploadInputGuru = document.getElementById('file-upload-guru');
    const fileUploadTextGuru = document.getElementById('file-upload-text-guru');
    const btnProsesImportGuru = document.getElementById('btn-proses-import-guru');

    fileUploadInputGuru.addEventListener('change', (e) => {
        const fileInput = e.target;
        if (fileInput.files.length > 0) {
            const fileName = fileInput.files[0].name;
            if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                fileUploadTextGuru.innerText = `File dipilih: ${fileName}`;
                fileUploadTextGuru.classList.add('file-chosen');
                btnProsesImportGuru.disabled = false;
                hideMessage('template-guru-message');
            } else {
                fileUploadTextGuru.innerText = 'File harus berekstensi .xlsx atau .xls';
                fileUploadTextGuru.classList.remove('file-chosen');
                btnProsesImportGuru.disabled = true;
            }
        } else {
            fileUploadTextGuru.innerText = 'Klik untuk memilih file atau seret & letakkan di sini.';
            fileUploadTextGuru.classList.remove('file-chosen');
            btnProsesImportGuru.disabled = true;
        }
    });

    fileUploadZoneGuru.addEventListener('dragover', (e) => {
        e.preventDefault();
        fileUploadZoneGuru.classList.add('drag-over');
    });

    fileUploadZoneGuru.addEventListener('dragleave', (e) => {
        e.preventDefault();
        fileUploadZoneGuru.classList.remove('drag-over');
    });

    fileUploadZoneGuru.addEventListener('drop', (e) => {
        e.preventDefault();
        fileUploadZoneGuru.classList.remove('drag-over');

        if (e.dataTransfer.files.length > 0) {
          fileUploadInputGuru.files = e.dataTransfer.files;
          const changeEvent = new Event('change');
          fileUploadInputGuru.dispatchEvent(changeEvent);
        }
    });

    document.getElementById('btn-tutup-modal-upload-nilai').addEventListener('click', tutupModalUploadNilai);
    document.getElementById('btn-batal-modal-upload-nilai').addEventListener('click', tutupModalUploadNilai);
    document.getElementById('btn-download-template-nilai').addEventListener('click', downloadTemplateNilai);
    document.getElementById('btn-proses-upload-nilai').addEventListener('click', prosesUploadFileNilai);

    const fileUploadZoneNilai = document.getElementById('file-upload-zone-nilai');
    const fileUploadInputNilai = document.getElementById('file-upload-nilai');
    const fileUploadTextNilai = document.getElementById('file-upload-text-nilai');
    const btnProsesUploadNilai = document.getElementById('btn-proses-upload-nilai');

    fileUploadInputNilai.addEventListener('change', (e) => {
        const fileInput = e.target;
        if (fileInput.files.length > 0) {
            const fileName = fileInput.files[0].name;
            if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                fileUploadTextNilai.innerText = `File dipilih: ${fileName}`;
                fileUploadTextNilai.classList.add('file-chosen');
                btnProsesUploadNilai.disabled = false;
                hideMessage('template-nilai-message');
            } else {
                fileUploadTextNilai.innerText = 'File harus berekstensi .xlsx atau .xls';
                fileUploadTextNilai.classList.remove('file-chosen');
                btnProsesUploadNilai.disabled = true;
            }
        } else {
            fileUploadTextNilai.innerText = 'Klik untuk memilih file atau seret & letakkan di sini.';
            fileUploadTextNilai.classList.remove('file-chosen');
            btnProsesUploadNilai.disabled = true;
        }
    });

    fileUploadZoneNilai.addEventListener('dragover', (e) => {
        e.preventDefault();
        fileUploadZoneNilai.classList.add('drag-over');
    });

    fileUploadZoneNilai.addEventListener('dragleave', (e) => {
        e.preventDefault();
        fileUploadZoneNilai.classList.remove('drag-over');
    });

    fileUploadZoneNilai.addEventListener('drop', (e) => {
        e.preventDefault();
        fileUploadZoneNilai.classList.remove('drag-over');
        
        if (e.dataTransfer.files.length > 0) {
          fileUploadInputNilai.files = e.dataTransfer.files;
          const changeEvent = new Event('change');
          fileUploadInputNilai.dispatchEvent(changeEvent);
        }
    });

    window.addEventListener('click', (e) => {
      if (!e.target.closest('#dynamic-tooltip') && !e.target.closest('.clickable-nama-siswa') && !e.target.closest('.clickable-mapel-header')) {
        hideDynamicTooltip();
      }
    });

    window.addEventListener('scroll', hideDynamicTooltip, { passive: true, capture: true });

    document.querySelector('#halaman-input-rapor-detail .tab-bar').addEventListener('click', (e) => {
      if (e.target.classList.contains('tab-link')) {
        const tabName = e.target.dataset.tab;
        activateRaporTab(tabName);
      }
    });

    document.getElementById('btn-buka-upload-rapor').addEventListener('click', bukaModalUploadNilaiRapor);
    document.getElementById('btn-tutup-modal-upload-nilai-rapor').addEventListener('click', tutupModalUploadNilaiRapor);
    document.getElementById('btn-batal-modal-upload-nilai-rapor').addEventListener('click', tutupModalUploadNilaiRapor);
    document.getElementById('btn-download-template-rapor').addEventListener('click', downloadTemplateNilaiRapor);
    document.getElementById('btn-proses-upload-nilai-rapor').addEventListener('click', prosesUploadFileNilaiRapor);

    const fileUploadZoneRapor = document.getElementById('file-upload-zone-rapor');
    const fileUploadInputRapor = document.getElementById('file-upload-rapor');
    const fileUploadTextRapor = document.getElementById('file-upload-text-rapor');
    const btnProsesUploadRapor = document.getElementById('btn-proses-upload-nilai-rapor');

    fileUploadInputRapor.addEventListener('change', (e) => {
        const fileInput = e.target;
        if (fileInput.files.length > 0) {
            const fileName = fileInput.files[0].name;
            if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                fileUploadTextRapor.innerText = `File dipilih: ${fileName}`;
                fileUploadTextRapor.classList.add('file-chosen');
                btnProsesUploadRapor.disabled = false;
                hideMessage('template-rapor-message');
            } else {
                fileUploadTextRapor.innerText = 'File harus berekstensi .xlsx atau .xls';
                fileUploadTextRapor.classList.remove('file-chosen');
                btnProsesUploadRapor.disabled = true;
            }
        } else {
            fileUploadTextRapor.innerText = 'Klik untuk memilih file atau seret & letakkan di sini.';
            fileUploadTextRapor.classList.remove('file-chosen');
            btnProsesUploadRapor.disabled = true;
        }
    });

    fileUploadZoneRapor.addEventListener('dragover', (e) => {
        e.preventDefault();
        fileUploadZoneRapor.classList.add('drag-over');
    });

    fileUploadZoneRapor.addEventListener('dragleave', (e) => {
        e.preventDefault();
        fileUploadZoneRapor.classList.remove('drag-over');
    });

    fileUploadZoneRapor.addEventListener('drop', (e) => {
        e.preventDefault();
        fileUploadZoneRapor.classList.remove('drag-over');
        
        if (e.dataTransfer.files.length > 0) {
          fileUploadInputRapor.files = e.dataTransfer.files;
          const changeEvent = new Event('change');
          fileUploadInputRapor.dispatchEvent(changeEvent);
        }
    });

    document.getElementById('btn-buka-input-rapor').addEventListener('click', () => {
      handleNavigationConfirm(bukaHalamanInputRapor);
    });
    document.getElementById('btn-kembali-ke-dashboard-8').addEventListener('click', () => {
      handleNavigationConfirm(() => tampilHalaman('halaman-utama'));
    });
    document.getElementById('btn-buka-rekap-rapor').addEventListener('click', () => {
      handleNavigationConfirm(bukaHalamanRekapRapor);
    });
    document.getElementById('btn-kembali-ke-input-rapor').addEventListener('click', () => {
      handleNavigationConfirm(bukaHalamanInputRapor);
    });
    document.getElementById('btn-kembali-ke-input-rapor-2').addEventListener('click', () => {
      handleNavigationConfirm(bukaHalamanInputRapor);
    });

    document.getElementById('btn-simpan-input-rapor-p').addEventListener('click', () => simpanInputNilaiRapor('P'));
    document.getElementById('btn-bersihkan-input-rapor-p').addEventListener('click', () => konfirmasiBersihkanNilaiRapor('P'));
    
    document.getElementById('btn-simpan-input-rapor-k').addEventListener('click', () => simpanInputNilaiRapor('K'));
    document.getElementById('btn-bersihkan-input-rapor-k').addEventListener('click', () => konfirmasiBersihkanNilaiRapor('K'));

    document.getElementById('halaman-input-rapor-detail').addEventListener('input', (e) => {
      if (e.target.classList.contains('input-nilai')) {
        isFormDirty = true; 

        let input = e.target;
        let value = input.value;
        let cleanedValue = value.replace(/[^\d]/g, ''); 
        if (cleanedValue !== value) {
          input.value = cleanedValue;
        }
        if (cleanedValue !== '') {
          let numValue = parseInt(cleanedValue, 10);
          if (numValue > 100) {
            input.value = ''; 
          } else {
            input.value = numValue.toString();
          }
        }
        
        const tableContainer = e.target.closest('.input-nilai-table-container');
        if (!tableContainer) return;

        const tipeNilai = (tableContainer.id === 'input-rapor-keterampilan-table-container') ? 'K' : 'P';
        const data = (tipeNilai === 'P') ? globalRaporData.P : globalRaporData.K;
        const mapelCount = data.mapelList.length;
        const siswaId = e.target.dataset.siswaId;

        updateRowTotalsRapor(siswaId, mapelCount, tipeNilai);
      }
    });

    document.getElementById('halaman-input-rapor-detail').addEventListener('click', (e) => {
      e.stopPropagation();
      const targetNama = e.target.closest('.clickable-nama-siswa');
      if (targetNama) {
        const nisn = targetNama.dataset.nisn;
        showDynamicTooltip(targetNama, `NISN: ${nisn}`);
        return; 
      }
      const targetMapel = e.target.closest('.clickable-mapel-header');
      if (targetMapel) {
        const namaMapel = targetMapel.dataset.mapelNama;
        showDynamicTooltip(targetMapel, namaMapel);
      }
    });

    document.getElementById('halaman-rekap-rapor').addEventListener('click', (e) => {
      e.stopPropagation();
      const targetNama = e.target.closest('.clickable-nama-siswa');
      if (targetNama) {
        const nisn = targetNama.dataset.nisn;
        showDynamicTooltip(targetNama, `NISN: ${nisn}`);
        return; 
      }
      const targetMapel = e.target.closest('.clickable-mapel-header');
      if (targetMapel) {
        const namaMapel = targetMapel.dataset.mapelNama;
        showDynamicTooltip(targetMapel, namaMapel);
      }
    });

    document.getElementById('input-rapor-filter-kelas').addEventListener('change', () => {
      renderNilaiRaporGridTable('P');
      renderNilaiRaporGridTable('K');
      renderRekapRaporSemesterTable();
    });
    document.getElementById('rekap-rapor-filter-kelas').addEventListener('change', renderRekapRaporTable);

    document.getElementById('btn-buka-nilai-ijazah').addEventListener('click', () => {
      handleNavigationConfirm(bukaHalamanNilaiIjazah);
    });
    document.getElementById('btn-kembali-ke-dashboard-9').addEventListener('click', () => {
      handleNavigationConfirm(() => tampilHalaman('halaman-utama'));
    });
    document.getElementById('ijazah-tab-bar').addEventListener('click', (e) => {
      if (e.target.classList.contains('tab-link')) {
        const tabName = e.target.dataset.tab;
        activateIjazahTab(tabName);
      }
    });
    document.getElementById('ijazah-filter-kelas').addEventListener('change', () => {
      // 1. Nonaktifkan tombol
      setIjazahExportButtonsDisabled(true);
      
      // 2. Beri jeda 10ms agar UI browser sempat update (tombol terlihat nonaktif)
      setTimeout(() => {
        // 3. Render ulang semua tabel
        renderNilaiIjazahTabel('ujian');
        renderNilaiIjazahTabel('rapor');
        renderNilaiIjazahTabel('ijazah');
        
        // 4. Aktifkan kembali tombol
        setIjazahExportButtonsDisabled(false);
      }, 10);
    });

    document.getElementById('btn-toggle-ujian-view').addEventListener('click', toggleUjianView);
    document.getElementById('btn-toggle-rapor-view').addEventListener('click', toggleRaporView);

    document.getElementById('halaman-nilai-ijazah').addEventListener('click', (e) => {
      const exportButton = e.target.closest('.btn-export-icon');
      if (exportButton) {
        e.preventDefault();
        const tipeFile = exportButton.dataset.tipe;
        const tipeData = exportButton.dataset.tab;
        handleExportClick(exportButton, tipeFile, tipeData);
        return; 
      }
      
      e.stopPropagation();
      const targetNama = e.target.closest('.clickable-nama-siswa');
      if (targetNama) {
        const nisn = targetNama.dataset.nisn;
        showDynamicTooltip(targetNama, `NISN: ${nisn}`);
        return; 
      }
      const targetMapel = e.target.closest('.clickable-mapel-header');
      if (targetMapel) {
        const namaMapel = targetMapel.dataset.mapelNama;
        showDynamicTooltip(targetMapel, namaMapel);
      }
    });

    document.getElementById('halaman-validasi-nilai').addEventListener('click', (e) => {
      e.stopPropagation();
      
      // Cek klik pada nama siswa
      const targetNama = e.target.closest('.clickable-nama-siswa');
      if (targetNama) {
        const nisn = targetNama.dataset.nisn;
        showDynamicTooltip(targetNama, `NISN: ${nisn}`);
        return; 
      }

      // Cek klik pada header mapel
      const targetMapel = e.target.closest('.clickable-mapel-header');
      if (targetMapel) {
        const namaMapel = targetMapel.dataset.mapelNama;
        showDynamicTooltip(targetMapel, namaMapel);
      }
    });

    // Update listener tombol 'Update Semua Data'
    document.getElementById('btn-update-semua-data').addEventListener('click', () => {
      const title = "Konfirmasi Update Data";
      const message = "Bersihkan cache dan muat ulang data dari server?";
      const callback = function() {
        setLoading(true, 'Membersihkan cache...');
        google.script.run.withSuccessHandler(onUpdateSemuaDataSukses).withFailureHandler(onGagal).clearAllCaches(getToken());
      };
      showConfirmationModal(title, message, callback, 'primary');
    });

    // --- TAMBAHAN BARU: Listener untuk Halaman Superadmin ---
    document.getElementById('btn-tambah-sekolah-baru').addEventListener('click', () => {
      showModalSekolah('add', {});
    });
    
    document.getElementById('btn-tutup-modal-sekolah').addEventListener('click', tutupModalSekolah);
    document.getElementById('btn-batal-modal-sekolah').addEventListener('click', tutupModalSekolah);
    document.getElementById('btn-simpan-sekolah').addEventListener('click', simpanSekolah);

    document.getElementById('superadmin-sekolah-list').addEventListener('click', (e) => {
      const target = e.target.closest('button');
      if (!target) return;

      if (target.classList.contains('btn-edit-sekolah')) {
          const dataset = target.dataset;
          const sekolahData = { 
            id: dataset.id, 
            nama: dataset.nama, 
            jenjang: dataset.jenjang, 
            email: dataset.email,
            spreadsheetId: dataset.ssid
          };
          showModalSekolah('edit', sekolahData);
      
      } else if (target.classList.contains('btn-delete-sekolah')) {
          const id = target.dataset.id;
          const nama = target.dataset.nama;
          const ssid = target.dataset.ssid;
          konfirmasiHapusSekolah(id, nama, ssid);
      
      // --- TAMBAHAN BARU DI SINI ---
      } else if (target.classList.contains('btn-impersonate-sekolah')) {
          const id = target.dataset.id;
          const nama = target.dataset.nama;
          konfirmasiImpersonate(id, nama);
      // --- AKHIR TAMBAHAN ---
      // --- TAMBAHKAN BLOK ELSE IF BARU DI BAWAH INI ---
      } else if (target.classList.contains('btn-batalkan-premium')) {
          const id = target.dataset.id;
          const nama = target.dataset.nama;
          konfirmasiBatalkanPremium(id, nama);
      } 
      // --- AKHIR BLOK BARU ---
    });
    // --- AKHIR TAMBAHAN ---

    // --- TAMBAHKAN LISTENER MODAL ALASAN BARU ---
    document.getElementById('btn-alasan-close').addEventListener('click', tutupAlasanModal);
    document.getElementById('btn-alasan-cancel').addEventListener('click', tutupAlasanModal);
    document.getElementById('btn-alasan-ok').addEventListener('click', handleAlasanConfirm);
    // --- AKHIR TAMBAHAN ---

    // --- TAMBAHKAN LISTENER UNTUK FILE UPLOAD DONASI ---
    const fileUploadZoneDonasi = document.getElementById('file-upload-zone-donasi');
    const fileUploadInputDonasi = document.getElementById('donasi-file');
    const fileUploadTextDonasi = document.getElementById('file-upload-text-donasi');

    if (fileUploadInputDonasi) {
      fileUploadInputDonasi.addEventListener('change', (e) => {
          const fileInput = e.target;
          if (fileInput.files.length > 0) {
              const fileName = fileInput.files[0].name;
              fileUploadTextDonasi.innerText = `File dipilih: ${fileName}`;
              fileUploadTextDonasi.classList.add('file-chosen');
              hideMessage('donasi-message');
          } else {
              fileUploadTextDonasi.innerText = 'Klik untuk memilih file...';
              fileUploadTextDonasi.classList.remove('file-chosen');
          }
      });
    }

    if (fileUploadZoneDonasi) {
      fileUploadZoneDonasi.addEventListener('dragover', (e) => {
          e.preventDefault();
          fileUploadZoneDonasi.classList.add('drag-over');
      });

      fileUploadZoneDonasi.addEventListener('dragleave', (e) => {
          e.preventDefault();
          fileUploadZoneDonasi.classList.remove('drag-over');
      });

      fileUploadZoneDonasi.addEventListener('drop', (e) => {
          e.preventDefault();
          fileUploadZoneDonasi.classList.remove('drag-over');
          
          if (e.dataTransfer.files.length > 0) {
            fileUploadInputDonasi.files = e.dataTransfer.files;
            const changeEvent = new Event('change');
            fileUploadInputDonasi.dispatchEvent(changeEvent);
          }
      });
    }
    // --- AKHIR LISTENER FILE UPLOAD DONASI ---

    document.addEventListener('keydown', handleKeyDown);
    
    document.getElementById('halaman-input-nilai-detail')
      .addEventListener('paste', handlePasteEvent);
      
    document.getElementById('halaman-input-rapor-detail')
      .addEventListener('paste', handlePasteEvent);

    window.addEventListener('mousemove', resetInactivityTimer);
    window.addEventListener('mousedown', resetInactivityTimer);
    window.addEventListener('keypress', resetInactivityTimer);
    window.addEventListener('touchstart', resetInactivityTimer, { passive: true });
    window.addEventListener('scroll', resetInactivityTimer, { passive: true });

    // --- LOGIKA PEMUATAN AWAL (ROUTING) YANG SUDAH DIPERBAIKI ---
    const token = localStorage.getItem('sessionToken');

    if (token) {
      // Tampilkan loading screen penuh. Biarkan onTokenCheck yang memutuskan halaman.
      setLoading(true, 'Memverifikasi sesi...', true, true); 
      
      google.script.run
        .withSuccessHandler(onTokenCheck) 
        .withFailureHandler(onTokenCheckFailed)
        .checkToken(token);
        
    } else {
      // TIDAK ADA TOKEN (Pengguna belum login)
            
      // Periksa apakah URL memiliki hash
      if (window.location.hash === '#login-guru') {
        // Jika ya, langsung tampilkan halaman login guru dan aktifkan tab-nya
        tampilHalaman('halaman-login-guru');
        activateAuthTab('guru');
      } else if (window.location.hash === '#login-siswa') {
        // Bonus: tambahkan juga untuk siswa jika diperlukan
        tampilHalaman('halaman-login-siswa');
        activateAuthTab('siswa');
      } else {
        // Jika tidak ada hash, tampilkan halaman login admin default
        tampilHalaman('halaman-login');
        activateAuthTab('admin'); // Aktifkan tab admin secara eksplisit
      }
    }
    // --- AKHIR LOGIKA PEMUATAN AWAL ---
  });

  function activateRaporTab(tabName) {
    const page = document.getElementById('halaman-input-rapor-detail');
    
    const tabClasses = ['tab-pengetahuan-active', 'tab-keterampilan-active', 'tab-rekap-active'];
    let newActiveClass = '';

    page.querySelectorAll('.tab-link').forEach(link => {
      link.classList.remove('active');
    });

    page.querySelectorAll('.tab-content').forEach(content => {
      content.classList.remove('active');
    });

    page.querySelector(`.tab-link[data-tab="${tabName}"]`).classList.add('active');
    page.querySelector(`#tab-${tabName}-content`).classList.add('active');
    
    if (tabName === 'pengetahuan') {
      newActiveClass = 'tab-pengetahuan-active';
    } else if (tabName === 'keterampilan') {
      newActiveClass = 'tab-keterampilan-active';
    } else if (tabName === 'rekap') {
      newActiveClass = 'tab-rekap-active';
    }
    
    page.classList.remove(...tabClasses);
    if (newActiveClass) {
      page.classList.add(newActiveClass);
    }

    if (tabName === 'pengetahuan' || tabName === 'keterampilan') {
      autoScrollToBottom();
    }
  }

  function onTokenCheck(response) {
    setLoading(false);
    resetInactivityTimer();

    // --- TAMBAHAN BARU: Mendorong state "jebakan" ---
    // Ini menambahkan entri history baru sehingga "back"
    // tidak langsung keluar dari aplikasi.
    history.pushState(null, "", location.href);
    // --- AKHIR TAMBAHAN BARU ---

    const lastPageId = localStorage.getItem(LAST_PAGE_KEY);

    globalAppUrl = response.appUrl || '';
    updateRecalculateButtonState();

    isImpersonatingCache = false;
    document.getElementById('btn-kembali-ke-superadmin').style.display = 'none';

    currentUserRole = response.role;

    if (response.role === 'superadmin') {
      document.getElementById('salam-superadmin').innerText = `Selamat Datang, ${response.nama || response.namaSekolah}`;

      bukaHalamanSuperadmin();

    } else if (response.role === 'admin') {
      document.getElementById('salam-sekolah').innerText = `Selamat Datang, Admin ${response.namaSekolah}`;
      jenjangBaseCache = response.jenjang;
      jenjangPilihanCache = response.jenjangPilihan;

      if (response.isImpersonating) {
        isImpersonatingCache = true;
        document.getElementById('btn-kembali-ke-superadmin').style.display = 'inline-flex';
      }

      // --- TAMBAHKAN 2 BARIS INI ---
      globalDonasiStatus = response.donasiStatus || "NONE";
      updatePremiumFeatures(globalDonasiStatus);
      // --- AKHIR TAMBAHAN ---

      if (lastPageId && lastPageId !== 'halaman-superadmin' && lastPageId !== 'halaman-login' && lastPageId !== 'halaman-login-guru') {
        bukaHalamanTersimpan(lastPageId);
      } else {
        tampilHalaman('halaman-utama');
      }

    } else if (response.role === 'guru') {
      guruHasPraktek = response.hasUjianPraktek;
      guruHasMadrasah = response.hasUjianMadrasah;
      jenjangPilihanCache = response.jenjangPilihan;
      tampilkanDashboardGuru(response.namaGuru || 'Guru', response.namaSekolah);

      if (lastPageId === 'halaman-input-ujian' || lastPageId === 'halaman-input-nilai-detail') {
          bukaHalamanTersimpan(lastPageId);
      }

    } else {
      onTokenCheckFailed({ message: 'Peran pengguna tidak dikenal.' });
    }
  }

  // --- [GANTI FUNGSI INI] ---
  function hasilLogin(response) {
    setLoading(false);
    resetButtonLoading(document.getElementById('btn-login'));
    resetButtonLoading(document.getElementById('btn-login-guru'));

    if (response.status === "sukses") {
      // Logika login ADMIN dan SUPERADMIN (App 1) tetap sama
      localStorage.setItem('sessionToken', response.token);
      resetInactivityTimer();
      history.pushState(null, "", location.href);
      globalAppUrl = response.appUrl || '';
      isImpersonatingCache = false;
      document.getElementById('btn-kembali-ke-superadmin').style.display = 'none';
      currentUserRole = response.role;

      if (response.role === 'superadmin') {
        document.getElementById('salam-superadmin').innerText = `Selamat Datang, ${response.nama}`;
        tampilHalaman('halaman-superadmin');
        bukaHalamanSuperadmin();

      } else if (response.role === 'admin') {
        jenjangBaseCache = response.jenjang;
        jenjangPilihanCache = response.jenjangPilihan;
        document.getElementById('salam-sekolah').innerText = `Selamat Datang, Admin ${response.namaSekolah}`;

        if (response.isImpersonating) {
          isImpersonatingCache = true;
          document.getElementById('btn-kembali-ke-superadmin').style.display = 'inline-flex';
        }
        
        globalDonasiStatus = response.donasiStatus || "NONE";
        updatePremiumFeatures(globalDonasiStatus);
        tampilHalaman('halaman-utama');
      }
      // Logika 'else if (response.role === 'guru')' yang lama Dihapus

    } else if (response.status === "sso_redirect") {
      const targetUrl = response.redirectUrl;

      // Validasi URL
      if (!targetUrl || targetUrl === "undefined") {
          showToast("Gagal: URL tujuan tidak ditemukan. Hubungi Admin.", 'gagal');
          return;
      }

      showToast("Login berhasil. Mengalihkan...", 'sukses', 3000);

      // --- PERBAIKAN UTAMA DI SINI ---
      
      // 1. Siapkan fungsi pembatal timer
      // Ini akan dipanggil jika browser berhasil mulai memuat halaman baru
      const cancelFallback = () => {
          if (window.redirectTimer) {
              clearTimeout(window.redirectTimer);
              console.log("Redirect berhasil dimulai, timer fallback dibatalkan.");
          }
      };

      // 2. Pasang pendengar event (listener)
      // 'beforeunload' memicu saat halaman mulai ditinggalkan
      window.addEventListener('beforeunload', cancelFallback);
      window.addEventListener('pagehide', cancelFallback);

      // 3. Lakukan pengalihan SEGERA
      window.top.location.href = targetUrl;

      // 4. Timer Fallback (Diperpanjang ke 10 detik)
      // Hanya jalan jika dalam 10 detik halaman masih belum 'unload' (macet/koneksi putus)
      window.redirectTimer = setTimeout(() => {
         const loginBtn = document.getElementById('btn-login-guru');
         const errorP = document.getElementById('login-guru-error');
         
         // Pastikan elemen masih ada di DOM
         if (loginBtn) {
             // Ubah tombol menjadi tombol manual
             loginBtn.innerHTML = '<i class="fas fa-external-link-alt"></i> KLIK DI SINI';
             loginBtn.style.backgroundColor = '#198754'; // Hijau
             loginBtn.disabled = false; 
             loginBtn.type = 'button';  
             
             // Hapus event listener lama (jika ada) dan pasang baru
             loginBtn.onclick = function(e) {
                 e.preventDefault();
                 window.open(targetUrl, "_top");
             };
             
             if (errorP) {
                 errorP.innerHTML = `Jika tidak dialihkan otomatis, silakan klik tombol di atas.`;
                 errorP.style.display = 'block';
                 errorP.className = 'message'; 
                 errorP.style.color = '#0d6efd';
             }
         }
      }, 10000); // Ubah ke 10000 ms (10 detik)

    } else {
      // Logika 'gagal' tetap sama
      if (document.getElementById('halaman-login-guru').style.display !== 'none') {
          showMessage('login-guru-error', response.message, true);
      } else {
          showMessage('login-error', response.message, true);
          const loginPage = document.getElementById('halaman-login');
          if (loginPage.style.display !== 'none') {
            loginPage.classList.remove('login-fail-shake');
            void loginPage.offsetWidth; 
            loginPage.classList.add('login-fail-shake');
            setTimeout(() => {
              loginPage.classList.remove('login-fail-shake');
            }, 600);
          }
      }
    }
  }

  function hasilRegistrasi(response) {
      resetButtonLoading(document.getElementById('btn-registrasi'));
      
      if (response.status === "pending") {
        // Tampilkan pesan sukses (bukan error)
        showMessage('reg-message', response.message, false); 

        // Kosongkan form
        document.getElementById('reg-nama-sekolah').value = "";
        document.getElementById('reg-jenjang').value = "";
        document.getElementById('reg-email').value = "";
        document.getElementById('reg-password').value = "";
        document.getElementById('reg-password-confirm').value = "";
        
        // Reset validasi tooltip email
        validateEmailFormat(); 
        
        // Reset validasi tooltip password
        validatePasswordTooltip();
        
        // Reset validasi match
        validatePasswordMatch(); 

        // Pastikan tooltip password tidak lagi 'all-valid'
        const tooltipContainer = document.getElementById('reg-password-tooltip');
        if(tooltipContainer) {
          tooltipContainer.classList.remove('all-valid');
        }

      } else if (response.status === "gagal") {
        // Ini adalah GAGAL (email sudah ada, dll)
        showMessage('reg-message', response.message, true);
      
      } else {
        // Fallback untuk status 'sukses' (seharusnya tidak terjadi lagi dari registrasi)
        showMessage('reg-message', "Registrasi berhasil! (Status tidak dikenal)", false);
        // Pindahkan ke login jika status 'sukses' lama masih ada
        setTimeout(() => {
          tampilHalaman('halaman-login');
        }, 2500);
      }
    }

  function onLogout(response) {
    // Logika utama sekarang ada di forceLogoutInstan()
    // google.script.run.prosesLogout() hanya membersihkan sisi server.
  }

  function onGagal(error) {
    setLoading(false); 

    const pageNilaiUjian = document.getElementById('halaman-input-nilai-detail');
    const pageNilaiRapor = document.getElementById('halaman-input-rapor-detail');

    if (pageNilaiUjian && pageNilaiUjian.classList.contains('loading-in-progress')) {
      setTableInputLock('halaman-input-nilai-detail', false);
    }
    if (pageNilaiRapor && pageNilaiRapor.classList.contains('loading-in-progress')) {
      setTableInputLock('halaman-input-rapor-detail', false);
    }
    
    const btnLogin = document.getElementById('btn-login');
    if (btnLogin && btnLogin.classList.contains('loading')) {
      resetButtonLoading(btnLogin);
    }
    const btnReg = document.getElementById('btn-registrasi');
    if (btnReg && btnReg.classList.contains('loading')) {
      resetButtonLoading(btnReg);
    }
    // --- TAMBAHAN BARU ---
    const btnSimpanPengaturanGuru = document.getElementById('btn-simpan-pengaturan-guru');
    if (btnSimpanPengaturanGuru && btnSimpanPengaturanGuru.classList.contains('loading')) {
      resetButtonLoading(btnSimpanPengaturanGuru);
    }
    // --- AKHIR TAMBAHAN ---
    
    const errorMsg = error.message;

    if (errorMsg.includes("Sesi") || errorMsg.includes("Token")) {
      localStorage.removeItem('sessionToken');
      localStorage.removeItem(LAST_PAGE_KEY);
      tampilHalaman('halaman-login');
      showMessage('login-error', errorMsg, true);
    }
    else if (document.getElementById('halaman-login').style.display !== 'none') {
      showMessage('login-error', 'Error: ' + errorMsg, true);
    } else if (document.getElementById('halaman-registrasi').style.display !== 'none') {
      showMessage('reg-message', 'Error: ' + errorMsg, true);
    
    } else if (document.getElementById('mapel-modal').classList.contains('show')) {
      showMessage('modal-mapel-error', 'Error: ' + errorMsg, true);
    } else if (document.getElementById('siswa-modal').classList.contains('show')) {
      showMessage('modal-siswa-error', 'Error: ' + errorMsg, true);
    }
    else if (document.getElementById('import-siswa-modal').classList.contains('show')) {
      showMessage('template-message', 'Error: ' + errorMsg, true);
    }
    else if (document.getElementById('upload-nilai-modal').classList.contains('show')) {
      showMessage('template-nilai-message', 'Error: ' + errorMsg, true);
    }
    else if (document.getElementById('halaman-data-sekolah').style.display !== 'none') {
      setFormDisabled('form-data-sekolah', false);
      showMessage('data-sekolah-message', 'Error: ' + errorMsg, true);
    }
    else if (document.getElementById('halaman-bobot').style.display !== 'none') {
      setFormDisabled('form-bobot', false);
      showMessage('bobot-message', 'Error: ' + errorMsg, true);
    }
    else if (document.getElementById('halaman-kelas').style.display !== 'none') {
      setFormDisabled('form-kelas', false);
      showMessage('kelas-message', 'Error: ' + errorMsg, true);
    }
    else if (document.getElementById('halaman-siswa').style.display !== 'none') {
      document.getElementById('btn-cetak-kartu-siswa').disabled = false;
      document.getElementById('btn-tambah-siswa-baru').disabled = false;
      document.getElementById('btn-import-siswa').disabled = false;
      document.getElementById('btn-hapus-semua-siswa').disabled = false;
      document.getElementById('siswa-filter-kelas').disabled = false;
      document.getElementById('siswa-sort-by').disabled = false;
      showMessage('siswa-message', 'Error: ' + errorMsg, true);
    }
    else if (document.getElementById('halaman-mapel').style.display !== 'none') {
      document.getElementById('btn-tambah-mapel-baru').disabled = false;
      document.getElementById('btn-ambil-default').disabled = false;
      document.getElementById('btn-hapus-semua').disabled = false;
      showMessage('mapel-message', 'Error: ' + errorMsg, true);
    }
    else if (document.getElementById('halaman-input-nilai-detail').style.display !== 'none') {
      showMessage('input-nilai-message', 'Error: ' + errorMsg, true);
    }
    else if (document.getElementById('halaman-rekap-nilai').style.display !== 'none') {
      showMessage('rekap-nilai-message', 'Error: ' + errorMsg, true);
    }
    else if (document.getElementById('halaman-input-rapor-detail').style.display !== 'none') {
      showMessage('input-rapor-message', 'Error: ' + errorMsg, true);
    }
    else if (document.getElementById('halaman-rekap-rapor').style.display !== 'none') {
      showMessage('rekap-rapor-message', 'Error: ' + errorMsg, true);
    }
    else if (document.getElementById('halaman-semester').style.display !== 'none') {
      setFormDisabled('form-semester', false);
      showMessage('semester-message', 'Error: ' + errorMsg, true);
    }
    else if (document.getElementById('halaman-validasi-nilai').style.display !== 'none') {
      showMessage('validasi-message', 'Error: ' + errorMsg, true);
    }
    else if (document.getElementById('halaman-superadmin').style.display !== 'none') {
      showMessage('superadmin-message', 'Error: ' + errorMsg, true);
    }
    // --- BLOK 'ELSE IF' BERIKUT INI TELAH DIMODIFIKASI ---
    else if (document.getElementById('halaman-guru').style.display !== 'none') {
      // Cek apakah errornya di modal atau di halaman utama
      if (document.getElementById('guru-modal').classList.contains('show')) {
         showMessage('modal-guru-error', 'Error: ' + errorMsg, true);
      } else {
         // Tampilkan error di halaman guru (bisa di tabel atau di form pengaturan)
         showMessage('pengaturan-guru-message', 'Error: ' + errorMsg, true);
         
         // Aktifkan kembali tombol jika gagal memuat
         document.getElementById('btn-tambah-guru-baru').disabled = false;
         document.getElementById('btn-import-guru').disabled = false;
         document.getElementById('btn-simpan-pengaturan-guru').disabled = false;

         // Tampilkan error di dalam container tabel jika tabel gagal muat
         const tableContainer = document.getElementById('guru-table-container');
         if (tableContainer.innerHTML.includes("Memuat data guru...")) {
           tableContainer.innerHTML = `<p class="message error" style="display:block;">Gagal memuat: ${errorMsg}</p>`;
         }
      }
    }
    // --- START: TAMBAHKAN BLOK DI BAWAH INI ---
    else if (document.getElementById('halaman-pengaturan-cetak').style.display !== 'none') {
      // Aktifkan kembali input form jika gagal memuat
      const formInputs = document.querySelectorAll('#form-pengaturan-cetak input, #form-pengaturan-cetak select, #form-pengaturan-cetak button');
      formInputs.forEach(input => {
        if(input.id !== 'btn-simpan-pengaturan-cetak') {
            input.disabled = false;
        }
      });
      showMessage('pengaturan-cetak-message', 'Error: ' + errorMsg, true);
    }

    // --- AKHIR MODIFIKASI ---
    else if (document.getElementById('superadmin-sekolah-modal').classList.contains('show')) {
      showMessage('modal-sekolah-error', 'Error: ' + errorMsg, true);
    }
    else if (document.getElementById('halaman-pengaturan-cetak').style.display !== 'none') {
      const formInputs = document.querySelectorAll('#form-pengaturan-cetak input, #form-pengaturan-cetak select, #form-pengaturan-cetak button');
      formInputs.forEach(input => {
        if(input.id !== 'btn-simpan-pengaturan-cetak') {
            input.disabled = false;
        }
      });
      showMessage('pengaturan-cetak-message', 'Error: ' + errorMsg, true);
    }
    else if (document.getElementById('halaman-kelola-nilai-guru').style.display !== 'none') {
      showMessage('kelola-nilai-guru-message', 'Error: ' + errorMsg, true);
    }
    else if (document.getElementById('alasan-tolak-modal').classList.contains('show')) {
      showMessage('alasan-tolak-modal-error', 'Error: ' + errorMsg, true);
    }
    else if (document.getElementById('preview-nilai-guru-modal').classList.contains('show')) {
      showMessage('preview-modal-error', 'Error: ' + errorMsg, true);
    }
    else {
      showInfoModal('Terjadi Error', errorMsg, true);
    }
  }

  // Salin dan ganti fungsi bukaHalamanMapel() Anda dengan yang ini
  function bukaHalamanMapel() {
      tampilHalaman('halaman-mapel');
      isFormDirty = false;
      setMapelTipeDirty(false);
      setMapelOrderDirty(false);

      // --- PENAMBAHAN LOGIKA CACHE ---
      if (globalMapelList && globalMapelList.length > 0) {
          console.log("Memuat mapel dari cache klien...");
          // Panggil handler sukses secara manual dengan data cache
          // isReRender: true akan memastikan data original (untuk undo) tidak ditimpa
          onMapelLoaded({ status: "sukses", mapel: globalMapelList, isReRender: true });
      } else {
          // Jika tidak ada, baru panggil server
          console.log("Memuat mapel dari server...");
          setLoading(true, 'Memuat data mapel...', false, false);
          document.getElementById('mapel-table-container').innerHTML = "<p>Memuat data mapel...</p>";
          document.getElementById('btn-tambah-mapel-baru').disabled = true;
          document.getElementById('btn-ambil-default').disabled = true;
          document.getElementById('btn-hapus-semua').disabled = true;
          google.script.run
              .withSuccessHandler(onMapelLoaded)
              .withFailureHandler(onGagal)
              .getMapel(getToken());
      }
      // --- AKHIR PERUBAHAN ---
  }

  /**
   * VERSI REFACTOR (Cepat)
   * Menggunakan DocumentFragment untuk merender tabel mapel
   * (Menggantikan logika string HTML di dalam onMapelLoaded)
   */
  function onMapelLoaded(response) {
      setLoading(false);

      document.getElementById('btn-tambah-mapel-baru').disabled = false;
      document.getElementById('btn-ambil-default').disabled = false;
      document.getElementById('btn-hapus-semua').disabled = false;

      const container = document.getElementById('mapel-table-container');
      container.innerHTML = ""; // 1. Kosongkan container

      if (response.status === "sukses") {
          
          if (!response.isReRender) {
              response.mapel.forEach(m => {
                  m.originalUrutan = m.urutan;
                  m.originalIsUS = m.isUS || false;
                  m.originalIsUP = m.isUP || false;
              });
          }
          globalMapelList = response.mapel;

          const jenjangPilihan = jenjangPilihanCache;
          const labelUjian = (jenjangPilihan === 'MI' || jenjangPilihan === 'MTS' || jenjangPilihan === 'MA') ? 'UM' : 'US';

          // 2. Buat elemen tabel
          const table = document.createElement('table');
          table.className = 'mapel-table';

          // 3. Buat header
          const thead = table.createTHead();
          const headerRow = thead.insertRow();
          headerRow.innerHTML = `
              <th>Kode Mapel</th>
              <th>Nama Mapel</th>
              <th class="col-cek">${labelUjian}</th>
              <th class="col-cek col-up">UP</th>
              <th>Aksi</th>
          `;

          // 4. Buat body dan DocumentFragment
          const tbody = table.createTBody();
          const fragment = document.createDocumentFragment();

          if (globalMapelList.length === 0) {
              const emptyRow = tbody.insertRow();
              emptyRow.innerHTML = '<td colspan="5" style="text-align: center;">Belum ada data mapel.</td>';
          } else {
              globalMapelList.forEach((mapel, index) => {
                  const isUS = mapel.isUS || false;
                  const isUP = mapel.isUP || false;
                  
                  const isFirst = (index === 0);
                  const isLast = (index === globalMapelList.length - 1);
                  
                  // 5. Buat <tr> baru di memori
                  const tr = document.createElement('tr');
                  
                  // 6. Buat <td> satu per satu
                  
                  // TD Kode Mapel
                  const tdId = tr.insertCell();
                  tdId.textContent = mapel.id;
                  
                  // TD Nama Mapel
                  const tdNama = tr.insertCell();
                  tdNama.textContent = mapel.nama;
                  
                  // TD Checkbox US/UM
                  const tdUS = tr.insertCell();
                  tdUS.className = 'col-cek';
                  const inputUS = document.createElement('input');
                  inputUS.type = 'checkbox';
                  inputUS.className = 'mapel-tipe-cek';
                  inputUS.dataset.id = mapel.id;
                  inputUS.dataset.tipe = 'us';
                  inputUS.checked = isUS;
                  tdUS.appendChild(inputUS);
                  
                  // TD Checkbox UP
                  const tdUP = tr.insertCell();
                  tdUP.className = 'col-cek col-up';
                  const inputUP = document.createElement('input');
                  inputUP.type = 'checkbox';
                  inputUP.className = 'mapel-tipe-cek';
                  inputUP.dataset.id = mapel.id;
                  inputUP.dataset.tipe = 'up';
                  inputUP.checked = isUP;
                  tdUP.appendChild(inputUP);
                  
                  // TD Aksi (InnerHTML aman untuk bagian ini)
                  const tdAksi = tr.insertCell();
                  tdAksi.innerHTML = `
                    <div class="btn-grup-gerak">
                      <button 
                        class="btn-aksi btn-move-up btn-move-up-mapel" 
                        data-id="${mapel.id}" 
                        ${isFirst ? 'disabled' : ''}
                        title="Naikkan posisi">
                          <i class="fas fa-arrow-up"></i>
                      </button>
                      <button 
                        class="btn-aksi btn-move-down btn-move-down-mapel" 
                        data-id="${mapel.id}" 
                        ${isLast ? 'disabled' : ''}
                        title="Turunkan posisi">
                            <i class="fas fa-arrow-down"></i>
                      </button>
                    </div>
                    <div class="btn-grup-aksi">
                      <button class="btn-aksi btn-edit" data-id="${mapel.id}" data-nama="${mapel.nama}"><i class="fas fa-pencil-alt"></i>Edit</button>
                      <button class="btn-aksi btn-delete" data-id="${mapel.id}"><i class="fas fa-trash-alt"></i>Hapus</button>
                    </div>
                  `;
                  
                  // 7. Tambahkan <tr> ke fragment
                  fragment.appendChild(tr);
              });
          }
          
          // 8. Tambahkan fragment ke tbody
          tbody.appendChild(fragment);

          // 9. Tambahkan tabel ke container
          container.appendChild(table);
          
      } else {
          globalMapelList = [];
          const p = document.createElement('p');
          p.className = 'message error';
          p.style.display = 'block';
          p.textContent = `Gagal memuat mapel: ${response.message}`;
          container.appendChild(p);
      }
  }

  function showModalMapel(mode, id = '', nama = '') {
      document.getElementById('modal-mapel-mode').value = mode;
      hideMessage('modal-mapel-error');

      const idInput = document.getElementById('modal-mapel-id');

      if (mode === 'add') {
        document.getElementById('modal-title').innerText = "Tambah Mapel Baru";
        idInput.value = "";
        idInput.readOnly = false;
        document.getElementById('modal-mapel-nama').value = "";
      }
      else if (mode === 'edit') {
        document.getElementById('modal-title').innerText = "Edit Mapel";
        idInput.value = id;
        idInput.readOnly = true;
        document.getElementById('modal-mapel-nama').value = nama;
      }

      document.getElementById('mapel-modal').classList.add('show');
  }

  function tutupModalMapel() {
      document.getElementById('mapel-modal').classList.remove('show');
  }

  function simpanMapel() {
    hideMessage('modal-mapel-error');
    
    // --- PERUBAHAN DI SINI: Validasi format dulu ---
    const isMapelIdFormatValid = validateMapelIdFormat();
    if (!isMapelIdFormatValid) {
      showMessage('modal-mapel-error', "Kode Mapel tidak valid. Periksa kembali.", true);
      return; // Hentikan simpan
    }
    // --- AKHIR PERUBAHAN ---

    setLoading(true, 'Menyimpan mapel...');
    const mode = document.getElementById('modal-mapel-mode').value;
    const id = document.getElementById('modal-mapel-id').value.trim(); // Trim di sini
    const nama = document.getElementById('modal-mapel-nama').value.trim();
    
    // Cek wajib diisi (setelah trim)
    if (!id || !nama) {
        setLoading(false);
        showMessage('modal-mapel-error', 'Kode Mapel dan Nama Mapel wajib diisi.', true);
        return;
    }

    if (mode === 'add') {
      google.script.run.withSuccessHandler(onMapelSaved).withFailureHandler(onGagal).createMapel(getToken(), id, nama);
    } else {
      google.script.run.withSuccessHandler(onMapelSaved).withFailureHandler(onGagal).updateMapel(getToken(), id, nama);
    }
  }

  function hapusMapel(id) {
    const title = "Konfirmasi Hapus";
    const message = `Hapus mapel ID: <strong>${id}</strong>? Data nilai terkait mungkin hilang.`;
    const callback = function() {
      setLoading(true, 'Menghapus mapel...');
      
      // --- PERUBAHAN HANDLER DI SINI ---
      google.script.run
        .withSuccessHandler((response) => onMapelDeleted(response, id)) // Panggil handler baru
        .withFailureHandler(onGagal)
        .deleteMapel(getToken(), id);
      // --- AKHIR PERUBAHAN ---
        
    };
    showConfirmationModal(title, message, callback, 'danger');
  }

  function onMapelDeleted(response, deletedMapelID) {
      setLoading(false);

      if (response.status === "sukses") {
          setIjazahDirty(true);
          
          // --- TAMBAHAN INVALIDASI CACHE ---
          globalNilaiGridCacheUM = null;
          globalNilaiGridCachePraktek = null;
          globalNilaiRaporGridCache.clear();
          // --- AKHIR TAMBAHAN ---
          
          // --- LOGIKA OPTIMIS ---
          const indexToDelete = globalMapelList.findIndex(m => m.id === deletedMapelID);
          if (indexToDelete > -1) {
              globalMapelList.splice(indexToDelete, 1);
          }
          // --- AKHIR LOGIKA ---

          setTimeout(() => {
              showToast("Data mapel berhasil dihapus!", 'sukses');
              onMapelLoaded({ status: "sukses", mapel: globalMapelList, isReRender: true });
          }, 550); 

      } else {
          showMessage('mapel-message', response.message, true);
      }
  }

  function onTableRefreshed(response) {
      setLoading(false);
      if (response.status === "sukses") {
        setIjazahDirty(true);
        globalMapelList = [];
        
        // --- TAMBAHAN INVALIDASI CACHE ---
        globalNilaiGridCacheUM = null;
        globalNilaiGridCachePraktek = null;
        globalNilaiRaporGridCache.clear();
        // --- AKHIR TAMBAHAN ---
        
        showInfoModal("Sukses", response.message, false, bukaHalamanMapel);
      } else {
        showInfoModal("Error", response.message, true, null);
      }
  }

  function onMapelSaved(response) {
      setLoading(false);

      if (response.status === "sukses") {
        setIjazahDirty(true);
        tutupModalMapel(); 
        setMapelOrderDirty(false); 

        // --- TAMBAHAN INVALIDASI CACHE ---
        globalNilaiGridCacheUM = null;
        globalNilaiGridCachePraktek = null;
        globalNilaiRaporGridCache.clear();
        // --- AKHIR TAMBAHAN ---

        // --- LOGIKA OPTIMIS (Sudah ada dari langkah sebelumnya) ---
        if (response.newData) { 
            const mode = document.getElementById('modal-mapel-mode').value;
            const newData = response.newData;
            if (mode === 'add') {
                globalMapelList.push(newData);
            } else { 
                const indexToUpdate = globalMapelList.findIndex(m => m.id === newData.id);
                if (indexToUpdate > -1) {
                    globalMapelList[indexToUpdate] = newData; 
                } else {
                    globalMapelList.push(newData);
                }
            }
        } else {
            globalMapelList = []; 
        }
        // --- AKHIR LOGIKA OPTIMIS ---

        setTimeout(() => {
          showToast("Data mapel berhasil disimpan!", 'sukses');
          if (globalMapelList.length === 0) {
              bukaHalamanMapel();
          } else {
              onMapelLoaded({ status: "sukses", mapel: globalMapelList, isReRender: true });
          }
        }, 550); 

      } else {
        showMessage('modal-mapel-error', response.message, true);
      }
  }

  function simpanTipeUjian() {
    setLoading(true, 'Menyimpan tipe ujian...');
    hideMessage('mapel-message');
    const allCheckboxes = document.querySelectorAll('#mapel-table-container .mapel-tipe-cek');
    const dataMap = new Map();
    allCheckboxes.forEach(checkbox => {
      const id = checkbox.dataset.id;
      const tipe = checkbox.dataset.tipe;
      const isChecked = checkbox.checked;
      if (!dataMap.has(id)) dataMap.set(id, { id: id, isUS: false, isUP: false });
      const mapelData = dataMap.get(id);
      if (tipe === 'us') mapelData.isUS = isChecked;
      else if (tipe === 'up') mapelData.isUP = isChecked;
    });
    const dataToSave = Array.from(dataMap.values());
    google.script.run.withSuccessHandler(onMapelTipeUjianSaved).withFailureHandler(onGagal).saveMapelTipeUjianBatch(getToken(), dataToSave);
  }
  
  function onMapelTipeUjianSaved(response) {
    setLoading(false);
    if (response.status === 'sukses') {
      setIjazahDirty(true);
      
      // --- TAMBAHAN INVALIDASI CACHE ---
      globalNilaiGridCacheUM = null;
      globalNilaiGridCachePraktek = null;
      globalNilaiRaporGridCache.clear();
      // --- AKHIR TAMBAHAN ---
      
      globalMapelList.forEach(m => {
        const cb_us = document.querySelector(`.mapel-tipe-cek[data-id="${m.id}"][data-tipe="us"]`);
        const cb_up = document.querySelector(`.mapel-tipe-cek[data-id="${m.id}"][data-tipe="up"]`);
        if (cb_us) m.originalIsUS = cb_us.checked;
        if (cb_up) m.originalIsUP = cb_up.checked;
      });
      setMapelTipeDirty(false); 
      isFormDirty = false; 
      showMessage('mapel-message', 'Tipe ujian berhasil disimpan!', false);
    } else {
      showMessage('mapel-message', response.message, true);
    }
  }

  function bukaHalamanDataSekolah() {
    tampilHalaman('halaman-data-sekolah');
    setLoading(true, 'Memuat data sekolah...', false, true); // Ubah ke non-blocking
    isFormDirty = false;
    hideMessage('data-sekolah-message');
    document.getElementById('form-data-sekolah').reset();
    setFormDisabled('form-data-sekolah', true);

    // --- LOGIKA CACHE BARU ---
    if (globalDataSekolahCache && globalDataSekolahCache.status === 'sukses') {
        console.log("Memuat data sekolah dari cache klien...");
        // Muat dari cache
        setTimeout(() => {
          onDataSekolahLoaded(globalDataSekolahCache);
        }, 10); // Jeda singkat agar UI "Memuat..." sempat tampil
    } else {
        // Cache miss, panggil server
        console.log("Memuat data sekolah dari server...");
        google.script.run
          .withSuccessHandler(onDataSekolahLoaded)
          .withFailureHandler(onGagal)
          .getSchoolData(getToken());
    }
    // --- AKHIR LOGIKA CACHE ---
  }

  function onDataSekolahLoaded(response) {
      setLoading(false);
      setFormDisabled('form-data-sekolah', false);

      if (response.status !== 'sukses') {
        showMessage('data-sekolah-message', response.message, true);
        return;
      }

      // --- TAMBAHAN BARU: Simpan ke cache ---
      globalDataSekolahCache = response;
      // --- AKHIR TAMBAHAN ---

      const data = response.data;
      jenjangBaseCache = data.jenjangBase;
      jenjangPilihanCache = data.jenjangPilihan;
      populateSelectJenjang(data.jenjangBase, data.jenjangPilihan);

      document.getElementById('data-nama-sekolah').value = data.namaSekolah;
      document.getElementById('data-npsn').value = data.npsn || '';
      document.getElementById('data-nsm').value = data.nsm || '';
      document.getElementById('data-alamat').value = data.alamat || '';
      document.getElementById('data-provinsi').value = data.provinsi || '';
      document.getElementById('data-kabkot').value = data.kabKot || '';
      document.getElementById('data-pilihan-kabkot').value = data.pilihanKabKot || 'Kabupaten';
      document.getElementById('data-kecamatan').value = data.kecamatan || '';
      document.getElementById('data-keldes').value = data.kelDes || '';
      document.getElementById('data-pilihan-keldes').value = data.pilihanKelDes || 'Kelurahan';
      document.getElementById('data-kodepos').value = data.kodePos || '';
      document.getElementById('data-telepon').value = data.telepon || '';
      document.getElementById('data-email').value = data.email || '';
      document.getElementById('data-website').value = data.website || '';
      document.getElementById('data-kepsek').value = data.namaKepsek || '';
      document.getElementById('data-nip-kepsek').value = data.nipKepsek || '';

      updateTampilanNSM();
  }

  function populateSelectJenjang(jenjangBase, selectedValue) {
      const select = document.getElementById('data-jenjang-pilihan');
      select.innerHTML = '';

      let options = [];
      if (jenjangBase === 'SD/MI') {
        options = ['SD', 'MI'];
      } else if (jenjangBase === 'SMP/MTS') {
        options = ['SMP', 'MTS'];
      } else if (jenjangBase === 'SMA/MA') {
        options = ['SMA', 'MA'];
      } else {
        options = [jenjangBase];
      }

      select.innerHTML = '<option value="">-- Pilih Jenjang --</option>';
      options.forEach(opt => {
        select.innerHTML += `<option value="${opt}">${opt}</option>`;
      });

      if (selectedValue) {
        select.value = selectedValue;
      } else if (options.length > 1) {
        select.value = options[1];
      }
  }

  function updateTampilanNSM() {
      const jenjangPilihan = document.getElementById('data-jenjang-pilihan').value;
      const grupNSM = document.getElementById('grup-nsm');
      const labelNSM = grupNSM.querySelector('label');

      if (jenjangPilihan === 'MI' || jenjangPilihan === 'MTS' || jenjangPilihan === 'MA') {
        labelNSM.innerText = 'NSM (Wajib)';
      } else {
        labelNSM.innerText = 'NSM (Opsional)';
      }
  }

  function simpanDataSekolah() {
    setLoading(true, 'Menyimpan data sekolah...');
    hideMessage('data-sekolah-message');
    const requiredFieldIds = ['data-jenjang-pilihan', 'data-npsn', 'data-alamat', 'data-kepsek'];
    requiredFieldIds.forEach(id => document.getElementById(id)?.classList.remove('input-error'));
    document.getElementById('data-nsm').classList.remove('input-error');
    const dataToSave = {
      jenjangPilihan: document.getElementById('data-jenjang-pilihan').value,
      npsn: document.getElementById('data-npsn').value.trim(),
      nsm: document.getElementById('data-nsm').value.trim(),
      alamat: document.getElementById('data-alamat').value.trim(),
      provinsi: document.getElementById('data-provinsi').value.trim(),
      kabKot: document.getElementById('data-kabkot').value.trim(),
      pilihanKabKot: document.getElementById('data-pilihan-kabkot').value,
      kecamatan: document.getElementById('data-kecamatan').value.trim(),
      kelDes: document.getElementById('data-keldes').value.trim(),
      pilihanKelDes: document.getElementById('data-pilihan-keldes').value,
      kodePos: document.getElementById('data-kodepos').value.trim(),
      telepon: document.getElementById('data-telepon').value.trim(),
      email: document.getElementById('data-email').value.trim(),
      website: document.getElementById('data-website').value.trim(),
      namaKepsek: document.getElementById('data-kepsek').value.trim(),
      nipKepsek: document.getElementById('data-nip-kepsek').value.trim()
    };
    const errorFieldIds = [];
    if (!dataToSave.jenjangPilihan) errorFieldIds.push('data-jenjang-pilihan');
    if (!dataToSave.npsn) errorFieldIds.push('data-npsn');
    if (!dataToSave.alamat) errorFieldIds.push('data-alamat');
    if (!dataToSave.namaKepsek) errorFieldIds.push('data-kepsek');
    const isMadrasah = (dataToSave.jenjangPilihan === 'MI' || dataToSave.jenjangPilihan === 'MTS' || dataToSave.jenjangPilihan === 'MA');
    if (isMadrasah && !dataToSave.nsm) errorFieldIds.push('data-nsm');
    if (errorFieldIds.length > 0) {
      setLoading(false);
      errorFieldIds.forEach(id => document.getElementById(id)?.classList.add('input-error'));
      document.getElementById(errorFieldIds[0]).focus();
      showMessage('data-sekolah-message', "Harap lengkapi field wajib.", true);
      return;
    }
    jenjangPilihanCache = dataToSave.jenjangPilihan;
    google.script.run
      .withSuccessHandler(onDataSekolahSaved)
      .withFailureHandler(onGagal)
      .saveSchoolData(getToken(), dataToSave);
  }

  function onDataSekolahSaved(response) {
      setLoading(false);
      if (response.status === 'sukses') {
        isFormDirty = false; 
        showMessage('data-sekolah-message', 'Data sekolah berhasil disimpan!', false);

        // --- TAMBAHAN BARU: Perbarui cache klien ---
        // Ambil data terbaru dari form yang baru saja disimpan
        const dataFromForm = {
          jenjangBase: jenjangBaseCache, // Ini tidak berubah
          namaSekolah: document.getElementById('data-nama-sekolah').value,
          jenjangPilihan: document.getElementById('data-jenjang-pilihan').value,
          npsn: document.getElementById('data-npsn').value,
          nsm: document.getElementById('data-nsm').value,
          alamat: document.getElementById('data-alamat').value,
          provinsi: document.getElementById('data-provinsi').value,
          kabKot: document.getElementById('data-kabkot').value,
          pilihanKabKot: document.getElementById('data-pilihan-kabkot').value,
          kecamatan: document.getElementById('data-kecamatan').value,
          kelDes: document.getElementById('data-keldes').value,
          pilihanKelDes: document.getElementById('data-pilihan-keldes').value,
          kodePos: document.getElementById('data-kodepos').value,
          telepon: document.getElementById('data-telepon').value,
          email: document.getElementById('data-email').value,
          website: document.getElementById('data-website').value,
          namaKepsek: document.getElementById('data-kepsek').value,
          nipKepsek: document.getElementById('data-nip-kepsek').value
        };

        // Perbarui cache global
        globalDataSekolahCache = {
          status: "sukses",
          data: dataFromForm
        };

        // Perbarui juga cache jenjang pilihan (seperti fungsi aslinya)
        jenjangPilihanCache = dataFromForm.jenjangPilihan;
        // --- AKHIR TAMBAHAN ---

      } else {
        showMessage('data-sekolah-message', response.message, true);
      }
  }

  function sinkronkanBobot(sumber) {
      const inputRapor = document.getElementById('bobot-rapor');
      const inputUjian = document.getElementById('bobot-ujian');

      let nilaiRapor = parseInt(inputRapor.value, 10);
      let nilaiUjian = parseInt(inputUjian.value, 10);

      if (sumber === 'rapor') {
        if (isNaN(nilaiRapor)) { inputUjian.value = ''; return; }
        if (nilaiRapor > 100) { nilaiRapor = 100; inputRapor.value = 100; }
        if (nilaiRapor < 0) { nilaiRapor = 0; inputRapor.value = 0; }
        inputUjian.value = 100 - nilaiRapor;
      } else if (sumber === 'ujian') {
        if (isNaN(nilaiUjian)) { inputRapor.value = ''; return; }
        if (nilaiUjian > 100) { nilaiUjian = 100; inputUjian.value = 100; }
        if (nilaiUjian < 0) { nilaiUjian = 0; inputUjian.value = 0; }
        inputRapor.value = 100 - nilaiUjian;
      }
  }

  function bukaHalamanBobot() {
    tampilHalaman('halaman-bobot');
    setLoading(true, 'Memuat data bobot...', false, true); // Ubah ke non-blocking toast
    isFormDirty = false;
    hideMessage('bobot-message');
    document.getElementById('form-bobot').reset();
    setFormDisabled('form-bobot', true);

    // Cek cache klien
    if (globalBobotCache && globalBobotCache.status === 'sukses') {
        console.log("Memuat bobot dari cache klien...");
        // Muat dari cache (setLoading(false) akan dipanggil oleh onBobotLoaded)
        setTimeout(() => {
          onBobotLoaded(globalBobotCache);
        }, 10); // Jeda singkat agar UI "Memuat..." sempat tampil
    } else {
        // Cache miss, panggil server
        console.log("Memuat bobot dari server...");
        google.script.run
          .withSuccessHandler(onBobotLoaded)
          .withFailureHandler(onGagal)
          .getBobotData(getToken());
    }
  }

  function onBobotLoaded(response) {
      setLoading(false);
      setFormDisabled('form-bobot', false);

      if (response.status !== 'sukses') {
        showMessage('bobot-message', response.message, true);
        globalBobotCache = null; // Set cache ke null jika gagal
        return;
      }
      
      // Simpan ke cache klien saat berhasil dimuat
      globalBobotCache = response; 
      
      document.getElementById('bobot-rapor').value = response.bobotRapor;
      document.getElementById('bobot-ujian').value = response.bobotUjian;
      document.getElementById('bobot-kkm').value = response.kkm;
  }

  function simpanBobot() {
    setLoading(true, 'Menyimpan data bobot...');
    hideMessage('bobot-message');
    const bobotRapor = parseInt(document.getElementById('bobot-rapor').value, 10) || 0;
    const bobotUjian = parseInt(document.getElementById('bobot-ujian').value, 10) || 0;
    const kkm = parseInt(document.getElementById('bobot-kkm').value, 10);
    if ((bobotRapor + bobotUjian) !== 100) {
      setLoading(false);
      showMessage('bobot-message', 'Total bobot harus 100%.', true);
      return;
    }
    if (isNaN(kkm) || kkm < 0 || kkm > 100) {
      setLoading(false);
      showMessage('bobot-message', 'KKM tidak valid.', true);
      return;
    }
    google.script.run
      .withSuccessHandler(onBobotSaved)
      .withFailureHandler(onGagal)
      .saveBobotData(getToken(), bobotRapor, bobotUjian, kkm);
  }

  function onBobotSaved(response) {
      setLoading(false);
      if (response.status === 'sukses') {
        isFormDirty = false; 
        setIjazahDirty(true);
        showMessage('bobot-message', 'Data bobot berhasil disimpan!', false);
        
        // --- TAMBAHAN BARU: Perbarui cache klien ---
        const bobotRapor = parseInt(document.getElementById('bobot-rapor').value, 10) || 0;
        const bobotUjian = parseInt(document.getElementById('bobot-ujian').value, 10) || 0;
        const kkm = parseInt(document.getElementById('bobot-kkm').value, 10);
        
        // Perbarui cache dengan data yang baru saja disimpan
        globalBobotCache = {
          status: "sukses",
          bobotRapor: bobotRapor,
          bobotUjian: bobotUjian,
          kkm: kkm
        };
        // --- AKHIR TAMBAHAN ---
        
      } else {
        showMessage('bobot-message', response.message, true);
      }
  }

  function getCurrentKelasList() {
      const allRows = document.querySelectorAll('#kelas-list-container .kelas-input-row');
      const list = [];
      
      allRows.forEach(row => {
        // 'lockedSpan' sudah tidak ada berkat renderKelasList baru,
        // tapi kita biarkan sebagai fallback jika terjadi kesalahan render
        const lockedSpan = row.querySelector('.kelas-input-locked'); 
        const unlockedInput = row.querySelector('input[type="text"]');

        if (lockedSpan) {
          const nama = lockedSpan.textContent.trim();
          list.push({ oldName: nama, newName: nama });
          
        } else if (unlockedInput) {
          const newName = unlockedInput.value.trim();
          
          // --- PERBAIKAN DI SINI ---
          // 'oldName' HANYA diambil dari 'data-original-name'.
          // Jika 'data-original-name' tidak ada (karena ini baris baru),
          // 'oldName' akan menjadi 'undefined'.
          const oldName = unlockedInput.dataset.originalName;
          // --- AKHIR PERBAIKAN ---
          
          list.push({ oldName: oldName, newName: newName });
        }
      });
      
      return list;
  }

  function renderKelasList(kelasList) { // kelasList sekarang [ {nama, isLocked}, ... ]
    const container = document.getElementById('kelas-list-container');
    container.innerHTML = '';

    let listToRender = kelasList;
    if (listToRender.length === 0) {
      listToRender = [{ nama: '', isLocked: false }];
    }

    listToRender.forEach((kelas, index) => {
      const div = document.createElement('div');
      div.className = 'kelas-input-row';
      
      const isLocked = kelas.isLocked || false; // <-- Status lock tetap dibaca
      
      // Pesan title baru untuk menjelaskan hybrid logic
      const titleAttr = isLocked ? 'Kelas ini memiliki nilai, sehingga tidak dapat dihapus. Nama kelas masih bisa diubah.' : '';

      let html = '';

      // --- MODIFIKASI 1: Selalu render INPUT (tidak pernah disabled span) ---
      html = `<input type="text" 
                    placeholder="Nama Kelas (Contoh: VI A)" 
                    value="${kelas.nama}"
                    data-original-name="${kelas.nama}"
                    title="${titleAttr}">`;

      // --- MODIFIKASI 2: Tombol Hapus ---
      if (listToRender.length > 1) {
        // Selalu render BUTTON, tapi tambahkan 'disabled' jika terkunci
        const disabledAttr = isLocked ? 'disabled' : '';
        html += `<button type="button" class="btn-aksi-kelas btn-remove-kelas" title="${titleAttr}" ${disabledAttr}>&times;</button>`;
      } else {
        // Jika hanya 1 baris, beri placeholder agar tombol Add tetap di kanan
        html += '<span class="btn-aksi-kelas" style="width: 40px; display: inline-block;"></span>';
      }

      // --- MODIFIKASI 3: Tombol Tambah (Logika tidak berubah) ---
      if (index === listToRender.length - 1) {
        html += '<button type="button" class="btn-aksi-kelas btn-add-kelas" title="Tambah Baris Baru">+</button>';
      }

      div.innerHTML = html;
      container.appendChild(div);
    });
  }

  function bukaHalamanKelas() {
    tampilHalaman('halaman-kelas');
    setLoading(true, 'Memuat data kelas...', false, false); // Tampilkan loading singkat
    isFormDirty = false;
    hideMessage('kelas-message');
    document.getElementById('kelas-list-container').innerHTML = "<p>Memuat data kelas...</p>";
    setFormDisabled('form-kelas', true);

    // Cek cache klien
    if (globalKelasListCache && globalKelasListCache.length > 0) {
        console.log("Memuat kelas dari cache klien...");
        // Muat dari cache (setLoading(false) akan dipanggil oleh onKelasLoaded)
        // Gunakan timeout kecil agar UI sempat update "Memuat..."
        setTimeout(() => {
          onKelasLoaded({ status: "sukses", kelasList: globalKelasListCache });
        }, 10);
    } else {
        // Cache miss, panggil server
        console.log("Memuat kelas dari server...");
        google.script.run
            .withSuccessHandler(onKelasLoaded)
            .withFailureHandler(onGagal)
            .getKelas(getToken());
    }
  }

  function onKelasLoaded(response) {
    setLoading(false);
    setFormDisabled('form-kelas', false);

    if (response.status !== 'sukses') {
      showMessage('kelas-message', response.message, true);
      document.getElementById('kelas-list-container').innerHTML = '';
      return;
    }
    
    // Simpan ke cache klien saat berhasil dimuat dari server
    if (response.kelasList) {
        globalKelasListCache = response.kelasList;
    }
    
    // Diperbarui untuk menggunakan response.kelasList (bukan response.kelas)
    renderKelasList(response.kelasList || []);
  }

  function simpanKelas() {
    setLoading(true, 'Menyimpan data kelas...');
    hideMessage('kelas-message');
    
    // --- PERBAIKAN DI SINI ---
    // Hapus .map(n => String(n).trim()).filter(n => n.length > 0);
    // Kita ingin mengirim array objek [ {oldName, newName}, ... ] secara langsung.
    const list = getCurrentKelasList(); 
    // --- AKHIR PERBAIKAN ---

    const uniqueList = new Set(list.map(n => n.newName.trim().toUpperCase()));
    
    // Filter dulu nama yang tidak kosong sebelum cek duplikat
    const filledNames = list.map(n => n.newName.trim()).filter(n => n.length > 0);
    const uniqueFilledNames = new Set(filledNames.map(n => n.toUpperCase()));
    
    if (uniqueFilledNames.size !== filledNames.length) {
      setLoading(false);
      showMessage('kelas-message', 'Nama kelas duplikat.', true);
      return;
    }
    
    google.script.run
      .withSuccessHandler(onKelasSaved)
      .withFailureHandler(onGagal)
      .saveKelas(getToken(), list); // Kirim 'list' (array objek)
  }

  function onKelasSaved(response) {
      setLoading(false);
      if (response.status === 'sukses') {
        isFormDirty = false; 
        
        // Hapus cache kelas di klien agar dimuat ulang nanti
        globalKelasListCache = []; 
        
        // --- TAMBAHAN BARU (SOLUSI) ---
        // Karena nama kelas mungkin berubah, kita harus membersihkan
        // cache siswa agar 'Kelola Siswa' memuat data baru.
        globalSiswaList = []; 
        console.log("Cache Siswa (globalSiswaList) dibersihkan karena ada perubahan kelas.");
        // --- AKHIR TAMBAHAN BARU ---
        
        showMessage('kelas-message', 'Data kelas berhasil disimpan!', false);
        
        // Panggil ulang bukaHalamanKelas untuk me-refresh DOM
        // dengan data-original-name yang baru dan status lock yang benar.
        setTimeout(() => {
          // Ini akan memaksa pengambilan data baru dari server
          bukaHalamanKelas(); 
        }, 500); // Jeda 0.5 detik
        
      } else {
        showMessage('kelas-message', response.message, true);
      }
  }

  // Salin dan ganti fungsi bukaHalamanSiswa() Anda dengan yang ini
  function bukaHalamanSiswa() {
      tampilHalaman('halaman-siswa');
      isFormDirty = false; // Reset dirty flag
      
      // --- PENAMBAHAN LOGIKA CACHE ---
      // Cek apakah data siswa sudah ada di variabel global (cache sisi klien)
      if (globalSiswaList && globalSiswaList.length > 0) {
          console.log("Memuat siswa dari cache klien...");
          // Jika ada, langsung panggil handler sukses dengan data yang ada
          // Ini menghindari panggilan ke server yang tidak perlu
          onSiswaLoaded({ status: "sukses", siswa: globalSiswaList });
      } else {
          // Jika tidak ada, baru panggil server (cache miss)
          console.log("Memuat siswa dari server...");
          setLoading(true, 'Memuat data siswa...', false, false);
          document.getElementById('siswa-table-container').innerHTML = "<p>Memuat data siswa...</p>";
          document.getElementById('btn-cetak-kartu-siswa').disabled = true;
          document.getElementById('btn-tambah-siswa-baru').disabled = true;
          document.getElementById('btn-import-siswa').disabled = true;
          document.getElementById('btn-hapus-semua-siswa').disabled = true;
          document.getElementById('siswa-filter-kelas').disabled = true;
          document.getElementById('siswa-sort-by').disabled = true;
          google.script.run
              .withSuccessHandler(onSiswaLoaded)
              .withFailureHandler(onGagal)
              .getSiswa(getToken());
      }
      // --- AKHIR PERUBAHAN ---
  }

  function onSiswaLoaded(response) {
      setLoading(false);
      
      // --- PERBAIKAN DI SINI ---
      // Tambahkan baris ini untuk mengaktifkan kembali tombol "Cetak Kartu Siswa"
      document.getElementById('btn-cetak-kartu-siswa').disabled = false;
      // --- AKHIR PERBAIKAN ---

      document.getElementById('btn-tambah-siswa-baru').disabled = false;
      document.getElementById('btn-import-siswa').disabled = false;
      document.getElementById('btn-hapus-semua-siswa').disabled = false;
      document.getElementById('siswa-filter-kelas').disabled = false;
      document.getElementById('siswa-sort-by').disabled = false;

      const container = document.getElementById('siswa-table-container');

      if (response.status === "sukses") {
        response.siswa.forEach(s => {
          s.originalUrutan = s.urutan;
        });
        globalSiswaList = response.siswa;
        
        populateSiswaFilters();
        applySiswaFiltersAndRender();
        setSiswaOrderDirty(false);
        
        // --- TAMBAHKAN PANGGILAN FUNGSI INI ---
        // Panggil fungsi untuk memuat data kelas di latar belakang
        preloadKelasData();
        // --- AKHIR TAMBAHAN ---
        
      } else {
        globalSiswaList = [];
        container.innerHTML = `<p class="message error" style="display:block;">Gagal memuat siswa: ${response.message}</p>`;
      }
  }

  /**
   * [FUNGSI BARU]
   * Memuat data kelas di latar belakang dan menyimpannya di cache klien.
   * Dipanggil saat halaman "Kelola Siswa" dibuka.
   */
  function preloadKelasData() {
    // Jika cache sudah terisi, jangan lakukan apa-apa
    if (globalKelasListCache.length > 0) {
      return; 
    }
    
    console.log("Pre-loading data kelas di latar belakang...");

    // Panggil server tanpa menampilkan loading spinner
    google.script.run
      .withSuccessHandler((response) => {
        if (response.status === 'sukses') {
          // Simpan data ke cache
          globalKelasListCache = response.kelasList; 
          console.log("Data kelas berhasil di-cache.");
        } else {
          // Gagal memuat, biarkan cache kosong. 
          // Modal akan memuat ulang secara manual.
          console.warn("Gagal pre-load data kelas:", response.message);
        }
      })
      .withFailureHandler((error) => {
        console.error("Gagal pre-load data kelas (failure):", error.message);
      })
      .getKelas(getToken());
  }

  function setSiswaOrderDirty(isDirty) {
    isSiswaOrderDirty = isDirty;
    updateSiswaFloatingActions();
  }

  function onSiswaUrutanSaved(response) {
    setLoading(false);
    if (response.status === 'sukses') {
      globalSiswaList.forEach(s => {
        s.originalUrutan = s.urutan;
      });
      setSiswaOrderDirty(false);
      isFormDirty = false; 
      showMessage('siswa-message', 'Urutan siswa berhasil disimpan!', false);
    } else {
      showMessage('siswa-message', response.message, true);
    }
  }

  function populateSiswaFilters() {
    const selectKelas = document.getElementById('siswa-filter-kelas');
    const selectedValue = selectKelas.value;
    
    const kelasSet = new Set(globalSiswaList.map(siswa => siswa.kelas));
    const kelasList = Array.from(kelasSet).sort(compareKelas); // [MODIFIKASI]
  
    let optionsHtml = '<option value="semua">-- Tampilkan Semua Kelas --</option>';
    kelasList.forEach(kelas => {
      optionsHtml += `<option value="${kelas}">${kelas}</option>`;
    });
  
    selectKelas.innerHTML = optionsHtml;
    
    selectKelas.value = selectedValue || (kelasList.length === 1 ? kelasList[0] : 'semua');
  }
  
  function applySiswaFiltersAndRender() {
    const selectedKelas = document.getElementById('siswa-filter-kelas').value;
    const selectedSort = document.getElementById('siswa-sort-by').value;
  
    let processedSiswa = [...globalSiswaList];
  
    if (selectedKelas !== 'semua') {
      processedSiswa = processedSiswa.filter(siswa => siswa.kelas === selectedKelas);
    }
  
    switch (selectedSort) {
      case 'nama-az':
        processedSiswa.sort((a, b) => a.nama.localeCompare(b.nama));
        break;
      case 'nama-za':
        processedSiswa.sort((a, b) => b.nama.localeCompare(a.nama));
        break;
      case 'nisn-asc':
        processedSiswa.sort((a, b) => a.nisn.localeCompare(b.nisn, undefined, { numeric: true }));
        break;
      case 'nisn-desc':
        processedSiswa.sort((a, b) => b.nisn.localeCompare(a.nisn, undefined, { numeric: true }));
        break;
      case 'default':
      default:
        processedSiswa.sort((a, b) => {
          const kelasCompare = a.kelas.localeCompare(b.kelas);
          if (kelasCompare !== 0) {
            return kelasCompare;
          }
          
          const urutanA = Number(a.urutan) || 0;
          const urutanB = Number(b.urutan) || 0;
          
          return urutanA - urutanB;
        });
        break;
    }
  
    renderSiswaTable(processedSiswa);
  }
  
  // GANTI fungsi renderSiswaTable yang lama dengan ini:
  function renderSiswaTable(siswaList) {
      const container = document.getElementById('siswa-table-container');
      container.innerHTML = ""; 

      const table = document.createElement('table');
      table.className = 'siswa-table';

      const thead = table.createTHead();
      const headerRow = thead.insertRow();
      
      // --- [MODIFIKASI HEADER] Menambahkan kolom Tahun Ajar ---
      headerRow.innerHTML = '<th>Nama Siswa</th><th>NISN</th><th>Kelas</th><th>Tahun Ajar</th><th>Aksi</th>';

      const tbody = table.createTBody();
      const fragment = document.createDocumentFragment(); 

      if (siswaList.length === 0) {
          const emptyRow = tbody.insertRow();
          // Colspan jadi 5 karena tambah 1 kolom
          emptyRow.innerHTML = '<td colspan="5" style="text-align: center;">Tidak ada data siswa yang sesuai dengan filter.</td>';
      } else {
          let currentKelas = null;
          const selectedSort = document.getElementById('siswa-sort-by').value;
          const isDefaultSort = (selectedSort === 'default');

          siswaList.forEach((siswa, index) => {
              const isFirstOfClass = (siswa.kelas !== currentKelas);
              currentKelas = siswa.kelas;
              
              const nextSiswa = siswaList[index + 1];
              const isLastOfClass = (!nextSiswa || nextSiswa.kelas !== siswa.kelas);
              
              let moveButtonsHtml = '';
              if (isDefaultSort) {
                moveButtonsHtml = `
                  <button class="btn-aksi btn-move-up" data-id="${siswa.id}" ${isFirstOfClass ? 'disabled' : ''} title="Naikkan posisi"><i class="fas fa-arrow-up"></i></button>
                  <button class="btn-aksi btn-move-down" data-id="${siswa.id}" ${isLastOfClass ? 'disabled' : ''} title="Turunkan posisi"><i class="fas fa-arrow-down"></i></button>
                `;
              }
              
              const tr = document.createElement('tr');
              
              // --- [MODIFIKASI BODY] Menambahkan data Tahun Ajar ---
              // Kita gunakan badge agar terlihat rapi jika ada banyak tahun
              const tahunAjarDisplay = siswa.tahun_ajar ? `<span style="background:#e7f1ff; color:#0d6efd; padding:2px 6px; border-radius:4px; font-size:12px; font-weight:500;">${siswa.tahun_ajar}</span>` : '-';

              tr.innerHTML = `
                <td><strong>${siswa.nama}</strong></td>
                <td>${siswa.nisn}</td>
                <td>${siswa.kelas}</td>
                <td>${tahunAjarDisplay}</td> <td>
                  <div class="btn-grup-gerak">
                    ${moveButtonsHtml}
                  </div>
                  <div class="btn-grup-aksi">
                    <button class="btn-aksi btn-edit btn-edit-siswa"
                      data-id="${siswa.id}" data-nama="${siswa.nama}" data-nisn="${siswa.nisn}" data-nis-lokal="${siswa.nisLokal}" data-jk="${siswa.jk}" data-tempat-lahir="${siswa.tempatLahir}" data-tgl-lahir="${siswa.tglLahir}" data-kelas="${siswa.kelas}"
                    ><i class="fas fa-pencil-alt"></i>Edit</button>
                    <button class="btn-aksi btn-delete btn-delete-siswa" data-id="${siswa.id}" data-nama="${siswa.nama}"><i class="fas fa-trash-alt"></i>Hapus</button>
                  </div>
                </td>
              `;
              
              fragment.appendChild(tr);
          });
      }
      
      tbody.appendChild(fragment);
      container.appendChild(table);
  }

  function tutupModalSiswa() {
      document.getElementById('siswa-modal').classList.remove('show');
  }

  function showModalSiswa(mode, siswaData) {
    hideMessage('modal-siswa-error');
    document.getElementById('modal-siswa-mode').value = mode;
    document.getElementById('modal-siswa-id').value = siswaData.id || '';
    
    // Reset form
    document.getElementById('modal-siswa-nama').value = '';
    document.getElementById('modal-siswa-nisn').value = '';
    document.getElementById('modal-siswa-nis-lokal').value = '';
    document.getElementById('modal-siswa-jk').value = '';
    document.getElementById('modal-siswa-tempat-lahir').value = '';
    document.getElementById('modal-siswa-tgl-lahir').value = '';
    const selectKelas = document.getElementById('modal-siswa-kelas');
    
    // Atur judul dan data
    if (mode === 'add') {
      document.getElementById('modal-siswa-title').innerText = "Tambah Siswa Baru";
      document.getElementById('modal-siswa-nisn').readOnly = false;
    } else {
      document.getElementById('modal-siswa-title').innerText = "Edit Data Siswa";
      document.getElementById('modal-siswa-nisn').readOnly = false;
      document.getElementById('modal-siswa-id').value = siswaData.id;
      document.getElementById('modal-siswa-nama').value = siswaData.nama;
      document.getElementById('modal-siswa-nisn').value = siswaData.nisn;
      document.getElementById('modal-siswa-nis-lokal').value = siswaData.nisLokal;
      document.getElementById('modal-siswa-jk').value = siswaData.jk;
      document.getElementById('modal-siswa-tempat-lahir').value = siswaData.tempatLahir;
      document.getElementById('modal-siswa-tgl-lahir').value = siswaData.tglLahir;
    }
    
    // Tampilkan modal SEKARANG
    document.getElementById('siswa-modal').classList.add('show');
    
    // --- LOGIKA PEMUATAN KELAS YANG DIPERBARUI ---
    
    if (globalKelasListCache.length > 0) {
      // 1. CACHE HIT (INSTAN)
      // Data sudah ada di cache, panggil handler secara sinkron
      console.log("Memuat kelas dari cache klien (instan).");
      onKelasListLoadedForModal({ status: "sukses", kelasList: globalKelasListCache }, siswaData);
      
    } else {
      // 2. CACHE MISS (LAMA)
      // Data belum ada (mungkin preload gagal atau user terlalu cepat)
      // Lakukan pemuatan manual seperti sebelumnya
      console.warn("Cache kelas kosong, memuat dari server (manual)...");
      selectKelas.innerHTML = '<option value="">-- Memuat kelas... --</option>';
      document.getElementById('btn-simpan-siswa').disabled = true;
      
      google.script.run
        .withSuccessHandler((response) => onKelasListLoadedForModal(response, siswaData))
        .withFailureHandler(onGagal)
        .getKelas(getToken());
    }
    // --- AKHIR LOGIKA PEMUATAN KELAS ---
  }

  function onKelasListLoadedForModal(response, siswaData) {
    const selectKelas = document.getElementById('modal-siswa-kelas');
    const btnSimpan = document.getElementById('btn-simpan-siswa');
    hideMessage('modal-siswa-error');
    
    const currentMode = document.getElementById('modal-siswa-mode').value;

    if (response.status !== 'sukses' || !response.kelasList || response.kelasList.length === 0) {
      selectKelas.innerHTML = '<option value="">-- Tidak ada data kelas --</option>';
      showMessage('modal-siswa-error', "Tidak dapat menambah/edit siswa. Harap isi data kelas terlebih dahulu di menu 'Kelola Kelas'.", true);
      btnSimpan.disabled = true;
    
    } else {
      
      if (globalKelasListCache.length === 0) {
        globalKelasListCache = response.kelasList;
      }

      const kelasList = response.kelasList;
      selectKelas.innerHTML = '<option value="">-- Pilih Kelas --</option>';
      
      // [MODIFIKASI]
      kelasList.sort((a, b) => compareKelas(a.nama, b.nama)).forEach(kelasObj => { 
        selectKelas.innerHTML += `<option value="${kelasObj.nama}">${kelasObj.nama}</option>`;
      });
      
      btnSimpan.disabled = false;

      if (currentMode === 'edit') {
        document.getElementById('modal-siswa-kelas').value = siswaData.kelas;
      } else if (currentMode === 'add' && kelasList.length === 1) {
        document.getElementById('modal-siswa-kelas').value = kelasList[0].nama; 
      }
    }
  }

  function simpanSiswa() {
    hideMessage('modal-siswa-error');
    
    // --- PERUBAHAN DI SINI: Validasi format dulu ---
    const isNisnFormatValid = validateNisnFormat();
    const isNisLokalFormatValid = validateNisLokalFormat();
    
    if (!isNisnFormatValid || !isNisLokalFormatValid) {
      showMessage('modal-siswa-error', "Data NISN atau NIS Lokal tidak valid. Periksa kembali.", true);
      return; // Hentikan simpan
    }
    // --- AKHIR PERUBAHAN ---

    setLoading(true, 'Menyimpan data siswa...');
    
    const requiredFieldIds = ['modal-siswa-nama', 'modal-siswa-nisn', 'modal-siswa-jk', 'modal-siswa-kelas'];
    requiredFieldIds.forEach(id => document.getElementById(id).classList.remove('input-error'));
    
    const dataSiswa = {
      id: document.getElementById('modal-siswa-id').value,
      nama: document.getElementById('modal-siswa-nama').value.trim(),
      nisn: document.getElementById('modal-siswa-nisn').value.trim(),
      nisLokal: document.getElementById('modal-siswa-nis-lokal').value.trim(),
      jk: document.getElementById('modal-siswa-jk').value,
      tempatLahir: document.getElementById('modal-siswa-tempat-lahir').value.trim(),
      tglLahir: document.getElementById('modal-siswa-tgl-lahir').value,
      kelas: document.getElementById('modal-siswa-kelas').value
    };
    
    const errorFieldIds = [];
    if (!dataSiswa.nama) errorFieldIds.push("modal-siswa-nama");
    if (!dataSiswa.nisn) errorFieldIds.push("modal-siswa-nisn"); // Check 'wajib' tetap ada
    if (!dataSiswa.jk) errorFieldIds.push("modal-siswa-jk");
    if (!dataSiswa.kelas) errorFieldIds.push("modal-siswa-kelas");
    
    if (errorFieldIds.length > 0) {
      setLoading(false);
      errorFieldIds.forEach(id => document.getElementById(id).classList.add('input-error'));
      document.getElementById(errorFieldIds[0]).focus();
      showMessage('modal-siswa-error', "Harap lengkapi field wajib.", true);
      return;
    }
    
    const mode = document.getElementById('modal-siswa-mode').value;
    if (mode === 'add') {
      google.script.run.withSuccessHandler(onSiswaSaved).withFailureHandler(onGagal).createSiswa(getToken(), dataSiswa);
    } else {
      google.script.run.withSuccessHandler(onSiswaSaved).withFailureHandler(onGagal).updateSiswa(getToken(), dataSiswa);
    }
  }

  function onSiswaSaved(response) {
      // 1. Matikan toast spinner "Menyimpan..."
      setLoading(false);

      if (response.status === "sukses") {
        setIjazahDirty(true);
        tutupModalSiswa(); // 2. Tutup modalnya

        // --- TAMBAHAN INVALIDASI CACHE ---
        globalNilaiGridCacheUM = null;
        globalNilaiGridCachePraktek = null;
        globalNilaiRaporGridCache.clear();
        // --- AKHIR TAMBAHAN ---
        
        // --- LOGIKA OPTIMIS (Sudah ada dari langkah sebelumnya) ---
        if (response.newData) { 
            const mode = document.getElementById('modal-siswa-mode').value;
            const newData = response.newData;

            if (mode === 'add') {
                globalSiswaList.push(newData); 
            } else { 
                const indexToUpdate = globalSiswaList.findIndex(s => s.id === newData.id);
                if (indexToUpdate > -1) {
                    globalSiswaList[indexToUpdate] = newData; 
                } else {
                    globalSiswaList.push(newData);
                }
            }
        } else {
            globalSiswaList = []; 
        }
        // --- AKHIR LOGIKA OPTIMIS ---

        setTimeout(() => {
          showToast("Data siswa berhasil disimpan!", 'sukses');
          
          if (globalSiswaList.length === 0) {
              bukaHalamanSiswa();
          } else {
              applySiswaFiltersAndRender();
              populateSiswaFilters(); 
          }
          
        }, 550);

      } else {
        showMessage('modal-siswa-error', response.message, true);
      }
  }

  function hapusSiswa(siswaID, namaSiswa) {
    const title = "Konfirmasi Hapus";
    const message = `Hapus siswa: <strong>${namaSiswa}</strong>? Nilai terkait akan hilang.`;
    const callback = function() {
      setLoading(true, 'Menghapus siswa...');
      
      // --- PERUBAHAN HANDLER DI SINI ---
      google.script.run
        .withSuccessHandler((response) => onSiswaDeleted(response, siswaID)) // Kirim siswaID ke handler baru
        .withFailureHandler(onGagal)
        .deleteSiswa(getToken(), siswaID);
      // --- AKHIR PERUBAHAN ---
        
    };
    showConfirmationModal(title, message, callback, 'danger');
  }

  function onSiswaDeleted(response, deletedSiswaID) {
      setLoading(false);

      if (response.status === "sukses") {
          setIjazahDirty(true);
          
          // --- TAMBAHAN INVALIDASI CACHE ---
          globalNilaiGridCacheUM = null;
          globalNilaiGridCachePraktek = null;
          globalNilaiRaporGridCache.clear();
          // --- AKHIR TAMBAHAN ---
          
          // --- LOGIKA OPTIMIS ---
          const indexToDelete = globalSiswaList.findIndex(s => s.id === deletedSiswaID);
          if (indexToDelete > -1) {
              globalSiswaList.splice(indexToDelete, 1); 
          }
          // --- AKHIR LOGIKA ---

          setTimeout(() => {
              showToast("Data siswa berhasil dihapus!", 'sukses');
              applySiswaFiltersAndRender();
              populateSiswaFilters();
          }, 550); 

      } else {
          showMessage('siswa-message', response.message, true);
      }
  }

  function hapusSemuaSiswa() {
    const title = "PERINGATAN BESAR!";
    const message = "Hapus SEMUA siswa? Tidak bisa dibatalkan.";
    const callback = function() {
      setLoading(true, 'Menghapus semua...');
      google.script.run.withSuccessHandler(onSiswaTableRefreshed).withFailureHandler(onGagal).deleteAllSiswa(getToken());
    };
    showConfirmationModal(title, message, callback, 'danger');
  }

  function onSiswaTableRefreshed(response) {
      setLoading(false);
      if (response.status === "sukses") {
        setIjazahDirty(true);
        globalSiswaList = []; 
        
        // --- TAMBAHAN INVALIDASI CACHE ---
        globalNilaiGridCacheUM = null;
        globalNilaiGridCachePraktek = null;
        globalNilaiRaporGridCache.clear();
        // --- AKHIR TAMBAHAN ---
        
        showInfoModal("Sukses", response.message, false, bukaHalamanSiswa);
      } else {
        showInfoModal("Error", response.message, true, null);
      }
  }

  function bukaModalImportSiswa() {
    document.getElementById('file-upload-siswa').value = null;
    document.getElementById('btn-proses-import-siswa').disabled = true;
    document.getElementById('import-siswa-results').style.display = 'none';
    document.getElementById('import-siswa-results').innerHTML = '';
    hideMessage('template-message');
    
    const fileUploadText = document.getElementById('file-upload-text');
    fileUploadText.innerText = 'Klik untuk memilih file atau seret & letakkan di sini.';
    fileUploadText.classList.remove('file-chosen');
    document.getElementById('file-upload-zone').classList.remove('drag-over');

    siswaTelahDiImport = false;
    
    document.getElementById('import-siswa-modal').classList.add('show');
  }

  function tutupModalImportSiswa() {
    document.getElementById('import-siswa-modal').classList.remove('show');
    if (siswaTelahDiImport) {
      siswaTelahDiImport = false;
      bukaHalamanSiswa();
    }
  }

  function downloadTemplateSiswa() {
    setLoading(true, 'Membuat template...');
    hideMessage('template-message');
    google.script.run
      .withSuccessHandler(onTemplateUrlReceived)
      .withFailureHandler(onGagal)
      .getSiswaTemplateUrl(getToken());
  }
  
  function onTemplateUrlReceived(response) {
    setLoading(false);
    
    if (response.status === 'sukses') {
      showMessage('template-message', 'Template berhasil dibuat. Mengunduh...', false);

      try {
        const dataUrl = `data:${response.mimeType};base64,${response.base64}`;
        
        const link = document.createElement('a');
        link.setAttribute('href', dataUrl);
        link.setAttribute('download', response.fileName);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        
        link.click();
        
        document.body.removeChild(link);

      } catch (e) {
        showMessage('template-message', 'Gagal memproses unduhan di browser: ' + e.message, true);
      }

    } else {
      showMessage('template-message', response.message, true);
    }
  }

  function prosesImportFileSiswa() {
    setLoading(true, 'Mengimpor siswa...');
    document.getElementById('import-siswa-results').style.display = 'none';
    hideMessage('template-message');
    const file = document.getElementById('file-upload-siswa').files[0];
    if (!file) { setLoading(false); showMessage('template-message', 'Pilih file Excel.', true); return; }
    const reader = new FileReader();
    reader.onload = (e) => {
      const fileData = { base64: e.target.result, mimeType: file.type, fileName: file.name };
      google.script.run.withSuccessHandler(onImportSiswaFinished).withFailureHandler(onGagal).prosesImportExcelSiswa(getToken(), fileData);
    };
    reader.onerror = (e) => { setLoading(false); showMessage('template-message', 'Gagal baca file.', true); };
    reader.readAsDataURL(file);
  }

  function onImportSiswaFinished(response) {
    setLoading(false);
    const resultsContainer = document.getElementById('import-siswa-results');

    if (response.status !== 'sukses') {
      showMessage('template-message', response.message, true);
      resultsContainer.style.display = 'none';
      return;
    }

    if (response.berhasilDiUpload > 0) {
      setIjazahDirty(true);
      siswaTelahDiImport = true;
      globalSiswaList = []; 
      
      // --- TAMBAHAN INVALIDASI CACHE ---
      globalNilaiGridCacheUM = null;
      globalNilaiGridCachePraktek = null;
      globalNilaiRaporGridCache.clear();
      // --- AKHIR TAMBAHAN ---
    }

    let html = '<h4><i class="fas fa-check-circle"></i>Proses Import Selesai</h4>';
    html += `<p>Total data diproses: <strong>${response.totalDiProses}</strong></p>`;
    html += `<p style="color: var(--success-color);">Berhasil ditambah: <strong>${response.berhasilDiUpload}</strong></p>`;
    html += `<p style="color: var(--danger-color);">Gagal/Dilewati: <strong>${response.gagalDiUpload}</strong></p>`;

    if (response.dataGagal && response.dataGagal.length > 0) {
      html += `<hr><p><strong>Detail Data yang Gagal:</strong></p>`;
      html += '<table class="import-gagal-table">';
      html += '<tr><th>Baris</th><th>Nama</th><th>NISN</th><th>Alasan Gagal</th></tr>';
      
      response.dataGagal.forEach(item => {
        html += `
          <tr>
            <td>${item.baris}</td>
            <td>${item.nama || '(Kosong)'}</td>
            <td>${item.nisn || '(Kosong)'}</td>
            <td>${item.alasan}</td>
          </tr>
        `;
      });
      html += '</table>';
    }

    resultsContainer.innerHTML = html;
    resultsContainer.style.display = 'block';

    document.getElementById('file-upload-siswa').value = null;
    document.getElementById('btn-proses-import-siswa').disabled = true;
  }

  function bukaModalUploadNilai() {
    document.getElementById('file-upload-nilai').value = null;
    document.getElementById('btn-proses-upload-nilai').disabled = true;
    document.getElementById('import-nilai-results').style.display = 'none';
    document.getElementById('import-nilai-results').innerHTML = '';
    hideMessage('template-nilai-message');
    const fileUploadText = document.getElementById('file-upload-text-nilai');
    fileUploadText.innerText = 'Klik untuk memilih file atau seret & letakkan di sini.';
    fileUploadText.classList.remove('file-chosen');
    document.getElementById('file-upload-zone-nilai').classList.remove('drag-over');
    nilaiTelahDiUpload = false;
    document.getElementById('upload-nilai-modal').classList.add('show');
    const selectKelas = document.getElementById('upload-nilai-filter-kelas');
    selectKelas.innerHTML = '<option value="">-- Memuat kelas... --</option>';
    google.script.run
      .withSuccessHandler(onKelasListLoadedForUploadModal)
      .withFailureHandler(onGagal)
      .getKelas(getToken());
  }

  function onKelasListLoadedForUploadModal(response) {
    const selectKelas = document.getElementById('upload-nilai-filter-kelas');
    hideMessage('template-nilai-message');

    if (response.status !== 'sukses' || !response.kelasList || response.kelasList.length === 0) {
      selectKelas.innerHTML = '<option value="">-- Tidak ada data kelas --</option>';
      showMessage('template-nilai-message', "Tidak dapat membuat template. Harap isi data kelas terlebih dahulu di menu 'Kelola Kelas'.", true);
    } else {
      const kelasList = response.kelasList.map(k => k.nama);
      selectKelas.innerHTML = '<option value="semua">-- Semua Kelas --</option>';
      kelasList.forEach(namaKelas => {
        selectKelas.innerHTML += `<option value="${namaKelas}">${namaKelas}</option>`;
      });
      
      if (kelasList.length === 1) {
        selectKelas.value = kelasList[0];
      } else {
        selectKelas.value = 'semua';
      }
    }
  }

  function tutupModalUploadNilai() {
    document.getElementById('upload-nilai-modal').classList.remove('show');
    if (nilaiTelahDiUpload) {
      nilaiTelahDiUpload = false;
    }
  }

  function downloadTemplateNilai() {
    setLoading(true, 'Membuat template nilai...');
    hideMessage('template-nilai-message');
    const kelasDipilih = document.getElementById('upload-nilai-filter-kelas').value;
    if (!kelasDipilih) { setLoading(false); showMessage('template-nilai-message', 'Pilih kelas dulu.', true); return; }
    google.script.run.withSuccessHandler(onTemplateNilaiUrlReceived).withFailureHandler(onGagal).getNilaiTemplateData(getToken(), kelasDipilih);
  }

  function onTemplateNilaiUrlReceived(response) {
    setLoading(false);
    
    if (response.status === 'sukses') {
      showMessage('template-nilai-message', 'Template berhasil dibuat. Mengunduh...', false);

      try {
        const dataUrl = `data:${response.mimeType};base64,${response.base64}`;
        const link = document.createElement('a');
        link.setAttribute('href', dataUrl);
        link.setAttribute('download', response.fileName);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      } catch (e) {
        showMessage('template-nilai-message', 'Gagal memproses unduhan: ' + e.message, true);
      }

    } else {
      showMessage('template-nilai-message', response.message, true);
    }
  }

  function prosesUploadFileNilai() {
    setLoading(true, 'Mengupload nilai...');
    document.getElementById('import-nilai-results').style.display = 'none';
    hideMessage('template-nilai-message');
    const file = document.getElementById('file-upload-nilai').files[0];
    if (!file) { setLoading(false); showMessage('template-nilai-message', 'Pilih file Excel.', true); return; }
    const reader = new FileReader();
    reader.onload = (e) => {
      const fileData = { base64: e.target.result, mimeType: file.type, fileName: file.name };
      google.script.run.withSuccessHandler(onUploadNilaiFinished).withFailureHandler(onGagal).prosesUploadExcelNilai(getToken(), fileData);
    };
    reader.onerror = (e) => { setLoading(false); showMessage('template-nilai-message', 'Gagal baca file.', true); };
    reader.readAsDataURL(file);
  }

  function onUploadNilaiFinished(response) {
    setLoading(false);
    const resultsContainer = document.getElementById('import-nilai-results');

    if (response.status !== 'sukses') {
      showMessage('template-nilai-message', response.message, true);
      resultsContainer.style.display = 'none';
      return;
    }

    if (response.berhasilDiUpload > 0) {
      setIjazahDirty(true);// <-- TAMBAHKAN INI
      nilaiTelahDiUpload = true;
    }

    let html = '<h4><i class="fas fa-check-circle"></i>Proses Upload Selesai</h4>';
    html += `<p>Total nilai terdeteksi: <strong>${response.totalDitemukan}</strong></p>`;
    html += `<p style="color: var(--success-color);">Berhasil disimpan/diperbarui: <strong>${response.berhasilDiUpload}</strong></p>`;
    html += `<p style="color: var(--danger-color);">Gagal/Dilewati: <strong>${response.gagalDiUpload}</strong></p>`;

    if (response.dataGagal && response.dataGagal.length > 0) {
      html += `<hr><p><strong>Detail Data yang Gagal:</strong></p>`;
      html += '<table class="import-gagal-table">';
      html += '<tr><th>Sheet</th><th>Baris</th><th>Info</th><th>Alasan Gagal</th></tr>';
      
      response.dataGagal.forEach(item => {
        html += `
          <tr>
            <td>${item.sheet || 'N/A'}</td>
            <td>${item.baris || 'N/A'}</td>
            <td>${item.info || 'N/A'}</td>
            <td>${item.alasan}</td>
          </tr>
        `;
      });
      html += '</table>';
    }

    resultsContainer.innerHTML = html;
    resultsContainer.style.display = 'block';

    document.getElementById('file-upload-nilai').value = null;
    document.getElementById('btn-proses-upload-nilai').disabled = true;
    
    const fileUploadText = document.getElementById('file-upload-text-nilai');
    fileUploadText.innerText = 'Klik untuk memilih file atau seret & letakkan di sini.';
    fileUploadText.classList.remove('file-chosen');
  }

  function bukaModalUploadNilaiRapor() {
    document.getElementById('file-upload-rapor').value = null;
    document.getElementById('btn-proses-upload-nilai-rapor').disabled = true;
    document.getElementById('import-rapor-results').style.display = 'none';
    document.getElementById('import-rapor-results').innerHTML = '';
    hideMessage('template-rapor-message');
    const fileUploadText = document.getElementById('file-upload-text-rapor');
    fileUploadText.innerText = 'Klik untuk memilih file atau seret & letakkan di sini.';
    fileUploadText.classList.remove('file-chosen');
    document.getElementById('file-upload-zone-rapor').classList.remove('drag-over');
    nilaiRaporTelahDiUpload = false;
    document.getElementById('upload-nilai-rapor-modal').classList.add('show');
    const selectSemester = document.getElementById('upload-rapor-filter-semester');
    selectSemester.innerHTML = '<option value="">-- Memuat semester... --</option>';
    const selectKelas = document.getElementById('upload-rapor-filter-kelas');
    selectKelas.innerHTML = '<option value="">-- Pilih Semester Dulu --</option>';
    google.script.run.withSuccessHandler(onSemesterListLoadedForUploadModal).withFailureHandler(onGagal).getSemesterList(getToken());
  }

  // Helper untuk modal upload rapor (memanggil getKelas juga)
  function onSemesterListLoadedForUploadModal(response) {
    const selectSemester = document.getElementById('upload-rapor-filter-semester');
    hideMessage('template-rapor-message');
    if (response.status !== 'sukses' || !response.semesterList || response.semesterList.length === 0) {
      selectSemester.innerHTML = '<option value="">-- Gagal memuat semester --</option>';
      showMessage('template-rapor-message', "Gagal memuat semester.", true);
    } else {
      selectSemester.innerHTML = '<option value="">-- Pilih Semester --</option>';
      response.semesterList.forEach(semester => {
        selectSemester.innerHTML += `<option value="${semester.id}">${semester.nama}</option>`;
      });
      google.script.run.withSuccessHandler(onKelasListLoadedForUploadRaporModal).withFailureHandler(onGagal).getKelas(getToken());
    }
  }

  function onKelasListLoadedForUploadRaporModal(response) {
    const selectKelas = document.getElementById('upload-rapor-filter-kelas');
    hideMessage('template-rapor-message');

    if (response.status !== 'sukses' || !response.kelasList || response.kelasList.length === 0) {
      selectKelas.innerHTML = '<option value="">-- Tidak ada data kelas --</option>';
      showMessage('template-rapor-message', "Tidak dapat membuat template. Harap isi data kelas terlebih dahulu.", true);
    } else {
      const kelasList = response.kelasList.map(k => k.nama);
      selectKelas.innerHTML = '<option value="semua">-- Semua Kelas --</option>';
      kelasList.forEach(namaKelas => {
        selectKelas.innerHTML += `<option value="${namaKelas}">${namaKelas}</option>`;
      });
      
      if (kelasList.length === 1) {
        selectKelas.value = kelasList[0];
      } else if (kelasList.length > 1) {
        selectKelas.value = 'semua';
      }
    }
  }

  function tutupModalUploadNilaiRapor() {
    document.getElementById('upload-nilai-rapor-modal').classList.remove('show');
    if (nilaiRaporTelahDiUpload) {
      nilaiRaporTelahDiUpload = false;
    }
  }

  function downloadTemplateNilaiRapor() {
    setLoading(true, 'Membuat template...');
    hideMessage('template-rapor-message');
    const semesterDipilih = document.getElementById('upload-rapor-filter-semester').value;
    const kelasDipilih = document.getElementById('upload-rapor-filter-kelas').value;
    if (!semesterDipilih) { setLoading(false); showMessage('template-rapor-message', 'Pilih semester dulu.', true); return; }
    if (!kelasDipilih) { setLoading(false); showMessage('template-rapor-message', 'Pilih kelas dulu.', true); return; }
    google.script.run.withSuccessHandler(onTemplateNilaiRaporUrlReceived).withFailureHandler(onGagal).getNilaiRaporTemplateData(getToken(), semesterDipilih, kelasDipilih);
  }

  function onTemplateNilaiRaporUrlReceived(response) {
    setLoading(false);
    
    if (response.status === 'sukses') {
      showMessage('template-rapor-message', 'Template berhasil dibuat. Mengunduh...', false);

      try {
        const dataUrl = `data:${response.mimeType};base64,${response.base64}`;
        const link = document.createElement('a');
        link.setAttribute('href', dataUrl);
        link.setAttribute('download', response.fileName);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      } catch (e) {
        showMessage('template-rapor-message', 'Gagal memproses unduhan: ' + e.message, true);
      }

    } else {
      showMessage('template-rapor-message', response.message, true);
    }
  }

  function prosesUploadFileNilaiRapor() {
    setLoading(true, 'Mengupload nilai rapor...');
    document.getElementById('import-rapor-results').style.display = 'none';
    hideMessage('template-rapor-message');
    const file = document.getElementById('file-upload-rapor').files[0];
    const semesterId = document.getElementById('upload-rapor-filter-semester').value;
    if (!file) { setLoading(false); showMessage('template-rapor-message', 'Pilih file Excel.', true); return; }
    if (!semesterId) { setLoading(false); showMessage('template-rapor-message', 'Pilih semester.', true); return; }
    const reader = new FileReader();
    reader.onload = (e) => {
      const fileData = { base64: e.target.result, mimeType: file.type, fileName: file.name };
      google.script.run.withSuccessHandler(onUploadNilaiRaporFinished).withFailureHandler(onGagal).prosesUploadExcelNilaiRapor(getToken(), fileData, semesterId);
    };
    reader.onerror = (e) => { setLoading(false); showMessage('template-rapor-message', 'Gagal baca file.', true); };
    reader.readAsDataURL(file);
  }

  function onUploadNilaiRaporFinished(response) {
    setLoading(false);
    const resultsContainer = document.getElementById('import-rapor-results');

    if (response.status !== 'sukses') {
      showMessage('template-rapor-message', response.message, true);
      resultsContainer.style.display = 'none';
      return;
    }

    if (response.berhasilDiUpload > 0) {
      setIjazahDirty(true);// <-- TAMBAHKAN INI
      nilaiRaporTelahDiUpload = true;
    }

    let html = '<h4><i class="fas fa-check-circle"></i>Proses Upload Selesai</h4>';
    html += `<p>Total nilai terdeteksi: <strong>${response.totalDitemukan}</strong></p>`;
    html += `<p style="color: var(--success-color);">Berhasil disimpan/diperbarui: <strong>${response.berhasilDiUpload}</strong></p>`;
    html += `<p style="color: var(--danger-color);">Gagal/Dilewati: <strong>${response.gagalDiUpload}</strong></p>`;

    if (response.dataGagal && response.dataGagal.length > 0) {
      html += `<hr><p><strong>Detail Data yang Gagal:</strong></p>`;
      html += '<table class="import-gagal-table">';
      html += '<tr><th>Sheet</th><th>Baris</th><th>Info</th><th>Alasan Gagal</th></tr>';
      
      response.dataGagal.forEach(item => {
        html += `
          <tr>
            <td>${item.sheet || 'N/A'}</td>
            <td>${item.baris || 'N/A'}</td>
            <td>${item.info || 'N/A'}</td>
            <td>${item.alasan}</td>
          </tr>
        `;
      });
      html += '</table>';
    }

    resultsContainer.innerHTML = html;
    resultsContainer.style.display = 'block';

    document.getElementById('file-upload-rapor').value = null;
    document.getElementById('btn-proses-upload-nilai-rapor').disabled = true;
    
    const fileUploadText = document.getElementById('file-upload-text-rapor');
    fileUploadText.innerText = 'Klik untuk memilih file atau seret & letakkan di sini.';
    fileUploadText.classList.remove('file-chosen');
  }

  function bukaHalamanInputUjian() {
    tampilHalaman('halaman-input-ujian');

    const labelUjianUtama = document.getElementById('label-ujian-utama');

    const jenjangPilihan = jenjangPilihanCache;
    if (jenjangPilihan === 'MI' || jenjangPilihan === 'MTS' || jenjangPilihan === 'MA') {
      labelUjianUtama.innerText = 'Ujian Madrasah';
    } else {
      labelUjianUtama.innerText = 'Ujian Sekolah';
    }

    const btnRekapUjian = document.getElementById('btn-buka-rekap-nilai');
    const btnPraktek = document.getElementById('btn-buka-input-praktek');
    const btnMadrasah = document.getElementById('btn-buka-input-um');

    const gridContainer = document.querySelector('#halaman-input-ujian .dashboard-menu-grid');
    
    const oldMessage = gridContainer.querySelector('.guru-no-mapel-message');
    if (oldMessage) {
      oldMessage.remove();
    }

    if (currentUserRole === 'guru') {
      if (btnRekapUjian) {
        btnRekapUjian.style.display = 'none';
      }
      
      let hasContent = false;
      
      if (btnPraktek) {
        if (guruHasPraktek) {
          btnPraktek.style.display = 'flex';
          hasContent = true; 
        } else {
          btnPraktek.style.display = 'none';
        }
      }
      if (btnMadrasah) {
        if (guruHasMadrasah) {
          btnMadrasah.style.display = 'flex';
          hasContent = true; 
        } else {
          btnMadrasah.style.display = 'none';
        }
      }

      if (!hasContent && gridContainer) {
        const messageEl = document.createElement('p');
        messageEl.className = 'guru-no-mapel-message'; 
        messageEl.innerHTML = `
          <i class="fas fa-info-circle"></i>
          <strong>Mata pelajaran Anda belum diatur.</strong>
          <br>
          Silakan hubungi Admin sekolah untuk mengatur mapel yang Anda ampu (Ujian Madrasah/Sekolah atau Praktek) agar menu input nilai dapat tampil.
        `;
        gridContainer.appendChild(messageEl);
      }
      
    } else {
      if (btnRekapUjian) {
        btnRekapUjian.style.display = 'flex';
      }
      if (btnPraktek) {
        btnPraktek.style.display = 'flex';
      }
      if (btnMadrasah) {
        btnMadrasah.style.display = 'flex';
      }
    }
    
    // --- TAMBAHKAN PANGGILAN INI DI AKHIR FUNGSI ---
    // Panggil pre-loader
    preloadNilaiGrids();
    // --- AKHIR TAMBAHAN ---
  }

  function bukaHalamanInputNilaiDetail(tipeUjian) {
    isFormDirty = false;
    tampilHalaman('halaman-input-nilai-detail');
    hideMessage('input-nilai-message');
    const page = document.getElementById('halaman-input-nilai-detail');
    const judulHalaman = document.getElementById('judul-halaman-input-nilai');
    const tableContainer = document.getElementById('input-nilai-table-container');
    const btnSimpan = document.getElementById('btn-simpan-input-nilai');
    const btnBersihkan = document.getElementById('btn-bersihkan-input-nilai');
    
    btnSimpan.disabled = true;
    btnBersihkan.disabled = true;
    document.getElementById('input-nilai-filter-kelas').innerHTML = '<option value="semua">-- Tampilkan Semua Kelas --</option>';
    globalGridData = { siswaList: [], mapelList: [], nilaiData: {} };

    // --- Setup Judul Halaman (Logika Asli) ---
    if (tipeUjian === 'UM') {
      const label = (jenjangPilihanCache === 'MI' || jenjangPilihanCache === 'MTS' || jenjangPilihanCache === 'MA') ? 'Ujian Madrasah' : 'Ujian Sekolah';
      judulHalaman.innerText = `Input Nilai ${label}`;
      judulHalaman.dataset.tipeUjian = 'UM';
      page.classList.remove('tipe-ujian-praktek'); page.classList.add('tipe-ujian-um');
    } else {
      judulHalaman.innerText = 'Input Nilai Ujian Praktek';
      judulHalaman.dataset.tipeUjian = 'Praktek';
      page.classList.remove('tipe-ujian-um'); page.classList.add('tipe-ujian-praktek');
    }

    // --- LOGIKA CACHE BARU ---
    const cache = (tipeUjian === 'UM') ? globalNilaiGridCacheUM : globalNilaiGridCachePraktek;

    if (cache !== null && cache.status === 'sukses') {
      // 1. CACHE HIT (INSTAN)
      console.log(`Memuat grid ${tipeUjian} dari cache klien.`);
      tableContainer.innerHTML = '<p>Memuat data...</p>'; // Tampilkan pesan loading singkat
      
      // Panggil handler secara sinkron (atau async kecil)
      setTimeout(() => {
        onNilaiGridLoaded(cache);
      }, 10); // Jeda kecil agar "Memuat data..." sempat ter-render
      
    } else {
      // 2. CACHE MISS (ATAU GAGAL PRELOAD)
      let loadingMsg = 'Memuat data nilai...';
      if (cache !== null && cache.status === 'gagal') {
        console.warn(`Cache ${tipeUjian} gagal, memuat ulang dari server.`);
        loadingMsg = 'Memuat ulang data (cache gagal)...';
      } else {
        console.log(`Cache grid ${tipeUjian} kosong, memuat dari server...`);
      }
      
      tableContainer.innerHTML = '<p>Memuat data...</p>';
      setLoading(true, loadingMsg, false, false); // Tampilkan loading server
      
      google.script.run
        .withSuccessHandler(onNilaiGridLoaded)
        .withFailureHandler(onGagal)
        .getNilaiUjianGridData(getToken(), tipeUjian);
    }
    // --- AKHIR LOGIKA CACHE BARU ---
  }

  function populateNilaiFilter(siswaList) {
    const selectKelas = document.getElementById('input-nilai-filter-kelas');
    const selectedValue = selectKelas.value;
  
    const kelasSet = new Set(siswaList.map(siswa => siswa.kelas));
    const kelasList = Array.from(kelasSet).sort(compareKelas); 
  
    let optionsHtml = '<option value="semua">-- Tampilkan Semua Kelas --</option>';
    kelasList.forEach(kelas => {
      optionsHtml += `<option value="${kelas}">${kelas}</option>`;
    });
  
    selectKelas.innerHTML = optionsHtml;
    
    // [MODIFIKASI] Default ke kelas pertama, bukan 'semua' jika kelas lebih dari 1
    if (selectedValue) {
       selectKelas.value = selectedValue;
    } else if (kelasList.length > 0) {
       // Ubah baris di bawah ini jika ingin default ke kelas pertama:
       // selectKelas.value = kelasList[0]; 
       selectKelas.value = 'semua'; // Saya biarkan 'semua' karena sudah ada pagination
    }
  }

  function onNilaiGridLoaded(response) {
    setLoading(false);
    const container = document.getElementById('input-nilai-table-container');
    const btnSimpan = document.getElementById('btn-simpan-input-nilai');
    const btnBersihkan = document.getElementById('btn-bersihkan-input-nilai');
    
    hideMessage('input-nilai-message');

    // --- TAMBAHAN DI SINI: Simpan ke Cache ---
    const tipeUjian = document.getElementById('judul-halaman-input-nilai').dataset.tipeUjian;
    if (response.status === 'sukses') {
      if (tipeUjian === 'UM') {
        // Hanya simpan ke cache jika cache kosong atau gagal (bukan dari cache hit)
        if(globalNilaiGridCacheUM === null || globalNilaiGridCacheUM.status === 'gagal') {
           globalNilaiGridCacheUM = response; // Simpan respons sukses ke cache
        }
      } else {
        if(globalNilaiGridCachePraktek === null || globalNilaiGridCachePraktek.status === 'gagal') {
           globalNilaiGridCachePraktek = response; // Simpan respons sukses ke cache
        }
      }
    }
    // --- AKHIR TAMBAHAN ---
    
    if (response.status !== 'sukses') {
      container.innerHTML = `<p class="message error" style="display:block;">Gagal memuat data: ${response.message}</p>`;
      btnSimpan.disabled = true;
      btnBersihkan.disabled = true;
      globalGridData = { siswaList: [], mapelList: [], nilaiData: {} };
      return;
    }

    // --- (Sisa fungsi Anda dari sini ke bawah tetap sama) ---
    
    const isInputDiizinkan = response.data.isInputDiizinkan;
    const pesanInput = response.data.pesanInput;
    
    if (currentUserRole === 'guru' && !isInputDiizinkan) {
      globalGridData = { siswaList: [], mapelList: [], nilaiData: {} };
      
      container.innerHTML = `<p class="message error" style="display:block;">${pesanInput}</p>`;
      
      btnSimpan.disabled = true;
      btnBersihkan.disabled = true;
      
      showToast(pesanInput, 'gagal');
      
      return; 
    }

    globalGridData = response.data;

    populateNilaiFilter(globalGridData.siswaList);

    renderNilaiGridTable(); 

    const { siswaList, mapelList } = globalGridData;
    if (siswaList && siswaList.length > 0 && mapelList && mapelList.length > 0) {
      btnSimpan.disabled = false;
      btnBersihkan.disabled = false;
    } else {
      btnSimpan.disabled = true;
      btnBersihkan.disabled = true;
    }

    autoScrollToBottom();
  }

  /**
   * VERSI TEROPTIMASI: DENGAN PAGINATION
   * Merender grid input nilai secara bertahap (per halaman) untuk mencegah lag.
   */
  function renderNilaiGridTable() {
      const container = document.getElementById('input-nilai-table-container');
      container.innerHTML = ""; // 1. Kosongkan container

      const { siswaList, mapelList, nilaiData, mapelKelasData } = globalGridData;
      const selectedKelas = document.getElementById('input-nilai-filter-kelas').value;

      // 2. Logika Pengecekan Data Kosong
      if (!siswaList || siswaList.length === 0) {
          container.innerHTML = '<p style="text-align: center; padding: 20px;">Belum ada data siswa.</p>';
          return;
      }
      if (!mapelList || mapelList.length === 0) {
          container.innerHTML = '<p style="text-align: center; padding: 20px;">Belum ada mapel yang diatur.</p>';
          return;
      }

      // Filter Data
      const filteredSiswaList = (selectedKelas === 'semua')
        ? siswaList
        : siswaList.filter(siswa => siswa.kelas === selectedKelas);

      if (filteredSiswaList.length === 0) {
          container.innerHTML = '<p style="text-align: center; padding: 20px;">Tidak ada siswa di kelas yang dipilih.</p>';
          return;
      }

      // --- [LOGIKA PAGINASI BARU] ---
      const totalRows = filteredSiswaList.length;
      const totalPages = Math.ceil(totalRows / ROWS_PER_PAGE);
      
      // Pastikan current page valid
      if (currentNilaiPage > totalPages) currentNilaiPage = 1;
      if (currentNilaiPage < 1) currentNilaiPage = 1;

      const startIndex = (currentNilaiPage - 1) * ROWS_PER_PAGE;
      const endIndex = Math.min(startIndex + ROWS_PER_PAGE, totalRows);
      
      // Ambil data HANYA untuk halaman ini
      const paginatedList = filteredSiswaList.slice(startIndex, endIndex);
      // --- [AKHIR LOGIKA PAGINASI] ---

      // 3. Mulai Buat Tabel
      const mapelCount = mapelList.length;
      let tableClass = 'guru-view';
      if (currentUserRole === 'guru' && mapelCount > 4) { 
        tableClass += ' guru-view-many-mapels';
      }
      
      const table = document.createElement('table');
      table.className = `input-nilai-table ${tableClass}`;

      // 4. Buat Header
      const thead = table.createTHead();
      const headerRow = thead.insertRow();
      let headerHTML = '<th>Nama Siswa</th>';
      mapelList.forEach(mapel => {
        headerHTML += `<th class="col-mapel clickable-mapel-header" data-mapel-nama="${mapel.nama}" title="${mapel.nama}">${mapel.id}</th>`;
      });
      headerHTML += '<th class="th-total th-total-jumlah">Jumlah</th>';
      headerHTML += '<th class="th-total th-total-rata">Rata-Rata</th>';
      headerRow.innerHTML = headerHTML;

      // 5. Buat Body & Fragment
      const tbody = table.createTBody();
      const fragment = document.createDocumentFragment();

      // Loop data yang SUDAH DIPAGINASI
      paginatedList.forEach((siswa, index) => {
          // Hitung nomor urut asli (berdasarkan halaman)
          const absoluteIndex = startIndex + index + 1;

          const tr = document.createElement('tr');
          
          // <td> Nama
          const tdNama = tr.insertCell();
          const namaProper = toProperCase(siswa.nama);
          const namaFormatted = formatNamaSiswa(namaProper);
          tdNama.innerHTML = `
            <div style="display:flex; gap:5px;">
                <span class="text-muted" style="font-size:0.85em; min-width:20px;">${absoluteIndex}.</span>
                <span class="clickable-nama-siswa" data-nisn="${siswa.nisn}" data-nama-lengkap="${siswa.nama}">${namaFormatted}</span>
            </div>`;
          
          // Loop <td> Mapel
          mapelList.forEach(mapel => {
              const key = `${siswa.id}_${mapel.id}`;
              const storedNilai = nilaiData[key];
              let nilai = '';
              if (storedNilai === 0 || storedNilai === '0') nilai = 0;
              else if (storedNilai) nilai = storedNilai;

              let isCellDisabled = false;
              if (currentUserRole === 'guru' && mapelKelasData) {
                const allowedClassesForMapel = mapelKelasData[mapel.id];
                if (allowedClassesForMapel) {
                  if (!allowedClassesForMapel.includes(siswa.kelas) && !allowedClassesForMapel.includes("*")) {
                    isCellDisabled = true;
                  }
                } else {
                  isCellDisabled = true;
                }
              }
              
              const tdMapel = tr.insertCell();
              tdMapel.className = 'col-mapel';
              
              const input = document.createElement('input');
              input.type = 'number';
              input.className = 'input-nilai';
              input.min = 0;
              input.max = 100;
              input.placeholder = '-';
              input.value = nilai;
              input.dataset.siswaId = siswa.id;
              input.dataset.mapelId = mapel.id;
              input.disabled = isCellDisabled;
              
              tdMapel.appendChild(input);
          });
          
          // <td> Total
          const tdJumlah = tr.insertCell();
          tdJumlah.className = 'col-total col-total-jumlah';
          tdJumlah.id = `jumlah_${siswa.id}`;
          tdJumlah.textContent = '0';
          
          const tdRata = tr.insertCell();
          tdRata.className = 'col-total col-total-rata';
          tdRata.id = `rata_${siswa.id}`;
          tdRata.textContent = '0.00';
          
          fragment.appendChild(tr);
      });
      
      tbody.appendChild(fragment);
      container.appendChild(table);

      // 6. Update totals untuk baris yang terlihat
      if (mapelCount > 0) {
        paginatedList.forEach(siswa => {
          updateRowTotals(siswa.id, mapelCount);
        });
      }

      // 7. [BARU] Render Kontrol Paginasi
      renderPaginationControls(totalPages, totalRows, startIndex + 1, endIndex);
  }

  /**
   * [FUNGSI BARU] Membuat tombol navigasi (Prev/Next) di bawah tabel.
   */
  function renderPaginationControls(totalPages, totalRows, startRow, endRow) {
      const container = document.getElementById('input-nilai-table-container');
      
      // Hapus pagination lama jika ada
      const oldNav = document.getElementById('nilai-pagination-nav');
      if (oldNav) oldNav.remove();

      if (totalPages <= 1) return; // Tidak perlu paginasi jika cuma 1 halaman

      const nav = document.createElement('div');
      nav.id = 'nilai-pagination-nav';
      nav.className = 'd-flex justify-content-between align-items-center mt-3 p-2 bg-light border rounded';
      
      // Info Baris
      const infoDiv = document.createElement('div');
      infoDiv.className = 'small text-muted font-weight-bold';
      infoDiv.innerText = `Menampilkan ${startRow}-${endRow} dari ${totalRows} siswa`;

      // Tombol Group
      const btnGroup = document.createElement('div');
      
      // Tombol Prev
      const btnPrev = document.createElement('button');
      btnPrev.className = 'btn btn-sm btn-outline-primary mr-2';
      btnPrev.innerHTML = '<i class="fas fa-chevron-left"></i> Sebelumnya';
      btnPrev.disabled = (currentNilaiPage === 1);
      btnPrev.onclick = () => changeNilaiPage(currentNilaiPage - 1);

      // Info Halaman (Dropdown)
      const pageSelect = document.createElement('select');
      pageSelect.className = 'form-control form-control-sm d-inline-block mr-2';
      pageSelect.style.width = 'auto';
      for (let i = 1; i <= totalPages; i++) {
          const opt = new Option(`Hal ${i}`, i);
          if (i === currentNilaiPage) opt.selected = true;
          pageSelect.add(opt);
      }
      pageSelect.onchange = (e) => changeNilaiPage(parseInt(e.target.value));

      // Tombol Next
      const btnNext = document.createElement('button');
      btnNext.className = 'btn btn-sm btn-outline-primary';
      btnNext.innerHTML = 'Berikutnya <i class="fas fa-chevron-right"></i>';
      btnNext.disabled = (currentNilaiPage === totalPages);
      btnNext.onclick = () => changeNilaiPage(currentNilaiPage + 1);

      btnGroup.appendChild(btnPrev);
      btnGroup.appendChild(pageSelect);
      btnGroup.appendChild(btnNext);

      nav.appendChild(infoDiv);
      nav.appendChild(btnGroup);
      
      container.appendChild(nav);
  }

  /**
   * [FUNGSI BARU] Mengganti halaman.
   */
  function changeNilaiPage(newPage) {
      // Simpan nilai sementara sebelum pindah halaman?
      // Karena data disimpan di variabel global via event 'input', 
      // kita tidak perlu simpan manual di sini. Cukup render ulang.
      
      currentNilaiPage = newPage;
      renderNilaiGridTable(); // Render ulang halaman baru
      
      // Scroll kembali ke atas tabel
      const container = document.getElementById('input-nilai-table-container');
      if(container) container.scrollTop = 0;
  }

  function updateRowTotals(siswaId, mapelCount) {
    const jumlahCell = document.getElementById(`jumlah_${siswaId}`);
    const rataCell = document.getElementById(`rata_${siswaId}`);
    
    if (!jumlahCell || !rataCell) return;

    const rowInputs = document.querySelectorAll(`.input-nilai[data-siswa-id="${siswaId}"]`);
    
    let sum = 0;
    let count = 0; 

    rowInputs.forEach(input => {
      const value = input.value; 
      
      if (value !== "" && value !== null && value !== undefined) {
        const numValue = parseFloat(value);
        if (!isNaN(numValue) && numValue >= 0 && numValue <= 100) {
          sum += numValue;
          count++; 
        }
      }
    });

    const average = (count > 0) ? (sum / count) : 0;
    
    jumlahCell.innerText = sum;
    rataCell.innerText = average.toFixed(2);
  }

  function simpanInputNilai() {
    setTableInputLock('halaman-input-nilai-detail', true, 'Menyimpan nilai ujian...');
    undoManager.clearHistory();
    hideMessage('input-nilai-message');
    const tipeUjian = document.getElementById('judul-halaman-input-nilai').dataset.tipeUjian;
    const inputs = document.querySelectorAll('#input-nilai-table-container .input-nilai');
    const dataToSave = [];
    inputs.forEach(input => {
      dataToSave.push({ siswaId: input.dataset.siswaId, mapelId: input.dataset.mapelId, tipeUjian: tipeUjian, nilai: input.value });
    });
    google.script.run
      .withSuccessHandler((response) => onNilaiUjianSaved(response, dataToSave))
      .withFailureHandler(onGagal)
      .saveNilaiUjianBatch(getToken(), dataToSave);
  }

  function onNilaiUjianSaved(response, savedData) {
    if (response.status === 'sukses') {
      setTableInputLock('halaman-input-nilai-detail', true, 'Sukses! Memuat ulang data...');
      isFormDirty = false;
      setIjazahDirty(true);
      const tipeUjian = document.getElementById('judul-halaman-input-nilai').dataset.tipeUjian;
      
      // --- PERUBAHAN DI SINI ---
      // Hapus cache yang baru saja kita simpan, agar dimuat ulang
      if (tipeUjian === 'UM') {
        globalNilaiGridCacheUM = null;
      } else {
        globalNilaiGridCachePraktek = null;
      }
      // --- AKHIR PERUBAHAN ---
      
      google.script.run.withSuccessHandler(onNilaiGridLoaded).withFailureHandler(onGagal).getNilaiUjianGridData(getToken(), tipeUjian);
    } else {
      setTableInputLock('halaman-input-nilai-detail', false);
      showMessage('input-nilai-message', response.message, true);
    }
  }

  function bukaHalamanRekapNilai() {
    tampilHalaman('halaman-rekap-nilai');
    hideMessage('rekap-nilai-message');
    document.getElementById('rekap-nilai-table-container').innerHTML = '<p>Memuat data...</p>';
    document.getElementById('rekap-nilai-filter-kelas').innerHTML = '<option value="semua">-- Tampilkan Semua Kelas --</option>';
    globalGridData = { siswaList: [], mapelList: [], nilaiRekapData: {} };
    setLoading(true, 'Membuat rekap...', false, false);
    google.script.run.withSuccessHandler(onRekapNilaiLoaded).withFailureHandler(onGagal).getRekapitulasiNilaiData(getToken());
  }

  function onRekapNilaiLoaded(response) {
    setLoading(false);
    const container = document.getElementById('rekap-nilai-table-container');
    
    if (response.status !== 'sukses') {
      container.innerHTML = `<p class="message error" style="display:block;">Gagal memuat data: ${response.message}</p>`;
      globalGridData = { siswaList: [], mapelList: [], nilaiRekapData: {} };
      return;
    }

    globalGridData = response.data;
    
    populateRekapNilaiFilter(globalGridData.siswaList);

    renderRekapNilaiTable();
  }

  function populateRekapNilaiFilter(siswaList) {
    const selectKelas = document.getElementById('rekap-nilai-filter-kelas');
    const selectedValue = selectKelas.value;
  
    const kelasSet = new Set(siswaList.map(siswa => siswa.kelas));
    const kelasList = Array.from(kelasSet).sort(compareKelas); // [MODIFIKASI]
  
    let optionsHtml = '<option value="semua">-- Tampilkan Semua Kelas --</option>';
    kelasList.forEach(kelas => {
      optionsHtml += `<option value="${kelas}">${kelas}</option>`;
    });
  
    selectKelas.innerHTML = optionsHtml;
    selectKelas.value = selectedValue || (kelasList.length === 1 ? kelasList[0] : 'semua');
  }

  /**
   * VERSI REFACTOR (Cepat)
   * Merender tabel rekap nilai ujian menggunakan DocumentFragment.
   */
  function renderRekapNilaiTable() {
      const container = document.getElementById('rekap-nilai-table-container');
      container.innerHTML = ""; // 1. Kosongkan

      const { siswaList, mapelList, nilaiRekapData } = globalGridData;
      const selectedKelas = document.getElementById('rekap-nilai-filter-kelas').value;

      // 2. Logika Pengecekan Data Kosong
      if (!siswaList || siswaList.length === 0) {
          const p = document.createElement('p');
          p.style = "text-align: center; padding: 20px;";
          p.textContent = 'Belum ada data siswa.';
          container.appendChild(p);
          return;
      }
      if (!mapelList || mapelList.length === 0) {
          const tipeUjian = document.getElementById('judul-halaman-input-nilai').dataset.tipeUjian;
          const pesan = `Tidak ada mapel yang diatur untuk ${tipeUjian === 'UM' ? 'Ujian Sekolah/Madrasah' : 'Ujian Praktek'}. Harap centang di menu "Kelola Mapel".`;
          const p = document.createElement('p');
          p.style = "text-align: center; padding: 20px;";
          p.textContent = pesan;
          container.appendChild(p);
          return;
      }

      const filteredSiswaList = (selectedKelas === 'semua')
        ? siswaList
        : siswaList.filter(siswa => siswa.kelas === selectedKelas);
      if (filteredSiswaList.length === 0) {
          const p = document.createElement('p');
          p.style = "text-align: center; padding: 20px;";
          p.textContent = (selectedKelas !== 'semua') ? 'Tidak ada siswa di kelas yang dipilih.' : 'Tidak ada data siswa.';
          container.appendChild(p);
          return;
      }
      
      // 3. Mulai Buat Tabel
      const table = document.createElement('table');
      table.className = 'input-nilai-table';

      // 4. Buat Header
      const thead = table.createTHead();
      const headerRow = thead.insertRow();
      let headerHTML = '<th>Nama Siswa</th>';
      mapelList.forEach(mapel => {
        headerHTML += `<th 
                        class="col-mapel clickable-mapel-header" 
                        data-mapel-nama="${mapel.nama}" 
                        title="Klik untuk lihat nama mapel"
                      >
                        ${mapel.id}
                      </th>`;
      });
      headerHTML += '<th class="th-total th-total-jumlah">Jumlah</th>';
      headerHTML += '<th class="th-total th-total-rata">Rata-Rata</th>';
      headerHTML += '<th class="th-total th-total-bulat">Pembulatan</th>';
      headerRow.innerHTML = headerHTML;

      // 5. Buat Body & Fragment
      const tbody = table.createTBody();
      const fragment = document.createDocumentFragment();

      filteredSiswaList.forEach(siswa => {
          const tr = document.createElement('tr');
          
          let rowHTML = ''; // Kita akan bangun HTML untuk <tr> ini
          
          const namaProper = toProperCase(siswa.nama);
          const namaFormatted = formatNamaSiswa(namaProper);
          rowHTML += `
            <td>
              <span 
                class="clickable-nama-siswa" 
                data-nisn="${siswa.nisn}" 
                data-nama-lengkap="${siswa.nama}"
                title="Klik untuk lihat NISN"
              >
                ${namaFormatted}
              </span>
            </td>`;
          
          let sum = 0;
          let count = 0; 
          
          mapelList.forEach(mapel => {
            const key = `${siswa.id}_${mapel.id}`;
            const nilai = nilaiRekapData[key];
            
            let nilaiTampil = '-';
            if (nilai !== null && nilai !== undefined) {
                if (nilai === 0) {
                  nilaiTampil = 0;
                } else {
                  if (nilai % 1 === 0) {
                    nilaiTampil = nilai.toFixed(0);
                  } else {
                    nilaiTampil = nilai.toFixed(2); 
                  }
                }
                sum += nilai;
                count++; 
            }
            
            rowHTML += `<td class="col-mapel" style="text-align: center; font-weight: 500;">
                ${nilaiTampil}
              </td>`;
          });
          
          const average = (count > 0) ? (sum / count) : 0;
          const pembulatan = Math.round(average);
          const sumTampil = parseFloat(sum.toFixed(2));
          
          rowHTML += `<td class="col-total col-total-jumlah">${sumTampil}</td>`;
          rowHTML += `<td class="col-total col-total-rata">${average.toFixed(2)}</td>`;
          rowHTML += `<td class="col-total col-total-bulat">${pembulatan}</td>`;
          
          tr.innerHTML = rowHTML; // Set innerHTML untuk <tr>
          fragment.appendChild(tr); // Tambahkan ke fragment
      });

      // 6. Tambahkan fragment ke body
      tbody.appendChild(fragment);
      // 7. Tambahkan tabel ke container
      container.appendChild(table);
  }

  function konfirmasiBersihkanNilai() {
    const title = "Konfirmasi Bersihkan Formulir";
    const message = "Ingin memulai lembar baru? <br><br>Ini akan <strong>mengosongkan semua nilai</strong> yang tampil di layar. Data yang sudah tersimpan di server <strong>tetap aman</strong>.";
    
    showConfirmationModal(title, message, bersihkanInputNilai, 'danger');
  }

  function bersihkanInputNilai() {
    const inputs = document.querySelectorAll('#input-nilai-table-container .input-nilai');
    
    const mapelCount = globalGridData.mapelList.length;
    
    const siswaIdsToUpdate = new Set();

    inputs.forEach(input => {
      input.value = '';
      siswaIdsToUpdate.add(input.dataset.siswaId);
    });

    isFormDirty = true; // <-- TAMBAHKAN INI

    if (mapelCount > 0) {
      siswaIdsToUpdate.forEach(siswaId => {
        updateRowTotals(siswaId, mapelCount);
      });
    }

    showMessage('input-nilai-message', 'Semua nilai di formulir telah dibersihkan.', false);
  }

  function bukaHalamanInputRapor() {
    tampilHalaman('halaman-input-rapor');
    setLoading(true, 'Memuat daftar semester...', false, false);
    document.getElementById('rapor-semester-card-container').innerHTML = '<p>Memuat...</p>';
    google.script.run.withSuccessHandler(onSemesterListLoaded).withFailureHandler(onGagal).getSemesterList(getToken());
  }

  function onSemesterListLoaded(response) {
    setLoading(false);
    const container = document.getElementById('rapor-semester-card-container');
    if (response.status !== 'sukses') {
      container.innerHTML = `<p class="message error" style="display:block;">${response.message}</p>`;
      return;
    }

    if (response.semesterList.length === 0) {
      container.innerHTML = '<p>Tidak ada daftar semester yang ditemukan. Periksa pengaturan jenjang dan semester.</p>';
      return;
    }

    let html = '';
    response.semesterList.forEach(semester => {
      const hoverStyle = `onmouseover="this.style.backgroundColor='${semester.color}'; this.style.color='white';" 
                          onmouseout="this.style.backgroundColor='white'; this.style.color='${semester.color}';"`;
      
      html += `
        <button class="dashboard-card" onclick="bukaHalamanInputRaporDetail('${semester.id}')" 
                style="color: ${semester.color || '#0d6efd'};" ${hoverStyle}>
          <i class="fas fa-edit"></i>
          <span>${semester.nama}</span>
        </button>
      `;
    });
    container.innerHTML = html;
    
    // --- TAMBAHKAN PANGGILAN INI DI AKHIR FUNGSI ---
    // Panggil pre-loader dengan daftar semester yang baru diterima
    preloadNilaiRaporGrids(response.semesterList);
    // --- AKHIR TAMBAHAN ---
  }

  function bukaHalamanInputRaporDetail(semesterId) {
    isFormDirty = false;
    tampilHalaman('halaman-input-rapor-detail');
    hideMessage('input-rapor-message');
    
    // --- Setup UI (Logika Asli) ---
    document.getElementById('input-rapor-table-container').innerHTML = '<p>Memuat data...</p>';
    document.getElementById('input-rapor-keterampilan-table-container').innerHTML = '<p>Memuat data...</p>';
    document.getElementById('rekap-rapor-semester-table-container').innerHTML = '<p>Memuat data...</p>';
    ['btn-simpan-input-rapor-p', 'btn-bersihkan-input-rapor-p', 'btn-simpan-input-rapor-k', 'btn-bersihkan-input-rapor-k']
      .forEach(id => document.getElementById(id).disabled = true);
    document.getElementById('input-rapor-filter-kelas').innerHTML = '<option value="semua">-- Tampilkan Semua Kelas --</option>';
    globalRaporData = { P: { siswaList: [], mapelList: [], nilaiData: {} }, K: { siswaList: [], mapelList: [], nilaiData: {} }, Rekap: { siswaList: [], mapelList: [], nilaiRekapData: {} } };
    const judulHalaman = document.getElementById('judul-halaman-input-rapor');
    judulHalaman.innerText = `Input Nilai Rapor...`;
    judulHalaman.dataset.semesterId = semesterId;
    
    // --- LOGIKA CACHE BARU ---
    const cache = globalNilaiRaporGridCache.get(semesterId);

    if (cache && cache.status === 'sukses') {
      // 1. CACHE HIT (INSTAN)
      console.log(`Memuat grid Rapor (${semesterId}) dari cache klien.`);
      // Panggil handler secara sinkron (atau async kecil)
      setTimeout(() => {
        onNilaiRaporGridLoaded(cache);
      }, 10); // Jeda kecil agar "Memuat data..." sempat ter-render
      
    } else {
      // 2. CACHE MISS (ATAU GAGAL PRELOAD)
      let loadingMsg = 'Memuat data nilai rapor...';
      if (cache && cache.status === 'gagal') {
        console.warn(`Cache Rapor (${semesterId}) gagal, memuat ulang dari server.`);
        loadingMsg = 'Memuat ulang data (cache gagal)...';
      } else if (cache && cache.status === 'loading') {
        console.log(`Cache Rapor (${semesterId}) masih loading, menunggu...`);
        loadingMsg = 'Data sedang disiapkan, harap tunggu...';
      } else {
        console.log(`Cache grid Rapor (${semesterId}) kosong, memuat dari server...`);
      }
      
      setLoading(true, loadingMsg, false, false); // Tampilkan loading server
      
      google.script.run
        .withSuccessHandler(onNilaiRaporGridLoaded)
        .withFailureHandler(onGagal)
        .getNilaiRaporGridData(getToken(), semesterId);
    }
    // --- AKHIR LOGIKA CACHE BARU ---
  }

  function onNilaiRaporGridLoaded(response) {
    setLoading(false);
    const semesterId = document.getElementById('judul-halaman-input-rapor').dataset.semesterId;
    
    // --- TAMBAHAN DI SINI: Simpan ke Cache ---
    if (response.status === 'sukses') {
      // Hanya simpan ke cache jika cache kosong, gagal, atau 'loading'
      const existingCache = globalNilaiRaporGridCache.get(semesterId);
      if(!existingCache || existingCache.status !== 'sukses') {
         globalNilaiRaporGridCache.set(semesterId, response); // Simpan respons sukses ke cache
      }
    }
    // --- AKHIR TAMBAHAN ---
    
    const btnSimpanP = document.getElementById('btn-simpan-input-rapor-p');
    const btnBersihkanP = document.getElementById('btn-bersihkan-input-rapor-p');
    const btnSimpanK = document.getElementById('btn-simpan-input-rapor-k');
    const btnBersihkanK = document.getElementById('btn-bersihkan-input-rapor-k');

    if (response.status !== 'sukses') {
      document.getElementById('input-rapor-table-container').innerHTML = `<p class="message error" style="display:block;">Gagal memuat data: ${response.message}</p>`;
      document.getElementById('input-rapor-keterampilan-table-container').innerHTML = "";
      document.getElementById('rekap-rapor-semester-table-container').innerHTML = "";
      return;
    }

    if (response.namaSemester) {
        document.getElementById('judul-halaman-input-rapor').innerText = `Input Nilai ${response.namaSemester}`;
    }

    globalRaporData.P = response.dataP;
    globalRaporData.K = response.dataK;
    globalRaporData.Rekap = response.dataRekap;
    
    populateNilaiRaporFilter(globalRaporData.P.siswaList);
    
    renderNilaiRaporGridTable('P'); 
    renderNilaiRaporGridTable('K');
    renderRekapRaporSemesterTable();
    
    activateRaporTab('pengetahuan');
    
    const { siswaList: siswaListP, mapelList: mapelListP } = globalRaporData.P;
    if (siswaListP && siswaListP.length > 0 && mapelListP && mapelListP.length > 0) {
      btnSimpanP.disabled = false;
      btnBersihkanP.disabled = false;
    }
    
    const { siswaList: siswaListK, mapelList: mapelListK } = globalRaporData.K;
    if (siswaListK && siswaListK.length > 0 && mapelListK && mapelListK.length > 0) {
      btnSimpanK.disabled = false;
      btnBersihkanK.disabled = false;
    }
  }
  
  function populateNilaiRaporFilter(siswaList) {
    const selectKelas = document.getElementById('input-rapor-filter-kelas');
    const selectedValue = selectKelas.value;
    const kelasSet = new Set(siswaList.map(siswa => siswa.kelas));
    const kelasList = Array.from(kelasSet).sort(compareKelas); // [MODIFIKASI]
    let optionsHtml = '<option value="semua">-- Tampilkan Semua Kelas --</option>';
    kelasList.forEach(kelas => {
      optionsHtml += `<option value="${kelas}">${kelas}</option>`;
    });
    selectKelas.innerHTML = optionsHtml;
    selectKelas.value = selectedValue || (kelasList.length === 1 ? kelasList[0] : 'semua');
  }

  /**
   * VERSI REFACTOR (Cepat)
   * Merender grid nilai rapor (P atau K) menggunakan DocumentFragment.
   */
  function renderNilaiRaporGridTable(tipeNilai) {
      const data = (tipeNilai === 'P') ? globalRaporData.P : globalRaporData.K;
      const containerId = (tipeNilai === 'P') ? 'input-rapor-table-container' : 'input-rapor-keterampilan-table-container';
      const totalIdPrefix = (tipeNilai === 'P') ? 'p' : 'k';

      const container = document.getElementById(containerId);
      container.innerHTML = ""; // 1. Kosongkan container
      
      const { siswaList, mapelList, nilaiData } = data;
      const selectedKelas = document.getElementById('input-rapor-filter-kelas').value;

      // 2. Logika Pengecekan Data Kosong
      if (!siswaList || siswaList.length === 0) {
          const p = document.createElement('p');
          p.style = "text-align: center; padding: 20px;";
          p.textContent = 'Belum ada data siswa.';
          container.appendChild(p);
          return;
      }
      if (!mapelList || mapelList.length === 0) {
          const p = document.createElement('p');
          p.style = "text-align: center; padding: 20px;";
          p.textContent = 'Belum ada data mata pelajaran.';
          container.appendChild(p);
          return;
      }

      const filteredSiswaList = (selectedKelas === 'semua')
        ? siswaList
        : siswaList.filter(siswa => siswa.kelas === selectedKelas);

      if (filteredSiswaList.length === 0) {
          const p = document.createElement('p');
          p.style = "text-align: center; padding: 20px;";
          p.textContent = 'Tidak ada siswa di kelas yang dipilih.';
          container.appendChild(p);
          return;
      }

      // 3. Mulai Buat Tabel
      const table = document.createElement('table');
      table.className = 'input-nilai-table guru-view'; // Asumsi guru-view default

      // 4. Buat Header
      const thead = table.createTHead();
      const headerRow = thead.insertRow();
      let headerHTML = '<th>Nama Siswa</th>';
      mapelList.forEach(mapel => {
        headerHTML += `<th class="col-mapel clickable-mapel-header" data-mapel-nama="${mapel.nama}" title="Klik untuk lihat nama mapel">${mapel.id}</th>`;
      });
      headerHTML += '<th class="th-total th-total-jumlah">Jumlah</th>';
      headerHTML += '<th class="th-total th-total-rata">Rata-Rata</th>';
      headerRow.innerHTML = headerHTML;

      // 5. Buat Body & Fragment
      const tbody = table.createTBody();
      const fragment = document.createDocumentFragment();

      filteredSiswaList.forEach(siswa => {
          const tr = document.createElement('tr');
          
          // <td> Nama
          const tdNama = tr.insertCell();
          const namaProper = toProperCase(siswa.nama);
          const namaFormatted = formatNamaSiswa(namaProper);
          tdNama.innerHTML = `<span class="clickable-nama-siswa" data-nisn="${siswa.nisn}" data-nama-lengkap="${siswa.nama}" title="Klik untuk lihat NISN">${namaFormatted}</span>`;

          // Loop <td> Mapel
          mapelList.forEach(mapel => {
              const key = `${siswa.id}_${mapel.id}`;
              const storedNilai = nilaiData[key];
              let nilai = '';
              if (storedNilai === 0 || storedNilai === '0') nilai = 0;
              else if (storedNilai) nilai = storedNilai;
              
              const tdMapel = tr.insertCell();
              tdMapel.className = 'col-mapel';
              
              // Buat <input> dinamis
              const input = document.createElement('input');
              input.type = 'number';
              input.className = 'input-nilai';
              input.min = 0;
              input.max = 100;
              input.placeholder = '-';
              input.value = nilai;
              input.dataset.siswaId = siswa.id;
              input.dataset.mapelId = mapel.id;
              
              tdMapel.appendChild(input);
          });

          // <td> Total
          const tdJumlah = tr.insertCell();
          tdJumlah.className = 'col-total col-total-jumlah';
          tdJumlah.id = `jumlah_rapor_${totalIdPrefix}_${siswa.id}`;
          tdJumlah.textContent = '0';
          
          const tdRata = tr.insertCell();
          tdRata.className = 'col-total col-total-rata';
          tdRata.id = `rata_rapor_${totalIdPrefix}_${siswa.id}`;
          tdRata.textContent = '0.00';

          fragment.appendChild(tr);
      });

      // 6. Tambahkan fragment ke body
      tbody.appendChild(fragment);
      // 7. Tambahkan tabel ke container
      container.appendChild(table);

      // 8. Update totals
      const mapelCount = mapelList.length;
      if (mapelCount > 0) {
        filteredSiswaList.forEach(siswa => {
          updateRowTotalsRapor(siswa.id, mapelCount, tipeNilai);
        });
      }
  }

  function updateRowTotalsRapor(siswaId, mapelCount, tipeNilai) {
    const containerSelector = (tipeNilai === 'P') ? '#input-rapor-table-container' : '#input-rapor-keterampilan-table-container';
    const totalIdPrefix = (tipeNilai === 'P') ? 'p' : 'k';
    
    const jumlahCell = document.getElementById(`jumlah_rapor_${totalIdPrefix}_${siswaId}`);
    const rataCell = document.getElementById(`rata_rapor_${totalIdPrefix}_${siswaId}`);
    if (!jumlahCell || !rataCell) return;

    const rowInputs = document.querySelectorAll(`${containerSelector} .input-nilai[data-siswa-id="${siswaId}"]`);
    
    let sum = 0;
    let count = 0; 
    rowInputs.forEach(input => {
      const value = input.value; 
      if (value !== "" && value !== null && value !== undefined) {
        const numValue = parseFloat(value);
        if (!isNaN(numValue) && numValue >= 0 && numValue <= 100) {
          sum += numValue;
          count++; 
        }
      }
    });
    
    const average = (count > 0) ? (sum / count) : 0;
    
    jumlahCell.innerText = sum;
    rataCell.innerText = average.toFixed(2);
  }

  function simpanInputNilaiRapor(tipeNilai) {
    const tipeText = (tipeNilai === 'P') ? 'Pengetahuan' : 'Keterampilan';
    setTableInputLock('halaman-input-rapor-detail', true, `Menyimpan nilai ${tipeText}...`);
    undoManager.clearHistory();
    hideMessage('input-rapor-message');
    const containerSelector = (tipeNilai === 'P') ? '#input-rapor-table-container' : '#input-rapor-keterampilan-table-container';
    const semesterId = document.getElementById('judul-halaman-input-rapor').dataset.semesterId;
    const inputs = document.querySelectorAll(`${containerSelector} .input-nilai`);
    const dataToSave = [];
    inputs.forEach(input => {
      dataToSave.push({ siswaId: input.dataset.siswaId, mapelId: input.dataset.mapelId, semesterId: semesterId, nilai: input.value });
    });
    google.script.run
      .withSuccessHandler((response) => onNilaiRaporSaved(response, tipeNilai, semesterId))
      .withFailureHandler(onGagal)
      .saveNilaiRaporBatch(getToken(), dataToSave, tipeNilai);
  }

  // Callback simpan rapor (perlu token untuk fetch ulang)
  function onNilaiRaporSaved(response, tipeNilai, semesterId) {
    if (response.status === 'sukses') {
      setLoading(true, 'Memperbarui rekap semester...', false);
      google.script.run.withSuccessHandler(onRekapSemesterUpdated).withFailureHandler(onGagal).getNilaiRaporGridData(getToken(), semesterId);
    } else {
      setTableInputLock('halaman-input-rapor-detail', false);
      showMessage('input-rapor-message', response.message, true);
    }
  }

  function onRekapSemesterUpdated(response) {
    setTableInputLock('halaman-input-rapor-detail', false);

    if (response.status === 'sukses') {
      isFormDirty = false; 
      setIjazahDirty(true);
      
      // --- PERUBAHAN DI SINI ---
      // Ambil semesterId dari respons yang baru dimuat
      const semesterId = document.getElementById('judul-halaman-input-rapor').dataset.semesterId;
      if (semesterId) {
        // Perbarui cache untuk semester INI SAJA
        globalNilaiRaporGridCache.set(semesterId, response);
      }
      // --- AKHIR PERUBAHAN ---
      
      globalRaporData.P = response.dataP;
      globalRaporData.K = response.dataK;
      globalRaporData.Rekap = response.dataRekap;
      
      renderNilaiRaporGridTable('P');
      renderNilaiRaporGridTable('K');
      renderRekapRaporSemesterTable();
      
      console.log(`Cache dan data Rapor (${semesterId}) telah diperbarui.`);
      showMessage('input-rapor-message', 'Nilai berhasil disimpan dan rekapitulasi telah diperbarui.', false);
      
    } else {
      showMessage('input-rapor-message', 'Gagal memperbarui rekap: ' + response.message, true);
    }
  }

  // --- FUNGSI DIPERBARUI: konfirmasiBersihkanNilaiRapor (Generik) ---
  function konfirmasiBersihkanNilaiRapor(tipeNilai) {
    const tipeText = (tipeNilai === 'P') ? 'Pengetahuan' : 'Keterampilan';
    const title = `Konfirmasi Bersihkan Formulir ${tipeText}`;
    const message = `Ini akan <strong>mengosongkan semua nilai ${tipeText}</strong> yang tampil di layar. Data yang sudah tersimpan <strong>tetap aman</strong>.`;
    
    // Kita gunakan closure untuk melewatkan tipeNilai
    const callback = function() {
      bersihkanInputNilaiRapor(tipeNilai);
    };
    
    showConfirmationModal(title, message, callback, 'danger');
  }

  // --- FUNGSI DIPERBARUI: bersihkanInputNilaiRapor (Generik) ---
  function bersihkanInputNilaiRapor(tipeNilai) {
    const containerSelector = (tipeNilai === 'P') ? '#input-rapor-table-container' : '#input-rapor-keterampilan-table-container';
    const data = (tipeNilai === 'P') ? globalRaporData.P : globalRaporData.K;
    
    const inputs = document.querySelectorAll(`${containerSelector} .input-nilai`);
    const mapelCount = data.mapelList.length;
    const siswaIdsToUpdate = new Set();

    inputs.forEach(input => {
      input.value = '';
      siswaIdsToUpdate.add(input.dataset.siswaId);
    });

    isFormDirty = true; // <-- TAMBAHKAN INI

    if (mapelCount > 0) {
      siswaIdsToUpdate.forEach(siswaId => {
        updateRowTotalsRapor(siswaId, mapelCount, tipeNilai);
      });
    }
    const tipeText = (tipeNilai === 'P') ? 'Pengetahuan' : 'Keterampilan';
    showMessage('input-rapor-message', `Formulir ${tipeText} telah dibersihkan.`, false);
  }

  /**
   * VERSI REFACTOR (Cepat)
   * Merender rekap rapor per semester menggunakan DocumentFragment.
   */
  function renderRekapRaporSemesterTable() {
      const container = document.getElementById('rekap-rapor-semester-table-container');
      container.innerHTML = ""; // 1. Kosongkan

      const { siswaList, mapelList, nilaiRekapData } = globalRaporData.Rekap; 
      const selectedKelas = document.getElementById('input-rapor-filter-kelas').value;

      // 2. Logika Pengecekan Data Kosong
      if (!siswaList || siswaList.length === 0) {
          container.innerHTML = '<p style="text-align: center; padding: 20px;">Belum ada data siswa.</p>';
          return;
      }
      if (!mapelList || mapelList.length === 0) {
          container.innerHTML = '<p style="text-align: center; padding: 20px;">Belum ada data mata pelajaran.</p>';
          return;
      }

      const filteredSiswaList = (selectedKelas === 'semua')
        ? siswaList
        : siswaList.filter(siswa => siswa.kelas === selectedKelas);

      if (filteredSiswaList.length === 0) {
          container.innerHTML = '<p style="text-align: center; padding: 20px;">Tidak ada siswa di kelas yang dipilih.</p>';
          return;
      }

      // 3. Mulai Buat Tabel
      const table = document.createElement('table');
      table.className = 'input-nilai-table guru-view';

      // 4. Buat Header
      const thead = table.createTHead();
      const headerRow = thead.insertRow();
      let headerHTML = '<th>Nama Siswa</th>';
      mapelList.forEach(mapel => {
        headerHTML += `<th class="col-mapel clickable-mapel-header" data-mapel-nama="${mapel.nama}" title="Klik untuk lihat nama mapel">${mapel.id}</th>`;
      });
      headerHTML += '<th class="th-total th-total-jumlah">Jumlah</th>';
      headerHTML += '<th class="th-total th-total-rata">Rata-Rata</th>';
      headerHTML += '<th class="th-total th-total-bulat">Pembulatan</th>';
      headerRow.innerHTML = headerHTML;

      // 5. Buat Body & Fragment
      const tbody = table.createTBody();
      const fragment = document.createDocumentFragment();

      filteredSiswaList.forEach(siswa => {
          const tr = document.createElement('tr');
          
          let rowHTML = ''; // Kita akan bangun HTML untuk <tr> ini
          
          const namaProper = toProperCase(siswa.nama);
          const namaFormatted = formatNamaSiswa(namaProper);
          rowHTML += `<td><span class="clickable-nama-siswa" data-nisn="${siswa.nisn}" data-nama-lengkap="${siswa.nama}" title="Klik untuk lihat NISN">${namaFormatted}</span></td>`; 

          let sum = 0;
          let count = 0;

          mapelList.forEach(mapel => {
              const key = `${siswa.id}_${mapel.id}`;
              const nilai = nilaiRekapData[key];

              let nilaiTampil = '-';
              if (nilai !== null && nilai !== undefined) {
                  nilaiTampil = nilai; // Nilai sudah dibulatkan dari server
                  sum += parseFloat(nilai);
                  count++;
              }
              rowHTML += `<td class="col-mapel" style="text-align: center; font-weight: 500;">${nilaiTampil}</td>`;
          });

          const average = (count > 0) ? (sum / count) : 0;
          const pembulatan = Math.round(average);
          const sumTampil = parseFloat(sum.toFixed(2));

          rowHTML += `<td class="col-total col-total-jumlah">${sumTampil}</td>`;
          rowHTML += `<td class="col-total col-total-rata">${average.toFixed(2)}</td>`;
          rowHTML += `<td class="col-total col-total-bulat">${pembulatan}</td>`;

          tr.innerHTML = rowHTML;
          fragment.appendChild(tr);
      });

      // 6. Tambahkan fragment ke body
      tbody.appendChild(fragment);
      // 7. Tambahkan tabel ke container
      container.appendChild(table);
  }

  function bukaHalamanRekapRapor() {
    tampilHalaman('halaman-rekap-rapor');
    hideMessage('rekap-rapor-message');
    document.getElementById('rekap-rapor-table-container').innerHTML = '<p>Memuat data...</p>';
    document.getElementById('rekap-rapor-filter-kelas').innerHTML = '<option value="semua">-- Tampilkan Semua Kelas --</option>';
    globalRaporGridData = { siswaList: [], mapelList: [], nilaiRekapData: {} };
    setLoading(true, 'Membuat rekap...', false, false);
    google.script.run.withSuccessHandler(onRekapRaporLoaded).withFailureHandler(onGagal).getRekapitulasiNilaiRaporData(getToken());
  }

  function onRekapRaporLoaded(response) {
    setLoading(false);
    const container = document.getElementById('rekap-rapor-table-container');
    
    if (response.status !== 'sukses') {
      container.innerHTML = `<p class="message error" style="display:block;">Gagal memuat data: ${response.message}</p>`;
      globalRaporGridData = { siswaList: [], mapelList: [], nilaiRekapData: {} };
      return;
    }

    document.getElementById('judul-halaman-rekap-rapor').innerText = `Rekapitulasi Rapor (${response.data.jumlahSemester} Semester)`;

    globalRaporGridData = response.data;
    populateRekapRaporFilter(globalRaporGridData.siswaList);
    renderRekapRaporTable();
  }

  function populateRekapRaporFilter(siswaList) {
    const selectKelas = document.getElementById('rekap-rapor-filter-kelas');
    const selectedValue = selectKelas.value;
    const kelasSet = new Set(siswaList.map(siswa => siswa.kelas));
    const kelasList = Array.from(kelasSet).sort(compareKelas); // [MODIFIKASI]
    let optionsHtml = '<option value="semua">-- Tampilkan Semua Kelas --</option>';
    kelasList.forEach(kelas => {
      optionsHtml += `<option value="${kelas}">${kelas}</option>`;
    });
    selectKelas.innerHTML = optionsHtml;
    selectKelas.value = selectedValue || (kelasList.length === 1 ? kelasList[0] : 'semua');
  }

  /**
   * VERSI REFACTOR (Cepat)
   * Merender rekap rapor total menggunakan DocumentFragment.
   */
  function renderRekapRaporTable() {
      const container = document.getElementById('rekap-rapor-table-container');
      container.innerHTML = ""; // 1. Kosongkan

      const { siswaList, mapelList, nilaiRekapData } = globalRaporGridData; 
      const selectedKelas = document.getElementById('rekap-rapor-filter-kelas').value;

      // 2. Logika Pengecekan Data Kosong
      if (!siswaList || siswaList.length === 0) {
          container.innerHTML = '<p style="text-align: center; padding: 20px;">Belum ada data siswa.</p>';
          return;
      }
      if (!mapelList || mapelList.length === 0) {
          container.innerHTML = '<p style="text-align: center; padding: 20px;">Belum ada data mata pelajaran.</p>';
          return;
      }

      const filteredSiswaList = (selectedKelas === 'semua')
        ? siswaList
        : siswaList.filter(siswa => siswa.kelas === selectedKelas);

      if (filteredSiswaList.length === 0) {
          container.innerHTML = '<p style="text-align: center; padding: 20px;">Tidak ada siswa di kelas yang dipilih.</p>';
          return;
      }

      // 3. Mulai Buat Tabel
      const table = document.createElement('table');
      table.className = 'input-nilai-table';

      // 4. Buat Header
      const thead = table.createTHead();
      const headerRow = thead.insertRow();
      let headerHTML = '<th>Nama Siswa</th>';
      mapelList.forEach(mapel => {
        headerHTML += `<th class="col-mapel clickable-mapel-header" data-mapel-nama="${mapel.nama}" title="Klik untuk lihat nama mapel">${mapel.id}</th>`;
      });
      headerHTML += '<th class="th-total th-total-jumlah">Jumlah</th>';
      headerHTML += '<th class="th-total th-total-rata">Rata-Rata</th>';
      headerHTML += '<th class="th-total th-total-bulat">Pembulatan</th>';
      headerRow.innerHTML = headerHTML;
      
      // 5. Buat Body & Fragment
      const tbody = table.createTBody();
      const fragment = document.createDocumentFragment();
      
      filteredSiswaList.forEach(siswa => {
          const tr = document.createElement('tr');
          let rowHTML = '';
          
          const namaProper = toProperCase(siswa.nama);
          const namaFormatted = formatNamaSiswa(namaProper);
          rowHTML += `<td><span class="clickable-nama-siswa" data-nisn="${siswa.nisn}" data-nama-lengkap="${siswa.nama}" title="Klik untuk lihat NISN">${namaFormatted}</span></td>`; 
          
          let sum = 0;
          let count = 0;
          
          mapelList.forEach(mapel => {
              const key = `${siswa.id}_${mapel.id}`;
              const nilai = nilaiRekapData[key];
              
              let nilaiTampil = '-';
              if (nilai !== null && nilai !== undefined) {
                  if (nilai === 0) {
                    nilaiTampil = 0;
                  } else {
                    if (nilai % 1 !== 0) {
                      nilaiTampil = nilai.toFixed(2); 
                    } else {
                      nilaiTampil = nilai.toFixed(0);
                    }
                  }
                  sum += nilai;
                  count++;
              }
              rowHTML += `<td class="col-mapel" style="text-align: center; font-weight: 500;">${nilaiTampil}</td>`;
          });
          
          const average = (count > 0) ? (sum / count) : 0;
          const pembulatan = Math.round(average);
          const sumTampil = parseFloat(sum.toFixed(2));
          
          rowHTML += `<td class="col-total col-total-jumlah">${sumTampil}</td>`;
          rowHTML += `<td class="col-total col-total-rata">${average.toFixed(2)}</td>`;
          rowHTML += `<td class="col-total col-total-bulat">${pembulatan}</td>`;
          
          tr.innerHTML = rowHTML;
          fragment.appendChild(tr);
      });

      // 6. Tambahkan fragment ke body
      tbody.appendChild(fragment);
      // 7. Tambahkan tabel ke container
      container.appendChild(table);
  }

  function bukaHalamanSemester() {
    tampilHalaman('halaman-semester');
    setLoading(true, 'Memuat pengaturan semester...', false, false); // Ubah ke non-blocking
    isFormDirty = false;
    hideMessage('semester-message');
    document.getElementById('form-semester').reset();
    setFormDisabled('form-semester', true);
    document.getElementById('pilihan-semester').innerHTML = '<option value="">Memuat...</option>';

    // --- LOGIKA CACHE BARU ---
    if (globalSemesterCache && globalSemesterCache.status === 'sukses') {
        console.log("Memuat semester dari cache klien...");
        // Muat dari cache
        setTimeout(() => {
          onSemesterSettingLoaded(globalSemesterCache);
        }, 10); // Jeda singkat agar UI "Memuat..." sempat tampil
    } else {
        // Cache miss, panggil server
        console.log("Memuat semester dari server...");
        google.script.run
          .withSuccessHandler(onSemesterSettingLoaded)
          .withFailureHandler(onGagal)
          .getSemesterSetting(getToken());
    }
    // --- AKHIR LOGIKA CACHE ---
  }

  function onSemesterSettingLoaded(response) {
    setLoading(false);
    setFormDisabled('form-semester', false);
    const select = document.getElementById('pilihan-semester');
    select.innerHTML = '';
    select.disabled = false;
    document.getElementById('btn-simpan-semester').disabled = false;

    if (response.status !== 'sukses') {
      showMessage('semester-message', response.message, true);
      return;
    }

    // --- TAMBAHAN BARU: Simpan ke cache ---
    globalSemesterCache = response;
    // --- AKHIR TAMBAHAN ---

    const jenjang = response.jenjang;
    const setting = response.setting || 5;

    if (jenjang === 'SD/MI') {
      select.innerHTML = '<option value="5">5 Semester (Default)</option>';
      select.innerHTML += '<option value="3">3 Semester</option>';
    } else {
      select.innerHTML = '<option value="5">5 Semester (Otomatis)</option>';
      select.disabled = true;
      document.getElementById('btn-simpan-semester').disabled = true;
    }
    
    select.value = setting;
  }

  function simpanSemester() {
    setLoading(true, 'Menyimpan data semester...');
    hideMessage('semester-message');
    const nilaiSemester = document.getElementById('pilihan-semester').value;
    google.script.run
      .withSuccessHandler(onSemesterSettingSaved)
      .withFailureHandler(onGagal)
      .saveSemesterSetting(getToken(), nilaiSemester);
  }

  function onSemesterSettingSaved(response) {
    setLoading(false);
    if (response.status === 'sukses') {
      isFormDirty = false; 
      setIjazahDirty(true);

      // --- PERUBAHAN DI SINI (Sudah ada, hanya konfirmasi) ---
      // Mengubah setelan semester membuat semua cache rapor tidak valid
      globalNilaiRaporGridCache.clear();
      // --- AKHIR PERUBAHAN ---

      showMessage('semester-message', 'Pengaturan semester berhasil disimpan!', false);

      // --- TAMBAHAN BARU: Perbarui cache klien ---
      if (globalSemesterCache && globalSemesterCache.status === 'sukses') {
        // Perbarui nilai 'setting' di cache yang ada
        globalSemesterCache.setting = document.getElementById('pilihan-semester').value;
      } else {
        // Jika cache belum ada (seharusnya tidak terjadi, tapi untuk jaga-jaga)
        globalSemesterCache = {
          status: "sukses",
          jenjang: jenjangBaseCache, // Ambil dari cache jenjang yang sudah ada
          setting: document.getElementById('pilihan-semester').value
        };
      }
      // --- AKHIR TAMBAHAN ---

    } else {
      showMessage('semester-message', response.message, true);
    }
  }

  function forceLogout(message) {
    const authContainer = document.getElementById('auth-container');
    if (authContainer && authContainer.style.display !== 'none') return;
    if (inactivityTimer) { clearTimeout(inactivityTimer); inactivityTimer = null; }
    showToast(message || 'Sesi berakhir.', 'gagal', 6000);
    google.script.run.prosesLogout(getToken());
    localStorage.removeItem('sessionToken');
    localStorage.removeItem(LAST_PAGE_KEY);
    globalSiswaList = [];
    globalGridData = { siswaList: [], mapelList: [], nilaiData: {} };
    globalRaporData = { P: { siswaList: [], mapelList: [], nilaiData: {} }, K: { siswaList: [], mapelList: [], nilaiData: {} }, Rekap: { siswaList: [], mapelList: [], nilaiRekapData: {} } };
    jenjangBaseCache = '';
    jenjangPilihanCache = '';
    tampilHalaman('halaman-login');
    setLoading(false);
    hideToast();
  }

  // --- FUNGSI BARU UNTUK RESET TIMER ---
  function resetInactivityTimer() {
    if (inactivityTimer) {
      clearTimeout(inactivityTimer);
    }
    
    // Cek jika kita di halaman login, jangan mulai timer
    const authContainer = document.getElementById('auth-container');
    if (authContainer && authContainer.style.display !== 'none') {
        inactivityTimer = null;
        return;
    }
    
    inactivityTimer = setTimeout(() => {
      // --- PERUBAHAN DI SINI ---
      forceLogout('Anda telah otomatis logout setelah 3 jam tidak aktif.');
      // --- AKHIR PERUBAHAN ---
    }, INACTIVITY_TIMEOUT_MS);
  }

  /**
   * FUNGSI BARU
   * Mengunci atau membuka form input nilai di halaman detail.
   * Ini akan menonaktifkan input & tombol, lalu menampilkan overlay,
   * tapi membiarkan tabel tetap bisa di-scroll.
   * @param {string} pageId - ID halaman ('halaman-input-nilai-detail' or 'halaman-input-rapor-detail')
   * @param {boolean} isLocked - True untuk mengunci, false untuk membuka.
   * @param {string} [message] - Pesan loading (opsional).
   */
  function setTableInputLock(pageId, isLocked, message = 'Menyimpan...') {
    const pageElement = document.getElementById(pageId);
    if (!pageElement) return;

    let inputs;
    let buttons;

    if (pageId === 'halaman-input-nilai-detail') {
      inputs = pageElement.querySelectorAll('.input-nilai');
      buttons = [
        document.getElementById('btn-simpan-input-nilai'),
        document.getElementById('btn-bersihkan-input-nilai')
      ];
    } else if (pageId === 'halaman-input-rapor-detail') {
      inputs = pageElement.querySelectorAll('.input-nilai');
      buttons = [
        document.getElementById('btn-simpan-input-rapor-p'),
        document.getElementById('btn-bersihkan-input-rapor-p'),
        document.getElementById('btn-simpan-input-rapor-k'),
        document.getElementById('btn-bersihkan-input-rapor-k')
      ];
    } else {
      return; // Halaman tidak didukung
    }

    if (isLocked) {
      // Tampilkan toast loading, TAPI JANGAN BLOKIR UI GLOBAL
      // (parameter ketiga `false` berarti jangan pakai global blocker)
      setLoading(true, message, false); 
      
      // Tambah class ke halaman untuk memicu overlay CSS
      pageElement.classList.add('loading-in-progress');

      // Nonaktifkan semua input dan tombol
      inputs.forEach(input => input.disabled = true);
      buttons.forEach(btn => btn.disabled = true);

    } else {
      // Sembunyikan toast
      setLoading(false); 
      
      // Hapus class loading
      pageElement.classList.remove('loading-in-progress');
      
      // Aktifkan kembali input dan tombol
      inputs.forEach(input => input.disabled = false);
      
      // Hanya enable tombol yang relevan (misal, jika ada data)
      if (pageId === 'halaman-input-nilai-detail') {
        const { siswaList, mapelList } = globalGridData;
        if (siswaList && siswaList.length > 0 && mapelList && mapelList.length > 0) {
          document.getElementById('btn-simpan-input-nilai').disabled = false;
          document.getElementById('btn-bersihkan-input-nilai').disabled = false;
        }
      } else if (pageId === 'halaman-input-rapor-detail') {
        const { siswaList: siswaP, mapelList: mapelP } = globalRaporData.P;
        if (siswaP && siswaP.length > 0 && mapelP && mapelP.length > 0) {
          document.getElementById('btn-simpan-input-rapor-p').disabled = false;
          document.getElementById('btn-bersihkan-input-rapor-p').disabled = false;
        }
        const { siswaList: siswaK, mapelList: mapelK } = globalRaporData.K;
        if (siswaK && siswaK.length > 0 && mapelK && mapelK.length > 0) {
          document.getElementById('btn-simpan-input-rapor-k').disabled = false;
          document.getElementById('btn-bersihkan-input-rapor-k').disabled = false;
        }
      }
    }
  }

  // Salin dan GANTI fungsi bukaHalamanNilaiIjazah() Anda
  function bukaHalamanNilaiIjazah(isRecalculating = false) { 
      tampilHalaman('halaman-nilai-ijazah');
      hideMessage('nilai-ijazah-message');
      
      // --- PERUBAHAN DI SINI ---
      // Langsung nonaktifkan tombol saat halaman mulai dimuat
      setIjazahExportButtonsDisabled(true); 
      // --- AKHIR PERUBAHAN ---

      document.getElementById('ijazah-ujian-table-container').innerHTML = '<p>Memuat data...</p>';
      document.getElementById('ijazah-rapor-table-container').innerHTML = '<p>Memuat data...</p>';
      document.getElementById('ijazah-final-table-container').innerHTML = '<p>Memuat data...</p>';
      document.getElementById('ijazah-filter-kelas').innerHTML = '<option value="semua">-- Tampilkan Semua Kelas --</option>';
      globalIjazahData = { siswaList: [], mapelList: [], dataUjian: {}, dataRapor: {}, dataIjazah: {} };
      showWeightedUjian = true; showWeightedRapor = true;
      document.querySelector('#ijazah-tab-bar .tab-link[data-tab="ujian"]').innerText = 'Nilai Ujian (...)';
      document.querySelector('#ijazah-tab-bar .tab-link[data-tab="rapor"]').innerText = 'Nilai Rapor (...)';
      document.querySelector('#ijazah-tab-bar .tab-link[data-tab="ijazah"]').innerText = 'Nilai Ijazah (...)';
      
      if (!isRecalculating) {
        setLoading(true, 'Memuat nilai ijazah...', false, false);
      }
      
      google.script.run
        .withSuccessHandler((response) => {
            onNilaiIjazahLoaded(response, isRecalculating); 
        })
        .withFailureHandler(onGagal)
        .getNilaiIjazahData(getToken());
  }

  // Salin dan GANTI fungsi onNilaiIjazahLoaded() Anda
  function onNilaiIjazahLoaded(response, isRecalculating = false) { 
      
      setLoading(false); 
      
      if (isRecalculating && response.status === 'sukses') {
          setTimeout(() => {
            showToast("Nilai berhasil dihitung ulang dan data telah diperbarui.", 'sukses');
          }, 550); 
      }
      
      const btnToggleUjian = document.getElementById('btn-toggle-ujian-view');
      const btnToggleRapor = document.getElementById('btn-toggle-rapor-view');
      
      const exportControlsUjian = document.getElementById('export-controls-ujian');
      const exportControlsRapor = document.getElementById('export-controls-rapor');
      const exportControlsIjazah = document.getElementById('export-controls-ijazah');

      const infoUpdateEl = document.getElementById('ijazah-info-update');
      infoUpdateEl.style.display = 'none';

      if (response.status !== 'sukses') {
        document.getElementById('ijazah-ujian-table-container').innerHTML = `<p class="message error" style="display:block;">Gagal memuat data: ${response.message}</p>`;
        document.getElementById('ijazah-rapor-table-container').innerHTML = '';
        document.getElementById('ijazah-final-table-container').innerHTML = '';
        globalIjazahData = { siswaList: [], mapelList: [], dataUjian: {}, dataRapor: {}, dataIjazah: {} };
        
        // Pastikan tombol tetap nonaktif jika gagal
        setIjazahExportButtonsDisabled(true); 

        const tabUjian = document.querySelector('#ijazah-tab-bar .tab-link[data-tab="ujian"]');
        if (tabUjian) tabUjian.innerText = 'Nilai Ujian (Gagal)';
        const tabRapor = document.querySelector('#ijazah-tab-bar .tab-link[data-tab="rapor"]');
        if (tabRapor) tabRapor.innerText = 'Nilai Rapor (Gagal)';
        const tabIjazah = document.querySelector('#ijazah-tab-bar .tab-link[data-tab="ijazah"]');
        if (tabIjazah) tabIjazah.innerText = 'Nilai Ijazah (Gagal)';
        
        if (btnToggleUjian) btnToggleUjian.style.display = 'none';
        if (btnToggleRapor) btnToggleRapor.style.display = 'none';
        
        if (exportControlsUjian) exportControlsUjian.style.display = 'none';
        if (exportControlsRapor) exportControlsRapor.style.display = 'none';
        if (exportControlsIjazah) exportControlsIjazah.style.display = 'none';

        if (!isRecalculating && response.message.includes("belum pernah dikalkulasi")) {
          showToast(response.message, 'gagal');
        }
        return;
      }

      if (btnToggleUjian) {
        btnToggleUjian.style.display = 'inline-flex';
        btnToggleUjian.innerText = 'Lihat Nilai Asli';
        btnToggleUjian.classList.remove('toggled');
        document.querySelector('#tab-ujian-content .table-content-header').innerText = 'Nilai Ujian (Setelah Diberi Bobot)';
      }
      if (btnToggleRapor) {
        btnToggleRapor.style.display = 'inline-flex';
        btnToggleRapor.innerText = 'Lihat Nilai Asli';
        btnToggleRapor.classList.remove('toggled');
        document.querySelector('#tab-rapor-content .table-content-header').innerText = 'Nilai Rapor (Setelah Diberi Bobot)';
      }

      const bobotUjian = response.data.bobotUjianPct || 0;
      const bobotRapor = response.data.bobotRaporPct || 0;
      const kkmValue = response.data.kkm || 0;
      
      const tabUjian = document.querySelector('#ijazah-tab-bar .tab-link[data-tab="ujian"]');
      if (tabUjian) {
        tabUjian.innerText = `Nilai Ujian (${bobotUjian}%)`;
      }
      
      const tabRapor = document.querySelector('#ijazah-tab-bar .tab-link[data-tab="rapor"]');
      if (tabRapor) {
        tabRapor.innerText = `Nilai Rapor (${bobotRapor}%)`;
      }
      
      const tabIjazah = document.querySelector('#ijazah-tab-bar .tab-link[data-tab="ijazah"]');
      if (tabIjazah) {
        tabIjazah.innerText = `Nilai Ijazah (${kkmValue})`;
      }

      globalIjazahData = response.data;
      
      populateNilaiIjazahFilter(globalIjazahData.siswaList);

      // Render 3 tabel
      renderNilaiIjazahTabel('ujian');
      renderNilaiIjazahTabel('rapor');
      renderNilaiIjazahTabel('ijazah');
      
      // Aktifkan kembali tombol SETELAH semua tabel selesai dirender
      setIjazahExportButtonsDisabled(false);
      
      if (exportControlsUjian) exportControlsUjian.style.display = 'flex';
      if (exportControlsRapor) exportControlsRapor.style.display = 'flex';
      if (exportControlsIjazah) exportControlsIjazah.style.display = 'flex';
      
      activateIjazahTab('ujian');
  }

  function populateNilaiIjazahFilter(siswaList) {
    const selectKelas = document.getElementById('ijazah-filter-kelas');
    const selectedValue = selectKelas.value;
  
    const kelasSet = new Set(siswaList.map(siswa => siswa.kelas));
    const kelasList = Array.from(kelasSet).sort(compareKelas); // [MODIFIKASI]
  
    let optionsHtml = '<option value="semua">-- Tampilkan Semua Kelas --</option>';
    kelasList.forEach(kelas => {
      optionsHtml += `<option value="${kelas}">${kelas}</option>`;
    });
  
    selectKelas.innerHTML = optionsHtml;
    selectKelas.value = selectedValue || (kelasList.length === 1 ? kelasList[0] : 'semua');
  }

  function activateIjazahTab(tabName) {
    const page = document.getElementById('halaman-nilai-ijazah');

    const tabClasses = ['tab-ujian-active', 'tab-rapor-active', 'tab-ijazah-active'];
    let newActiveClass = '';

    page.querySelectorAll('.tab-link').forEach(link => {
      link.classList.remove('active');
    });

    page.querySelectorAll('.tab-content').forEach(content => {
      content.classList.remove('active');
    });

    page.querySelector(`.tab-link[data-tab="${tabName}"]`).classList.add('active');
    page.querySelector(`#tab-${tabName}-content`).classList.add('active');
    
    if (tabName === 'ujian') {
      newActiveClass = 'tab-ujian-active';
    } else if (tabName === 'rapor') {
      newActiveClass = 'tab-rapor-active';
    } else if (tabName === 'ijazah') {
      newActiveClass = 'tab-ijazah-active';
    }
    
    page.classList.remove(...tabClasses);
    if (newActiveClass) {
      page.classList.add(newActiveClass);
    }
  }

  /**
   * VERSI REFACTOR (Cepat)
   * Merender tabel nilai ijazah (ujian, rapor, final) menggunakan DocumentFragment.
   */
  function renderNilaiIjazahTabel(tipeTabel) {
      let container;
      let nilaiDataMap;
      let showStatusColumn = false;
      let useOriginal = false;

      if (tipeTabel === 'ujian') {
        container = document.getElementById('ijazah-ujian-table-container');
        useOriginal = !showWeightedUjian;
        nilaiDataMap = useOriginal ? globalIjazahData.dataUjianOriginal : globalIjazahData.dataUjian;
      } else if (tipeTabel === 'rapor') {
        container = document.getElementById('ijazah-rapor-table-container');
        useOriginal = !showWeightedRapor;
        nilaiDataMap = useOriginal ? globalIjazahData.dataRaporOriginal : globalIjazahData.dataRapor;
      } else {
        container = document.getElementById('ijazah-final-table-container');
        nilaiDataMap = globalIjazahData.dataIjazah;
        showStatusColumn = true; 
      }
      
      container.innerHTML = ""; // 1. Kosongkan

      const { siswaList, mapelList, kkm } = globalIjazahData; 
      const kkmValue = kkm || 76; 
      const selectedKelas = document.getElementById('ijazah-filter-kelas').value;
      
      // 2. Logika Pengecekan Data Kosong
      if (!siswaList || siswaList.length === 0) {
        container.innerHTML = '<p style="text-align: center; padding: 20px;">Belum ada data siswa.</p>';
        return;
      }
      if (!mapelList || mapelList.length === 0) {
        container.innerHTML = `<p style="text-align: center; padding: 20px;">Belum ada mapel yang diatur untuk Ijazah.</p>`;
        return;
      }

      const filteredSiswaList = (selectedKelas === 'semua')
        ? siswaList
        : siswaList.filter(siswa => siswa.kelas === selectedKelas);

      if (filteredSiswaList.length === 0) {
          container.innerHTML = '<p style="text-align: center; padding: 20px;">Tidak ada siswa di kelas yang dipilih.</p>';
          return;
      }

      // 3. Mulai Buat Tabel
      const table = document.createElement('table');
      table.className = 'input-nilai-table guru-view';

      // 4. Buat Header
      const thead = table.createTHead();
      const headerRow = thead.insertRow();
      let headerHTML = '<th>Nama Siswa</th>';
      mapelList.forEach(mapel => {
        headerHTML += `<th class="col-mapel clickable-mapel-header" data-mapel-nama="${mapel.nama}" title="Klik untuk lihat nama mapel">${mapel.id}</th>`;
      });
      headerHTML += '<th class="th-total th-total-jumlah">Jumlah</th>';
      headerHTML += '<th class="th-total th-total-rata">Rata-Rata</th>';
      if (showStatusColumn) { 
        headerHTML += '<th class="th-total th-total-bulat">Status</th>'; 
      }
      headerRow.innerHTML = headerHTML;

      // 5. Buat Body & Fragment
      const tbody = table.createTBody();
      const fragment = document.createDocumentFragment();

      filteredSiswaList.forEach(siswa => {
          const tr = document.createElement('tr');
          let rowHTML = '';
          
          const namaProper = toProperCase(siswa.nama);
          const namaFormatted = formatNamaSiswa(namaProper);
          rowHTML += `<td><span class="clickable-nama-siswa" data-nisn="${siswa.nisn}" data-nama-lengkap="${siswa.nama}" title="Klik untuk lihat NISN">${namaFormatted}</span></td>`; 
          
          let sum = 0;
          let count = 0;
          
          mapelList.forEach(mapel => {
              const key = `${siswa.id}_${mapel.id}`;
              const nilai = nilaiDataMap[key];
              
              let nilaiTampil = '-';
              if (nilai !== null && nilai !== undefined) {
                  const nilaiAngka = parseFloat(nilai);
                  
                  if (tipeTabel === 'ijazah' || useOriginal) {
                    nilaiTampil = Math.round(nilaiAngka);
                    sum += nilaiTampil;
                  } else {
                    nilaiTampil = nilaiAngka.toFixed(2);
                    sum += nilaiAngka;
                  }
                  count++;
              }
              rowHTML += `<td class="col-mapel" style="text-align: center; font-weight: 500;">${nilaiTampil}</td>`;
          });
          
          const average = (count > 0) ? (sum / count) : 0;
          
          if (tipeTabel === 'ijazah' || useOriginal) {
            rowHTML += `<td class="col-total col-total-jumlah">${Math.round(sum)}</td>`;
          } else {
            rowHTML += `<td class="col-total col-total-jumlah">${sum.toFixed(2)}</td>`;
          }

          rowHTML += `<td class="col-total col-total-rata">${average.toFixed(2)}</td>`;
          
          if (showStatusColumn) { 
              let statusText = '';
              let statusClass = '';
              const nilaiAkhirIjazah = (count > 0) ? (sum / count) : 0;
              
              if (nilaiAkhirIjazah >= kkmValue) {
                  statusText = 'LULUS';
                  statusClass = 'status-lulus';
              } else {
                  statusText = 'TIDAK LULUS';
                  statusClass = 'status-tidak-lulus';
              }
              rowHTML += `<td class="col-total col-total-bulat ${statusClass}">${statusText}</td>`; 
          }
          
          tr.innerHTML = rowHTML;
          fragment.appendChild(tr);
      });

      // 6. Tambahkan fragment ke body
      tbody.appendChild(fragment);
      // 7. Tambahkan tabel ke container
      container.appendChild(table);
  }

  // Salin dan GANTI fungsi toggleUjianView() Anda
  function toggleUjianView() {
    showWeightedUjian = !showWeightedUjian;
    const btn = document.getElementById('btn-toggle-ujian-view');
    const header = document.querySelector('#tab-ujian-content .table-content-header');
    
    if (showWeightedUjian) {
      btn.innerText = 'Lihat Nilai Asli';
      btn.classList.remove('toggled');
      document.querySelector('#tab-ujian-content .table-content-header').innerText = 'Nilai Ujian (Setelah Diberi Bobot)';
    } else {
      btn.innerText = 'Lihat Nilai Bobot';
      btn.classList.add('toggled');
      header.innerText = 'Nilai Ujian (Asli/Sebelum Bobot)';
    }
    
    setIjazahExportButtonsDisabled(true);
    setTimeout(() => {
      renderNilaiIjazahTabel('ujian');
      
      // ===== MODIFIKASI DI BAWAH INI =====
      // Cek apakah tombol hitung ulang SEDANG loading
      const btnRecalc = document.getElementById('btn-recalculate-ijazah');
      if (!btnRecalc || !btnRecalc.classList.contains('loading')) {
        // Hanya aktifkan jika TIDAK sedang kalkulasi ulang
        setIjazahExportButtonsDisabled(false);
      }
      // Jika sedang loading, biarkan tombol tetap nonaktif
      // ===== AKHIR MODIFIKASI =====
      
    }, 10);
  }

  // Salin dan GANTI fungsi toggleRaporView() Anda
  function toggleRaporView() {
    showWeightedRapor = !showWeightedRapor;
    const btn = document.getElementById('btn-toggle-rapor-view');
    const header = document.querySelector('#tab-rapor-content .table-content-header');
    
    if (showWeightedRapor) {
      btn.innerText = 'Lihat Nilai Asli';
      btn.classList.remove('toggled');
      header.innerText = 'Nilai Rapor (Setelah Diberi Bobot)';
    } else {
      btn.innerText = 'Lihat Nilai Bobot';
      btn.classList.add('toggled');
      header.innerText = 'Nilai Rapor (Asli/Sebelum Bobot)';
    }
    
    setIjazahExportButtonsDisabled(true);
    setTimeout(() => {
      renderNilaiIjazahTabel('rapor');
      
      // ===== MODIFIKASI DI BAWAH INI =====
      // Cek apakah tombol hitung ulang SEDANG loading
      const btnRecalc = document.getElementById('btn-recalculate-ijazah');
      if (!btnRecalc || !btnRecalc.classList.contains('loading')) {
        // Hanya aktifkan jika TIDAK sedang kalkulasi ulang
        setIjazahExportButtonsDisabled(false);
      }
      // Jika sedang loading, biarkan tombol tetap nonaktif
      // ===== AKHIR MODIFIKASI =====
      
    }, 10);
  }

  function setMapelOrderDirty(isDirty) {
    isMapelOrderDirty = isDirty;
    updateMapelFloatingActions();
  }

  function onMapelUrutanSaved(response) {
    setLoading(false);
    if (response.status === 'sukses') {
      globalMapelList.forEach(m => {
        m.originalUrutan = m.urutan;
      });
      setMapelOrderDirty(false); 
      isFormDirty = false; 
      showMessage('mapel-message', 'Urutan mapel berhasil disimpan!', false);
    } else {
      showMessage('mapel-message', response.message, true);
    }
  }

  function checkMapelDirtyState() {
    if (!globalMapelList) return;

    let orderIsDirty = false;
    let tipeIsDirty = false;

    const currentTipeState = new Map();
    document.querySelectorAll('#mapel-table-container .mapel-tipe-cek').forEach(cb => {
      const id = cb.dataset.id;
      const tipe = cb.dataset.tipe;
      if (!currentTipeState.has(id)) {
        currentTipeState.set(id, { isUS: false, isUP: false });
      }
      if (tipe === 'us') currentTipeState.get(id).isUS = cb.checked;
      if (tipe === 'up') currentTipeState.get(id).isUP = cb.checked;
    });

    for (const mapel of globalMapelList) {
      if (mapel.urutan != mapel.originalUrutan) {
        orderIsDirty = true;
      }
      
      const currentTipes = currentTipeState.get(mapel.id);
      if (currentTipes) {
        if (currentTipes.isUS != mapel.originalIsUS || currentTipes.isUP != mapel.originalIsUP) {
          tipeIsDirty = true;
        }
      }

      if (orderIsDirty && tipeIsDirty) break;
    }
    
    setMapelOrderDirty(orderIsDirty);
    setMapelTipeDirty(tipeIsDirty);
    
    if (orderIsDirty || tipeIsDirty) {
      isFormDirty = true;
    }
  }

  function updateMapelFloatingActions() {
    const container = document.getElementById('mapel-floating-actions');
    const tableContainer = document.getElementById('mapel-table-container');
    if (!container || !tableContainer) return;
    
    const btnUrutan = document.getElementById('btn-simpan-urutan-mapel');
    const btnTipe = document.getElementById('btn-simpan-tipe-ujian');
    
    btnUrutan.disabled = !isMapelOrderDirty;
    btnTipe.disabled = !isMapelTipeDirty;
    
    if (isMapelOrderDirty || isMapelTipeDirty) {
      container.classList.add('show-actions');
      tableContainer.classList.add('table-container-with-actions');
    } else {
      container.classList.remove('show-actions');
      tableContainer.classList.remove('table-container-with-actions');
    }
  }

  function cancelMapelChanges() {
    if (!globalMapelList) return;

    globalMapelList.forEach(m => {
      m.urutan = m.originalUrutan;
      m.isUS = m.originalIsUS;
      m.isUP = m.originalIsUP;
    });
    
    globalMapelList.sort((a,b) => a.urutan - b.urutan);
    
    onMapelLoaded({ status: "sukses", mapel: globalMapelList, isReRender: true });
    
    setMapelOrderDirty(false);
    setMapelTipeDirty(false);
    isFormDirty = false; 
    
    showMessage('mapel-message', 'Perubahan dibatalkan.', false);
  }

  function checkSiswaDirtyState() {
    if (!globalSiswaList) return;

    let orderIsDirty = false;
    for (const siswa of globalSiswaList) {
      if (siswa.urutan != siswa.originalUrutan) {
        orderIsDirty = true;
        break;
      }
    }
    
    setSiswaOrderDirty(orderIsDirty);
    if (orderIsDirty) {
      isFormDirty = true;
    }
  }

  function updateSiswaFloatingActions() {
    const container = document.getElementById('siswa-floating-actions');
    const tableContainer = document.getElementById('siswa-table-container');
    if (!container || !tableContainer) return;
    
    const btnUrutan = document.getElementById('btn-simpan-urutan-siswa');
    
    btnUrutan.disabled = !isSiswaOrderDirty;
    
    if (isSiswaOrderDirty) {
      container.classList.add('show-actions');
      tableContainer.classList.add('table-container-with-actions');
    } else {
      container.classList.remove('show-actions');
      tableContainer.classList.remove('table-container-with-actions');
    }
  }

  function cancelSiswaChanges() {
    if (!globalSiswaList) return;

    globalSiswaList.forEach(s => {
      s.urutan = s.originalUrutan;
    });
    
    setSiswaOrderDirty(false);
    isFormDirty = false; 
    
    applySiswaFiltersAndRender();
    
    showMessage('siswa-message', 'Urutan siswa dikembalikan.', false);
  }

  function setExportButtonsLoading(isLoading, button) {
    const allExportButtons = document.querySelectorAll('#halaman-nilai-ijazah .btn-export-icon');
    
    if (isLoading && button) {
      allExportButtons.forEach(btn => {
        if (btn !== button) {
          btn.disabled = true;
          btn.style.opacity = '0.5';
        }
      });
      setButtonLoading(button, '');
      button.style.width = '40px'; 
    } else {
      allExportButtons.forEach(btn => {
        btn.disabled = false;
        btn.style.opacity = '1';
        if (btn.classList.contains('loading')) {
          resetButtonLoading(btn);
        }
      });
    }
  }

  // Salin dan GANTI fungsi handleExportClick() Anda dengan yang ini
  function handleExportClick(button, tipeFile, tipeData) {
    if (button.disabled) return;
    
    // 1. Tentukan pesan loading dinamis
    let loadingMessage = 'Membuat file ekspor, harap tunggu...'; // Default
    if (tipeFile === 'pdf') {
      loadingMessage = 'Membuat file ekspor PDF, harap tunggu...';
    } else if (tipeFile === 'excel') {
      loadingMessage = 'Membuat file ekspor Excel, harap tunggu...';
    }

    // 2. Tampilkan toast spinner "Proses..." dengan pesan dinamis
    setLoading(true, loadingMessage, false, true); 
    
    // 3. Tampilkan spinner di tombol yang diklik (logika Anda yang sudah ada)
    setExportButtonsLoading(true, button); 
    
    // 4. Persiapkan data dan panggil server
    const kelasFilter = document.getElementById('ijazah-filter-kelas').value;
    let isWeighted = true;
    if (tipeData === 'ujian') isWeighted = showWeightedUjian;
    else if (tipeData === 'rapor') isWeighted = showWeightedRapor;
    
    // --- PERUBAHAN DI SINI ---
    google.script.run
      .withSuccessHandler((response) => {
          // Teruskan 'response' DAN 'tipeFile' ke callback
          onDataExported(response, tipeFile); 
      }) 
      .withFailureHandler(onGagalExport) 
      .exportDataIjazah(getToken(), tipeFile, tipeData, kelasFilter, isWeighted);
    // --- AKHIR PERUBAHAN ---
  }

  // Salin dan GANTI fungsi onDataExported() Anda dengan yang ini
  function onDataExported(response, tipeFile) { // <-- 1. TAMBAHKAN PARAMETER 'tipeFile'
    // 1. Sembunyikan toast "Proses..."
    setLoading(false);
    
    // 2. Kembalikan tombol ke status normal
    setExportButtonsLoading(false, null); 

    if (response.status === 'sukses') {
      
      // --- PERUBAHAN DI SINI ---
      // 3. Tentukan pesan sukses dinamis
      let successMessage = 'File ekspor berhasil dibuat. Mengunduh...'; // Default
      if (tipeFile === 'pdf') {
        successMessage = 'File PDF berhasil dibuat. Mengunduh...';
      } else if (tipeFile === 'excel') {
        successMessage = 'File Excel berhasil dibuat. Mengunduh...';
      }
      // --- AKHIR PERUBAHAN ---

      // 4. Tampilkan toast "Sukses" SETELAH jeda 550md
      setTimeout(() => {
        showToast(successMessage, 'sukses'); // <-- Gunakan pesan dinamis
        try {
          const dataUrl = `data:${response.mimeType};base64,${response.base64}`;
          
          const link = document.createElement('a');
          link.setAttribute('href', dataUrl);
          link.setAttribute('download', response.fileName);
          link.style.visibility = 'hidden';
          document.body.appendChild(link);
          
          link.click();
          
          document.body.removeChild(link);

        } catch (e) {
          // Tampilkan toast error baru jika unduhan gagal
          showToast('Gagal memproses unduhan: ' + e.message, 'gagal');
        }
      }, 550); // 550ms jeda

    } else {
      // 4B. Jika GAGAL, tampilkan toast "Gagal" SETELAH jeda
      setTimeout(() => {
        showToast('Gagal membuat file ekspor: ' + response.message, 'gagal');
      }, 550); // 550ms jeda
    }
  }

  function onGagalExport(error) {
    setExportButtonsLoading(false, null);
    onGagal(error);
  }

  // Salin dan ganti fungsi onUpdateSemuaDataSukses() Anda dengan yang ini
  function onUpdateSemuaDataSukses(response) {
      setLoading(false);
      if (response.status === 'sukses') {
          showToast('Semua data berhasil diperbarui dari server.', 'sukses');
          
          // --- AWAL PERBAIKAN: Bersihkan SEMUA cache klien ---
          console.log("Membersihkan cache sisi klien...");
          globalSiswaList = [];
          globalGridData = { siswaList: [], mapelList: [], nilaiData: {} };
          globalRaporData = { P: { siswaList: [], mapelList: [], nilaiData: {} }, K: { siswaList: [], mapelList: [], nilaiData: {} }, Rekap: { siswaList: [], mapelList: [], nilaiRekapData: {} } };
          jenjangBaseCache = '';
          jenjangPilihanCache = '';
          // (currentUserRole tidak perlu di-reset, user masih login)

          // Variabel yang hilang sebelumnya, sekarang ditambahkan:
          globalDataSekolahCache = null;
          globalBobotCache = null;
          globalKelasListCache = [];
          globalMapelList = [];
          globalGuruList = [];
          globalSemesterCache = null;
          globalTaList = [];
          globalNilaiGridCacheUM = null;
          globalNilaiGridCachePraktek = null;
          globalNilaiRaporGridCache.clear();
          globalIjazahData = { siswaList: [], mapelList: [], dataUjian: {}, dataRapor: {}, dataIjazah: {} };
          globalPengaturanCetakCache = null;
          globalPenempatanData = { siswaData: [], mapelList: [], guruList: [], mapelAssignments: [] };
          // --- AKHIR PERBAIKAN ---
          
          // Muat ulang data di halaman saat ini (logika asli Anda)
          const currentPage = localStorage.getItem(LAST_PAGE_KEY) || 'halaman-utama';
          if (currentPage !== 'halaman-utama') {
              bukaHalamanTersimpan('halaman-utama'); 
              setTimeout(() => {
                  bukaHalamanTersimpan(currentPage); // Ini sekarang akan memicu 'cache miss'
              }, 100);
          } else {
             // Jika sedang di halaman utama, refresh saja dashboard
             tampilHalaman('halaman-utama');
          }
      } else {
          showToast('Gagal memperbarui data: ' + response.message, 'gagal');
      }
  }

  // Salin dan GANTI fungsi jalankanRekalkulasiIjazah() Anda
  function jalankanRekalkulasiIjazah() {
      const btn = document.getElementById('btn-recalculate-ijazah');
      setButtonLoading(btn, 'Menghitung...');
      
      // --- PERUBAHAN DI SINI ---
      // 1. Nonaktifkan tombol ekspor SEGERA
      setIjazahExportButtonsDisabled(true); 
      // --- AKHIR PERUBAHAN ---
      
      setLoading(true, "Proses sedang menghitung ulang, silahkan tunggu...", false, true);
      
      setTimeout(() => {
        google.script.run
          .withSuccessHandler(onRekalkulasiIjazahSukses)
          .withFailureHandler(onGagalRekalkulasiIjazah) // Pastikan memanggil handler gagal yang spesifik
          .recalculateIjazahData(getToken());
      }, 50); 
  }

  // Salin dan GANTI fungsi onRekalkulasiIjazahSukses() Anda
  function onRekalkulasiIjazahSukses(response) {
      const btn = document.getElementById('btn-recalculate-ijazah');
      resetButtonLoading(btn); // Kembalikan tombol hitung ulang

      if (response.status === 'sukses') {
        setIjazahDirty(response.isDirty); 
        
        // Panggil bukaHalamanNilaiIjazah.
        // Fungsi ini sudah kita atur untuk MENJAGA tombol ekspor
        // tetap nonaktif sampai onNilaiIjazahLoaded selesai.
        bukaHalamanNilaiIjazah(true); 

      } else {
        // Kalkulasi di server GAGAL (tapi koneksi tidak putus)
        setLoading(false); 
        if (response.isDirty) {
          setIjazahDirty(response.isDirty); 
        }
        showToast('Gagal menghitung: ' + response.message, 'gagal');
        
        // --- PERUBAHAN DI SINI ---
        // Aktifkan kembali tombol ekspor karena proses gagal dan halaman tidak di-reload
        setIjazahExportButtonsDisabled(false);
        // --- AKHIR PERUBAHAN ---
      }
  }

  // Salin dan GANTI fungsi onGagalRekalkulasiIjazah() Anda
  function onGagalRekalkulasiIjazah(error) {
    const btn = document.getElementById('btn-recalculate-ijazah');
    resetButtonLoading(btn);
    
    // --- PERUBAHAN DI SINI ---
    // Aktifkan kembali tombol ekspor jika terjadi kegagalan fatal
    setIjazahExportButtonsDisabled(false);
    // --- AKHIR PERUBAHAN ---
    
    onGagal(error); // Panggil handler onGagal utama
  }

  /**
   * Menandai bahwa data sumber ijazah telah berubah (dirty).
   * @param {boolean} isDirty 
   */
  function setIjazahDirty(isDirty) {
    if (isDirty) {
      localStorage.setItem('ijazahDataIsDirty', 'true');
      console.log('Ijazah data flagged as DIRTY.');
    } else {
      localStorage.removeItem('ijazahDataIsDirty');
      console.log('Ijazah data flagged as CLEAN.');
    }
    updateRecalculateButtonState();
  }

  /**
   * Memperbarui tampilan visual tombol DAN TEKS berdasarkan status 'dirty'.
   */
  function updateRecalculateButtonState() {
    const isDirty = localStorage.getItem('ijazahDataIsDirty') === 'true';
    
    const btnRecalcDashboard = document.getElementById('btn-buka-nilai-ijazah');
    const btnRecalcPage = document.getElementById('btn-recalculate-ijazah');
    const textReminder = document.getElementById('btn-recalculate-ijazah-text');
    
    if (isDirty) {
      if (btnRecalcDashboard) btnRecalcDashboard.classList.add('btn-dirty-state');
      if (btnRecalcPage) btnRecalcPage.classList.add('btn-dirty-state');
      
      // Tampilkan teks pengingat
      if (textReminder) {
        textReminder.style.display = 'inline-block';
      }
    } else {
      if (btnRecalcDashboard) btnRecalcDashboard.classList.remove('btn-dirty-state');
      if (btnRecalcPage) btnRecalcPage.classList.remove('btn-dirty-state');

      // Sembunyikan teks pengingat
      if (textReminder) {
        textReminder.style.display = 'none';
      }
    }
  }

  /**
   * Helper untuk memeriksa 'isFormDirty' sebelum pindah halaman.
   * @param {function} targetPageFunction Fungsi yang akan dijalankan jika bersih (misal: bukaHalamanInputUjian)
   */
  function handleNavigationConfirm(targetPageFunction) {
    
    // --- [PERBAIKAN BARU] Simpan posisi scroll jika kita ada di dasbor ---
    const currentPageId = localStorage.getItem(LAST_PAGE_KEY) || 'halaman-utama';
    if (currentPageId === 'halaman-utama') {
      // Kita akan meninggalkan 'halaman-utama', simpan posisinya.
      lastDashboardScrollPosition = window.scrollY;
    }
    // --- [AKHIR PERBAIKAN BARU] ---

    if (isFormDirty) {
      const callback = function() {
        isFormDirty = false; // Reset flag
        targetPageFunction(); // Lanjutkan navigasi
      };
      showConfirmationModal(
        "Perubahan Belum Disimpan", 
        "Anda memiliki <strong>perubahan nilai yang belum disimpan</strong> di halaman ini. Jika Anda pindah halaman, perubahan tersebut akan hilang.<br><br>Yakin ingin tetap pindah?",
        callback, 
        'danger' 
      );
    } else {
      targetPageFunction(); // Langsung navigasi jika form bersih
    }
  }

  let globalValidationDataSiswa = {
    siswaList: [],
    requiredSemesters: [],
    validationData: {}
  };

  // TAMBAHKAN GLOBAL BARU
  let globalValidationDataMapel = {
    mapelList: [],
    siswaList: [],
    requiredSemesters: [],
    validationData: {}
  };

  // ===== MODIFIKASI DI BAWAH INI (NAMA FUNGSI DIUBAH) =====
  function bukaHalamanValidasi() {
    tampilHalaman('halaman-validasi-nilai');
    hideMessage('validasi-message');
    
    // Reset kedua kontainer
    document.getElementById('validasi-nilai-table-container').innerHTML = '<p>Memeriksa kelengkapan per siswa...</p>';
    document.getElementById('validasi-mapel-table-container').innerHTML = '<p>Memeriksa kelengkapan per mapel...</p>';
    
    // Reset filter
    document.getElementById('validasi-filter-kelas').innerHTML = '<option value="semua">-- Tampilkan Semua Kelas --</option>';
    
    // Reset data global
    globalValidationDataSiswa = { siswaList: [], requiredSemesters: [], validationData: {} };
    globalValidationDataMapel = { mapelList: [], siswaList: [], requiredSemesters: [], validationData: {} };

    // Aktifkan tab default
    activateValidasiTab('siswa');
    
    setLoading(true, 'Memvalidasi data...', false, false);

    // Panggil fungsi data siswa (fungsi lama yang di-rename)
    google.script.run
      .withSuccessHandler(onValidasiSiswaDataLoaded) // <-- Handler baru
      .withFailureHandler(onGagal) // <-- Handler onGagal biasa
      .getValidationDataBySiswa(getToken()); // <-- Fungsi server baru

    // Panggil fungsi data mapel (fungsi baru)
    google.script.run
      .withSuccessHandler(onValidasiMapelDataLoaded) // <-- Handler baru
      .withFailureHandler(onGagal) // <-- Handler onGagal biasa
      .getValidationDataByMapel(getToken()); // <-- Fungsi server baru
  }

  // NAMA FUNGSI DIUBAH (DARI onValidasiDataLoaded)
  function onValidasiSiswaDataLoaded(response) {
    // Hanya matikan loading jika KEDUA panggilan selesai
    // (Panggilan kedua akan mematikan spinner)
    
    const container = document.getElementById('validasi-nilai-table-container');
    
    if (response.status !== 'sukses') {
      container.innerHTML = `<p class="message error" style="display:block;">Gagal memuat data validasi siswa: ${response.message}</p>`;
      globalValidationDataSiswa = { siswaList: [], requiredSemesters: [], validationData: {} };
      setLoading(false); // Matikan paksa jika error
      return;
    }

    globalValidationDataSiswa = response.data;
    populateValidasiSiswaFilter(globalValidationDataSiswa.siswaList);
    renderValidasiTableBySiswa();
    
    // Cek apakah panggilan lain sudah selesai (ditandai dgn dimuatnya mapelList)
    if (globalValidationDataMapel.mapelList.length > 0 || globalValidationDataMapel.siswaList.length > 0) {
        setLoading(false);
    }
  }

  // TAMBAHKAN FUNGSI BARU INI
  function onValidasiMapelDataLoaded(response) {
    setLoading(false); // Panggilan kedua selalu mematikan loading
    const container = document.getElementById('validasi-mapel-table-container');

    if (response.status !== 'sukses') {
      container.innerHTML = `<p class="message error" style="display:block;">Gagal memuat data validasi mapel: ${response.message}</p>`;
      globalValidationDataMapel = { mapelList: [], siswaList: [], requiredSemesters: [], validationData: {} };
      return;
    }

    globalValidationDataMapel = response.data;
    // Saat ini, renderValidasiTableByMapel masih placeholder
    renderValidasiTableByMapel();
  }

  // NAMA FUNGSI DIUBAH (DARI populateValidasiFilter)
  function populateValidasiSiswaFilter(siswaList) {
    const selectKelas = document.getElementById('validasi-filter-kelas');
    const selectedValue = selectKelas.value;
  
    const kelasSet = new Set(siswaList.map(siswa => siswa.kelas));
    const kelasList = Array.from(kelasSet).sort(compareKelas); // [MODIFIKASI]
  
    let optionsHtml = '<option value="semua">-- Tampilkan Semua Kelas --</option>';
    kelasList.forEach(kelas => {
      optionsHtml += `<option value="${kelas}">${kelas}</option>`;
    });
  
    selectKelas.innerHTML = optionsHtml;
    selectKelas.value = selectedValue || (kelasList.length === 1 ? kelasList[0] : 'semua');
  }

  // TAMBAHKAN FUNGSI BARU INI
  function activateValidasiTab(tabName) {
    const page = document.getElementById('halaman-validasi-nilai');
    
    const tabClasses = ['tab-siswa-active', 'tab-mapel-active'];
    let newActiveClass = '';

    page.querySelectorAll('.tab-link').forEach(link => {
      link.classList.remove('active');
    });

    page.querySelectorAll('.tab-content').forEach(content => {
      content.classList.remove('active');
    });

    page.querySelector(`.tab-link[data-tab="${tabName}"]`).classList.add('active');
    page.querySelector(`#tab-validasi-${tabName}-content`).classList.add('active');
    
    // Tampilkan/Sembunyikan filter bar
    const filterBar = document.querySelector('#halaman-validasi-nilai .filter-bar');
    if (tabName === 'siswa') {
      newActiveClass = 'tab-siswa-active';
      filterBar.style.display = 'flex';
    } else if (tabName === 'mapel') {
      newActiveClass = 'tab-mapel-active';
      filterBar.style.display = 'none'; // Sembunyikan filter untuk tab mapel
    }
    
    page.classList.remove(...tabClasses);
    if (newActiveClass) {
      page.classList.add(newActiveClass);
    }
  }

  // NAMA FUNGSI DIUBAH (DARI renderValidasiTable)
  function renderValidasiTableBySiswa() {
      const container = document.getElementById('validasi-nilai-table-container');
      container.innerHTML = ""; // 1. Kosongkan

      const { siswaList, validationData, requiredSemesters } = globalValidationDataSiswa; // <-- Ganti global var
      const selectedKelas = document.getElementById('validasi-filter-kelas').value;

      // 2. Logika Pengecekan Data Kosong
      if (!siswaList || siswaList.length === 0) {
          container.innerHTML = '<p style="text-align: center; padding: 20px;">Belum ada data siswa.</p>';
          return;
      }

      const filteredSiswaList = (selectedKelas === 'semua')
        ? siswaList
        : siswaList.filter(siswa => siswa.kelas === selectedKelas);

      if (filteredSiswaList.length === 0) {
          container.innerHTML = '<p style="text-align: center; padding: 20px;">Tidak ada siswa di kelas yang dipilih.</p>';
          return;
      }
      
      const firstSiswaValidasi = validationData[filteredSiswaList[0].id];
      if (!firstSiswaValidasi) {
        container.innerHTML = '<p style="text-align: center; padding: 20px;">Data validasi tidak ditemukan untuk siswa.</p>';
        return;
      }

      // 3. Mulai Buat Tabel
      const table = document.createElement('table');
      table.className = 'input-nilai-table';

      // 4. Buat Header
      const thead = table.createTHead();
      const headerRow = thead.insertRow();
      
      const hasUM = firstSiswaValidasi.ujian.hasOwnProperty('UM');
      const hasUP = firstSiswaValidasi.ujian.hasOwnProperty('UP');
      const jenjangPilihan = jenjangPilihanCache;
      const labelUjian = (jenjangPilihan === 'MI' || jenjangPilihan === 'MTS' || jenjangPilihan === 'MA') ? 'UM' : 'US';
      const namaUjianLengkap = (labelUjian === 'UM') ? 'Ujian Madrasah' : 'Ujian Sekolah';

      let headerHTML = '<th>Nama Siswa</th><th>Kelas</th>';
      if (hasUM) {
        headerHTML += `<th class="col-validasi-header col-validasi-ujian clickable-mapel-header" data-mapel-nama="${namaUjianLengkap}" title="Klik untuk lihat nama mapel">${labelUjian}</th>`;
      }
      if (hasUP) {
        headerHTML += `<th class="col-validasi-header col-validasi-ujian clickable-mapel-header" data-mapel-nama="Ujian Praktek" title="Klik untuk lihat nama mapel">UP</th>`;
      }
      requiredSemesters.forEach(semester => {
        const shortCodeP = `${semester.shortCode}.P`;
        const fullNameP = `${semester.nama} (Pengetahuan)`;
        const shortCodeK = `${semester.shortCode}.K`;
        const fullNameK = `${semester.nama} (Keterampilan)`;
        headerHTML += `<th class="col-validasi-header col-validasi-rapor clickable-mapel-header" data-mapel-nama="${fullNameP}" title="Klik untuk lihat nama mapel">${shortCodeP}</th>`;
        headerHTML += `<th class="col-validasi-header col-validasi-rapor clickable-mapel-header" data-mapel-nama="${fullNameK}" title="Klik untuk lihat nama mapel">${shortCodeK}</th>`;
      });
      headerRow.innerHTML = headerHTML;

      // 5. Buat Body & Fragment
      const tbody = table.createTBody();
      const fragment = document.createDocumentFragment();
      
      const okIcon = '<span class="validasi-icon validasi-ok"><i class="fas fa-check-circle"></i></span>';
      const noIcon = '<span class="validasi-icon validasi-no"><i class="fas fa-times-circle"></i></span>';

      filteredSiswaList.forEach(siswa => {
          const tr = document.createElement('tr');
          let rowHTML = '';
          
          const namaProper = toProperCase(siswa.nama);
          const namaFormatted = formatNamaSiswa(namaProper);
          rowHTML += `
            <td>
              <span 
                class="clickable-nama-siswa" 
                data-nisn="${siswa.nisn}" 
                data-nama-lengkap="${siswa.nama}"
                title="Klik untuk lihat NISN"
              >
                ${namaFormatted}
              </span>
            </td>`;
          rowHTML += `<td>${siswa.kelas}</td>`;

          const validasi = validationData[siswa.id] || { rapor: {}, ujian: {} };

          if (hasUM) {
            rowHTML += `<td>${validasi.ujian.UM ? okIcon : noIcon}</td>`;
          }
          if (hasUP) {
            rowHTML += `<td>${validasi.ujian.UP ? okIcon : noIcon}</td>`;
          }
          requiredSemesters.forEach(semester => {
            const semId = semester.id;
            rowHTML += `<td>${validasi.rapor[semId + "_P"] ? okIcon : noIcon}</td>`;
            rowHTML += `<td>${validasi.rapor[semId + "_K"] ? okIcon : noIcon}</td>`;
          });
          
          tr.innerHTML = rowHTML;
          fragment.appendChild(tr);
      });

      // 6. Tambahkan fragment ke body
      tbody.appendChild(fragment);
      // 7. Tambahkan tabel ke container
      container.appendChild(table);
  }

  /**
   * [BARU - DIAKTIFKAN v2] Merender tabel validasi per mapel (Agregat).
   */
  function renderValidasiTableByMapel() {
    const container = document.getElementById('validasi-mapel-table-container');
    container.innerHTML = ""; // 1. Kosongkan

    // Ambil data dari global baru
    const { mapelList, siswaList, validationData, requiredSemesters } = globalValidationDataMapel;
    
    // 2. Cek data kosong
    if (!mapelList || mapelList.length === 0) {
        container.innerHTML = '<p style="text-align: center; padding: 20px;">Belum ada data mapel wajib (US/UP).</p>';
        return;
    }
    const totalSiswa = (siswaList && siswaList.length > 0) ? siswaList.length : 0;
    if (totalSiswa === 0) {
        container.innerHTML = '<p style="text-align: center; padding: 20px;">Belum ada data siswa.</p>';
        return;
    }

    // 3. Ikon (Definisi ulang)
    const okIcon = '<span class="validasi-icon validasi-ok"><i class="fas fa-check-circle"></i></span>';
    const noIcon = '<span class="validasi-icon validasi-no"><i class="fas fa-times-circle"></i></span>';
    const dashIcon = '<span class="validasi-icon validasi-na">-</span>'; // Untuk N/A

    // 4. Buat Tabel
    const table = document.createElement('table');
    table.className = 'input-nilai-table'; // Pakai style tabel yang sudah ada

    // 5. Buat Header (Kolom adalah Tipe Nilai, sama seperti tab per-siswa)
    const thead = table.createTHead();
    const headerRow = thead.insertRow();
    
    let headerHTML = '<th>Mata Pelajaran</th>';
    
    const globalNeedsUM = mapelList.some(m => m.isUS);
    const globalNeedsUP = mapelList.some(m => m.isUP);
    const jenjangPilihan = jenjangPilihanCache;
    const labelUjian = (jenjangPilihan === 'MI' || jenjangPilihan === 'MTS' || jenjangPilihan === 'MA') ? 'UM' : 'US';
    const namaUjianLengkap = (labelUjian === 'UM') ? 'Ujian Madrasah' : 'Ujian Sekolah';

    // Buat array header komponen untuk iterasi di body
    const componentHeaders = [];

    if (globalNeedsUM) {
      headerHTML += `<th class="col-validasi-header col-validasi-ujian clickable-mapel-header" data-mapel-nama="${namaUjianLengkap}" title="Klik untuk lihat nama mapel">${labelUjian}</th>`;
      componentHeaders.push({ id: 'UM', isRequiredField: 'isUS' });
    }
    if (globalNeedsUP) {
      headerHTML += `<th class="col-validasi-header col-validasi-ujian clickable-mapel-header" data-mapel-nama="Ujian Praktek" title="Klik untuk lihat nama mapel">UP</th>`;
      componentHeaders.push({ id: 'UP', isRequiredField: 'isUP' });
    }
    requiredSemesters.forEach(semester => {
      const shortCodeP = `${semester.shortCode}.P`;
      const fullNameP = `${semester.nama} (Pengetahuan)`;
      const shortCodeK = `${semester.shortCode}.K`;
      const fullNameK = `${semester.nama} (Keterampilan)`;
      headerHTML += `<th class="col-validasi-header col-validasi-rapor clickable-mapel-header" data-mapel-nama="${fullNameP}" title="Klik untuk lihat nama mapel">${shortCodeP}</th>`;
      headerHTML += `<th class="col-validasi-header col-validasi-rapor clickable-mapel-header" data-mapel-nama="${fullNameK}" title="Klik untuk lihat nama mapel">${shortCodeK}</th>`;
      componentHeaders.push({ id: `${semester.id}_P`, isRequiredField: true }); // Rapor P selalu wajib
      componentHeaders.push({ id: `${semester.id}_K`, isRequiredField: true }); // Rapor K selalu wajib
    });
    headerRow.innerHTML = headerHTML;

    // 6. Buat Body (Baris adalah Mapel)
    const tbody = table.createTBody();
    const fragment = document.createDocumentFragment();

    mapelList.forEach(mapel => {
      const tr = document.createElement('tr');
      
      // Kolom 1: Nama Mapel (Sticky)
      let rowHTML = `
        <td>
          <span
            class="clickable-mapel-header" 
            data-mapel-nama="${mapel.nama}" 
            title="Klik untuk lihat nama mapel"
          >
            <strong>${mapel.id}</strong>
          </span>
        </td>`;
      
      const agg = validationData[mapel.id];
      if (!agg) {
          tr.innerHTML = rowHTML + `<td colspan="100" style="text-align:center;">Error data</td>`;
          fragment.appendChild(tr);
          return; // Lanjut ke mapel berikutnya
      }

      // Helper untuk membuat sel
      const createCell = (count, isRequired, componentId) => {
        if (!isRequired) return `<td>${dashIcon}</td>`;
        
        const isComplete = (count === totalSiswa);
        const text = `${count}/${totalSiswa}`;
        const icon = isComplete ? okIcon : noIcon;
        
        // [MODIFIKASI] Tambahkan data-mapel-id dan data-component-id
        return `<td class="clickable-validasi-mapel" 
                    data-mapel-id="${mapel.id}" 
                    data-component-id="${componentId}" 
                    style="text-align: center;">
                      ${icon} <span style="margin-left: 5px;">${text}</span>
                </td>`;
      };
      
      // Loop menggunakan componentHeaders array
      componentHeaders.forEach(comp => {
        let count = 0;
        let isRequired = comp.isRequiredField === true; // true untuk Rapor
        
        if (comp.id === 'UM' || comp.id === 'UP') {
          isRequired = mapel[comp.isRequiredField]; // Cek isUS atau isUP
          if (agg.ujian[comp.id] !== undefined) {
            count = agg.ujian[comp.id];
          }
        } else {
          // Ini adalah Rapor (misal: K4_S1_P)
          if (agg.rapor[comp.id] !== undefined) {
            count = agg.rapor[comp.id];
          }
        }
        
        rowHTML += createCell(count, isRequired, comp.id);
      });
      
      tr.innerHTML = rowHTML;
      fragment.appendChild(tr);
    }); // Akhir loop mapel

    // 7. Selesaikan tabel
    tbody.appendChild(fragment);
    table.appendChild(thead);
    table.appendChild(tbody);
    container.appendChild(table);
  }

  /**
   * [BARU] Menampilkan modal tooltip dengan daftar siswa yang belum lengkap.
   */
  function showMissingStudentsTooltip(targetCell, mapelId, componentId) {
    // 1. Ambil data mentah (raw maps) dari cache
    const { siswaList, rawUjianMap, rawRaporMap, requiredSemesters } = globalValidationDataSiswa;
    
    // 2. Cari nama mapel dan nama komponen (Logika ini tidak berubah)
    const mapel = globalValidationDataMapel.mapelList.find(m => m.id === mapelId);
    const mapelName = mapel ? mapel.nama : mapelId;
    let componentName = componentId;
    
    if (componentId === 'UM') {
      const labelUjian = (jenjangPilihanCache === 'MI' || jenjangPilihanCache === 'MTS' || jenjangPilihanCache === 'MA') ? 'Ujian Madrasah' : 'Ujian Sekolah';
      componentName = labelUjian;
    } else if (componentId === 'UP') {
      componentName = 'Ujian Praktek';
    } else {
      const sem = requiredSemesters.find(s => componentId.startsWith(s.id));
      if (sem) {
        componentName = componentId.endsWith("_P") ? `${sem.nama} (Pengetahuan)` : `${sem.nama} (Keterampilan)`;
      }
    }

    // 3. Filter siswa (Logika ini DIPERBARUI)
    const missingStudents = [];
    const completeStudents = [];

    siswaList.forEach(siswa => {
      const siswaId = siswa.id;
      let isComplete = false;

      // --- Logika Baru: Periksa data mentah ---
      if (componentId === 'UM') {
        // Cek rawUjianMap[siswaId][mapelId] -> .UM
        isComplete = rawUjianMap?.[siswaId]?.[mapelId]?.UM || false;
      } else if (componentId === 'UP') {
        // Cek rawUjianMap[siswaId][mapelId] -> .UP
        isComplete = rawUjianMap?.[siswaId]?.[mapelId]?.UP || false;
      } else {
        // Ini adalah rapor, cth: "K4_S1_P"
        const semId = componentId.substring(0, 5); // "K4_S1"
        const tipe = componentId.substring(6); // "P" or "K"

        if (tipe === 'P') {
          isComplete = rawRaporMap?.[siswaId]?.[mapelId]?.[semId]?.P || false;
        } else if (tipe === 'K') {
          isComplete = rawRaporMap?.[siswaId]?.[mapelId]?.[semId]?.K || false;
        }
      }
      // --- Akhir Logika Baru ---
      
      if (isComplete) {
        completeStudents.push(siswa.nama);
      } else {
        missingStudents.push(siswa.nama);
      }
    });

    // 4. Buat judul dan pesan (Logika ini sudah benar sesuai permintaan Anda)
    let title = '';
    let message = '';
    
    if (missingStudents.length > 0) {
      // KASUS: BELUM LENGKAP
      title = `Siswa Belum Lengkap: ${mapelName} (${componentName})`;
      message = `<p>Ditemukan <strong>${missingStudents.length} siswa</strong> yang belum memiliki nilai untuk komponen ini:</p>`;
      message += '<ul style="max-height: 200px; overflow-y: auto; background: #f9f9f9; padding: 10px 10px 10px 30px; border-radius: 4px;">';
      missingStudents.sort().forEach(nama => {
        message += `<li>${nama}</li>`;
      });
      message += '</ul>';
    } else {
      // KASUS: SUDAH LENGKAP
      title = `Data Lengkap: ${mapelName} (${componentName})`;
      message = `<p>Semua <strong>${completeStudents.length} siswa</strong> telah memiliki nilai untuk komponen ini.</p>`;
    }
    
    // 5. Tampilkan modal info (Logika ini tidak berubah)
    const modal = document.getElementById('info-modal');
    document.getElementById('info-modal-title').innerText = title;
    document.getElementById('info-modal-body').innerHTML = message;
    document.getElementById('info-modal-body').classList.remove('error');
    
    modal.onOk = null;
    modal.classList.add('show');
  }

  function forceLogoutInstan() {
    setLoading(false); 
    localStorage.removeItem('sessionToken');
    localStorage.removeItem(LAST_PAGE_KEY);

    if (inactivityTimer) {
      clearTimeout(inactivityTimer);
      inactivityTimer = null;
    }
    
    // --- AWAL PERBAIKAN: Bersihkan SEMUA cache klien ---
    globalSiswaList = [];
    globalGridData = { siswaList: [], mapelList: [], nilaiData: {} };
    globalRaporData = { P: { siswaList: [], mapelList: [], nilaiData: {} }, K: { siswaList: [], mapelList: [], nilaiData: {} }, Rekap: { siswaList: [], mapelList: [], nilaiRekapData: {} } };
    jenjangBaseCache = '';
    jenjangPilihanCache = '';
    currentUserRole = '';

    // Variabel yang hilang (yang menyebabkan bug)
    globalDataSekolahCache = null;
    globalBobotCache = null;
    globalKelasListCache = [];
    globalMapelList = [];
    globalGuruList = [];
    globalSemesterCache = null;
    globalTaList = [];
    globalNilaiGridCacheUM = null;
    globalNilaiGridCachePraktek = null;
    globalNilaiRaporGridCache.clear(); // Ini adalah Map, gunakan .clear()
    globalIjazahData = { siswaList: [], mapelList: [], dataUjian: {}, dataRapor: {}, dataIjazah: {} };
    globalPengaturanCetakCache = null;
    globalPenempatanData = { siswaData: [], mapelList: [], guruList: [], mapelAssignments: [] };
    // --- AKHIR PERBAIKAN ---

    
    document.getElementById('halaman-hasil-siswa').style.display = 'none';

    // --- [Sisa kode reset UI di bawah ini tidak berubah] ---
    const pSubjudul = document.querySelector('#halaman-utama h2#salam-sekolah + p');
    if (pSubjudul) {
      pSubjudul.style.marginBottom = '';
    }

    const menuAdminIds = [
      'btn-buka-data-sekolah', 'btn-buka-siswa', 'btn-buka-mapel', 
      'btn-buka-bobot', 'btn-buka-kelas', 'btn-buka-semester',
      'btn-buka-input-rapor', 'btn-buka-validasi-nilai', 
      'btn-buka-nilai-ijazah', 'btn-buka-kelola-kelulusan',
      'btn-update-semua-data', 'btn-buka-guru',
      'btn-buka-penempatan', 'btn-buka-tahun-ajaran', 'btn-buka-proses-kelulusan', 'btn-buka-pengaturan-cetak', 'btn-buka-donasi'
    ];
    
    menuAdminIds.forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        // Reset kartu dashboard (termasuk yang premium)
        const card = el.closest('.dashboard-card');
        if (card) {
          card.style.display = 'flex';
          card.classList.remove('card-disabled');
          const stamp = card.querySelector('.premium-stamp');
          if(stamp) stamp.style.display = 'none';
        } else {
          el.style.display = 'flex';
        }
      }
    });

    document.querySelectorAll('.dashboard-section-header, .dashboard-divider, .dashboard-section-header-flex').forEach(el => {
       if (el.classList.contains('dashboard-section-header-flex')) {
         el.style.display = 'flex';
       } else {
         el.style.display = 'block';
       }
    });

    const guruMenu = document.getElementById('guru-menu-container');
    const inputUjianCard = document.getElementById('btn-buka-input-ujian')?.closest('.dashboard-card');
    
    if (guruMenu && inputUjianCard) {
      const h3InputNilai = Array.from(document.querySelectorAll('#halaman-utama h3.dashboard-section-header')).find(h => h.innerText.trim() === 'Input Nilai');
      if (h3InputNilai) {
        const originalParent = h3InputNilai.nextElementSibling;
        if (originalParent && originalParent.classList.contains('dashboard-grid-input')) {
          originalParent.prepend(inputUjianCard);
        }
      }
      guruMenu.remove();
    }
    
    if (inputUjianCard) {
      inputUjianCard.style.display = 'flex';
    }

    tampilHalaman('halaman-login');
  }

  // Di dalam client.html
  function bukaHalamanSuperadmin() {
    tampilHalaman('halaman-superadmin');
    setLoading(true, 'Memuat daftar sekolah...', false, false);
    document.getElementById('superadmin-sekolah-list').innerHTML = "<p>Memuat...</p>";
    
    // --- TAMBAHKAN BLOK INI ---
    document.getElementById('superadmin-donasi-list').innerHTML = "<p>Memuat...</p>";
    google.script.run
      .withSuccessHandler(renderDonasiList)
      .withFailureHandler(onGagal)
      .getDonasiList(getToken());
    // --- AKHIR TAMBAHAN ---
      
    google.script.run.withSuccessHandler(onSekolahListLoaded).withFailureHandler(onGagal).getSekolahList(getToken());
  }

  /**
   * [SUPERADMIN] Callback setelah data sekolah diterima.
   */
  function onSekolahListLoaded(response) {
    setLoading(false);
    if (response.status === 'sukses') {
      renderSekolahTable(response.sekolah);
    } else {
      document.getElementById('superadmin-sekolah-list').innerHTML = `<p class="message error" style="display:block;">Gagal memuat: ${response.message}</p>`;
    }
  }

  /**
   * [SUPERADMIN] Merender tabel daftar sekolah.
   */
  function renderSekolahTable(sekolahList) {
    const container = document.getElementById('superadmin-sekolah-list');
    let html = '<table class="superadmin-table">';
    html += '<thead><tr><th>Nama Sekolah</th><th>Jenjang</th><th>Email Admin</th><th>Aksi</th></tr></thead>';
    html += '<tbody>';

    if (sekolahList.length === 0) {
      html += '<tr><td colspan="4" style="text-align: center;">Belum ada sekolah terdaftar.</td></tr>';
    }

    sekolahList.forEach(sekolah => {
      // --- TAMBAHAN BLOK KONDISIONAL ---
      let tombolDonasiHtml = '';
      if (sekolah.donasiStatus === "APPROVED") {
        tombolDonasiHtml = `
          <button class="btn-aksi btn-batalkan-premium"
            data-id="${sekolah.id}" 
            data-nama="${sekolah.nama}"
          ><i class="fas fa-ban"></i>Batalkan</button>
        `;
      }
      // --- AKHIR BLOK KONDISIONAL ---

      html += `
        <tr>
          <td>${sekolah.nama}</td>
          <td>${sekolah.jenjang}</td>
          <td>${sekolah.email}</td>
          <td>
            <div class="btn-grup-aksi-sa">
              ${tombolDonasiHtml} <button class="btn-aksi btn-aksi-sukses btn-impersonate-sekolah"
                data-id="${sekolah.id}" 
                data-nama="${sekolah.nama}"
              ><i class="fas fa-sign-in-alt"></i>Masuk</button>
              
              <button class="btn-aksi btn-edit btn-edit-sekolah"
                data-id="${sekolah.id}" 
                data-nama="${sekolah.nama}" 
                data-jenjang="${sekolah.jenjang}" 
                data-email="${sekolah.email}"
                data-ssid="${sekolah.spreadsheetId}"
              ><i class="fas fa-pencil-alt"></i>Edit</button>
              
              <button class="btn-aksi btn-delete btn-delete-sekolah" 
                data-id="${sekolah.id}" 
                data-nama="${sekolah.nama}"
                data-ssid="${sekolah.spreadsheetId}"
              ><i class="fas fa-trash-alt"></i>Hapus</button>
            </div>
          </td>
        </tr>
      `;
    });

    html += '</tbody></table>';
    container.innerHTML = html;
  }

  /**
   * [SUPERADMIN] Menampilkan modal untuk tambah/edit sekolah.
   * FUNGSI DIPERBAIKI: Menggunakan ID form untuk reset dan memperbaiki bug label.
   */
  function showModalSekolah(mode, data) {
    hideMessage('modal-sekolah-error');
    
    const form = document.getElementById('modal-sekolah-form');
    if (form) {
      form.reset(); // Ini akan membersihkan semua input di dalamnya
    } else {
      // Fallback jika form masih belum ada (seharusnya tidak terjadi setelah fix HTML)
      console.error("Form 'modal-sekolah-form' tidak ditemukan!");
      // Kosongkan manual
      document.getElementById('modal-sekolah-nama').value = "";
      document.getElementById('modal-sekolah-jenjang').value = "";
      document.getElementById('modal-sekolah-email').value = "";
      document.getElementById('modal-sekolah-password').value = "";
    }

    document.getElementById('modal-sekolah-mode').value = mode;
    const passInput = document.getElementById('modal-sekolah-password');
    // Cara yang lebih aman untuk menemukan label
    const passLabel = document.querySelector('label[for="modal-sekolah-password"]'); 

    if (mode === 'add') {
      document.getElementById('modal-sekolah-title').innerText = "Tambah Sekolah Baru";
      document.getElementById('modal-sekolah-id').value = "";
      document.getElementById('modal-sekolah-ss-id').value = "";
      
      if(passLabel) passLabel.innerText = "Password Admin (Wajib)";
      passInput.placeholder = "Masukkan password baru";

    } else if (mode === 'edit') {
      document.getElementById('modal-sekolah-title').innerText = "Edit Data Sekolah";
      document.getElementById('modal-sekolah-id').value = data.id;
      document.getElementById('modal-sekolah-ss-id').value = data.spreadsheetId;
      document.getElementById('modal-sekolah-nama').value = data.nama;
      document.getElementById('modal-sekolah-jenjang').value = data.jenjang;
      document.getElementById('modal-sekolah-email').value = data.email;
      
      if(passLabel) passLabel.innerText = "Password Admin (Opsional)";
      passInput.placeholder = "Kosongkan jika tidak berubah";
    }

    document.getElementById('superadmin-sekolah-modal').classList.add('show');
  }

  /**
   * [SUPERADMIN] Menutup modal sekolah.
   */
  function tutupModalSekolah() {
    document.getElementById('superadmin-sekolah-modal').classList.remove('show');
    hideMessage('modal-sekolah-error');
  }

  function simpanSekolah() {
    setButtonLoading(document.getElementById('btn-simpan-sekolah'), 'Menyimpan...');
    hideMessage('modal-sekolah-error');
    const mode = document.getElementById('modal-sekolah-mode').value;
    const dataSekolah = {
      id: document.getElementById('modal-sekolah-id').value,
      nama: document.getElementById('modal-sekolah-nama').value.trim(),
      jenjang: document.getElementById('modal-sekolah-jenjang').value,
      email: document.getElementById('modal-sekolah-email').value.trim(),
      password: document.getElementById('modal-sekolah-password').value
    };
    if (!dataSekolah.nama || !dataSekolah.jenjang || !dataSekolah.email) {
      resetButtonLoading(document.getElementById('btn-simpan-sekolah'));
      showMessage('modal-sekolah-error', 'Data wajib diisi.', true); return;
    }
    if (mode === 'add' && !dataSekolah.password) {
      resetButtonLoading(document.getElementById('btn-simpan-sekolah'));
      showMessage('modal-sekolah-error', 'Password wajib untuk baru.', true); return;
    }
    google.script.run.withSuccessHandler(onSekolahSaved).withFailureHandler(onGagal).superadminSaveSekolah(getToken(), dataSekolah);
  }

  /**
   * [SUPERADMIN] Callback setelah sekolah disimpan.
   */
  function onSekolahSaved(response) {
    resetButtonLoading(document.getElementById('btn-simpan-sekolah'));
    if (response.status === 'sukses') {
      tutupModalSekolah();
      showMessage('superadmin-message', response.message, false);
      bukaHalamanSuperadmin(); // Muat ulang daftar
    } else {
      showMessage('modal-sekolah-error', response.message, true);
    }
  }

  /**
   * [SUPERADMIN] Menampilkan konfirmasi hapus sekolah.
   */
  function konfirmasiHapusSekolah(id, nama, ssid) {
    const title = "Konfirmasi Hapus Sekolah";
    const message = `Anda yakin ingin menghapus sekolah: <strong>${nama}</strong>?
                   <br><br>
                   <strong>PERINGATAN BESAR:</strong> Tindakan ini akan 
                   <strong>MENGHAPUS PERMANEN</strong> akun admin sekolah DAN 
                   <strong>SEMUA DATA SPREADSHEET</strong> (data siswa, nilai, dll) 
                   milik sekolah tersebut.
                   <br><br>
                   Tindakan ini tidak bisa dibatalkan.`;
    
    const callback = function() {
      hapusSekolah(id, ssid);
    };
    
    showConfirmationModal(title, message, callback, 'danger');
  }

  function hapusSekolah(id, ssid) {
    setLoading(true, 'Menghapus sekolah...');
    google.script.run.withSuccessHandler(onSekolahDihapus).withFailureHandler(onGagal).superadminDeleteSekolah(getToken(), id, ssid);
  }

  /**
   * [SUPERADMIN] Callback setelah sekolah dihapus.
   */
  function onSekolahDihapus(response) {
    setLoading(false);
    if (response.status === 'sukses') {
      showMessage('superadmin-message', response.message, false);
      bukaHalamanSuperadmin(); // Muat ulang daftar
    } else {
      showMessage('superadmin-message', response.message, true);
    }
  }

  // --- TAMBAHAN FUNGSI BARU ---
  /**
   * Handler BARU khusus untuk kegagalan checkToken.
   * Ini memperbaiki bug "Memverifikasi sesi..." yang macet.
   */
  function onTokenCheckFailed(error) {
    // 1. Matikan loader
    setLoading(false); 
    
    // 2. Bersihkan session di client
    localStorage.removeItem('sessionToken');
    localStorage.removeItem(LAST_PAGE_KEY);
    
    // 3. Tampilkan halaman login
    tampilHalaman('halaman-login');
    
    // 4. Tampilkan pesan error
    const errorMsg = error.message || 'Sesi tidak valid atau telah berakhir. Silakan login ulang.';
    showMessage('login-error', errorMsg, true);
  }
  // --- AKHIR FUNGSI BARU ---

  /**
   * [SUPERADMIN] Menampilkan konfirmasi sebelum login sebagai sekolah.
   */
  function konfirmasiImpersonate(id, nama) {
    const title = "Konfirmasi Masuk Sebagai";
    const message = `Anda akan masuk sebagai Admin <strong>${nama}</strong>. 
                   <br><br>
                   Sesi Superadmin Anda saat ini akan berakhir. Anda dapat logout dari akun sekolah untuk kembali ke Superadmin.`;
    
    const callback = function() {
      impersonateSekolah(id, nama);
    };
    
    // Tombol OK dibuat 'primary' (biru) bukan 'danger' (merah)
    showConfirmationModal(title, message, callback, 'primary'); 
  }

  function impersonateSekolah(id, nama) {
    setLoading(true, `Masuk sebagai ${nama}...`);
    // Token dikirim pertama, ID kedua (Sesuai Kode.gs yang saya output terakhir)
    google.script.run.withSuccessHandler(hasilLogin).withFailureHandler(onGagal).superadminImpersonate(id, getToken());
  }

  /**
   * [SUPERADMIN] Callback setelah berhasil kembali ke sesi Superadmin.
   */
  function onReturnToSuperadmin(response) {
    setLoading(false);
    if (response.status === 'sukses') {
      // Sembunyikan tombol kembali
      isImpersonatingCache = false;
      document.getElementById('btn-kembali-ke-superadmin').style.display = 'none';

      // 'response' berisi payload Superadmin
      document.getElementById('salam-superadmin').innerText = `Selamat Datang, ${response.namaSekolah}`;
      tampilHalaman('halaman-superadmin');
      bukaHalamanSuperadmin(); // Muat ulang data sekolah
    } else {
      // Gagal kembali, mungkin paksa logout
      onGagal(response);
    }
  }

  /**
   * [ADMIN] Helper baru untuk memeriksa ke server apakah data ijazah
   * benar-benar 'dirty' (berbeda dari cache).
   */
  function updateIjazahDirtyStatusFromServer() {
    console.log("Memeriksa status dirty Ijazah ke server...");
    
    // Panggil API baru di server
    google.script.run
      .withSuccessHandler((response) => {
        if (response.status === 'sukses') {
          console.log("Server merespons. isDirty:", response.isDirty);
          setIjazahDirty(response.isDirty); // Terapkan status dari server
        } else {
          // Jika gagal, anggap saja dirty
          console.warn("Gagal memeriksa status dirty, anggap dirty.");
          updateIjazahDirtyStatusFromServer();
        }
      })
      .withFailureHandler((error) => {
        // Jika gagal, anggap saja dirty
        console.error("Error saat memeriksa status dirty:", error.message);
        setIjazahDirty(true);
      })
      .getIjazahDirtyState();
  }

  /**
   * FUNGSI BARU YANG HILANG (PENTING)
   * Menandai bahwa data sumber ijazah telah berubah (dirty).
   * @param {boolean} isDirty 
   */
  function setIjazahDirty(isDirty) {
    if (isDirty) {
      localStorage.setItem('ijazahDataIsDirty', 'true');
      console.log('Ijazah data flagged as DIRTY.');
    } else {
      localStorage.removeItem('ijazahDataIsDirty');
      console.log('Ijazah data flagged as CLEAN.');
    }
    // Panggil fungsi yang sudah ada di client.html untuk update UI
    updateRecalculateButtonState(); 
  }

  /**
   * [PERBAIKAN] Helper untuk memvalidasi satu aturan password dan mengelola transisi UI.
   * SEKARANG MENGEMBALIKAN STATUS (true/false)
   */
  function checkPasswordRule(ruleId, isMet) {
    const li = document.getElementById(ruleId);
    if (!li) return false; // Kembalikan false jika elemen tidak ada

    if (isMet) {
      // Aturan terpenuhi
      if (!li.classList.contains('valid')) {
        // Ini adalah PERTAMA KALI aturan terpenuhi
        li.classList.add('valid');
        
        // Hapus timer lama JIKA ADA (seharusnya tidak ada, tapi untuk jaga-jaga)
        if (li.timeoutId) {
          clearTimeout(li.timeoutId);
        }
        
        // Atur timer baru untuk menyembunyikan
        li.timeoutId = setTimeout(() => {
          li.classList.add('hide');
        }, 1500); // Sembunyikan setelah 1.5 detik
      }
      return true; // Aturan terpenuhi
      
    } else {
      // Aturan TIDAK terpenuhi (misal: backspace)
      
      // 1. Hapus timer sembunyi jika ada
      if (li.timeoutId) {
        clearTimeout(li.timeoutId);
        li.timeoutId = null;
      }
      
      // 2. Tampilkan kembali aturannya (hapus .valid dan .hide)
      li.classList.remove('valid', 'hide');
      return false; // Aturan tidak terpenuhi
    }
  }

  /**
   * [PERBAIKAN] Fungsi utama untuk memvalidasi password di sisi klien.
   * Sekarang juga menyembunyikan seluruh tooltip jika semua valid.
   */
  function validatePasswordTooltip() {
    const password = document.getElementById('reg-password').value;
    const tooltipContainer = document.getElementById('reg-password-tooltip');
    if (!tooltipContainer) return;

    // Jalankan validasi untuk setiap aturan dan simpan hasilnya
    const isLengthValid = checkPasswordRule('pass-length', password.length >= 8);
    const isLowerValid = checkPasswordRule('pass-lower', /[a-z]/.test(password));
    const isUpperValid = checkPasswordRule('pass-upper', /[A-Z]/.test(password));
    const isNumberValid = checkPasswordRule('pass-number', /\d/.test(password));
    const isSymbolValid = checkPasswordRule('pass-symbol', /[^a-zA-Z0-9]/.test(password));

    // Cek apakah SEMUA aturan valid
    const allValid = isLengthValid && isLowerValid && isUpperValid && isNumberValid && isSymbolValid;

    if (allValid) {
      // Jika semua valid, tambahkan kelas 'all-valid' untuk menyembunyikan container
      tooltipContainer.classList.add('all-valid');
    } else {
      // Jika ada satu saja yang tidak valid, pastikan container terlihat
      tooltipContainer.classList.remove('all-valid');
    }
  }

  /**
   * [BARU] Fungsi untuk memvalidasi kecocokan password konfirmasi.
   */
  function validatePasswordMatch() {
    const passInput = document.getElementById('reg-password');
    const confirmInput = document.getElementById('reg-password-confirm');
    const tooltip = document.getElementById('reg-password-confirm-tooltip');

    if (!passInput || !confirmInput || !tooltip) return;

    const password = passInput.value;
    const confirmPassword = confirmInput.value;

    // Tampilkan tooltip HANYA jika confirm box tidak kosong DAN tidak cocok
    if (confirmPassword.length > 0 && password !== confirmPassword) {
      tooltip.classList.add('show');
    } else {
      tooltip.classList.remove('show');
    }
  }

  /**
   * [BARU] Fungsi untuk memvalidasi format NISN (10 digit angka).
   * @returns {boolean} - true jika valid (atau kosong), false jika format salah.
   */
  function validateNisnFormat() {
    const input = document.getElementById('modal-siswa-nisn');
    const tooltip = document.getElementById('modal-nisn-tooltip');
    const ruleLi = document.getElementById('nisn-rules');
    if (!input || !tooltip || !ruleLi) return true; // Anggap valid jika elemen hilang

    const value = input.value.trim();

    // 1. Jika kosong, sembunyikan & valid (biarkan simpanSiswa yg menangani required)
    if (value.length === 0) {
      tooltip.classList.remove('show');
      input.classList.remove('input-error');
      return true;
    }

    // 2. Cek apakah hanya angka
    if (!/^\d+$/.test(value)) {
      ruleLi.innerText = 'NISN harus berupa angka.';
      tooltip.classList.add('show');
      input.classList.add('input-error');
      return false;
    }
    
    // 3. Cek panjang
    if (value.length !== 10) {
      ruleLi.innerText = 'NISN harus terdiri dari 10 digit angka.';
      tooltip.classList.add('show');
      input.classList.add('input-error');
      return false;
    }

    // 4. Lolos semua
    tooltip.classList.remove('show');
    input.classList.remove('input-error');
    return true;
  }

  /**
   * [BARU] Fungsi untuk memvalidasi format NIS Lokal (6 digit angka).
   * @returns {boolean} - true jika valid (atau kosong), false jika format salah.
   */
  function validateNisLokalFormat() {
    const input = document.getElementById('modal-siswa-nis-lokal');
    const tooltip = document.getElementById('modal-nis-lokal-tooltip');
    const ruleLi = document.getElementById('nis-lokal-rules');
    if (!input || !tooltip || !ruleLi) return true; // Anggap valid jika elemen hilang

    const value = input.value.trim();

    // 1. Jika kosong, sembunyikan & valid (karena opsional)
    if (value.length === 0) {
      tooltip.classList.remove('show');
      input.classList.remove('input-error');
      return true;
    }

    // 2. Cek apakah hanya angka
    if (!/^\d+$/.test(value)) {
      ruleLi.innerText = 'NIS Lokal harus berupa angka.';
      tooltip.classList.add('show');
      input.classList.add('input-error');
      return false;
    }
    
    // 3. Cek panjang
    if (value.length !== 6) {
      ruleLi.innerText = 'NIS Lokal harus terdiri dari 6 digit angka.';
      tooltip.classList.add('show');
      input.classList.add('input-error');
      return false;
    }

    // 4. Lolos semua
    tooltip.classList.remove('show');
    input.classList.remove('input-error');
    return true;
  }

  /**
   * [BARU] Fungsi untuk memvalidasi format email.
   * @returns {boolean} - true jika valid, false jika tidak.
   */
  function validateEmailFormat() {
    const emailInput = document.getElementById('reg-email');
    const tooltip = document.getElementById('reg-email-tooltip');
    if (!emailInput || !tooltip) return true; // Anggap valid jika elemen tidak ada

    const email = emailInput.value.trim();
    
    // Regex standar untuk format email
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    
    if (email.length > 0 && !emailRegex.test(email)) {
      // Jika tidak kosong DAN formatnya salah
      tooltip.classList.add('show');
      return false;
    } else {
      // Jika kosong ATAU formatnya benar
      tooltip.classList.remove('show');
      return true;
    }
  }

  let globalCountdownTimer = null;

  function activateAuthTab(tabName) {
    const container = document.getElementById('auth-container');

    // --- TAMBAHAN BARU ---
    // Selalu reset teks tab admin setiap kali berpindah tab
    const adminTab = document.getElementById('tab-btn-admin');
    if (adminTab) {
      adminTab.innerText = 'Login Admin';
    }
    // --- AKHIR TAMBAHAN ---

    container.querySelectorAll('.tab-link').forEach(link => link.classList.remove('active'));
    container.querySelectorAll('.auth-tab-content').forEach(content => {
      content.style.display = 'none';
      content.classList.remove('active');
    });
    const regPage = document.getElementById('halaman-registrasi');
    if (regPage) regPage.style.display = 'none';
    
    container.querySelector(`.tab-link[data-tab="${tabName}"]`).classList.add('active');
    const contentToShow = container.querySelector(`.auth-tab-content[data-content="${tabName}"]`);
    if (contentToShow) {
        contentToShow.style.display = 'block';
        contentToShow.classList.add('active');
    }
    hideMessage('login-error');
    hideMessage('login-siswa-error');
    hideMessage('login-guru-error'); // Tambahkan ini
  }

  function bukaHalamanKelolaKelulusan() {
    tampilHalaman('halaman-kelola-kelulusan');

    // --- [TAMBAHAN BARU] ---
    // 1. Dapatkan halaman dan tentukan status premium
    const halaman = document.getElementById('halaman-kelola-kelulusan');
    const isPremium = (globalDonasiStatus === 'APPROVED');

    // Hapus info box lama jika ada (untuk mencegah duplikat saat dibuka ulang)
    const oldInfoBox = document.getElementById('kelulusan-premium-info');
    if (oldInfoBox) {
      oldInfoBox.remove();
    }

    // 2. Terapkan/Hapus kelas read-only
    if (isPremium) {
      halaman.classList.remove('non-premium-readonly');
    } else {
      halaman.classList.add('non-premium-readonly');
      
      // 3. Tampilkan info box non-premium
      const infoBox = document.createElement('div');
      infoBox.id = 'kelulusan-premium-info';
      infoBox.className = 'premium-info-box'; // Style akan ditambahkan di CSS
      infoBox.innerHTML = '<i class="fas fa-star"></i>Ini adalah Fitur Premium. Anda dapat melihat pengaturan, tetapi tidak dapat mempublikasikan. Silakan <a href="#" id="link-donasi-dari-kelulusan">Donasi</a> untuk mengaktifkan fitur ini.';
      
      // Sisipkan setelah <div class="page-header">
      const pageHeader = halaman.querySelector('.page-header');
      if (pageHeader) {
        pageHeader.insertAdjacentElement('afterend', infoBox);
      }
      
      // Tambahkan event listener untuk link donasi
      const linkDonasi = document.getElementById('link-donasi-dari-kelulusan');
      if (linkDonasi) {
        linkDonasi.addEventListener('click', (e) => {
          e.preventDefault();
          bukaHalamanDonasi(); // Panggil fungsi yang sudah ada
        });
      }
    }
    // --- [AKHIR TAMBAHAN BARU] ---

    // (Sisa fungsi ini tetap sama seperti aslinya)
    setLoading(true, 'Memeriksa status...', false, false);
    hideMessage('kelulusan-message');
    document.getElementById('input-tanggal-pengumuman').value = '';
    document.getElementById('btn-publikasikan-hasil').disabled = true;
    document.getElementById('btn-tarik-publikasi').disabled = true;
    google.script.run.withSuccessHandler(onPublishedStatusLoaded).withFailureHandler(onGagal).getPublishedStatus(getToken());
  }

  function onPublishedStatusLoaded(response) {
    setLoading(false);
    
    // --- [TAMBAHAN BARU] ---
    // 1. Cek apakah halaman dalam mode read-only
    const halaman = document.getElementById('halaman-kelola-kelulusan');
    const isReadOnly = halaman.classList.contains('non-premium-readonly');
    // --- [AKHIR TAMBAHAN BARU] ---

    const statusContainer = document.getElementById('status-publikasi-container');
    const statusText = document.getElementById('status-publikasi-text');
    const tanggalWrapper = document.getElementById('status-publikasi-tanggal-wrapper');
    const tanggalText = document.getElementById('status-publikasi-tanggal');
    const btnPublikasi = document.getElementById('btn-publikasikan-hasil');
    const btnTarik = document.getElementById('btn-tarik-publikasi');
    
    // --- [MODIFIKASI] ---
    // 2. Jangan aktifkan tombol jika read-only
    if (!isReadOnly) { 
      btnPublikasi.disabled = false;
    }
    // --- [AKHIR MODIFIKASI] ---
    
    statusContainer.style.display = 'block';

    if (response.status === 'sukses') {
      if (response.isPublished && response.publishDate) {
        statusContainer.classList.remove('error');
        statusContainer.classList.add('success');
        statusText.innerText = "Sudah Dipublikasikan";
        
        const tgl = new Date(response.publishDate);
        tanggalText.innerText = tgl.toLocaleString('id-ID', { dateStyle: 'full', timeStyle: 'short' });
        tanggalWrapper.style.display = 'block';
        
        document.getElementById('input-tanggal-pengumuman').value = response.publishDate.slice(0, 16);
        btnPublikasi.innerText = "Update Jadwal Publikasi";

        // --- [MODIFIKASI] ---
        // 3. Jangan aktifkan tombol jika read-only
        if (!isReadOnly) {
          btnTarik.disabled = false;
        }
        // --- [AKHIR MODIFIKASI] ---

      } else {
        statusContainer.classList.remove('success');
        statusContainer.classList.add('error');
        statusText.innerText = "Belum Dipublikasikan";
        tanggalWrapper.style.display = 'none';
        btnPublikasi.innerText = "Publikasikan Hasil";
        btnTarik.disabled = true; // Ini sudah disabled, jadi aman
      }
    } else {
      statusContainer.classList.add('error');
      statusText.innerText = "Gagal memuat status.";
      showMessage('kelulusan-message', response.message, true);
    }
    
    // --- [TAMBAHAN BARU] ---
    // 4. Paksa disable semua input/tombol jika read-only,
    //    override semua logika di atas.
    if (isReadOnly) {
      document.getElementById('input-tanggal-pengumuman').disabled = true;
      btnPublikasi.disabled = true;
      btnTarik.disabled = true;
    } else {
      // Jika BUKAN read-only, pastikan input aktif
      document.getElementById('input-tanggal-pengumuman').disabled = false;
    }
    // --- [AKHIR TAMBAHAN BARU] ---
  }

  function isValidISODateString(dateString) {
    if (!dateString) return false;
    try {
      const d = new Date(dateString);
      return d.toISOString() === dateString;
    } catch (e) {
      return false;
    }
  }

  function konfirmasiPublishKelulusan() {
    const tanggalInput = document.getElementById('input-tanggal-pengumuman').value;
    if (!tanggalInput) { showMessage('kelulusan-message', 'Tentukan tanggal pengumuman.', true); return; }
    const tanggalISO = new Date(tanggalInput).toISOString();
    const title = "Konfirmasi Publikasi";
    const message = `Publikasikan hasil untuk tanggal: <br><strong>${new Date(tanggalISO).toLocaleString('id-ID')}</strong>?`;
    const callback = function() {
      setLoading(true, 'Mempublikasikan...');
      hideMessage('kelulusan-message');
      google.script.run.withSuccessHandler(onKelulusanPublished).withFailureHandler(onGagal).publishKelulusan(getToken(), tanggalISO);
    };
    showConfirmationModal(title, message, callback, 'primary');
  }

  function onKelulusanPublished(response) {
    setLoading(false);
    if (response.status === 'sukses') {
      showMessage('kelulusan-message', response.message, false);
      bukaHalamanKelolaKelulusan(); 
    } else {
      showMessage('kelulusan-message', response.message, true);
    }
  }

  function konfirmasiTarikKelulusan() {
    const title = "Konfirmasi Tarik Publikasi";
    const message = "Tarik data kelulusan? Siswa tidak bisa cek lagi.";
    const callback = function() {
      setLoading(true, 'Menarik publikasi...');
      hideMessage('kelulusan-message');
      google.script.run.withSuccessHandler(onKelulusanUnpublished).withFailureHandler(onGagal).unpublishKelulusan(getToken());
    };
    showConfirmationModal(title, message, callback, 'danger');
  }

  function onKelulusanUnpublished(response) {
    setLoading(false);
    if (response.status === 'sukses') {
      showMessage('kelulusan-message', response.message, false);
      bukaHalamanKelolaKelulusan();
    } else {
      showMessage('kelulusan-message', response.message, true);
    }
  }

  function jalankanCekKelulusan() {
    hideMessage('login-siswa-error');
    const nisnInput = document.getElementById('login-siswa-nisn');
    const tglLahirInput = document.getElementById('login-siswa-tgllahir');
    
    const nisn = nisnInput.value.trim();
    const tglLahir = tglLahirInput.value; 

    if (!nisn) {
      showMessage('login-siswa-error', 'NISN harus diisi.', true);
      nisnInput.focus();
      return;
    }
    
    if (!tglLahir) {
      showMessage('login-siswa-error', 'Tanggal Lahir harus diisi.', true);
      tglLahirInput.focus();
      return;
    }
    
    setButtonLoading(document.getElementById('btn-cek-kelulusan'), 'Mengecek...');
    
    google.script.run
      .withSuccessHandler(onCekKelulusanResult)
      .withFailureHandler(onGagalCekKelulusan)
      .cekStatusSiswa(nisn, tglLahir);
  }

  function onGagalCekKelulusan(error) {
    resetButtonLoading(document.getElementById('btn-cek-kelulusan'));
    showMessage('login-siswa-error', error.message, true);
  }

  function onCekKelulusanResult(response) {
    resetButtonLoading(document.getElementById('btn-cek-kelulusan'));
    
    if (response.status === 'error') {
      showMessage('login-siswa-error', response.message, true);
    } else if (response.status === 'countdown') {
      tampilHalamanCountdown(response.targetDate, response.namaSekolah);
    } else if (response.status === 'hasil') {
      tampilHalamanHasil(response.result, response.namaSiswa, response.namaSekolah);
    }
  }

  function tampilHalamanCountdown(targetDateISO, namaSekolah) {
    document.getElementById('hasil-nama-sekolah').innerText = namaSekolah || 'Sekolah Anda';
    tampilHalaman('halaman-hasil-siswa');
    document.getElementById('hasil-countdown-container').style.display = 'block';
    document.getElementById('hasil-reveal-container').style.display = 'none';
    
    const targetDate = new Date(targetDateISO);
    document.getElementById('countdown-target-date').innerText = 
      `Pengumuman akan dibuka pada: ${targetDate.toLocaleString('id-ID', { dateStyle: 'full', timeStyle: 'long' })}`;
    
    startCountdown(targetDate);
  }

  function tampilHalamanHasil(statusKelulusan, namaSiswa, namaSekolah) {
    if (globalCountdownTimer) {
      clearInterval(globalCountdownTimer);
      globalCountdownTimer = null;
    }
    
    document.getElementById('hasil-nama-sekolah').innerText = namaSekolah || 'Sekolah Anda';
    document.getElementById('hasil-nama-siswa-lulus').innerText = namaSiswa || '';
    document.getElementById('hasil-nama-siswa-gagal').innerText = namaSiswa || '';
    
    tampilHalaman('halaman-hasil-siswa');
    document.getElementById('hasil-countdown-container').style.display = 'none';
    document.getElementById('hasil-reveal-container').style.display = 'block';

    const envelopeImage = document.getElementById('envelope-image-clickable'); 
    const envelopeContainer = document.getElementById('envelope-container');
    const resultContainer = document.getElementById('result-card-container');
    
    // Reset style gambar (untuk jika siswa cek ulang)
    envelopeImage.style.transform = ''; // Hapus style inline
    envelopeImage.style.opacity = '1';
    envelopeImage.classList.remove('envelope-opening'); // Pastikan kelas animasi di-reset
    
    envelopeContainer.style.display = 'block';
    resultContainer.style.display = 'none';
    
    document.getElementById('hasil-lulus-container').style.display = 'none';
    document.getElementById('hasil-tidak-lulus-container').style.display = 'none';

    envelopeImage.dataset.status = statusKelulusan; 
    
    // --- PERUBAHAN PADA CLICK HANDLER ---
    const clickHandler = () => {
      // 1. Tambahkan kelas animasi flip
      envelopeImage.classList.add('envelope-opening');
      
      // 2. Panggil revealResult setelah animasi dimulai
      // (Kita tidak perlu menunggu, revealResult akan menangani timeout)
      revealResult(envelopeImage.dataset.status); 
      
      // 3. Hapus listener
      envelopeImage.removeEventListener('click', clickHandler); 
    };
    // --- AKHIR PERUBAHAN ---
    
    envelopeImage.addEventListener('click', clickHandler); 
  }

  function revealResult(status) {
    // Hapus javascript yang mengatur animasi, karena CSS sudah menanganinya
    const envelopeContainer = document.getElementById('envelope-container');
    const resultContainer = document.getElementById('result-card-container');
    
    // Sesuaikan timeout agar cocok dengan durasi transisi di CSS (0.6s)
    setTimeout(() => {
      envelopeContainer.style.display = 'none';
      resultContainer.style.display = 'block';
      
      if (status === 'LULUS') {
        document.getElementById('hasil-lulus-container').style.display = 'block';
        triggerConfetti();
      } else {
        document.getElementById('hasil-tidak-lulus-container').style.display = 'block';
      }
    }, 600); // Diubah menjadi 600ms agar pas dengan transisi CSS
  }

  function startCountdown(targetDate) {
    if (globalCountdownTimer) {
      clearInterval(globalCountdownTimer);
    }
    
    const targetTime = targetDate.getTime();
    
    const daysEl = document.getElementById('countdown-days');
    const hoursEl = document.getElementById('countdown-hours');
    const minutesEl = document.getElementById('countdown-minutes');
    const secondsEl = document.getElementById('countdown-seconds');

    function updateTimer() {
      const now = new Date().getTime();
      const distance = targetTime - now;

      if (distance < 0) {
        clearInterval(globalCountdownTimer);
        globalCountdownTimer = null;
        
        // --- PERUBAHAN DI SINI ---
        
        // 1. Tampilkan pesan bahwa waktunya telah tiba
        const countdownContainer = document.getElementById('hasil-countdown-container');
        if (countdownContainer) {
          countdownContainer.innerHTML = 
            '<h2 style="color: var(--success-color);">Waktu Pengumuman Telah Tiba!</h2>' +
            '<p>Sedang mengambil hasil kelulusan Anda, harap tunggu...</p>' +
            '<div class="spinner" style="width: 40px; height: 40px; border-width: 4px; margin-top: 20px;"></div>';
        }
        
        // 2. Ambil data login siswa dari form (karena kita masih di halaman login)
        const nisn = document.getElementById('login-siswa-nisn').value;
        const tglLahir = document.getElementById('login-siswa-tgllahir').value;
        
        // 3. Panggil ulang fungsi cek kelulusan secara otomatis
        // onCekKelulusanResult akan menangani tampilan halaman hasil
        google.script.run
          .withSuccessHandler(onCekKelulusanResult)
          .withFailureHandler(onGagalCekKelulusan)
          .cekStatusSiswa(nisn, tglLahir);
        
        // --- AKHIR PERUBAHAN ---
        return;
      }

      const days = Math.floor(distance / (1000 * 60 * 60 * 24));
      const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((distance % (1000 * 60)) / 1000);
      
      daysEl.innerText = String(days).padStart(2, '0');
      hoursEl.innerText = String(hours).padStart(2, '0');
      minutesEl.innerText = String(minutes).padStart(2, '0');
      secondsEl.innerText = String(seconds).padStart(2, '0');
    }

    updateTimer();
    globalCountdownTimer = setInterval(updateTimer, 1000);
  }

  function triggerConfetti() {
    const canvas = document.getElementById('confetti-canvas');
    if (!canvas || !window.confetti) {
      console.log('Confetti library not found.');
      return;
    }

    const myConfetti = confetti.create(canvas, {
      resize: true,
      useWorker: true
    });

    const duration = 5 * 1000;
    const animationEnd = Date.now() + duration;
    const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 10001 };

    function randomInRange(min, max) {
      return Math.random() * (max - min) + min;
    }

    const interval = setInterval(function() {
      const timeLeft = animationEnd - Date.now();

      if (timeLeft <= 0) {
        return clearInterval(interval);
      }

      const particleCount = 50 * (timeLeft / duration);
      
      myConfetti(Object.assign({}, defaults, { 
        particleCount, 
        origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } 
      }));
      myConfetti(Object.assign({}, defaults, { 
        particleCount, 
        origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } 
      }));
    }, 250);
  }

  function jalankanLoginGuru() {
    hideMessage('login-guru-error');
    const npsn = document.getElementById('login-guru-npsn').value.trim();
    const email = document.getElementById('login-guru-email').value.trim();
    const pass = document.getElementById('login-guru-password').value;

    if (!npsn || !email || !pass) {
      showMessage('login-guru-error', "Semua field harus diisi.", true);
      return;
    }

    setButtonLoading(document.getElementById('btn-login-guru'), 'Login Guru...');
    google.script.run
      .withSuccessHandler(hasilLogin)
      .withFailureHandler((error) => {
         resetButtonLoading(document.getElementById('btn-login-guru'));
         showMessage('login-guru-error', error.message, true);
      })
      .prosesLoginGuru(npsn, email, pass);
  }

  function tampilkanDashboardGuru(namaGuru, namaSekolah) {
    tampilHalaman('halaman-utama');
    document.getElementById('salam-sekolah').innerHTML = `Selamat Datang, ${namaGuru}<br><small>${namaSekolah}</small>`;
    
    const pSubjudul = document.querySelector('#halaman-utama h2#salam-sekolah + p');
    if (pSubjudul) {
      pSubjudul.style.marginBottom = '0'; 
    }
    
    const menuAdmin = [
      'btn-buka-data-sekolah', 'btn-buka-siswa', 'btn-buka-mapel', 
      'btn-buka-bobot', 'btn-buka-kelas', 'btn-buka-semester',
      'btn-buka-input-rapor', 'btn-buka-validasi-nilai', 
      'btn-buka-nilai-ijazah', 'btn-buka-kelola-kelulusan',
      'btn-update-semua-data', 'btn-buka-guru'
    ];
    
    menuAdmin.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.closest('.dashboard-card') ? el.closest('.dashboard-card').style.display = 'none' : el.style.display = 'none';
    });

    document.querySelectorAll('.dashboard-section-header, .dashboard-divider, .dashboard-section-header-flex').forEach(el => {
       el.style.display = 'none';
    });

    document.getElementById('btn-buka-input-ujian').closest('.dashboard-card').style.display = 'flex';
    
    const container = document.querySelector('#halaman-utama .page');
    let guruMenu = document.getElementById('guru-menu-container');
    if (!guruMenu) {
        guruMenu = document.createElement('div');
        guruMenu.id = 'guru-menu-container';
        guruMenu.className = 'dashboard-menu-grid';
        
        guruMenu.appendChild(document.getElementById('btn-buka-input-ujian').closest('.dashboard-card'));
        
        if (pSubjudul) {
            pSubjudul.insertAdjacentElement('afterend', guruMenu);
        } else {
            container.appendChild(guruMenu);
        }
    }
  }

  function bukaHalamanGuru() {
      tampilHalaman('halaman-guru');
      
      // --- Logika UI Premium (Tetap dipertahankan) ---
      const halaman = document.getElementById('halaman-guru');
      const isPremium = (globalDonasiStatus === 'APPROVED');

      const oldInfoBox = document.getElementById('guru-premium-info');
      if (oldInfoBox) oldInfoBox.remove();

      if (isPremium) {
        halaman.classList.remove('non-premium-readonly');
      } else {
        halaman.classList.add('non-premium-readonly');
        
        const infoBox = document.createElement('div');
        infoBox.id = 'guru-premium-info';
        infoBox.className = 'premium-info-box';
        infoBox.innerHTML = '<i class="fas fa-star"></i>Ini adalah Fitur Premium. Anda dapat melihat data guru, tetapi tidak dapat menambah, mengedit, atau menghapus data. Silakan <a href="#" id="link-donasi-dari-guru">Donasi</a> untuk mengaktifkan fitur ini.';
        
        const pageHeader = halaman.querySelector('.page-header');
        if (pageHeader) pageHeader.insertAdjacentElement('afterend', infoBox);
        
        const linkDonasi = document.getElementById('link-donasi-dari-guru');
        if (linkDonasi) {
          linkDonasi.addEventListener('click', (e) => {
            e.preventDefault();
            bukaHalamanDonasi();
          });
        }
      }
      // --- Akhir Logika UI Premium ---
      
      // --- [PERBAIKAN UTAMA: LOADING BERANTAI MAPEL -> KELAS -> GURU] ---
      console.log("Memulai sequence loading halaman Guru...");
      setLoading(true, 'Memuat referensi data...', false, false);
      
      // Reset UI Tabel
      document.getElementById('guru-table-container').innerHTML = '<p>Memuat data guru...</p>';
      
      // Matikan tombol sementara
      document.getElementById('btn-tambah-guru-baru').disabled = true;
      document.getElementById('btn-import-guru').disabled = true;
      document.getElementById('btn-cetak-kartu-guru').disabled = true;
      document.getElementById('btn-sync-guru-kelas').disabled = true;
      document.getElementById('btn-simpan-pengaturan-guru').disabled = true;

      // LANGKAH 1: Cek apakah Mapel sudah ada di cache?
      if (globalMapelList && globalMapelList.length > 0) {
          console.log("Cache Mapel ditemukan, lanjut ke Kelas...");
          _loadKelasForGuruPage(); // Lanjut ke langkah 2
      } else {
          console.log("Cache Mapel kosong, memuat dari server...");
          // Ambil Mapel dari server
          google.script.run
              .withSuccessHandler((response) => {
                  if (response.status === 'sukses') {
                      // Simpan ke variabel global agar pencarian di modal berfungsi
                      globalMapelList = response.mapel;
                      // Setelah mapel siap, Lanjut ke langkah 2
                      _loadKelasForGuruPage();
                  } else {
                      onGagal(response);
                  }
              })
              .withFailureHandler(onGagal)
              .getMapel(getToken());
      }

      // Panggil data Pengaturan Guru (jalan paralel karena independen)
      google.script.run
          .withSuccessHandler(onPengaturanGuruLoaded)
          .withFailureHandler(onGagal) 
          .getPengaturanGuru(getToken());
  }

  /**
   * [BARU] Callback setelah kelas dimuat, SEBELUM memuat guru.
   * VERSI REFACTOR: Menambahkan flag isFromCache
   */
  function onKelasLoadedForGuruPage(response, isFromCache = false) { // <-- TAMBAHKAN PARAMETER
      if (response.status === 'sukses') {
          globalKelasListCache = response.kelasList;

          // --- PENAMBAHAN LOGIKA ---
          // Jika data berasal dari cache, jangan panggil server lagi.
          if (isFromCache) {
              return; 
          }
          // --- AKHIR PENAMBAHAN ---
          
          // 3. Setelah kelas dimuat (dari server), SEKARANG panggil getGuru (Logika Asli)
          google.script.run
              .withSuccessHandler(onGuruLoaded)
              .withFailureHandler(onGagal)
              .getGuru(getToken());
              
      } else {
          // Gagal memuat kelas. Ini fatal. Hentikan loading dan tampilkan error.
          globalKelasListCache = [];
          onGagal(response); // Biarkan onGagal mematikan loading
      }
  }

  let globalGuruList = []; // Cache lokal untuk data guru

  // Di dalam client.html
  function onGuruLoaded(response) {
    setLoading(false);
    
    // --- [TAMBAHAN BARU] ---
    const halaman = document.getElementById('halaman-guru');
    const isReadOnly = halaman.classList.contains('non-premium-readonly');
    // --- [AKHIR TAMBAHAN BARU] ---

    // --- [MODIFIKASI] ---
    // Aktifkan tombol HANYA jika TIDAK read-only
    if (!isReadOnly) {
      document.getElementById('btn-tambah-guru-baru').disabled = false;
      document.getElementById('btn-import-guru').disabled = false;
      document.getElementById('btn-cetak-kartu-guru').disabled = false;
      document.getElementById('btn-sync-guru-kelas').disabled = false;
    }
    // --- [AKHIR MODIFIKASI] ---

    if (response.status === 'sukses') {
      globalGuruList = response.guru;
      renderGuruTable(globalGuruList);
      
      try {
        const totalKelasCount = globalKelasListCache.length;
        let isDataDirty = false;
        
        if (totalKelasCount === 1) { 
          for (const guru of globalGuruList) {
            const mapelData = guru.mapelKelas || {};
            for (const mapelId in mapelData) {
              const kelasArray = mapelData[mapelId];
              if (!Array.isArray(kelasArray) || kelasArray.length !== 1 || kelasArray[0] !== "*") {
                isDataDirty = true;
                break;
              }
            }
            if (isDataDirty) break;
          }
        }
        
        // --- [MODIFIKASI] ---
        // Tampilkan tombol HANYA jika dirty DAN tidak read-only
        if (isDataDirty && !isReadOnly) {
          document.getElementById('btn-sync-guru-kelas').style.display = 'inline-flex';
        } else {
          document.getElementById('btn-sync-guru-kelas').style.display = 'none';
        }
        // --- [AKHIR MODIFIKASI] ---
        
      } catch (e) {
        console.error("Gagal memeriksa status sync guru:", e);
        document.getElementById('btn-sync-guru-kelas').style.display = 'none';
      }
      
    } else {
      document.getElementById('guru-table-container').innerHTML = `<p class="message error" style="display:block;">${response.message}</p>`;
    }
  }

  /**
   * Callback setelah pengaturan guru dimuat.
   */
  function onPengaturanGuruLoaded(response) {
    // Jika onGuruLoaded belum selesai, setLoading(false) tidak akan dipanggil
    // Kita asumsikan onGuruLoaded akan memanggil setLoading(false) nanti
    
    if (response.status === 'sukses') {
      const toggle = document.getElementById('toggle-waktu-input');
      const tglMulai = document.getElementById('guru-tanggal-mulai');
      const tglTutup = document.getElementById('guru-tanggal-tutup');
      const container = document.getElementById('container-tanggal-input-guru');
      
      toggle.checked = response.pengaturan.isAktif;
      tglMulai.value = response.pengaturan.tanggalMulai;
      tglTutup.value = response.pengaturan.tanggalTutup;

      if (response.pengaturan.isAktif) {
        container.style.display = 'block';
      } else {
        container.style.display = 'none';
      }
      
      document.getElementById('btn-simpan-pengaturan-guru').disabled = false;
    } else {
      // onGagal akan menangani pesan error di 'pengaturan-guru-message'
      showMessage('pengaturan-guru-message', response.message, true);
    }
  }

  /**
   * Menyimpan pengaturan waktu input guru.
   */
  function simpanPengaturanGuru() {
    const isAktif = document.getElementById('toggle-waktu-input').checked;
    const tanggalMulai = document.getElementById('guru-tanggal-mulai').value;
    const tanggalTutup = document.getElementById('guru-tanggal-tutup').value;

    // --- PERUBAHAN VALIDASI DI SINI ---
    // Validasi hanya jika KEDUA tanggal diisi
    if (isAktif && tanggalMulai && tanggalTutup && tanggalMulai >= tanggalTutup) {
      showMessage('pengaturan-guru-message', 'Tanggal selesai harus setelah tanggal mulai.', true);
      return;
    }
    // Validasi "wajib diisi" dihapus
    // --- AKHIR PERUBAHAN ---

    const pengaturan = {
      isAktif: isAktif,
      tanggalMulai: tanggalMulai, // Kirim string kosong jika tidak diisi
      tanggalTutup: tanggalTutup  // Kirim string kosong jika tidak diisi
    };

    setButtonLoading(document.getElementById('btn-simpan-pengaturan-guru'), 'Menyimpan...');
    hideMessage('pengaturan-guru-message');
    
    google.script.run
      .withSuccessHandler(onPengaturanGuruSaved)
      .withFailureHandler(onGagal) // onGagal akan mereset tombol
      .savePengaturanGuru(getToken(), pengaturan);
  }

  /**
   * Callback setelah pengaturan guru disimpan.
   */
  function onPengaturanGuruSaved(response) {
    resetButtonLoading(document.getElementById('btn-simpan-pengaturan-guru'));
    if (response.status === 'sukses') {
      showMessage('pengaturan-guru-message', response.message, false);
    } else {
      showMessage('pengaturan-guru-message', response.message, true);
    }
  }

  /**
   * VERSI REFACTOR (Cepat)
   * Merender tabel guru menggunakan DocumentFragment.
   */
  function renderGuruTable(guruList) {
      const container = document.getElementById('guru-table-container');
      container.innerHTML = ""; // 1. Kosongkan

      if (!guruList || guruList.length === 0) {
          // [MODIFIKASI] Colspan diubah dari 4 menjadi 3
          container.innerHTML = '<table class="siswa-table guru-table"><tbody><tr><td colspan="3" style="text-align: center;">Belum ada data guru.</td></tr></tbody></table>';
          return;
      }

      // Ambil data kelas yang valid dari cache
      const validKelasNames = globalKelasListCache.map(k => k.nama);
      const totalKelasCount = globalKelasListCache.length;

      // 2. Buat elemen tabel
      const table = document.createElement('table');
      table.className = 'siswa-table guru-table';

      // 3. Buat header
      const thead = table.createTHead();
      const headerRow = thead.insertRow();
      // [MODIFIKASI] Menghilangkan header "MAPEL DIampu"
      headerRow.innerHTML = '<thead><tr><th>Nama Guru</th><th>Email Login</th><th>Aksi</th></tr></thead>';

      // 4. Buat body dan DocumentFragment
      const tbody = table.createTBody();
      const fragment = document.createDocumentFragment();
      
      guruList.forEach(guru => {
          // [MODIFIKASI] Logika untuk 'mapelBadges' dihapus semua
          
          const guruDataJson = JSON.stringify({
              email: guru.email,
              nama: guru.nama,
              nip: guru.nip, // <-- BARIS INI DIMODIFIKASI
              mapelKelas: guru.mapelKelas // Data ini tetap disimpan di tombol untuk modal
          }).replace(/"/g, '&quot;');

          // 5. Buat <tr> baru di memori
          const tr = document.createElement('tr');
          
          // 6. [MODIFIKASI] Isi <td> (menambahkan premium-stamp dan wrapper)
          tr.innerHTML = `
              <td><strong>${guru.nama}</strong></td>
              <td>${guru.email}</td>
              <td>
                <div class="btn-grup-aksi">
                      <button class="btn-aksi btn-edit btn-edit-guru" data-guru="${guruDataJson}">
                        <span class="btn-content-wrapper"><i class="fas fa-pencil-alt"></i> Edit</span>
                        <div class="premium-stamp" style="display: none;">Premium</div>
                      </button>
                      <button class="btn-aksi btn-delete btn-delete-guru" data-email="${guru.email}" data-nama="${guru.nama}">
                        <span class="btn-content-wrapper"><i class="fas fa-trash-alt"></i> Hapus</span>
                        <div class="premium-stamp" style="display: none;">Premium</div>
                      </button>
                </div>
              </td>
          `;
          
          // 7. Tambahkan <tr> ke fragment
          fragment.appendChild(tr);
      });

      // 8. Tambahkan fragment ke tbody
      tbody.appendChild(fragment);

      // 9. Tambahkan tabel ke container
      container.appendChild(table);
  }

  function showModalGuru(mode, guruData = null) {
      hideMessage('modal-guru-error');
      document.getElementById('modal-guru-mode').value = mode;
      const passLabel = document.getElementById('label-guru-password');
      const passInput = document.getElementById('modal-guru-password');
      
      // --- [PEMULIHAN FITUR] ---
      // 1. Tampilkan Container Mapel
      const mapelContainer = document.querySelector('#form-guru .form-group[style*="display: none;"]');
      if (mapelContainer) mapelContainer.style.display = 'block';

      // 2. Pastikan menggunakan UI Multi-Kelas (Mapel + Kelas)
      document.getElementById('modal-guru-ui-single-class').style.display = 'none';
      document.getElementById('modal-guru-ui-multi-class').style.display = 'block';
      
      // 3. Set mode di hidden input agar pencarian mapel tahu kita pakai mode multi-kelas
      // Penting: set ke 'false' agar pencarian mengarah ke container yang benar
      document.getElementById('modal-guru-mode').dataset.isSingleClassMode = "false"; 
      
      // 4. Bersihkan list sebelumnya
      document.getElementById('modal-guru-mapel-kelas-list').innerHTML = '';
      document.getElementById('modal-guru-mapel-kelas-search').value = '';
      // --- [AKHIR PEMULIHAN] ---

      if (mode === 'add') {
          document.getElementById('modal-guru-title').innerText = "Tambah Guru Baru";
          document.getElementById('modal-guru-nama').value = "";
          document.getElementById('modal-guru-nip').value = ""; 
          document.getElementById('modal-guru-email').value = "";
          document.getElementById('modal-guru-original-email').value = "";
          passInput.value = "";
          passLabel.innerText = "Password (Wajib)";
          passInput.placeholder = "Buat password baru";
      } else {
          // Mode Edit
          document.getElementById('modal-guru-title').innerText = "Edit Data Guru";
          document.getElementById('modal-guru-nama').value = guruData.nama;
          document.getElementById('modal-guru-nip').value = guruData.nip || ""; 
          document.getElementById('modal-guru-email').value = guruData.email;
          document.getElementById('modal-guru-original-email').value = guruData.email;
          passInput.value = "";
          passLabel.innerText = "Password (Kosongkan jika tidak diubah)";
          passInput.placeholder = "---";
          
          // --- [PEMULIHAN FITUR] Render data mapel yang sudah ada ---
          if (guruData.mapelKelas) {
             renderMapelKelasList(guruData.mapelKelas);
          }
          // --- [AKHIR PEMULIHAN] ---
      }

      document.getElementById('guru-modal').classList.add('show');
  }

  function tutupModalGuru() {
      document.getElementById('guru-modal').classList.remove('show');
  }

  function simpanGuru() {
      setButtonLoading(document.getElementById('btn-simpan-guru'), 'Menyimpan...');
      hideMessage('modal-guru-error');

      const nama = document.getElementById('modal-guru-nama').value.trim();
      const nip = document.getElementById('modal-guru-nip').value.trim(); 
      const email = document.getElementById('modal-guru-email').value.trim();
      const password = document.getElementById('modal-guru-password').value;
      const mode = document.getElementById('modal-guru-mode').value;
      const originalEmail = document.getElementById('modal-guru-original-email').value;
      
      // --- [PEMULIHAN & UPDATE FITUR] ---
      const mapelKelasData = {};
      const rows = document.querySelectorAll('#modal-guru-mapel-kelas-list .mapel-kelas-row');
      
      rows.forEach(row => {
          const mapelId = row.dataset.mapelId;
          const select = row.querySelector('select.mapel-kelas-select');
          const selectedKelas = select ? select.value : "";
          
          if (mapelId && selectedKelas) {
              if (!mapelKelasData[mapelId]) {
                  mapelKelasData[mapelId] = [];
              }
              
              // --- [LOGIKA BARU UNTUK SEMUA KELAS] ---
              if (selectedKelas === "*") {
                  // Jika pilih "Semua Kelas", paksa array jadi ["*"] dan abaikan pilihan lain untuk mapel ini
                  mapelKelasData[mapelId] = ["*"];
              } else {
                  // Jika bukan "*", masukkan ke array jika belum ada "Semua Kelas" di dalamnya
                  if (!mapelKelasData[mapelId].includes("*")) {
                      if (!mapelKelasData[mapelId].includes(selectedKelas)) {
                          mapelKelasData[mapelId].push(selectedKelas);
                      }
                  }
              }
              // --- [AKHIR LOGIKA BARU] ---
          }
      });
      // --- [AKHIR PEMULIHAN] ---

      if (!nama || !email) {
          resetButtonLoading(document.getElementById('btn-simpan-guru'));
          showMessage('modal-guru-error', 'Nama dan Email wajib diisi.', true);
          return;
      }
      if (mode === 'add' && !password) {
          resetButtonLoading(document.getElementById('btn-simpan-guru'));
          showMessage('modal-guru-error', 'Password wajib untuk guru baru.', true);
          return;
      }
      if (password && password.length < 8) {
          resetButtonLoading(document.getElementById('btn-simpan-guru'));
          showMessage('modal-guru-error', 'Password minimal 8 karakter.', true);
          return;
      }

      const guruData = {
          mode: mode,
          originalEmail: originalEmail,
          nama: nama,
          nip: nip, 
          email: email,
          password: password,
          mapelKelas: mapelKelasData
      };

      google.script.run
          .withSuccessHandler((response) => {
              resetButtonLoading(document.getElementById('btn-simpan-guru'));
              if (response.status === 'sukses') {
                  tutupModalGuru();
                  showToast(response.message, 'sukses');
                  
                  if (response.newData) {
                    const newData = response.newData;
                    if (mode === 'add') {
                      globalGuruList.push(newData);
                    } else {
                      const emailToFind = (originalEmail || newData.email);
                      const indexToUpdate = globalGuruList.findIndex(g => g.email === emailToFind);
                      if (indexToUpdate > -1) {
                        globalGuruList[indexToUpdate] = newData;
                      } else {
                         // Fallback update cache
                         const indexToUpdateByName = globalGuruList.findIndex(g => g.nama === newData.nama);
                         if(indexToUpdateByName > -1) globalGuruList[indexToUpdateByName] = newData;
                         else globalGuruList.push(newData); 
                      }
                    }
                  } else {
                    globalGuruList = []; 
                  }

                  bukaHalamanGuru(); 
              } else {
                  showMessage('modal-guru-error', response.message, true);
              }
          })
          .withFailureHandler(onGagal)
          .saveGuru(getToken(), guruData);
  }

  function konfirmasiHapusGuru(email, nama) {
      const title = "Konfirmasi Hapus Guru";
      const message = `Yakin ingin menghapus guru <strong>${nama}</strong> (${email})?<br>Akses login mereka akan dicabut.`;
      const callback = function() {
          setLoading(true, 'Menghapus guru...');
          google.script.run
              .withSuccessHandler((response) => {
                  setLoading(false);
                  if (response.status === 'sukses') {
                      showToast(response.message, 'sukses');
                      bukaHalamanGuru(); // Reload tabel
                  } else {
                      showToast(response.message, 'gagal');
                  }
              })
              .withFailureHandler(onGagal)
              .deleteGuru(getToken(), email);
      };
      showConfirmationModal(title, message, callback, 'danger');
  }

  // Di dalam client.html (FUNGSI BARU)

  /**
   * [BARU] Menampilkan konfirmasi sebelum sinkronisasi kelas guru.
   */
  function konfirmasiSyncGuruKelas() {
    const title = "Sinkronkan Kelas Guru";
    const message = "Ini akan mengatur ulang semua mapel guru agar mengajar di 'Semua Kelas' (karena Anda hanya memiliki 1 kelas terdaftar). Ini akan membersihkan data kelas lama yang mungkin tersisa. Lanjutkan?";
    const callback = function() {
      setLoading(true, 'Menyinkronkan data guru...');
      // Sembunyikan tombolnya langsung agar tidak diklik dua kali
      document.getElementById('btn-sync-guru-kelas').style.display = 'none';
      
      google.script.run
        .withSuccessHandler(onSyncGuruKelasSelesai)
        .withFailureHandler(onGagal)
        .syncGuruClassesToSingleClass(getToken());
    };
    showConfirmationModal(title, message, callback, 'primary');
  }

  /**
   * [BARU] Callback setelah sinkronisasi kelas guru selesai.
   */
  function onSyncGuruKelasSelesai(response) {
    setLoading(false);
    if (response.status === 'sukses') {
      // Muat ulang halaman guru (data akan bersih, tombol akan otomatis hilang)
      bukaHalamanGuru();
      showToast(response.message, 'sukses');
    } else {
      // Gagal, tampilkan pesan error
      // (Tombol akan muncul lagi saat bukaHalamanGuru() dipanggil berikutnya jika masih dirty)
      showMessage('pengaturan-guru-message', response.message, true);
    }
  }

  function getSelectedMapelIds() {
    const ids = new Set();
    document.querySelectorAll('#modal-guru-mapel-selected .selected-mapel-tag-remove').forEach(tag => {
      ids.add(tag.dataset.id);
    });
    return ids;
  }

  function updateMapelSuggestions() {
    // --- PERBAIKAN: Tentukan UI mana yang aktif ---
    const modal = document.getElementById('guru-modal');
    if (!modal) return;
    const isSingleClassMode = (modal.dataset.isSingleClassMode === 'true');

    const container = document.getElementById(isSingleClassMode ? 'modal-guru-mapel-suggestions' : 'modal-guru-mapel-kelas-suggestions');
    const searchInput = document.getElementById(isSingleClassMode ? 'modal-guru-mapel-search' : 'modal-guru-mapel-kelas-search');
    // --- AKHIR PERBAIKAN ---

    const searchTerm = searchInput.value.toLowerCase();

    if (searchTerm.length === 0) {
      container.innerHTML = '';
      container.style.display = 'none';
      return;
    }

    // --- PERBAIKAN: Baca dari UI yang benar ---
    const selectedIds = isSingleClassMode ? 
                        getSelectedMapelIds() : // (Fungsi lama, baca tag)
                        getSelectedMapelKelasIds(); // (Fungsi baru, baca list row)
    // --- AKHIR PERBAIKAN ---

    const filteredMapel = globalMapelList.filter(mapel => {
      return !selectedIds.has(mapel.id) && 
            (mapel.id.toLowerCase().includes(searchTerm) || 
              mapel.nama.toLowerCase().includes(searchTerm));
    });

    if (filteredMapel.length === 0) {
      container.innerHTML = '<div class="mapel-suggestion-item" style="color: var(--text-light); cursor: default;">Mapel tidak ditemukan atau sudah ditambah.</div>';
    } else {
      container.innerHTML = filteredMapel.slice(0, 10).map(mapel => {
        return `
          <div class="mapel-suggestion-item" data-id="${mapel.id}" data-nama="${mapel.nama}">
            <strong>${mapel.id}</strong> - ${mapel.nama}
          </div>
        `;
      }).join('');
    }
    container.style.display = 'block';
  }

  /**
   * [BARU] Helper untuk UI Multi-Kelas: Baca mapel yg sudah ada di list
   */
  function getSelectedMapelKelasIds() {
    const ids = new Set();
    document.querySelectorAll('#modal-guru-mapel-kelas-list .mapel-kelas-row').forEach(row => {
      ids.add(row.dataset.mapelId);
    });
    return ids;
  }

  function addMapelKelasRow(mapelId, mapelNama, selectedKelas = "") { 
    const container = document.getElementById('modal-guru-mapel-kelas-list');
    
    // Buat opsi <select>
    let classOptions = '<option value="">-- Pilih Kelas --</option>';
    
    // --- [MODIFIKASI] Tambahkan Opsi "Semua Kelas" ---
    const isAllSelected = (selectedKelas === "*");
    classOptions += `<option value="*" ${isAllSelected ? 'selected' : ''} style="font-weight:bold; color:var(--primary-color);">-- Semua Kelas --</option>`;
    // --- [AKHIR MODIFIKASI] ---
    
    if (globalKelasListCache.length > 0) {
      // Urutkan kelas agar rapi
      globalKelasListCache.sort((a, b) => compareKelas(a.nama, b.nama));
      
      globalKelasListCache.forEach(kelas => {
        const isSelected = (selectedKelas === kelas.nama) ? 'selected' : '';
        classOptions += `<option value="${kelas.nama}" ${isSelected}>${kelas.nama}</option>`;
      });
    } else {
      classOptions += '<option value="" disabled>Data kelas kosong</option>';
    }

    const rowHtml = `
      <div class="mapel-kelas-row" data-mapel-id="${mapelId}">
        <span class="mapel-kelas-nama">${mapelId} - ${mapelNama}</span>
        <div class="mapel-kelas-select-wrapper">
            <select class="mapel-kelas-select">
                ${classOptions}
            </select>
        </div>
        <button type="button" class="mapel-kelas-remove" data-id="${mapelId}" title="Hapus Baris Ini">
          <i class="fas fa-trash-alt"></i>
        </button>
      </div>
    `;
    
    container.innerHTML += rowHtml;

    // Reset input pencarian
    const searchInput = document.getElementById('modal-guru-mapel-kelas-search');
    const suggestionsContainer = document.getElementById('modal-guru-mapel-kelas-suggestions');
    searchInput.value = "";
    suggestionsContainer.innerHTML = "";
    suggestionsContainer.style.display = "none";
    searchInput.focus();
  }

  function renderMapelKelasList(mapelKelasData) {
    const container = document.getElementById('modal-guru-mapel-kelas-list');
    container.innerHTML = ''; // Kosongkan dulu
    
    if (!globalMapelList || globalMapelList.length === 0) {
      setTimeout(() => renderMapelKelasList(mapelKelasData), 100);
      return;
    }

    for (const mapelId in mapelKelasData) {
      const mapel = globalMapelList.find(m => m.id === mapelId);
      if (mapel) {
        const selectedKelas = mapelKelasData[mapelId]; // Array, misal: ["VI A"] atau ["*"]
        let kelasArray = Array.isArray(selectedKelas) ? selectedKelas : [];
        
        // --- [MODIFIKASI PENTING] ---
        // DULU: Kita expand "*" menjadi list semua nama kelas.
        // SEKARANG: Kita biarkan apa adanya. Jika ["*"], loop di bawah akan merender 1 baris dengan value "*"
        
        if (kelasArray.length > 0) {
          kelasArray.forEach(namaKelas => {
            addMapelKelasRow(mapel.id, mapel.nama, namaKelas);
          });
        }
        // --- [AKHIR MODIFIKASI] ---
      }
    }
  }

  function addSelectedMapelTag(mapelId, mapelNama) {
    const container = document.getElementById('modal-guru-mapel-selected');
    const searchInput = document.getElementById('modal-guru-mapel-search');
    const suggestionsContainer = document.getElementById('modal-guru-mapel-suggestions');

    const tagHtml = `
      <div class="selected-mapel-tag" id="tag_mapel_${mapelId}">
        <span>${mapelId} - ${mapelNama}</span>
        <button type="button" class="selected-mapel-tag-remove" data-id="${mapelId}" title="Hapus">&times;</button>
      </div>
    `;

    container.innerHTML += tagHtml;

    searchInput.value = "";
    suggestionsContainer.innerHTML = "";
    suggestionsContainer.style.display = "none";
    searchInput.focus();
  }

  function removeSelectedMapelTag(mapelId) {
    const tagElement = document.getElementById(`tag_mapel_${mapelId}`);
    if (tagElement) {
      tagElement.remove();
    }
  }

  function renderSelectedMapelTags(mapelIdArray) {
    const container = document.getElementById('modal-guru-mapel-selected');
    container.innerHTML = '';
    if (!mapelIdArray || mapelIdArray.length === 0) {
      return;
    }

    if (!globalMapelList || globalMapelList.length === 0) {
      setTimeout(() => renderSelectedMapelTags(mapelIdArray), 100);
      return;
    }

    mapelIdArray.forEach(id => {
      const mapel = globalMapelList.find(m => m.id === id);
      if (mapel) {
        addSelectedMapelTag(mapel.id, mapel.nama);
      }
    });

    const searchInput = document.getElementById('modal-guru-mapel-search');
    if (searchInput) searchInput.value = "";
  }

  function bukaModalImportGuru() {
    document.getElementById('file-upload-guru').value = null;
    document.getElementById('btn-proses-import-guru').disabled = true;
    document.getElementById('import-guru-results').style.display = 'none';
    document.getElementById('import-guru-results').innerHTML = '';
    hideMessage('template-guru-message');

    const fileUploadText = document.getElementById('file-upload-text-guru');
    fileUploadText.innerText = 'Klik untuk memilih file atau seret & letakkan di sini.';
    fileUploadText.classList.remove('file-chosen');
    document.getElementById('file-upload-zone-guru').classList.remove('drag-over');

    guruTelahDiImport = false;

    document.getElementById('import-guru-modal').classList.add('show');
  }

  function tutupModalImportGuru() {
    document.getElementById('import-guru-modal').classList.remove('show');
    if (guruTelahDiImport) {
      guruTelahDiImport = false;
      bukaHalamanGuru();
    }
  }

  function downloadTemplateGuru() {
    setLoading(true, 'Membuat template guru...');
    hideMessage('template-guru-message');
    google.script.run
      .withSuccessHandler(onTemplateGuruReceived)
      .withFailureHandler(onGagal)
      .getGuruTemplateData(getToken());
  }

  function onTemplateGuruReceived(response) {
    setLoading(false);

    if (response.status === 'sukses') {
      showMessage('template-guru-message', 'Template berhasil dibuat. Mengunduh...', false);

      try {
        const dataUrl = `data:${response.mimeType};base64,${response.base64}`;

        const link = document.createElement('a');
        link.setAttribute('href', dataUrl);
        link.setAttribute('download', response.fileName);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);

        link.click();

        document.body.removeChild(link);

      } catch (e) {
        showMessage('template-guru-message', 'Gagal memproses unduhan di browser: ' + e.message, true);
      }

    } else {
      showMessage('template-guru-message', response.message, true);
    }
  }

  function prosesImportFileGuru() {
    setLoading(true, 'Mengimpor guru...');
    document.getElementById('import-guru-results').style.display = 'none';
    hideMessage('template-guru-message');
    const file = document.getElementById('file-upload-guru').files[0];
    if (!file) { setLoading(false); showMessage('template-guru-message', 'Pilih file Excel.', true); return; }
    const reader = new FileReader();
    reader.onload = (e) => {
      const fileData = { base64: e.target.result, mimeType: file.type, fileName: file.name };
      google.script.run.withSuccessHandler(onImportGuruFinished).withFailureHandler(onGagal).prosesImportExcelGuru(getToken(), fileData);
    };
    reader.onerror = (e) => { setLoading(false); showMessage('template-guru-message', 'Gagal baca file.', true); };
    reader.readAsDataURL(file);
  }

  function onImportGuruFinished(response) {
    setLoading(false);
    const resultsContainer = document.getElementById('import-guru-results');

    if (response.status !== 'sukses') {
      showMessage('template-guru-message', response.message, true);
      resultsContainer.style.display = 'none';
      return;
    }

    if (response.berhasilDiUpload > 0) {
      guruTelahDiImport = true;
    }

    let html = '<h4><i class="fas fa-check-circle"></i>Proses Import Selesai</h4>';
    html += `<p>Total data diproses: <strong>${response.totalDiProses}</strong></p>`;
    html += `<p style="color: var(--success-color);">Berhasil ditambah: <strong>${response.berhasilDiUpload}</strong></p>`;
    html += `<p style="color: var(--danger-color);">Gagal/Dilewati: <strong>${response.gagalDiUpload}</strong></p>`;

    if (response.dataGagal && response.dataGagal.length > 0) {
      html += `<hr><p><strong>Detail Data yang Gagal:</strong></p>`;
      html += '<table class="import-gagal-table">';
      html += '<tr><th>Baris</th><th>Nama</th><th>Email</th><th>Alasan Gagal</th></tr>';

      response.dataGagal.forEach(item => {
        html += `
          <tr>
            <td>${item.baris}</td>
            <td>${item.nama || '(Kosong)'}</td>
            <td>${item.email || '(Kosong)'}</td>
            <td>${item.alasan}</td>
          </tr>
        `;
      });
      html += '</table>';
    }

    resultsContainer.innerHTML = html;
    resultsContainer.style.display = 'block';

    document.getElementById('file-upload-guru').value = null;
    document.getElementById('btn-proses-import-guru').disabled = true;
  }

  /**
   * Menampilkan modal konfirmasi SEBELUM me-reset semua password.
   */
  function konfirmasiCetakKartu() {
    const title = "Konfirmasi Cetak Kartu & Reset Password";
    const message = `
      Anda akan membuat kartu login untuk <strong>semua guru</strong>.
      <br><br>
      <strong style="color: var(--danger-color); font-size: 16px;">PERINGATAN BESAR:</strong>
      <br>
      Tindakan ini akan <strong>MENGGANTI (MERESET)</strong> password SEMUA guru dengan password acak baru. Password lama mereka tidak akan berlaku lagi.
      <br><br>
      Yakin ingin melanjutkan?
    `;
    showConfirmationModal(title, message, jalankanCetakKartu, 'danger');
  }

  /**
   * Memanggil server untuk me-reset password dan mendapatkan data kartu.
   */
  function jalankanCetakKartu() {
    setLoading(true, 'Membuat password baru dan data kartu...', true, true);
    google.script.run
      .withSuccessHandler(onCetakKartuSuccess)
      .withFailureHandler(onGagal)
      .generateGuruLoginCards(getToken());
  }

  /**
   * Dipanggil setelah server berhasil membuat data kartu.
   * VERSI REVISI: Menggunakan <p> Teks Murni
   */
  function onCetakKartuSuccess(response) {
    setLoading(false);
    if (response.status !== 'sukses' || !response.cardData) {
      onGagal({ message: response.message || "Gagal mengambil data kartu." });
      return;
    }
    
    const websiteUrl = globalAppUrl + '#login-guru';
    const npsn = response.npsn || 'N/A'; 

    if (!globalAppUrl || websiteUrl.length < 20) { 
      console.error("Gagal mendapatkan URL website yang valid. URL:", websiteUrl);
      onGagal({ message: "Gagal mendapatkan URL aplikasi. Tidak dapat membuat QR code." });
      return;
    }

    const cardData = response.cardData;
    const container = document.getElementById('kartu-container');
    const page = document.getElementById('halaman-cetak-kartu');
    container.innerHTML = ''; 

    if (cardData.length === 0) {
      container.innerHTML = '<p>Tidak ada data guru untuk dicetak.</p>';
      page.style.display = 'block';
      return;
    }

    // 1. Buat HTML untuk semua kartu
    let cardsHtml = '';
    for (let i = 0; i < cardData.length; i++) {
      const guru = cardData[i];
      cardsHtml += `
        <div class="login-card">
          <h3>Kartu Login Guru</h3>
          <a class="login-card-qr"
             id="qr-guru-${i}" 
             href="${websiteUrl}" 
             target="_blank" 
             title="Pindai kode ini, atau klik untuk membuka link">
          </a>
          <p style="font-size: 12px; color: #333; margin: 5px 0 0 0; font-family: sans-serif; font-weight: 500;">
            Link: s.id/aplikasiijazah1
          </p>
          <div class="login-card-info">
            <strong>${guru.nama}</strong><br>
            NPSN: <strong>${npsn}</strong><br>
            Email: <strong>${guru.email}</strong><br>
            Password: <strong>${guru.newPassword}</strong>
          </div>
        </div>
      `;
    }
    container.innerHTML = cardsHtml;
    
    // 2. Tampilkan halaman cetak
    page.style.display = 'block';

    // 3. Generate QR Code
    setTimeout(() => {
      try {
        for (let i = 0; i < cardData.length; i++) {
          const qrElement = document.getElementById(`qr-guru-${i}`); 
          if (qrElement) {
            qrElement.innerHTML = ''; 
            new QRCode(qrElement, {
              text: websiteUrl,
              width: 160, 
              height: 160,
              colorDark : "#000000",
              colorLight : "#ffffff",
              correctLevel : QRCode.CorrectLevel.H 
            });
          } else {
            console.warn(`Elemen qr-guru-${i} tidak ditemukan.`);
          }
        }
      } catch (e) {
        console.error("Gagal membuat QR Code:", e);
        if (typeof QRCode === 'undefined') {
          showToast("Gagal memuat library QR Code. Periksa koneksi internet.", 'gagal');
        } else {
          showToast("Gagal membuat QR Code, terjadi error.", 'gagal');
        }
      }
    }, 50); 
    
    showToast(`Berhasil membuat ${cardData.length} kartu. Semua password guru telah direset.`, 'sukses');
  }

  function updatePremiumFeatures(status) {
    const isPremium = (status === "APPROVED");
    
    const btnGuru = document.getElementById('btn-buka-guru');
    const tabGuru = document.getElementById('tab-btn-guru');
    const tabSiswa = document.getElementById('tab-btn-siswa');
    const btnKelulusan = document.getElementById('btn-buka-kelola-kelulusan'); 
    const btnProsesKelulusan = document.getElementById('btn-buka-proses-kelulusan');
    const btnPenempatan = document.getElementById('btn-buka-penempatan');
    const btnTahunAjaran = document.getElementById('btn-buka-tahun-ajaran');
    const btnCetakKartuSiswa = document.getElementById('btn-cetak-kartu-siswa');
    const btnPengaturanCetak = document.getElementById('btn-buka-pengaturan-cetak');
    const btnKelolaNilaiGuru = document.getElementById('btn-buka-kelola-nilai-guru');
    
    if (btnGuru) {
      const stamp = btnGuru.querySelector('.premium-stamp');
      if (isPremium) {
        btnGuru.classList.remove('card-disabled');
        if (stamp) stamp.style.display = 'none';
      } else {
        btnGuru.classList.add('card-disabled'); 
        if (stamp) stamp.style.display = 'block';
      }
    }
    
    if (btnKelulusan) {
      const stamp = btnKelulusan.querySelector('.premium-stamp');
      if (isPremium) {
        btnKelulusan.classList.remove('card-disabled');
        if (stamp) stamp.style.display = 'none';
      } else {
        btnKelulusan.classList.add('card-disabled');
        if (stamp) stamp.style.display = 'block';
      }
    }

    if (btnProsesKelulusan) {
      const stamp = btnProsesKelulusan.querySelector('.premium-stamp');
      if (isPremium) {
        btnProsesKelulusan.classList.remove('card-disabled');
        if (stamp) stamp.style.display = 'none';
      } else {
        btnProsesKelulusan.classList.add('card-disabled');
        if (stamp) stamp.style.display = 'block';
      }
    }

    if (btnPenempatan) {
      const stamp = btnPenempatan.querySelector('.premium-stamp');
      if (isPremium) {
        btnPenempatan.classList.remove('card-disabled');
        if (stamp) stamp.style.display = 'none';
      } else {
        btnPenempatan.classList.add('card-disabled');
        if (stamp) stamp.style.display = 'block';
      }
    }
    
    if (btnTahunAjaran) {
      const stamp = btnTahunAjaran.querySelector('.premium-stamp');
      if (isPremium) {
        btnTahunAjaran.classList.remove('card-disabled');
        if (stamp) stamp.style.display = 'none';
      } else {
        btnTahunAjaran.classList.add('card-disabled');
        if (stamp) stamp.style.display = 'block';
      }
    }
    
    if (btnCetakKartuSiswa) {
      // Kita tidak perlu mencari stamp, karena sudah dihapus dari HTML
      const stamp = btnCetakKartuSiswa.querySelector('.premium-stamp');
      if (isPremium) {
        btnCetakKartuSiswa.classList.remove('card-disabled');
        if (stamp) stamp.style.display = 'none'; // Jaga jika ada
      } else {
        btnCetakKartuSiswa.classList.add('card-disabled');
        if (stamp) stamp.style.display = 'block'; // Jaga jika ada
      }
    }

    if (btnPengaturanCetak) {
      const stamp = btnPengaturanCetak.querySelector('.premium-stamp');
      if (isPremium) {
        btnPengaturanCetak.classList.remove('card-disabled');
        if (stamp) stamp.style.display = 'none';
      } else {
        btnPengaturanCetak.classList.add('card-disabled');
        if (stamp) stamp.style.display = 'block';
      }
    }
    
    if (btnKelolaNilaiGuru) {
      const stamp = btnKelolaNilaiGuru.querySelector('.premium-stamp');
      if (isPremium) {
        btnKelolaNilaiGuru.classList.remove('card-disabled');
        if (stamp) stamp.style.display = 'none';
      } else {
        btnKelolaNilaiGuru.classList.add('card-disabled');
        if (stamp) stamp.style.display = 'block';
      }
    }

    if (tabGuru) {
      tabGuru.disabled = !isPremium;
      tabGuru.title = isPremium ? "Login sebagai Guru" : "Fitur Premium - Donasi untuk aktivasi";
    }
    
    if (tabSiswa) {
      tabSiswa.disabled = !isPremium;
      tabSiswa.title = isPremium ? "Cek Kelulusan Siswa" : "Fitur Premium - Donasi untuk aktivasi";
    }
  }

  /**
   * [BARU] Membuka halaman donasi dan menampilkan state yang sesuai.
   */
  function bukaHalamanDonasi() {
    tampilHalaman('halaman-donasi');
    
    // Sembunyikan semua state
    document.getElementById('donasi-state-form').style.display = 'none';
    document.getElementById('donasi-state-pending').style.display = 'none';
    document.getElementById('donasi-state-approved').style.display = 'none';
    document.getElementById('donasi-state-rejected').style.display = 'none';
    hideMessage('donasi-message');
    
    // Reset form
    document.getElementById('form-donasi').reset();
    const fileUploadText = document.getElementById('file-upload-text-donasi');
    fileUploadText.innerText = 'Klik untuk memilih file...';
    fileUploadText.classList.remove('file-chosen');

    // Panggil server untuk data terbaru (termasuk URL file / alasan)
    setLoading(true, 'Memeriksa status donasi...', false);
    google.script.run
      .withSuccessHandler(onDonasiStatusLoaded)
      .withFailureHandler(onGagal)
      .getDonasiStatusDetail(getToken());
  }

  /**
   * [BARU] Callback setelah status donasi detail dimuat.
   */
  function onDonasiStatusLoaded(response) {
    setLoading(false);
    if (response.status !== 'sukses') {
      showToast(response.message, 'gagal');
      document.getElementById('donasi-state-form').style.display = 'block';
      return;
    }
    
    // --- PERBARUI FUNGSI INI ---
    const donasi = response.donasi;
    const admin = response.admin; // Ambil data admin
    
    globalDonasiStatus = donasi.status;
    globalDonasiDetail = donasi; // Simpan detail (fileUrl, alasan, dll)

    // Isi field yang terkunci
    if (admin) {
      document.getElementById('donasi-email').value = admin.email || '';
      document.getElementById('donasi-nama-sekolah').value = admin.namaSekolah || '';
    }
    // --- AKHIR PERBARUAN ---

    if (donasi.status === 'PENDING') {
      document.getElementById('donasi-state-pending').style.display = 'block';
      let dataHtml = "Data donasi tidak ada.";
      if (donasi.dataJson) {
        try {
          const data = JSON.parse(donasi.dataJson);
          // Format Angka ke Rupiah
          const jumlahRp = Number(data.jumlah || 0).toLocaleString('id-ID');
          
          // PERBAIKAN: Gunakan data.namaRekening (bukan data.nama) dan tambahkan data.metode
          dataHtml = `
            <strong>Metode:</strong> ${data.metode || 'N/A'}<br>
            <strong>Nama Pengirim:</strong> ${data.namaRekening || 'N/A'}<br>
            <strong>Jumlah:</strong> Rp ${jumlahRp}
          `;
        } catch(e) {
          dataHtml = "<em>Gagal memuat detail donasi.</em>";
        }
      }
      document.getElementById('donasi-pending-data').innerHTML = dataHtml;
      
    } else if (donasi.status === 'APPROVED') {
      document.getElementById('donasi-state-approved').style.display = 'block';
      
    } else if (donasi.status === 'REJECTED') {
      document.getElementById('donasi-state-rejected').style.display = 'block';
      
      //  INI LOGIKA YANG DIMAKSUD 
      document.getElementById('donasi-rejected-reason').innerText = `Alasan: ${donasi.alasan || "Tidak ada alasan."}`;
      //  INI LOGIKA YANG DIMAKSUD 

      // Tampilkan form di bawah pesan reject
      document.getElementById('donasi-state-form').style.display = 'block'; 
      
    } else { // 'NONE'
      document.getElementById('donasi-state-form').style.display = 'block';
    }
    
    // Panggil lagi untuk memastikan UI dashboard (jika ada) sinkron
    updatePremiumFeatures(globalDonasiStatus);
  }

  /**
   * [BARU] Mengirimkan form donasi.
   * --- FUNGSI INI DIPERBARUI TOTAL ---
   */
  function submitDonasiForm() {
    hideMessage('donasi-message');
    
    // Ambil data dari form baru
    const metode = document.getElementById('donasi-metode').value;
    const namaRekening = document.getElementById('donasi-nama-rekening').value.trim();
    const jumlah = document.getElementById('donasi-jumlah').value;
    const fileInput = document.getElementById('donasi-file');
    const file = fileInput.files[0];
    
    if (!metode) {
      showMessage('donasi-message', 'Silakan pilih metode pembayaran.', true);
      return;
    }
    if (!namaRekening) {
      showMessage('donasi-message', 'Nama pemilik rekening/e-wallet wajib diisi.', true);
      return;
    }
    if (!jumlah) {
      showMessage('donasi-message', 'Jumlah donasi wajib diisi.', true);
      return;
    }
    if (!file) {
      showMessage('donasi-message', 'Bukti transfer (file) wajib diunggah.', true);
      return;
    }
    
    setButtonLoading(document.getElementById('btn-kirim-donasi'), 'Mengunggah file...');
    
    const reader = new FileReader();
    reader.onload = (e) => {
      const fileData = { 
        base64: e.target.result, 
        mimeType: file.type, 
        fileName: file.name 
      };
      
      // Buat JSON baru
      const formDataJSON = JSON.stringify({
        metode: metode,
        namaRekening: namaRekening,
        jumlah: jumlah
      });
      
      google.script.run
        .withSuccessHandler(onDonasiSelesai)
        .withFailureHandler(onGagalKirimDonasi)
        .submitDonasi(getToken(), fileData, formDataJSON); // Fungsi backend tetap sama
    };
    reader.onerror = (e) => {
      onGagalKirimDonasi({ message: 'Gagal membaca file.' });
    };
    reader.readAsDataURL(file);
  }

  function onDonasiSelesai(response) {
    resetButtonLoading(document.getElementById('btn-kirim-donasi'));
    if (response.status === 'sukses') {
      globalDonasiStatus = response.donasiStatus;
      bukaHalamanDonasi(); // Muat ulang halaman untuk tampilkan status PENDING
      showToast("Bukti donasi berhasil dikirim!", 'sukses');
    } else {
      onGagalKirimDonasi(response);
    }
  }

  function onGagalKirimDonasi(error) {
    resetButtonLoading(document.getElementById('btn-kirim-donasi'));
    showMessage('donasi-message', error.message, true);
  }

  /**
   * [BARU] Konfirmasi pembatalan donasi.
   */
  function konfirmasiBatalkanDonasi() {
    const title = "Batalkan Donasi";
    const message = "Anda yakin ingin membatalkan pengajuan donasi ini? Bukti transfer Anda akan dihapus.";
    const callback = function() {
      setLoading(true, 'Membatalkan...');
      google.script.run
        .withSuccessHandler(onDonasiDibatalkan)
        .withFailureHandler(onGagal)
        .batalkanDonasi(getToken());
    };
    showConfirmationModal(title, message, callback, 'danger');
  }

  function onDonasiDibatalkan(response) {
    setLoading(false);
    if (response.status === 'sukses') {
      globalDonasiStatus = response.donasiStatus;
      bukaHalamanDonasi(); // Muat ulang halaman (akan kembali ke form)
      showToast("Donasi dibatalkan.", 'sukses');
    } else {
      onGagal(response);
    }
  }

  /**
   * [BARU] Merender daftar donasi pending untuk Superadmin.
   */
  function renderDonasiList(response) {
    const container = document.getElementById('superadmin-donasi-list');
    if (response.status !== 'sukses') {
      container.innerHTML = `<p class="message error" style="display:block;">Gagal memuat donasi: ${response.message}</p>`;
      return;
    }
    
    const list = response.pendingList;
    if (list.length === 0) {
      container.innerHTML = '<p style="text-align: center; padding: 15px 0; color: var(--text-light);">Tidak ada donasi yang menunggu verifikasi.</p>';
      return;
    }
    
    let html = '';
    list.forEach(item => {
      // --- BLOK INI AKAN DIMODIFIKASI ---
      let dataHtml = '<p class="donasi-detail-item"><em>Data form tidak tersedia.</em></p>';
      if (item.dataJson) {
        try {
          const data = JSON.parse(item.dataJson);
          // Format Angka ke Rupiah
          const jumlahRp = Number(data.jumlah || 0).toLocaleString('id-ID');
          
          dataHtml = `
            <div class="donasi-detail-list">
              <span class="donasi-detail-item"><strong>Metode:</strong> ${data.metode || 'N/A'}</span>
              <span class="donasi-detail-item"><strong>Pengirim:</strong> ${data.namaRekening || 'N/A'}</span>
              <span class="donasi-detail-item"><strong>Jumlah:</strong> Rp ${jumlahRp}</span>
            </div>
          `;
        } catch(e) {
          dataHtml = `<p class="donasi-detail-item"><em>Gagal memuat data donasi.</em></p>`;
        }
      }
      // --- AKHIR MODIFIKASI ---
      
      html += `
        <div class="donasi-card">
          <h4>${item.namaSekolah}</h4>
          <p>${dataHtml}</p>
          <div class="donasi-card-actions">
            <button class="btn-aksi btn-donasi-lihat" data-url="${item.fileUrl || '#'}"><i class="fas fa-search"></i>Lihat Bukti</button>
            <button class="btn-aksi btn-donasi-tolak" data-id="${item.sekolahID}"><i class="fas fa-times"></i>Tolak</button>
            <button class="btn-aksi btn-donasi-setujui" data-id="${item.sekolahID}"><i class="fas fa-check"></i>Setujui</button>
          </div>
        </div>
      `;
    });
    container.innerHTML = html;
  }

  /**
   * [BARU] Handler untuk tombol Setujui/Tolak Superadmin.
   * --- FUNGSI INI DIMODIFIKASI (HANYA MENANGANI 'SETUJUI') ---
   */
  function handleDonasiVerify(sekolahID, isApproved) {
    // Fungsi ini sekarang HANYA menangani 'isApproved = true'
    // Kasus 'Tolak' (isApproved = false) ditangani langsung oleh event listener di atas
    if (!isApproved) {
      console.error("handleDonasiVerify dipanggil untuk 'Tolak'. Ini seharusnya tidak terjadi.");
      return;
    }

    const actionText = 'Menyetujui';
    setLoading(true, `${actionText} donasi...`);
    
    google.script.run
      .withSuccessHandler(onDonasiDiverifikasi)
      .withFailureHandler(onGagal)
      .verifikasiDonasi(getToken(), sekolahID, true, ""); // Alasan kosong untuk 'Setujui'
  }

  function onDonasiDiverifikasi(response) {
    setLoading(false);
    if (response.status === 'sukses') {
      showToast(response.message, 'sukses');
      bukaHalamanSuperadmin(); // Muat ulang daftar donasi dan sekolah
    } else {
      onGagal(response);
    }
  }

  // --- TAMBAHKAN FUNGSI-FUNGSI BARU DI BAWAH INI ---
  
  /**
   * [BARU] Menampilkan modal kustom untuk meminta alasan.
   */
  function showAlasanModal(title, message, sekolahID, sekolahNama, onConfirmCallback) {
    const modal = document.getElementById('alasan-modal');
    hideMessage('alasan-modal-error');
    
    document.getElementById('alasan-modal-title').innerText = title;
    document.getElementById('alasan-modal-message').innerHTML = message;
    document.getElementById('alasan-modal-nama-sekolah').innerText = sekolahNama;
    document.getElementById('alasan-modal-input').value = '';
    
    // Simpan data & callback di elemen modal untuk diambil nanti
    modal.dataset.sekolahId = sekolahID;
    modal.onConfirm = onConfirmCallback;
    
    modal.classList.add('show');
    document.getElementById('alasan-modal-input').focus();
  }

  /**
   * [BARU] Menutup modal alasan.
   */
  function tutupAlasanModal() {
    const modal = document.getElementById('alasan-modal');
    modal.classList.remove('show');
    modal.dataset.sekolahId = '';
    modal.onConfirm = null;
    hideMessage('alasan-modal-error');
  }

  /**
   * [BARU] Menangani klik OK pada modal alasan.
   */
  function handleAlasanConfirm() {
    const modal = document.getElementById('alasan-modal');
    const alasanInput = document.getElementById('alasan-modal-input');
    const alasan = alasanInput.value.trim();
    
    if (alasan === "") {
      showMessage('alasan-modal-error', 'Alasan pembatalan tidak boleh kosong.', true);
      alasanInput.focus();
      return;
    }
    
    if (typeof modal.onConfirm === 'function') {
      const sekolahID = modal.dataset.sekolahId;
      modal.onConfirm(sekolahID, alasan); // Panggil callback asli
    }
    
    tutupAlasanModal();
  }

  /**
   * [SUPERADMIN] Konfirmasi pembatalan premium.
   * --- FUNGSI INI DIMODIFIKASI UNTUK MENGGUNAKAN MODAL BARU ---
   */
  function konfirmasiBatalkanPremium(sekolahID, namaSekolah) { 
    const title = "Batalkan Status Premium";
    const message = `Masukkan alasan pembatalan untuk sekolah: <strong><span id="alasan-modal-nama-sekolah"></span></strong>`;

    // Callback yang akan dijalankan oleh modal kustom saat di-OK
    const callback = function(id, alasan) {
      setLoading(true, 'Membatalkan status premium...');
      google.script.run
        .withSuccessHandler(onPremiumDibatalkan)
        .withFailureHandler(onGagal)
        .superadminBatalkanPremium(getToken(), id, alasan); // Kirim 'id' dan 'alasan' dari modal
    };

    // Tampilkan modal kustom baru
    showAlasanModal(title, message, sekolahID, namaSekolah, callback);
  }

  /**
   * [SUPERADMIN] Callback setelah premium dibatalkan.
   */
  function onPremiumDibatalkan(response) {
    setLoading(false);
    if (response.status === 'sukses') {
      showToast(response.message, 'sukses');
      bukaHalamanSuperadmin(); // Muat ulang daftar sekolah
    } else {
      showMessage('superadmin-message', response.message, true);
    }
  }

  /* --- ============================================= --- */
  /* ---      INISIALISASI SLIDER DONASI (SWIPER)      --- */
  /* --- ============================================= --- */

  // Pastikan kode ini ada DI LUAR (setelah) fungsi-fungsi lain
  // Ia akan otomatis berjalan saat halaman dimuat

  var donasiSwiper = new Swiper(".donasi-slider", {
    // Opsi Loop (Kembali ke awal setelah slide terakhir)
    loop: true,

    // Indikator Titik-titik
    pagination: {
      el: ".swiper-pagination",
      clickable: true,
    },

    // Tombol Panah Kanan/Kiri
    navigation: {
      nextEl: ".swiper-button-next",
      prevEl: ".swiper-button-prev",
    },
    
    // Bonus: Otomatis hentikan video YouTube saat slide diganti
    on: {
      slideChange: function () {
        try {
          // Cari semua iframe di dalam slider (LOGIKA ASLI)
          var iframes = this.el.querySelectorAll('iframe');
          iframes.forEach(function(iframe) {
            // Reset 'src'-nya untuk menghentikan video
            var iframeSrc = iframe.src;
            iframe.src = iframeSrc; 
          });

          /* --- =================================== --- */
          /* ---      TAMBAHAN BARU DI SINI        --- */
          /* --- =================================== --- */
          // Hentikan juga player API jika ada
          if (ytPlayerDonasi && typeof ytPlayerDonasi.stopVideo === 'function') {
            ytPlayerDonasi.stopVideo();
          }
          // Pastikan nav tampil lagi saat slide diganti
          const sliderEl = document.querySelector('.donasi-slider');
          if (sliderEl) {
              sliderEl.classList.remove('video-is-playing');
          }
          /* --- =================================== --- */
          /* ---      AKHIR TAMBAHAN BARU          --- */
          /* --- =================================== --- */

        } catch (e) {
          console.warn("Gagal menghentikan video:", e);
        }
      },
    }
  });

  /* --- ============================================= --- */
  /* ---      KODE BARU: KONTROL VIDEO YOUTUBE         --- */
  /* --- ============================================= --- */

  // 1. Variabel global untuk player
  let ytPlayerDonasi = null;

  /**
   * 2. Fungsi ini dipanggil otomatis oleh API YouTube (dari index.html)
   * saat API siap.
   */
  function onYouTubeIframeAPIReady() {
    const playerElement = document.getElementById('youtube-player-donasi');
    if (playerElement) {
      try {
        ytPlayerDonasi = new YT.Player('youtube-player-donasi', {
          events: {
            'onReady': onPlayerReady,
            'onStateChange': onPlayerStateChange
          }
        });
      } catch(e) {
        console.error("Gagal menginisialisasi YouTube Player API:", e);
      }
    }
  }

  /**
   * 3. Dipanggil saat player siap.
   */
  function onPlayerReady(event) {
    // Player siap. Kita tambahkan listener untuk menampilkan kembali nav
    const sliderEl = document.querySelector('.donasi-slider');
    if (sliderEl) {
      // Listener untuk "kursor diarahkan ke video/slider"
      sliderEl.addEventListener('mouseenter', showSliderNav);
      // Listener untuk "halaman diklik"
      document.addEventListener('click', showSliderNav);
    }
  }

  /**
   * 4. Fungsi untuk menangani perubahan status player (Play, Pause, dll.)
   */
  function onPlayerStateChange(event) {
    const sliderEl = document.querySelector('.donasi-slider');
    if (!sliderEl) return;

    if (event.data == YT.PlayerState.PLAYING) {
      // Saat video diputar: Sembunyikan navigasi
      sliderEl.classList.add('video-is-playing');
    } else {
      // Saat video dijeda, selesai, atau buffering: Tampilkan navigasi
      sliderEl.classList.remove('video-is-playing');
    }
  }

  /**
   * 5. Fungsi helper untuk menampilkan navigasi (dipanggil oleh listener)
   */
  function showSliderNav() {
    const sliderEl = document.querySelector('.donasi-slider');
    if (sliderEl) {
      sliderEl.classList.remove('video-is-playing');
    }
  }
  /* --- ============================================= --- */
  /* ---      AKHIR KODE BARU                        --- */
  /* --- ============================================= --- */

  /**
   * [BARU] Fungsi untuk memvalidasi format Kode Mapel (3-5 char, alphanumeric).
   * @returns {boolean} - true jika valid, false jika format salah.
   */
  function validateMapelIdFormat() {
    const input = document.getElementById('modal-mapel-id');
    const tooltip = document.getElementById('modal-mapel-id-tooltip');
    const ruleLi = document.getElementById('mapel-id-rules');
    if (!input || !tooltip || !ruleLi) return true; // Anggap valid jika elemen hilang

    const value = input.value.trim();

    // 1. Jika kosong, sembunyikan & valid (biarkan simpanMapel yg menangani required)
    if (value.length === 0) {
      tooltip.classList.remove('show');
      input.classList.remove('input-error');
      return true;
    }

    // 2. Cek karakter (hanya huruf dan angka)
    if (!/^[a-zA-Z0-9]+$/.test(value)) {
      ruleLi.innerText = 'Kode Mapel hanya boleh huruf dan angka (tanpa spasi/simbol).';
      tooltip.classList.add('show');
      input.classList.add('input-error');
      return false;
    }
    
    // 3. Cek panjang
    if (value.length < 2) {
      ruleLi.innerText = 'Kode Mapel harus terdiri dari 2-5 karakter.';
      tooltip.classList.add('show');
      input.classList.add('input-error');
      return false;
    }
    
    // 4. Cek panjang (max sudah ditangani HTML, tapi validasi lagi)
    if (value.length > 5) {
      ruleLi.innerText = 'Kode Mapel tidak boleh lebih dari 5 karakter.';
      tooltip.classList.add('show');
      input.classList.add('input-error');
      return false;
    }

    // 5. Lolos semua
    tooltip.classList.remove('show');
    input.classList.remove('input-error');
    return true;
  }

  /**
   * [FUNGSI BARU]
   * Memuat data grid nilai (UM dan Praktek) di latar belakang.
   * Dipanggil saat membuka halaman sub-menu "Input Nilai Ujian".
   */
  function preloadNilaiGrids() {
    console.log("Memulai pre-load data grid nilai...");
    
    // Cek dan muat UM
    if (globalNilaiGridCacheUM === null) {
      console.log("Pre-loading: UM...");
      google.script.run
        .withSuccessHandler((response) => {
          if(response.status === 'sukses') {
            globalNilaiGridCacheUM = response; // Simpan seluruh respons
            console.log("Pre-loading: UM Selesai.");
          } else {
            console.warn("Pre-loading: UM Gagal:", response.message);
            globalNilaiGridCacheUM = { status: 'gagal', message: response.message }; // Simpan error
          }
        })
        .withFailureHandler((error) => {
          console.error("Pre-loading: UM Gagal (Fatal):", error.message);
          globalNilaiGridCacheUM = { status: 'gagal', message: error.message }; // Simpan error
        })
        .getNilaiUjianGridData(getToken(), 'UM');
    } else {
      console.log("Pre-loading: UM (sudah di cache).");
    }

    // Cek dan muat Praktek
    if (globalNilaiGridCachePraktek === null) {
      console.log("Pre-loading: Praktek...");
      google.script.run
        .withSuccessHandler((response) => {
          if(response.status === 'sukses') {
            globalNilaiGridCachePraktek = response; // Simpan seluruh respons
            console.log("Pre-loading: Praktek Selesai.");
          } else {
            console.warn("Pre-loading: Praktek Gagal:", response.message);
            globalNilaiGridCachePraktek = { status: 'gagal', message: response.message }; // Simpan error
          }
        })
        .withFailureHandler((error) => {
          console.error("Pre-loading: Praktek Gagal (Fatal):", error.message);
          globalNilaiGridCachePraktek = { status: 'gagal', message: error.message }; // Simpan error
        })
        .getNilaiUjianGridData(getToken(), 'Praktek');
    } else {
      console.log("Pre-loading: Praktek (sudah di cache).");
    }
  }

  /**
   * [FUNGSI BARU]
   * Memuat data grid nilai rapor untuk semua semester di latar belakang.
   * Dipanggil saat membuka halaman sub-menu "Input Nilai Rapor".
   */
  function preloadNilaiRaporGrids(semesterList) {
    if (!semesterList || semesterList.length === 0) return;
    
    console.log("Memulai pre-load data grid nilai rapor...");
    
    semesterList.forEach(semester => {
      const semesterId = semester.id;
      
      // Cek apakah sudah ada di cache atau sedang loading
      const existingCache = globalNilaiRaporGridCache.get(semesterId);
      if (!existingCache || existingCache.status === 'gagal') {
        
        console.log(`Pre-loading: Rapor (${semesterId})...`);
        
        // Set cache ke status 'loading' untuk mencegah panggilan ganda
        globalNilaiRaporGridCache.set(semesterId, { status: 'loading' }); 
        
        google.script.run
          .withSuccessHandler((response) => {
            // Server merespons, simpan hasil (baik sukses atau gagal)
            globalNilaiRaporGridCache.set(semesterId, response); 
            if (response.status === 'sukses') {
              console.log(`Pre-loading: Rapor (${semesterId}) Selesai.`);
            } else {
              console.warn(`Pre-loading: Rapor (${semesterId}) Gagal:`, response.message);
            }
          })
          .withFailureHandler((error) => {
            // Jika server call gagal total
            const errorResponse = { status: 'gagal', message: error.message };
            globalNilaiRaporGridCache.set(semesterId, errorResponse); // Simpan respons error
            console.error(`Pre-loading: Rapor (${semesterId}) Gagal (Fatal):`, error.message);
          })
          .getNilaiRaporGridData(getToken(), semesterId);
      } else {
         console.log(`Pre-loading: Rapor (${semesterId}) (sudah di cache atau sedang dimuat).`);
      }
    });
  }

  /**
   * [FUNGSI BARU]
   * Mengaktifkan atau menonaktifkan SEMUA tombol ekspor (PDF/Excel)
   * di halaman Nilai Ijazah.
   * @param {boolean} isDisabled - True untuk menonaktifkan, false untuk mengaktifkan.
   */
  function setIjazahExportButtonsDisabled(isDisabled) {
    const page = document.getElementById('halaman-nilai-ijazah');
    if (!page) return;
    
    // Temukan semua tombol ekspor di dalam halaman Ijazah
    const exportButtons = page.querySelectorAll('.btn-export-icon');
    
    exportButtons.forEach(btn => {
      btn.disabled = isDisabled; // Atur status disabled
      
      // Ubah tampilan visual agar terlihat nonaktif
      if (isDisabled) {
        btn.style.opacity = '0.5';
        btn.style.cursor = 'not-allowed';
      } else {
        btn.style.opacity = '1';
        btn.style.cursor = 'pointer';
      }
    });
  }

  function bukaHalamanProsesKelulusan() {
    tampilHalaman('halaman-proses-kelulusan');
    hideMessage('proses-kelulusan-message');
    
    const inputKonfirmasi = document.getElementById('input-konfirmasi-nama-sekolah');
    const btnProses = document.getElementById('btn-proses-kelulusan');
    const labelNama = document.getElementById('nama-sekolah-untuk-konfirmasi');
    const hiddenNama = document.getElementById('nama-sekolah-hidden-konfirmasi');
    
    inputKonfirmasi.value = '';
    btnProses.disabled = true;
    labelNama.innerText = 'Memuat...';
    hiddenNama.value = '';

    // --- [TAMBAHAN BARU] ---
    const halaman = document.getElementById('halaman-proses-kelulusan');
    const isPremium = (globalDonasiStatus === 'APPROVED');

    const oldInfoBox = document.getElementById('proses-kelulusan-premium-info');
    if (oldInfoBox) {
      oldInfoBox.remove();
    }

    if (isPremium) {
      halaman.classList.remove('non-premium-readonly');
      inputKonfirmasi.disabled = false; // Aktifkan input jika premium
    } else {
      halaman.classList.add('non-premium-readonly');
      inputKonfirmasi.disabled = true; // Nonaktifkan input jika non-premium
      
      const infoBox = document.createElement('div');
      infoBox.id = 'proses-kelulusan-premium-info';
      infoBox.className = 'premium-info-box';
      infoBox.innerHTML = '<i class="fas fa-star"></i>Ini adalah Fitur Premium. Anda dapat melihat halaman ini, tetapi tidak dapat menjalankan proses tutup tahun ajaran. Silakan <a href="#" id="link-donasi-dari-proses-kelulusan">Donasi</a> untuk mengaktifkan fitur ini.';
      
      const pageHeader = halaman.querySelector('.page-header');
      if (pageHeader) {
        pageHeader.insertAdjacentElement('afterend', infoBox);
      }
      
      const linkDonasi = document.getElementById('link-donasi-dari-proses-kelulusan');
      if (linkDonasi) {
        linkDonasi.addEventListener('click', (e) => {
          e.preventDefault();
          bukaHalamanDonasi();
        });
      }
    }
    // --- [AKHIR TAMBAHAN BARU] ---

    // Panggil server untuk mendapatkan nama sekolah (logika asli)
    setLoading(true, 'Memuat data sekolah...', false, true);
    google.script.run
      .withSuccessHandler(onNamaSekolahForProsesLoaded)
      .withFailureHandler(onGagal)
      .getNamaSekolah(getToken());
  }

  /**
   * [BARU] Callback setelah nama sekolah didapat.
   */
  function onNamaSekolahForProsesLoaded(response) {
    setLoading(false);
    if (response.status === 'sukses') {
      document.getElementById('nama-sekolah-untuk-konfirmasi').innerText = response.namaSekolah;
      document.getElementById('nama-sekolah-hidden-konfirmasi').value = response.namaSekolah;
    } else {
      document.getElementById('nama-sekolah-untuk-konfirmasi').innerText = '(Gagal Memuat)';
      showMessage('proses-kelulusan-message', 'Gagal memuat nama sekolah. Tidak dapat melanjutkan.', true);
    }
  }

  /**
   * [BARU] Memvalidasi input konfirmasi nama sekolah.
   */
  function validasiKonfirmasiNamaSekolah() {
    const inputKonfirmasi = document.getElementById('input-konfirmasi-nama-sekolah').value;
    const namaSekolahAsli = document.getElementById('nama-sekolah-hidden-konfirmasi').value;
    const btnProses = document.getElementById('btn-proses-kelulusan');
    
    if (namaSekolahAsli && inputKonfirmasi === namaSekolahAsli) {
      btnProses.disabled = false;
    } else {
      btnProses.disabled = true;
    }
  }

  /**
   * [BARU] Menjalankan proses utama: 1. Backup, 2. Hapus.
   */
  function jalankanProsesKelulusan() {
    // Langkah 1: Panggil backup
    setLoading(true, 'Membuat file backup database... Ini mungkin perlu waktu beberapa saat.', true, true);
    hideMessage('proses-kelulusan-message');
    
    google.script.run
      .withSuccessHandler(onBackupDownloaded) // Handler kustom
      .withFailureHandler(onGagal) // Handler onGagal biasa
      .getBackupDatabaseExcel(getToken()); // Fungsi backend baru
  }

  /**
   * [BARU] Callback setelah file backup berhasil dibuat.
   */
  function onBackupDownloaded(response) {
    setLoading(false); // Matikan loading "Membuat backup..."
    
    if (response.status === 'sukses') {
      // 1. Picu download di browser
      try {
        const dataUrl = `data:${response.mimeType};base64,${response.base64}`;
        const link = document.createElement('a');
        link.setAttribute('href', dataUrl);
        link.setAttribute('download', response.fileName);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      } catch (e) {
        showMessage('proses-kelulusan-message', 'Gagal memicu download: ' + e.message, true);
        return; // Hentikan proses jika download gagal
      }
      
      // 2. Tampilkan toast perantara
      showToast("Backup berhasil diunduh. Memulai pembersihan data...", 'sukses', 3000);
      
      // 3. Panggil proses penghapusan data
      setLoading(true, 'Menghapus data siswa dan nilai... Harap jangan tutup halaman.', true, true);
      
      google.script.run
        .withSuccessHandler(onPembersihanSelesai)
        .withFailureHandler(onGagal)
        .hapusSemuaDataSiswaDanNilai(getToken()); // Fungsi backend baru
        
    } else {
      showMessage('proses-kelulusan-message', 'Gagal membuat file backup: ' + response.message, true);
    }
  }

  /**
   * [BARU] Callback setelah semua data dihapus.
   */
  function onPembersihanSelesai(response) {
    setLoading(false);
    
    if (response.status === 'sukses') {
      // Bersihkan semua cache di sisi klien
      globalSiswaList = [];
      globalGuruList = []; // Juga hapus data guru
      globalKelasListCache = [];
      globalNilaiGridCacheUM = null;
      globalNilaiGridCachePraktek = null;
      globalNilaiRaporGridCache.clear();
      globalIjazahData = { siswaList: [], mapelList: [], dataUjian: {}, dataRapor: {}, dataIjazah: {} };
      
      // Tampilkan notifikasi sukses dan kembali ke dasbor
      showToast('Proses Kelulusan Selesai. Data siswa, guru, dan nilai telah dihapus.', 'sukses', 5000);
      tampilHalaman('halaman-utama');
      
    } else {
      showMessage('proses-kelulusan-message', 'Gagal menghapus data: ' + response.message, true);
    }
  }

  /**
   * [BARU] Menampilkan konfirmasi sebelum mencetak kartu siswa.
   */
  function konfirmasiCetakKartuSiswa() {
    const title = "Konfirmasi Cetak Kartu Siswa";
    const message = `
      Anda akan membuat kartu cek kelulusan untuk <strong>semua siswa</strong>.
      <br><br>
      Kartu ini akan berisi Nama, NISN, dan Tanggal Lahir yang digunakan siswa untuk login. Siswa yang tidak memiliki NISN atau Tgl. Lahir tidak akan dicetak.
      <br><br>
      Yakin ingin melanjutkan?
    `;
    showConfirmationModal(title, message, jalankanCetakKartuSiswa, 'primary'); // 'primary' (biru)
  }

  /**
   * [BARU] Memanggil server untuk mendapatkan data kartu siswa.
   */
  function jalankanCetakKartuSiswa() {
    setLoading(true, 'Membuat data kartu siswa...', true, true);
    google.script.run
      .withSuccessHandler(onCetakKartuSiswaSuccess)
      .withFailureHandler(onGagal)
      .generateSiswaLoginCards(getToken());
  }

  /**
   * [BARU - DIPERBARUI] Dipanggil setelah server berhasil membuat data kartu siswa.
   */
  function onCetakKartuSiswaSuccess(response) {
    setLoading(false);
    if (response.status !== 'sukses' || !response.cardData) {
      onGagal({ message: response.message || "Gagal mengambil data kartu." });
      return;
    }
    
    // Dapatkan URL dari respons, atau buat dari globalAppUrl jika tidak ada
    const websiteUrl = response.websiteUrl || (globalAppUrl + '#login-siswa');
    const cardData = response.cardData;
    const container = document.getElementById('kartu-container');
    const page = document.getElementById('halaman-cetak-kartu');
    container.innerHTML = ''; 

    if (cardData.length === 0) {
      container.innerHTML = '<p>Tidak ada data siswa yang memiliki NISN dan Tanggal Lahir lengkap untuk dicetak.</p>';
      page.style.display = 'block';
      return;
    }

    // 1. Buat HTML untuk semua kartu
    let cardsHtml = '';
    for (let i = 0; i < cardData.length; i++) {
      const siswa = cardData[i];
      cardsHtml += `
        <div class="login-card">
          <h3>Kartu Cek Kelulusan Siswa</h3>
          <a class="login-card-qr"
             id="qr-siswa-${i}" 
             href="${websiteUrl}" 
             target="_blank" 
             title="Pindai kode ini, atau klik untuk membuka link">
          </a>
          <p style="font-size: 12px; color: #333; margin: 5px 0 0 0; font-family: sans-serif; font-weight: 500;">
            Link: s.id/aplikasiijazah1
          </p>
          <div class="login-card-info">
            <strong>${siswa.nama}</strong><br>
            NISN: <strong>${siswa.nisn}</strong><br>
            Tgl. Lahir: <strong>${siswa.tglLahir}</strong>
          </div>
        </div>
      `;
    }
    container.innerHTML = cardsHtml;
    
    // 2. Tampilkan halaman cetak
    page.style.display = 'block';

    // 3. Generate QR Code
    setTimeout(() => {
      try {
        for (let i = 0; i < cardData.length; i++) {
          const qrElement = document.getElementById(`qr-siswa-${i}`); 
          if (qrElement) {
            qrElement.innerHTML = ''; 
            new QRCode(qrElement, {
              text: websiteUrl,
              width: 160,
              height: 160,
              colorDark : "#000000",
              colorLight : "#ffffff",
              correctLevel : QRCode.CorrectLevel.H
            });
          }
        }
      } catch (e) {
        console.error("Gagal membuat QR Code siswa:", e);
        if (typeof QRCode === 'undefined') {
          showToast("Gagal memuat library QR Code. Periksa koneksi.", 'gagal');
        } else {
          showToast("Gagal membuat QR Code, terjadi error.", 'gagal');
        }
      }
    }, 50); 
    
    showToast(`Berhasil membuat ${cardData.length} kartu siswa.`, 'sukses');
  }

  // --- ============================================= ---
  // ---      FUNGSI-FUNGSI BARU KELOLA TAHUN AJARAN   ---
  // --- ============================================= ---

  function bukaHalamanTahunAjaran() {
    tampilHalaman('halaman-tahun-ajaran');
    
    // --- [TAMBAHAN BARU] ---
    const halaman = document.getElementById('halaman-tahun-ajaran');
    const isPremium = (globalDonasiStatus === 'APPROVED');
    
    const oldInfoBox = document.getElementById('ta-premium-info');
    if (oldInfoBox) {
      oldInfoBox.remove();
    }
    
    if (isPremium) {
      halaman.classList.remove('non-premium-readonly');
    } else {
      halaman.classList.add('non-premium-readonly');
      
      const infoBox = document.createElement('div');
      infoBox.id = 'ta-premium-info';
      infoBox.className = 'premium-info-box';
      infoBox.innerHTML = '<i class="fas fa-star"></i>Ini adalah Fitur Premium. Anda dapat melihat data, tetapi tidak dapat menambah, mengedit, atau menghapus tahun ajaran. Silakan <a href="#" id="link-donasi-dari-ta">Donasi</a> untuk mengaktifkan fitur ini.';
      
      const pageHeader = halaman.querySelector('.page-header');
      if (pageHeader) {
        pageHeader.insertAdjacentElement('afterend', infoBox);
      }
      
      const linkDonasi = document.getElementById('link-donasi-dari-ta');
      if (linkDonasi) {
        linkDonasi.addEventListener('click', (e) => {
          e.preventDefault();
          bukaHalamanDonasi();
        });
      }
    }
    // --- [AKHIR TAMBAHAN BARU] ---

    setLoading(true, 'Memuat data tahun ajaran...', false, false);
    isFormDirty = false;
    hideMessage('ta-message');
    document.getElementById('ta-list-container').innerHTML = "<p>Memuat data tahun ajaran...</p>";
    setFormDisabled('form-ta', true);

    if (globalTaList && globalTaList.length > 0) {
        console.log("Memuat T.A. dari cache klien...");
        setTimeout(() => {
          onTahunAjaranLoaded({ status: "sukses", data: globalTaList });
        }, 10); 
    } else {
        console.log("Memuat T.A. dari server...");
        google.script.run
          .withSuccessHandler(onTahunAjaranLoaded)
          .withFailureHandler(onGagal)
          .getTahunAjaran(getToken());
    }
  }

  function onTahunAjaranLoaded(response) {
    setLoading(false);
    
    // --- [TAMBAHAN BARU] ---
    const halaman = document.getElementById('halaman-tahun-ajaran');
    const isReadOnly = halaman.classList.contains('non-premium-readonly');
    
    // Aktifkan form HANYA jika tidak read-only
    if (!isReadOnly) {
      setFormDisabled('form-ta', false);
    }
    // --- [AKHIR TAMBAHAN BARU] ---

    if (response.status !== 'sukses') {
      showMessage('ta-message', response.message, true);
      document.getElementById('ta-list-container').innerHTML = `<p class="message error" style="display:block;">${response.message}</p>`;
      globalTaList = []; 
      return;
    }
    
    globalTaList = response.data || [];
    
    renderTahunAjaranList(globalTaList);
    
    // --- [TAMBAHAN BARU] ---
    // Jika read-only, nonaktifkan semua input/tombol yang baru di-render
    if (isReadOnly) {
      halaman.querySelectorAll('input, button').forEach(el => {
        if(el.id !== 'btn-kembali-ke-dashboard-14') { // Jangan disable tombol kembali
           el.disabled = true;
        }
      });
    }
    // --- [AKHIR TAMBAHAN BARU] ---
  }

  /**
   * [BARU] Membaca data T.A. saat ini dari DOM.
   * [PERBAIKAN] Sekarang juga membaca status 'isUsed' dari 'dataset.isUsed'.
   */
  function getCurrentTahunAjaranList() {
    const allRows = document.querySelectorAll('#ta-list-container .ta-input-row');
    const list = [];
    
    allRows.forEach(row => {
      const idInput = row.querySelector('.ta-id-input');
      const deskripsiInput = row.querySelector('.ta-deskripsi-input');
      const kunciInput = row.querySelector('.ta-kunci-input');
      
      // Lewati header row
      if (idInput && deskripsiInput && kunciInput) {
        
        // *** FIX 1: Read 'isUsed' state from the DOM ***
        // Konversi string 'true'/'false' kembali ke boolean
        const isUsed = (row.dataset.isUsed === 'true'); 
        
        list.push({
          id: idInput.value,
          deskripsi: deskripsiInput.value,
          isLocked: kunciInput.checked,
          isUsed: isUsed // <-- Masukkan kembali ke dalam data
        });
      }
    });
    
    return list;
  }

  /**
   * [BARU] Merender list T.A. ke DOM.
   * [PERBAIKAN] Menyimpan 'data-is-used' dan memperbaiki logika tombol Hapus/Tambah.
   */
  function renderTahunAjaranList(taList) {
    const container = document.getElementById('ta-list-container');
    container.innerHTML = '';

    let listToRender = taList;
    if (listToRender.length === 0) {
      // Jika kosong, tambahkan satu baris baru default
      listToRender = [{ id: '', deskripsi: '', isLocked: false, isUsed: false }];
    }

    // Buat header
    const headerDiv = document.createElement('div');
    headerDiv.className = 'ta-input-row';
    headerDiv.innerHTML = `
      <label style="font-weight: 700;">ID Tahun Ajaran</label>
      <label style="font-weight: 700;">Deskripsi (Cth: 2024/2025)</label>
      <label style="font-weight: 700; text-align: center;">Kunci</label>
      <label style="font-weight: 700;">Aksi</label>
    `;
    container.appendChild(headerDiv);

    listToRender.forEach((ta, index) => {
      const div = document.createElement('div');
      div.className = 'ta-input-row';
      
      const isUsed = ta.isUsed || false;
      const isLocked = ta.isLocked || false;
      
      // *** FIX 1: Store isUsed state in the DOM ***
      div.dataset.isUsed = String(isUsed); // Simpan sebagai string 'true'/'false'
      
      const titleAttr = isUsed ? 'ID tidak bisa diubah/dihapus karena T.A. sudah dipakai.' : '';

      const idInputHtml = isUsed ? 
        `<input type="text" class="ta-id-input" value="${ta.id}" readonly style="background-color: var(--bg-light); cursor: not-allowed;" title="${titleAttr}">` :
        `<input type="text" class="ta-id-input" value="${ta.id}" placeholder="TA-2024-2025">`;
        
      const checkboxHtml = `<input type="checkbox" class="ta-kunci-input" id="kunci_${index}" ${isLocked ? 'checked' : ''} title="Kunci/Buka Kunci T.A.">`;
      
      // *** FIX 2: Logic for buttons ***
      
      // 1. Buat tombol Hapus.
      // Selalu ada, kecuali jika ini satu-satunya baris.
      const isOnlyRow = (listToRender.length === 1);
      let removeButtonHtml;
      
      if (isOnlyRow) {
        // Jika hanya 1 baris, buat placeholder non-fungsional
         removeButtonHtml = `<button type="button" class="btn-aksi-kelas btn-remove-ta-row" disabled style="opacity: 0; pointer-events: none;">&times;</button>`;
      } else if (isUsed) {
        // Jika 'isUsed' (terkunci), buat tombol non-fungsional
        removeButtonHtml = `<button type="button" class="btn-aksi-kelas btn-remove-ta-row" disabled title="${titleAttr}">&times;</button>`;
      } else {
        // Jika tidak terkunci, buat tombol fungsional
        removeButtonHtml = `<button type="button" class="btn-aksi-kelas btn-remove-ta-row" title="Hapus Baris">&times;</button>`;
      }
          
      // 2. Buat tombol Tambah (hanya untuk baris terakhir)
      const addButtonHtml = (index === listToRender.length - 1) ?
        `<button type="button" class="btn-aksi-kelas btn-add-ta-row btn-add-kelas" title="Tambah Baris Baru">+</button>` :
        ''; // Kosong untuk semua baris lain

      // 3. Gabungkan dalam wrapper (sesuai perbaikan CSS)
      const actionsHtml = `
        <div class="ta-action-buttons">
          ${removeButtonHtml}
          ${addButtonHtml}
        </div>
      `;
      
      // 4. Build final row
      div.innerHTML = `
        ${idInputHtml}
        <input type="text" class="ta-deskripsi-input" value="${ta.deskripsi}" placeholder="Deskripsi T.A.">
        <div class="ta-lock-wrapper">
          <label for="kunci_${index}">Kunci</label>
          ${checkboxHtml}
        </div>
        ${actionsHtml} 
      `;
      
      container.appendChild(div);
    });
  }

  /**
   * [BARU] Menyimpan data T.A. ke server.
   */
  function simpanTahunAjaran() {
    setLoading(true, 'Menyimpan data tahun ajaran...');
    hideMessage('ta-message');
    
    const list = getCurrentTahunAjaranList();
    
    // Validasi client-side
    const idSet = new Set();
    for (const item of list) {
      if (!item.id || !item.deskripsi) {
        setLoading(false);
        showMessage('ta-message', 'ID dan Deskripsi tidak boleh kosong.', true);
        return;
      }
      const id_upper = item.id.toUpperCase();
      if (idSet.has(id_upper)) {
        setLoading(false);
        showMessage('ta-message', `ID Tahun Ajaran duplikat: '${item.id}'. ID harus unik.`, true);
        return;
      }
      idSet.add(id_upper);
    }
    
    google.script.run
      .withSuccessHandler(onTahunAjaranSaved)
      .withFailureHandler(onGagal)
      .saveTahunAjaran(getToken(), list);
  }

  /**
   * [BARU] Callback setelah T.A. disimpan.
   * [MODIFIKASI] Ditambahkan invalidasi cache.
   */
  // Salin dan GANTI fungsi onTahunAjaranSaved() Anda dengan yang ini
  function onTahunAjaranSaved(response) {
      setLoading(false);
      if (response.status === 'sukses') {
        isFormDirty = false; 
        showMessage('ta-message', 'Data Tahun Ajaran berhasil disimpan!', false);
        
        // --- TAMBAHAN BARU: Invalidate cache ---
        globalTaList = []; 
        // --- AKHIR TAMBAHAN ---

        // Muat ulang data untuk mendapatkan status 'isUsed' terbaru
        // Ini sekarang akan memicu cache miss dan mengambil data baru dari server
        bukaHalamanTahunAjaran(); 
      } else {
        showMessage('ta-message', response.message, true);
      }
  }
  
  function bukaHalamanPenempatan() {
    tampilHalaman('halaman-penempatan');
    
    // --- [TAMBAHAN BARU] ---
    const halaman = document.getElementById('halaman-penempatan');
    const isPremium = (globalDonasiStatus === 'APPROVED');
    
    const oldInfoBox = document.getElementById('penempatan-premium-info');
    if (oldInfoBox) {
      oldInfoBox.remove();
    }
    
    if (isPremium) {
      halaman.classList.remove('non-premium-readonly');
    } else {
      halaman.classList.add('non-premium-readonly');
      
      const infoBox = document.createElement('div');
      infoBox.id = 'penempatan-premium-info';
      infoBox.className = 'premium-info-box';
      infoBox.innerHTML = '<i class="fas fa-star"></i>Ini adalah Fitur Premium. Anda dapat melihat data, tetapi tidak dapat mengubah penempatan. Silakan <a href="#" id="link-donasi-dari-penempatan">Donasi</a> untuk mengaktifkan fitur ini.';
      
      const pageHeader = halaman.querySelector('.page-header');
      if (pageHeader) {
        pageHeader.insertAdjacentElement('afterend', infoBox);
      }
      
      const linkDonasi = document.getElementById('link-donasi-dari-penempatan');
      if (linkDonasi) {
        linkDonasi.addEventListener('click', (e) => {
          e.preventDefault();
          bukaHalamanDonasi();
        });
      }
    }
    // --- [AKHIR TAMBAHAN BARU] ---

    isPenempatanSiswaDirty = false;
    isPenempatanMapelDirty = false;
    hideMessage('penempatan-message');
    
    document.getElementById('penempatan-tab-bar').style.display = 'none';
    document.getElementById('tab-penempatan-siswa').style.display = 'none';
    document.getElementById('tab-penempatan-mapel').style.display = 'none';
    document.getElementById('penempatan-siswa-container').innerHTML = '<p>Pilih Tahun Ajaran untuk memuat data.</p>';
    document.getElementById('penempatan-mapel-container').innerHTML = '<p>Pilih Tahun Ajaran untuk memuat data.</p>';
    document.getElementById('btn-simpan-penempatan-siswa').disabled = true;
    document.getElementById('btn-simpan-penempatan-mapel').disabled = true;
    
    globalPenempatanData = { siswaData: [], mapelList: [], guruList: [], mapelAssignments: [] };

    const taSelect = document.getElementById('penempatan-ta-select');
    taSelect.innerHTML = '<option value="">-- Memuat T.A. --</option>';
    taSelect.disabled = true;
    
    google.script.run
      .withSuccessHandler(onTahunAjaranListLoadedForPenempatan)
      .withFailureHandler(onGagal)
      .getTahunAjaranList(getToken());
  }

  /**
   * [BARU] Callback setelah daftar T.A. dimuat untuk halaman Penempatan.
   */
  function onTahunAjaranListLoadedForPenempatan(response) {
    const taSelect = document.getElementById('penempatan-ta-select');
    if (response.status === 'sukses' && response.taList.length > 0) {
      globalTaList = response.taList; // Simpan daftar T.A.
      taSelect.innerHTML = '<option value="">-- Pilih Tahun Ajaran --</option>';
      response.taList.forEach(ta => {
        const lockIcon = ta.isLocked ? '  (Terkunci)' : '';
        taSelect.add(new Option(ta.deskripsi + lockIcon, ta.id));
      });
      taSelect.disabled = false;
    } else {
      taSelect.innerHTML = '<option value="">-- Tidak ada T.A. --</option>';
      if(response.message) showMessage('penempatan-message', response.message, true);
    }
  }

  /**
   * [BARU] Memuat data utama (siswa, mapel, guru, assignment)
   * setelah T.A. dipilih.
   */
  function loadPenempatanData(id_tahun_ajaran) {
    setLoading(true, 'Memuat data penempatan...', false, true);
    isPenempatanSiswaDirty = false;
    isPenempatanMapelDirty = false;
    document.getElementById('btn-simpan-penempatan-siswa').disabled = true;
    document.getElementById('btn-simpan-penempatan-mapel').disabled = true;
    document.getElementById('penempatan-siswa-container').innerHTML = '<p>Memuat data siswa...</p>';
    document.getElementById('penempatan-mapel-container').innerHTML = '<p>Memuat data mapel...</p>';
    
    google.script.run
      .withSuccessHandler(onPenempatanDataLoaded)
      .withFailureHandler(onGagal)
      .getPenempatanData(getToken(), id_tahun_ajaran);
  }

  /**
   * [BARU] Callback setelah semua data penempatan (gabungan) dimuat.
   */
  function onPenempatanDataLoaded(response) {
    setLoading(false);
    if (response.status !== 'sukses') {
      showMessage('penempatan-message', response.message, true);
      return;
    }
    
    globalPenempatanData = response;
    
    // [MODIFIKASI] Simpan cache kelas (sudah dalam format objek)
    if (response.kelasList) {
        globalKelasListCache = response.kelasList; // Ini sudah array of objects
        console.log("Cache kelas diisi dari getPenempatanData:", globalKelasListCache);
    } else {
        console.warn("Respon 'getPenempatanData' tidak menyertakan 'kelasList'.");
        globalKelasListCache = []; // Set ke kosong
    }
    // [AKHIR MODIFIKASI]
    
    // Cek status kunci T.A.
    const taId = document.getElementById('penempatan-ta-select').value;
    const taData = globalTaList.find(ta => ta.id === taId);
    const isTaLocked = taData ? taData.isLocked : false;

    // Tampilkan UI Tab
    document.getElementById('penempatan-tab-bar').style.display = 'flex';
    
    // [MODIFIKASI] Baca dari variabel global, jangan hardcode 'siswa'
    activatePenempatanTab(currentPenempatanTab); 
    // [AKHIR MODIFIKASI]
    
    // 1. Render Tab Siswa
    populatePenempatanSiswaFilters(globalPenempatanData.siswaData);
    renderPenempatanSiswaTable();
    
    // 2. Render Tab Mapel
    renderPenempatanMapelTable();
    
    // 3. Atur status Kunci (Lock)
    if (isTaLocked) {
      document.getElementById('btn-simpan-penempatan-siswa').disabled = true;
      document.getElementById('btn-simpan-penempatan-mapel').disabled = true;
      document.getElementById('btn-buka-modal-mapel-app2').disabled = true;
      showToast('Tahun Ajaran ini terkunci. Data tidak dapat diubah.', 'gagal', 5000);
    } else {
      // Tombol simpan akan aktif saat ada perubahan (dirty state)
      document.getElementById('btn-buka-modal-mapel-app2').disabled = false;
    }
  }

  /**
   * [BARU] Mengaktifkan tab di halaman Penempatan.
   */
  function activatePenempatanTab(tabName) {
    currentPenempatanTab = tabName; // <-- [MODIFIKASI] Simpan tab aktif
    
    document.querySelectorAll('#penempatan-tab-bar .tab-link').forEach(link => link.classList.remove('active'));
    document.querySelectorAll('#halaman-penempatan .tab-content').forEach(content => content.style.display = 'none');
    
    document.querySelector(`.tab-link[data-tab="${tabName}"]`).classList.add('active');
    document.getElementById(`tab-penempatan-${tabName}`).style.display = 'block';
  }

  function populatePenempatanSiswaFilters(siswaList) {
    const selectKelas = document.getElementById('penempatan-siswa-filter-kelas');
    selectKelas.innerHTML = '';
    
    const kelasSet = new Set(siswaList.map(siswa => siswa.kelas));
    const kelasList = Array.from(kelasSet).sort(compareKelas); // [MODIFIKASI]
  
    let optionsHtml = '<option value="semua">-- Semua Kelas --</option>';
    kelasList.forEach(kelas => {
      optionsHtml += `<option value="${kelas}">${kelas}</option>`;
    });
    selectKelas.innerHTML = optionsHtml;
    selectKelas.value = 'semua';
  }

  /**
   * [BARU] Render tabel Penempatan Siswa.
   */
  function renderPenempatanSiswaTable() {
    const container = document.getElementById('penempatan-siswa-container');
    container.innerHTML = "";
    
    const { siswaData } = globalPenempatanData;
    const filterKelas = document.getElementById('penempatan-siswa-filter-kelas').value;
    const filterNama = document.getElementById('penempatan-siswa-search').value.toLowerCase();
    
    let filteredSiswa = siswaData;
    if (filterKelas !== 'semua') {
      filteredSiswa = filteredSiswa.filter(s => s.kelas === filterKelas);
    }
    if (filterNama) {
      filteredSiswa = filteredSiswa.filter(s => s.nama.toLowerCase().includes(filterNama));
    }
    
    if (filteredSiswa.length === 0) {
      container.innerHTML = '<p style="text-align: center; padding: 20px;">Tidak ada siswa sesuai filter.</p>';
      return;
    }
    
    const table = document.createElement('table');
    // [MODIFIKASI] Menambahkan class 'siswa-table' untuk styling konsisten
    table.className = 'siswa-table penempatan-siswa-table';
    
    const thead = table.createTHead();
    // [MODIFIKASI] Menambahkan 'thead-dark'
    thead.className = 'thead-dark'; 
    
    // [MODIFIKASI] Mengubah header menjadi UPPERCASE dan menambahkan class
    thead.innerHTML = `
      <tr>
        <th class="col-cek-enroll"><i class="fas fa-check"></i></th>
        <th>NAMA SISWA (APP 1)</th>
        <th class="col-kelas-app1">KELAS (APP 1)</th>
        <th>NO. UJIAN (APP 2)</th>
        <th class="col-ruang">RUANG UJIAN (APP 2)</th>
      </tr>
    `;
    
    const tbody = table.createTBody();
    const fragment = document.createDocumentFragment();
    
    filteredSiswa.forEach(siswa => {
      const tr = document.createElement('tr');
      tr.dataset.siswaId = siswa.id;
      
      const isEnrolled = siswa.isEnrolled;
      // [MODIFIKASI] Pastikan default value tidak kosong
      const nomorUjianApp2 = siswa.nomor_ujian_app2 || ''; 
      
      tr.innerHTML = `
        <td class="col-cek-enroll">
          <input type="checkbox" class="enroll-checkbox" ${isEnrolled ? 'checked' : ''} title="Tandai untuk ditempatkan">
        </td>
        <td><strong>${siswa.nama}</strong></td>
        <td class="col-kelas-app1">${siswa.kelas}</td>
        <td>
          <input type="text" class="form-control form-control-sm enroll-noujian-input" value="${nomorUjianApp2}" title="Nomor Ujian Siswa di Aplikasi 2">
        </td>
        <td class="col-ruang">
          <input type="text" class="form-control form-control-sm enroll-ruang-input" value="${siswa.ruang_ujian}" placeholder="Contoh: R-01">
        </td>
      `;
      
      const checkbox = tr.querySelector('.enroll-checkbox');
      updateNomorUjianApp2(checkbox); 
      
      fragment.appendChild(tr);
    });
    
    tbody.appendChild(fragment);
    table.appendChild(thead);
    table.appendChild(tbody);
    container.appendChild(table);
  }
  
  /**
   * [BARU] Update input Nomor Ujian App 2 saat checkbox diubah.
   */
  function updateNomorUjianApp2(checkbox) {
    const tr = checkbox.closest('tr');
    if (!tr) return;
    const ruangInput = tr.querySelector('.enroll-ruang-input');
    const noujianInput = tr.querySelector('.enroll-noujian-input');
    
    if (checkbox.checked) {
      ruangInput.disabled = false;
      if (noujianInput) noujianInput.disabled = false;
    } else {
      ruangInput.disabled = true;
      if (noujianInput) noujianInput.disabled = true;
    }
  }

  /**
   * [BARU] Tandai/Batal tandai semua siswa yang terlihat di filter.
   */
  function toggleEnrollAll(shouldEnroll) {
    const rows = document.querySelectorAll('#penempatan-siswa-container tbody tr');
    rows.forEach(tr => {
      const checkbox = tr.querySelector('.enroll-checkbox');
      const ruangInput = tr.querySelector('.enroll-ruang-input');
      const noujianInput = tr.querySelector('.enroll-noujian-input');
      
      if (checkbox) {
        checkbox.checked = shouldEnroll;
        if(ruangInput) ruangInput.disabled = !shouldEnroll;
        if(noujianInput) noujianInput.disabled = !shouldEnroll;
      }
    });
    isPenempatanSiswaDirty = true;
    document.getElementById('btn-simpan-penempatan-siswa').disabled = false;
  }

  /**
   * [BARU] Menyimpan data penempatan siswa (db_enrollment).
   * [PERBAIKAN] Validasi No. Ujian HANYA jika siswa dicentang.
   */
  function simpanPenempatanSiswa() {
    setLoading(true, 'Menyimpan penempatan siswa...', true, true);
    hideMessage('penempatan-message');
    
    const taId = document.getElementById('penempatan-ta-select').value;
    const rows = document.querySelectorAll('#penempatan-siswa-container tbody tr');
    const enrollmentData = [];
    
    try {
      rows.forEach(tr => {
        const siswaId = tr.dataset.siswaId;
        if (!siswaId) return; // Bukan baris data
        
        const checkbox = tr.querySelector('.enroll-checkbox');
        const ruangInput = tr.querySelector('.enroll-ruang-input');
        const noUjianInput = tr.querySelector('.enroll-noujian-input');
        const namaApp1 = tr.cells[1].textContent.trim();
        
        let nomorUjianApp2 = noUjianInput ? noUjianInput.value.trim() : '';
        
        // --- PERBAIKAN BUG 2 DI SINI ---
        // Hanya validasi (throw error) jika Nomor Ujian kosong DAN siswa tersebut dicentang.
        if (checkbox.checked && !nomorUjianApp2) {
          throw new Error(`Nomor Ujian untuk siswa ${namaApp1} tidak boleh kosong (karena dicentang).`);
        }
        // --- AKHIR PERBAIKAN ---
        
        enrollmentData.push({
          id_siswa_app1: siswaId,
          isEnrolled: checkbox.checked, // Kirim status centang
          nomor_ujian_app2: nomorUjianApp2, // Kirim no ujian (bisa kosong jika tdk dicentang)
          ruang_ujian: ruangInput.value.trim(),
          nama_app1: namaApp1 // Untuk sinkronisasi db_siswa App 2
        });
      });
      
      // Kirim data ke server
      google.script.run
        .withSuccessHandler(onPenempatanSiswaSaved)
        .withFailureHandler(onGagal)
        .saveSiswaEnrollment(getToken(), taId, enrollmentData);
        
    } catch (e) {
      // Tangkap error validasi (dari throw new Error)
      setLoading(false);
      showMessage('penempatan-message', e.message, true);
    }
  }

  /**
   * [BARU] Callback setelah penempatan siswa disimpan.
   */
  function onPenempatanSiswaSaved(response) {
    setLoading(false);
    if (response.status === 'sukses') {
      isPenempatanSiswaDirty = false;
      document.getElementById('btn-simpan-penempatan-siswa').disabled = true;
      showToast('Penempatan siswa berhasil disimpan.', 'sukses');
      // Muat ulang data untuk T.A. ini
      loadPenempatanData(document.getElementById('penempatan-ta-select').value);
    } else {
      showMessage('penempatan-message', response.message, true);
    }
  }
  
  /**
   * [BARU] Render tabel Penempatan Mapel.
   * [MODIFIKASI V2] Memperbaiki dataset untuk menyimpan Nama Mapel (bukan ID)
   */
  function renderPenempatanMapelTable() {
    const container = document.getElementById('penempatan-mapel-container');
    container.innerHTML = ""; // 1. Kosongkan container
    
    const { mapelAssignments, guruList, mapelList } = globalPenempatanData;
    
    // [MODIFIKASI]
    const kelasList = (globalKelasListCache || []).sort((a, b) => compareKelas(a.nama, b.nama));
    
    // 2. Selalu buat struktur tabel
    const table = document.createElement('table');
    table.className = 'siswa-table guru-table penempatan-mapel-table'; 
    
    const thead = table.createTHead();
    thead.className = 'thead-dark'; 
    thead.innerHTML = `
      <tr>
        <th>GURU PENGAMPU</th>
        <th>MATA PELAJARAN</th>
        <th>SINGKATAN</th>
        <th class="col-kelas">KELAS</th>
        <th style="width: 80px;">AKSI</th>
      </tr>
    `;
    
    const tbody = table.createTBody(); // Buat tbody

    // 3. Cek apakah ada data untuk diisi
    if (mapelAssignments.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Belum ada mapel yang ditempatkan untuk T.A. ini.</td></tr>';
    } else {
      // Jika ada data, isi seperti biasa
      const fragment = document.createDocumentFragment();
      
      const guruMap = new Map(guruList.map(g => [g.email, g.nama]));
      // mapelList (dari App 1) Peta-nya: [MapelID, NamaMapel]
      const mapelMap = new Map(mapelList.map(m => [m.id, m.nama])); 

      mapelAssignments.sort((a, b) => {
        const namaGuruA = guruMap.get(a.email_guru) || a.email_guru;
        const namaGuruB = guruMap.get(b.email_guru) || b.email_guru;
        return namaGuruA.localeCompare(namaGuruB) || a.mapel.localeCompare(b.mapel);
      });

      mapelAssignments.forEach(item => {
        const tr = document.createElement('tr');
        
        // --- [MODIFIKASI DI SINI] ---
        const idMapel = item.mapel; // Ini adalah ID/Singkatan (cth: "BINDO")
        const namaMapel = mapelMap.get(idMapel) || `(${idMapel})`; // Ini Nama Panjang (cth: "Bahasa Indonesia")
        const singkatan = item.singkatan || idMapel; // Singkatan (jika ada) atau fallback ke ID
        
        tr.dataset.email = item.email_guru;
        tr.dataset.mapel = namaMapel;     // <-- DIUBAH: Simpan Nama Panjang
        tr.dataset.singkatan = idMapel; // <-- DIUBAH: Simpan ID/Singkatan
        tr.dataset.isus = item.isUS;
        tr.dataset.isup = item.isUP;
        // --- [AKHIR MODIFIKASI] ---
        
        const namaGuru = guruMap.get(item.email_guru) || `(${item.email_guru})`;
        
        // Membuat HTML untuk dropdown kelas
        const currentKelasJson = item.kelas_json || '["*"]';
        const allKelasValue = '["*"]';
        
        let optionsHtml = `<option value='${allKelasValue}' ${currentKelasJson === allKelasValue ? 'selected' : ''}>Semua Kelas</option>`;
        
        kelasList.forEach(kelas => {
          const kelasValue = JSON.stringify([kelas.nama]); // Simpan sbg array JSON
          optionsHtml += `<option value='${kelasValue}' ${currentKelasJson === kelasValue ? 'selected' : ''}>${kelas.nama}</option>`;
        });

        tr.innerHTML = `
          <td><strong>${namaGuru}</strong></td>
          <td>${namaMapel}</td> 
          <td>${singkatan}</td> 
          <td>
            <select class="form-control form-control-sm penempatan-mapel-kelas-select" data-email="${item.email_guru}" data-mapel="${item.mapel}">
              ${optionsHtml}
            </select>
          </td>
          <td style="text-align: center;">
            <button class="btn-aksi btn-delete btn-remove-mapel-app2" title="Hapus Penempatan Ini">
              <i class="fas fa-trash-alt"></i>
            </button>
          </td>
        `;
        fragment.appendChild(tr);
      });
      tbody.appendChild(fragment);
    }
    
    // 4. Tambahkan tabel yang sudah lengkap ke container
    container.appendChild(table);
  }
  
  /**
   * [BARU] Membuka modal untuk menambah penempatan mapel.
   * VERSI MODIFIKASI: Menggunakan UI pencarian/tag.
   * (PERBAIKAN: Menghapus jQuery $ dan memindahkan listener)
   */
  function bukaModalTambahMapelApp2() {
    hideMessage('modal-mapel-app2-error');
    
    // Reset field-field spesifik
    document.getElementById('modal-mapel-app2-guru').value = "";
    document.getElementById('modal-penempatan-mapel-search').value = "";
    document.getElementById('modal-penempatan-mapel-suggestions').style.display = 'none';
    document.getElementById('modal-penempatan-mapel-selected').innerHTML = "";

    const { guruList } = globalPenempatanData;
    
    const guruSelect = document.getElementById('modal-mapel-app2-guru');
    guruSelect.innerHTML = '<option value="">-- Pilih Guru --</option>';
    guruList.sort((a, b) => a.nama.localeCompare(b.nama)).forEach(g => {
      guruSelect.add(new Option(`${g.nama} (${g.email})`, g.email));
    });
    
    // Event listener sekarang ditangani di DOMContentLoaded

    document.getElementById('modal-mapel-app2').classList.add('show');
  }

  /**
   * [BARU] Menutup modal tambah mapel App 2.
   */
  function tutupModalMapelApp2() {
    document.getElementById('modal-mapel-app2').classList.remove('show');
  }

  /**
   * [BARU] Menambahkan item dari modal ke tabel penempatan mapel.
   * VERSI MODIFIKASI: Membaca dari tag, bukan multi-select. Singkatan otomatis.
   * [MODIFIKASI V2] Memperbaiki dataset untuk menyimpan Nama Mapel (bukan ID)
   */
  function tambahkanMapelKeTabel() {
    hideMessage('modal-mapel-app2-error');
    const email = document.getElementById('modal-mapel-app2-guru').value;
    const guru = globalPenempatanData.guruList.find(g => g.email === email);
    
    const selectedMapels = getSelectedPenempatanMapelIds(); 
    
    if (!email || selectedMapels.size === 0) { 
      showMessage('modal-mapel-app2-error', 'Guru dan minimal satu Mapel wajib dipilih.', true);
      return;
    }

    if (!guru) {
      showMessage('modal-mapel-app2-error', 'Data guru tidak valid.', true);
      return;
    }

    const table = document.querySelector('#penempatan-mapel-container table');
    if (!table) return;
    
    const tbody = table.tBodies[0];
    const emptyRow = tbody.querySelector('td[colspan="5"]'); // Colspan 5
    if (emptyRow) emptyRow.parentElement.remove();

    let addedCount = 0;
    let skippedCount = 0;
    
    const kelasList = globalKelasListCache || [];
    let optionsHtml = '<option value=\'["*"]\' selected>Semua Kelas</option>';
    kelasList.forEach(kelas => { 
      optionsHtml += `<option value='${JSON.stringify([kelas.nama])}'>${kelas.nama}</option>`; 
    });

    for (const mapelId of selectedMapels) { // mapelId adalah "BINDO" 
      const existingRow = document.querySelector(`#penempatan-mapel-container tr[data-email="${email}"][data-mapel-id="${mapelId}"]`); // <-- [PERBAIKAN] Cek berdasarkan ID
      if (existingRow) {
        skippedCount++;
        continue; 
      }
      
      const mapelData = globalPenempatanData.mapelList.find(m => m.id === mapelId);
      
      if (!mapelData) {
        console.warn(`Data Mapel untuk ID ${mapelId} tidak ditemukan, dilewati.`);
        skippedCount++;
        continue; 
      }
      
      // --- [MODIFIKASI DI SINI] ---
      const namaMapel = mapelData.nama; // "Bahasa Indonesia"
      const singkatan = mapelId;     // "BINDO"
      
      const tr = tbody.insertRow();
      tr.dataset.email = email;
      tr.dataset.mapel = namaMapel;     // <-- DIUBAH: Simpan Nama Panjang
      tr.dataset.singkatan = singkatan; // <-- DIUBAH: Simpan ID/Singkatan
      tr.dataset.isus = mapelData.isUS;
      tr.dataset.isup = mapelData.isUP;
      
      // [PERBAIKAN] Tambahkan data-mapel-id agar pencarian duplikat di atas berfungsi
      tr.dataset.mapelId = mapelId; 
      // --- [AKHIR MODIFIKASI] ---
      
      tr.innerHTML = `
        <td><strong>${guru.nama}</strong></td>
        <td>${namaMapel}</td>
        <td>${singkatan || '-'}</td>
        <td>
          <select class="form-control form-control-sm penempatan-mapel-kelas-select" data-email="${email}" data-mapel="${mapelId}">
            ${optionsHtml}
          </select>
        </td>
        <td style="text-align: center;">
          <button class="btn-aksi btn-delete btn-remove-mapel-app2" title="Hapus Penempatan Ini">
            <i class="fas fa-trash-alt"></i>
          </button>
        </td>
      `;
      addedCount++;
    }
    
    if (addedCount > 0) {
      isPenempatanMapelDirty = true;
      document.getElementById('btn-simpan-penempatan-mapel').disabled = false;
    }
    
    if (skippedCount > 0) {
      showToast(`${skippedCount} mapel dilewati (karena sudah ada).`, 'sukses', 3000);
    }

    tutupModalMapelApp2();
  }

  function openAddMapelModal() {
    document.getElementById('mapelForm').reset();
    document.getElementById('mapelModalLabel').innerText = 'Tambah Mapel Baru';
    document.getElementById('mapel-modal-alert').style.display = 'none';
    
    // Reset hidden fields untuk edit
    document.getElementById('editKeyEmail').value = '';
    document.getElementById('editKeyMapel').value = '';
    document.getElementById('editKeyTA').value = '';

    // Aktifkan field kunci
    document.getElementById('mapelGuruSelect').disabled = false;
    
    // Ambil info dari filter utama
    const taSelect = document.getElementById('mapel-ta-select');
    const sekolahSelect = document.getElementById('mapel-sekolah-select');
    const id_sekolah_terfilter = sekolahSelect.value;
    
    document.getElementById('mapel-info-ta').innerText = taSelect.options[taSelect.selectedIndex].text;
    document.getElementById('mapel-info-sekolah').innerText = sekolahSelect.options[sekolahSelect.selectedIndex].text;

    // Populate guru dropdown
    const guruSelect = document.getElementById('mapelGuruSelect');
    guruSelect.innerHTML = '<option value="">Memuat guru...</option>';

    if (!allTeachersDataCache) {
      // Jika cache belum ada, ambil dulu
      google.script.run
        .withSuccessHandler(response => {
          if (response.success) { 
            allTeachersDataCache = response.data; 
            populateGuruForMapelModal(id_sekolah_terfilter); // Panggil populator
          } else {
            guruSelect.innerHTML = '<option value="">Gagal muat guru</option>';
          }
        })
        .withFailureHandler(err => {
          guruSelect.innerHTML = '<option value="">Error muat guru</option>';
        })
        .superadmin_getAllTeachers(loggedInUser.email);
    } else {
      // Cache sudah ada, langsung populate
      populateGuruForMapelModal(id_sekolah_terfilter);
    }
    
    // [MODIFIKASI] Tombol "Tambah Penempatan Mapel" kini menggunakan style btn-success
    // Kita pastikan tombol simpan di modal juga konsisten
    const saveButton = document.getElementById('btn-simpan-modal-mapel-app2');
    saveButton.style.backgroundColor = 'var(--success-color)';
    saveButton.innerHTML = '<i class="fas fa-plus"></i> Tambahkan';
    // [AKHIR MODIFIKASI]
        
    $('#mapelModal').modal('show');
  }

  /**
   * [BARU] Menampilkan saran mapel untuk modal Penempatan Mapel (App 2).
   */
  function updatePenempatanMapelSuggestions() {
    const container = document.getElementById('modal-penempatan-mapel-suggestions');
    const searchInput = document.getElementById('modal-penempatan-mapel-search');
    if (!container || !searchInput) return;

    const searchTerm = searchInput.value.toLowerCase();

    if (searchTerm.length === 0) {
      container.innerHTML = '';
      container.style.display = 'none';
      return;
    }

    const selectedIds = getSelectedPenempatanMapelIds(); // Helper baru
    
    // Gunakan globalPenempatanData.mapelList
    const filteredMapel = globalPenempatanData.mapelList.filter(mapel => {
      return !selectedIds.has(mapel.id) && 
            (mapel.id.toLowerCase().includes(searchTerm) || 
              mapel.nama.toLowerCase().includes(searchTerm));
    });

    if (filteredMapel.length === 0) {
      container.innerHTML = '<div class="mapel-suggestion-item" style="color: var(--text-light); cursor: default;">Mapel tidak ditemukan atau sudah ditambah.</div>';
    } else {
      container.innerHTML = filteredMapel.slice(0, 10).map(mapel => {
        return `
          <div class="mapel-suggestion-item" data-id="${mapel.id}" data-nama="${mapel.nama}">
            <strong>${mapel.id}</strong> - ${mapel.nama}
          </div>
        `;
      }).join('');
    }
    container.style.display = 'block';
  }

  /**
   * [BARU] Mendapatkan ID mapel yang sudah dipilih di modal Penempatan.
   */
  function getSelectedPenempatanMapelIds() {
    const ids = new Set();
    document.querySelectorAll('#modal-penempatan-mapel-selected .selected-mapel-tag-remove').forEach(tag => {
      ids.add(tag.dataset.id);
    });
    return ids;
  }

  /**
   * [BARU] Menambahkan tag mapel ke UI modal Penempatan.
   */
  function addSelectedPenempatanMapelTag(mapelId, mapelNama) {
    const container = document.getElementById('modal-penempatan-mapel-selected');
    const searchInput = document.getElementById('modal-penempatan-mapel-search');
    const suggestionsContainer = document.getElementById('modal-penempatan-mapel-suggestions');

    const tagHtml = `
      <div class="selected-mapel-tag" id="tag_penempatan_${mapelId}">
        <span>${mapelId} - ${mapelNama}</span>
        <button type="button" class="selected-mapel-tag-remove" data-id="${mapelId}" title="Hapus">&times;</button>
      </div>
    `;

    container.innerHTML += tagHtml;

    searchInput.value = "";
    suggestionsContainer.innerHTML = "";
    suggestionsContainer.style.display = "none";
    searchInput.focus();
  }

  /**
   * [BARU] Menghapus tag mapel dari UI modal Penempatan.
   */
  function removeSelectedPenempatanMapelTag(mapelId) {
    const tagElement = document.getElementById(`tag_penempatan_${mapelId}`);
    if (tagElement) {
      tagElement.remove();
    }
  }

  /**
   * [BARU] Menyimpan data penempatan mapel (db_mapel).
   */
  function simpanPenempatanMapel() {
    setLoading(true, 'Menyimpan penempatan mapel...', true, true);
    hideMessage('penempatan-message');
    
    const taId = document.getElementById('penempatan-ta-select').value;
    const rows = document.querySelectorAll('#penempatan-mapel-container tbody tr');
    const assignmentsToSave = [];
    
    // [MODIFIKASI] Membaca nilai <select>
    rows.forEach(tr => {
      if (tr.dataset.email) { // Pastikan ini baris data
        const select = tr.querySelector('.penempatan-mapel-kelas-select');
        const kelasJson = select ? select.value : '["*"]'; // Default ke "Semua Kelas"
        
        assignmentsToSave.push({
          email_guru: tr.dataset.email,
          mapel: tr.dataset.mapel,
          singkatan: tr.dataset.singkatan,
          kelas_json: kelasJson,
          isUS: tr.dataset.isus === 'true', // <-- TAMBAHKAN INI (konversi string ke boolean)
          isUP: tr.dataset.isup === 'true'  // <-- TAMBAHKAN INI (konversi string ke boolean)
        });
      }
    });
    
    google.script.run
      .withSuccessHandler(onPenempatanMapelSaved)
      .withFailureHandler(onGagal)
      .saveMapelAssignment(getToken(), taId, assignmentsToSave);
  }

  /**
   * [BARU] Callback setelah penempatan mapel disimpan.
   */
  function onPenempatanMapelSaved(response) {
    setLoading(false);
    if (response.status === 'sukses') {
      isPenempatanMapelDirty = false;
      document.getElementById('btn-simpan-penempatan-mapel').disabled = true;
      showToast('Penempatan mapel berhasil disimpan.', 'sukses');
      // Muat ulang data untuk T.A. ini
      loadPenempatanData(document.getElementById('penempatan-ta-select').value);
    } else {
      showMessage('penempatan-message', response.message, true);
    }
  }

  // --- ============================================= ---
  // ---      AKHIR FUNGSI-FUNGSI BARU                 ---
  // --- ============================================= ---

  /**
   * [BARU] Membuka modal import untuk penempatan siswa.
   */
  function bukaModalImportPenempatan() {
    document.getElementById('file-upload-penempatan').value = null;
    document.getElementById('btn-proses-import-penempatan').disabled = true;
    document.getElementById('import-penempatan-results').style.display = 'none';
    document.getElementById('import-penempatan-results').innerHTML = '';
    hideMessage('template-penempatan-message');
    
    const fileUploadText = document.getElementById('file-upload-text-penempatan');
    fileUploadText.innerText = 'Klik untuk memilih file atau seret & letakkan di sini.';
    fileUploadText.classList.remove('file-chosen');
    document.getElementById('file-upload-zone-penempatan').classList.remove('drag-over');
    
    document.getElementById('import-penempatan-modal').classList.add('show');
  }

  /**
   * [BARU] Menutup modal import untuk penempatan siswa.
   */
  function tutupModalImportPenempatan() {
    document.getElementById('import-penempatan-modal').classList.remove('show');
  }

  /**
   * [BARU] Mengunduh template untuk penempatan siswa.
   */
  function downloadTemplatePenempatan() {
    setLoading(true, 'Membuat template penempatan...');
    hideMessage('template-penempatan-message');
    
    // Ambil filter kelas DARI HALAMAN UTAMA, bukan dari modal
    const kelasDipilih = document.getElementById('penempatan-siswa-filter-kelas').value;
    
    google.script.run
      .withSuccessHandler(onTemplatePenempatanReceived)
      .withFailureHandler(onGagal)
      .getPenempatanTemplateData(getToken(), kelasDipilih);
  }

  /**
   * [BARU] Callback setelah template penempatan diterima.
   */
  function onTemplatePenempatanReceived(response) {
    setLoading(false);
    
    if (response.status === 'sukses') {
      showMessage('template-penempatan-message', 'Template berhasil dibuat. Mengunduh...', false);
      try {
        const dataUrl = `data:${response.mimeType};base64,${response.base64}`;
        const link = document.createElement('a');
        link.setAttribute('href', dataUrl);
        link.setAttribute('download', response.fileName);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      } catch (e) {
        showMessage('template-penempatan-message', 'Gagal memproses unduhan: ' + e.message, true);
      }
    } else {
      showMessage('template-penempatan-message', response.message, true);
    }
  }

  /**
   * [BARU] Memproses file Excel penempatan yang di-upload.
   */
  function prosesImportFilePenempatan() {
    setLoading(true, 'Mengimpor data penempatan...');
    document.getElementById('import-penempatan-results').style.display = 'none';
    hideMessage('template-penempatan-message');
    
    const file = document.getElementById('file-upload-penempatan').files[0];
    // [MODIFIKASI] Ambil id_tahun_ajaran dari filter utama
    const taId = document.getElementById('penempatan-ta-select').value;
    
    if (!file) { 
      setLoading(false); 
      showMessage('template-penempatan-message', 'Pilih file Excel.', true); 
      return; 
    }
    // [MODIFIKASI] Pastikan TA dipilih
    if (!taId) {
      setLoading(false); 
      showMessage('template-penempatan-message', 'Kesalahan: ID Tahun Ajaran tidak ditemukan. Muat ulang halaman.', true); 
      return; 
    }
    
    const reader = new FileReader();
    reader.onload = (e) => {
      const fileData = { base64: e.target.result, mimeType: file.type, fileName: file.name };
      // [MODIFIKASI] Kirim taId sebagai argumen ketiga
      google.script.run
        .withSuccessHandler(onImportPenempatanFinished)
        .withFailureHandler(onGagal)
        .prosesUploadPenempatanSiswa(getToken(), fileData, taId);
    };
    reader.onerror = (e) => { 
      setLoading(false); 
      showMessage('template-penempatan-message', 'Gagal baca file.', true); 
    };
    reader.readAsDataURL(file);
  }

  /**
   * [BARU] Callback setelah file penempatan diproses oleh server.
   * Ini adalah inti dari permintaan Anda.
   */
  function onImportPenempatanFinished(response) {
    setLoading(false);
    const resultsContainer = document.getElementById('import-penempatan-results');

    if (response.status !== 'sukses') {
      showMessage('template-penempatan-message', response.message, true);
      resultsContainer.style.display = 'none';
      return;
    }

    // [MODIFIKASI] Menggunakan kunci respons baru
    let html = '<h4><i class="fas fa-check-circle"></i>Proses Import Selesai</h4>';
    html += `<p>Total data diproses: <strong>${response.totalDiProses}</strong></p>`;
    html += `<p style="color: var(--success-color);">Berhasil disimpan: <strong>${response.berhasilDisimpan}</strong></p>`;
    html += `<p style="color: var(--danger-color);">Gagal/Dilewati: <strong>${response.gagalDisimpan}</strong></p>`;

    if (response.dataGagal && response.dataGagal.length > 0) {
      html += `<hr><p><strong>Detail Data yang Gagal:</strong></p>`;
      html += '<table class="import-gagal-table">';
      html += '<tr><th>Baris</th><th>NISN</th><th>Alasan Gagal</th></tr>';
      response.dataGagal.forEach(item => {
        html += `<tr>
            <td>${item.baris}</td>
            <td>${item.nisn || '(Kosong)'}</td>
            <td>${item.alasan}</td>
          </tr>`;
      });
      html += '</table>';
    }

    resultsContainer.innerHTML = html;
    resultsContainer.style.display = 'block';

    // Reset UI modal
    document.getElementById('file-upload-penempatan').value = null;
    document.getElementById('btn-proses-import-penempatan').disabled = true;
    const fileUploadText = document.getElementById('file-upload-text-penempatan');
    fileUploadText.innerText = 'Klik untuk memilih file atau seret & letakkan di sini.';
    fileUploadText.classList.remove('file-chosen');
    
    // [MODIFIKASI] Logika inti baru
    if (response.berhasilDisimpan > 0) {
      
      showToast(`${response.berhasilDisimpan} data siswa berhasil diimpor dan disimpan. Memuat ulang...`, 'sukses');
      
      // Tutup modal setelah 1.5 detik
      setTimeout(() => {
          tutupModalImportPenempatan();
      }, 1500);

      // Muat ulang data tabel utama dari server
      loadPenempatanData(document.getElementById('penempatan-ta-select').value);
      
      // Pastikan form bersih
      isPenempatanSiswaDirty = false;
      document.getElementById('btn-simpan-penempatan-siswa').disabled = true;
    }
  }

  // TAMBAHKAN SEMUA FUNGSI INI DI AKHIR FILE client.html

  /**
   * [BARU] Menampilkan preview gambar kop surat yang dipilih.
   */
  function tampilkanPreviewKop(file) {
    const reader = new FileReader();
    reader.onload = (e) => {
      document.getElementById('kop-surat-preview').src = e.target.result;
      document.getElementById('kop-surat-preview-container').style.display = 'block';
      document.getElementById('file-upload-zone-kop').style.display = 'none';
    };
    reader.readAsDataURL(file);
  }

  /**
   * [BARU] Menangani klik tombol Hapus Gambar.
   */
  function hapusGambarKop() {
    document.getElementById('kop-surat-preview-container').style.display = 'none';
    document.getElementById('kop-surat-preview').src = '';
    document.getElementById('file-upload-zone-kop').style.display = 'flex';
    document.getElementById('file-upload-text-kop').innerText = 'Klik untuk memilih gambar...';
    document.getElementById('file-upload-kop').value = null; // Hapus file dari input
    document.getElementById('kop-surat-status').value = 'delete'; // Tandai untuk dihapus
    document.getElementById('btn-simpan-pengaturan-cetak').disabled = false; // Aktifkan simpan
  }

  function bukaHalamanPengaturanCetak() {
    tampilHalaman('halaman-pengaturan-cetak');
    
    // --- [MODIFIKASI DI SINI] ---
    const halaman = document.getElementById('halaman-pengaturan-cetak');
    const isPremium = (globalDonasiStatus === 'APPROVED');
    
    const oldInfoBox = document.getElementById('pengaturan-cetak-premium-info');
    if (oldInfoBox) {
      oldInfoBox.remove();
    }
    
    if (isPremium) {
      halaman.classList.remove('non-premium-readonly');
    } else {
      halaman.classList.add('non-premium-readonly');
      
      const infoBox = document.createElement('div');
      infoBox.id = 'pengaturan-cetak-premium-info';
      infoBox.className = 'premium-info-box';
      infoBox.innerHTML = '<i class="fas fa-star"></i>Ini adalah Fitur Premium. Anda dapat melihat pengaturan, tetapi tidak dapat mengubahnya. Silakan <a href="#" id="link-donasi-dari-pengaturan-cetak">Donasi</a> untuk mengaktifkan fitur ini.';
      
      const pageHeader = halaman.querySelector('.page-header');
      if (pageHeader) {
        pageHeader.insertAdjacentElement('afterend', infoBox);
      }
      
      const linkDonasi = document.getElementById('link-donasi-dari-pengaturan-cetak');
      if (linkDonasi) {
        linkDonasi.addEventListener('click', (e) => {
          e.preventDefault();
          bukaHalamanDonasi();
        });
      }
    }
    // --- [AKHIR MODIFIKASI] ---

    setLoading(true, 'Memuat pengaturan...', false, true);
    hideMessage('pengaturan-cetak-message');

    // (Sisa fungsi ini adalah logika reset form, tetap sama)
    document.getElementById('form-pengaturan-cetak').reset();
    document.getElementById('pengaturan-tempat-ttd').value = '';
    document.getElementById('pengaturan-tanggal-mode').value = 'otomatis';
    document.getElementById('pengaturan-tanggal-manual-container').style.display = 'none';
    document.getElementById('btn-simpan-pengaturan-cetak').disabled = true;
    document.getElementById('kop-surat-status').value = 'keep';
    document.getElementById('kop-surat-preview-container').style.display = 'none';
    document.getElementById('kop-surat-preview').src = '';
    document.getElementById('file-upload-zone-kop').style.display = 'flex';
    document.getElementById('file-upload-text-kop').innerText = 'Klik untuk memilih gambar...';
    document.getElementById('pengaturan-template-kustom-toggle').checked = false;
    document.getElementById('pengaturan-template-kustom-toggle').disabled = true; 
    document.getElementById('pengaturan-template-kustom-container').style.display = 'none';
    document.getElementById('pengaturan-template-doc-id').value = '';
    document.getElementById('pengaturan-template-rekap-id').value = '';

    const formInputs = document.querySelectorAll('#form-pengaturan-cetak input, #form-pengaturan-cetak select, #form-pengaturan-cetak button');
    formInputs.forEach(input => {
      if(input.id !== 'btn-kembali-ke-dashboard-16') { 
        input.disabled = true;
      }
    });

    google.script.run
      .withSuccessHandler(onPengaturanCetakLoaded)
      .withFailureHandler(onGagal)
      .getPengaturanCetak(getToken());
  }

  function onPengaturanCetakLoaded(response) {
    setLoading(false);

    // --- [TAMBAHAN BARU] ---
    const halaman = document.getElementById('halaman-pengaturan-cetak');
    const isReadOnly = halaman.classList.contains('non-premium-readonly');
    // --- [AKHIR TAMBAHAN BARU] ---

    const formInputs = document.querySelectorAll('#form-pengaturan-cetak input, #form-pengaturan-cetak select, #form-pengaturan-cetak button');
    
    // --- [MODIFIKASI] ---
    // Aktifkan form HANYA jika tidak read-only
    if (!isReadOnly) {
      formInputs.forEach(input => {
        if(input.id !== 'btn-simpan-pengaturan-cetak' && input.id !== 'pengaturan-template-kustom-toggle') { 
            input.disabled = false;
        }
      });
    }
    // --- [AKHIR MODIFIKASI] ---
    
    document.getElementById('file-upload-kop').value = null;

    if (response.status === 'sukses') {
      
      globalPengaturanCetakCache = response;

      const data = response.data;
      document.getElementById('pengaturan-tanggal-cetak').value = data.tanggalCetak || '';
      document.getElementById('pengaturan-tempat-ttd').value = data.tempatTTD || '';

      const mode = data.tanggalTtdMode || 'otomatis';
      document.getElementById('pengaturan-tanggal-mode').value = mode;
      if (mode === 'manual') {
        document.getElementById('pengaturan-tanggal-manual-container').style.display = 'block';
      } else {
        document.getElementById('pengaturan-tanggal-manual-container').style.display = 'none';
      }

      if (data.kopSuratUrl) {
        document.getElementById('kop-surat-preview').src = data.kopSuratUrl;
        document.getElementById('kop-surat-preview-container').style.display = 'block';
        document.getElementById('file-upload-zone-kop').style.display = 'none';
      }

      const toggle = document.getElementById('pengaturan-template-kustom-toggle');
      const container = document.getElementById('pengaturan-template-kustom-container');
      const docIdInput = document.getElementById('pengaturan-template-doc-id');
      const rekapIdInput = document.getElementById('pengaturan-template-rekap-id');

      docIdInput.value = data.templateDocID || data.defaultTemplateDocID || '';
      rekapIdInput.value = data.templateRekapID || data.defaultTemplateRekapID || '';

      if (globalDonasiStatus === "APPROVED") {
        // --- [MODIFIKASI] ---
        // Aktifkan toggle HANYA jika tidak read-only
        if (!isReadOnly) {
          toggle.disabled = false;
        }
        // --- [AKHIR MODIFIKASI] ---
        
        const isCustomDoc = data.templateDocID && (data.templateDocID !== data.defaultTemplateDocID);
        const isCustomRekap = data.templateRekapID && (data.templateRekapID !== data.defaultTemplateRekapID);

        if (isCustomDoc || isCustomRekap) {
          toggle.checked = true;
          container.style.display = 'block';
        } else {
          toggle.checked = false;
          container.style.display = 'none';
        }
      } else {
        toggle.disabled = true;
        toggle.checked = false;
        container.style.display = 'none';
      }

      document.getElementById('btn-simpan-pengaturan-cetak').disabled = true;

    } else {
      globalPengaturanCetakCache = null;
      showMessage('pengaturan-cetak-message', 'Gagal memuat pengaturan: ' + response.message, true);
    }

    // --- [TAMBAHAN BARU] ---
    // Paksa disable semua input/tombol jika read-only
    if (isReadOnly) {
      formInputs.forEach(input => {
        if(input.id !== 'btn-kembali-ke-dashboard-16') {
           input.disabled = true;
        }
      });
      // Sembunyikan tombol hapus kop surat juga
      const btnHapusKop = document.getElementById('btn-hapus-kop-surat');
      if (btnHapusKop) btnHapusKop.style.display = 'none';
    } else {
      // Pastikan tombol hapus kop surat terlihat jika premium
      const btnHapusKop = document.getElementById('btn-hapus-kop-surat');
      if (btnHapusKop && response.status === 'sukses' && response.data.kopSuratUrl) {
         btnHapusKop.style.display = 'block';
      }
    }
    // --- [AKHIR TAMBAHAN BARU] ---
  }

  function simpanPengaturanCetak() {
    const btn = document.getElementById('btn-simpan-pengaturan-cetak');
    setButtonLoading(btn, 'Menyimpan...');
    hideMessage('pengaturan-cetak-message');
    document.getElementById('pengaturan-tempat-ttd').classList.remove('input-error');
    document.getElementById('pengaturan-tanggal-cetak').classList.remove('input-error');
    
    // --- [MODIFIKASI] Hapus error class dari input baru ---
    document.getElementById('pengaturan-template-doc-id').classList.remove('input-error');
    document.getElementById('pengaturan-template-rekap-id').classList.remove('input-error');
    // --- [AKHIR MODIFIKASI] ---

    const tempatTTD = document.getElementById('pengaturan-tempat-ttd').value.trim();
    const tanggalTtdMode = document.getElementById('pengaturan-tanggal-mode').value;
    const tanggalCetak = document.getElementById('pengaturan-tanggal-cetak').value;
    
    const fileInput = document.getElementById('file-upload-kop');
    const file = fileInput.files[0];
    const status = document.getElementById('kop-surat-status').value;

    // --- [MODIFIKASI] Baca data dari input baru ---
    const isKustom = document.getElementById('pengaturan-template-kustom-toggle').checked;
    const templateDocID = document.getElementById('pengaturan-template-doc-id').value.trim();
    const templateRekapID = document.getElementById('pengaturan-template-rekap-id').value.trim();
    // --- [AKHIR MODIFIKASI] ---

    // --- Validasi ---
    if (!tempatTTD) {
      resetButtonLoading(btn);
      showMessage('pengaturan-cetak-message', 'Tempat Tanda Tangan wajib diisi.', true);
      document.getElementById('pengaturan-tempat-ttd').classList.add('input-error');
      document.getElementById('pengaturan-tempat-ttd').focus();
      return;
    }
    if (tanggalTtdMode === 'manual' && !tanggalCetak) {
      resetButtonLoading(btn);
      showMessage('pengaturan-cetak-message', 'Tanggal Tanda Tangan Manual wajib diisi jika mode "Manual" dipilih.', true);
      document.getElementById('pengaturan-tanggal-cetak').classList.add('input-error');
      document.getElementById('pengaturan-tanggal-cetak').focus();
      return;
    }
    
    // --- [MODIFIKASI] Validasi input baru ---
    // Validasi hanya jika checkbox (yang sudah di-unlock) dicentang
    if (globalDonasiStatus === "APPROVED" && isKustom) {
      let errorTemplate = false;
      if (!templateDocID) {
        document.getElementById('pengaturan-template-doc-id').classList.add('input-error');
        errorTemplate = true;
      }
      if (!templateRekapID) {
        document.getElementById('pengaturan-template-rekap-id').classList.add('input-error');
        errorTemplate = true;
      }
      if (errorTemplate) {
        resetButtonLoading(btn);
        showMessage('pengaturan-cetak-message', 'Jika "Gunakan Template Sendiri" dicentang, kedua ID Spreadsheet wajib diisi.', true);
        return;
      }
    }
    // --- [AKHIR MODIFIKASI] ---

    let fileData = null;

    // Definisikan fungsi panggilan backend
    const callBackend = (fileDataPayload) => {
      google.script.run
        .withSuccessHandler(onPengaturanCetakSaved)
        .withFailureHandler(onGagal)
        .savePengaturanCetak(
          getToken(), 
          tanggalCetak, 
          fileDataPayload, 
          tempatTTD, 
          tanggalTtdMode,
          templateDocID,    // <-- Argumen BARU
          templateRekapID   // <-- Argumen BARU
        );
    };

    // Logika pembacaan file (tidak berubah)
    if (status === 'new' && file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        fileData = {
          base64: e.target.result,
          mimeType: file.type,
          fileName: file.name
        };
        callBackend(fileData); // Panggil setelah file dibaca
      };
      reader.onerror = (e) => {
        onGagal({ message: 'Gagal membaca file.' });
      };
      reader.readAsDataURL(file);

    } else if (status === 'delete') {
      fileData = { delete: true };
      callBackend(fileData); // Panggil dengan flag delete

    } else {
      // Status 'keep' atau tidak ada file baru
      callBackend(null); // Panggil tanpa data file
    }
  }

  function onPengaturanCetakSaved(response) {
    const btn = document.getElementById('btn-simpan-pengaturan-cetak');
    resetButtonLoading(btn);

    if (response.status === 'sukses') {
      showToast("Pengaturan berhasil disimpan!", 'sukses');
      document.getElementById('btn-simpan-pengaturan-cetak').disabled = true;
      document.getElementById('kop-surat-status').value = 'keep'; // Reset status

      // --- [MODIFIKASI] Invalidate cache ---
      // Invalidate cache data sekolah agar data template yang baru disimpan
      // akan dimuat ulang saat halaman dibuka lagi.
      globalDataSekolahCache = null; 
      // --- [AKHIR MODIFIKASI] ---

      if (response.newUrl) {
        document.getElementById('kop-surat-preview').src = response.newUrl;
      } else if (document.getElementById('kop-surat-status').value === 'delete') {
        hapusGambarKop();
      }
    } else {
      showMessage('pengaturan-cetak-message', 'Gagal menyimpan: ' + response.message, true);
    }
  }

  /**
   * [BARU] Helper untuk konversi angka Romawi (hingga 39, cukup untuk kelas).
   */
  function romanToInt(s) {
    if (!s) return 0;
    const map = { 'I': 1, 'V': 5, 'X': 10 };
    let num = 0;
    try {
      for (let i = 0; i < s.length; i++) {
        const curr = map[s[i].toUpperCase()];
        const next = map[s[i+1]?.toUpperCase()];
        if (curr < next) {
          num -= curr;
        } else {
          num += curr;
        }
      }
    } catch(e) { return 0; }
    return num;
  }

  /**
   * [BARU] Helper untuk mengekstrak nilai sortable dari nama kelas.
   */
  function getKelasSortValue(className) {
    if (!className) return { type: 'string', value: 999, original: '' };
    
    // Regex untuk Romawi (sebagai kata utuh, misal "VI" tapi bukan "VIP")
    const romanMatch = className.toUpperCase().match(/\b(XII|XI|X|IX|VIII|VII|VI|V|IV|III|II|I)\b/);
    if (romanMatch) {
      return { 
        type: 'number', 
        value: romanToInt(romanMatch[0]), 
        original: className 
      };
    }
    
    // Regex untuk angka Arab
    const arabicMatch = className.match(/(\d+)/);
    if (arabicMatch) {
      return { 
        type: 'number', 
        value: parseInt(arabicMatch[0], 10), 
        original: className 
      };
    }
    
    // Tidak ada angka, urutkan berdasarkan abjad
    return { type: 'string', value: 999, original: className };
  }

  /**
   * [BARU] Fungsi komparator untuk sorting nama kelas.
   */
  function compareKelas(a, b) {
    const valA = getKelasSortValue(a);
    const valB = getKelasSortValue(b);

    // Angka (Romawi/Arab) selalu di atas string
    if (valA.type === 'number' && valB.type === 'string') return -1;
    if (valA.type === 'string' && valB.type === 'number') return 1;

    // Jika keduanya angka
    if (valA.type === 'number' && valB.type === 'number') {
      if (valA.value !== valB.value) {
        return valA.value - valB.value; // Urutkan berdasarkan angkanya (1, 2, 6, 9, 10)
      }
    }
    
    // Jika keduanya string, atau angkanya sama (misal VI A vs VI B)
    // Urutkan berdasarkan teks aslinya
    return valA.original.localeCompare(valB.original);
  }

  /**
   * [BARU] Menampilkan modal tutorial untuk template kustom.
   * @param {string} type - 'doc' (untuk Laporan Nilai) atau 'rekap' (untuk Rekapitulasi).
   */
  function showTemplateTutorialModal(type) {
    let title = '';
    let message = '';
    let exampleLink = '#';

    // 1. Ambil data link dari cache
    if (globalPengaturanCetakCache && globalPengaturanCetakCache.data) {
      if (type === 'doc') {
        exampleLink = globalPengaturanCetakCache.data.exampleLinkDoc || '#';
      } else {
        exampleLink = globalPengaturanCetakCache.data.exampleLinkRekap || '#';
      }
    } else {
      showToast("Gagal memuat link contoh, cache pengaturan cetak tidak ditemukan.", 'gagal');
    }

    // 2. Tentukan konten modal
    if (type === 'doc') {
      title = "Petunjuk Template Laporan Nilai (App 2)";
      message = `
        <div style="text-align: left; line-height: 1.6;">
          <a href="${exampleLink}" target="_blank" rel="noopener noreferrer" class="btn-aksi" style="width: 100%; margin-bottom: 15px; background-color: var(--success-color); text-align: center;">
            <i class="fas fa-external-link-alt"></i> Buka Contoh Template
          </a>
          <p>Template ini digunakan oleh <strong>Aplikasi 2 (Input Nilai Ujian)</strong> untuk mencetak laporan per mapel.</p>
          <strong style="display: block; margin-top: 10px;">Placeholder Teks:</strong>
          <p>Anda bisa menggunakan variabel berikut di mana saja (termasuk header/footer):</p>
          <ul style="padding-left: 20px; font-family: monospace; font-size: 14px;">
            <li>{{KOP_SURAT}}</li>
            <li>{{nama_mapel}}</li>
            <li>{{tahun_lulus}}</li>
            <li>{{tahun_pelajaran}}</li>
            <li>{{guru_pemeriksa}}</li>
            <li>{{nama_kepala_sekolah}}</li>
            <li>{{nip_kepala_sekolah}}</li>
            <li>{{tempat_ttd}}</li>
            <li>{{tanggal_ttd}}</li>
          <p>Khusus KOP SURAT, Anda bisa langsung memasukkan gambar KOP SURAT Sekolah Anda, tidak perlu menggunakan placeholder dan tidak perlu melakukan upload KOP SURAT. Silahkan hapus {{KOP_SURAT}} dan ganti dengan gambar KOP SURAT Sekolah Anda.</p>
          </ul>
          <strong style="display: block; margin-top: 10px;">Persyaratan Tabel:</strong>
          <ul style="padding-left: 20px;">
            <li>Template Anda <strong>wajib memiliki 1 (satu) tabel</strong>.</li>
            <li>Script akan mencari tabel pertama dan <strong>menambahkan baris data siswa</strong> di bawah header Anda.</li>
            <li>Buatlah header tabel Anda sendiri (Contoh: No, Nama Siswa, No. Ujian, Nilai, Terbilang).</li>
          </ul>
        </div>
      `;
    } else { // type === 'rekap'
      title = "Petunjuk Template Rekapitulasi (App 1)";
      message = `
        <div style="text-align: left; line-height: 1.6;">
          <a href="${exampleLink}" target="_blank" rel="noopener noreferrer" class="btn-aksi" style="width: 100%; margin-bottom: 15px; background-color: var(--success-color); text-align: center;">
            <i class="fas fa-external-link-alt"></i> Buka Contoh Template
          </a>
          <p>Template ini digunakan oleh <strong>Aplikasi 1 (Nilai Ijazah)</strong> untuk mencetak rekapitulasi nilai (di menu Nilai Ijazah).</p>
          <strong style="display: block; margin-top: 10px;">Placeholder Teks:</strong>
          <p>Anda bisa menggunakan variabel berikut di mana saja:</p>
          <ul style="padding-left: 20px; font-family: monospace; font-size: 14px;">
            <li>{{nama_sekolah}}</li>
            <li>{{deskripsi_rekap}}</li>
          </ul>
          <strong style="display: block; margin-top: 10px;">Persyaratan Tabel:</strong>
          <ul style="padding-left: 20px;">
            <li>Template Anda <strong>wajib memiliki 1 (satu) tabel kosong</strong>.</li>
            <li>Script akan <strong>MENGHAPUS SEMUA ISI</strong> tabel tersebut dan menggantinya dengan header dan data rekapitulasi secara otomatis.</li>
          </ul>
        </div>
      `;
    }
    
    // 3. Panggil modal info
    const modal = document.getElementById('info-modal');
    document.getElementById('info-modal-title').innerText = title;
    document.getElementById('info-modal-body').innerHTML = message;
    document.getElementById('info-modal-body').classList.remove('error');
    
    modal.onOk = null;
    modal.classList.add('show');
  }

  function bukaHalamanKelolaNilaiGuru() {
    tampilHalaman('halaman-kelola-nilai-guru');
    
    const halaman = document.getElementById('halaman-kelola-nilai-guru');
    const isPremium = (globalDonasiStatus === 'APPROVED');
    
    const oldInfoBox = document.getElementById('kelola-nilai-guru-premium-info');
    if (oldInfoBox) {
      oldInfoBox.remove();
    }
    
    if (isPremium) {
      halaman.classList.remove('non-premium-readonly');
    } else {
      halaman.classList.add('non-premium-readonly');
      
      const infoBox = document.createElement('div');
      infoBox.id = 'kelola-nilai-guru-premium-info';
      infoBox.className = 'premium-info-box';
      infoBox.innerHTML = '<i class="fas fa-star"></i>Ini adalah Fitur Premium. Anda dapat melihat, tetapi tidak dapat menyetujui atau menolak kiriman nilai. Silakan <a href="#" id="link-donasi-dari-kelola-nilai">Donasi</a> untuk mengaktifkan fitur ini.';
      
      const pageHeader = halaman.querySelector('.page-header');
      if (pageHeader) {
        pageHeader.insertAdjacentElement('afterend', infoBox);
      }
      
      const linkDonasi = document.getElementById('link-donasi-dari-kelola-nilai');
      if (linkDonasi) {
        linkDonasi.addEventListener('click', (e) => {
          e.preventDefault();
          bukaHalamanDonasi();
        });
      }
    }
    
    setLoading(true, 'Memuat kiriman nilai guru...', false, false);
    hideMessage('kelola-nilai-guru-message');
    document.getElementById('pending-scores-container').innerHTML = '<p>Memuat data...</p>';
    
    google.script.run
      .withSuccessHandler(onPendingScoresLoaded)
      .withFailureHandler(onGagal)
      .getPendingTeacherScores(getToken());
  }

  function onPendingScoresLoaded(response) {
    setLoading(false);
    const container = document.getElementById('pending-scores-container');
    
    if (response.status !== 'sukses') {
      container.innerHTML = `<p class="message error" style="display:block;">${response.message}</p>`;
      return;
    }
    
    const scores = response.pendingScores;
    if (scores.length === 0) {
      container.innerHTML = '<p>Tidak ada kiriman nilai baru yang menunggu persetujuan.</p>';
      return;
    }
    
    let html = '';
    const isReadOnly = document.getElementById('halaman-kelola-nilai-guru').classList.contains('non-premium-readonly');
    
    scores.forEach(score => {
      const kirimDate = new Date(score.timestamp_kirim);
      const kirimDateStr = kirimDate.toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' });
      
      html += `
        <div class="pending-score-card">
          <h4>${score.nama_mapel}</h4>
          <div class="pending-score-details">
            <p style="margin:0;"><strong>Guru</strong>: ${score.nama_guru}</p>
            <p style="margin:0;"><strong>T.A.</strong>: ${score.deskripsi_ta}</p>
            <p style="margin:0;"><strong>Dikirim</strong>: <span>${kirimDateStr}</span></p>
          </div>
          <div class="pending-score-card-actions">
            <button class="btn-aksi btn-reject-score" 
                    data-key="${score.key}" 
                    data-mapel="${score.nama_mapel}" 
                    data-guru="${score.nama_guru}"
                    ${isReadOnly ? 'disabled' : ''}>
              <span class="btn-content-wrapper"><i class="fas fa-times"></i> Tolak/Revisi</span>
              <div class="premium-stamp" style="display: none;">Premium</div>
            </button>
            
            <button class="btn-aksi btn-preview-score" 
                    data-key="${score.key}" 
                    data-mapel="${score.nama_mapel}" 
                    data-guru="${score.nama_guru}">
              <i class="fas fa-eye"></i> Preview
            </button>

            <button class="btn-aksi btn-approve-score" 
                    data-key="${score.key}" 
                    data-mapel="${score.nama_mapel}"
                    ${isReadOnly ? 'disabled' : ''}>
              <span class="btn-content-wrapper"><i class="fas fa-check"></i> Setujui Nilai</span>
              <div class="premium-stamp" style="display: none;">Premium</div>
            </button>
          </div>
        </div>
      `;
    });
    
    container.innerHTML = html;
  }

  function showAlasanTolakModal(submissionKey, namaMapel, namaGuru) {
    const modal = document.getElementById('alasan-tolak-modal');
    hideMessage('alasan-tolak-modal-error');
    
    document.getElementById('alasan-tolak-submission-key').value = submissionKey;
    document.getElementById('alasan-tolak-mapel-nama').innerText = namaMapel;
    document.getElementById('alasan-tolak-guru-nama').innerText = namaGuru;
    document.getElementById('alasan-tolak-input').value = '';
    
    modal.classList.add('show');
    document.getElementById('alasan-tolak-input').focus();
  }

  function tutupAlasanTolakModal() {
    const modal = document.getElementById('alasan-tolak-modal');
    modal.classList.remove('show');
    document.getElementById('alasan-tolak-submission-key').value = '';
    hideMessage('alasan-tolak-modal-error');
  }

  function submitRejection() {
    const modal = document.getElementById('alasan-tolak-modal');
    const reason = document.getElementById('alasan-tolak-input').value.trim();
    const submissionKey = document.getElementById('alasan-tolak-submission-key').value;
    
    if (reason === "") {
      showMessage('alasan-tolak-modal-error', 'Alasan penolakan tidak boleh kosong.', true);
      document.getElementById('alasan-tolak-input').focus();
      return;
    }
    
    const btn = document.getElementById('btn-kirim-alasan-tolak-modal');
    setButtonLoading(btn, 'Mengirim...');
    
    google.script.run
      .withSuccessHandler(onScoreRejected)
      .withFailureHandler(onScoreRejectFailed)
      .rejectTeacherScore(getToken(), submissionKey, reason);
  }

  function onScoreRejected(response) {
    const btn = document.getElementById('btn-kirim-alasan-tolak-modal');
    resetButtonLoading(btn);
    
    if (response.status === 'sukses') {
      tutupAlasanTolakModal();
      showToast(response.message, 'sukses');
      bukaHalamanKelolaNilaiGuru(); // Refresh list
    } else {
      onScoreRejectFailed({ message: response.message });
    }
  }

  function onScoreRejectFailed(error) {
    const btn = document.getElementById('btn-kirim-alasan-tolak-modal');
    resetButtonLoading(btn);
    showMessage('alasan-tolak-modal-error', error.message, true);
  }

  function onScoreApproved(response) {
    setLoading(false);
    if (response.status === 'sukses') {
      showToast(response.message, 'sukses');
      setIjazahDirty(true); // <--- BARIS PENTING
      bukaHalamanKelolaNilaiGuru(); // Refresh list
    } else {
      onGagal(response);
    }
  }

  function bukaPreviewModal(submissionKey, namaMapel, namaGuru) {
    const modal = document.getElementById('preview-nilai-guru-modal');
    hideMessage('preview-modal-error');
    
    globalPreviewScores = [];
    document.getElementById('preview-filter-kelas').innerHTML = '<option value="semua">-- Semua Kelas --</option>';
    document.getElementById('preview-filter-nama').value = '';

    document.getElementById('preview-modal-title').innerText = `Preview: ${namaMapel}`;
    document.getElementById('preview-modal-info').innerHTML = `Menampilkan nilai kiriman dari <strong>${namaGuru}</strong>.`;
    document.getElementById('preview-modal-table-container').innerHTML = '<p>Memuat nilai...</p>';
    
    modal.classList.add('show');
    
    google.script.run
      .withSuccessHandler(onPreviewScoresLoaded)
      .withFailureHandler(onPreviewScoresFailed)
      .getTeacherSubmittedScores(getToken(), submissionKey);
  }

  function tutupPreviewModal() {
    document.getElementById('preview-nilai-guru-modal').classList.remove('show');
    hideMessage('preview-modal-error');
  }

  function onPreviewScoresLoaded(response) {
    const container = document.getElementById('preview-modal-table-container');
    
    if (response.status !== 'sukses') {
      container.innerHTML = '';
      showMessage('preview-modal-error', response.message, true);
      return;
    }
    
    globalPreviewScores = response.scores;
    
    const selectKelas = document.getElementById('preview-filter-kelas');
    const kelasList = (response.allKelas || []).sort(compareKelas);
    
    let optionsHtml = '<option value="semua">-- Semua Kelas --</option>';
    kelasList.forEach(kelas => {
      optionsHtml += `<option value="${kelas}">${kelas}</option>`;
    });
    selectKelas.innerHTML = optionsHtml;
    
    renderPreviewTable();
  }

  function onPreviewScoresFailed(error) {
    showMessage('preview-modal-error', error.message, true);
  }

  function renderPreviewTable() {
    const container = document.getElementById('preview-modal-table-container');
    const scores = globalPreviewScores;
    
    if (scores.length === 0) {
      container.innerHTML = '<p>Tidak ada data siswa ditemukan untuk kiriman ini.</p>';
      return;
    }
    
    const mapelInfo = (scores.length > 0) 
      ? { 
          isUS: scores.some(s => s.nilai_ujian !== "-"), 
          isUP: scores.some(s => s.nilai_praktek !== "-") 
        } 
      : { isUS: true, isUP: true };
    
    // Ambil data dari response (sudah disortir server), tapi cek mapelInfo
    const mapelInfoFromServer = globalPreviewScores.mapelInfo;
    if (mapelInfoFromServer) {
        mapelInfo.isUS = mapelInfoFromServer.isUS;
        mapelInfo.isUP = mapelInfoFromServer.isUP;
    }

    const filterKelas = document.getElementById('preview-filter-kelas').value;
    const filterNama = document.getElementById('preview-filter-nama').value.toLowerCase();
    
    const filteredScores = scores.filter(score => {
      const kelasMatch = (filterKelas === 'semua' || score.kelas === filterKelas);
      const namaMatch = (filterNama === '' || score.nama.toLowerCase().includes(filterNama));
      return kelasMatch && namaMatch;
    });

    if (filteredScores.length === 0) {
      container.innerHTML = '<p>Tidak ada siswa yang cocok dengan filter.</p>';
      return;
    }
    
    let tableHtml = '<table class="preview-scores-table">';
    tableHtml += '<thead><tr><th>Nama Siswa</th><th>Kelas</th><th>No. Ujian</th>';
    
    if (mapelInfo.isUS) {
      tableHtml += '<th class="col-nilai">Nilai Ujian</th>';
    }
    if (mapelInfo.isUP) {
      tableHtml += '<th class="col-nilai">Nilai Praktek</th>';
    }
    tableHtml += '</tr></thead><tbody>';
    
    filteredScores.forEach(score => {
      tableHtml += '<tr>';
      tableHtml += `<td>${score.nama}</td>`;
      tableHtml += `<td>${score.kelas}</td>`;
      tableHtml += `<td class="col-no-ujian">${score.no_ujian}</td>`;
      if (mapelInfo.isUS) {
        tableHtml += `<td class="col-nilai">${score.nilai_ujian}</td>`;
      }
      if (mapelInfo.isUP) {
        tableHtml += `<td class="col-nilai">${score.nilai_praktek}</td>`;
      }
      tableHtml += '</tr>';
    });
    
    tableHtml += '</tbody></table>';
    container.innerHTML = tableHtml;
  }

  // Fungsi untuk Ganti Tab
  function activateKelolaNilaiTab(tabName) {
      // Reset Active Classes
      document.querySelectorAll('#kelola-nilai-tab-bar .tab-link').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('#halaman-kelola-nilai-guru .tab-content').forEach(el => el.classList.remove('active'));
      
      // Set Active
      document.querySelector(`#kelola-nilai-tab-bar .tab-link[data-tab="${tabName}"]`).classList.add('active');
      document.getElementById(`tab-nilai-${tabName}-content`).classList.add('active');
      
      if (tabName === 'pending') {
          bukaHalamanKelolaNilaiGuru(); // Refresh pending list
      } else if (tabName === 'riwayat') {
          // Load TA jika belum ada
          if (document.getElementById('riwayat-filter-ta').options.length <= 1) {
             loadTaForRiwayat();
          }
      }
  }

  function loadTaForRiwayat() {
      const select = document.getElementById('riwayat-filter-ta');
      select.innerHTML = '<option value="">Memuat...</option>';
      google.script.run.withSuccessHandler((response) => {
          select.innerHTML = '<option value="">-- Pilih T.A. --</option>';
          if(response.status === 'sukses' && response.taList) {
              // Urutkan T.A terbaru di atas
              response.taList.sort((a,b) => b.deskripsi.localeCompare(a.deskripsi));
              response.taList.forEach(ta => {
                  select.add(new Option(ta.deskripsi, ta.id));
              });
              // Pilih otomatis yang pertama (terbaru)
              if(response.taList.length > 0) select.selectedIndex = 1;
          }
      }).withFailureHandler(onGagal).getTahunAjaranList(getToken());
  }

  function loadRiwayatNilaiGuru() {
      // Ambil elemen filter
      const selectTa = document.getElementById('riwayat-filter-ta');
      const searchInput = document.getElementById('riwayat-search');
      
      // Validasi elemen ada
      if (!selectTa) {
          showToast("Error: Dropdown Tahun Ajaran tidak ditemukan.", 'gagal');
          return;
      }

      const taId = selectTa.value;
      const search = searchInput ? searchInput.value.toLowerCase() : '';
      
      // Cek apakah TA dipilih
      if (!taId) {
          showToast("Silakan pilih Tahun Ajaran terlebih dahulu.", 'gagal');
          selectTa.focus(); // Arahkan kursor ke dropdown
          return;
      }
      
      // Tampilkan status loading di container
      const container = document.getElementById('riwayat-scores-container');
      if (container) {
          container.innerHTML = `
            <div class="text-center p-4">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2">Mengambil data riwayat dari server...</p>
            </div>`;
      }
      
      // Panggil Server
      console.log("Memanggil getRiwayatNilaiGuru dengan TA ID:", taId);
      
      google.script.run
          .withSuccessHandler((response) => {
              console.log("Data diterima dari server:", response);
              renderRiwayatTable(response, search);
          })
          .withFailureHandler((e) => {
              console.error("Server Error:", e);
              if (container) {
                  container.innerHTML = `<div class="alert alert-danger">Gagal memuat data: ${e.message}</div>`;
              }
              showToast("Gagal terhubung ke server.", 'gagal');
          })
          .getRiwayatNilaiGuru(getToken(), taId);
  }

  function renderRiwayatTable(response, searchTerm) {
      const container = document.getElementById('riwayat-scores-container');
      if (!container) return;

      // 1. Cek Error dari Server
      if (!response || response.status !== 'sukses') {
          const msg = (response && response.message) ? response.message : "Gagal terhubung ke data server.";
          container.innerHTML = `
            <div class="alert alert-danger">
              <i class="fas fa-exclamation-circle"></i> ${msg}
            </div>`;
          return;
      }
      
      let list = response.data || [];
      
      // 2. Filter Pencarian (Client Side)
      if (searchTerm) {
          const lowerTerm = searchTerm.toLowerCase();
          list = list.filter(item => {
              const guru = (item.nama_guru || "").toLowerCase();
              const mapel = (item.nama_mapel || "").toLowerCase();
              return guru.includes(lowerTerm) || mapel.includes(lowerTerm);
          });
      }
      
      // 3. Tampilan Jika Data Kosong
      if (list.length === 0) {
          container.innerHTML = `
            <div style="text-align: center; padding: 30px; background-color: #f8f9fa; border-radius: 8px; border: 1px dashed #ccc;">
                <i class="fas fa-folder-open" style="font-size: 3rem; color: #ccc; margin-bottom: 10px;"></i>
                <p style="color: #666; margin: 0;">Tidak ada riwayat pengiriman nilai untuk Tahun Ajaran ini.</p>
                <small style="color: #999;">Pastikan guru sudah mengirim nilai (klik "Simpan & Kirim") di aplikasi mereka.</small>
            </div>`;
          return;
      }
      
      // 4. Render Tabel
      let html = `
        <div style="overflow-x: auto;">
            <table class="superadmin-table" style="width: 100%; min-width: 600px;">
                <thead>
                    <tr>
                        <th style="width: 25%;">Guru</th>
                        <th style="width: 20%;">Mapel</th>
                        <th style="width: 20%;">Waktu Kirim</th>
                        <th style="width: 15%; text-align: center;">Status</th>
                        <th style="width: 20%; text-align: center;">Aksi</th>
                    </tr>
                </thead>
                <tbody>
      `;
      
      list.forEach(item => {
          // Badge Status
          let statusBadge = '<span class="badge badge-secondary">Unknown</span>';
          const st = (item.status || 'PENDING');
          
          if (st === 'APPROVED' || st === 'APPROVED_NOTIFIED') {
              statusBadge = '<span style="color: #198754; font-weight: bold; background: #d1e7dd; padding: 4px 8px; border-radius: 4px; font-size: 12px;">Disetujui</span>';
          } else if (st === 'REJECTED' || st === 'REJECTED_NOTIFIED') {
              statusBadge = '<span style="color: #dc3545; font-weight: bold; background: #f8d7da; padding: 4px 8px; border-radius: 4px; font-size: 12px;">Ditolak</span>';
          } else {
              statusBadge = '<span style="color: #fd7e14; font-weight: bold; background: #fff3cd; padding: 4px 8px; border-radius: 4px; font-size: 12px;">Menunggu</span>';
          }
          
          // Tombol PDF
          const isApproved = (st === 'APPROVED' || st === 'APPROVED_NOTIFIED');
          const btnPdfClass = isApproved ? 'btn-danger' : 'btn-secondary';
          const btnPdfStyle = isApproved ? 'background-color: #dc3545; color: white;' : 'background-color: #e9ecef; color: #aaa; cursor: not-allowed;';
          const btnPdfAttr = isApproved ? '' : 'disabled';

          html += `
            <tr style="border-bottom: 1px solid #dee2e6;">
                <td style="padding: 12px;">
                    <div style="font-weight: 600; color: #333;">${item.nama_guru}</div>
                    <div style="font-size: 12px; color: #777;">${item.email_guru}</div>
                </td>
                <td style="padding: 12px;">${item.nama_mapel}</td>
                <td style="padding: 12px;">${item.timestamp_str}</td>
                <td style="padding: 12px; text-align: center;">${statusBadge}</td>
                <td style="padding: 12px; text-align: center;">
                    <div style="display: flex; gap: 5px; justify-content: center;">
                        <button class="btn-aksi btn-lihat-rekap-admin" 
                                data-key="${item.key}" 
                                data-mapel="${item.nama_mapel}" 
                                data-guru="${item.nama_guru}"
                                style="padding: 6px 10px; font-size: 12px; width: auto;">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn-aksi btn-unduh-pdf-admin" 
                                data-key="${item.key}"
                                ${btnPdfAttr}
                                style="padding: 6px 10px; font-size: 12px; width: auto; ${btnPdfStyle}"
                                title="${isApproved ? 'Unduh PDF' : 'Menunggu Persetujuan'}">
                            <i class="fas fa-file-pdf"></i>
                        </button>
                    </div>
                </td>
            </tr>
          `;
      });
      
      html += '</tbody></table></div>';
      container.innerHTML = html;
  }

  function handleAdminDownloadPdf(submissionKey, btnElement) {
      setButtonLoading(btnElement, ""); // Spinner saja
      showToast("Membuat PDF Laporan...", 'proses');
      
      google.script.run
          .withSuccessHandler((res) => {
              resetButtonLoading(btnElement);
              if (res.status === 'sukses') {
                  onDataExported(res, 'pdf'); // Reuse fungsi download yang ada
              } else {
                  showToast(res.message, 'gagal');
              }
          })
          .withFailureHandler((e) => {
              resetButtonLoading(btnElement);
              onGagal(e);
          })
          .generateGuruPdfAdmin(getToken(), submissionKey);
  }

  // --- FUNGSI LOGIKA MODAL SET TAHUN AJAR ---

  function bukaModalSetTahunAjar() {
      // Reset UI
      document.getElementById('set-ta-select').innerHTML = '<option value="">Memuat T.A...</option>';
      document.getElementById('set-ta-table-container').innerHTML = '<p style="padding: 20px; text-align: center;">Silakan pilih Tahun Ajaran.</p>';
      document.getElementById('set-ta-filter-kelas').innerHTML = '<option value="semua">-- Semua Kelas --</option>';
      document.getElementById('set-ta-search').value = '';
      document.getElementById('btn-simpan-set-ta').disabled = true;
      isSetTaDirty = false;
      globalSetTaData = [];

      // Tampilkan Modal
      document.getElementById('modal-set-tahun-ajar').classList.add('show');

      // Ambil List Tahun Ajaran (Menggunakan fungsi yang sudah ada)
      google.script.run
        .withSuccessHandler((response) => {
            const select = document.getElementById('set-ta-select');
            select.innerHTML = '<option value="">-- Pilih Tahun Ajaran --</option>';
            if(response.status === 'sukses' && response.taList) {
                response.taList.forEach(ta => {
                    const lockText = ta.isLocked ? ' (Terkunci)' : '';
                    select.add(new Option(ta.deskripsi + lockText, ta.id));
                });
            }
        })
        .withFailureHandler(onGagal)
        .getTahunAjaranList(getToken());
  }

  function tutupModalSetTahunAjar() {
      if(isSetTaDirty) {
          if(!confirm("Ada perubahan yang belum disimpan. Yakin ingin menutup?")) return;
      }
      document.getElementById('modal-set-tahun-ajar').classList.remove('show');
  }

  function loadDataForSetTahunAjar(taId) {
      const container = document.getElementById('set-ta-table-container');
      container.innerHTML = '<div class="spinner-inline"></div> Memuat data siswa & penempatan...';
      document.getElementById('btn-simpan-set-ta').disabled = true;
      
      // Reuse fungsi backend 'getPenempatanData' yang sangat lengkap
      // Fungsi ini mengembalikan gabungan data Siswa App 1 + Enrollment App 2
      google.script.run
          .withSuccessHandler((response) => {
              if(response.status !== 'sukses') {
                  container.innerHTML = `<p class="message error">${response.message}</p>`;
                  return;
              }
              
              // Simpan data ke variabel global untuk filtering cepat client-side
              globalSetTaData = response.siswaData; // Array objek siswa
              
              // Populate Filter Kelas
              const kelasSet = new Set(globalSetTaData.map(s => s.kelas));
              const kelasList = Array.from(kelasSet).sort(compareKelas); // Gunakan helper sort yang ada
              const selectKelas = document.getElementById('set-ta-filter-kelas');
              selectKelas.innerHTML = '<option value="semua">-- Semua Kelas --</option>';
              kelasList.forEach(k => selectKelas.add(new Option(k, k)));
              
              // Render Tabel Awal
              renderTableSetTahunAjar();
              
              // Cek jika TA terkunci
              const taSelect = document.getElementById('set-ta-select');
              const taText = taSelect.options[taSelect.selectedIndex].text;
              if(taText.includes('(Terkunci)')) {
                  showToast("Tahun Ajaran ini terkunci. Anda hanya bisa melihat data.", "gagal");
              } else {
                  // Aktifkan tombol simpan (nanti akan didisable lagi jika tidak dirty, 
                  // tapi kita biarkan enable dulu agar user tahu tombolnya ada)
                  // Sebenarnya logic dirty state lebih baik:
                  document.getElementById('btn-simpan-set-ta').disabled = true; 
              }
              isSetTaDirty = false;
          })
          .withFailureHandler(onGagal)
          .getPenempatanData(getToken(), taId);
  }

  // --- [PERBAIKAN TAMPILAN] Hapus kolom No. Ujian App 2 ---
  function renderTableSetTahunAjar() {
      const container = document.getElementById('set-ta-table-container');
      const filterKelas = document.getElementById('set-ta-filter-kelas').value;
      const filterNama = document.getElementById('set-ta-search').value.toLowerCase();

      const filteredData = globalSetTaData.filter(s => {
          const matchKelas = (filterKelas === 'semua' || s.kelas === filterKelas);
          const matchNama = (s.nama.toLowerCase().includes(filterNama) || String(s.nisn).includes(filterNama));
          return matchKelas && matchNama;
      });

      if(filteredData.length === 0) {
          container.innerHTML = '<p style="padding:20px; text-align:center;">Tidak ada siswa yang cocok dengan filter.</p>';
          return;
      }

      let html = `
        <table class="siswa-table" style="width:100%; border-collapse: collapse;">
          <thead style="position: sticky; top: 0; z-index: 5; background: #f8f9fa;">
            <tr>
              <th style="width: 40px; text-align: center;"><i class="fas fa-check"></i></th>
              <th>Nama Siswa</th>
              <th style="width: 80px;">Kelas</th>
              <th style="width: 150px;">NISN</th> 
              <th style="width: 100px;">Ruang</th>
            </tr>
          </thead>
          <tbody>
      `;

      filteredData.forEach(s => {
          const checkedAttr = s.isEnrolled ? 'checked' : '';
          const rowClass = s.isEnrolled ? 'row-enrolled' : '';
          // Input ruang hanya aktif jika dicentang
          const disabledAttr = s.isEnrolled ? '' : 'disabled';

          html += `
            <tr class="${rowClass}" data-id="${s.id}" data-nama="${s.nama}">
              <td style="text-align: center;">
                <input type="checkbox" class="enroll-checkbox" ${checkedAttr}>
              </td>
              <td>${s.nama}</td>
              <td style="text-align: center;">${s.kelas}</td>
              <td style="text-align: center;">${s.nisn}</td>
              <td>
                <input type="text" class="form-control form-control-sm enroll-ruang-input" 
                      value="${s.ruang_ujian || ''}" ${disabledAttr} placeholder="R-01">
              </td>
            </tr>
          `;
      });

      html += '</tbody></table>';
      container.innerHTML = html;
  }

  function toggleSetTaCheckboxes(checkStatus) {
      const checkboxes = document.querySelectorAll('#set-ta-table-container .enroll-checkbox');
      checkboxes.forEach(cb => {
          cb.checked = checkStatus;
          // Trigger event change manual untuk update state input text
          const tr = cb.closest('tr');
          const inputs = tr.querySelectorAll('input[type="text"]');
          inputs.forEach(inp => inp.disabled = !checkStatus);
      });
      isSetTaDirty = true;
      document.getElementById('btn-simpan-set-ta').disabled = false;
  }

  // --- [PERBAIKAN SIMPAN] Otomatis hapus yang tidak dicentang ---
  function simpanSetTahunAjar() {
      const taId = document.getElementById('set-ta-select').value;
      if(!taId) return;

      setButtonLoading(document.getElementById('btn-simpan-set-ta'), 'Menyimpan...');
      
      const enrollmentData = [];
      let errorFound = false;
      let errorMsg = "";

      // 1. Loop data global kita (source of truth)
      globalSetTaData.forEach(siswa => {
          
          // 2. Cek apakah siswa ini ada di DOM (tampil di tabel saat ini)
          // untuk mengambil nilai Ruang terbaru yang mungkin baru diedit user.
          const tr = document.querySelector(`#set-ta-table-container tr[data-id="${siswa.id}"]`);
          
          // Default gunakan data di memori
          let isChecked = siswa.isEnrolled;
          let currentRuang = siswa.ruang_ujian;

          // Jika tampil di tabel, ambil nilai langsung dari input
          if (tr) {
              isChecked = tr.querySelector('.enroll-checkbox').checked;
              currentRuang = tr.querySelector('.enroll-ruang-input').value.trim();
              
              // Update memori agar sinkron
              siswa.isEnrolled = isChecked;
              siswa.ruang_ujian = currentRuang;
          }

          // 3. LOGIKA PENYIMPANAN & PENGHAPUSAN OTOMATIS
          // Backend akan menghapus SEMUA data di TA ini, lalu hanya menulis ulang
          // apa yang ada di array `enrollmentData`.
          // JADI: Jika checkbox dicentang -> Masukkan ke array (Disimpan).
          //       Jika checkbox TIDAK dicentang -> Jangan masukkan (Otomatis terhapus/tidak disimpan).

          if (isChecked) {
              const nisn = String(siswa.nisn).trim();
              
              if (!nisn || nisn === "") {
                  errorFound = true;
                  errorMsg = `Siswa <strong>${siswa.nama}</strong> dicentang tapi tidak punya NISN.`;
                  return;
              }

              enrollmentData.push({
                  id_siswa_app1: siswa.id,
                  isEnrolled: true,
                  nomor_ujian_app2: nisn, // Gunakan NISN sebagai nomor ujian
                  ruang_ujian: currentRuang,
                  nama_app1: siswa.nama
              });
          }
      });

      if(errorFound) {
          resetButtonLoading(document.getElementById('btn-simpan-set-ta'));
          showToast(errorMsg, "gagal");
          return;
      }

      google.script.run
          .withSuccessHandler((response) => {
              resetButtonLoading(document.getElementById('btn-simpan-set-ta'));
              if(response.status === 'sukses') {
                  showToast("Data berhasil disimpan!", "sukses");
                  isSetTaDirty = false;
                  document.getElementById('btn-simpan-set-ta').disabled = true;
                  loadDataForSetTahunAjar(taId); // Reload untuk verifikasi
              } else {
                  showToast(response.message, "gagal");
              }
          })
          .withFailureHandler(onGagal)
          .saveSiswaEnrollment(getToken(), taId, enrollmentData);
  }

  /**
   * [HELPER BARU] Langkah 2 dari Loading Guru: Memuat Kelas lalu Guru.
   */
  function _loadKelasForGuruPage() {
      // LANGKAH 2: Cek Cache Kelas
      if (globalKelasListCache && globalKelasListCache.length > 0) {
          console.log("Cache Kelas ditemukan, lanjut memuat Guru...");
          // Jika kelas ada di cache, panggil handler sukses secara manual
          // Parameter 'true' menandakan data dari cache
          onKelasLoadedForGuruPage({ status: "sukses", kelasList: globalKelasListCache }, true);
      } else {
          console.log("Cache Kelas kosong, memuat dari server...");
          setLoading(true, 'Memuat data kelas...', false, false);
          // Ambil Kelas dari server
          google.script.run
              .withSuccessHandler(onKelasLoadedForGuruPage) 
              .withFailureHandler(onGagal)
              .getKelas(getToken());
      }
  }

</script>
