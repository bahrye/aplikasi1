// --- [TAMBAHAN BARU] ---
// Ganti dengan ID spreadsheet "Aplikasi 2" Anda (yang berisi db_guru, db_sekolah, dll.)
const ID_SPREADSHEET_APLIKASI_2 = "1vNp3tvy9Ahy0apVBzcg7BClHsrJG85W3z-kSMjlzWuQ";

// Ganti dengan URL Web App *Aplikasi 2* yang sudah Anda deploy
// const URL_WEB_APP_APLIKASI_2 = "https://script.google.com/macros/s/AKfycbyYzdFCu9dZ0DzMZrUoY_EhEjWekF-ozVQxfKPdxjt_Irxxz9e6X3ZuC_ATcjp7PdDVog/exec";
// --- [AKHIR TAMBAHAN] ---

// --- TAMBAHAN BARU ---
const SHEET_SUPERADMIN = "Sheet_Superadmin";
// --- AKHIR TAMBAHAN ---

const MASTER_SHEET_ID = "191TzI0vRzK8xg7kGym8qUnvXz_edlCH_IJmmwMZMK_M"; 
const TARGET_FOLDER_ID = "1Xu9vSZQKAxVCNDuAXI8W5l-3xb58cQm9";

// --- TAMBAHAN BARU ---
const DONASI_FOLDER_ID = "1ETK_gUuPQsuSeNu_XbIctkvVb9JSPmS9"; // <== PENTING: Ganti ID ini
// --- AKHIR TAMBAHAN ---

const MASTER_SHEET_CACHE_KEY = 'MASTER_SHEET_DATA_V1';

const MAPEL_CACHE_KEY = 'mapel_data_v1';
const SISWA_CACHE_KEY = 'siswa_data_v1';
const NILAI_GRID_CACHE_KEY_PREFIX = 'nilai_grid_v1_';
const REKAP_NILAI_CACHE_KEY = 'rekap_nilai_v1';
const NILAI_RAPOR_GRID_CACHE_KEY_PREFIX = 'nilai_rapor_grid_v1_';
const REKAP_NILAI_RAPOR_CACHE_KEY = 'rekap_nilai_rapor_v1';

const TEMPLATE_SISWA_FILENAME = "template_import_siswa.xlsx";
const TEMPLATE_SISWA_MIMETYPE = MimeType.MICROSOFT_EXCEL;

const SHEET_REGISTRASI_PENDING = "Registrasi_Pending";
const TOKEN_EXPIRY_HOURS = 24; // Token berlaku 24 jam

const LOCKED_KELAS_CACHE_KEY = 'locked_kelas_v1';

const NILAI_IJAZAH_CACHE_KEY = 'nilai_ijazah_v1';

const SHEET_CACHE_IJAZAH = "Cache_Rekap_Ijazah";

const MASTER_NISN_INDEX_KEY = 'master_nisn_index_v1';
const HASIL_KELULUSAN_PREFIX = 'hasil_kelulusan_v1_';

const MASTER_KELULUSAN_DB_ID = "1f0xj0-tfK7hlEnAV-pIySfj_K4o46vjGV6iqo6toZRI";

// GANTI DENGAN ID FILE YANG ANDA SALIN DARI LANGKAH 2
const TEMPLATE_SISWA_FILE_ID = "1jITh9Ss5DsesT35RN-R3DDvI1AZDIi8M57F4nTLZoeM";

/**
 * Mengubah array byte (dari computeDigest) menjadi string heksadesimal.
 */
function bytesToHex(bytes) {
  return bytes.map(byte => {
    return ('0' + (byte & 0xFF).toString(16)).slice(-2);
  }).join('');
}

/**
 * Membuat string salt acak yang unik.
 */
function generateSalt() {
  return Utilities.getUuid();
}

/**
 * Membuat hash SHA-256 dari password dan salt.
 * Mengembalikan hash sebagai string hex.
 */
function hashPassword(password, salt) {
  const digest = Utilities.computeDigest(Utilities.DigestAlgorithm.SHA_256, password + salt, Utilities.Charset.UTF_8);
  return bytesToHex(digest);
}

/**
 * Memverifikasi apakah password inputan cocok dengan hash yang tersimpan.
 */
function verifyPassword(inputPassword, storedHash, storedSalt) {
  const newHash = hashPassword(inputPassword, storedSalt);
  return newHash === storedHash;
}

// GANTI FUNGSI INI
function getSheetRegistrasiPending(masterSS) {
  let sheet = masterSS.getSheetByName(SHEET_REGISTRASI_PENDING);
  if (!sheet) {
    sheet = masterSS.insertSheet(SHEET_REGISTRASI_PENDING);
    // [PERBAIKAN] Hapus 'PlainPassword' dari header (sekarang 8 kolom)
    sheet.appendRow(['Email', 'NamaSekolah', 'NPSN', 'Jenjang', 'HashedPassword', 'Salt', 'VerificationToken', 'Timestamp']);
    sheet.setFrozenRows(1);
  } else {
    // Cek header lama (NPSN)
    const header = sheet.getRange(1, 3).getValue();
    if (header !== "NPSN") {
       sheet.insertColumnBefore(3);
       sheet.getRange(1, 3).setValue("NPSN");
    }
    // [PERBAIKAN] Hapus blok 'check' untuk header 'PlainPassword'
    /*
    const headerPlain = sheet.getRange(1, 9).getValue();
    if (headerPlain !== "PlainPassword") {
      sheet.getRange(1, 9).setValue("PlainPassword");
    }
    */
  }
  return sheet;
}

/**
 * [BARU] Membuat ID Sekolah yang unik berdasarkan nama sekolah dan kode acak.
 * Memastikan ID tidak bertabrakan dengan yang sudah ada.
 */
function generateNewSekolahID(namaSekolah, sheetSekolah) {
  // 1. Buat prefix dari nama sekolah (ambil 4 huruf/angka pertama)
  // Cth: "MTS TANUNTUNG" -> "MTST"
  const prefix = namaSekolah.toUpperCase().replace(/[^A-Z0-9]/g, '').substring(0, 4) || "SKL"; // Fallback "SKL"
  
  // 2. Dapatkan semua ID yang sudah ada
  const dataSekolah = sheetSekolah.getDataRange().getValues();
  const existingIds = new Set();
  for (let i = 1; i < dataSekolah.length; i++) { // Mulai dari 1 untuk lewati header
    existingIds.add(dataSekolah[i][0]); // Kolom A adalah SekolahID
  }

  let newSekolahID = '';
  let attempts = 0;
  const MAX_ATTEMPTS = 10;

  // 3. Loop untuk mencari ID unik
  do {
    attempts++;
    let suffix = '';
    if (attempts > MAX_ATTEMPTS) {
      // Failsafe: jika 10x tabrakan (sangat langka), gunakan bagian dari UUID
      suffix = Utilities.getUuid().split('-')[0]; // e.g., "a1b2c3d4"
    } else {
      // Buat 5 karakter acak (alphanumeric)
      suffix = Math.random().toString(36).substring(2, 7); // cth: "f3xgv"
    }
    
    newSekolahID = `${prefix}-${suffix}`.toUpperCase(); // Cth: "MTST-F3XGV"
    
    if (attempts > MAX_ATTEMPTS + 5) { // Failsafe kedua
       throw new Error("Gagal total membuat ID Sekolah unik. Silakan coba lagi.");
    }
    
  } while (existingIds.has(newSekolahID)); // Loop jika ID sudah ada

  return newSekolahID;
}

function doGet(e) {
  // Cek apakah ada parameter 'v' (untuk verifikasi)
  if (e.parameter.v) {
    const token = e.parameter.v;
    // Proses token dan dapatkan pesan HTML
    const message = prosesVerifikasiToken(token);
    
    // --- PERBAIKAN DI SINI ---
    // 1. Buat template dari file 'verifikasi.html'
    const template = HtmlService.createTemplateFromFile('verifikasi');
    
    // 2. Masukkan pesan (sukses/gagal) ke dalam variabel template 'verificationMessage'
    //    Ini akan mengisi placeholder <?!= verificationMessage; ?> di file verifikasi.html
    template.verificationMessage = `<div>${message}</div>`;
    
    // 3. Evaluasi template SETELAH variabelnya diisi
    return template.evaluate()
      .setTitle('Verifikasi Akun');
    // --- AKHIR PERBAIKAN ---
  }
  
  // Jika tidak ada parameter 'v', jalankan aplikasi utama seperti biasa
  return HtmlService.createTemplateFromFile('index')
    .evaluate()
    .setTitle('Pengolahan Nilai Ijazah')
    .setFaviconUrl("https://images.icon-icons.com/547/PNG/512/1455554314_line-15_icon-icons.com_53330.png")
    .addMetaTag('viewport', 'width=device-width, initial-scale=1.0');
}

// --- TAMBAHAN BARU ---
/**
 * Mendapatkan atau membuat sheet untuk Superadmin.
 */
function getSheetSuperadmin(masterSS) {
  let sheet = masterSS.getSheetByName(SHEET_SUPERADMIN);
  if (!sheet) {
    sheet = masterSS.insertSheet(SHEET_SUPERADMIN);
    // Email, Nama Tampilan, HashedPassword, Salt
    sheet.appendRow(['Email', 'Nama', 'HashedPassword', 'Salt']);
    sheet.setFrozenRows(1);
    
    // --- BUAT AKUN SUPERADMIN PERTAMA KALI (HANYA SEKALI) ---
    // Ganti 'superadmin@email.com', 'Super Admin', dan 'password_superadmin'
    // Jalankan fungsi ini sekali manual dari editor Apps Script untuk membuat akun.
    // try {
    //   const firstSalt = generateSalt();
    //   const firstHash = hashPassword('password_superadmin', firstSalt);
    //   sheet.appendRow(['superadmin@email.com', 'Super Admin', firstHash, firstSalt]);
    // } catch (e) {}
    // --- AKHIR PEMBUATAN AKUN ---
  }
  return sheet;
}

// --- FUNGSI BARU ---
/**
 * Mengirim email verifikasi ke pengguna.
 */
function kirimEmailVerifikasi(email, namaSekolah, token) {
  try {
    const url = ScriptApp.getService().getUrl() + '?v=' + token;
    const subject = "Verifikasi Akun Aplikasi Nilai Ijazah";
    const body = `
      <div style="font-family: Arial, sans-serif; line-height: 1.6;">
        <p>Halo, Admin ${namaSekolah},</p>
        <p>Terima kasih telah mendaftar di Aplikasi Pengolahan Nilai Ijazah.</p>
        <p>Untuk mengaktifkan akun Anda, silakan klik tombol di bawah ini:</p>
        <p style="margin: 25px 0;">
          <a href="${url}" style="font-size: 16px; font-weight: bold; padding: 12px 20px; background-color: #0d6efd; color: white; text-decoration: none; border-radius: 5px;">
            Aktivasi Akun Saya
          </a>
        </p>
        <p>Jika tombol di atas tidak berfungsi, salin dan tempel URL berikut di browser Anda:</p>
        <p style="word-break: break-all;">${url}</p>
        <p>Link ini akan kedaluwarsa dalam ${TOKEN_EXPIRY_HOURS} jam.</p>
        <br>
        <p>Terima kasih.</p>
      </div>
    `;

    MailApp.sendEmail({
      to: email,
      subject: subject,
      htmlBody: body,
      name: "Admin Aplikasi Ijazah" // Nama pengirim
    });
    Logger.log("Email verifikasi terkirim ke: " + email);
  } catch (e) {
    Logger.log(`Gagal mengirim email verifikasi ke ${email}: ${e.message}`);
    // Sebaiknya jangan gagalkan registrasi jika email gagal, cukup log saja
  }
}

// GANTI FUNGSI INI di aplikasi1/Kode.gs.html

// [MODIFIKASI] Menambahkan argumen ke-7: schoolDriveFolder
function buatDatabaseSekolahBaru(namaSekolah, jenjang, npsn, email, password, masterSS, schoolDriveFolder) {
  let newSSID = null; 
  try {
    let targetFolder;
    try {
      // [MODIFIKASI] Gunakan folder yang diberikan, bukan TARGET_FOLDER_ID
      targetFolder = schoolDriveFolder; 
      if (!targetFolder) { // Fallback jika argumen tidak diberikan
        Logger.log("Peringatan: schoolDriveFolder tidak diberikan ke buatDatabaseSekolahBaru. Fallback ke TARGET_FOLDER_ID.");
        targetFolder = DriveApp.getFolderById(TARGET_FOLDER_ID);
      }
    } catch (folderError) {
      Logger.log("Error mengambil folder: " + folderError);
      throw new Error("Error: Folder target tidak ditemukan atau tidak dapat diakses.");
    }

    const namaSekolahUpper = namaSekolah.toUpperCase();
    const newSpreadsheet = SpreadsheetApp.create("Database Nilai - " + namaSekolahUpper); 
    newSSID = newSpreadsheet.getId();
    Logger.log("Spreadsheet baru dibuat (via verifikasi): " + newSSID);

    const newFile = DriveApp.getFileById(newSSID);
    targetFolder.addFile(newFile); // [MODIFIKASI] Ini sekarang menggunakan schoolDriveFolder
    DriveApp.getRootFolder().removeFile(newFile); 
    Logger.log("Spreadsheet dipindahkan ke folder: " + targetFolder.getName()); // [MODIFIKASI] Log yang benar

    // (Sisa dari fungsi ini tetap sama, tidak perlu disalin ulang)
    // ... (kode pembuatan sheetSiswa, sheetKelas, sheetMapel, dll) ...
    
    const defaultSheet = newSpreadsheet.getSheets()[0];
    
    const sheetSiswa = newSpreadsheet.insertSheet('Siswa');
    sheetSiswa.appendRow([
        'SiswaID', 'NamaSiswa', 'NISN', 'NIS_Lokal', 'JenisKelamin', 
        'TempatLahir', 'TglLahir', 'Kelas', 'Urutan'
      ]);
    sheetSiswa.getRange('C:D').setNumberFormat('@');
      
    
    const sheetKelas = newSpreadsheet.insertSheet('Kelas');
    sheetKelas.appendRow(['NamaKelas']); 

    let defaultKelas = '';
    switch (jenjang) {
      case 'SD/MI':
        defaultKelas = 'VI';
        break;
      case 'SMP/MTS':
        defaultKelas = 'IX';
        break;
      case 'SMA/MA':
        defaultKelas = 'XII';
        break;
    }
    
    if (defaultKelas) {
      sheetKelas.appendRow([defaultKelas]);
    }
    
    const sheetMapel = newSpreadsheet.insertSheet('Mapel');
    sheetMapel.appendRow(['MapelID', 'NamaMapel', 'isUS', 'isUP', 'Urutan']); 

    const defaultMapel = getDynamicDefaultMapel(jenjang, masterSS);
    if (defaultMapel.length > 0) {
      sheetMapel.getRange(2, 1, defaultMapel.length, 5).setValues(defaultMapel);
    }

    newSpreadsheet.insertSheet('Nilai_Ujian')
      .appendRow(['SiswaID', 'MapelID', 'UjianMadrasah', 'UjianPraktek']);
      
    newSpreadsheet.insertSheet('Nilai_Rapor_Akhir')
      .appendRow(['SiswaID', 'MapelID', 'SemesterID', 'Nilai_P', 'Nilai_K']);
    
    const sheetSetting = newSpreadsheet.insertSheet('Pengaturan');
    sheetSetting.appendRow(['Setting', 'Value']);
    sheetSetting.appendRow(['Bobot_Rapor', 60]);
    sheetSetting.appendRow(['Bobot_Ujian', 40]);
    sheetSetting.appendRow(['Jumlah_Semester', 5]);
    sheetSetting.appendRow(['KKM', 76]);

    const sheetDataSekolah = newSpreadsheet.insertSheet('Data_Sekolah');
    sheetDataSekolah.appendRow([
      'JenjangPilihan', 'NPSN', 'NSM', 'Alamat', 'Provinsi', 
      'KabKot', 'PilihanKabKot', 'Kecamatan', 'KelDes', 'PilihanKelDes', 
      'KodePos', 'Telepon', 'Email', 'Website', 'NamaKepsek', 'NIPKepsek'
    ]);
    let jenjangPilihanDefault = '';
    if (jenjang === 'SD/MI') {
      jenjangPilihanDefault = 'MI';
    } else if (jenjang === 'SMP/MTS') {
      jenjangPilihanDefault = 'MTS';
    } else if (jenjang === 'SMA/MA') {
      jenjangPilihanDefault = 'MA';
    }
    
    sheetDataSekolah.appendRow([
      jenjangPilihanDefault, 
      "'" + npsn, 
      '', '', '', 
      '', 'Kabupaten', '', '', 'Kelurahan', 
      '', '', '', '', '', ''
    ]);

    sheetDataSekolah.getRange('A2:P2').setNumberFormat('@');

    const sheetCacheIjazah = newSpreadsheet.insertSheet(SHEET_CACHE_IJAZAH);
    sheetCacheIjazah.appendRow(['Meta', 'LastUpdated', 'BobotRaporPct', 'BobotUjianPct', 'KKM', 'SiswaListJSON', 'MapelListJSON']);
    sheetCacheIjazah.appendRow(['SiswaID', 'MapelID', 'UjianAsli', 'RaporAsli', 'UjianBobot', 'RaporBobot', 'IjazahFinal']);
    sheetCacheIjazah.setFrozenRows(2);
    sheetCacheIjazah.hideSheet();

    newSpreadsheet.deleteSheet(defaultSheet);
    
    return newSSID;

  } catch (e) {
    Logger.log(e);
    if (newSSID) {
      DriveApp.getFileById(newSSID).setTrashed(true);
    }
    throw new Error("Gagal membuat database: " + e.message);
  }
}

function prosesVerifikasiToken(token) {
  if (!token) {
    return `<h1>Permintaan Tidak Valid</h1>
            <p>Permintaan verifikasi tidak lengkap. Pastikan Anda menggunakan link yang benar dari email.</p>`;
  }
  
  let masterSS;
  let sheetSekolah;
  let sheetPending;
  
  const lock = LockService.getScriptLock();
  lock.waitLock(15000);
  
  try {
    masterSS = SpreadsheetApp.openById(MASTER_SHEET_ID);
    sheetSekolah = masterSS.getSheetByName('Sheet_Sekolah');
    sheetPending = getSheetRegistrasiPending(masterSS); 

    const dataPending = sheetPending.getDataRange().getValues();
    const now = new Date();
    const expiryLimit = now.getTime() - (TOKEN_EXPIRY_HOURS * 60 * 60 * 1000);

    for (let i = dataPending.length - 1; i >= 1; i--) {
      const row = dataPending[i];
      const dbToken = row[6]; // Kolom G
      const dbTimestamp = new Date(row[7]).getTime(); // Kolom H

      if (dbToken === token) {
        if (dbTimestamp < expiryLimit) {
          sheetPending.deleteRow(i + 1);
          return `<h1>Token Kedaluwarsa</h1>
                  <p>Link verifikasi Anda sudah tidak berlaku (lebih dari ${TOKEN_EXPIRY_HOURS} jam). Untuk keamanan, silakan lakukan registrasi ulang.</p>`;
        }

        const email = row[0]; // Kolom A
        const namaSekolah = row[1]; // Kolom B
        const npsn = row[2]; // Kolom C
        const jenjang = row[3]; // Kolom D
        
        const dbHashedPassword = row[4]; 
        const dbSalt = row[5];
        // const dbPlainPassword = row[8]; // <-- PERBAIKAN: Dihapus, tidak dibaca lagi
        
        const emailFinder = sheetSekolah.getRange("D2:D").createTextFinder(email).matchEntireCell(true).findAll();
        
        if (emailFinder.length > 0) {
          sheetPending.deleteRow(i + 1);
          const appUrl = ScriptApp.getService().getUrl();
          return `<h1>Akun Sudah Aktif</h1>
                  <p>Akun dengan email ini sudah terverifikasi dan aktif. Anda dapat langsung login.</p>
                  <a href="${appUrl}" class="button-login">Menuju Halaman Login</a>`;
        }

        let newSchoolFolderId = null; // [MODIFIKASI] Dipindahkan ke scope luar try-catch
        try {
          let newSchoolFolder, donasiSubFolder;
          // let newSchoolFolderId = null; // [MODIFIKASI] Dihapus dari sini
          let donasiSubFolderId = null;

          try {
            const parentFolder = DriveApp.getFolderById(TARGET_FOLDER_ID);
            newSchoolFolder = parentFolder.createFolder(namaSekolah.toUpperCase());
            newSchoolFolderId = newSchoolFolder.getId();
            donasiSubFolder = newSchoolFolder.createFolder("Donasi");
            donasiSubFolderId = donasiSubFolder.getId();
          } catch (folderError) {
            Logger.log(`KRITIKAL: Gagal membuat folder drive untuk ${namaSekolah}. Error: ${folderError.message}`);
            throw new Error(`Gagal membuat folder Google Drive. ${folderError.message}`);
          }

          // --- [MODIFIKASI] Ambil Konfigurasi Default ---
          const config = getMasterConfig();
          // --- [AKHIR MODIFIKASI] ---

          const newSSID_App1 = buatDatabaseSekolahBaru(namaSekolah, jenjang, npsn, email, "dummy", masterSS, newSchoolFolder);
          const newSSID_App2 = buatDatabaseAplikasi2Baru(namaSekolah.toUpperCase(), newSchoolFolder);
          const newSekolahID = generateNewSekolahID(namaSekolah, sheetSekolah);
          
          // --- [MODIFIKASI] Tambahkan ID Template Default ke Kolom R dan S ---
          sheetSekolah.appendRow([
            newSekolahID, 
            namaSekolah.toUpperCase(), 
            jenjang, 
            email, 
            dbHashedPassword, // E
            newSSID_App1,     // F
            dbSalt,           // G
            "'" + npsn,     // H
            "NONE",         // I
            "",             // J (DonasiFileID)
            "",             // K (DonasiDataJSON)
            "",             // L (DonasiAlasanTolak)
            newSSID_App2,     // M (App2_DB_ID)
            newSchoolFolderId, // N (MainFolderID)
            donasiSubFolderId,  // O (DonasiFolderID)
            "",                 // P (KopSuratFileID)
            "",                 // Q (TanggalCetak)
            config.DEFAULT_TEMPLATE_DOC_ID || "",  // R (TemplateDocID) <-- DIUBAH
            config.DEFAULT_TEMPLATE_REKAP_ID || "", // S (TemplateRekapID) <-- DIUBAH
            "",                 // T (TempatTTD)
            "otomatis"          // U (TanggalTtdMode)
          ]);
          // --- [AKHIR MODIFIKASI] ---

          sheetPending.deleteRow(i + 1);
          clearMasterSheetCache();
          
          Logger.log(`Mulai integrasi App 2 (Global) untuk: ${newSekolahID}`);
          registerSchoolInApp2(newSekolahID, namaSekolah.toUpperCase());
          // [MODIFIKASI] Panggilan untuk mendaftarkan admin sebagai guru DIHAPUS
          // registerAdminAsGuruInApp2(email, dbPlainPassword, namaSekolah.toUpperCase(), newSekolahID, 'guru', ''); // <-- DIHAPUS
          
          const appUrl = ScriptApp.getService().getUrl();
          return `<h1>Verifikasi Berhasil!</h1>
                  <p>Akun Anda telah berhasil diaktifkan dan folder sekolah Anda telah dibuat di Google Drive.</p>
                  <p>Silakan klik tombol di bawah ini untuk masuk ke halaman login.</p>
                  <a href="${appUrl}" class="button-login">Menuju Halaman Login</a>`;
          
        } catch (e) {
          Logger.log(`Verifikasi sukses untuk ${email} TAPI GAGAL buat DB/Folder: ${e.message}`);
          if (newSchoolFolderId) { // [MODIFIKASI] Gunakan variabel dari scope luar
             try { DriveApp.getFolderById(newSchoolFolderId).setTrashed(true); } catch(err) {}
          }
          return `<h1>Verifikasi Berhasil, Namun...</h1>
                  <p>Akun Anda terverifikasi, tetapi terjadi error saat penyiapan database/folder sekolah. Silakan hubungi admin untuk tindak lanjut.</p>
                  <p style="font-size: 14px; color: #6c757d;">Detail Error: ${e.message}</p>`;
        }
      }
    }
    
    return `<h1>Token Tidak Valid</h1>
            <p>Token verifikasi Anda tidak ditemukan. Link ini mungkin sudah digunakan atau tidak valid.</p>`;

  } catch (e) {
    Logger.log(e);
    return `<h1>Error Server</h1>
            <p>Terjadi kegagalan di server. Silakan coba lagi beberapa saat, atau hubungi admin jika masalah berlanjut.</p>
            <p style="font-size: 14px; color: #6c757d;">Detail Error: ${e.message}</p>`;
  } finally {
    lock.releaseLock();
  }
}

function include(filename) {
  return HtmlService.createHtmlOutputFromFile(filename).getContent();
}

function getCachedMasterSheetData() {
  const cache = CacheService.getScriptCache();
  
  let cachedData = cache.get(MASTER_SHEET_CACHE_KEY);
  if (cachedData != null) {
    Logger.log("Mengambil data Master Sheet dari SCRIPT CACHE");
    return JSON.parse(cachedData);
  }
  
  Logger.log("Mengambil data Master Sheet dari SPREADSHEET (Fresh)");
  let masterSS;
  try {
     masterSS = SpreadsheetApp.openById(MASTER_SHEET_ID);
  } catch (e) {
    Logger.log("Gagal membuka Master Sheet ID: " + MASTER_SHEET_ID + ". Error: " + e.message);
    throw new Error("Database Master tidak dapat diakses. Hubungi Admin.");
  }

  const sheetSekolah = masterSS.getSheetByName('Sheet_Sekolah');
  if (!sheetSekolah) {
    Logger.log("Sheet 'Sheet_Sekolah' tidak ditemukan di Master Sheet.");
    throw new Error("Database Master tidak dikonfigurasi. Hubungi Admin.");
  }
  
  const dataSekolah = sheetSekolah.getDataRange().getValues();
  
  cache.put(MASTER_SHEET_CACHE_KEY, JSON.stringify(dataSekolah), 3600); 
  
  return dataSekolah;
}

function clearLockedKelasCache(sekolahID) {
  try {
    const cacheKey = LOCKED_KELAS_CACHE_KEY + "_" + sekolahID;
    CacheService.getScriptCache().remove(cacheKey);
  } catch (e) {
  }
}

function clearMasterSheetCache() {
  try {
    CacheService.getScriptCache().remove(MASTER_SHEET_CACHE_KEY);
    Logger.log("Cache Master Sheet dibersihkan.");
  } catch (e) {
    Logger.log("Gagal membersihkan cache Master Sheet: " + e.message);
  }
}

// Salin dan ganti fungsi clearRekapNilaiCache() Anda dengan yang ini
function clearRekapNilaiCache(sekolahID) {
  try {
    const cacheKey = REKAP_NILAI_CACHE_KEY + "_" + sekolahID;
    
    // --- PERBAIKAN: Gunakan variabel scriptCache ---
    const scriptCache = CacheService.getScriptCache();
    scriptCache.remove(cacheKey);
    // --- AKHIR PERBAIKAN ---

    // --- TAMBAHAN: Rekap Ujian mempengaruhi Ijazah ---
    scriptCache.remove(NILAI_IJAZAH_CACHE_KEY + "_" + sekolahID);
    // --- AKHIR TAMBAHAN ---

  } catch (e) {
     Logger.log("Gagal clearRekapNilaiCache: " + e.message);
  }
}

// Salin dan ganti fungsi clearNilaiUjianCache() Anda dengan yang ini
function clearNilaiUjianCache(sekolahID, spreadsheetID) { // <--- Terima spreadsheetID
  try {
    const scriptCache = CacheService.getScriptCache();
    // Hapus cache admin
    scriptCache.remove(NILAI_GRID_CACHE_KEY_PREFIX + 'UM' + "_" + sekolahID);
    scriptCache.remove(NILAI_GRID_CACHE_KEY_PREFIX + 'Praktek' + "_" + sekolahID);

    if (spreadsheetID) {
      const ss = SpreadsheetApp.openById(spreadsheetID);
      const sheetGuru = ss.getSheetByName('Akun_Guru');

      if (sheetGuru) {
        const guruData = sheetGuru.getDataRange().getValues();
        guruData.shift();
        // Loop semua guru di sekolah ini dan hapus cache mereka
        guruData.forEach(row => {
          const namaGuru = row[1];
          if (namaGuru) {
            const suffix = `_GURU_${namaGuru.replace(/\s+/g, '')}`;
            scriptCache.remove(NILAI_GRID_CACHE_KEY_PREFIX + 'UM' + "_" + sekolahID + suffix);
            scriptCache.remove(NILAI_GRID_CACHE_KEY_PREFIX + 'Praktek' + "_" + sekolahID + suffix);
          }
        });
      }
    } // Akhir dari 'if (spreadsheetID)'
    
    // --- TAMBAHAN: Pastikan Ijazah dan Rekap juga bersih ---
    clearRekapNilaiCache(sekolahID); // Ini sudah otomatis membersihkan Ijazah
    // --- AKHIR TAMBAHAN ---

  } catch (e) {
     Logger.log("Gagal clearNilaiUjianCache: " + e.message);
  }
}

// Salin dan ganti fungsi clearRekapNilaiRaporCache() Anda dengan yang ini
function clearRekapNilaiRaporCache(sekolahID) {
  try {
    const cacheKey = REKAP_NILAI_RAPOR_CACHE_KEY + "_" + sekolahID;
    
    // --- PERBAIKAN: Gunakan variabel scriptCache ---
    const scriptCache = CacheService.getScriptCache();
    scriptCache.remove(cacheKey);
    // --- AKHIR PERBAIKAN ---

    // --- TAMBAHAN: Rekap Rapor mempengaruhi Ijazah ---
    scriptCache.remove(NILAI_IJAZAH_CACHE_KEY + "_" + sekolahID);
    // --- AKHIR TAMBAHAN ---

  } catch (e) {
     Logger.log("Gagal clearRekapNilaiRaporCache: " + e.message);
  }
}

// Salin dan ganti fungsi clearNilaiRaporCache() Anda dengan yang ini
function clearNilaiRaporCache(sekolahID, spreadsheetID) { // <--- Terima spreadsheetID
  try {
    const scriptCache = CacheService.getScriptCache();
    scriptCache.remove(REKAP_NILAI_RAPOR_CACHE_KEY + "_" + sekolahID);
    scriptCache.remove(NILAI_IJAZAH_CACHE_KEY + "_" + sekolahID);
    
    // Hapus juga cache grid rapor (per semester)
    if (spreadsheetID) {
        const ss = SpreadsheetApp.openById(spreadsheetID);
        
        // Ambil 'jenjang' dari data sekolah
        const sheetDataSekolah = getDataSekolahSheet(ss);
        const jenjangPilihan = sheetDataSekolah.getRange('A2').getValue();
        // Tentukan jenjang berdasarkan jenjangPilihan
        const jenjang = jenjangPilihan.includes('SD') || jenjangPilihan.includes('MI') ? 'SD/MI' : (jenjangPilihan.includes('SMP') || jenjangPilihan.includes('MTS') ? 'SMP/MTS' : 'SMA/MA');

        const sheetSetting = getPengaturanSheet(ss);
        const data = sheetSetting.getRange('A1:B' + sheetSetting.getLastRow()).getValues();
        let jumlahSemester = 5;
        for (let i = 0; i < data.length; i++) {
          if (data[i][0] === 'Jumlah_Semester') {
            jumlahSemester = parseInt(data[i][1], 10) || 5;
            break;
          }
        }
        
        // Tentukan daftar semester ID
        let semesterList = [];
        if (jenjang === 'SD/MI') {
          if (jumlahSemester === 3) semesterList = [{ id: "K5_S1" }, { id: "K5_S2" }, { id: "K6_S1" }];
          else semesterList = [{ id: "K4_S1" }, { id: "K4_S2" }, { id: "K5_S1" }, { id: "K5_S2" }, { id: "K6_S1" }];
        } else if (jenjang === 'SMP/MTS') {
          semesterList = [{ id: "K7_S1" }, { id: "K7_S2" }, { id: "K8_S1" }, { id: "K8_S2" }, { id: "K9_S1" }];
        } else if (jenjang === 'SMA/MA') {
          semesterList = [{ id: "K10_S1" }, { id: "K10_S2" }, { id: "K11_S1" }, { id: "K11_S2" }, { id: "K12_S1" }];
        }
        
        // Hapus cache grid per semester
        semesterList.forEach(sem => {
            scriptCache.remove(NILAI_RAPOR_GRID_CACHE_KEY_PREFIX + sem.id + "_" + sekolahID);
        });
    }
    
  } catch (e) {
    Logger.log("Gagal clearNilaiRaporCache: " + e.message);
  }
}

// Salin dan ganti fungsi clearSiswaCache() Anda dengan yang ini
function clearSiswaCache(sekolahID, spreadsheetID) { // <--- Terima spreadsheetID
  try {
    const cacheKey = SISWA_CACHE_KEY + "_" + sekolahID;
    const scriptCache = CacheService.getScriptCache(); // <-- [PERBAIKAN]
    
    scriptCache.remove(cacheKey); // Hapus cache siswa
    
    // --- PERBAIKAN: AKTIFKAN (UN-COMMENT) DUA BARIS DI BAWAH INI ---
    clearNilaiUjianCache(sekolahID, spreadsheetID);
    clearNilaiRaporCache(sekolahID, spreadsheetID);
    // --- AKHIR PERBAIKAN ---

    clearLockedKelasCache(sekolahID); // Ini tidak perlu spreadsheetID
    
    scriptCache.remove(NILAI_IJAZAH_CACHE_KEY + "_" + sekolahID); // <-- [TAMBAHAN]

  } catch (e) {
     Logger.log("Gagal clearSiswaCache: " + e.message);
  }
}

// Salin dan ganti fungsi clearMapelCache() Anda dengan yang ini
function clearMapelCache(sekolahID, spreadsheetID) { // <--- TAMBAHKAN spreadsheetID
  try {
    const cacheKey = MAPEL_CACHE_KEY + "_" + sekolahID;
    
    // --- TAMBAHAN: Ganti dengan baris di bawah ini ---
    const scriptCache = CacheService.getScriptCache();
    scriptCache.remove(cacheKey);
    
    // Data mapel mempengaruhi SEMUA cache nilai.
    clearNilaiUjianCache(sekolahID, spreadsheetID);
    clearNilaiRaporCache(sekolahID, spreadsheetID);
    // (Kedua fungsi di atas sudah otomatis membersihkan Ijazah & Rekap)
    // --- AKHIR TAMBAHAN ---

  } catch (e) {
     Logger.log("Gagal clearMapelCache: " + e.message);
  }
}

function prosesLogin(email, password) {
  try {
    const appUrl = ScriptApp.getService().getUrl();
    const masterSS = SpreadsheetApp.openById(MASTER_SHEET_ID);
    
    const sheetSuperadmin = getSheetSuperadmin(masterSS);
    const superadminEmailFinder = sheetSuperadmin.getRange("A2:A").createTextFinder(email).matchEntireCell(true).findAll();
    
    if (superadminEmailFinder.length > 0) {
      const rowNum = superadminEmailFinder[0].getRow();
      const rowData = sheetSuperadmin.getRange(rowNum, 1, 1, sheetSuperadmin.getLastColumn()).getValues()[0];
      // Verifikasi password HASHED Superadmin (Kolom C = Hash, Kolom D = Salt)
      if (verifyPassword(password, rowData[2], rowData[3])) {
        const token = Utilities.getUuid();
        const sessionData = {
          role: 'superadmin',
          nama: rowData[1],
          lastActivity: new Date().getTime()
        };
        CacheService.getScriptCache().put('SESSION_' + token, JSON.stringify(sessionData), 21600);
        return {
          status: "sukses",
          role: "superadmin",
          nama: rowData[1],
          token: token,
          appUrl: appUrl
        };
      }
    }
    
    const sheetSekolah = masterSS.getSheetByName('Sheet_Sekolah');
    const adminEmailFinder = sheetSekolah.getRange("D2:D").createTextFinder(email).matchEntireCell(true).findAll();
    
    let cachedRow = null;
    let passwordIsValid = false;
    let rowNumGlobal = -1; // Simpan nomor baris

    if (adminEmailFinder.length > 0) {
      rowNumGlobal = adminEmailFinder[0].getRow(); // Dapatkan nomor baris
      const rowData = sheetSekolah.getRange(rowNumGlobal, 1, 1, sheetSekolah.getLastColumn()).getValues()[0];
      
      const storedHash = rowData[4]; // Kolom E (index 4)
      const storedSalt = rowData[6]; // Kolom G (index 6)
      
      if (storedHash && storedSalt) {
         passwordIsValid = verifyPassword(password, storedHash, storedSalt);
      } else if (storedHash && !storedSalt) {
         passwordIsValid = (storedHash === password);
      }

      if (passwordIsValid) {
        cachedRow = rowData;
      }
    }

    if (!passwordIsValid || !cachedRow) {
      return { status: "gagal", message: "Email atau password salah." };
    }
    
    const token = Utilities.getUuid();
    const namaSekolahUpper = cachedRow[1].toUpperCase();
    const sekolahID = cachedRow[0]; // Kolom A
    const userSpreadsheetID = cachedRow[5]; // Kolom F (App 1 DB ID)
    let app2DbId = cachedRow[12]; // Kolom M (App 2 DB ID)
    
    // Validasi ID
    if (!userSpreadsheetID) {
      return { status: "gagal", message: "Database sekolah (Kolom F) belum diatur oleh Superadmin." };
    }
    
    // Perbaikan Otomatis: Jika App 2 DB ID (Kolom M) kosong, buatkan sekarang.
    if (!app2DbId) {
      Logger.log(`PERBAIKAN LOGIN: Kolom M kosong untuk ${sekolahID}. Memulai pembuatan DB App 2...`);
      const lock = LockService.getScriptLock();
      lock.waitLock(30000);
      try {
        // Cek ulang jika proses lain sudah mengisi
        const freshApp2DbId = sheetSekolah.getRange(rowNumGlobal, 13).getValue();
        if (freshApp2DbId) {
          app2DbId = freshApp2DbId;
        } else {
          // Panggil fungsi internal (yang ada di file Kode.gs.html App 1)
          app2DbId = buatDatabaseAplikasi2Baru(namaSekolahUpper); 
          sheetSekolah.getRange(rowNumGlobal, 13).setValue(app2DbId);
          registerSchoolInApp2(sekolahID, namaSekolahUpper);
          // [MODIFIKASI] Panggilan untuk mendaftarkan admin sebagai guru DIHAPUS
          // registerAdminAsGuruInApp2(email, namaSekolahUpper, sekolahID, password, 'guru', ''); // <-- DIHAPUS
          clearMasterSheetCache();
          Logger.log(`PERBAIKAN LOGIN: Sukses. DB App 2 Dibuat: ${app2DbId}.`);
        }
      } catch (e) {
         Logger.log(`PERBAIKAN LOGIN: Gagal. ${e.message}`);
         return { status: "gagal", message: `Gagal menautkan ke DB App 2: ${e.message}` };
      } finally {
        lock.releaseLock();
      }
    }
    
    const jenjangPilihan = getJenjangPilihanFromSheet(userSpreadsheetID);
    const donasiStatus = cachedRow[8] || "NONE"; // Kolom I adalah DonasiStatus

    const sessionData = {
      role: 'admin',
      sekolahID: sekolahID,
      namaSekolah: namaSekolahUpper,
      jenjang: cachedRow[2], // Kolom C
      spreadsheetID: userSpreadsheetID, // ID DB App 1
      app2DbId: app2DbId, // ID DB App 2
      jenjangPilihan: jenjangPilihan,
      donasiStatus: donasiStatus,
      lastActivity: new Date().getTime()
    };
    CacheService.getScriptCache().put('SESSION_' + token, JSON.stringify(sessionData), 21600);
    return {
      status: "sukses",
      role: "admin",
      namaSekolah: namaSekolahUpper,
      jenjang: cachedRow[2],
      jenjangPilihan: jenjangPilihan,
      donasiStatus: donasiStatus,
      token: token,
      appUrl: appUrl
    };
  } catch (e) {
    return { status: "gagal", message: "Terjadi error: " + e.message };
  }
}

function prosesRegistrasi(namaSekolah, npsn, jenjang, email, password) {
  const lock = LockService.getScriptLock();
  lock.waitLock(15000);

  try {
    if (!namaSekolah || !npsn || !jenjang || !email || !password) {
      return { status: "gagal", message: "Semua data wajib diisi." };
    }
    if (!/^\d+$/.test(npsn)) {
      return { status: "gagal", message: "NPSN harus berupa angka." };
    }

    if (password.length < 8) {
      return { status: "gagal", message: "Password minimal harus 8 karakter." };
    }
    if (!/[a-z]/.test(password)) {
      return { status: "gagal", message: "Password harus mengandung minimal satu huruf kecil." };
    }
    if (!/[A-Z]/.test(password)) {
      return { status: "gagal", message: "Password harus mengandung minimal satu huruf besar." };
    }
    if (!/\d/.test(password)) {
      return { status: "gagal", message: "Password harus mengandung minimal satu angka." };
    }
    if (!/[^a-zA-Z0-9]/.test(password)) {
      return { status: "gagal", message: "Password harus mengandung minimal satu simbol (contoh: @, #, $, !)." };
    }

    const masterSS = SpreadsheetApp.openById(MASTER_SHEET_ID);
    let sheetSekolah = masterSS.getSheetByName('Sheet_Sekolah');
    
    if (sheetSekolah) {
       const dataSekolah = sheetSekolah.getDataRange().getValues();
       for (let i = 1; i < dataSekolah.length; i++) {
         if (dataSekolah[i][3] === email) {
           return { status: "gagal", message: "Email ini sudah terdaftar dan aktif." };
         }
         if (dataSekolah[i][7] && dataSekolah[i][7] == npsn) { 
           return { status: "gagal", message: "NPSN ini sudah terdaftar oleh sekolah lain." };
         }
       }
    } else {
       sheetSekolah = masterSS.insertSheet('Sheet_Sekolah');
       // [MODIFIKASI] Header sekarang memiliki 15 kolom (A-O)
       sheetSekolah.appendRow([
         'SekolahID', 'NamaSekolah', 'Jenjang', 'EmailAdmin', 'HashedPassword', 
         'SpreadsheetID', 'Salt', 'NPSN', 'DonasiStatus', 'DonasiFileID', 
         'DonasiDataJSON', 'DonasiAlasanTolak', 'App2_DB_ID', 'MainFolderID', 'DonasiFolderID',
         'KopSuratFileID', 'TanggalCetak'
        ]);
    }

    const sheetPending = getSheetRegistrasiPending(masterSS);
    const dataPending = sheetPending.getDataRange().getValues();
    const now = new Date();
    const expiryLimit = now.getTime() - (TOKEN_EXPIRY_HOURS * 60 * 60 * 1000);

    for (let i = dataPending.length - 1; i >= 1; i--) {
      const row = dataPending[i];
      const dbEmail = row[0];
      const dbNPSN = row[2];
      const dbTimestamp = new Date(row[7]).getTime();

      if (dbTimestamp < expiryLimit) {
        sheetPending.deleteRow(i + 1);
        continue;
      }
      
      if (dbNPSN === npsn) {
        return { status: "gagal", message: "NPSN ini sudah didaftarkan dan menunggu verifikasi." };
      }
      if (dbEmail === email) {
        kirimEmailVerifikasi(email, row[1], row[6]);
        return { 
          status: "pending", 
          message: "Email ini sudah terdaftar dan menunggu verifikasi. Kami telah mengirim ulang link verifikasi." 
        };
      }
    }

    const verificationToken = Utilities.getUuid() + Utilities.getUuid();
    const namaSekolahUpper = namaSekolah.toUpperCase();

    // --- [PERUBAHAN LOGIKA PASSWORD] ---
    // Buat HASH dan SALT
    const newSalt = generateSalt();
    const newHash = hashPassword(password, newSalt);
    
    // Simpan HASH (kolom E), SALT (kolom F), dan KOSONG (kolom I)
    sheetPending.appendRow([
      email,
      namaSekolahUpper,
      "'" + npsn,
      jenjang,
      newHash,  // <-- Simpan HASH
      newSalt,  // <-- Simpan SALT
      verificationToken,
      now,
      ""  // <-- PERBAIKAN: Kolom I (PlainPassword) sekarang KOSONG
    ]);
    // --- [AKHIR PERUBAHAN LOGIKA PASSWORD] ---
    
    kirimEmailVerifikasi(email, namaSekolahUpper, verificationToken);

    return { 
      status: "pending", 
      message: "Registrasi awal berhasil! Kami telah mengirimkan link verifikasi ke email Anda. Silakan cek inbox (atau folder spam)." 
    };
    
  } catch (e) {
    Logger.log(e);
    return { status: "gagal", message: "Terjadi error di server: " + e.message };
  } finally {
    lock.releaseLock();
  }
}

function prosesLogout(token) {
  try {
    if (token) {
       CacheService.getScriptCache().remove('SESSION_' + token);
    }
    return { status: "sukses" };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

/**
 * [MODIFIKASI SESUAI ANALISIS]
 * Memvalidasi sesi, kini "ringan" dan membaca 'donasiStatus' dari cache sesi.
 * Tidak lagi membuka Master Sheet pada setiap panggilan.
 *
 * FUNGSI INI MASIH MEMBUKA MASTER SHEET HANYA JIKA MENDETEKSI SESI LAMA/KORUP
 * (misal: !sessionData.app2DbId) UNTUK MELAKUKAN PERBAIKAN OTOMATIS.
 */
function validateAndRefreshSession(token) {
  if (!token) {
    throw new Error("Sesi tidak ditemukan. Silakan login ulang.");
  }
  const cache = CacheService.getScriptCache();
  const sessionJson = cache.get('SESSION_' + token);
  if (!sessionJson) {
    throw new Error("Sesi kedaluwarsa atau tidak valid. Silakan login ulang.");
  }
  
  const sessionData = JSON.parse(sessionJson);
  const now = new Date().getTime();

  // 1. Cek Waktu (Cepat, dari cache)
  const threeHours = 3 * 60 * 60 * 1000;
  if (now - sessionData.lastActivity > threeHours) {
    cache.remove('SESSION_' + token);
    throw new Error("Sesi Anda telah berakhir (3 jam tidak aktif). Silakan login ulang.");
  }
  
  // 2. BLOK VALIDASI/PERBAIKAN SINKRON (Hanya untuk Admin)
  if (sessionData.role === 'admin') {
    
    // Cek apakah sesi ini "lama" (dibuat sebelum donasiStatus atau app2DbId ada)
    const isSesiLama = (!sessionData.spreadsheetID || !sessionData.app2DbId || typeof sessionData.donasiStatus === 'undefined');
    
    if (isSesiLama) {
      Logger.log(`Sesi lama/tidak lengkap terdeteksi untuk ${sessionData.sekolahID}. Memvalidasi ulang dari Master Sheet...`);
      
      const lock = LockService.getScriptLock(); // Kunci untuk mencegah race condition saat memperbaiki
      lock.waitLock(30000); 
      
      try {
        // Buka Master Sheet SEKALI
        const masterSS = SpreadsheetApp.openById(MASTER_SHEET_ID);
        const sheetSekolah = masterSS.getSheetByName('Sheet_Sekolah');
        const dataSekolah = sheetSekolah.getDataRange().getValues();
        
        let targetRowData = null;
        let targetRowIndex = -1; // 1-based row index

        for (let i = 1; i < dataSekolah.length; i++) {
          if (dataSekolah[i][0] === sessionData.sekolahID) {
            targetRowData = dataSekolah[i];
            targetRowIndex = i + 1; // 1-based index (misal, baris 5 di sheet)
            break;
          }
        }
        
        if (!targetRowData) {
          throw new Error("Data sekolah tidak ditemukan lagi di Master Sheet.");
        }

        // 2a. Perbarui Sesi dengan data yang hilang
        sessionData.spreadsheetID = targetRowData[5]; // Kolom F
        sessionData.app2DbId = targetRowData[12]; // Kolom M
        sessionData.donasiStatus = targetRowData[8] || "NONE"; // Kolom I
        
        if (!sessionData.spreadsheetID) {
           throw new Error("Database sekolah (Kolom F) belum diatur oleh Superadmin.");
        }
        
        // 2b. Perbaiki App 2 DB ID jika masih kosong
        if (!sessionData.app2DbId) {
          Logger.log(`PERBAIKAN SESI: Kolom M kosong untuk ${sessionData.sekolahID}. Memulai pembuatan DB App 2...`);
          
          const namaSekolah = targetRowData[1]; // Kolom B
          const emailAdmin = targetRowData[3]; // Kolom D
          
          if (!namaSekolah || !emailAdmin) {
            throw new Error(`Data sekolah (Nama/Email) tidak lengkap untuk ${sessionData.sekolahID}. Perbaikan otomatis gagal.`);
          }
          
          // --- Logika dari getApp2DatabaseId (inline) ---
          
          // Panggil fungsi internal (yang ada di file Kode.gs.html App 1)
          // [MODIFIKASI] Pastikan Anda meneruskan folder drive jika fungsi Anda membutuhkannya
          // Kita asumsikan 'buatDatabaseAplikasi2Baru' telah dimodifikasi untuk
          // mengambil folder dari 'targetRowData' jika perlu, atau cukup membuat di root.
          // Berdasarkan file Anda, 'buatDatabaseAplikasi2Baru' *memerlukan* objek folder.
          
          let schoolDriveFolder;
          const mainFolderId = targetRowData[13]; // Kolom N
          if (mainFolderId) {
            schoolDriveFolder = DriveApp.getFolderById(mainFolderId);
          } else {
            // Fallback jika Kolom N kosong (sekolah lama)
            Logger.log(`FolderID (Kolom N) kosong untuk ${sessionData.sekolahID}. DB App 2 akan dibuat di folder Target_Folder_ID.`);
            schoolDriveFolder = DriveApp.getFolderById(TARGET_FOLDER_ID); 
          }

          const newSSID_App2 = buatDatabaseAplikasi2Baru(namaSekolah.toUpperCase(), schoolDriveFolder);
          
          // Tulis ID baru ke Kolom M
          sheetSekolah.getRange(targetRowIndex, 13).setValue(newSSID_App2);
          
          // Buat password dummy (karena kita tidak punya plain text di sini)
          const dummyPassword = "GANTI_PASSWORD_" + Math.random().toString(36).substring(2, 8);
          
          // Daftarkan ke Global App 2
          registerSchoolInApp2(sessionData.sekolahID, namaSekolah.toUpperCase());
          // (Panggilan 'registerAdminAsGuruInApp2' sudah dihapus dari file Anda, jadi kita tidak memanggilnya)
          
          Logger.log(`PERBAIKAN SESI: Sukses. DB App 2 Dibuat: ${newSSID_App2}.`);
          
          // Bersihkan cache master
          clearMasterSheetCache();
          
          // Perbarui sesi
          sessionData.app2DbId = newSSID_App2;
        }

      } catch (e) {
         throw new Error(`Gagal memperbaiki data sesi: ${e.message}`);
      } finally {
        lock.releaseLock();
      }
    }
  }

  // 3. Simpan sesi kembali dengan timestamp baru
  sessionData.lastActivity = now;
  cache.put('SESSION_' + token, JSON.stringify(sessionData), 21600);
  
  return sessionData; // Kembalikan data sesi yang LENGKAP
}

function checkToken(tokenFromClient) {
  try {
    const sessionData = validateAndRefreshSession(tokenFromClient);
    const appUrl = ScriptApp.getService().getUrl(); 

    if (sessionData.role === 'superadmin') {
      return {
        status: "sukses",
        role: "superadmin",
        namaSekolah: sessionData.nama, // Nama Superadmin
        appUrl: appUrl
      };
    } else if (sessionData.role === 'admin') {
      return {
        status: "sukses",
        role: "admin",
        isImpersonating: sessionData.isImpersonating === true,
        namaSekolah: sessionData.namaSekolah,
        jenjang: sessionData.jenjang,
        jenjangPilihan: sessionData.jenjangPilihan,
        donasiStatus: sessionData.donasiStatus || "NONE",
        appUrl: appUrl
      };
    } else if (sessionData.role === 'guru') {
      return {
        status: "sukses",
        role: "guru",
        namaSekolah: sessionData.namaSekolah,
        namaGuru: sessionData.namaGuru,
        jenjangPilihan: sessionData.jenjangPilihan,
        hasUjianPraktek: sessionData.hasUjianPraktek,
        hasUjianMadrasah: sessionData.hasUjianMadrasah,
        appUrl: appUrl
      };
    } else {
      throw new Error("Sesi tidak valid (role tidak dikenal).");
    }
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function validateSuperadminSession(token) {
  const sessionData = validateAndRefreshSession(token);
  if (sessionData.role !== 'superadmin') {
    throw new Error("Akses ditolak. Anda harus login sebagai Superadmin.");
  }
  if (sessionData.isImpersonating) {
    throw new Error("Akses ditolak. Harap kembali ke Superadmin sebelum mengelola sekolah.");
  }
  return sessionData;
}

function getSekolahList(token) {
  try {
    validateSuperadminSession(token);
    const dataSekolah = getCachedMasterSheetData();
    dataSekolah.shift();
    const sekolahList = dataSekolah.map(row => {
      return {
        id: row[0],
        nama: row[1],
        jenjang: row[2],
        email: row[3],
        spreadsheetId: row[5],
        donasiStatus: row[8] || "NONE"
      };
    });
    return { status: "sukses", sekolah: sekolahList };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function superadminDeleteSekolah(token, sekolahID, spreadsheetID) {
  const lock = LockService.getScriptLock();
  lock.waitLock(15000);
  try {
    validateSuperadminSession(token);
    if (!sekolahID || !spreadsheetID) {
      throw new Error("ID Sekolah dan ID Spreadsheet diperlukan.");
    }
    const masterSS = SpreadsheetApp.openById(MASTER_SHEET_ID);
    const sheetSekolah = masterSS.getSheetByName('Sheet_Sekolah');
    const data = sheetSekolah.getDataRange().getValues();
    let rowDeleted = false;
    for (let i = data.length - 1; i >= 1; i--) {
      if (data[i][0] === sekolahID) {
        sheetSekolah.deleteRow(i + 1);
        rowDeleted = true;
        break;
      }
    }
    if (!rowDeleted) {
      throw new Error("SekolahID tidak ditemukan di database master.");
    }
    try {
      DriveApp.getFileById(spreadsheetID).setTrashed(true);
    } catch (driveError) {
    }
    clearMasterSheetCache();
    return { status: "sukses", message: "Sekolah berhasil dihapus." };
  } catch (e) {
    return { status: "gagal", message: e.message };
  } finally {
    lock.releaseLock();
  }
}

/**
 * [SUPERADMIN] Membatalkan status premium sekolah yang sudah APPROVED.
 */
function superadminBatalkanPremium(token, sekolahID, alasan) {
  const lock = LockService.getScriptLock();
  lock.waitLock(15000);
  try {
    validateSuperadminSession(token);
    
    if (!sekolahID) throw new Error("SekolahID tidak ada.");
    if (!alasan) throw new Error("Alasan pembatalan wajib diisi.");

    const masterSS = SpreadsheetApp.openById(MASTER_SHEET_ID);
    const sheetSekolah = masterSS.getSheetByName('Sheet_Sekolah');
    const dataSekolah = sheetSekolah.getDataRange().getValues();
    
    let rowToUpdate = -1;
    for (let i = 1; i < dataSekolah.length; i++) {
      if (dataSekolah[i][0] === sekolahID) {
        rowToUpdate = i + 1;
        break;
      }
    }
    
    if (rowToUpdate === -1) {
      throw new Error("Gagal menemukan data sekolah.");
    }
    
    // Ubah status jadi REJECTED dan catat alasannya
    sheetSekolah.getRange(rowToUpdate, 9).setValue("REJECTED"); // Kolom I (Status)
    sheetSekolah.getRange(rowToUpdate, 12).setValue(alasan); // Kolom L (Alasan)
    
    clearMasterSheetCache();
    
    // Hapus juga cache kelulusan jika ada, karena fitur dimatikan
    const scriptCache = CacheService.getScriptCache();
    scriptCache.remove(MASTER_NISN_INDEX_KEY);
    scriptCache.remove(HASIL_KELULUSAN_PREFIX + sekolahID);
    
    return { status: "sukses", message: "Status premium berhasil dibatalkan." };

  } catch (e) {
    return { status: "gagal", message: e.message };
  } finally {
    lock.releaseLock();
  }
}

function superadminSaveSekolah(token, data) {
  const lock = LockService.getScriptLock();
  lock.waitLock(15000);
  try {
    validateSuperadminSession(token);
    const { id, nama, jenjang, email, password } = data;
    if (!nama || !jenjang || !email) {
      throw new Error("Nama, Jenjang, dan Email wajib diisi.");
    }
    const masterSS = SpreadsheetApp.openById(MASTER_SHEET_ID);
    const sheetSekolah = masterSS.getSheetByName('Sheet_Sekolah');
    const dataSekolah = sheetSekolah.getDataRange().getValues();
    const mode = id ? 'edit' : 'add';
    for (let i = 1; i < dataSekolah.length; i++) {
      if (dataSekolah[i][3] === email && dataSekolah[i][0] !== id) {
        throw new Error("Email ini sudah digunakan oleh sekolah lain.");
      }
    }
    if (mode === 'add') {
      if (!password) {
        throw new Error("Password wajib diisi untuk akun baru.");
      }
      
      // --- PERBAIKAN DI SINI ---
      // Menambahkan '' sebagai parameter 'npsn'
      const newSSID = buatDatabaseSekolahBaru(nama, jenjang, '', email, password, masterSS);
      // --- AKHIR PERBAIKAN ---

      const newSalt = generateSalt();
      const newHash = hashPassword(password, newSalt);
      const newSekolahID = generateNewSekolahID(nama, sheetSekolah);
      sheetSekolah.appendRow([
        newSekolahID,
        nama.toUpperCase(),
        jenjang,
        email,
        newHash,
        newSSID,
        newSalt,
        "", // NPSN (kosongkan saja, bisa diisi admin sekolah nanti)
        "NONE", // DonasiStatus
        "",     // DonasiFileID
        "",     // DonasiDataJSON
        ""      // DonasiAlasanTolak
      ]);

      // [MODIFIKASI] Panggilan untuk mendaftarkan admin sebagai guru DIHAPUS
      registerSchoolInApp2(newSekolahID, nama.toUpperCase());
      // registerAdminAsGuruInApp2(email, password, nama.toUpperCase(), newSekolahID, 'guru', ''); // <-- DIHAPUS

    } else {
      let rowToUpdate = -1;
      for (let i = 1; i < dataSekolah.length; i++) {
        if (dataSekolah[i][0] === id) {
          rowToUpdate = i + 1;
          break;
        }
      }
      if (rowToUpdate === -1) {
        throw new Error("SekolahID tidak ditemukan untuk diedit.");
      }
      sheetSekolah.getRange(rowToUpdate, 2).setValue(nama.toUpperCase());
      sheetSekolah.getRange(rowToUpdate, 3).setValue(jenjang);
      sheetSekolah.getRange(rowToUpdate, 4).setValue(email);
      if (password) {
        const newSalt = generateSalt();
        const newHash = hashPassword(password, newSalt);
        sheetSekolah.getRange(rowToUpdate, 5).setValue(newHash);
        sheetSekolah.getRange(rowToUpdate, 7).setValue(newSalt);
        
        // [MODIFIKASI] Panggilan untuk update password guru admin di App 2 DIHAPUS
        // const guruNama = `Admin ${nama.toUpperCase()}`;
        // addOrUpdateGuruInApp2(email, passwordToSync, guruNama, id, 'guru', null); // <-- DIHAPUS
      }
    }
    clearMasterSheetCache();
    return { status: "sukses", message: "Data sekolah berhasil disimpan." };
  } catch (e) {
    return { status: "gagal", message: e.message };
  } finally {
    lock.releaseLock();
  }
}

function superadminImpersonate(sekolahID, token) {
  try {
    const sessionData = validateSuperadminSession(token);
    const dataSekolahFromCache = getCachedMasterSheetData();
    let targetRow = null;
    let rowNumGlobal = -1; // Simpan nomor baris

    for (let i = 1; i < dataSekolahFromCache.length; i++) {
      if (dataSekolahFromCache[i][0] === sekolahID) {
        targetRow = dataSekolahFromCache[i];
        rowNumGlobal = i + 1; // 1-based index (data[0] is header)
        break;
      }
    }
    if (!targetRow) {
      return { status: "gagal", message: "SekolahID tidak ditemukan." };
    }
    const spreadsheetID = targetRow[5]; // Kolom F (App 1 DB ID)
    if (!spreadsheetID) {
      return { status: "gagal", message: "Sekolah ini tidak memiliki SpreadsheetID." };
    }
    
    let app2DbId = targetRow[12]; // Kolom M (App 2 DB ID)
    
    // Perbaikan Otomatis: Jika App 2 DB ID (Kolom M) kosong, buatkan sekarang.
    if (!app2DbId) {
      Logger.log(`PERBAIKAN IMPERSONATE: Kolom M kosong untuk ${sekolahID}. Memulai pembuatan DB App 2...`);
      const lock = LockService.getScriptLock();
      lock.waitLock(30000);
      try {
        const masterSS = SpreadsheetApp.openById(MASTER_SHEET_ID);
        const sheetSekolah = masterSS.getSheetByName('Sheet_Sekolah');
        
        const freshApp2DbId = sheetSekolah.getRange(rowNumGlobal, 13).getValue();
        if (freshApp2DbId) {
          app2DbId = freshApp2DbId;
        } else {
          const namaSekolah = targetRow[1];
          const emailAdmin = targetRow[3];
          
          app2DbId = buatDatabaseAplikasi2Baru(namaSekolah.toUpperCase());
          sheetSekolah.getRange(rowNumGlobal, 13).setValue(app2DbId);
          
          // Daftarkan dengan password dummy
          const dummyPassword = "GANTI_PASSWORD_" + Math.random().toString(36).substring(2, 8);
          
          registerSchoolInApp2(sekolahID, namaSekolah.toUpperCase());
          // [MODIFIKASI] Panggilan untuk mendaftarkan admin sebagai guru DIHAPUS
          // registerAdminAsGuruInApp2(emailAdmin, namaSekolah.toUpperCase(), sekolahID, dummyPassword, 'guru', ''); // <-- DIHAPUS
          
          clearMasterSheetCache();
          Logger.log(`PERBAIKAN IMPERSONATE: Sukses. DB App 2 Dibuat: ${app2DbId}.`);
        }
      } catch (e) {
         Logger.log(`PERBAIKAN IMPERSONATE: Gagal. ${e.message}`);
         return { status: "gagal", message: `Gagal menautkan ke DB App 2: ${e.message}` };
      } finally {
        lock.releaseLock();
      }
    }
    
    const jenjangPilihan = getJenjangPilihanFromSheet(spreadsheetID);
    
    sessionData.originalRole = 'superadmin';
    sessionData.role = 'admin';
    sessionData.isImpersonating = true;
    sessionData.sekolahID = sekolahID;
    sessionData.namaSekolah = targetRow[1].toUpperCase();
    sessionData.jenjang = targetRow[2];
    sessionData.spreadsheetID = spreadsheetID;
    sessionData.app2DbId = app2DbId; // Simpan App 2 ID di sesi
    sessionData.jenjangPilihan = jenjangPilihan;
    sessionData.donasiStatus = targetRow[8] || "NONE"; // Simpan Donasi Status

    const appUrl = ScriptApp.getService().getUrl();

    CacheService.getScriptCache().put('SESSION_' + token, JSON.stringify(sessionData), 21600);

    return {
      status: "sukses",
      role: "admin",
      isImpersonating: true,
      namaSekolah: sessionData.namaSekolah,
      jenjang: sessionData.jenjang,
      jenjangPilihan: jenjangPilihan,
      donasiStatus: sessionData.donasiStatus, // Kirim ke client
      token: token,
      appUrl: appUrl
    };
  } catch (e) {
    return { status: "gagal", message: "Terjadi error: " + e.message };
  }
}

function superadminReturn(token) {
  try {
    const sessionData = validateAndRefreshSession(token);
    if (sessionData.originalRole !== 'superadmin') {
       throw new Error("Tidak dapat kembali. Sesi asal bukan Superadmin.");
    }

    const newSessionData = {
        role: 'superadmin',
        nama: sessionData.nama,
        lastActivity: new Date().getTime()
    };
    CacheService.getScriptCache().put('SESSION_' + token, JSON.stringify(newSessionData), 21600);

    return {
      status: "sukses",
      role: "superadmin",
      namaSekolah: newSessionData.nama
    };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function getDynamicDefaultMapel(jenjang, masterSpreadsheet) {
  try {
    const mapelSheet = masterSpreadsheet.getSheetByName('Data_Mapel_Default');
    if (!mapelSheet) {
      Logger.log("Peringatan: Sheet 'Data_Mapel_Default' tidak ditemukan di Master Sheet.");
      return []; 
    }
    
    const data = mapelSheet.getDataRange().getValues();
    data.shift(); 

    const defaultMapel = [];
    
    for (let i = 0; i < data.length; i++) {
      const row = data[i];
      const jenjangData = row[0]; 
      const mapelID = row[1];     
      const namaMapel = row[2];   
      
      const val_us = row[3]; 
      const val_up = row[4]; 

      let isUS_default = false;
      let isUP_default = false;

      if (val_us === true) {
        isUS_default = true;
      } else if (typeof val_us === 'string') {
        isUS_default = val_us.trim().toUpperCase() === 'TRUE';
      }

      if (val_up === true) {
        isUP_default = true;
      } else if (typeof val_up === 'string') {
        isUP_default = val_up.trim().toUpperCase() === 'TRUE';
      }
      
      if (jenjangData === jenjang || jenjangData === 'UMUM') {
        if (mapelID && namaMapel) { 
          defaultMapel.push([mapelID, namaMapel, isUS_default, isUP_default, i + 1]);
        }
      }
    }
    
    return defaultMapel;

  } catch (e) {
    Logger.log("Error saat mengambil mapel dinamis: " + e.message);
    return []; 
  }
}

function getMapelSheet(ss) {
  let userSpreadsheet = ss;
  if (!userSpreadsheet) {
    const { spreadsheetID } = validateAdminSession(); 
    if (!spreadsheetID) throw new Error("Spreadsheet ID Sesi tidak ditemukan.");
    userSpreadsheet = SpreadsheetApp.openById(spreadsheetID);
  }

  const sheetMapel = userSpreadsheet.getSheetByName('Mapel');
  if (!sheetMapel) throw new Error("Sheet 'Mapel' tidak ditemukan.");
  
  try {
    const header = sheetMapel.getRange('E1').getValue();
    if (header !== 'Urutan') {
      sheetMapel.getRange('E1').setValue('Urutan');
    }
  } catch (e) {
    Logger.log("Gagal mengecek/membuat header Urutan Mapel: " + e.message);
  }

  return sheetMapel;
}

// Salin dan GANTI fungsi getMapel() Anda dengan yang ini
function getMapel(token) {
  try {
    const { sessionData, spreadsheetID } = validateAdminOrGuruSession(token);
    const ss = SpreadsheetApp.openById(spreadsheetID);
    
    // Panggil helper internal baru
    const mapel = _getMapelInternal(ss, sessionData.sekolahID);
    
    return { status: "sukses", mapel: mapel };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function createMapel(token, mapelID, namaMapel) {
  try {
    const { sessionData, spreadsheetID } = validateAdminSession(token);
    if (!mapelID || !namaMapel) return { status: "gagal", message: "Data tidak lengkap." };
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheetMapel = getMapelSheet(ss);
    const data = sheetMapel.getDataRange().getValues();
    let maxUrutan = 0;
    for (let i = 1; i < data.length; i++) {
      if (data[i][0] && data[i][0].toUpperCase() === mapelID.toUpperCase()) {
        return { status: "gagal", message: "MapelID sudah ada." };
      }
      const urutanNum = Number(data[i][4] || 0);
      if (urutanNum > maxUrutan) maxUrutan = urutanNum;
    }
    const newUrutan = maxUrutan + 1;
    const defaultIsUS = false;
    const defaultIsUP = false;

    sheetMapel.appendRow([mapelID, namaMapel, defaultIsUS, defaultIsUP, newUrutan]);
    clearMapelCache(sessionData.sekolahID, spreadsheetID);

    // --- PERUBAHAN DI SINI ---
    // Buat objek data baru untuk dikirim kembali ke klien
    const newMapelObject = {
      id: mapelID,
      nama: namaMapel,
      isUS: defaultIsUS,
      isUP: defaultIsUP,
      urutan: newUrutan,
      originalUrutan: newUrutan,
      originalIsUS: defaultIsUS,
      originalIsUP: defaultIsUP
    };
    
    return { status: "sukses", newData: newMapelObject };
    // --- AKHIR PERUBAHAN ---

  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function updateMapel(token, mapelID, namaMapel) {
  try {
    const { sessionData, spreadsheetID } = validateAdminSession(token);
    if (!mapelID || !namaMapel) return { status: "gagal", message: "Data tidak lengkap." };
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheetMapel = getMapelSheet(ss);
    const data = sheetMapel.getDataRange().getValues();
    
    for (let i = 1; i < data.length; i++) {
      if (data[i][0] === mapelID) {
        
        sheetMapel.getRange(i + 1, 2).setValue(namaMapel); // Update nama
        clearMapelCache(sessionData.sekolahID, spreadsheetID);

        // --- PERUBAHAN DI SINI ---
        // Kirim kembali data lengkap dari baris yang diperbarui
        const updatedMapelObject = {
          id: data[i][0],
          nama: namaMapel, // Nama baru dari input
          isUS: data[i][2] || false,
          isUP: data[i][3] || false,
          urutan: Number(data[i][4] || i),
          originalUrutan: Number(data[i][4] || i),
          originalIsUS: data[i][2] || false,
          originalIsUP: data[i][3] || false
        };

        return { status: "sukses", newData: updatedMapelObject };
        // --- AKHIR PERUBAHAN ---
      }
    }
    return { status: "gagal", message: "MapelID tidak ditemukan." };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function deleteMapel(token, mapelID) {
  try {
    const { sessionData, spreadsheetID } = validateAdminSession(token);
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheetMapel = getMapelSheet(ss);
    const data = sheetMapel.getDataRange().getValues();
    for (let i = data.length - 1; i >= 1; i--) {
      if (data[i][0] === mapelID) {
        sheetMapel.deleteRow(i + 1);
        clearMapelCache(sessionData.sekolahID, spreadsheetID);
        return { status: "sukses" };
      }
    }
    return { status: "gagal", message: "MapelID tidak ditemukan." };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function syncDefaultMapel(token) {
  try {
    const { sessionData, spreadsheetID } = validateAdminSession(token);
    const jenjang = sessionData.jenjang;
    const masterSS = SpreadsheetApp.openById(MASTER_SHEET_ID);
    const sourceData = getDynamicDefaultMapel(jenjang, masterSS);
    const sourceMap = new Map();
    sourceData.forEach(row => {
      sourceMap.set(row[0], { name: row[1], isUS: row[2], isUP: row[3], urutan: row[4] });
    });
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheetMapel = getMapelSheet(ss);
    const targetRange = sheetMapel.getDataRange();
    const targetValues = targetRange.getValues();
    targetValues.shift();
    const targetIdMap = new Map(targetValues.map(row => [row[0], true]));
    let maxUrutan = 0;
    targetValues.forEach(row => {
      const urutanNum = Number(row[4] || 0);
      if (urutanNum > maxUrutan) maxUrutan = urutanNum;
    });
    const mapelToAdd = [];
    let changesMade = false;
    for (let i = 0; i < targetValues.length; i++) {
      const targetId = targetValues[i][0];
      const sourceRowData = sourceMap.get(targetId);
      if (sourceRowData) {
        if (targetValues[i][2] != sourceRowData.isUS || targetValues[i][3] != sourceRowData.isUP) {
          targetValues[i][2] = sourceRowData.isUS;
          targetValues[i][3] = sourceRowData.isUP;
          changesMade = true;
        }
      }
    }
    for (const [sourceId, sourceData] of sourceMap.entries()) {
      if (!targetIdMap.has(sourceId)) {
        maxUrutan++;
        mapelToAdd.push([sourceId, sourceData.name, sourceData.isUS, sourceData.isUP, maxUrutan]);
      }
    }
    if (changesMade) {
      sheetMapel.getRange(2, 1, targetValues.length, targetValues[0].length).setValues(targetValues);
    }
    if (mapelToAdd.length > 0) {
      sheetMapel.getRange(sheetMapel.getLastRow() + 1, 1, mapelToAdd.length, 5).setValues(mapelToAdd);
    }
    clearMapelCache(sessionData.sekolahID, spreadsheetID);
    return { status: "sukses" };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function deleteAllMapel(token) {
  try {
    const { sessionData, spreadsheetID } = validateAdminSession(token);
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheetMapel = getMapelSheet(ss);
    const lastRow = sheetMapel.getLastRow();
    if (lastRow > 1) {
      sheetMapel.deleteRows(2, lastRow - 1);
    }
    clearMapelCache(sessionData.sekolahID, spreadsheetID);
    return { status: "sukses", message: "Semua mapel telah dihapus." };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function saveMapelTipeUjianBatch(token, tipeUjianData) {
  let spreadsheetID, sessionData;
  let app2DbId; // <-- BARU
  
  try {
    const session = validateAdminSession(token);
    spreadsheetID = session.spreadsheetID;
    sessionData = session.sessionData;
    
    // --- TAMBAHAN 1: Dapatkan ID Aplikasi 2 ---
    app2DbId = getApp2DatabaseId(token); // Gunakan helper yang sudah ada
    if (!app2DbId) {
      throw new Error("Database Aplikasi 2 tidak ditemukan. Sinkronisasi Tipe Ujian gagal.");
    }
    // --- AKHIR TAMBAHAN 1 ---
    
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
  
  const lock = LockService.getDocumentLock(); // Ini mengunci App 1
  lock.waitLock(15000);
  
  try {
    // --- Update App 1 (Logika Asli Anda) ---
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheetMapel = getMapelSheet(ss);
    const dataRange = sheetMapel.getDataRange();
    const data = dataRange.getValues();
    const dataMap = new Map(tipeUjianData.map(item => [item.id, item]));
    let changesMade = false;
    const valuesToUpdate = [];
    
    for (let i = 1; i < data.length; i++) {
      const id = data[i][0];
      const newData = dataMap.get(id);
      let currentIsUS = data[i][2];
      let currentIsUP = data[i][3];
      if (newData) {
        if (currentIsUS != newData.isUS || currentIsUP != newData.isUP) {
          currentIsUS = newData.isUS;
          currentIsUP = newData.isUP;
          changesMade = true;
        }
      }
      valuesToUpdate.push([currentIsUS, currentIsUP]);
    }
    
    if (changesMade) {
      if (valuesToUpdate.length > 0) {
        sheetMapel.getRange(2, 3, valuesToUpdate.length, 2).setValues(valuesToUpdate);
      }
      clearMapelCache(sessionData.sekolahID, spreadsheetID);
    }
    
    // --- TAMBAHAN 2: Sinkronisasi Otomatis ke App 2 ---
    if (changesMade) {
      Logger.log("Perubahan Tipe Ujian terdeteksi, menyinkronkan ke Aplikasi 2 (db_mapel)...");
      
      const ss_app2 = SpreadsheetApp.openById(app2DbId);
      // Panggil helper yang tadi Anda salin
      const sheetMapelApp2 = getMapelSheet_App2(ss_app2); 
      
      const app2DataRange = sheetMapelApp2.getDataRange();
      const app2Data = app2DataRange.getValues();
      let app2ChangesMade = false;
      
      // Loop data di App 2 (mulai dari baris 2, index 1)
      for (let i = 1; i < app2Data.length; i++) {
        const mapelId = app2Data[i][1]; // Kolom B = mapel
        const newData = dataMap.get(mapelId); // Cek apakah mapel ini ada di data yang di-submit
        
        if (newData) {
          // Mapel ini ada di daftar yang diubah.
          const old_isUS = app2Data[i][5]; // Kolom F
          const old_isUP = app2Data[i][6]; // Kolom G
          
          if (old_isUS !== newData.isUS || old_isUP !== newData.isUP) {
            // Tulis nilai baru
            app2Data[i][5] = newData.isUS;
            app2Data[i][6] = newData.isUP;
            app2ChangesMade = true;
          }
        }
      }
      
      // Tulis kembali data ke App 2 jika ada perubahan
      if (app2ChangesMade) {
        app2DataRange.setValues(app2Data);
        Logger.log("Sinkronisasi Tipe Ujian ke Aplikasi 2 Selesai.");
      }
    }
    // --- AKHIR TAMBAHAN 2 ---

    return { status: "sukses" };
  } catch (e) {
    return { status: "gagal", message: e.message };
  } finally {
    lock.releaseLock();
  }
}

function saveMapelUrutanBatch(token, urutanData) {
  let spreadsheetID, sessionData;
  try {
    const session = validateAdminSession(token);
    spreadsheetID = session.spreadsheetID;
    sessionData = session.sessionData;
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
  const lock = LockService.getDocumentLock();
  lock.waitLock(15000);
  try {
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getMapelSheet(ss);
    const dataRange = sheet.getDataRange();
    const data = dataRange.getValues();
    const urutanMap = new Map(urutanData.map(item => [item.id, item.urutan]));
    let changesMade = false;
    for (let i = 1; i < data.length; i++) {
      const id = data[i][0];
      const newUrutan = urutanMap.get(id);
      if (newUrutan !== undefined && data[i][4] != newUrutan) {
        data[i][4] = newUrutan;
        changesMade = true;
      }
    }
    if (changesMade) {
      const valuesToUpdate = data.slice(1).map(row => [row[4]]);
      if (valuesToUpdate.length > 0) {
        sheet.getRange(2, 5, valuesToUpdate.length, 1).setValues(valuesToUpdate);
      }
      clearMapelCache(sessionData.sekolahID, spreadsheetID);
    }
    return { status: "sukses" };
  } catch (e) {
    return { status: "gagal", message: e.message };
  } finally {
    lock.releaseLock();
  }
}

function getSiswaSheet(ss) {
  let userSpreadsheet = ss;
  if (!userSpreadsheet) {
    const { spreadsheetID } = validateAdminSession();
    if (!spreadsheetID) throw new Error("Spreadsheet ID Sesi tidak ditemukan.");
    userSpreadsheet = SpreadsheetApp.openById(spreadsheetID);
  }

  let sheet = userSpreadsheet.getSheetByName('Siswa');
  if (!sheet) {
    sheet = userSpreadsheet.insertSheet('Siswa');
    sheet.appendRow([
        'SiswaID', 'NamaSiswa', 'NISN', 'NIS_Lokal', 'JenisKelamin', 
        'TempatLahir', 'TglLahir', 'Kelas'
      ]);
    SpreadsheetApp.flush();
  }
  
  try {
    sheet.getRange('C:D').setNumberFormat('@');
  } catch (e) {
    Logger.log("Gagal set format teks untuk NISN/NIS: " + e.message);
  }
  
  try {
    const header = sheet.getRange('I1').getValue();
    if (header !== 'Urutan') {
      sheet.getRange('I1').setValue('Urutan');
    }
  } catch (e) {
    Logger.log("Gagal mengecek/membuat header Urutan: " + e.message);
  }

  return sheet;
}

// Salin dan GANTI fungsi getSiswa() Anda dengan yang ini
function getSiswa(token) {
  try {
    const { sessionData, spreadsheetID } = validateAdminOrGuruSession(token);
    const sekolahID = sessionData.sekolahID;
    
    // Panggil helper internal yang mengelola cache
    const siswaList = _getSiswaInternal(spreadsheetID, sekolahID);
    
    return { status: "sukses", siswa: siswaList };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function createSiswa(token, dataSiswa) {
  // --- PERBAIKAN: Tambahkan LockService ---
  const lock = LockService.getDocumentLock();
  lock.waitLock(15000); // Tunggu 15 detik
  // --- AKHIR PERBAIKAN ---
  try {
    const { sessionData, spreadsheetID } = validateAdminSession(token);
    if (!dataSiswa.nama || !dataSiswa.nisn || !dataSiswa.jk || !dataSiswa.kelas) {
      return { status: "gagal", message: "Data wajib diisi." };
    }
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getSiswaSheet(ss);
    const lastRow = sheet.getLastRow();
    const nisnSet = new Set();
    let maxIdNum = 0;
    let maxUrutan = 0;
    if (lastRow > 1) {
      const dataRange = sheet.getRange("A2:I" + lastRow).getValues();
      dataRange.forEach(row => {
        if (row[2]) nisnSet.add(String(row[2]));
        const idNum = parseInt((row[0] || 'SIS-0').split('-')[1] || 0);
        if (idNum > maxIdNum) maxIdNum = idNum;
        const urutanNum = Number(row[8] || 0);
        if (urutanNum > maxUrutan) maxUrutan = urutanNum;
      });
    }
    if (nisnSet.has(String(dataSiswa.nisn))) {
      return { status: "gagal", message: "NISN sudah terdaftar." };
    }
    const newIdNum = maxIdNum + 1;
    const newUrutan = maxUrutan + 1;
    const newSiswaID = "SIS-" + newIdNum;
    const formattedNisn = dataSiswa.nisn ? "'" + dataSiswa.nisn : null;
    const formattedNisLokal = dataSiswa.nisLokal ? "'" + dataSiswa.nisLokal : null;
    sheet.appendRow([
      newSiswaID, dataSiswa.nama, formattedNisn, formattedNisLokal,
      dataSiswa.jk, dataSiswa.tempatLahir, dataSiswa.tglLahir || null,
      dataSiswa.kelas, newUrutan
    ]);

    clearSiswaCache(sessionData.sekolahID, spreadsheetID);

    // --- PERUBAHAN DI SINI ---
    // Buat objek siswa baru untuk dikirim kembali ke klien
    const newSiswaObject = {
      id: newSiswaID,
      nama: dataSiswa.nama,
      nisn: dataSiswa.nisn, // Kirim nilai mentah
      nisLokal: dataSiswa.nisLokal || '',
      jk: dataSiswa.jk || '',
      tempatLahir: dataSiswa.tempatLahir || '',
      tglLahir: dataSiswa.tglLahir || '',
      kelas: dataSiswa.kelas || '',
      urutan: newUrutan,
      originalUrutan: newUrutan // Penting untuk logika 'dirty check'
    };

    return { status: "sukses", newData: newSiswaObject };
    // --- AKHIR PERUBAHAN ---

  } catch (e) {
    return { status: "gagal", message: e.message };
  } finally {
    if (lock) lock.releaseLock();
  }
}

function updateSiswa(token, dataSiswa) {
  try {
    const { sessionData, spreadsheetID } = validateAdminSession(token);
    if (!dataSiswa.id) return { status: "gagal", message: "ID Siswa hilang." };
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getSiswaSheet(ss);
    const data = sheet.getDataRange().getValues();
    let rowToUpdate = -1;
    for (let i = 1; i < data.length; i++) {
      if (data[i][2] == dataSiswa.nisn && data[i][0] != dataSiswa.id) {
        return { status: "gagal", message: "NISN sudah digunakan." };
      }
      if (data[i][0] == dataSiswa.id) rowToUpdate = i + 1;
    }
    if (rowToUpdate === -1) return { status: "gagal", message: "Siswa tidak ditemukan." };
    const formattedNisn = dataSiswa.nisn ? "'" + dataSiswa.nisn : null;
    const formattedNisLokal = dataSiswa.nisLokal ? "'" + dataSiswa.nisLokal : null;
    const updatedRow = [
      dataSiswa.id, dataSiswa.nama, formattedNisn, formattedNisLokal,
      dataSiswa.jk, dataSiswa.tempatLahir, dataSiswa.tglLahir || null, dataSiswa.kelas
    ];
    sheet.getRange(rowToUpdate, 1, 1, updatedRow.length).setValues([updatedRow]);
    
    clearSiswaCache(sessionData.sekolahID, spreadsheetID);

    // --- PERUBAHAN DI SINI ---
    // Ambil 'urutan' asli dari data yang dibaca (data adalah array 0-indexed, rowToUpdate 1-indexed)
    const urutanAsli = data[rowToUpdate - 1][8]; // Kolom I adalah index 8
    
    // Gabungkan dataSiswa dari klien dengan urutan dari server
    const updatedSiswaObject = { 
      ...dataSiswa, // Data dari form (id, nama, nisn, dll)
      urutan: urutanAsli, 
      originalUrutan: urutanAsli 
    };

    return { status: "sukses", newData: updatedSiswaObject };
    // --- AKHIR PERUBAHAN ---

  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function deleteSiswa(token, siswaID) {
  try {
    const { sessionData, spreadsheetID } = validateAdminSession(token); // <--- Ambil spreadsheetID
    if (!siswaID) return { status: "gagal", message: "SiswaID kosong." };
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getSiswaSheet(ss);
    const data = sheet.getDataRange().getValues();
    for (let i = data.length - 1; i >= 1; i--) {
      if (data[i][0] == siswaID) {
        sheet.deleteRow(i + 1);
        
        // --- PERBAIKAN DI SINI ---
        clearSiswaCache(sessionData.sekolahID, spreadsheetID);
        // --- AKHIR PERBAIKAN ---

        return { status: "sukses" };
      }
    }
    return { status: "gagal", message: "Siswa tidak ditemukan." };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function deleteAllSiswa(token) {
  try {
    const { sessionData, spreadsheetID } = validateAdminSession(token); // <--- Ambil spreadsheetID
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getSiswaSheet(ss);
    const lastRow = sheet.getLastRow();
    if (lastRow > 1) {
      sheet.deleteRows(2, lastRow - 1);
    }
    
    // --- PERBAIKAN DI SINI ---
    clearSiswaCache(sessionData.sekolahID, spreadsheetID);
    // --- AKHIR PERBAIKAN ---

    return { status: "sukses", message: "Semua data siswa dihapus." };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function getDataSekolahSheet(ss) {
  let userSpreadsheet = ss;
  if (!userSpreadsheet) {
    const { spreadsheetID } = validateAdminSession();
    if (!spreadsheetID) throw new Error("Spreadsheet ID Sesi tidak ditemukan.");
    userSpreadsheet = SpreadsheetApp.openById(spreadsheetID);
  }

  let sheet = userSpreadsheet.getSheetByName('Data_Sekolah');
  if (!sheet) {
    sheet = userSpreadsheet.insertSheet('Data_Sekolah');
    sheet.appendRow([
      'JenjangPilihan', 'NPSN', 'NSM', 'Alamat', 'Provinsi', 
      'KabKot', 'PilihanKabKot', 'Kecamatan', 'KelDes', 'PilihanKelDes', 
      'KodePos', 'Telepon', 'Email', 'Website', 'NamaKepsek', 'NIPKepsek'
    ]);
    sheet.appendRow([
      '', '', '', '', '', 
      '', 'Kabupaten', '', '', 'Kelurahan', 
      '', '', '', '', '', ''
    ]);
    sheet.getRange('A2:P2').setNumberFormat('@');
    SpreadsheetApp.flush(); 
  }
  return sheet;
}

function getJenjangPilihanFromSheet(spreadsheetID) {
  try {
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getDataSekolahSheet(ss); 
    const jenjangPilihan = sheet.getRange('A2').getValue(); 
    return String(jenjangPilihan);
  } catch (e) {
    Logger.log(`Gagal mengambil jenjangPilihan dari sheet ${spreadsheetID}: ${e.message}`);
    return ""; 
  }
}

function getSchoolData(token) {
  try {
    const { sessionData, spreadsheetID } = validateAdminSession(token);
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getDataSekolahSheet(ss);
    const data = sheet.getRange('A2:P2').getValues()[0];
    const dataSekolah = {
      jenjangBase: sessionData.jenjang,
      namaSekolah: sessionData.namaSekolah,
      jenjangPilihan: data[0],
      npsn: data[1],
      nsm: data[2],
      alamat: data[3],
      provinsi: data[4],
      kabKot: data[5],
      pilihanKabKot: data[6],
      kecamatan: data[7],
      kelDes: data[8],
      pilihanKelDes: data[9],
      kodePos: data[10],
      telepon: data[11],
      email: data[12],
      website: data[13],
      namaKepsek: data[14],
      nipKepsek: data[15]
    };
    return { status: "sukses", data: dataSekolah };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function saveSchoolData(token, data) {
  try {
    const { sessionData, spreadsheetID } = validateAdminSession(token);
    sessionData.jenjangPilihan = data.jenjangPilihan;
    CacheService.getScriptCache().put('SESSION_' + token, JSON.stringify(sessionData), 21600);

    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getDataSekolahSheet(ss);
    const dataArray = [
      data.jenjangPilihan, data.npsn, data.nsm, data.alamat, data.provinsi,
      data.kabKot, data.pilihanKabKot, data.kecamatan, data.kelDes, data.pilihanKelDes,
      data.kodePos, data.telepon, data.email, data.website, data.namaKepsek, data.nipKepsek
    ];
    sheet.getRange('A2:P2').setValues([dataArray]);
    return { status: "sukses" };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function getPengaturanSheet(ss) {
  let userSpreadsheet = ss;
  if (!userSpreadsheet) {
    const { spreadsheetID } = validateAdminSession();
    if (!spreadsheetID) throw new Error("Spreadsheet ID Sesi tidak ditemukan.");
    userSpreadsheet = SpreadsheetApp.openById(spreadsheetID);
  }

  let sheet = userSpreadsheet.getSheetByName('Pengaturan');
  if (!sheet) {
    sheet = userSpreadsheet.insertSheet('Pengaturan');
    sheet.appendRow(['Setting', 'Value']);
    sheet.appendRow(['Bobot_Rapor', 60]); 
    sheet.appendRow(['Bobot_Ujian', 40]); 
    sheet.appendRow(['Jumlah_Semester', 5]);
    sheet.appendRow(['KKM', 76]); 
    SpreadsheetApp.flush();
  }
  
  try {
    const data = sheet.getRange('A1:A' + sheet.getLastRow()).getValues();
    let foundSemester = false;
    let foundKKM = false;
    for (let i = 0; i < data.length; i++) {
      if (data[i][0] === 'Jumlah_Semester') {
        foundSemester = true;
      }
      if (data[i][0] === 'KKM') {
        foundKKM = true;
      }
    }
    if (!foundSemester) {
      sheet.appendRow(['Jumlah_Semester', 5]);
    }
    if (!foundKKM) { 
      sheet.appendRow(['KKM', 76]); 
    }
  } catch (e) {
    Logger.log("Gagal mengecek/membuat setting: " + e.message);
  }
  
  return sheet;
}

function getBobotData(token) {
  try {
    const { spreadsheetID } = validateAdminSession(token);
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getPengaturanSheet(ss);
    const data = sheet.getRange('A1:B' + sheet.getLastRow()).getValues();
    let bobotRapor = 60;
    let bobotUjian = 40;
    let kkm = 76;
    for (let i = 0; i < data.length; i++) {
      if (data[i][0] === 'Bobot_Rapor') {
        bobotRapor = data[i][1];
      } else if (data[i][0] === 'Bobot_Ujian') {
        bobotUjian = data[i][1];
      } else if (data[i][0] === 'KKM') {
        kkm = data[i][1];
      }
    }
    return { status: "sukses", bobotUjian: bobotUjian, bobotRapor: bobotRapor, kkm: kkm };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function saveBobotData(token, bobotRapor, bobotUjian, kkm) {
  try {
    const { sessionData, spreadsheetID } = validateAdminSession(token);
    if ((bobotRapor + bobotUjian) !== 100) {
      return { status: "gagal", message: "Total bobot harus 100." };
    }
    const kkmValue = parseInt(kkm, 10);
    if (isNaN(kkmValue) || kkmValue < 0 || kkmValue > 100) {
      return { status: "gagal", message: "KKM harus angka antara 0 dan 100." };
    }
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getPengaturanSheet(ss);
    const data = sheet.getRange('A1:B' + sheet.getLastRow()).getValues();
    let foundRapor = false;
    let foundUjian = false;
    let foundKKM = false;
    for (let i = 0; i < data.length; i++) {
      const rowIdx = i + 1;
      if (data[i][0] === 'Bobot_Rapor') {
        sheet.getRange('B' + rowIdx).setValue(bobotRapor);
        foundRapor = true;
      } else if (data[i][0] === 'Bobot_Ujian') {
        sheet.getRange('B' + rowIdx).setValue(bobotUjian);
        foundUjian = true;
      } else if (data[i][0] === 'KKM') {
        sheet.getRange('B' + rowIdx).setValue(kkmValue);
        foundKKM = true;
      }
    }
    if (!foundRapor) sheet.appendRow(['Bobot_Rapor', bobotRapor]);
    if (!foundUjian) sheet.appendRow(['Bobot_Ujian', bobotUjian]);
    if (!foundKKM) sheet.appendRow(['KKM', kkmValue]);

    clearRekapNilaiCache(sessionData.sekolahID);
    clearRekapNilaiRaporCache(sessionData.sekolahID);
    return { status: "sukses" };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function getKelasSheet(ss) {
  let userSpreadsheet = ss;
  if (!userSpreadsheet) {
    const { spreadsheetID } = validateAdminSession();
    if (!spreadsheetID) throw new Error("Spreadsheet ID Sesi tidak ditemukan.");
    userSpreadsheet = SpreadsheetApp.openById(spreadsheetID);
  }

  let sheet = userSpreadsheet.getSheetByName('Kelas');
  if (!sheet) {
    sheet = userSpreadsheet.insertSheet('Kelas');
    sheet.appendRow(['NamaKelas']);
    SpreadsheetApp.flush();
  }
  return sheet;
}


/**
 * [MODIFIKASI] Mengecek kelas yang terkunci (locked).
 * Aturan baru: Kelas dianggap 'terkunci' jika sudah ada 
 * minimal satu siswa yang ditempatkan di kelas tersebut di sheet 'Siswa'.
 */
function getLockedKelasSet(ss, sekolahID) {
  try {
    const cacheKey = LOCKED_KELAS_CACHE_KEY + "_" + sekolahID;
    const scriptCache = CacheService.getScriptCache();
    const cachedData = scriptCache.get(cacheKey);
    
    if (cachedData != null) {
      // Jika ada di cache, langsung kembalikan data cache
      return new Set(JSON.parse(cachedData));
    }
    
    Logger.log("CACHE MISS: getLockedKelasSet (Aturan Siswa) untuk " + sekolahID);

    // Buka sheet 'Siswa'
    const sheetSiswa = getSiswaSheet(ss);
    const lockedKelasSet = new Set();

    if (sheetSiswa.getLastRow() > 1) {
      // Ambil HANYA kolom Kelas (Kolom H, index 7)
      // getRange(baris_mulai, kolom_mulai, jumlah_baris, jumlah_kolom)
      const kelasData = sheetSiswa.getRange(2, 8, sheetSiswa.getLastRow() - 1, 1).getValues();
      
      // Loop data kelas
      for (const row of kelasData) {
        const namaKelas = row[0];
        // Jika sel kelas tidak kosong
        if (namaKelas) { 
          // Tambahkan nama kelas (dikonversi ke string dan uppercase) ke Set.
          // Set akan otomatis menangani duplikat.
          lockedKelasSet.add(String(namaKelas).toUpperCase());
        }
      }
    }
    
    // Simpan hasil (bisa jadi Set kosong jika tidak ada siswa) ke cache
    scriptCache.put(cacheKey, JSON.stringify(Array.from(lockedKelasSet)), 3600); // Cache 1 jam
    return lockedKelasSet;

  } catch (e) {
    Logger.log(`Error di getLockedKelasSet (Aturan Siswa): ${e.message}`);
    // Jika error, kembalikan Set kosong agar tidak memblokir UI
    return new Set();
  }
}

function getKelas(token) {
  try {
    const { sessionData, spreadsheetID } = validateAdminOrGuruSession(token);
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getKelasSheet(ss);
    const data = sheet.getDataRange().getValues();
    data.shift();
    
    // --- PERBAIKAN DI SINI ---
    // 1. Filter dengan lebih aman untuk null/undefined/string kosong
    const kelasListNama = data.map(row => row[0]).filter(nama => (nama !== null && nama !== undefined && nama !== ""));
    
    const lockedKelasSet = getLockedKelasSet(ss, sessionData.sekolahID);
    
    const kelasListWithStatus = kelasListNama.map(nama => {
      // 2. Paksa 'nama' menjadi string SEBELUM memanggil .toUpperCase()
      const namaString = String(nama); 
      return {
        nama: namaString, // Kirim string yang sudah dikonversi ke klien
        isLocked: lockedKelasSet.has(namaString.toUpperCase())
      };
    });
    // --- AKHIR PERBAIKAN ---

    return { status: "sukses", kelasList: kelasListWithStatus };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function saveKelas(token, kelasList) { // kelasList sekarang [ {oldName, newName}, ... ]
  let spreadsheetID, sessionData;
  let app2DbId = null; // ID Database Aplikasi 2
  
  try {
    const session = validateAdminSession(token);
    spreadsheetID = session.spreadsheetID;
    sessionData = session.sessionData;
    // Dapatkan ID App 2 di awal untuk cascade
    app2DbId = getApp2DatabaseId(token); 
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
  
  const lock = LockService.getDocumentLock();
  lock.waitLock(15000);
  
  try {
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getKelasSheet(ss);
    // Kita tetap memerlukan lockedKelasSet untuk validasi HAPUS
    // Ini sekarang akan memanggil getLockedKelasSet versi BARU (berbasis siswa)
    const lockedKelasSet = getLockedKelasSet(ss, sessionData.sekolahID); 
    
    const renameMap = new Map();
    const newClassListStrings = [];
    const newClassSet = new Set();

    for (const item of kelasList) {
      const newName = (item.newName || "").trim();
      if (!newName) continue; // Lewati baris kosong

      const oldName = (item.oldName || "").trim();
      
      // 1. Cek duplikat di input baru
      const newNameUpper = newName.toUpperCase();
      if (newClassSet.has(newNameUpper)) {
        throw new Error(`Nama kelas duplikat: '${newName}'.`);
      }
      newClassSet.add(newNameUpper);
      newClassListStrings.push(newName); // Kumpulkan nama baru untuk disimpan

      // 2. Buat Peta Penggantian Nama (Rename Map)
      if (oldName && newName !== oldName) { 
        renameMap.set(oldName, newName);
      }
    }
    
    // 3. Validasi Hapus (Logika Asli DIPERTAHANKAN)
    const oldData = sheet.getDataRange().getValues();
    oldData.shift();
    
    // Filter dengan lebih aman
    const oldClassList = oldData.map(row => row[0]).filter(nama => (nama !== null && nama !== undefined && nama !== ""));
    
    for (const item of oldClassList) { 
      // Paksa 'item' (yang bisa jadi angka) menjadi string
      const oldClass = String(item); 
      const oldClassUpper = oldClass.toUpperCase(); // <-- Panggil .toUpperCase() pada string

      if (lockedKelasSet.has(oldClassUpper)) { 
        
        // --- PERBAIKAN LOGIKA RENAME (DI SINI) ---
        // Cek apakah kelas ini ada di daftar rename (sebagai 'oldName')
        const isBeingRenamed = renameMap.has(oldClass);

        // HANYA blokir jika:
        // 1. Kelas ini TIDAK ada di daftar NAMA BARU (newClassSet)
        // 2. DAN kelas ini TIDAK sedang di-rename (isBeingRenamed)
        if (!newClassSet.has(oldClassUpper) && !isBeingRenamed) {
          // Ini adalah upaya PENGHAPUSAN murni pada kelas yang terkunci.
          return { status: "gagal", message: `Kelas '${oldClass}' tidak dapat dihapus karena sudah ada siswa yang terdaftar di kelas tersebut.` };
        }
        // Jika isBeingRenamed = true, biarkan lolos.
        // Cascade akan ditangani di langkah berikutnya.
        // --- AKHIR PERBAIKAN ---
      }
    }
    
    // --- TINDAKAN CASCADE ---
    if (renameMap.size > 0 && app2DbId) {
      Logger.log(`Mendeteksi ${renameMap.size} penggantian nama kelas. Memulai cascade...`);
      // Update Siswa di Aplikasi 1
      _cascadeKelasRename_App1(ss, renameMap, sessionData.sekolahID, spreadsheetID);
      // Update db_siswa di Aplikasi 2
      _cascadeKelasRename_App2(app2DbId, renameMap);
    }
    // --- AKHIR TINDAKAN CASCADE ---

    // Hapus data lama dari sheet Kelas
    const lastRow = sheet.getLastRow();
    if (lastRow > 1) {
      sheet.deleteRows(2, lastRow - 1);
    }
    
    // Tulis data baru ke sheet Kelas
    if (newClassListStrings.length > 0) {
      const dataToSave = newClassListStrings.map(nama => [nama]);
      sheet.getRange(2, 1, dataToSave.length, 1).setValues(dataToSave);
    }
    
    // Bersihkan cache
    clearSiswaCache(sessionData.sekolahID, spreadsheetID); 
    clearLockedKelasCache(sessionData.sekolahID);
    
    return { status: "sukses" };
    
  } catch (e) {
    return { status: "gagal", message: e.message };
  } finally {
    lock.releaseLock();
  }
}

/**
 * [HELPER BARU] Melakukan cascade update nama kelas di db_siswa (Aplikasi 2).
 */
function _cascadeKelasRename_App2(app2DbId, renameMap) {
  try {
    const ss_app2 = SpreadsheetApp.openById(app2DbId);
    // Memanggil helper getSiswaSheet_App2 (yang sudah ada di Kode.gs.html)
    const sheetSiswa = getSiswaSheet_App2(ss_app2); 
    
    if (sheetSiswa.getLastRow() <= 1) return; // Tidak ada siswa

    const dataRange = sheetSiswa.getRange(2, 4, sheetSiswa.getLastRow() - 1, 1); // Kolom D (kelas)
    const values = dataRange.getValues();
    let changesMade = false;

    for (let i = 0; i < values.length; i++) {
      const oldKelas = values[i][0];
      if (renameMap.has(oldKelas)) {
        values[i][0] = renameMap.get(oldKelas); // Ganti dengan nama baru
        changesMade = true;
      }
    }

    if (changesMade) {
      dataRange.setValues(values);
      Logger.log(`Cascade rename (App 2) berhasil. ${renameMap.size} kelas diperbarui di db_siswa.`);
    }
  } catch (e) {
    Logger.log(`ERROR GAGAL cascade rename (App 2): ${e.message}`);
    // Jangan lempar error agar proses simpan utama tidak gagal
  }
}

/**
 * [HELPER BARU] Melakukan cascade update nama kelas di Siswa (Aplikasi 1).
 */
function _cascadeKelasRename_App1(ss_app1, renameMap, sekolahID, spreadsheetID) {
  try {
    const sheetSiswa = getSiswaSheet(ss_app1); // Helper getSiswaSheet (App 1)
    if (sheetSiswa.getLastRow() <= 1) return; // Tidak ada siswa

    const dataRange = sheetSiswa.getRange(2, 8, sheetSiswa.getLastRow() - 1, 1); // Kolom H (Kelas)
    const values = dataRange.getValues();
    let changesMade = false;

    for (let i = 0; i < values.length; i++) {
      const oldKelas = values[i][0];
      if (renameMap.has(oldKelas)) {
        values[i][0] = renameMap.get(oldKelas); // Ganti dengan nama baru
        changesMade = true;
      }
    }

    if (changesMade) {
      dataRange.setValues(values);
      // Penting: Bersihkan cache siswa App 1
      clearSiswaCache(sekolahID, spreadsheetID); 
      Logger.log(`Cascade rename (App 1) berhasil. ${renameMap.size} kelas diperbarui di Siswa.`);
    }
  } catch (e) {
    Logger.log(`ERROR GAGAL cascade rename (App 1): ${e.message}`);
  }
}

// GANTI FUNGSI LAMA ANDA DENGAN YANG INI
function getSiswaTemplateUrl(token) {
  let tempSpreadsheetId = null; // Untuk memastikan cleanup
  try {
    // 1. Validasi sesi dan dapatkan ID spreadsheet pengguna
    const { sessionData, spreadsheetID } = validateAdminSession(token);
    const ss = SpreadsheetApp.openById(spreadsheetID);

    // 2. Ambil daftar kelas pengguna saat ini
    const sheetKelas = getKelasSheet(ss); // Menggunakan helper yang sudah ada
    const kelasList = sheetKelas.getRange("A2:A" + sheetKelas.getLastRow()).getValues()
      .map(row => row[0])
      .filter(nama => (nama !== null && nama !== undefined && nama !== "")); // Filter baris kosong

    // 3. Buat spreadsheet temporer baru
    const tempSS = SpreadsheetApp.create("TEMP_Template_Siswa_" + sessionData.sekolahID);
    tempSpreadsheetId = tempSS.getId();
    
    // 4. Buka file template statis (yang lama)
    const staticTemplateSS = SpreadsheetApp.openById(TEMPLATE_SISWA_FILE_ID);
    const mainSheet = staticTemplateSS.getSheets()[0]; // Ambil sheet template utama
    
    // 5. Salin sheet template utama ke spreadsheet temporer
    // Ini akan menjadi sheet ke-2 (setelah 'Sheet1')
    const sheetTemplate = mainSheet.copyTo(tempSS).setName("Template Import Siswa");
    
    // ===== MODIFIKASI DIMULAI DI SINI =====
    // 6. Buat sheet referensi kelas yang baru
    // Sisipkan secara eksplisit di posisi 3 (setelah 'Sheet1' dan 'Template Import Siswa')
    const sheetKelasRef = tempSS.insertSheet("Daftar Kelas", 3);
    // ===== AKHIR MODIFIKASI =====

    sheetKelasRef.appendRow(["Nama Kelas (Salin-tempel dari sini)"]);
    sheetKelasRef.getRange("A1").setFontWeight("bold");
    
    if (kelasList.length > 0) {
      const dataToSave = kelasList.map(nama => [nama]);
      sheetKelasRef.getRange(2, 1, dataToSave.length, 1).setValues(dataToSave);
    } else {
      sheetKelasRef.getRange(2, 1).setValue("(Belum ada data kelas di 'Kelola Kelas')");
    }
    sheetKelasRef.autoResizeColumn(1);

    // 7. Tambahkan Data Validation ke sheet template
    if (kelasList.length > 0) {
      // 7a. Tentukan range sumber data (e.g., 'Daftar Kelas'!$A$2:$A$10)
      const validationSourceRangeA1 = `'Daftar Kelas'!$A$2:$A$${kelasList.length + 1}`;
      
      // 7b. Buat objek Range dari string A1
      const validationRange = tempSS.getRange(validationSourceRangeA1);
      
      // 7c. Buat aturan validasi
      const validationRule = SpreadsheetApp.newDataValidation()
          .requireValueInRange(validationRange, true) // true = show dropdown
          .setAllowInvalid(false) // false = tolak inputan selain dari daftar
          .setHelpText("Pilih kelas dari daftar yang valid.")
          .build();
          
      // 7d. Terapkan aturan ke kolom "Kelas" (Kolom G) di sheet template
      // Terapkan ke 1000 baris (G2:G1001) agar ada banyak ruang
      const targetValidationRange = sheetTemplate.getRange("G2:G1001");
      targetValidationRange.setDataValidation(validationRule);
      
      Logger.log(`Data validation ditambahkan ke kolom G, sumber: ${validationSourceRangeA1}`);
    }

    // 8. Hapus "Sheet1" default dari spreadsheet temporer
    const defaultSheet = tempSS.getSheetByName("Sheet1");
    if (defaultSheet) {
      tempSS.deleteSheet(defaultSheet);
    }

    // 9. Ekspor spreadsheet temporer sebagai file .xlsx
    SpreadsheetApp.flush(); // Pastikan semua perubahan disimpan
    
    const url = "https://docs.google.com/spreadsheets/d/" + tempSpreadsheetId + "/export?format=xlsx";
    const oauthToken = ScriptApp.getOAuthToken();
    const response = UrlFetchApp.fetch(url, {
      headers: {
        'Authorization': 'Bearer ' + oauthToken
      }
    });
    
    const blob = response.getBlob().setName("template_import_siswa.xlsx");
    const base64Data = Utilities.base64Encode(blob.getBytes());
    
    return {
      status: "sukses",
      base64: base64Data,
      mimeType: MimeType.MICROSOFT_EXCEL,
      fileName: "template_import_siswa.xlsx"
    };
    
  } catch (e) {
    if (e.message.includes("Export_TRANSIENT") || e.message.includes("failed")) {
      return { status: "gagal", message: "Gagal mengekspor template. Pastikan file template (ID: " + TEMPLATE_SISWA_FILE_ID + ") dapat diakses." };
    }
    return { status: "gagal", message: "Gagal membuat template: " + e.message };
  } finally {
    // 10. Hapus file temporer
    if (tempSpreadsheetId) {
      try {
        DriveApp.getFileById(tempSpreadsheetId).setTrashed(true);
      } catch (e) {
        Logger.log("Gagal menghapus file temp template siswa: " + e.message);
      }
    }
  }
}

function prosesImportExcelSiswa(token, fileData) {
  let tempExcelFileId = null;
  let tempConvertedSheetId = null;
  const lock = LockService.getDocumentLock();
  lock.waitLock(30000); // Tunggu 30 detik untuk impor
  try {
    const { sessionData, spreadsheetID } = validateAdminSession(token);
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheetSiswa = getSiswaSheet(ss);
    const sheetKelas = getKelasSheet(ss);
    const { base64, mimeType, fileName } = fileData;
    const decodedData = Utilities.base64Decode(base64.split(',')[1]);
    const blob = Utilities.newBlob(decodedData, mimeType, fileName);
    const tempExcelFile = DriveApp.createFile(blob);
    tempExcelFileId = tempExcelFile.getId();
    const conversionResource = {
      title: `[TEMP] Konversi - ${fileName}`,
      mimeType: MimeType.GOOGLE_SHEETS
    };
    const convertedFile = Drive.Files.copy(conversionResource, tempExcelFileId, { convert: true });
    tempConvertedSheetId = convertedFile.id;
    const tempSheet = SpreadsheetApp.openById(tempConvertedSheetId);
    const dataSheet = tempSheet.getSheets()[0];
    const excelData = dataSheet.getDataRange().getValues();
    if (excelData.length <= 1) {
      throw new Error("File Excel kosong atau hanya berisi header.");
    }
    excelData.shift();
    const dataNisn = sheetSiswa.getRange('C2:C' + sheetSiswa.getLastRow()).getValues()
      .map(row => String(row[0]).trim())
      .filter(nisn => nisn);
    const existingNisnSet = new Set(dataNisn);
    const dataKelas = sheetKelas.getRange('A2:A' + sheetKelas.getLastRow()).getValues()
      .map(row => String(row[0]).trim())
      .filter(kelas => kelas);
    const existingKelasSet = new Set(dataKelas);
    const gagalList = [];
    const rowsToAppend = [];
    const existingData = sheetSiswa.getDataRange().getValues();
    let maxIdNum = 0;
    let maxUrutan = 0;
    for (let i = 1; i < existingData.length; i++) {
      const idNum = parseInt((existingData[i][0] || 'SIS-0').split('-')[1] || 0);
      if (idNum > maxIdNum) maxIdNum = idNum;
      const urutanNum = Number(existingData[i][8] || 0);
      if (urutanNum > maxUrutan) maxUrutan = urutanNum;
    }
    let nextIdNum = maxIdNum + 1;
    let nextUrutan = maxUrutan + 1;
    for (let i = 0; i < excelData.length; i++) {
      const row = excelData[i];
      const barisKe = i + 2;
      const nama = (row[0] ? String(row[0]) : '').trim();
      const nisn = (row[1] ? String(row[1]) : '').trim();
      const nisLokal = (row[2] ? String(row[2]) : '').trim();
      const jk = (row[3] ? String(row[3]) : '').trim().toUpperCase();
      const tempatLahir = (row[4] ? String(row[4]) : '').trim();
      let tglLahir = (row[5] ? row[5] : '');
      if (tglLahir instanceof Date) {
        tglLahir = Utilities.formatDate(tglLahir, Session.getScriptTimeZone(), "yyyy-MM-dd");
      } else {
        tglLahir = String(tglLahir).trim();
      }
      const kelas = (row[6] ? String(row[6]) : '').trim();
      if (!nama || !nisn || !jk || !kelas) {
        gagalList.push({ baris: barisKe, nama: nama, nisn: nisn, alasan: "Data wajib tidak lengkap." });
        continue;
      }
      if (existingNisnSet.has(nisn)) {
        gagalList.push({ baris: barisKe, nama: nama, nisn: nisn, alasan: "NISN sudah terdaftar." });
        continue;
      }
      if (jk !== 'L' && jk !== 'P') {
        gagalList.push({ baris: barisKe, nama: nama, nisn: nisn, alasan: "Jenis Kelamin harus 'L' atau 'P'." });
        continue;
      }
      if (!existingKelasSet.has(kelas)) {
        gagalList.push({ baris: barisKe, nama: nama, nisn: nisn, alasan: `Kelas '${kelas}' tidak ditemukan.` });
        continue;
      }
      const newSiswaID = "SIS-" + nextIdNum;
      const formattedNisn = nisn ? "'" + nisn : null;
      const formattedNisLokal = nisLokal ? "'" + nisLokal : null;
      const newRow = [
        newSiswaID, nama, formattedNisn, formattedNisLokal, jk,
        tempatLahir, (tglLahir || null), kelas, nextUrutan
      ];
      rowsToAppend.push(newRow);
      existingNisnSet.add(nisn);
      nextIdNum++;
      nextUrutan++;
    }
    if (rowsToAppend.length > 0) {
      sheetSiswa.getRange(sheetSiswa.getLastRow() + 1, 1, rowsToAppend.length, rowsToAppend[0].length)
        .setValues(rowsToAppend);
    }
    DriveApp.getFileById(tempExcelFileId).setTrashed(true);
    DriveApp.getFileById(tempConvertedSheetId).setTrashed(true);
    
    // --- PERBAIKAN DI SINI ---
    clearSiswaCache(sessionData.sekolahID, spreadsheetID);
    // --- AKHIR PERBAIKAN ---

    return {
      status: "sukses",
      totalDiProses: excelData.length,
      berhasilDiUpload: rowsToAppend.length,
      gagalDiUpload: gagalList.length,
      dataGagal: gagalList
    };
  } catch (e) {
    if (tempExcelFileId) { DriveApp.getFileById(tempExcelFileId).setTrashed(true); }
    if (tempConvertedSheetId) { DriveApp.getFileById(tempConvertedSheetId).setTrashed(true); }
    return { status: "gagal", message: "Terjadi error: " + e.message };
  } finally {
    if (lock) lock.releaseLock();
  }
}

function moveSiswaUrutan(token, siswaID, direction) {
  try {
    const { sessionData, spreadsheetID } = validateAdminSession(token);
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getSiswaSheet(ss);
    const data = sheet.getDataRange().getValues();
    let targetRowIndex = -1;
    let targetData = null;
    for (let i = 0; i < data.length; i++) {
      if (data[i][0] === siswaID) {
        targetRowIndex = i;
        targetData = {
          id: data[i][0],
          kelas: data[i][7],
          urutan: Number(data[i][8] || parseInt((data[i][0] || 'SIS-0').split('-')[1] || 0)),
          sheetRow: i + 1
        };
        break;
      }
    }
    if (!targetData) {
      throw new Error("SiswaID tidak ditemukan.");
    }
    const classmates = [];
    for (let i = 0; i < data.length; i++) {
      if (data[i][7] === targetData.kelas) {
        const idNum = parseInt((data[i][0] || 'SIS-0').split('-')[1] || 0);
        classmates.push({
          id: data[i][0],
          kelas: data[i][7],
          urutan: Number(data[i][8] || idNum),
          sheetRow: i + 1
        });
      }
    }
    classmates.sort((a, b) => a.urutan - b.urutan);
    let targetIndexInClass = classmates.findIndex(s => s.id === siswaID);
    let swapTarget = null;
    if (direction === 'up' && targetIndexInClass > 0) {
      swapTarget = classmates[targetIndexInClass - 1];
    } else if (direction === 'down' && targetIndexInClass < classmates.length - 1) {
      swapTarget = classmates[targetIndexInClass + 1];
    }
    if (swapTarget) {
      const targetUrutanVal = targetData.urutan;
      const swapUrutanVal = swapTarget.urutan;
      sheet.getRange(targetData.sheetRow, 9).setValue(swapUrutanVal);
      sheet.getRange(swapTarget.sheetRow, 9).setValue(targetUrutanVal);
      clearSiswaCache(sessionData.sekolahID);
      return { status: "sukses" };
    }
    return { status: "gagal", message: "Tidak bisa bergerak lebih jauh." };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function saveSiswaUrutanBatch(token, urutanData) {
  let spreadsheetID, sessionData;
  try {
    const session = validateAdminSession(token);
    spreadsheetID = session.spreadsheetID; // <--- Ambil spreadsheetID
    sessionData = session.sessionData;
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
  const lock = LockService.getDocumentLock();
  lock.waitLock(15000);
  try {
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getSiswaSheet(ss);
    const dataRange = sheet.getDataRange();
    const data = dataRange.getValues();
    const urutanMap = new Map(urutanData.map(item => [item.id, item.urutan]));
    let changesMade = false;
    for (let i = 1; i < data.length; i++) {
      const id = data[i][0];
      const newUrutan = urutanMap.get(id);
      if (newUrutan !== undefined && data[i][8] != newUrutan) {
        data[i][8] = newUrutan;
        changesMade = true;
      }
    }
    if (changesMade) {
      const valuesToUpdate = data.slice(1).map(row => [row[8]]);
      if (valuesToUpdate.length > 0) {
        sheet.getRange(2, 9, valuesToUpdate.length, 1).setValues(valuesToUpdate);
      }
      
      // --- PERBAIKAN DI SINI ---
      clearSiswaCache(sessionData.sekolahID, spreadsheetID);
      // --- AKHIR PERBAIKAN ---
    }
    return { status: "sukses" };
  } catch (e) {
    return { status: "gagal", message: e.message };
  } finally {
    lock.releaseLock();
  }
}

function getNilaiUjianSheet(ss) {
  let userSpreadsheet = ss;
  if (!userSpreadsheet) {
    const { spreadsheetID } = validateAdminSession();
    if (!spreadsheetID) throw new Error("Spreadsheet ID Sesi tidak ditemukan.");
    userSpreadsheet = SpreadsheetApp.openById(spreadsheetID);
  }

  let sheet = userSpreadsheet.getSheetByName('Nilai_Ujian');
  if (!sheet) {
    sheet = userSpreadsheet.insertSheet('Nilai_Ujian');
    sheet.appendRow(['SiswaID', 'MapelID', 'UjianMadrasah', 'UjianPraktek']);
    SpreadsheetApp.flush();
  }
  return sheet;
}

// Salin dan GANTI fungsi getNilaiUjianGridData() Anda dengan yang ini
function getNilaiUjianGridData(token, tipeUjian) {
  try {
    const sessionData = validateAndRefreshSession(token);
    const spreadsheetID = sessionData.spreadsheetID;
    const sekolahID = sessionData.sekolahID;
    const isGuru = (sessionData.role === 'guru');
    
    const assignedMapelSet = isGuru ? new Set(sessionData.assignedMapel) : null;
    const assignedKelasSet = isGuru ? new Set(sessionData.assignedKelas) : null;
    const mapelKelasData = isGuru ? sessionData.mapelKelasData : null;

    const scriptCache = CacheService.getScriptCache();
    const cacheKeySuffix = isGuru ? `_GURU_${sessionData.namaGuru.replace(/\s+/g, '')}` : '';
    const cacheKey = NILAI_GRID_CACHE_KEY_PREFIX + tipeUjian + "_" + sekolahID + cacheKeySuffix;
    
    const cachedData = scriptCache.get(cacheKey);
    if (cachedData != null) {
      const ss = SpreadsheetApp.openById(spreadsheetID); // Buka SS hanya untuk cek waktu
      let cekWaktu = { diizinkan: true, pesan: "" };
      if (isGuru) {
        cekWaktu = cekWaktuInputGuru(ss);
      }
      const parsedCache = JSON.parse(cachedData);
      parsedCache.data.isInputDiizinkan = cekWaktu.diizinkan;
      parsedCache.data.pesanInput = cekWaktu.pesan;
      parsedCache.data.mapelKelasData = mapelKelasData;
      return parsedCache;
    }

    const ss = SpreadsheetApp.openById(spreadsheetID);

    let cekWaktu = { diizinkan: true, pesan: "" };
    if (isGuru) {
      cekWaktu = cekWaktuInputGuru(ss);
    }

    // --- PERBAIKAN: GANTI BACA SHEET DENGAN HELPER CACHE ---
    // HAPUS: const sheetSiswa = getSiswaSheet(ss);
    // HAPUS: const dataSiswa = sheetSiswa.getDataRange().getValues();
    // HAPUS: dataSiswa.shift();
    // HAPUS: let siswaList = dataSiswa.map(row => ({...}));
    
    // GANTI DENGAN:
    let siswaList = _getSiswaInternal(spreadsheetID, sekolahID);
    // --- AKHIR PERBAIKAN ---

    if (isGuru) {
      siswaList = siswaList.filter(siswa => assignedKelasSet.has(siswa.kelas));
    }
    // Siswa sudah di-sort oleh _getSiswaInternal, tidak perlu sort ulang

    // --- PERBAIKAN: GANTI DENGAN HELPER CACHE MAPEL ---
    // HAPUS: let mapelListFull = getMapelDataInternal(ss, sekolahID);
    // GANTI DENGAN:
    let mapelListFull = _getMapelInternal(ss, sekolahID);
    // --- AKHIR PERBAIKAN ---
    
    if (isGuru) {
      mapelListFull = mapelListFull.filter(m => assignedMapelSet.has(m.id));
    }

    let filteredMapel = (tipeUjian === 'UM') ? mapelListFull.filter(m => m.isUS) : mapelListFull.filter(m => m.isUP);
    const mapelList = filteredMapel.map(m => ({ id: m.id, nama: m.nama }));

    const sheetNilai = getNilaiUjianSheet(ss);
    const dataNilai = sheetNilai.getDataRange().getValues();
    dataNilai.shift();
    const nilaiData = {};
    dataNilai.forEach(row => {
      const key = `${row[0]}_${row[1]}`;
      nilaiData[key] = (tipeUjian === 'UM') ? row[2] : row[3];
    });

    const response = { 
      status: "sukses", 
      data: { 
        siswaList, 
        mapelList, 
        nilaiData,
        isInputDiizinkan: cekWaktu.diizinkan,
        pesanInput: cekWaktu.pesan,
        mapelKelasData: mapelKelasData 
      } 
    };
    scriptCache.put(cacheKey, JSON.stringify(response), 600);
    return response;
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function saveNilaiUjianBatch(token, dataToSave) {
  try {
    const sessionData = validateAndRefreshSession(token);
    const spreadsheetID = sessionData.spreadsheetID;
    const isGuru = (sessionData.role === 'guru');

    // --- TAMBAHKAN BLOK INI ---
    const ss = SpreadsheetApp.openById(spreadsheetID); // Buka SS di awal
    if (isGuru) {
      const cekWaktu = cekWaktuInputGuru(ss);
      if (!cekWaktu.diizinkan) {
        // Jika tidak diizinkan, langsung kembalikan error
        return { status: "gagal", message: cekWaktu.pesan };
      }
    }
    // --- AKHIR TAMBAHAN ---

    if (isGuru) {
      const assignedSet = new Set(sessionData.assignedMapel);
      for (const item of dataToSave) {
        if (!assignedSet.has(item.mapelId)) {
          throw new Error(`Akses Ditolak: Anda tidak berhak menyimpan nilai untuk mapel ${item.mapelId}`);
        }
      }
    }

    const lock = LockService.getDocumentLock();
    lock.waitLock(15000);
    try {
      // const ss = SpreadsheetApp.openById(spreadsheetID); // <-- Baris ini dipindah ke atas
      const sheet = getNilaiUjianSheet(ss); // <-- Gunakan 'ss' dari atas
      
      // --- Modifikasi Batch Dimulai ---
      const range = sheet.getDataRange();
      const data = range.getValues(); // Baca semua data SEKALI
      
      const dataMap = new Map();
      for (let i = 1; i < data.length; i++) {
        dataMap.set(`${data[i][0]}_${data[i][1]}`, {row: i + 1, um: data[i][2], up: data[i][3]});
      }
      const rowsToAppend = [];
      let tipeUjianDisimpan = null;
      
      dataToSave.forEach(item => {
        if (!tipeUjianDisimpan) tipeUjianDisimpan = item.tipeUjian;
        const key = `${item.siswaId}_${item.mapelId}`;
        let nilaiBaru = null;
        if (item.nilai !== "" && item.nilai != null) {
          let num = parseFloat(item.nilai);
          if (!isNaN(num) && num >= 0 && num <= 100) nilaiBaru = num;
        }
        
        const existing = dataMap.get(key);
        
        if (existing !== undefined) {
          const colIdx = (item.tipeUjian === 'UM') ? 2 : 3; // 0-based index (C=2, D=3)
          const rowIndex_0based = existing.row - 1; // Konversi ke 0-based
          
          const oldNilai = data[rowIndex_0based][colIdx];
          
          if (oldNilai !== nilaiBaru) {
            // Modifikasi array di memori
            data[rowIndex_0based][colIdx] = nilaiBaru;
          }
        } else {
          let newRow = [item.siswaId, item.mapelId, null, null];
          newRow[(item.tipeUjian === 'UM') ? 2 : 3] = nilaiBaru;
          rowsToAppend.push(newRow);
          // Update map agar data baru dikenali
          dataMap.set(key, {
            row: data.length + rowsToAppend.length, 
            um: newRow[2], 
            up: newRow[3]
          });
        }
      });
      
      // Tulis semua perubahan sekaligus
      range.setValues(data); 
      
      if (rowsToAppend.length > 0) {
        sheet.getRange(sheet.getLastRow() + 1, 1, rowsToAppend.length, 4).setValues(rowsToAppend);
      }
      // --- Akhir Modifikasi Batch ---
      
      const sekolahID = sessionData.sekolahID;
      const scriptCache = CacheService.getScriptCache();

      if (tipeUjianDisimpan) {
         scriptCache.remove(NILAI_GRID_CACHE_KEY_PREFIX + tipeUjianDisimpan + "_" + sekolahID);
         if (isGuru) {
             scriptCache.remove(NILAI_GRID_CACHE_KEY_PREFIX + tipeUjianDisimpan + "_" + sekolahID + `_GURU_${sessionData.namaGuru.replace(/\s+/g, '')}`);
         }
      } else {
         clearNilaiUjianCache(sekolahID, spreadsheetID);
      }

      if (!isGuru) {
        clearRekapNilaiCache(sekolahID);
      }
      clearLockedKelasCache(sekolahID);
      return { status: "sukses", message: "Nilai tersimpan." };
    } finally {
      lock.releaseLock();
    }
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function getNilaiTemplateData(token, kelasDipilih) {
  let tempSpreadsheetId = null;
  try {
    const { sessionData } = validateAdminOrGuruSession(token);
    const namaSekolah = sessionData.namaSekolah;
    const siswaResponse = getSiswa(token);
    if (siswaResponse.status !== 'sukses') throw new Error(siswaResponse.message);
    const siswaList = siswaResponse.siswa;
    const filteredSiswa = (kelasDipilih === 'semua') ? siswaList : siswaList.filter(s => s.kelas === kelasDipilih);
    if (filteredSiswa.length === 0) return { status: "gagal", message: `Tidak ada siswa di kelas '${kelasDipilih}'.` };
    const mapelResponse = getMapel(token);
    if (mapelResponse.status !== 'sukses') throw new Error(mapelResponse.message);
    
    let allMapel = mapelResponse.mapel;
    
    // --- TAMBAHAN FILTER UNTUK GURU ---
    if (sessionData.role === 'guru') {
      const assignedMapelSet = new Set(sessionData.assignedMapel);
      allMapel = allMapel.filter(m => assignedMapelSet.has(m.id));
    }
    // --- AKHIR TAMBAHAN ---
    
    const mapelUS = allMapel.filter(m => m.isUS === true);
    const mapelUP = allMapel.filter(m => m.isUP === true);
    const timestamp = Utilities.formatDate(new Date(), Session.getScriptTimeZone(), "yyyyMMdd_HHmmss");
    const tempFileName = `[TEMP] Template Nilai - ${namaSekolah} - ${timestamp}`;
    const ss = SpreadsheetApp.create(tempFileName);
    tempSpreadsheetId = ss.getId();
    const rule = SpreadsheetApp.newDataValidation().requireNumberBetween(0, 100).setAllowInvalid(true).build();
    const sheetUS = ss.getSheetByName('Sheet1');
    const jenjangPilihan = sessionData.jenjangPilihan;
    const namaSheetUS = (jenjangPilihan === 'MI' || jenjangPilihan === 'MTS' || jenjangPilihan === 'MA') ? 'Ujian Madrasah' : 'Ujian Sekolah';
    sheetUS.setName(namaSheetUS);
    sheetUS.getRange("B:B").setNumberFormat("@");
    if (mapelUS.length > 0) {
      const headersUS = ["Nama Siswa", "NISN", "Kelas", ...mapelUS.map(m => m.id)];
      sheetUS.getRange(1, 1, 1, headersUS.length).setValues([headersUS]);
      const dataSiswaRows = filteredSiswa.map(s => [s.nama, String(s.nisn), s.kelas]);
      sheetUS.getRange(2, 1, dataSiswaRows.length, 3).setValues(dataSiswaRows);
      sheetUS.getRange(2, 4, dataSiswaRows.length, mapelUS.length).setDataValidation(rule);
      sheetUS.autoResizeColumns(1, 3);
    } else {
      sheetUS.getRange('A1').setValue(`Tidak ada mapel untuk ${namaSheetUS}.`);
    }
    const sheetUP = ss.insertSheet('Ujian Praktek');
    sheetUP.getRange("B:B").setNumberFormat("@");
    if (mapelUP.length > 0) {
      const headersUP = ["Nama Siswa", "NISN", "Kelas", ...mapelUP.map(m => m.id)];
      sheetUP.getRange(1, 1, 1, headersUP.length).setValues([headersUP]);
      const dataSiswaRows = filteredSiswa.map(s => [s.nama, String(s.nisn), s.kelas]);
      sheetUP.getRange(2, 1, dataSiswaRows.length, 3).setValues(dataSiswaRows);
      sheetUP.getRange(2, 4, dataSiswaRows.length, mapelUP.length).setDataValidation(rule);
      sheetUP.autoResizeColumns(1, 3);
    } else {
      sheetUP.getRange('A1').setValue('Tidak ada mapel untuk Ujian Praktek.');
    }
    SpreadsheetApp.flush();
    const url = "https://docs.google.com/spreadsheets/d/" + tempSpreadsheetId + "/export?format=xlsx";
    const oauthToken = ScriptApp.getOAuthToken();
    const response = UrlFetchApp.fetch(url, { headers: { 'Authorization': 'Bearer ' + oauthToken } });
    const base64Data = Utilities.base64Encode(response.getBlob().getBytes());
    return { status: "sukses", base64: base64Data, mimeType: MimeType.MICROSOFT_EXCEL, fileName: "template_nilai_ujian.xlsx" };
  } catch (e) {
    return { status: "gagal", message: "Gagal membuat template: " + e.message };
  } finally {
    if (tempSpreadsheetId) DriveApp.getFileById(tempSpreadsheetId).setTrashed(true);
  }
}

function hitungNilaiRekap(nilaiUM, nilaiUP) {
  const um = (nilaiUM === null || nilaiUM === undefined || nilaiUM === "") ? null : parseFloat(nilaiUM);
  const up = (nilaiUP === null || nilaiUP === undefined || nilaiUP === "") ? null : parseFloat(nilaiUP);
  
  const umIsValid = (um !== null && !isNaN(um));
  const upIsValid = (up !== null && !isNaN(up));
  
  if (umIsValid && upIsValid) {
    return (um + up) / 2;
  } else if (umIsValid) {
    return um;
  } else if (upIsValid) {
    return up;
  } else {
    return null;
  }
}

// Salin dan GANTI fungsi getRekapitulasiNilaiData() Anda dengan yang ini
function getRekapitulasiNilaiData(token) {
  try {
    const { sessionData, spreadsheetID } = validateAdminSession(token);
    const sekolahID = sessionData.sekolahID;
    
    const scriptCache = CacheService.getScriptCache();
    const cacheKey = REKAP_NILAI_CACHE_KEY + "_" + sekolahID;
    const cachedData = scriptCache.get(cacheKey);

    if (cachedData != null) {
      return JSON.parse(cachedData);
    }
    
    const ss = SpreadsheetApp.openById(spreadsheetID);

    // --- PERBAIKAN: GANTI BACA SHEET DENGAN HELPER CACHE ---
    // HAPUS: const siswaData = getSiswa(token);
    // HAPUS: if (siswaData.status !== 'sukses') throw new Error(siswaData.message);
    // HAPUS: const siswaList = siswaData.siswa.map(s => ({ id: s.id, nama: s.nama, nisn: s.nisn, kelas: s.kelas }));
    // GANTI DENGAN:
    const siswaList = _getSiswaInternal(spreadsheetID, sekolahID).map(s => ({ id: s.id, nama: s.nama, nisn: s.nisn, kelas: s.kelas }));
    
    // HAPUS: const mapelListFull = getMapelDataInternal(ss, sekolahID);
    // GANTI DENGAN:
    const mapelListFull = _getMapelInternal(ss, sekolahID);
    // --- AKHIR PERBAIKAN ---

    const { mapelList, nilaiRekapMap } = getRekapUjianInternal(ss, siswaList, mapelListFull);
    const nilaiRekapDataObj = {};
    nilaiRekapMap.forEach((value, key) => { nilaiRekapDataObj[key] = value; });
    const response = { status: "sukses", data: { siswaList, mapelList, nilaiRekapData: nilaiRekapDataObj } };
    
    scriptCache.put(cacheKey, JSON.stringify(response), 600);
    
    return response;
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

// Salin dan GANTI fungsi getRekapitulasiNilaiRaporData() Anda dengan yang ini
function getRekapitulasiNilaiRaporData(token) {
  try {
    const { sessionData, spreadsheetID } = validateAdminSession(token);
    const sekolahID = sessionData.sekolahID;
    
    const scriptCache = CacheService.getScriptCache();
    const cacheKey = REKAP_NILAI_RAPOR_CACHE_KEY + "_" + sekolahID;
    const cachedData = scriptCache.get(cacheKey);

    if (cachedData != null) {
      return JSON.parse(cachedData);
    }
    
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const semesterListData = getSemesterList(token);
    if (semesterListData.status !== 'sukses') throw new Error(semesterListData.message);
    const semesterIds = semesterListData.semesterList.map(s => s.id);
    
    // --- PERBAIKAN: GANTI BACA SHEET DENGAN HELPER CACHE ---
    // HAPUS: const siswaData = getSiswa(token);
    // HAPUS: if (siswaData.status !== 'sukses') throw new Error(siswaData.message);
    // HAPUS: const siswaList = siswaData.siswa.map(s => ({ id: s.id, nama: s.nama, nisn: s.nisn, kelas: s.kelas }));
    // GANTI DENGAN:
    const siswaList = _getSiswaInternal(spreadsheetID, sekolahID).map(s => ({ id: s.id, nama: s.nama, nisn: s.nisn, kelas: s.kelas }));
    
    // HAPUS: const mapelListFull = getMapelDataInternal(ss, sekolahID);
    // GANTI DENGAN:
    const mapelListFull = _getMapelInternal(ss, sekolahID);
    // --- AKHIR PERBAIKAN ---
    
    const { mapelList, nilaiRekapMap } = getRekapRaporInternal(ss, siswaList, mapelListFull, semesterIds);
    const nilaiRekapDataObj = {};
    nilaiRekapMap.forEach((value, key) => { nilaiRekapDataObj[key] = value; });
    const response = {
      status: "sukses",
      data: { siswaList, mapelList, nilaiRekapData: nilaiRekapDataObj, jumlahSemester: semesterIds.length }
    };
    
    scriptCache.put(cacheKey, JSON.stringify(response), 600);

    return response;
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function getSemesterSetting(token) {
  try {
    const { sessionData, spreadsheetID } = validateAdminSession(token);
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getPengaturanSheet(ss);
    const data = sheet.getRange('A1:B' + sheet.getLastRow()).getValues();
    let jumlahSemester = 5;
    for (let i = 0; i < data.length; i++) {
      if (data[i][0] === 'Jumlah_Semester') {
        jumlahSemester = data[i][1];
        break;
      }
    }
    return { status: "sukses", jenjang: sessionData.jenjang, setting: jumlahSemester };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function saveSemesterSetting(token, jumlahSemester) {
  try {
    const { sessionData, spreadsheetID } = validateAdminSession(token);
    const jenjang = sessionData.jenjang;
    const settingAngka = parseInt(jumlahSemester, 10);
    if (settingAngka !== 3 && settingAngka !== 5) return { status: "gagal", message: "Nilai semester tidak valid." };
    if (jenjang !== 'SD/MI' && settingAngka === 3) return { status: "gagal", message: "3 semester hanya untuk SD/MI." };
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getPengaturanSheet(ss);
    const data = sheet.getRange('A1:B' + sheet.getLastRow()).getValues();
    let found = false;
    for (let i = 0; i < data.length; i++) {
      if (data[i][0] === 'Jumlah_Semester') {
        sheet.getRange('B' + (i + 1)).setValue(settingAngka);
        found = true;
        break;
      }
    }
    if (!found) sheet.appendRow(['Jumlah_Semester', settingAngka]);
    
    // Panggil clearNilaiRaporCache dengan spreadsheetID
    clearNilaiRaporCache(sessionData.sekolahID, spreadsheetID);
    
    return { status: "sukses" };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function getNilaiRaporSheet(ss) {
  let userSpreadsheet = ss;
  if (!userSpreadsheet) {
    const { spreadsheetID } = validateAdminSession();
    if (!spreadsheetID) throw new Error("Spreadsheet ID Sesi tidak ditemukan.");
    userSpreadsheet = SpreadsheetApp.openById(spreadsheetID);
  }

  let sheet = userSpreadsheet.getSheetByName('Nilai_Rapor_Akhir');
  if (!sheet) {
    sheet = userSpreadsheet.insertSheet('Nilai_Rapor_Akhir');
    sheet.appendRow(['SiswaID', 'MapelID', 'SemesterID', 'Nilai_P', 'Nilai_K']);
    SpreadsheetApp.flush();
  } else {
    const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
    const nilaiIndex = headers.indexOf('Nilai');
    const nilaiPIndex = headers.indexOf('Nilai_P');
    
    if (nilaiIndex !== -1 && nilaiPIndex === -1) {
      sheet.getRange(1, nilaiIndex + 1).setValue('Nilai_P');
      sheet.getRange(1, headers.length + 1).setValue('Nilai_K');
      Logger.log("Migrasi skema Nilai_Rapor_Akhir: Menambahkan Nilai_P dan Nilai_K.");
    } else if (nilaiPIndex === -1) {
       sheet.clear();
       sheet.appendRow(['SiswaID', 'MapelID', 'SemesterID', 'Nilai_P', 'Nilai_K']);
    }
  }
  return sheet;
}

function getSemesterList(token) {
  try {
    const { sessionData, spreadsheetID } = validateAdminSession(token);
    const jenjang = sessionData.jenjang;
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheetSetting = getPengaturanSheet(ss);
    const data = sheetSetting.getRange('A1:B' + sheetSetting.getLastRow()).getValues();
    let jumlahSemester = 5;
    for (let i = 0; i < data.length; i++) {
      if (data[i][0] === 'Jumlah_Semester') {
        jumlahSemester = parseInt(data[i][1], 10) || 5;
        break;
      }
    }
    let semesterList = [];
    if (jenjang === 'SD/MI') {
      if (jumlahSemester === 3) {
        semesterList = [{ id: "K5_S1", nama: "Kelas 5 Ganjil", color: "#0d6efd" }, { id: "K5_S2", nama: "Kelas 5 Genap", color: "#0d6efd" }, { id: "K6_S1", nama: "Kelas 6 Ganjil", color: "#198754" }];
      } else {
        semesterList = [{ id: "K4_S1", nama: "Kelas 4 Ganjil", color: "#fd7e14" }, { id: "K4_S2", nama: "Kelas 4 Genap", color: "#fd7e14" }, { id: "K5_S1", nama: "Kelas 5 Ganjil", color: "#0d6efd" }, { id: "K5_S2", nama: "Kelas 5 Genap", color: "#0d6efd" }, { id: "K6_S1", nama: "Kelas 6 Ganjil", color: "#198754" }];
      }
    } else if (jenjang === 'SMP/MTS') {
      semesterList = [{ id: "K7_S1", nama: "Kelas 7 Ganjil", color: "#fd7e14" }, { id: "K7_S2", nama: "Kelas 7 Genap", color: "#fd7e14" }, { id: "K8_S1", nama: "Kelas 8 Ganjil", color: "#0d6efd" }, { id: "K8_S2", nama: "Kelas 8 Genap", color: "#0d6efd" }, { id: "K9_S1", nama: "Kelas 9 Ganjil", color: "#198754" }];
    } else if (jenjang === 'SMA/MA') {
      semesterList = [{ id: "K10_S1", nama: "Kelas 10 Ganjil", color: "#fd7e14" }, { id: "K10_S2", nama: "Kelas 10 Genap", color: "#fd7e14" }, { id: "K11_S1", nama: "Kelas 11 Ganjil", color: "#0d6efd" }, { id: "K11_S2", nama: "Kelas 11 Genap", color: "#0d6efd" }, { id: "K12_S1", nama: "Kelas 12 Ganjil", color: "#198754" }];
    }
    return { status: "sukses", semesterList: semesterList };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function getNilaiRaporGridData(token, semesterId) {
  try {
    const { sessionData, spreadsheetID } = validateAdminSession(token);
    const sekolahID = sessionData.sekolahID;
    
    const scriptCache = CacheService.getScriptCache();
    const cacheKey = NILAI_RAPOR_GRID_CACHE_KEY_PREFIX + semesterId + "_" + sekolahID;
    const cachedData = scriptCache.get(cacheKey);

    if (cachedData != null) {
      return JSON.parse(cachedData);
    }
    const ss = SpreadsheetApp.openById(spreadsheetID);
    
    // --- PERBAIKAN DI SINI ---
    // Menggunakan helper cache _getSiswaInternal (ini sudah benar dari langkah sebelumnya)
    const siswaList = _getSiswaInternal(spreadsheetID, sekolahID).map(s => ({ 
      id: s.id, 
      nama: s.nama, 
      nisn: s.nisn, 
      kelas: s.kelas 
    }));
    
    // Menggunakan helper cache _getMapelInternal
    const mapelListFull = _getMapelInternal(ss, sekolahID); 
    // --- AKHIR PERBAIKAN ---

    const filteredMapelList = mapelListFull.filter(m => m.isUS === true || m.isUP === true);
    const mapelList = filteredMapelList.map(m => ({ id: m.id, nama: m.nama }));
    const sheetNilai = getNilaiRaporSheet(ss);
    const dataNilai = sheetNilai.getDataRange().getValues();
    dataNilai.shift();
    const nilaiMapP = new Map();
    const nilaiMapK = new Map();
    const nilaiMapRekap = new Map();
    dataNilai.forEach(row => {
      if (row[2] === semesterId) {
        const key = `${row[0]}_${row[1]}`;
        if (row[3] !== "" && row[3] != null) nilaiMapP.set(key, row[3]);
        if (row[4] !== "" && row[4] != null) nilaiMapK.set(key, row[4]);
        const p = (row[3] === "" || row[3] == null) ? null : parseFloat(row[3]);
        const k = (row[4] === "" || row[4] == null) ? null : parseFloat(row[4]);
        let rekapVal = null;
        if (p != null && !isNaN(p) && k != null && !isNaN(k)) rekapVal = (p + k) / 2;
        else if (p != null && !isNaN(p)) rekapVal = p;
        else if (k != null && !isNaN(k)) rekapVal = k;
        if (rekapVal !== null) nilaiMapRekap.set(key, Math.round(rekapVal));
      }
    });
    const nilaiDataP = {};
    const nilaiDataK = {};
    const nilaiDataRekap = {};
    siswaList.forEach(siswa => {
      mapelList.forEach(mapel => {
        const key = `${siswa.id}_${mapel.id}`;
        if (nilaiMapP.has(key)) nilaiDataP[key] = nilaiMapP.get(key);
        if (nilaiMapK.has(key)) nilaiDataK[key] = nilaiMapK.get(key);
        if (nilaiMapRekap.has(key)) nilaiDataRekap[key] = nilaiMapRekap.get(key);
      });
    });
    const semesterListData = getSemesterList(token);
    let namaSemester = semesterId;
    if (semesterListData.status === 'sukses') {
      const sem = semesterListData.semesterList.find(s => s.id === semesterId);
      if (sem) namaSemester = sem.nama;
    }
    const response = {
      status: "sukses",
      namaSemester: namaSemester,
      dataP: { siswaList, mapelList, nilaiData: nilaiDataP },
      dataK: { siswaList, mapelList, nilaiData: nilaiDataK },
      dataRekap: { siswaList, mapelList, nilaiRekapData: nilaiDataRekap }
    };
    
    scriptCache.put(cacheKey, JSON.stringify(response), 600);
    
    return response;
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function saveNilaiRaporBatch(token, dataToSave, tipeNilai) {
  let spreadsheetID, sessionData;
  try {
    const session = validateAdminSession(token);
    spreadsheetID = session.spreadsheetID;
    sessionData = session.sessionData;
    if (!tipeNilai || (tipeNilai !== 'P' && tipeNilai !== 'K')) return { status: "gagal", message: "Tipe nilai tidak valid." };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
  const lock = LockService.getDocumentLock();
  lock.waitLock(15000);
  try {
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getNilaiRaporSheet(ss);
    
    // --- Modifikasi Batch Dimulai ---
    const range = sheet.getDataRange();
    const data = range.getValues(); // Baca semua data SEKALI
    
    const kolomIndex = (tipeNilai === 'P') ? 3 : 4; // 0-based index (D=3, E=4)
    
    const dataMap = new Map();
    for (let i = 1; i < data.length; i++) {
      dataMap.set(`${data[i][0]}_${data[i][1]}_${data[i][2]}`, {row: i + 1, value: data[i][kolomIndex]});
    }

    const rowsToAppend = [];
    
    dataToSave.forEach(item => {
      if (!item.semesterId) return;
      const key = `${item.siswaId}_${item.mapelId}_${item.semesterId}`;
      let nilaiAngka = null;
      if (item.nilai !== "" && item.nilai != null) {
        let num = parseFloat(item.nilai);
        if (!isNaN(num) && Number.isInteger(num) && num >= 0 && num <= 100) nilaiAngka = num;
      }
      
      const existing = dataMap.get(key);
      
      if (existing !== undefined) {
        const rowIndex_0based = existing.row - 1; // Konversi ke 0-based
        if (data[rowIndex_0based][kolomIndex] !== nilaiAngka) {
          // Modifikasi array di memori
          data[rowIndex_0based][kolomIndex] = nilaiAngka;
        }
      } else {
        let newRow = [item.siswaId, item.mapelId, item.semesterId, null, null];
        newRow[kolomIndex] = nilaiAngka;
        rowsToAppend.push(newRow);
        // Update map agar data baru dikenali
        dataMap.set(key, {
          row: data.length + rowsToAppend.length, 
          value: nilaiAngka
        });
      }
    });

    // Tulis semua perubahan sekaligus
    range.setValues(data);

    if (rowsToAppend.length > 0) {
      sheet.getRange(sheet.getLastRow() + 1, 1, rowsToAppend.length, 5).setValues(rowsToAppend);
    }
    // --- Akhir Modifikasi Batch ---

    const sekolahID = sessionData.sekolahID;
    
    // Panggil fungsi clearNilaiRaporCache dengan spreadsheetID
    clearNilaiRaporCache(sekolahID, spreadsheetID);
    clearLockedKelasCache(sekolahID);
    return { status: "sukses", message: "Nilai rapor tersimpan." };
  } catch (e) {
    return { status: "gagal", message: e.message };
  } finally {
    lock.releaseLock();
  }
}

/**
 * FUNGSI MIGRASI SATU KALI.
 * Jalankan ini secara manual dari editor Apps Script.
 * Ini akan mengubah semua password plain text di Sheet_Sekolah menjadi hash.
 */
function MIGRASI_PasswordLama() {
  Logger.log("Memulai migrasi password...");
  
  let masterSS;
  let sheetSekolah;
  
  try {
    masterSS = SpreadsheetApp.openById(MASTER_SHEET_ID);
    sheetSekolah = masterSS.getSheetByName('Sheet_Sekolah');
    if (!sheetSekolah) {
      Logger.log("Sheet_Sekolah tidak ditemukan. Migrasi dibatalkan.");
      return;
    }
    
    const range = sheetSekolah.getDataRange();
    const values = range.getValues();
    let migratedCount = 0;
    
    // Mulai dari i = 1 untuk melewati header
    for (let i = 1; i < values.length; i++) {
      const plainPass = values[i][4]; // Kolom E
      const salt = values[i][6];      // Kolom G
      
      // Jika 'salt' KOSONG dan 'plainPass' ADA ISINYA, maka itu akun lama
      if (!salt && plainPass) {
        const newSalt = generateSalt();
        const newHash = hashPassword(plainPass, newSalt);
        
        // Update HashedPassword (Kolom E)
        sheetSekolah.getRange(i + 1, 5).setValue(newHash);
        // Update Salt (Kolom G)
        sheetSekolah.getRange(i + 1, 7).setValue(newSalt);
        
        migratedCount++;
        Logger.log(`Password untuk baris ${i+1} (Email: ${values[i][3]}) telah di-hash.`);
      }
    }
    
    if (migratedCount > 0) {
      // Bersihkan cache agar data baru dibaca
      clearMasterSheetCache();
      Logger.log(`Migrasi Selesai. ${migratedCount} password telah di-hash dan diamankan. Cache dibersihkan.`);
      SpreadsheetApp.flush();
      Browser.msgBox(`Migrasi Selesai. ${migratedCount} password telah di-hash dan diamankan.`);
    } else {
      Logger.log("Migrasi Selesai. Tidak ada password plain text yang ditemukan untuk dimigrasi.");
      Browser.msgBox("Migrasi Selesai. Tidak ada password lama yang ditemukan.");
    }
    
  } catch (e) {
    Logger.log("Gagal total saat migrasi: " + e.message);
    Browser.msgBox("Migrasi Gagal: " + e.message);
  }
}

function getNilaiRaporTemplateData(token, semesterId, kelasDipilih) {
  let tempSpreadsheetId = null;
  try {
    const { sessionData } = validateAdminSession(token);
    const namaSekolah = sessionData.namaSekolah;
    const siswaResponse = getSiswa(token);
    if (siswaResponse.status !== 'sukses') throw new Error(siswaResponse.message);
    const siswaList = siswaResponse.siswa;
    const filteredSiswa = (kelasDipilih === 'semua') ? siswaList : siswaList.filter(s => s.kelas === kelasDipilih);
    if (filteredSiswa.length === 0) return { status: "gagal", message: `Tidak ada siswa di kelas '${kelasDipilih}'.` };
    const mapelResponse = getMapel(token);
    if (mapelResponse.status !== 'sukses') throw new Error(mapelResponse.message);
    const mapelList = mapelResponse.mapel;
    if (mapelList.length === 0) return { status: "gagal", message: "Tidak ada mata pelajaran." };
    const timestamp = Utilities.formatDate(new Date(), Session.getScriptTimeZone(), "yyyyMMdd_HHmmss");
    const tempFileName = `[TEMP] Template Rapor - ${namaSekolah} - ${timestamp}`;
    const ss = SpreadsheetApp.create(tempFileName);
    tempSpreadsheetId = ss.getId();
    const rule = SpreadsheetApp.newDataValidation().requireNumberBetween(0, 100).setAllowInvalid(true).build();
    const mapelHeaders = mapelList.map(m => m.id);
    const headers = ["Nama Siswa", "NISN", "Kelas", ...mapelHeaders];
    const dataSiswaRows = filteredSiswa.map(s => [s.nama, String(s.nisn), s.kelas]);
    const sheetP = ss.getSheetByName('Sheet1');
    sheetP.setName("Pengetahuan");
    sheetP.getRange("B:B").setNumberFormat("@");
    sheetP.getRange(1, 1, 1, headers.length).setValues([headers]);
    sheetP.getRange(2, 1, dataSiswaRows.length, 3).setValues(dataSiswaRows);
    if (mapelHeaders.length > 0) sheetP.getRange(2, 4, dataSiswaRows.length, mapelHeaders.length).setDataValidation(rule);
    sheetP.autoResizeColumns(1, 3);
    const sheetK = ss.insertSheet('Keterampilan');
    sheetK.getRange("B:B").setNumberFormat("@");
    sheetK.getRange(1, 1, 1, headers.length).setValues([headers]);
    sheetK.getRange(2, 1, dataSiswaRows.length, 3).setValues(dataSiswaRows);
    if (mapelHeaders.length > 0) sheetK.getRange(2, 4, dataSiswaRows.length, mapelHeaders.length).setDataValidation(rule);
    sheetK.autoResizeColumns(1, 3);
    const metadataSheet = ss.insertSheet('Metadata');
    metadataSheet.appendRow(['SemesterID', semesterId]);
    metadataSheet.appendRow(['Kelas', kelasDipilih]);
    metadataSheet.hideSheet();
    SpreadsheetApp.flush();
    const url = "[https://docs.google.com/spreadsheets/d/](https://docs.google.com/spreadsheets/d/)" + tempSpreadsheetId + "/export?format=xlsx";
    const oauthToken = ScriptApp.getOAuthToken();
    const response = UrlFetchApp.fetch(url, { headers: { 'Authorization': 'Bearer ' + oauthToken } });
    const fileNameOutput = `template_rapor_${semesterId}_${kelasDipilih}.xlsx`;
    return { status: "sukses", base64: Utilities.base64Encode(response.getBlob().getBytes()), mimeType: MimeType.MICROSOFT_EXCEL, fileName: fileNameOutput };
  } catch (e) {
    return { status: "gagal", message: "Gagal membuat template: " + e.message };
  } finally {
    if (tempSpreadsheetId) DriveApp.getFileById(tempSpreadsheetId).setTrashed(true);
  }
}

function prosesUploadExcelNilai(token, fileData) {
  let tempExcelFileId = null;
  let tempConvertedSheetId = null;
  try {
    const { sessionData, spreadsheetID } = validateAdminOrGuruSession(token);
    const ss = SpreadsheetApp.openById(spreadsheetID);

    // --- TAMBAHAN KEAMANAN UNTUK GURU ---
    const isGuru = (sessionData.role === 'guru');
    const assignedMapelSet = isGuru ? new Set(sessionData.assignedMapel) : null;

    // --- TAMBAHKAN BLOK INI ---
    if (isGuru) {
      const cekWaktu = cekWaktuInputGuru(ss);
      if (!cekWaktu.diizinkan) {
        throw new Error(cekWaktu.pesan); // Hentikan proses upload
      }
    }
    // --- AKHIR TAMBAHAN ---

    const sheetSiswa = getSiswaSheet(ss);
    const dataSiswa = sheetSiswa.getDataRange().getValues();
    dataSiswa.shift();
    const nisnToSiswaIdMap = new Map(dataSiswa.map(row => [String(row[2]), row[0]]));
    const sheetMapel = getMapelSheet(ss);
    const dataMapel = sheetMapel.getDataRange().getValues();
    dataMapel.shift();
    const mapelIdSet = new Set(dataMapel.map(row => row[0]));

    const { base64, mimeType, fileName } = fileData;
    const decodedData = Utilities.base64Decode(base64.split(',')[1]);
    const blob = Utilities.newBlob(decodedData, mimeType, fileName);
    const tempExcelFile = DriveApp.createFile(blob);
    tempExcelFileId = tempExcelFile.getId();
    const conversionResource = { title: `[TEMP] Upload Nilai - ${fileName}`, mimeType: MimeType.GOOGLE_SHEETS };
    const convertedFile = Drive.Files.copy(conversionResource, tempExcelFileId, { convert: true });
    tempConvertedSheetId = convertedFile.id;
    const tempSheet = SpreadsheetApp.openById(tempConvertedSheetId);
    const gagalList = [];
    const dataToSave = [];
    let totalDitemukan = 0;
    const jenjangPilihan = sessionData.jenjangPilihan;
    const namaSheetUS = (jenjangPilihan === 'MI' || jenjangPilihan === 'MTS' || jenjangPilihan === 'MA') ? 'Ujian Madrasah' : 'Ujian Sekolah';
    const sheetsToProcess = [{ name: namaSheetUS, type: 'UM' }, { name: 'Ujian Praktek', type: 'Praktek' }];
    sheetsToProcess.forEach(sheetInfo => {
      const sheet = tempSheet.getSheetByName(sheetInfo.name);
      if (!sheet) {
        gagalList.push({ sheet: sheetInfo.name, baris: 'N/A', info: 'Sheet Tidak Ditemukan', alasan: 'Sheet tidak ada di file.' });
        return;
      }
      const data = sheet.getDataRange().getValues();
      if (data.length <= 1) return;
      const header = data.shift();
      const mapelHeaders = header.slice(3);
      data.forEach((row, rowIndex) => {
        const barisKe = rowIndex + 2;
        const namaSiswa = row[0];
        const nisn = String(row[1]).trim();
        const siswaId = nisnToSiswaIdMap.get(nisn);
        if (!siswaId) {
          gagalList.push({ sheet: sheetInfo.name, baris: barisKe, info: `Siswa: ${namaSiswa || nisn}`, alasan: "NISN tidak terdaftar." });
          return;
        }
        mapelHeaders.forEach((mapelId, mapelIndex) => {
          mapelId = String(mapelId).trim();
          const nilai = row[mapelIndex + 3];
          if (nilai === null || nilai === "") return;

          // --- TAMBAHAN PENGECEKAN GURU ---
          if (isGuru && !assignedMapelSet.has(mapelId)) {
            // Jika ini guru, dan mapel ini BUKAN mapel mereka,
            // lewati (jangan proses dan jangan laporkan error).
            return; // Ini sama dengan 'continue' di forEach
          }
          // --- AKHIR TAMBAHAN ---

          totalDitemukan++;
          const info = `Siswa: ${namaSiswa} (Mapel: ${mapelId})`;
          if (!mapelIdSet.has(mapelId)) {
            gagalList.push({ sheet: sheetInfo.name, baris: barisKe, info: info, alasan: `Kode Mapel '${mapelId}' tidak dikenal.` });
            return;
          }
          let num = parseFloat(nilai);
          if (isNaN(num) || !Number.isInteger(num) || num < 0 || num > 100) {
            gagalList.push({ sheet: sheetInfo.name, baris: barisKe, info: info, alasan: `Nilai '${nilai}' tidak valid (harus angka bulat 0-100).` });
            return;
          }
          dataToSave.push({ siswaId: siswaId, mapelId: mapelId, tipeUjian: sheetInfo.type, nilai: num });
        });
      });
    });
    if (dataToSave.length > 0) {
      const saveResult = saveNilaiUjianBatch(token, dataToSave);
      if (saveResult.status !== 'sukses') throw new Error(saveResult.message);
    }
    DriveApp.getFileById(tempExcelFileId).setTrashed(true);
    DriveApp.getFileById(tempConvertedSheetId).setTrashed(true);
    return { status: "sukses", totalDitemukan: totalDitemukan, berhasilDiUpload: dataToSave.length, gagalDiUpload: gagalList.length, dataGagal: gagalList };
  } catch (e) {
    if (tempExcelFileId) DriveApp.getFileById(tempExcelFileId).setTrashed(true);
    if (tempConvertedSheetId) DriveApp.getFileById(tempConvertedSheetId).setTrashed(true);
    return { status: "gagal", message: "Terjadi error: " + e.message };
  }
}

function prosesUploadExcelNilaiRapor(token, fileData, semesterIdFromModal) {
  let tempExcelFileId = null;
  let tempConvertedSheetId = null;
  try {
    const { sessionData, spreadsheetID } = validateAdminSession(token);
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const { base64, mimeType, fileName } = fileData;
    const decodedData = Utilities.base64Decode(base64.split(',')[1]);
    const blob = Utilities.newBlob(decodedData, mimeType, fileName);
    const tempExcelFile = DriveApp.createFile(blob);
    tempExcelFileId = tempExcelFile.getId();
    const conversionResource = { title: `[TEMP] Upload Rapor - ${fileName}`, mimeType: MimeType.GOOGLE_SHEETS };
    const convertedFile = Drive.Files.copy(conversionResource, tempExcelFileId, { convert: true });
    tempConvertedSheetId = convertedFile.id;
    const tempSheet = SpreadsheetApp.openById(tempConvertedSheetId);
    const metadataSheet = tempSheet.getSheetByName('Metadata');
    if (!metadataSheet) throw new Error("File template tidak valid. Sheet 'Metadata' hilang.");
    const templateSemesterId = metadataSheet.getRange('B1').getValue();
    const templateKelas = metadataSheet.getRange('B2').getValue();
    if (templateSemesterId !== semesterIdFromModal) throw new Error("Semester file tidak cocok dengan pilihan.");
    const sheetSiswa = getSiswaSheet(ss);
    const dataSiswa = sheetSiswa.getDataRange().getValues();
    dataSiswa.shift();
    const nisnToSiswaIdMap = new Map();
    dataSiswa.forEach(row => {
      if (templateKelas === 'semua' || row[7] === templateKelas) nisnToSiswaIdMap.set(String(row[2]), row[0]);
    });
    const sheetMapel = getMapelSheet(ss);
    const dataMapel = sheetMapel.getDataRange().getValues();
    dataMapel.shift();
    const mapelIdSet = new Set(dataMapel.map(row => row[0]));
    const gagalList = [];
    const dataToSaveP = [];
    const dataToSaveK = [];
    let totalDitemukan = 0;
    const sheetsToProcess = [{ name: "Pengetahuan", dataArray: dataToSaveP }, { name: 'Keterampilan', dataArray: dataToSaveK }];
    sheetsToProcess.forEach(sheetInfo => {
      const sheet = tempSheet.getSheetByName(sheetInfo.name);
      if (!sheet) {
        gagalList.push({ sheet: sheetInfo.name, baris: 'N/A', info: 'Sheet Tidak Ditemukan', alasan: 'Sheet tidak ada.' });
        return;
      }
      const data = sheet.getDataRange().getValues();
      if (data.length <= 1) return;
      const header = data.shift();
      const mapelHeaders = header.slice(3);
      data.forEach((row, rowIndex) => {
        const barisKe = rowIndex + 2;
        const namaSiswa = row[0];
        const nisn = String(row[1]).trim();
        const kelasSiswa = String(row[2]).trim();
        const siswaId = nisnToSiswaIdMap.get(nisn);
        if (templateKelas !== 'semua' && kelasSiswa !== templateKelas) {
          gagalList.push({ sheet: sheetInfo.name, baris: barisKe, info: `Siswa: ${namaSiswa}`, alasan: "Siswa salah kelas." });
          return;
        }
        if (!siswaId) {
          gagalList.push({ sheet: sheetInfo.name, baris: barisKe, info: `Siswa: ${namaSiswa || nisn}`, alasan: "NISN tidak terdaftar." });
          return;
        }
        mapelHeaders.forEach((mapelId, mapelIndex) => {
          mapelId = String(mapelId).trim();
          const nilai = row[mapelIndex + 3];
          if (nilai === null || nilai === "") return;
          totalDitemukan++;
          const info = `Siswa: ${namaSiswa} (Mapel: ${mapelId})`;
          if (!mapelIdSet.has(mapelId)) {
            gagalList.push({ sheet: sheetInfo.name, baris: barisKe, info: info, alasan: `Kode Mapel '${mapelId}' tidak dikenal.` });
            return;
          }
          let num = parseFloat(nilai);
          if (isNaN(num) || !Number.isInteger(num) || num < 0 || num > 100) {
            gagalList.push({ sheet: sheetInfo.name, baris: barisKe, info: info, alasan: `Nilai '${nilai}' tidak valid.` });
            return;
          }
          sheetInfo.dataArray.push({ siswaId, mapelId, semesterId: templateSemesterId, nilai: num });
        });
      });
    });
    let totalBerhasil = 0;
    if (dataToSaveP.length > 0) {
      const saveResultP = saveNilaiRaporBatch(token, dataToSaveP, 'P');
      if (saveResultP.status === 'sukses') totalBerhasil += dataToSaveP.length;
      else throw new Error("Gagal simpan Pengetahuan: " + saveResultP.message);
    }
    if (dataToSaveK.length > 0) {
      const saveResultK = saveNilaiRaporBatch(token, dataToSaveK, 'K');
      if (saveResultK.status === 'sukses') totalBerhasil += dataToSaveK.length;
      else throw new Error("Gagal simpan Keterampilan: " + saveResultK.message);
    }
    DriveApp.getFileById(tempExcelFileId).setTrashed(true);
    DriveApp.getFileById(tempConvertedSheetId).setTrashed(true);
    return { status: "sukses", totalDitemukan, berhasilDiUpload: totalBerhasil, gagalDiUpload: gagalList.length, dataGagal: gagalList };
  } catch (e) {
    if (tempExcelFileId) DriveApp.getFileById(tempExcelFileId).setTrashed(true);
    if (tempConvertedSheetId) DriveApp.getFileById(tempConvertedSheetId).setTrashed(true);
    return { status: "gagal", message: "Terjadi error: " + e.message };
  }
}

// HAPUS fungsi getMapelDataInternal() lama Anda
// dan TAMBAHKAN fungsi _getMapelInternal() ini
/**
 * [INTERNAL HELPER] Mengambil data mapel dari cache atau sheet.
 * (Sebelumnya bernama getMapelDataInternal)
 */
function _getMapelInternal(ss, sekolahID) {
  const cacheKey = MAPEL_CACHE_KEY + "_" + sekolahID;
  
  // --- PERBAIKAN ---
  const scriptCache = CacheService.getScriptCache();
  const cachedMapel = scriptCache.get(cacheKey);
  // --- AKHIR PERBAIKAN ---

  if (cachedMapel != null) {
    return JSON.parse(cachedMapel);
  }
  
  Logger.log("CACHE MISS: _getMapelInternal untuk " + sekolahID);
  const sheetMapel = getMapelSheet(ss);
  const data = sheetMapel.getDataRange().getValues();
  data.shift();
  const mapel = data.map((row, index) => ({
    id: row[0],
    nama: row[1],
    isUS: row[2] || false,
    isUP: row[3] || false,
    urutan: Number(row[4] || index + 1)
  })).filter(row => row.id).sort((a, b) => a.urutan - b.urutan);
  
  // --- PERBAIKAN ---
  scriptCache.put(cacheKey, JSON.stringify(mapel), 600);
  // --- AKHIR PERBAIKAN ---

  return mapel;
}

function getRekapUjianInternal(ss, siswaList, mapelListFull) {
  
    const filteredMapelList = mapelListFull.filter(m => m.isUS === true || m.isUP === true);
    const mapelFlags = new Map(filteredMapelList.map(m => [m.id, { isUS: m.isUS, isUP: m.isUP }]));
    
    const sheetNilai = getNilaiUjianSheet(ss);
    const dataNilai = sheetNilai.getDataRange().getValues();
    dataNilai.shift(); 
    
    const nilaiMap = new Map();
    dataNilai.forEach(row => {
      const siswaId = row[0];
      const mapelId = row[1];
      const nilaiUM = row[2];
      const nilaiUP = row[3];
      const key = `${siswaId}_${mapelId}`;
      nilaiMap.set(key, { um: nilaiUM, up: nilaiUP });
    });
    
    const nilaiRekapData = new Map();
    siswaList.forEach(siswa => {
      filteredMapelList.forEach(mapel => {
        const key = `${siswa.id}_${mapel.id}`;
        const storedNilai = nilaiMap.get(key);
        const flags = mapelFlags.get(mapel.id);
        
        let nilaiRekap = null;
        
        if (flags && (flags.isUS || flags.isUP)) {
          let nilaiUM_to_use = null;
          let nilaiUP_to_use = null;

          if (storedNilai) {
            nilaiUM_to_use = (flags.isUS) ? storedNilai.um : null;
            nilaiUP_to_use = (flags.isUP) ? storedNilai.up : null;
          }
          
          nilaiRekap = hitungNilaiRekap(nilaiUM_to_use, nilaiUP_to_use);
        }
        
        if (nilaiRekap !== null) {
            nilaiRekapData.set(key, Math.round(nilaiRekap));
        }
      });
    });

    return { 
      mapelList: filteredMapelList.map(m => ({ id: m.id, nama: m.nama })),
      nilaiRekapMap: nilaiRekapData
    };
}

function getRekapRaporInternal(ss, siswaList, mapelListFull, semesterIds) {

  const semesterIdSet = new Set(semesterIds);
  const semesterCount = semesterIds.length;
  
  const filteredMapelList = mapelListFull.filter(m => m.isUS === true || m.isUP === true);
  
  const sheetNilai = getNilaiRaporSheet(ss);
  const dataNilai = sheetNilai.getDataRange().getValues();
  dataNilai.shift(); 
  
  const nilaiMap = new Map();
  dataNilai.forEach(row => {
    const siswaId = row[0];
    const mapelId = row[1];
    const semId = row[2];
    const nilaiP = parseFloat(row[3]); 
    const nilaiK = parseFloat(row[4]); 
    
    if (semesterIdSet.has(semId)) {
      
      let nilaiAkhirSem = null;
      const pIsValid = !isNaN(nilaiP);
      const kIsValid = !isNaN(nilaiK);
      
      if (pIsValid && kIsValid) {
        nilaiAkhirSem = (nilaiP + nilaiK) / 2;
      } else if (pIsValid) {
        nilaiAkhirSem = nilaiP;
      } else if (kIsValid) {
        nilaiAkhirSem = nilaiK;
      }

      if (nilaiAkhirSem !== null) {
        const key = `${siswaId}_${mapelId}`;
        if (!nilaiMap.has(key)) {
          nilaiMap.set(key, []);
        }
        nilaiMap.get(key).push(nilaiAkhirSem);
      }
    }
  });
  
  const nilaiRekapData = new Map();
  siswaList.forEach(siswa => {
    filteredMapelList.forEach(mapel => { 
      const key = `${siswa.id}_${mapel.id}`;
      const nilaiArray = nilaiMap.get(key);
      
      if (nilaiArray && nilaiArray.length > 0) {
        const sum = nilaiArray.reduce((acc, val) => acc + val, 0);
        const average = sum / semesterCount; 
        
        nilaiRekapData.set(key, Math.round(average));
      } else {
        nilaiRekapData.set(key, null);
      }
    });
  });

  return {
    mapelList: filteredMapelList.map(m => ({ id: m.id, nama: m.nama })),
    nilaiRekapMap: nilaiRekapData
  };
}

function getNilaiIjazahData(token) {
  try {
    const { spreadsheetID } = validateAdminSession(token);
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = ss.getSheetByName(SHEET_CACHE_IJAZAH);
    if (!sheet) return { status: "gagal", message: "Data belum dikalkulasi. Klik 'Hitung Ulang Nilai' dulu." };
    const metaValues = sheet.getRange(1, 1, 1, 7).getValues()[0];
    if (metaValues[0] !== 'Meta' || !metaValues[1]) return { status: "gagal", message: "Cache rusak. Klik 'Hitung Ulang Nilai'." };
    let siswaList, mapelList;
    try {
      siswaList = JSON.parse(metaValues[5]);
      mapelList = JSON.parse(metaValues[6]);
    } catch (e) { throw new Error("Data cache rusak. Harap Hitung Ulang."); }
    const dataUjianOriginal = {};
    const dataRaporOriginal = {};
    const dataUjianWeighted = {};
    const dataRaporWeighted = {};
    const dataIjazahFinal = {};
    const lastRow = sheet.getLastRow();
    if (lastRow > 2) {
      const dataValues = sheet.getRange(3, 1, lastRow - 2, 7).getValues();
      for (let i = 0; i < dataValues.length; i++) {
        const row = dataValues[i];
        const key = `${row[0]}_${row[1]}`;
        dataUjianOriginal[key] = row[2];
        dataRaporOriginal[key] = row[3];
        dataUjianWeighted[key] = row[4];
        dataRaporWeighted[key] = row[5];
        dataIjazahFinal[key] = row[6];
      }
    }
    return {
      status: "sukses",
      data: {
        siswaList, mapelList, dataUjian: dataUjianWeighted, dataRapor: dataRaporWeighted,
        dataIjazah: dataIjazahFinal, dataUjianOriginal, dataRaporOriginal,
        kkm: metaValues[4], bobotUjianPct: metaValues[3], bobotRaporPct: metaValues[2]
      }
    };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

// Salin dan GANTI fungsi recalculateIjazahData() Anda dengan yang ini
function recalculateIjazahData(token) {
  let spreadsheetID, sessionData;
  try {
    const session = validateAdminSession(token);
    spreadsheetID = session.spreadsheetID;
    sessionData = session.sessionData;
    const ss = SpreadsheetApp.openById(spreadsheetID);
    
    const sheetSetting = getPengaturanSheet(ss);
    const settings = sheetSetting.getRange('A1:B' + sheetSetting.getLastRow()).getValues();
    let bobotRapor = 60, bobotUjian = 40, kkm = 76, jmlSemester = 5;
    settings.forEach(s => {
      if (s[0] === 'Bobot_Rapor') bobotRapor = s[1];
      if (s[0] === 'Bobot_Ujian') bobotUjian = s[1];
      if (s[0] === 'KKM') kkm = s[1];
      if (s[0] === 'Jumlah_Semester') jmlSemester = s[1];
    });

    // --- PERBAIKAN 2.2 (SUDAH DITERAPKAN) ---
    // Menggunakan helper cache _getSiswaInternal
    // Kita butuh data lengkap (termasuk tglLahir), jadi panggil _getSiswaInternal
    const siswaListFull = _getSiswaInternal(spreadsheetID, sessionData.sekolahID);
    const siswaList = siswaListFull.map(s => ({ 
        id: s.id, 
        nama: s.nama, 
        nisn: s.nisn, 
        kelas: s.kelas 
    }));
    
    // Menggunakan helper cache _getMapelInternal
    const mapelListFull = _getMapelInternal(ss, sessionData.sekolahID);
    // --- AKHIR PERBAIKAN 2.2 ---
    
    const mapelIjazah = mapelListFull.filter(m => m.isUS || m.isUP);
    
    const { nilaiRekapMap: nilaiUjian } = getRekapUjianInternal(ss, siswaList, mapelListFull);
    
    const semesterIds = [];
    const jenjang = sessionData.jenjang;
    if (jenjang === 'SD/MI') {
       if (jmlSemester === 3) semesterIds.push('K5_S1','K5_S2','K6_S1');
       else semesterIds.push('K4_S1','K4_S2','K5_S1','K5_S2','K6_S1');
    } else if (jenjang === 'SMP/MTS') {
       semesterIds.push('K7_S1','K7_S2','K8_S1','K8_S2','K9_S1');
    } else {
       semesterIds.push('K10_S1','K10_S2','K11_S1','K11_S2','K12_S1');
    }
    const { nilaiRekapMap: nilaiRapor } = getRekapRaporInternal(ss, siswaList, mapelListFull, semesterIds);

    const dataToAppend = [];
    
    // --- PERBAIKAN 2.3: Buat rekapMap di sini ---
    const rekapMap = new Map();
    // --- AKHIR PERBAIKAN 2.3 ---

    siswaList.forEach(siswa => {
      // --- PERBAIKAN 2.3 ---
      let sum = 0;
      let count = 0;
      // --- AKHIR PERBAIKAN 2.3 ---

      mapelIjazah.forEach(mapel => {
        const key = `${siswa.id}_${mapel.id}`;
        const nU = nilaiUjian.get(key) || 0;
        const nR = nilaiRapor.get(key) || 0;
        const final = (nU * (bobotUjian/100)) + (nR * (bobotRapor/100));
        dataToAppend.push([siswa.id, mapel.id, nU, nR, nU*(bobotUjian/100), nR*(bobotRapor/100), final]);
        
        // --- PERBAIKAN 2.3: Kumpulkan nilai akhir ---
        sum += final;
        count++;
        // --- AKHIR PERBAIKAN 2.3 ---
      });

      // --- PERBAIKAN 2.3: Simpan data rekap untuk dikirim ---
      rekapMap.set(siswa.id, { sum: sum, count: count });
      // --- AKHIR PERBAIKAN 2.3 ---
    });

    let sheetCache = ss.getSheetByName(SHEET_CACHE_IJAZAH);
    if (!sheetCache) { sheetCache = ss.insertSheet(SHEET_CACHE_IJAZAH); sheetCache.hideSheet(); }
    sheetCache.clear();
    sheetCache.appendRow(['Meta', new Date(), bobotRapor, bobotUjian, kkm, JSON.stringify(siswaList), JSON.stringify(mapelIjazah), jmlSemester]);
    sheetCache.appendRow(['SiswaID', 'MapelID', 'UjianAsli', 'RaporAsli', 'UjianBobot', 'RaporBobot', 'IjazahFinal']);
    if (dataToAppend.length > 0) sheetCache.getRange(3, 1, dataToAppend.length, 7).setValues(dataToAppend);

    // --- PERBAIKAN 2.3: Buat siswaMap dan nisnList di sini ---
    const siswaMap = new Map();
    const nisnList = [];
    // Gunakan siswaListFull dari _getSiswaInternal() karena mengandung tglLahir
    siswaListFull.forEach(siswa => { 
        let nisn = String(siswa.nisn).trim().replace("'", "");
        const tglLahir = siswa.tglLahir; // Ambil tglLahir dari helper
        if (nisn && tglLahir && siswa.nama) {
          siswaMap.set(nisn, { id: siswa.id, dob: tglLahir, nama: siswa.nama });
          nisnList.push(nisn);
        }
    });
    // --- AKHIR PERBAIKAN 2.3 ---

    const db = SpreadsheetApp.openById(MASTER_KELULUSAN_DB_ID);
    const sheetHasil = db.getSheetByName('Sheet_Hasil_Publikasi');
    const hasilData = sheetHasil.getDataRange().getValues();
    for (let i = 1; i < hasilData.length; i++) {
      if (hasilData[i][0] === sessionData.sekolahID) {
        
        // --- PERUBAHAN KRUSIAL 2.3: Kirim data sebagai parameter ---
        _internalPublishLogic(
            spreadsheetID, 
            sessionData.sekolahID, 
            sessionData.namaSekolah, 
            hasilData[i][1],
            siswaMap,   // <-- Data baru
            nisnList,   // <-- Data baru
            rekapMap,   // <-- Data baru
            kkm         // <-- Data baru
        );
        // --- AKHIR PERUBAHAN 2.3 ---
        break;
      }
    }

    return { status: "sukses", message: "Nilai berhasil dihitung.", isDirty: false };
  } catch (e) {
    return { status: "gagal", message: e.message, isDirty: true };
  }
}

function exportDataIjazah(token, tipeFile, tipeData, kelasFilter, isWeighted) {
  let tempSpreadsheetId = null;
  try {
    const { sessionData } = validateAdminSession(token);
    const namaSekolah = sessionData.namaSekolah;
    const jenjangPilihan = sessionData.jenjangPilihan;
    const ijazahResponse = getNilaiIjazahData(token);
    if (ijazahResponse.status !== 'sukses') throw new Error(ijazahResponse.message);
    const data = ijazahResponse.data;
    let dataToExport, title = "", kkmInfo = "";
    if (tipeData === 'ujian') {
      dataToExport = isWeighted ? data.dataUjian : data.dataUjianOriginal;
      title = (jenjangPilihan === 'MI' || jenjangPilihan === 'MTS' || jenjangPilihan === 'MA') ? "NILAI UJIAN MADRASAH" : "NILAI UJIAN SEKOLAH";
      kkmInfo = isWeighted ? `(Bobot ${data.bobotUjianPct}%)` : "(Nilai Asli)";
    } else if (tipeData === 'rapor') {
      dataToExport = isWeighted ? data.dataRapor : data.dataRaporOriginal;
      title = "NILAI RAPOR";
      kkmInfo = isWeighted ? `(Bobot ${data.bobotRaporPct}%)` : "(Nilai Asli)";
    } else {
      dataToExport = data.dataIjazah;
      title = "NILAI IJAZAH";
      kkmInfo = `(KKM: ${data.kkm})`;
    }
    const filteredSiswaList = (kelasFilter === 'semua') ? data.siswaList : data.siswaList.filter(s => s.kelas === kelasFilter);
    const dataPayload = {
      namaSekolah, title, kkmInfo, kelasFilter, siswaList: filteredSiswaList,
      mapelList: data.mapelList, nilaiData: dataToExport, tipeData, isWeighted, kkmValue: data.kkm
    };
    const tempSS = buatSpreadsheetEksporIjazah(dataPayload);
    tempSpreadsheetId = tempSS.getId();
    let blob, fileName, mimeType;
    const timestamp = Utilities.formatDate(new Date(), Session.getScriptTimeZone(), "yyyyMMdd");
    const safeTitle = title.replace(/ /g, '_'), safeKelas = kelasFilter.replace(/ /g, '_');
    if (tipeFile === 'pdf') {
      blob = generatePdfBlobFromSheet(tempSS);
      fileName = `Nilai_${safeTitle}_${safeKelas}_${timestamp}.pdf`;
      mimeType = MimeType.PDF;
    } else {
      blob = generateExcelBlobFromSheet(tempSS);
      fileName = `Nilai_${safeTitle}_${safeKelas}_${timestamp}.xlsx`;
      mimeType = MimeType.MICROSOFT_EXCEL;
    }
    return { status: "sukses", base64: Utilities.base64Encode(blob.getBytes()), mimeType, fileName };
  } catch (e) {
    return { status: "gagal", message: e.message };
  } finally {
    if (tempSpreadsheetId) DriveApp.getFileById(tempSpreadsheetId).setTrashed(true);
  }
}

function buatSpreadsheetEksporIjazah(dataPayload) {
  const { namaSekolah, title, kkmInfo, kelasFilter, siswaList, mapelList, nilaiData, tipeData, isWeighted, kkmValue } = dataPayload;
  
  const ss = SpreadsheetApp.create(`[TEMP] Ekspor ${title}`);
  const sheet = ss.getSheetByName('Sheet1');
  sheet.setName('Data Nilai');

  sheet.getRange('A1').setValue(namaSekolah.toUpperCase()).setFontSize(14).setFontWeight('bold');
  sheet.getRange('A2').setValue(`REKAPITULASI ${title.toUpperCase()} ${kkmInfo}`).setFontSize(12).setFontWeight('bold');
  sheet.getRange('A3').setValue(`Kelas: ${(kelasFilter === 'semua') ? 'Semua Kelas' : kelasFilter}`).setFontSize(12).setFontWeight('bold');

  const headers = ["No", "Nama Siswa", "NISN", "Kelas", ...mapelList.map(m => m.id), "Jumlah", "Rata-Rata"];
  if (tipeData === 'ijazah') {
    headers.push("Status");
  }
  
  const headerRange = sheet.getRange(5, 1, 1, headers.length);
  headerRange.setValues([headers]);
  headerRange.setFontWeight('bold').setHorizontalAlignment('center').setVerticalAlignment('middle');
  headerRange.setBackground("#666666").setFontColor("#ffffff");

  headerRange.setWrap(false);
  sheet.getRange(5, 2).setWrap(true);
  sheet.getRange(5, 5, 1, mapelList.length).setWrap(true);

  const dataRows = [];
  
  siswaList.forEach((siswa, index) => {
    const row = [index + 1, siswa.nama, "'" + siswa.nisn, siswa.kelas];
    let sum = 0;
    let count = 0;
    
    mapelList.forEach(mapel => {
      const key = `${siswa.id}_${mapel.id}`;
      const nilai = nilaiData[key];
      
      if (nilai !== null && nilai !== undefined) {
        const nilaiAngka = parseFloat(nilai);
        if (tipeData === 'ijazah' || !isWeighted) {
          const nilaiTampil = Math.round(nilaiAngka);
          sum += nilaiTampil;
          row.push(nilaiTampil); 
        } else {
          const nilaiTampil = parseFloat(nilaiAngka.toFixed(2));
          sum += nilaiTampil;
          row.push("'" + nilaiTampil.toFixed(2).replace('.', ',')); 
        }
        count++;
      } else {
        row.push(null); 
      }
    });
    
    const average = (count > 0) ? (sum / count) : 0;
    
    if (tipeData === 'ijazah' || !isWeighted) {
      row.push(Math.round(sum)); 
    } else {
      row.push("'" + sum.toFixed(2).replace('.', ',')); 
    }
    
    row.push("'" + average.toFixed(2).replace('.', ',')); 

    if (tipeData === 'ijazah') {
      row.push(average >= kkmValue ? 'LULUS' : 'TIDAK LULUS');
    }
    
    dataRows.push(row);
  });

  if (dataRows.length > 0) {
    const dataRange = sheet.getRange(6, 1, dataRows.length, headers.length);
    dataRange.setValues(dataRows);
    dataRange.applyRowBanding(SpreadsheetApp.BandingTheme.LIGHT_GREY, false, false);
    
    dataRange.setVerticalAlignment('middle'); 
    sheet.getRange(6, 2, dataRows.length, 1).setWrap(true); 
    
    sheet.getRange(6, 1, dataRows.length, 1).setHorizontalAlignment('center'); // Kolom No (A) -> Rata Tengah
    sheet.getRange(6, 2, dataRows.length, 1).setHorizontalAlignment('left');  // Kolom Nama (B) -> Rata Kiri
    
    // --- PERBAIKAN RATA TENGAH NISN ---
    sheet.getRange(6, 3, dataRows.length, 1).setHorizontalAlignment('center'); // Kolom NISN (C) -> Rata Tengah
    sheet.getRange(6, 4, dataRows.length, headers.length - 3).setHorizontalAlignment('center'); // Kolom Kelas (D) -> dst
    // --- AKHIR PERBAIKAN ---
    
    const tableRange = sheet.getRange(5, 1, dataRows.length + 1, headers.length);
    tableRange.setBorder(true, true, true, true, true, true);
    tableRange.setFontSize(11); 
    
    const legendStartRow = 6 + dataRows.length + 2; 
    
    const mergeStartCol = 3; 
    const mergeEndCol = 12;  
    const mergeCount = mergeEndCol - mergeStartCol + 1; 
    
    sheet.getRange(legendStartRow, mergeStartCol, 1, mergeCount).merge(); 
    
    // --- PERBAIKAN RATA KIRI LEGENDA ---
    sheet.getRange(legendStartRow, mergeStartCol).setValue("Keterangan Kode Mapel :")
         .setFontWeight('bold').setFontSize(11).setHorizontalAlignment('left');
    // --- AKHIR PERBAIKAN ---
         
    const legendData = [];
    mapelList.forEach(mapel => {
      legendData.push([mapel.id, "'=", mapel.nama]); 
    });
    
    if (legendData.length > 0) {
      const legendDataRange = sheet.getRange(legendStartRow + 1, 3, legendData.length, 3);
      legendDataRange.setValues(legendData);
      
      legendDataRange.setFontSize(11);
      
      // --- PERBAIKAN RATA KIRI LEGENDA ---
      sheet.getRange(legendStartRow + 1, 3, legendData.length, 1).setFontWeight('bold').setHorizontalAlignment('left'); // Kolom C (Kode)
      // --- AKHIR PERBAIKAN ---
      
      sheet.getRange(legendStartRow + 1, 4, legendData.length, 1).setHorizontalAlignment('center'); // Kolom D (=)

      for (let i = 0; i < legendData.length; i++) {
        let row = legendStartRow + 1 + i;
        sheet.getRange(row, 5, 1, 8).merge(); 
        sheet.getRange(row, 5).setHorizontalAlignment('left').setVerticalAlignment('middle');
      }
    }
  }

  sheet.setColumnWidth(1, 40); 
  sheet.setColumnWidth(2, 220); 
  sheet.setColumnWidth(3, 100); 
  sheet.setColumnWidth(4, 60);  
  
  const mapelColStart = 5;
  for(let i = 0; i < mapelList.length; i++) {
    const colIndex = mapelColStart + i;
    sheet.setColumnWidth(colIndex, 60); 
  }

  const rekapColStart = mapelColStart + mapelList.length;
  sheet.setColumnWidth(rekapColStart, 80); 
  sheet.setColumnWidth(rekapColStart + 1, 80); 
  if (tipeData === 'ijazah') {
    sheet.setColumnWidth(rekapColStart + 2, 100); 
  }

  SpreadsheetApp.flush();

  return ss;
}

function generatePdfBlobFromSheet(spreadsheet) {
  const spreadsheetId = spreadsheet.getId();
  const file = DriveApp.getFileById(spreadsheetId);
  
  const marginInches = 0.2 / 2.54; 
  
  const url = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/export?` +
    'format=pdf&' +
    'size=a4&' +
    'portrait=false&' + 
    'fitw=true&' + 
    'sheetnames=false&' +
    'printtitle=false&' +
    'pagenumbers=false&' +
    'gridlines=false&' +
    'fzr=false&' +
    'gid=' + spreadsheet.getSheets()[0].getSheetId() + '&' +
    `top_margin=${marginInches}&` +
    `bottom_margin=${marginInches}&` +
    `left_margin=${marginInches}&` +
    `right_margin=${marginInches}`;
    
  const token = ScriptApp.getOAuthToken();
  const response = UrlFetchApp.fetch(url, {
    headers: {
      'Authorization': 'Bearer ' + token
    }
  });

  return response.getBlob().setName(spreadsheet.getName() + ".pdf");
}

function generateExcelBlobFromSheet(spreadsheet) {
  const spreadsheetId = spreadsheet.getId();
  const url = "https://docs.google.com/spreadsheets/d/" + spreadsheetId + "/export?format=xlsx";
  const token = ScriptApp.getOAuthToken();
  
  const response = UrlFetchApp.fetch(url, {
    headers: {
      'Authorization': 'Bearer ' + token
    }
  });

  return response.getBlob().setName(spreadsheet.getName() + ".xlsx");
}

function clearAllCaches(token) {
  try {
    const { sessionData } = validateAdminSession(token);
    clearSiswaCache(sessionData.sekolahID);
    clearMapelCache(sessionData.sekolahID);
    clearMasterSheetCache();
    return { status: "sukses" };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function getValidationDataBySiswa(token) {
  try {
    const { sessionData, spreadsheetID } = validateAdminSession(token);
    const ss = SpreadsheetApp.openById(spreadsheetID);
    
    // --- PERBAIKAN DI SINI ---
    const siswaList = _getSiswaInternal(spreadsheetID, sessionData.sekolahID);
    const mapelListFull = _getMapelInternal(ss, sessionData.sekolahID);
    // --- AKHIR PERBAIKAN ---

    const requiredMapelList = mapelListFull.filter(m => m.isUS === true || m.isUP === true);
    const requiredMapelIds = new Set(requiredMapelList.map(m => m.id));
    const mapelInfoMap = new Map(requiredMapelList.map(m => [m.id, { isUS: m.isUS, isUP: m.isUP }]));
    
    const semesterListData = getSemesterList(token);
    if (semesterListData.status !== 'sukses') throw new Error("Gagal mengambil daftar semester.");
    const requiredSemesterList = semesterListData.semesterList;
    const semesterListWithCodes = requiredSemesterList.map(sem => {
      const parts = sem.id.split('_');
      return { ...sem, shortCode: (parts.length === 2) ? `${parts[0].replace('K', '')}.${parts[1].replace('S', '')}` : '' };
    });
    const requiredSemesterIdSet = new Set(requiredSemesterList.map(s => s.id));
    
    const nilaiRaporSheet = getNilaiRaporSheet(ss);
    const raporDataValues = nilaiRaporSheet.getDataRange().getValues();
    raporDataValues.shift();
    const raporMap = new Map();
    raporDataValues.forEach(row => {
      if (requiredSemesterIdSet.has(row[2]) && requiredMapelIds.has(row[1])) {
        if (!raporMap.has(row[0])) raporMap.set(row[0], new Map());
        if (!raporMap.get(row[0]).has(row[1])) raporMap.get(row[0]).set(row[1], new Map());
        raporMap.get(row[0]).get(row[1]).set(row[2], { P: (row[3] != null && row[3] !== ""), K: (row[4] != null && row[4] !== "") });
      }
    });
    
    const nilaiUjianSheet = getNilaiUjianSheet(ss);
    const ujianDataValues = nilaiUjianSheet.getDataRange().getValues();
    ujianDataValues.shift();
    const ujianMap = new Map();
    ujianDataValues.forEach(row => {
      if (requiredMapelIds.has(row[1])) {
        if (!ujianMap.has(row[0])) ujianMap.set(row[0], new Map());
        ujianMap.get(row[0]).set(row[1], { UM: (row[2] != null && row[2] !== ""), UP: (row[3] != null && row[3] !== "") });
      }
    });
    
    const validationResults = {};
    let globalNeedsUM = false, globalNeedsUP = false;
    mapelInfoMap.forEach(info => { if (info.isUS) globalNeedsUM = true; if (info.isUP) globalNeedsUP = true; });
    
    siswaList.forEach(siswa => {
      const resultSiswa = { rapor: {}, ujian: {} };
      if (globalNeedsUM) resultSiswa.ujian.UM = true;
      if (globalNeedsUP) resultSiswa.ujian.UP = true;
      requiredSemesterList.forEach(sem => { resultSiswa.rapor[`${sem.id}_P`] = true; resultSiswa.rapor[`${sem.id}_K`] = true; });
      for (const mapel of requiredMapelList) {
        const mapelInfo = mapelInfoMap.get(mapel.id);
        for (const sem of requiredSemesterList) {
          const rData = raporMap.get(siswa.id)?.get(mapel.id)?.get(sem.id) || { P: false, K: false };
          if (resultSiswa.rapor[`${sem.id}_P`] && !rData.P) resultSiswa.rapor[`${sem.id}_P`] = false;
          if (resultSiswa.rapor[`${sem.id}_K`] && !rData.K) resultSiswa.rapor[`${sem.id}_K`] = false;
        }
        const uData = ujianMap.get(siswa.id)?.get(mapel.id) || { UM: false, UP: false };
        if (globalNeedsUM && mapelInfo.isUS && !uData.UM) resultSiswa.ujian.UM = false;
        if (globalNeedsUP && mapelInfo.isUP && !uData.UP) resultSiswa.ujian.UP = false;
      }
      if (!globalNeedsUM) delete resultSiswa.ujian.UM;
      if (!globalNeedsUP) delete resultSiswa.ujian.UP;
      validationResults[siswa.id] = resultSiswa;
    });
    return { status: "sukses", data: { siswaList: siswaList.map(s => ({ id: s.id, nama: s.nama, nisn: s.nisn, kelas: s.kelas })), requiredSemesters: semesterListWithCodes, validationData: validationResults } };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

/**
 * [BARU - DIAKTIFKAN v2] Mengambil data validasi yang diagregasi per mapel.
 * Menghitung jumlah siswa yang lengkap per komponen nilai.
 */
function getValidationDataByMapel(token) {
  try {
    // 1. Validasi sesi dan dapatkan data
    const { sessionData, spreadsheetID } = validateAdminSession(token);
    const ss = SpreadsheetApp.openById(spreadsheetID);

    // 2. Ambil semua data sumber (Siswa, Mapel, Semester)
    const siswaList = _getSiswaInternal(spreadsheetID, sessionData.sekolahID); // (id, nama, nisn, kelas)
    const totalSiswaCount = siswaList.length;
    
    const mapelListFull = _getMapelInternal(ss, sessionData.sekolahID);
    const requiredMapelList = mapelListFull.filter(m => m.isUS === true || m.isUP === true);
    const mapelInfoMap = new Map(requiredMapelList.map(m => [m.id, { isUS: m.isUS, isUP: m.isUP }]));

    const semesterListData = getSemesterList(token);
    if (semesterListData.status !== 'sukses') throw new Error("Gagal mengambil daftar semester.");
    const requiredSemesterList = semesterListData.semesterList;
    const requiredSemesterIdSet = new Set(requiredSemesterList.map(s => s.id));

    // 3. Buat Peta Nilai yang Sudah Terisi (Sama seperti di 'per Siswa')
    const nilaiRaporSheet = getNilaiRaporSheet(ss);
    const raporDataValues = nilaiRaporSheet.getDataRange().getValues();
    raporDataValues.shift();
    const raporMap = new Map(); // Map<siswaId, Map<mapelId, Map<semId, {P, K}>>>
    raporDataValues.forEach(row => {
      if (requiredSemesterIdSet.has(row[2]) && mapelInfoMap.has(row[1])) {
        if (!raporMap.has(row[0])) raporMap.set(row[0], new Map());
        if (!raporMap.get(row[0]).has(row[1])) raporMap.get(row[0]).set(row[1], new Map());
        raporMap.get(row[0]).get(row[1]).set(row[2], { P: (row[3] != null && row[3] !== ""), K: (row[4] != null && row[4] !== "") });
      }
    });
    
    const nilaiUjianSheet = getNilaiUjianSheet(ss);
    const ujianDataValues = nilaiUjianSheet.getDataRange().getValues();
    ujianDataValues.shift();
    const ujianMap = new Map(); // Map<siswaId, Map<mapelId, {UM, UP}>>
    ujianDataValues.forEach(row => {
      if (mapelInfoMap.has(row[1])) {
        if (!ujianMap.has(row[0])) ujianMap.set(row[0], new Map());
        ujianMap.get(row[0]).set(row[1], { UM: (row[2] != null && row[2] !== ""), UP: (row[3] != null && row[3] !== "") });
      }
    });

    // 4. Bangun Peta Agregasi Validasi (Mapel -> Hitungan)
    const validationAggregates = {}; // Ini adalah objek besar: { mapelId: { totalSiswa: X, us: Y, up: Z, ... } }

    requiredMapelList.forEach(mapel => {
      const mapelInfo = mapelInfoMap.get(mapel.id);
      
      // Inisialisasi hitungan
      let agg = {
        totalSiswa: totalSiswaCount,
        ujian: {},
        rapor: {}
      };
      // Inisialisasi hitungan ujian
      if (mapelInfo.isUS) agg.ujian.UM = 0;
      if (mapelInfo.isUP) agg.ujian.UP = 0;
      // Inisialisasi hitungan rapor
      requiredSemesterList.forEach(sem => {
        agg.rapor[sem.id + "_P"] = 0;
        agg.rapor[sem.id + "_K"] = 0;
      });

      // Loop per siswa untuk menghitung
      siswaList.forEach(siswa => {
        // Cek Ujian
        const uData = ujianMap.get(siswa.id)?.get(mapel.id) || { UM: false, UP: false };
        if (mapelInfo.isUS && uData.UM) agg.ujian.UM++;
        if (mapelInfo.isUP && uData.UP) agg.ujian.UP++;

        // Cek Rapor
        requiredSemesterList.forEach(sem => {
          const semId = sem.id;
          const rData = raporMap.get(siswa.id)?.get(mapel.id)?.get(semId) || { P: false, K: false };
          if (rData.P) agg.rapor[semId + "_P"]++;
          if (rData.K) agg.rapor[semId + "_K"]++;
        });
      });
      
      validationAggregates[mapel.id] = agg;
    });

    // 5. Kembalikan semua data yang dibutuhkan klien
    return { 
      status: "sukses", 
      data: { 
        mapelList: requiredMapelList, 
        siswaList: siswaList, // Kirim daftar siswa (untuk totalSiswa)
        requiredSemesters: requiredSemesterList.map(sem => { // Kirim juga shortCode
            const parts = sem.id.split('_');
            return { ...sem, shortCode: (parts.length === 2) ? `${parts[0].replace('K', '')}.${parts[1].replace('S', '')}` : '' };
        }),
        validationData: validationAggregates // Data validasi yang sudah diagregasi
      } 
    };

  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

/**
 * FUNGSI UNTUK DIJALANKAN MANUAL SEKALI SAJA
 * * CARA MENJALANKAN:
 * 1. Buka file Kode.gs.html Anda.
 * 2. Salin dan tempel (paste) fungsi ini di bagian paling bawah file.
 * 3. UBAH 'email_superadmin@anda.com', 'Nama Super Admin', dan 'password_rahasia_anda'.
 * 4. Simpan file (Ctrl+S atau ikon Simpan).
 * 5. Di bagian atas editor, pilih nama fungsi "BUAT_SUPERADMIN_PERTAMA_KALI" dari menu dropdown (di sebelah "Debug" dan "Run").
 * 6. Klik tombol "Run" ().
 * 7. Periksa log (View > Logs) untuk pesan "BERHASIL!".
 * 8. Hapus atau beri komentar (//) pada fungsi ini setelah selesai.
 */
/*
function BUAT_SUPERADMIN_PERTAMA_KALI() {
  try {
    // --- SESUAIKAN DATA DI BAWAH INI ---
    const EMAIL_SUPERADMIN = "syamsulbahri.agro27b@gmail.com";
    const NAMA_SUPERADMIN = "Syamsul Bahri";
    const PASSWORD_SUPERADMIN = "Andhika9619!"; // Ganti dengan password yang kuat
    // --- BATAS PENYESUAIAN ---

    if (PASSWORD_SUPERADMIN === "password_rahasia_anda" || EMAIL_SUPERADMIN === "superadmin@email.com") {
      Logger.log("PENTING: Harap ubah email dan password di dalam kode fungsi sebelum menjalankan.");
      Browser.msgBox("PENTING: Harap ubah email dan password di dalam kode fungsi sebelum menjalankan.");
      return;
    }

    const masterSS = SpreadsheetApp.openById(MASTER_SHEET_ID);
    const sheet = getSheetSuperadmin(masterSS); // Fungsi ini akan membuat sheet jika belum ada

    // Cek apakah email sudah ada
    const data = sheet.getDataRange().getValues();
    for (let i = 1; i < data.length; i++) {
      if (data[i][0] === EMAIL_SUPERADMIN) {
        Logger.log("Akun Superadmin dengan email " + EMAIL_SUPERADMIN + " sudah ada.");
        Browser.msgBox("Akun Superadmin dengan email " + EMAIL_SUPERADMIN + " sudah ada.");
        return;
      }
    }

    // Buat hash dan salt baru (memanggil fungsi yang sudah ada di script Anda)
    const newSalt = generateSalt();
    const newHash = hashPassword(PASSWORD_SUPERADMIN, newSalt);

    // Tambahkan ke sheet
    sheet.appendRow([EMAIL_SUPERADMIN, NAMA_SUPERADMIN, newHash, newSalt]);

    Logger.log("BERHASIL! Akun Superadmin " + EMAIL_SUPERADMIN + " telah dibuat.");
    Browser.msgBox("BERHASIL! Akun Superadmin " + EMAIL_SUPERADMIN + " telah dibuat. Anda sekarang dapat login.");

  } catch (e) {
    Logger.log("Gagal membuat Superadmin: " + e.message);
    Browser.msgBox("Gagal membuat Superadmin: " + e.message);
  }
}
*/

function validateAdminOrGuruSession(token) {
  // 1. Panggil fungsi validasi inti
  const sessionData = validateAndRefreshSession(token);
  
  // 2. Cek Role
  if (sessionData.role !== 'admin' && sessionData.role !== 'guru') {
    throw new Error("Akses ditolak. API ini hanya untuk Admin atau Guru.");
  }
  
  // 3. Cek ID yang sudah ada di sesi
  if (!sessionData.spreadsheetID) {
    throw new Error("Sesi tidak valid (Spreadsheet ID tidak ditemukan).");
  }
  
  // 4. Kembalikan data yang diperlukan
  return { sessionData, spreadsheetID: sessionData.spreadsheetID };
}

function validateAdminSession(token) {
  // 1. Panggil fungsi validasi inti
  const sessionData = validateAndRefreshSession(token);
  
  // 2. Cek Role
  if (sessionData.role !== 'admin') {
    throw new Error("Akses ditolak. API ini hanya untuk Admin Sekolah.");
  }
  
  // 3. Cek ID yang sudah ada di sesi
  if (!sessionData.spreadsheetID) {
    throw new Error("Sesi Admin tidak valid (Spreadsheet ID tidak ditemukan).");
  }
  if (!sessionData.app2DbId) {
    // Ini seharusnya sudah diperbaiki oleh validateAndRefreshSession,
    // tapi sebagai failsafe, kita cek lagi.
    throw new Error("Sesi Admin tidak valid (App 2 DB ID tidak ditemukan).");
  }

  // 4. Kembalikan data yang diperlukan
  return { 
    sessionData: sessionData, 
    spreadsheetID: sessionData.spreadsheetID,
    app2DbId: sessionData.app2DbId,
    sekolahID: sessionData.sekolahID
  };
}

// Salin dan GANTI fungsi _internalPublishLogic() Anda dengan yang ini
/**
 * FUNGSI HELPER BARU
 * Berisi logika inti untuk mempublikasikan hasil.
 * VERSI REFACTOR 2.3: Menerima data yang sudah dihitung sebagai parameter
 * untuk menghindari pembacaan ganda.
 */
function _internalPublishLogic(
    spreadsheetID, sekolahID, namaSekolah, tanggalPengumumanISO,
    siswaMap, nisnList, rekapMap, kkm // <-- PARAMETER BARU DARI PERBAIKAN 2.3
) {
  // --- PERBAIKAN BLOK GATING ---
  // Cek status donasi.
  const masterSS = SpreadsheetApp.openById(MASTER_SHEET_ID);
  const sheetSekolah = masterSS.getSheetByName('Sheet_Sekolah');
  const dataSekolah = sheetSekolah.getDataRange().getValues();
  let donasiStatus = "NONE";
  for (let i = 1; i < dataSekolah.length; i++) {
    if (dataSekolah[i][0] === sekolahID) {
      donasiStatus = dataSekolah[i][8] || "NONE";
      break;
    }
  }
  
  // JIKA DONASI TIDAK AKTIF:
  if (donasiStatus !== "APPROVED") {
    // Jangan lempar error, cukup hentikan fungsi secara diam-diam.
    Logger.log(`_internalPublishLogic dihentikan untuk ${sekolahID} (Donasi: ${donasiStatus}). Kalkulasi nilai tetap berhasil.`);
    return;
  }
  // --- AKHIR PERBAIKAN BLOK ---

  // --- PERUBAHAN KRUSIAL 2.3: HAPUS BLOK PEMBACAAN DATA ---
  // const ss = SpreadsheetApp.openById(spreadsheetID);
  // const siswaListFull = _getSiswaInternal(spreadsheetID, sekolahID);
  // ... (logika membuat siswaMap & nisnList) ...
  // const sheetCacheIjazah = ss.getSheetByName(SHEET_CACHE_IJAZAH);
  // ... (logika membaca kkm dan ijazahData) ...
  // ... (logika membuat rekapMap) ...
  // --- BLOK DI ATAS SEPENUHNYA DIHAPUS ---
  // --- AKHIR PERUBAHAN 2.3 ---


  // 3. Tentukan status kelulusan
  // Logika ini sekarang menggunakan data dari PARAMETER (siswaMap, rekapMap, kkm)
  const hasilKelulusan = {};
  siswaMap.forEach((data, nisn) => {
    const rekap = rekapMap.get(data.id);
    let status = 'TIDAK LULUS'; // Default
    if (rekap && rekap.count > 0) {
      const average = rekap.sum / rekap.count;
      if (average >= kkm) { // <-- kkm dari parameter
        status = 'LULUS';
      }
    }
    hasilKelulusan[nisn] = {
      dob: data.dob,
      status: status,
      nama: data.nama
    };
  });
  
  const hasilKelulusanJson = JSON.stringify(hasilKelulusan);
  
  // 4. Tulis/Timpa ke Database Master Kelulusan
  const db = SpreadsheetApp.openById(MASTER_KELULUSAN_DB_ID);
  const sheetHasil = db.getSheetByName('Sheet_Hasil_Publikasi');
  const hasilData = sheetHasil.getDataRange().getValues();
  let rowUpdated = false;
  for (let i = 1; i < hasilData.length; i++) {
    if (hasilData[i][0] === sekolahID) {
      // Timpa data yang ada
      sheetHasil.getRange(i + 1, 2, 1, 3).setValues([[tanggalPengumumanISO, hasilKelulusanJson, namaSekolah]]);
      rowUpdated = true;
      break;
    }
  }
  if (!rowUpdated) {
    // Tambah data baru jika belum ada
    sheetHasil.appendRow([sekolahID, tanggalPengumumanISO, hasilKelulusanJson, namaSekolah]);
  }
  
  // 5. Update Master Index (Hapus lama, tambah baru)
  const sheetIndex = db.getSheetByName('Sheet_Master_Index');
  const indexData = sheetIndex.getDataRange().getDisplayValues(); 
  const rowsToDelete = [];
  for (let i = indexData.length - 1; i >= 1; i--) { 
    if (indexData[i][1] === sekolahID) {
      rowsToDelete.push(i + 1);
    }
  }
  rowsToDelete.forEach(rowNum => {
    sheetIndex.deleteRow(rowNum);
  });
  
  // Gunakan nisnList dari PARAMETER
  const nisnRowsToAdd = nisnList.map(nisn => ["'" + nisn, sekolahID]); 
  if (nisnRowsToAdd.length > 0) {
    sheetIndex.getRange(sheetIndex.getLastRow() + 1, 1, nisnRowsToAdd.length, 2).setValues(nisnRowsToAdd);
  }
  
  // 6. Bersihkan Cache Publik
  const scriptCache = CacheService.getScriptCache();
  scriptCache.remove(MASTER_NISN_INDEX_KEY);
  scriptCache.remove(HASIL_KELULUSAN_PREFIX + sekolahID);
  
  // Bangun ulang cache publik agar data baru segera tersedia
  rebuildKelulusanCacheFromDB(); 

  // Kembalikan jumlah siswa untuk pesan sukses (gunakan nisnList dari PARAMETER)
  return nisnList.length;
}

function publishKelulusan(token, tanggalPengumumanISO) {
  const lock = LockService.getScriptLock();
  lock.waitLock(30000);
  try {
    const session = validateAdminSession(token);
    const nisnListLength = _internalPublishLogic(session.spreadsheetID, session.sessionData.sekolahID, session.sessionData.namaSekolah, tanggalPengumumanISO);
    return { status: "sukses", message: `Hasil kelulusan dipublikasikan untuk ${nisnListLength} siswa.` };
  } catch (e) {
    return { status: "gagal", message: e.message };
  } finally {
    lock.releaseLock();
  }
}

function getPublishedStatus(token) {
  try {
    const { sessionData } = validateAdminSession(token);
    const scriptCache = CacheService.getScriptCache();
    const dataWrapperJson = scriptCache.get(HASIL_KELULUSAN_PREFIX + sessionData.sekolahID);
    if (dataWrapperJson) {
      return { status: "sukses", isPublished: true, publishDate: JSON.parse(dataWrapperJson).tanggalPengumuman };
    } else {
      return { status: "sukses", isPublished: false };
    }
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function unpublishKelulusan(token) {
  const lock = LockService.getScriptLock();
  lock.waitLock(30000);
  try {
    const { sessionData } = validateAdminSession(token);
    const sekolahID = sessionData.sekolahID;
    const db = SpreadsheetApp.openById(MASTER_KELULUSAN_DB_ID);
    const sheetHasil = db.getSheetByName('Sheet_Hasil_Publikasi');
    const hasilData = sheetHasil.getDataRange().getValues();
    for (let i = hasilData.length - 1; i >= 1; i--) {
      if (hasilData[i][0] === sekolahID) {
        sheetHasil.deleteRow(i + 1);
        break;
      }
    }
    const sheetIndex = db.getSheetByName('Sheet_Master_Index');
    const indexData = sheetIndex.getDataRange().getDisplayValues();
    const rowsToDelete = [];
    let nisnRemovedCount = 0;
    for (let i = indexData.length - 1; i >= 1; i--) {
      if (indexData[i][1] === sekolahID) {
        rowsToDelete.push(i + 1);
        nisnRemovedCount++;
      }
    }
    rowsToDelete.forEach(rowNum => sheetIndex.deleteRow(rowNum));
    const scriptCache = CacheService.getScriptCache();
    scriptCache.remove(MASTER_NISN_INDEX_KEY);
    scriptCache.remove(HASIL_KELULUSAN_PREFIX + sekolahID);
    return { status: "sukses", message: `Publikasi ditarik (${nisnRemovedCount} NISN dihapus).` };
  } catch (e) {
    return { status: "gagal", message: e.message };
  } finally {
    lock.releaseLock();
  }
}

function cekStatusSiswa(nisn, tglLahir) {
  try {
    if (!nisn || !tglLahir) {
      return { status: 'error', message: 'NISN dan Tanggal Lahir harus diisi.' };
    }
    
    const scriptCache = CacheService.getScriptCache();
    let allHasilWrappers = null;
    let masterIndex;
    
    const masterIndexJson = scriptCache.get(MASTER_NISN_INDEX_KEY);
    
    if (!masterIndexJson) {
      Logger.log("CACHE MISS: Master Index. Membangun ulang dari DB...");
      const rebuiltData = rebuildKelulusanCacheFromDB();
      masterIndex = rebuiltData.masterIndex;
      allHasilWrappers = rebuiltData.allHasilWrappers;
    } else {
      masterIndex = JSON.parse(masterIndexJson);
    }
    
    const nisnTrimmed = String(nisn).trim();
    const sekolahID = masterIndex[nisnTrimmed];
    
    if (!sekolahID) {
      return { status: 'error', message: 'NISN tidak terdaftar.' };
    }
    
    let dataWrapper;
    if (allHasilWrappers) {
      dataWrapper = allHasilWrappers[sekolahID];
    } else {
      const dataWrapperJson = scriptCache.get(HASIL_KELULUSAN_PREFIX + sekolahID);
      if (!dataWrapperJson) {
        Logger.log(`CACHE MISS: Hasil Sekolah ${sekolahID}. Membangun ulang dari DB...`);
        const rebuiltData = rebuildKelulusanCacheFromDB();
        dataWrapper = rebuiltData.allHasilWrappers[sekolahID];
      } else {
        dataWrapper = JSON.parse(dataWrapperJson);
      }
    }
    
    if (!dataWrapper) {
      return { status: 'error', message: 'Hasil kelulusan untuk sekolah ini belum dipublikasikan oleh Admin.' };
    }

    // --- TAMBAHKAN BLOK GATING INI ---
    if (dataWrapper.donasiStatus !== "APPROVED") {
      return { status: 'error', message: 'Fitur Cek Kelulusan belum diaktifkan oleh sekolah ini.' };
    }
    // --- AKHIR BLOK ---
    
    const dataSiswa = dataWrapper.hasil[nisnTrimmed];
    
    if (!dataSiswa) {
      return { status: 'error', message: 'NISN tidak terdaftar di sekolah ini.' };
    }
    
    if (dataSiswa.dob !== tglLahir) {
      return { status: 'error', message: 'NISN dan Tanggal Lahir tidak cocok.' };
    }
    
    const tanggalPengumuman = new Date(dataWrapper.tanggalPengumuman);
    const sekarang = new Date();
    
    const responsePayload = {
      namaSekolah: dataWrapper.namaSekolah,
      namaSiswa: dataSiswa.nama
    };
    
    if (sekarang < tanggalPengumuman) {
      return { 
        ...responsePayload,
        status: 'countdown', 
        targetDate: dataWrapper.tanggalPengumuman 
      };
    } else {
      return { 
        ...responsePayload,
        status: 'hasil', 
        result: dataSiswa.status 
      };
    }
    
  } catch (e) {
    Logger.log("Gagal cekStatusSiswa: " + e.message);
    return { status: 'error', message: 'Terjadi kesalahan server: ' + e.message };
  }
}

function rebuildKelulusanCacheFromDB() {
  Logger.log("Memulai Pembangunan Ulang Cache Kelulusan dari DB...");
  const scriptCache = CacheService.getScriptCache();
  let masterIndex = {};
  let allHasilWrappers = {};

  try {
    const db = SpreadsheetApp.openById(MASTER_KELULUSAN_DB_ID);

    // --- TAMBAHKAN BLOK INI ---
    // 1. Buat Peta Donasi
    const masterSS = SpreadsheetApp.openById(MASTER_SHEET_ID);
    const sheetSekolah = masterSS.getSheetByName('Sheet_Sekolah');
    const dataSekolah = sheetSekolah.getDataRange().getValues();
    const donasiStatusMap = new Map();
    for(let i=1; i < dataSekolah.length; i++) {
      donasiStatusMap.set(dataSekolah[i][0], dataSekolah[i][8] || "NONE"); // Kolom A -> Kolom I
    }
    // --- AKHIR BLOK ---
    
    const sheetIndex = db.getSheetByName('Sheet_Master_Index');
    const indexData = sheetIndex.getRange(2, 1, sheetIndex.getLastRow() - 1, 2).getDisplayValues(); 
    indexData.forEach(row => {
      masterIndex[row[0]] = row[1]; 
    });

    const sheetHasil = db.getSheetByName('Sheet_Hasil_Publikasi');
    const hasilData = sheetHasil.getRange(2, 1, sheetHasil.getLastRow() - 1, 4).getValues();
    
    hasilData.forEach(row => {
      const sekolahID = row[0];
      const tanggalISO = row[1];
      const hasilJson = row[2];
      const namaSekolah = row[3];
      
      try {
        const dataWrapper = {
          tanggalPengumuman: tanggalISO,
          namaSekolah: namaSekolah,
          donasiStatus: donasiStatusMap.get(sekolahID) || "NONE",
          hasil: JSON.parse(hasilJson)
        };
        allHasilWrappers[sekolahID] = dataWrapper;
        scriptCache.put(HASIL_KELULUSAN_PREFIX + sekolahID, JSON.stringify(dataWrapper), 21600);
      } catch (e) {
        Logger.log(`Gagal mem-parse JSON untuk ${sekolahID}: ${e.message}`);
      }
    });
    
    scriptCache.put(MASTER_NISN_INDEX_KEY, JSON.stringify(masterIndex), 21600);
    Logger.log(`Pembangunan Ulang Cache Selesai. ${indexData.length} NISN dan ${hasilData.length} sekolah dimuat.`);
    
  } catch (e) {
    Logger.log(`FATAL: Gagal membangun ulang cache: ${e.message}`);
  }
  
  return { masterIndex, allHasilWrappers };
}

/**
 * [MODIFIKASI BESAR UNTUK SSO]
 * Mengautentikasi guru ke database Aplikasi 2 menggunakan HASH & SALT.
 * dan MENCATAT One-Time Token (OTT) di spreadsheet Aplikasi 2.
 * [MODIFIKASI V2] Sekarang mengirim payload JSON {email, jenjangPilihan}.
 * [MODIFIKASI V3] Menggunakan Master Sheet 'Config' untuk URL dinamis.
 */
function prosesLoginGuru(npsn, email, password) {
  try {
    // 1. Validasi NPSN/Kode Sekolah dan AMBIL DATA BARIS
    const masterSS_App1 = SpreadsheetApp.openById(MASTER_SHEET_ID); 
    const sheetSekolah_App1 = masterSS_App1.getSheetByName('Sheet_Sekolah');
    
    const dataSekolahApp1 = sheetSekolah_App1.getRange("A2:H" + sheetSekolah_App1.getLastRow()).getValues();
    
    let rowDataSekolah = null;
    const npsnLower = npsn.toLowerCase();

    for (const row of dataSekolahApp1) {
      const npsnDb = String(row[7]).toLowerCase(); // Kolom H
      const namaDb = String(row[1]).toLowerCase(); // Kolom B
      
      if (npsnDb === npsnLower || namaDb === npsnLower) {
        rowDataSekolah = row;
        break;
      }
    }

    if (!rowDataSekolah) {
      return { status: "gagal", message: "NPSN/Kode Sekolah tidak ditemukan di Aplikasi 1." };
    }

    const idSekolahApp1 = rowDataSekolah[0]; // Kolom A
    const app1DbId = rowDataSekolah[5];      // Kolom F (App 1 DB ID)
    
    if (!app1DbId) {
      return { status: "gagal", message: `Database App 1 (Kolom F) untuk sekolah ${idSekolahApp1} belum diatur.` };
    }
    const jenjangPilihan = getJenjangPilihanFromSheet(app1DbId);
    if (!jenjangPilihan) {
      return { status: "gagal", message: `Jenjang Pilihan (Data_Sekolah!A2) di database sekolah ${idSekolahApp1} belum diatur.` };
    }


    // 2. Buka database Aplikasi 2 (Pusat Guru)
    const ss_app2 = SpreadsheetApp.openById(ID_SPREADSHEET_APLIKASI_2);
    const sheetGuru_app2 = ss_app2.getSheetByName('db_guru');
    if (!sheetGuru_app2) throw new Error("Database Guru (db_guru) di Aplikasi 2 tidak ditemukan.");
    
    const dataGuru_app2 = sheetGuru_app2.getDataRange().getValues();
    
    // 3. Cari guru di Aplikasi 2
    const userEmailLower = email.toLowerCase();
    let foundGuruData = null;
    
    for (let i = 1; i < dataGuru_app2.length; i++) {
      const row = dataGuru_app2[i];
      if (row[0].toLowerCase() === userEmailLower) {
        const storedHash = row[1]; // Kolom B (HashedPassword)
        const storedSalt = row[5]; // Kolom F (Salt)
        
        if (verifyPassword(password, storedHash, storedSalt)) {
          if (row[3] == idSekolahApp1) { 
            foundGuruData = {
              email: row[0],
              nama: row[2],
              id_sekolah: row[3],
              role: row[4] || 'guru'
            };
            break;
          } else {
              return { status: "gagal", message: "Login berhasil, tetapi guru ini tidak terdaftar di sekolah (NPSN) ini." };
          }
        }
      }
    }

    if (!foundGuruData) {
      return { status: "gagal", message: "Email atau password guru salah." };
    }

    // 4. Buat One-Time Token (OTT)
    const ott = 'ott-' + Utilities.getUuid();
    
    const payload = {
      email: foundGuruData.email,
      jenjangPilihan: jenjangPilihan 
    };
    const payloadString = JSON.stringify(payload);
    
    const timestamp = new Date();
    
    const ottSheet = ss_app2.getSheetByName('db_ott_cache');
    if (!ottSheet) {
      throw new Error("Sheet 'db_ott_cache' tidak ditemukan di Aplikasi 2.");
    }
    
    // 5. Simpan OTT ke SPREADSHEET Aplikasi 2
    const lock = LockService.getScriptLock();
    lock.waitLock(10000); 
    try {
      ottSheet.appendRow([ott, payloadString, timestamp]); // [MODIFIKASI] Simpan string JSON
      
      const data = ottSheet.getDataRange().getValues();
      const now = timestamp.getTime();
      const expiryLimit = 5 * 60 * 1000; // 5 menit
      const rowsToDelete = [];
      
      for (let i = data.length - 1; i >= 1; i--) { 
        if (data[i][2] instanceof Date && (now - data[i][2].getTime() > expiryLimit)) {
          rowsToDelete.push(i + 1);
        }
      }
      rowsToDelete.forEach(rowNum => ottSheet.deleteRow(rowNum));
      
    } catch(e) {
      throw e;
    } finally {
      lock.releaseLock();
    }
    
    // 6. Baca URL Aplikasi 2 secara dinamis dari Master Sheet 'Config'
    // (masterSS_App1 sudah dibuka di atas)
    const configSheet = masterSS_App1.getSheetByName('Config');
    if (!configSheet) {
      throw new Error("Sheet 'Config' tidak ditemukan di Master Sheet. Harap buat sheet 'Config' dan isi sel B1 dengan URL /exec Aplikasi 2.");
    }
    const URL_APLIKASI_2_DINAMIS = configSheet.getRange('B1').getValue();
    
    if (!URL_APLIKASI_2_DINAMIS || !URL_APLIKASI_2_DINAMIS.endsWith('/exec')) {
      // Jika admin lupa menjalankan 'simpanURLDeployBaru' atau salah isi
      return { status: "gagal", message: "Error: URL Aplikasi 2 (Nilai) belum diatur oleh Admin. Hubungi Admin." };
    }
    
    // 7. Buat URL Redirect (DINAMIS)
    const redirectUrl = URL_APLIKASI_2_DINAMIS + (URL_APLIKASI_2_DINAMIS.includes('?') ? '&' : '?') + 'ott=' + ott;
    
    return {
      status: "sso_redirect",
      redirectUrl: redirectUrl
    };

  } catch (e) {
    Logger.log(`Error prosesLoginGuru (SSO): ${e.message}`);
    return { status: "gagal", message: "Terjadi error server: " + e.message };
  }
}

function getGuruSheet(ss) {
  let sheet = ss.getSheetByName('Akun_Guru');
  if (!sheet) {
    sheet = ss.insertSheet('Akun_Guru');
    // [MODIFIKASI] Tambahkan NIP di header (Kolom C)
    sheet.appendRow(['Email', 'Nama', 'NIP', 'HashedPassword', 'Salt', 'MapelKelasJSON']);
    // --- AKHIR MODIFIKASI ---
    sheet.setFrozenRows(1);
  } else {
    // --- TAMBAHKAN BLOK MIGRASI INI ---
    const headerNIP = sheet.getRange(1, 3).getValue();
    if (headerNIP !== "NIP") {
      sheet.insertColumnAfter(2); // Sisipkan kolom baru setelah Nama (Kolom B)
      sheet.getRange(1, 3).setValue("NIP"); // Beri nama header
    }
    // --- AKHIR BLOK MIGRASI ---

    // --- MODIFIKASI: Pindahkan pengecekan MapelKelasJSON ke Kolom F (index 6) ---
    const header = sheet.getRange(1, 6).getValue();
    if (header === "MapelIDs") {
      sheet.getRange(1, 6).setValue("MapelKelasJSON");
    }
    // --- AKHIR MODIFIKASI ---
  }

  // --- TAMBAHAN PERBAIKAN (INTI MASALAH) ---
  // Selalu pastikan Kolom C (NIP) diformat sebagai Teks.
  try {
    sheet.getRange('C:C').setNumberFormat('@');
  } catch (e) {
    Logger.log(`Gagal mengatur format Teks untuk kolom NIP: ${e.message}`);
  }
  // --- AKHIR TAMBAHAN PERBAIKAN ---

  return sheet;
}

function getGuru(token) {
  try {
    const { spreadsheetID } = validateAdminSession(token);
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getGuruSheet(ss);
    const data = sheet.getDataRange().getValues();
    data.shift(); // Hapus header

    const guruList = data.map(row => {
      const email = row[0];
      const nama = row[1];
      const nip = row[2] || ''; // <-- TAMBAHKAN BARIS INI (Kolom C, index 2)
      const dataMapel = row[5]; // <-- UBAH KE INDEX 5 (Kolom F)
      let mapelKelasData = {};

      if (dataMapel) {
        try {
          // Coba parse sebagai JSON (Format baru)
          mapelKelasData = JSON.parse(dataMapel);
        } catch (e) {
          // Gagal parse? Ini pasti format lama (string "MTK,IPA")
          mapelKelasData = {};
          const mapelArray = String(dataMapel).split(',').map(s => s.trim());
          mapelArray.forEach(mapelId => {
            if (mapelId) {
              mapelKelasData[mapelId] = ["*"]; // "*" berarti "Semua Kelas"
            }
          });
        }
      }

      return {
        email: email,
        nama: nama,
        nip: nip, // <-- TAMBAHKAN BARIS INI
        mapelKelas: mapelKelasData // Kirim sebagai objek JSON
      };
    }).filter(g => g.email); // Hanya ambil yang emailnya ada

    return { status: "sukses", guru: guruList };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function saveGuru(token, guruData) {
  const lock = LockService.getDocumentLock();
  lock.waitLock(15000);
  try {
    const { sessionData, spreadsheetID } = validateAdminSession(token);
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getGuruSheet(ss);
    const data = sheet.getDataRange().getValues();

    const mapelKelasJSON = JSON.stringify(guruData.mapelKelas); 
    const nip = guruData.nip || "";
    const formattedNip = (nip !== "") ? "'" + nip : ""; 

    let rowIndex = -1;
    if (guruData.mode === 'edit') {
       for (let i = 1; i < data.length; i++) {
         if (data[i][0] === guruData.originalEmail) {
           rowIndex = i + 1;
           break;
         }
       }
       if (rowIndex === -1) return { status: "gagal", message: "Guru tidak ditemukan untuk diedit." };
    } else {
       for (let i = 1; i < data.length; i++) {
         if (data[i][0] === guruData.email) return { status: "gagal", message: "Email guru sudah terdaftar (di sheet lokal)." };
       }
    }
    
    const newGuruData = {
      email: guruData.email,
      nama: guruData.nama,
      nip: nip, 
      mapelKelas: guruData.mapelKelas
    };

    if (guruData.mode === 'add') {
      if (!guruData.password) return { status: "gagal", message: "Password wajib untuk guru baru." };
      
      // --- [MODIFIKASI] Buat hash dan salt untuk data LOKAL ---
      const newSalt = generateSalt();
      const newHash = hashPassword(guruData.password, newSalt);
      // Simpan HASH dan SALT (bukan plain text)
      sheet.appendRow([guruData.email, guruData.nama, formattedNip, newHash, newSalt, mapelKelasJSON]);
      // --- [AKHIR MODIFIKASI] ---
      
      addOrUpdateGuruInApp2(guruData.email, guruData.password, guruData.nama, sessionData.sekolahID, 'guru', nip);
      
    } else {
      // Mode Edit
      const originalEmail = guruData.originalEmail;
      const newEmail = guruData.email;
      
      // Simpan Nama, NIP, Mapel
      sheet.getRange(rowIndex, 1).setValue(newEmail);
      sheet.getRange(rowIndex, 2).setValue(guruData.nama);
      sheet.getRange(rowIndex, 3).setValue(formattedNip); 
      sheet.getRange(rowIndex, 6).setValue(mapelKelasJSON);
      
      let passwordToSync = null; // Default: Jangan sinkronisasi password

      if (guruData.password) {
        // --- [MODIFIKASI] User memasukkan password BARU ---
        const newSalt = generateSalt();
        const newHash = hashPassword(guruData.password, newSalt);
        sheet.getRange(rowIndex, 4).setValue(newHash); // Kolom D (Hash)
        sheet.getRange(rowIndex, 5).setValue(newSalt); // Kolom E (Salt)
        passwordToSync = guruData.password; // Kirim plain text ke App 2 untuk di-hash di sana
        // --- [AKHIR MODIFIKASI] ---
      } else {
        // --- [MODIFIKASI] User TIDAK memasukkan password baru ---
        // Cek apakah data lama (di sheet) perlu dimigrasi (jika salt kosong)
        const oldSalt = data[rowIndex-1][4]; // Kolom E (index 4)
        if (!oldSalt) {
          // INI DATA LAMA (PLAIN TEXT)! Lakukan migrasi
          const oldPlainTextPass = data[rowIndex-1][3]; // Kolom D (plain text lama)
          if (oldPlainTextPass) { // Pastikan tidak kosong
            const newSalt = generateSalt();
            const newHash = hashPassword(oldPlainTextPass, newSalt);
            sheet.getRange(rowIndex, 4).setValue(newHash); // Update Hash
            sheet.getRange(rowIndex, 5).setValue(newSalt); // Update Salt
            passwordToSync = oldPlainTextPass; // Kirim plain text ini ke App 2 agar sama
            Logger.log(`Migrasi runtime password untuk ${newEmail}`);
          }
        }
        // Jika oldSalt sudah ada, passwordToSync tetap null (tidak ada perubahan)
        // --- [AKHIR MODIFIKASI] ---
      }

      // Sinkronisasi ke App 2
      if (originalEmail.toLowerCase() !== newEmail.toLowerCase()) {
        deleteGuruFromApp2(originalEmail);
      }
      addOrUpdateGuruInApp2(newEmail, passwordToSync, guruData.nama, sessionData.sekolahID, 'guru', nip);
    }

    return { status: "sukses", message: "Data guru berhasil disimpan.", newData: newGuruData };

  } catch (e) {
    return { status: "gagal", message: e.message };
  } finally {
    lock.releaseLock();
  }
}

function deleteGuru(token, emailGuru) {
  const lock = LockService.getDocumentLock();
  lock.waitLock(15000);
  try {
    const { spreadsheetID } = validateAdminSession(token);
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getGuruSheet(ss);
    const data = sheet.getDataRange().getValues();
    
    for (let i = 1; i < data.length; i++) {
      if (data[i][0] === emailGuru) {
        // 1. Hapus dari sheet LOKAL
        sheet.deleteRow(i + 1);
        
        // --- [PERBAIKAN] Sinkronisasi hapus ke GLOBAL (App 2) ---
        deleteGuruFromApp2(emailGuru);
        // --- [AKHIR PERBAIKAN] ---
        
        return { status: "sukses", message: "Guru berhasil dihapus." };
      }
    }
    return { status: "gagal", message: "Guru tidak ditemukan." };
  } catch (e) {
    return { status: "gagal", message: e.message };
  } finally {
    lock.releaseLock();
  }
}

function getGuruTemplateData(token) {
  let tempSpreadsheetId = null;
  try {
    const { sessionData, spreadsheetID } = validateAdminSession(token);
    
    // [MODIFIKASI] Panggilan ke _getMapelInternal() dihapus.
    // const ss = SpreadsheetApp.openById(spreadsheetID);
    // const mapelList = _getMapelInternal(ss, sessionData.sekolahID);
    
    const namaSekolah = sessionData.namaSekolah;
    const timestamp = Utilities.formatDate(new Date(), Session.getScriptTimeZone(), "yyyyMMdd_HHmmss");
    const tempFileName = `[TEMP] Template Guru - ${namaSekolah} - ${timestamp}`;
    
    const tempSS = SpreadsheetApp.create(tempFileName);
    tempSpreadsheetId = tempSS.getId();
    
    const sheetTemplate = tempSS.getSheetByName('Sheet1');
    sheetTemplate.setName('Template Guru');
    
    // [MODIFIKASI] Sheet 'Daftar Mapel' tidak lagi dibuat.
    // const sheetMapel = tempSS.insertSheet('Daftar Mapel');
    // ... (blok sheetMapel dihapus) ...

    // [MODIFIKASI] Header dikurangi menjadi 4 kolom
    sheetTemplate.appendRow(['NamaGuru', 'NIP (Opsional)', 'Email', 'Password']);
    // [MODIFIKASI] Contoh data disesuaikan menjadi 4 kolom
    sheetTemplate.appendRow([
      'Budi Santoso, S.Pd.', 
      '198001012005011001', // Contoh NIP
      'budi.santoso@email.com', 
      'PasswordMin8Karakter'
    ]);
    sheetTemplate.getRange('A1:D1').setFontWeight('bold'); // <-- UBAH KE D1
    
    // [MODIFIKASI] Teks bantuan diperbarui
    const helpText = "Kolom A, C, dan D wajib diisi. Kolom B (NIP) opsional.";
    sheetTemplate.getRange('A3').setValue(helpText).setFontStyle('italic').setFontColor('#666');
    sheetTemplate.getRange('A3:D3').merge(); // <-- UBAH KE D3
    
    sheetTemplate.getRange('B:B').setNumberFormat('@'); // Format NIP sebagai Teks
    // [MODIFIKASI] Kolom E (Mapel) dihapus
    // sheetTemplate.getRange('E:E').setNumberFormat('@');
    sheetTemplate.autoResizeColumns(1, 4); // <-- UBAH KE 4
    
    SpreadsheetApp.flush(); 

    const url = "https://docs.google.com/spreadsheets/d/" + tempSpreadsheetId + "/export?format=xlsx";
    const oauthToken = ScriptApp.getOAuthToken();
    const response = UrlFetchApp.fetch(url, { headers: { 'Authorization': 'Bearer ' + oauthToken } });
    
    const fileNameOutput = `template_import_guru_${namaSekolah}.xlsx`;
    
    return { 
      status: "sukses", 
      base64: Utilities.base64Encode(response.getBlob().getBytes()), 
      mimeType: MimeType.MICROSOFT_EXCEL, 
      fileName: fileNameOutput 
    };
    
  } catch (e) {
    return { status: "gagal", message: "Gagal membuat template: " + e.message };
  } finally {
    if (tempSpreadsheetId) DriveApp.getFileById(tempSpreadsheetId).setTrashed(true);
  }
}

function prosesImportExcelGuru(token, fileData) {
  let tempExcelFileId = null;
  let tempConvertedSheetId = null;
  
  try {
    const { sessionData, spreadsheetID } = validateAdminSession(token);
    const ss = SpreadsheetApp.openById(spreadsheetID);
    
    const sheetGuru = getGuruSheet(ss);
    const dataGuru = sheetGuru.getDataRange().getValues();
    const existingEmailSet = new Set();
    for(let i=1; i < dataGuru.length; i++) {
      existingEmailSet.add(String(dataGuru[i][0]).trim().toLowerCase());
    }

    // [MODIFIKASI] Logika mapel dihapus
    // const mapelList = _getMapelInternal(ss, sessionData.sekolahID); 
    // const validMapelIdSet = new Set(mapelList.map(m => m.id));

    const { base64, mimeType, fileName } = fileData;
    const decodedData = Utilities.base64Decode(base64.split(',')[1]);
    const blob = Utilities.newBlob(decodedData, mimeType, fileName);
    
    const tempExcelFile = DriveApp.createFile(blob);
    tempExcelFileId = tempExcelFile.getId();
    const conversionResource = { title: `[TEMP] Import Guru - ${fileName}`, mimeType: MimeType.GOOGLE_SHEETS };
    const convertedFile = Drive.Files.copy(conversionResource, tempExcelFileId, { convert: true });
    tempConvertedSheetId = convertedFile.id;
    
    const tempSheet = SpreadsheetApp.openById(tempConvertedSheetId);
    const dataSheet = tempSheet.getSheetByName('Template Guru');
    if (!dataSheet) {
      throw new Error("File Excel tidak valid. Sheet 'Template Guru' tidak ditemukan.");
    }
    
    const excelData = dataSheet.getDataRange().getValues();
    if (excelData.length <= 1) {
      throw new Error("File Excel kosong atau hanya berisi header.");
    }
    
    excelData.shift(); 

    const gagalList = [];
    const rowsToAppend = [];
    const gurusToSync = []; 
    
    for (let i = 0; i < excelData.length; i++) {
      const row = excelData[i];
      const barisKe = i + 2;
      
      const nama = (row[0] ? String(row[0]) : '').trim();
      const nip = (row[1] ? String(row[1]) : '').trim(); 
      const email = (row[2] ? String(row[2]) : '').trim().toLowerCase(); 
      const password = (row[3] ? String(row[3]) : ''); 
      
      // [MODIFIKASI] Pembacaan 'mapelIdsStr' (row[4]) dihapus.
      // const mapelIdsStr = (row[4] ? String(row[4]) : '').trim(); 

      if (!nama || !email || !password) {
        gagalList.push({ baris: barisKe, nama: nama, email: email, alasan: "Nama, Email, atau Password kosong." });
        continue;
      }
      
      if (existingEmailSet.has(email)) {
        gagalList.push({ baris: barisKe, nama: nama, email: email, alasan: "Email sudah terdaftar." });
        continue;
      }

      if (password.length < 8) {
         gagalList.push({ baris: barisKe, nama: nama, email: email, alasan: "Password kurang dari 8 karakter." });
         continue;
      }

      // [MODIFIKASI] Validasi Mapel dihapus
      // const mapelIds = mapelIdsStr.split(',').map(id => id.trim()).filter(id => id);
      // ... (blok validasi mapel dihapus) ...
      
      // [MODIFIKASI] mapelKelasData sekarang selalu kosong
      const mapelKelasData = {};
      const mapelKelasJSON = JSON.stringify(mapelKelasData); // Ini akan menjadi '{}'

      // --- [MODIFIKASI DI SINI] ---
      // Buat Hash dan Salt untuk sheet LOKAL
      const newSalt = generateSalt();
      const newHash = hashPassword(password, newSalt);
      const formattedNip = (nip !== "") ? "'" + nip : ""; 
      
      // [MODIFIKASI] mapelKelasJSON sekarang '{}'
      rowsToAppend.push([email, nama, formattedNip, newHash, newSalt, mapelKelasJSON]);
      existingEmailSet.add(email);
      // --- [AKHIR MODIFIKASI] ---
      
      // Kumpulkan data untuk sinkronisasi global (tetap kirim plain text)
      gurusToSync.push({
        email: email,
        password: password,
        nama: nama,
        nip: nip, 
        sekolahID: sessionData.sekolahID,
        role: 'guru'
      });
    }

    if (rowsToAppend.length > 0) {
      // 1. Simpan ke sheet LOKAL
      sheetGuru.getRange(sheetGuru.getLastRow() + 1, 1, rowsToAppend.length, rowsToAppend[0].length)
        .setValues(rowsToAppend);
        
      // 2. Jalankan sinkronisasi global
      gurusToSync.forEach(guru => {
        addOrUpdateGuruInApp2(guru.email, guru.password, guru.nama, guru.sekolahID, guru.role, guru.nip);
      });
    }

    DriveApp.getFileById(tempExcelFileId).setTrashed(true);
    DriveApp.getFileById(tempConvertedSheetId).setTrashed(true);
    
    return {
      status: "sukses",
      totalDiProses: excelData.length,
      berhasilDiUpload: rowsToAppend.length,
      gagalDiUpload: gagalList.length,
      dataGagal: gagalList
    };
    
  } catch (e) {
    if (tempExcelFileId) { try { DriveApp.getFileById(tempExcelFileId).setTrashed(true); } catch (err) {} }
    if (tempConvertedSheetId) { try { DriveApp.getFileById(tempConvertedSheetId).setTrashed(true); } catch (err) {} }
    return { status: "gagal", message: "Terjadi error: " + e.message };
  }
}

/**
 * Mengambil pengaturan batas waktu input guru dari sheet Pengaturan.
 */
function getPengaturanGuru(token) {
  try {
    const { spreadsheetID } = validateAdminSession(token);
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getPengaturanSheet(ss);
    const data = sheet.getRange('A1:B' + sheet.getLastRow()).getValues();
    
    // --- TAMBAHAN BARU ---
    // 1. Dapatkan timezone dari spreadsheet, bukan dari script
    const spreadsheetTimeZone = ss.getSpreadsheetTimeZone(); 
    // 2. Tentukan format yang TEPAT untuk <input type="datetime-local">
    const formatString = "yyyy-MM-dd'T'HH:mm";
    // --- AKHIR TAMBAHAN ---
    
    let pengaturan = {
      isAktif: false,
      tanggalMulai: '',
      tanggalTutup: ''
    };

    for (let i = 0; i < data.length; i++) {
      if (data[i][0] === 'Guru_Input_Aktif') {
        pengaturan.isAktif = data[i][1] === true;
      
      } else if (data[i][0] === 'Guru_Input_Mulai') {
        
        // --- PERBAIKAN DI SINI ---
        // Menggunakan Utilities.formatDate alih-alih .toISOString()
        if (data[i][1] instanceof Date) {
          pengaturan.tanggalMulai = Utilities.formatDate(data[i][1], spreadsheetTimeZone, formatString);
        } else {
          pengaturan.tanggalMulai = '';
        }
        // --- AKHIR PERBAIKAN ---

      } else if (data[i][0] === 'Guru_Input_Tutup') {
        
        // --- PERBAIKAN DI SINI ---
        // Menggunakan Utilities.formatDate alih-alih .toISOString()
        if (data[i][1] instanceof Date) {
          pengaturan.tanggalTutup = Utilities.formatDate(data[i][1], spreadsheetTimeZone, formatString);
        } else {
          pengaturan.tanggalTutup = '';
        }
        // --- AKHIR PERBAIKAN ---
      }
    }
    
    return { status: "sukses", pengaturan: pengaturan };

  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

/**
 * Menyimpan pengaturan batas waktu input guru.
 */
function savePengaturanGuru(token, pengaturan) {
  try {
    const { spreadsheetID } = validateAdminSession(token);
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getPengaturanSheet(ss);
    const data = sheet.getRange('A1:B' + sheet.getLastRow()).getValues();

    const settingsMap = new Map(data.map(row => [row[0], row[1]]));
    settingsMap.set('Guru_Input_Aktif', pengaturan.isAktif);
    settingsMap.set('Guru_Input_Mulai', pengaturan.isAktif && pengaturan.tanggalMulai ? new Date(pengaturan.tanggalMulai) : null);
    settingsMap.set('Guru_Input_Tutup', pengaturan.isAktif && pengaturan.tanggalTutup ? new Date(pengaturan.tanggalTutup) : null);

    // Hapus baris lama
    sheet.getRange('A1:B' + sheet.getLastRow()).clearContent();
    
    // Tulis ulang semua
    const newData = Array.from(settingsMap.entries());
    sheet.getRange(1, 1, newData.length, 2).setValues(newData);

    return { status: "sukses", message: "Pengaturan waktu input guru berhasil disimpan." };

  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

/**
 * Memeriksa apakah input guru saat ini diizinkan berdasarkan pengaturan.
 * @param {GoogleAppsScript.Spreadsheet.Spreadsheet} ss - Spreadsheet yang aktif.
 * @returns {Object} { diizinkan: boolean, pesan: string }
 */
function cekWaktuInputGuru(ss) {
  try {
    const sheet = getPengaturanSheet(ss);
    const data = sheet.getRange('A1:B' + sheet.getLastRow()).getValues();
    
    let isAktif = false;
    let tanggalMulai = null;
    let tanggalTutup = null;

    for (let i = 0; i < data.length; i++) {
      if (data[i][0] === 'Guru_Input_Aktif') {
        isAktif = data[i][1] === true;
      } else if (data[i][0] === 'Guru_Input_Mulai') {
        if (data[i][1] instanceof Date) tanggalMulai = data[i][1];
      } else if (data[i][0] === 'Guru_Input_Tutup') {
        if (data[i][1] instanceof Date) tanggalTutup = data[i][1];
      }
    }
    
    // --- PERUBAHAN UTAMA DI SINI ---
    // Jika tidak aktif, langsung blokir.
    if (!isAktif) {
      return { diizinkan: false, pesan: "Admin belum mengaktifkan izin input nilai untuk guru." };
    }
    // --- AKHIR PERUBAHAN ---

    const now = new Date();

    // Cek tanggal hanya jika 'isAktif' adalah true
    if (tanggalMulai && now < tanggalMulai) {
      const tglMulaiStr = Utilities.formatDate(tanggalMulai, Session.getScriptTimeZone(), "dd MMM yyyy 'pukul' HH:mm");
      return { diizinkan: false, pesan: `Input nilai belum dibuka. Akan dibuka pada ${tglMulaiStr}.` };
    }
    
    if (tanggalTutup && now > tanggalTutup) {
      const tglTutupStr = Utilities.formatDate(tanggalTutup, Session.getScriptTimeZone(), "dd MMM yyyy 'pukul' HH:mm");
      return { diizinkan: false, pesan: `Waktu input nilai sudah ditutup sejak ${tglTutupStr}.` };
    }

    // Jika aktif, dan lolos cek tanggal (atau tanggal kosong)
    return { diizinkan: true, pesan: "Input diizinkan." };

  } catch (e) {
    Logger.log("Error cekWaktuInputGuru: " + e.message);
    // Gagal-safe: Asumsikan TIDAK diizinkan jika terjadi error
    return { diizinkan: false, pesan: "Gagal memvalidasi izin input. Hubungi Admin." };
  }
}

/**
 * Helper untuk membuat password acak sederhana.
 */
function generateRandomPassword() {
  const chars = 'abcdefghjkmnpqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let password = '';
  for (let i = 0; i < 8; i++) {
    password += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return password;
}

/**
 * [ADMIN] Membuat data kartu login untuk SEMUA guru.
 * PENTING: Ini akan MENGGANTI (RESET) semua password guru yang ada.
 * VERSI REVISI: Menambahkan NPSN sekolah ke data respons.
 */
function generateGuruLoginCards(token) {
  const lock = LockService.getDocumentLock();
  lock.waitLock(30000); // Kunci dokumen selama 30 detik
  
  try {
    const { sessionData, spreadsheetID } = validateAdminSession(token); // Ambil spreadsheetID
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getGuruSheet(ss);
    
    // --- TAMBAHAN BARU: Ambil NPSN ---
    const sheetDataSekolah = getDataSekolahSheet(ss); // Fungsi ini sudah ada
    const npsn = sheetDataSekolah.getRange('B2').getValue() || 'N/A'; // Kolom B adalah NPSN
    // --- AKHIR TAMBAHAN ---

    const dataRange = sheet.getRange(2, 1, sheet.getLastRow() - 1, 4); // Kolom A-D (Email, Nama, Hash, Salt)
    const data = dataRange.getValues();
    
    const cardData = [];
    const updatedData = [];

    for (let i = 0; i < data.length; i++) {
      const email = data[i][0];
      const nama = data[i][1];
      
      if (!email || !nama) {
        continue; // Lewati baris kosong
      }

      // 1. Buat password baru
      const newPassword = generateRandomPassword();
      
      // 2. Buat hash & salt baru
      const newSalt = generateSalt();
      const newHash = hashPassword(newPassword, newSalt);
      
      // 3. Siapkan data untuk ditulis kembali ke sheet
      updatedData.push([email, nama, newHash, newSalt]);
      
      // 4. Siapkan data untuk dikirim ke klien (dengan password plain text baru)
      cardData.push({
        email: email,
        nama: nama,
        newPassword: newPassword
      });
    }

    // 5. Tulis SEMUA password baru ke sheet dalam satu operasi
    if (updatedData.length > 0) {
      sheet.getRange(2, 1, updatedData.length, 4).setValues(updatedData);
    }

    // --- PERUBAHAN DI SINI: Tambahkan npsn ke respons ---
    return { status: "sukses", cardData: cardData, npsn: npsn };

  } catch (e) {
    Logger.log("Error generateGuruLoginCards: " + e.message);
    return { status: "gagal", message: e.message };
  } finally {
    lock.releaseLock();
  }
}

/**
 * [ADMIN] Menyinkronkan data MapelKelasJSON semua guru ke ["*"] (Semua Kelas).
 * Hanya berjalan jika total kelas di sekolah = 1.
 */
function syncGuruClassesToSingleClass(token) {
  const lock = LockService.getDocumentLock();
  lock.waitLock(15000);
  
  try {
    const { spreadsheetID } = validateAdminSession(token);
    const ss = SpreadsheetApp.openById(spreadsheetID);
    
    // 1. Validasi bahwa hanya ada 1 kelas
    const sheetKelas = getKelasSheet(ss);
    const totalKelas = sheetKelas.getLastRow() - 1; // Kurangi header
    if (totalKelas !== 1) {
      throw new Error(`Fitur ini hanya dapat digunakan jika Anda memiliki TEPAT SATU kelas terdaftar. (Terdeteksi: ${totalKelas} kelas)`);
    }

    // 2. Proses sheet Guru
    const sheetGuru = getGuruSheet(ss);
    if (sheetGuru.getLastRow() <= 1) {
      return { status: "sukses", message: "Tidak ada data guru untuk disinkronkan." };
    }

    const dataRange = sheetGuru.getRange(2, 1, sheetGuru.getLastRow() - 1, 5); // Kolom A sampai E
    const values = dataRange.getValues();
    
    let changesMade = 0;
    let newJsonValues = []; // Array untuk menampung JSON baru

    for (let i = 0; i < values.length; i++) {
      const mapelKelasJSON = values[i][4]; // Kolom E
      
      if (!mapelKelasJSON) {
        newJsonValues.push([null]); // Jika kosong, biarkan kosong
        continue;
      }

      try {
        const mapelData = JSON.parse(mapelKelasJSON);
        const mapelKeys = Object.keys(mapelData);

        if (mapelKeys.length === 0) {
          newJsonValues.push([mapelKelasJSON]); // Jika JSON kosong, biarkan
          continue;
        }

        let needsSync = false;
        const newData = {};

        // Buat ulang data baru
        for (const key of mapelKeys) {
          newData[key] = ["*"]; // Atur ke "Semua Kelas"
          
          // Cek apakah data lama "kotor"
          const val = mapelData[key];
          if (!Array.isArray(val) || val.length !== 1 || val[0] !== "*") {
            needsSync = true; // Tandai jika datanya BUKAN ["*"]
          }
        }

        if (needsSync) {
          changesMade++;
          newJsonValues.push([JSON.stringify(newData)]); // Simpan JSON baru
        } else {
          newJsonValues.push([mapelKelasJSON]); // Data sudah bersih, simpan yang lama
        }
        
      } catch (e) {
        newJsonValues.push([mapelKelasJSON]); // Gagal parse, biarkan data aslinya
      }
    }

    // 3. Tulis kembali data JSON yang sudah bersih secara batch
    if (changesMade > 0) {
      sheetGuru.getRange(2, 5, newJsonValues.length, 1).setValues(newJsonValues);
    }
    
    return { status: "sukses", message: `Sinkronisasi selesai. ${changesMade} data guru diperbarui.` };

  } catch (e) {
    return { status: "gagal", message: e.message };
  } finally {
    lock.releaseLock();
  }
}

/**
 * [ADMIN] Mendapatkan detail status donasi saat ini.
 * Fungsi ini mengambil data dari Master Sheet untuk ditampilkan di halaman donasi.
 */
function getDonasiStatusDetail(token) {
  try {
    // 1. Validasi sesi dan dapatkan sekolahID
    const { sessionData } = validateAdminSession(token); // Ini sudah me-refresh sesi
    
    // 2. Siapkan data dasar untuk dikirim (dari sesi)
    const adminData = {
      email: "", // Kita akan coba ambil ini dari sheet di bawah
      namaSekolah: sessionData.namaSekolah
    };

    // 3. Buka Master Sheet untuk mengambil detail lengkap
    const masterSS = SpreadsheetApp.openById(MASTER_SHEET_ID);
    const sheetSekolah = masterSS.getSheetByName('Sheet_Sekolah');
    const dataSekolah = sheetSekolah.getDataRange().getValues();
    
    let donasiDetail = { status: "NONE" }; // Default

    // 4. Loop untuk menemukan sekolah yang sesuai
    for (let i = 1; i < dataSekolah.length; i++) { // Mulai dari 1 (skip header)
      if (dataSekolah[i][0] === sessionData.sekolahID) { // Kolom A (SekolahID)
        
        // Ambil email admin dari Kolom D (index 3)
        adminData.email = dataSekolah[i][3]; 
        
        const donasiStatus = dataSekolah[i][8] || "NONE"; // Kolom I (DonasiStatus)
        
        // Hanya ambil detail jika statusnya BUKAN "NONE"
        if (donasiStatus !== "NONE") {
            const fileId = dataSekolah[i][9]; // Kolom J (DonasiFileID)
            let fileUrl = null;
            
            if (fileId) {
              try {
                // Buat link view sementara untuk file bukti
                const file = DriveApp.getFileById(fileId);
                // Dapatkan link viewer (bukan download)
                fileUrl = file.getDownloadUrl().replace("&export=download", ""); 
              } catch (e) {
                Logger.log("Gagal mendapatkan URL file donasi: " + e.message);
                fileUrl = null; // Set ke null jika file tidak dapat diakses
              }
            }
            
            donasiDetail = {
                status: donasiStatus,     // Kolom I
                fileId: fileId,
                fileUrl: fileUrl,         // Link file yang baru dibuat
                dataJson: dataSekolah[i][10],  // Kolom K (Data Form JSON)
                alasan: dataSekolah[i][11]   // Kolom L (Alasan Tolak)
            };
        }
        break; // Hentikan loop setelah sekolah ditemukan
      }
    }
    
    // 5. Kembalikan kedua objek
    return { status: "sukses", donasi: donasiDetail, admin: adminData };

  } catch (e) {
    Logger.log("Error di getDonasiStatusDetail: " + e.message + "\n" + e.stack);
    return { status: "gagal", message: e.message };
  }
}


function submitDonasi(token, fileData, formDataJSON) {
  const lock = LockService.getScriptLock();
  lock.waitLock(15000);
  try {
    const { sessionData } = validateAdminSession(token);
    
    // 1. Dapatkan Folder Donasi
    const masterSS = SpreadsheetApp.openById(MASTER_SHEET_ID);
    const sheetSekolah = masterSS.getSheetByName('Sheet_Sekolah');
    const dataSekolah = sheetSekolah.getDataRange().getValues();
    
    let rowToUpdate = -1;
    let oldFileId = null;
    let donasiFolderId = null; // <-- [BARU] Variabel untuk ID folder

    for (let i = 1; i < dataSekolah.length; i++) {
      if (dataSekolah[i][0] === sessionData.sekolahID) {
        rowToUpdate = i + 1;
        oldFileId = dataSekolah[i][9]; // Kolom J (FileID lama)
        donasiFolderId = dataSekolah[i][14]; // <-- [BARU] Kolom O (DonasiFolderID)
        break;
      }
    }
    
    if (rowToUpdate === -1) {
      throw new Error("Gagal menemukan data sekolah Anda.");
    }
    
    // --- [MODIFIKASI] Tentukan folder tujuan ---
    let uploadFolder;
    if (donasiFolderId) {
      try {
        uploadFolder = DriveApp.getFolderById(donasiFolderId);
      } catch (e) {
        Logger.log(`Peringatan: Folder donasi (Kolom O) ID ${donasiFolderId} tidak ditemukan. Fallback ke global.`);
        uploadFolder = DriveApp.getFolderById(DONASI_FOLDER_ID); // Fallback
      }
    } else {
      Logger.log(`Peringatan: Kolom O (DonasiFolderID) kosong. Fallback ke global.`);
      uploadFolder = DriveApp.getFolderById(DONASI_FOLDER_ID); // Fallback untuk sekolah lama
    }
    // --- [AKHIR MODIFIKASI] ---

    // 2. Hapus file lama jika ada (logika ini tetap sama)
    if (oldFileId) {
      try { DriveApp.getFileById(oldFileId).setTrashed(true); } catch(e) {}
    }
    
    // 3. Upload file bukti ke folder yang benar
    const { base64, mimeType, fileName } = fileData;
    const decodedData = Utilities.base64Decode(base64.split(',')[1]);
    const blob = Utilities.newBlob(decodedData, mimeType, `[${sessionData.namaSekolah}] - ${fileName}`);
    
    // [MODIFIKASI] Menggunakan 'uploadFolder'
    const newFile = uploadFolder.createFile(blob);
    const newFileId = newFile.getId();
    
    // 4. Tulis data baru ke Sheet_Sekolah (logika ini tetap sama)
    sheetSekolah.getRange(rowToUpdate, 9, 1, 4).setValues([[
      "PENDING",      // Kolom I (Status)
      newFileId,      // Kolom J (FileID)
      formDataJSON,   // Kolom K (Data Form)
      ""              // Kolom L (Alasan)
    ]]);
    
    clearMasterSheetCache();
    
    return { status: "sukses", donasiStatus: "PENDING" };
    
  } catch (e) {
    return { status: "gagal", message: e.message };
  } finally {
    lock.releaseLock();
  }
}

/**
 * [ADMIN] Membatalkan donasi yang sedang pending.
 */
function batalkanDonasi(token) {
  const lock = LockService.getScriptLock();
  lock.waitLock(15000);
  try {
    const { sessionData } = validateAdminSession(token);

    const masterSS = SpreadsheetApp.openById(MASTER_SHEET_ID);
    const sheetSekolah = masterSS.getSheetByName('Sheet_Sekolah');
    const dataSekolah = sheetSekolah.getDataRange().getValues();
    
    let rowToUpdate = -1;
    let fileToTrash = null;
    for (let i = 1; i < dataSekolah.length; i++) {
      if (dataSekolah[i][0] === sessionData.sekolahID) {
        if (dataSekolah[i][8] === "PENDING") { // Hanya bisa batalkan yg PENDING
          rowToUpdate = i + 1;
          fileToTrash = dataSekolah[i][9]; // Kolom J (FileID)
        }
        break;
      }
    }
    
    if (rowToUpdate === -1) {
      throw new Error("Gagal menemukan data donasi pending.");
    }

    if (fileToTrash) {
      try { DriveApp.getFileById(fileToTrash).setTrashed(true); } catch(e) {}
    }
    
    sheetSekolah.getRange(rowToUpdate, 9, 1, 4).setValues([[
      "NONE", // Kolom I (Status)
      "",     // Kolom J (FileID)
      "",     // Kolom K (Data Form)
      ""      // Kolom L (Alasan)
    ]]);
    
    clearMasterSheetCache();
    
    return { status: "sukses", donasiStatus: "NONE" };
    
  } catch (e) {
    return { status: "gagal", message: e.message };
  } finally {
    lock.releaseLock();
  }
}

/**
 * [SUPERADMIN] Mengambil daftar donasi yang PENDING.
 */
function getDonasiList(token) {
  try {
    validateSuperadminSession(token);
    const dataSekolah = getCachedMasterSheetData();
    dataSekolah.shift(); // Hapus header
    
    const pendingList = [];
    
    for (const row of dataSekolah) {
      const donasiStatus = row[8]; // Kolom I
      if (donasiStatus === "PENDING") {
        const fileId = row[9]; // Kolom J
        let fileUrl = null;
        if (fileId) {
          try {
            const file = DriveApp.getFileById(fileId);
            file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW); // Pastikan SA bisa lihat
            fileUrl = file.getDownloadUrl().replace("&export=download", ""); // Dapatkan link viewer
          } catch (e) {
            fileUrl = "ERROR: " + e.message;
          }
        }
        
        pendingList.push({
          sekolahID: row[0],
          namaSekolah: row[1],
          dataJson: row[10], // Kolom K
          fileUrl: fileUrl
        });
      }
    }
    
    return { status: "sukses", pendingList: pendingList };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

/**
 * [SUPERADMIN] Memverifikasi (Setujui/Tolak) donasi.
 */
function verifikasiDonasi(token, sekolahID, isApproved, alasan) {
  const lock = LockService.getScriptLock();
  lock.waitLock(15000);
  try {
    validateSuperadminSession(token);
    
    if (!sekolahID) throw new Error("SekolahID tidak ada.");
    if (!isApproved && !alasan) throw new Error("Alasan penolakan wajib diisi.");

    const masterSS = SpreadsheetApp.openById(MASTER_SHEET_ID);
    const sheetSekolah = masterSS.getSheetByName('Sheet_Sekolah');
    const dataSekolah = sheetSekolah.getDataRange().getValues();
    
    let rowToUpdate = -1;
    for (let i = 1; i < dataSekolah.length; i++) {
      if (dataSekolah[i][0] === sekolahID) {
        rowToUpdate = i + 1;
        break;
      }
    }
    
    if (rowToUpdate === -1) {
      throw new Error("Gagal menemukan data sekolah.");
    }
    
    if (isApproved) {
      sheetSekolah.getRange(rowToUpdate, 9).setValue("APPROVED"); // Kolom I
      sheetSekolah.getRange(rowToUpdate, 12).setValue("");      // Kolom L
    } else {
      sheetSekolah.getRange(rowToUpdate, 9).setValue("REJECTED"); // Kolom I
      sheetSekolah.getRange(rowToUpdate, 12).setValue(alasan); // Kolom L
    }
    
    clearMasterSheetCache();
    
    return { status: "sukses", message: "Verifikasi berhasil disimpan." };

  } catch (e) {
    return { status: "gagal", message: e.message };
  } finally {
    lock.releaseLock();
  }
}

/**
 * [INTERNAL HELPER BARU]
 * Mengambil data siswa dari cache atau (jika cache kosong) dari sheet.
 * Ini menggantikan logika yang sebelumnya terduplikat di banyak fungsi.
 */
function _getSiswaInternal(spreadsheetID, sekolahID) {
  const cacheKey = SISWA_CACHE_KEY + "_" + sekolahID;
  const scriptCache = CacheService.getScriptCache();
  const cachedSiswa = scriptCache.get(cacheKey);

  if (cachedSiswa != null) {
    // 1. Ditemukan di cache, kembalikan data cache
    return JSON.parse(cachedSiswa);
  }

  // 2. Tidak ada di cache, ambil dari sheet
  Logger.log("CACHE MISS: _getSiswaInternal untuk " + sekolahID);
  const ss = SpreadsheetApp.openById(spreadsheetID);
  const sheet = getSiswaSheet(ss);
  const data = sheet.getDataRange().getValues();
  data.shift(); // Hapus header
  
  const siswaList = data.map(row => {
    const idNum = parseInt((row[0] || 'SIS-0').split('-')[1] || 0);
    return {
      id: row[0],
      nama: row[1],
      nisn: row[2],
      nisLokal: row[3] || '',
      jk: row[4] || '',
      tempatLahir: row[5] || '',
      tglLahir: (row[6] instanceof Date) ? Utilities.formatDate(row[6], Session.getScriptTimeZone(), "yyyy-MM-dd") : (row[6] || ''),
      kelas: row[7] || '',
      urutan: row[8] || idNum
    };
  });
  
  // Urutkan data sebelum disimpan ke cache
  siswaList.sort((a, b) => {
    const kelasCompare = a.kelas.localeCompare(b.kelas);
    if (kelasCompare !== 0) return kelasCompare;
    return (Number(a.urutan) || 0) - (Number(b.urutan) || 0);
  });
  
  // 3. Simpan ke cache untuk panggilan berikutnya
  scriptCache.put(cacheKey, JSON.stringify(siswaList), 3600); // Cache 1 jam
  return siswaList;
}

/**
 * [BARU] Mengambil nama sekolah untuk konfirmasi.
 */
function getNamaSekolah(token) {
  try {
    const { sessionData } = validateAdminSession(token);
    return { status: "sukses", namaSekolah: sessionData.namaSekolah };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

/**
 * [BARU] Membuat file backup .xlsx dari SELURUH database sekolah.
 */
function getBackupDatabaseExcel(token) {
  try {
    const { sessionData, spreadsheetID } = validateAdminSession(token);
    
    const url = "https://docs.google.com/spreadsheets/d/" + spreadsheetID + "/export?format=xlsx";
    const oauthToken = ScriptApp.getOAuthToken();
    
    const response = UrlFetchApp.fetch(url, {
      headers: {
        'Authorization': 'Bearer ' + oauthToken
      },
      muteHttpExceptions: true // Tangkap error
    });
    
    if (response.getResponseCode() !== 200) {
      throw new Error("Gagal mengambil file dari server Google. Coba lagi.");
    }

    const timestamp = Utilities.formatDate(new Date(), Session.getScriptTimeZone(), "yyyy-MM-dd");
    const fileName = `[BACKUP] ${sessionData.namaSekolah} - ${timestamp}.xlsx`;
    const blob = response.getBlob().setName(fileName);
    
    return { 
      status: "sukses", 
      base64: Utilities.base64Encode(blob.getBytes()), 
      mimeType: MimeType.MICROSOFT_EXCEL, 
      fileName: fileName 
    };
    
  } catch (e) {
    Logger.log("Gagal getBackupDatabaseExcel: " + e.message);
    return { status: "gagal", message: "Gagal membuat file backup: " + e.message };
  }
}

/**
 * [BARU - DIPERBARUI] Menghapus semua data siswa, nilai, dan cache ijazah.
 * Mempertahankan Mapel, Kelas, dan Akun Guru.
 */
function hapusSemuaDataSiswaDanNilai(token) {
  const lock = LockService.getDocumentLock();
  lock.waitLock(30000); // Kunci selama 30 detik
  
  let spreadsheetID, sessionData;
  try {
    const session = validateAdminSession(token);
    spreadsheetID = session.spreadsheetID;
    sessionData = session.sessionData;
    
    const ss = SpreadsheetApp.openById(spreadsheetID);
    
    // Daftar sheet yang akan DIBERSIHKAN (bukan dihapus)
    const sheetsToClear = [
      'Siswa',
      'Nilai_Ujian',
      'Nilai_Rapor_Akhir',
      'Cache_Rekap_Ijazah'
      // 'Akun_Guru' <-- TELAH DIHAPUS DARI DAFTAR INI
    ];
    
    sheetsToClear.forEach(sheetName => {
      const sheet = ss.getSheetByName(sheetName);
      if (sheet) {
        const lastRow = sheet.getLastRow();
        if (lastRow > 1) {
          // Hapus baris 2 sampai akhir
          sheet.deleteRows(2, lastRow - 1);
        }
      }
    });

    // Bersihkan semua cache sisi server yang terkait siswa
    clearSiswaCache(sessionData.sekolahID, spreadsheetID);
    clearNilaiUjianCache(sessionData.sekolahID, spreadsheetID);
    clearNilaiRaporCache(sessionData.sekolahID, spreadsheetID);
    clearRekapNilaiCache(sessionData.sekolahID);
    clearLockedKelasCache(sessionData.sekolahID);
    CacheService.getScriptCache().remove(NILAI_IJAZAH_CACHE_KEY + "_" + sessionData.sekolahID);

    return { status: "sukses" };

  } catch (e) {
    Logger.log("Gagal hapusSemuaDataSiswaDanNilai: " + e.message);
    return { status: "gagal", message: e.message };
  } finally {
    if (lock) lock.releaseLock();
  }
}

/**
 * [BARU - DIPERBARUI] Membuat data kartu login untuk SEMUA siswa.
 * Mengambil data siswa yang memiliki NISN dan Tgl Lahir.
 */
function generateSiswaLoginCards(token) {
  try {
    const { sessionData, spreadsheetID } = validateAdminSession(token);
    
    // 1. Dapatkan URL login siswa
    const appUrl = ScriptApp.getService().getUrl() + '#login-siswa';
    
    // 2. Dapatkan semua data siswa (dari cache atau sheet)
    const allSiswa = _getSiswaInternal(spreadsheetID, sessionData.sekolahID);

    const cardData = [];

    // 3. Filter siswa
    allSiswa.forEach(siswa => {
      // Hanya sertakan siswa yang memiliki NISN dan Tanggal Lahir
      if (siswa.nisn && siswa.tglLahir) {
        
        // --- PERBAIKAN FORMAT TANGGAL DI SINI ---
        let formattedDate = siswa.tglLahir; // Default: "YYYY-MM-DD"
        try {
          // Pisahkan tanggal "2025-11-07"
          const parts = siswa.tglLahir.split('-');
          if (parts.length === 3) {
            // Susun ulang menjadi "07-11-2025"
            formattedDate = `${parts[2]}-${parts[1]}-${parts[0]}`;
          }
        } catch(e) {
          // Jika gagal, biarkan format aslinya
          Logger.log("Gagal format tanggal siswa: " + e.message);
        }
        // --- AKHIR PERBAIKAN ---

        cardData.push({
          nama: siswa.nama,
          nisn: siswa.nisn,
          tglLahir: formattedDate // Kirim format baru ke klien
        });
      }
    });

    return { status: "sukses", cardData: cardData, websiteUrl: appUrl };

  } catch (e) {
    Logger.log("Error generateSiswaLoginCards: " + e.message);
    return { status: "gagal", message: e.message };
  }
}


/**
 * [BARU] Membuat spreadsheet baru untuk data Aplikasi 2 (Nilai Ujian)
 * dan mengisinya dengan semua sheet yang diperlukan.
 * @param {string} namaSekolah Nama sekolah untuk judul spreadsheet.
 * @param {GoogleAppsScript.Drive.Folder} schoolDriveFolder Folder tujuan untuk menyimpan file.
 * @returns {string} ID dari Spreadsheet baru yang dibuat.
 */
function buatDatabaseAplikasi2Baru(namaSekolah, schoolDriveFolder) { // [MODIFIKASI] Tambah argumen
  let newSS;
  try {
    // 1. Buat Spreadsheet baru
    const ssName = `Database Nilai Ujian - ${namaSekolah}`;
    newSS = SpreadsheetApp.create(ssName);
    const newSSID = newSS.getId();
    
    // 2. Pindahkan ke Folder Target
    try {
      // [MODIFIKASI] Gunakan schoolDriveFolder, hapus referensi ke TARGET_FOLDER_ID
      const newFile = DriveApp.getFileById(newSSID);
      schoolDriveFolder.addFile(newFile);
      DriveApp.getRootFolder().removeFile(newFile);
    } catch (e) {
      // Biarkan fallback ke root jika pemindahan gagal
      Logger.log(`Peringatan: Gagal memindahkan DB App 2 baru ke folder sekolah. Error: ${e.message}`);
    }

    // 3. Buat semua sheet yang diperlukan oleh Aplikasi 2
    
    const defaultSheet = newSS.getSheets()[0];
    
    // db_guru (Hanya untuk referensi, tidak dipakai di model ini)
    // newSS.insertSheet('db_guru').appendRow(["email", "password", "nama", "id_sekolah", "role"]).setFrozenRows(1);

    // db_siswa
    const siswaSheet = newSS.insertSheet('db_siswa');
    siswaSheet.appendRow(["nomor_ujian", "nama"]);
    siswaSheet.setFrozenRows(1);
    siswaSheet.getRange("A:A").setNumberFormat('@');

    // db_tahun_ajaran
    const taSheet = newSS.insertSheet('db_tahun_ajaran');
    taSheet.appendRow(["id_tahun_ajaran", "deskripsi", "status_kunci"]);
    // Tambahkan T.A. default
    const currentYear = new Date().getFullYear();
    const nextYear = currentYear + 1;
    const defaultTaDeskripsi = `${currentYear}/${nextYear}`;
    const defaultTaId = `TA-${currentYear}-${nextYear}`;
    taSheet.appendRow([defaultTaId, defaultTaDeskripsi, false]); 
    taSheet.setFrozenRows(1);

    // db_enrollment
    newSS.insertSheet('db_enrollment').appendRow(["id_enrollment", "nomor_ujian", "id_sekolah", "id_tahun_ajaran", "ruang_ujian"]).setFrozenRows(1);

    // db_mapel
    newSS.insertSheet('db_mapel').appendRow(["email_guru", "mapel", "id_tahun_ajaran", "singkatan"]).setFrozenRows(1);

    // db_sekolah (Hanya untuk referensi)
    newSS.insertSheet('db_sekolah').appendRow(["id_sekolah", "nama_sekolah", "tempat_ttd", "kepala_sekolah", "nip_kepsek", "template_id", "tanggal_sistem", "template_rekap", "pengumuman"]).setFrozenRows(1);

    // db_pengaturan_cetak
    newSS.insertSheet('db_pengaturan_cetak').appendRow(["email_guru", "preferensi_tanggal", "tanggal_manual_OBSOLETE"]).setFrozenRows(1);

    // db_status_kirim
    newSS.insertSheet('db_status_kirim').appendRow(["key", "id_tahun_ajaran", "email_guru", "nama_mapel", "timestamp_kirim", "tanggal_ttd"]).setFrozenRows(1);

    // db_pengaturan_katrol
    newSS.insertSheet('db_pengaturan_katrol').appendRow(["email", "id_tahun_ajaran", "min_hasil_katrol", "max_hasil_katrol"]).setFrozenRows(1);

    // db_ott_cache (PENTING UNTUK SSO)
    newSS.insertSheet('db_ott_cache').appendRow(["Token", "EmailPayload", "Timestamp"]).setFrozenRows(1);
    
    newSS.deleteSheet(defaultSheet);

    Logger.log(`Database Aplikasi 2 baru berhasil dibuat untuk ${namaSekolah} dengan ID: ${newSSID}`);
    return newSSID;
    
  } catch (e) {
    Logger.log(`FATAL: Gagal membuat Database Aplikasi 2 baru. Error: ${e.message}`);
    if (newSS) {
      DriveApp.getFileById(newSS.getId()).setTrashed(true);
    }
    throw new Error(`Gagal membuat database sekunder (App 2): ${e.message}`);
  }
}

// Di file: aplikasi1/Kode.gs.html
// Ganti fungsi getApp2DatabaseId(token) Anda dengan yang ini:

function getApp2DatabaseId(token) {
  const sessionData = validateAndRefreshSession(token);
  const sekolahID = sessionData.sekolahID;

  const masterSS = SpreadsheetApp.openById(MASTER_SHEET_ID);
  const sheetSekolah = masterSS.getSheetByName('Sheet_Sekolah');
  // Pastikan membaca sampai Kolom M (13 kolom)
  const dataRange = sheetSekolah.getRange("A2:M" + sheetSekolah.getLastRow());
  const data = dataRange.getValues();

  let targetRowIndex = -1;
  let rowData = null;

  for (let i = 0; i < data.length; i++) {
    if (data[i][0] == sekolahID) { // Kolom A
      targetRowIndex = i;
      rowData = data[i];
      break;
    }
  }

  if (!rowData) {
    throw new Error("Data sekolah tidak ditemukan di Master Sheet.");
  }

  let app2DbId = rowData[12]; // Kolom M

  // *** INI ADALAH LOGIKA PERBAIKAN OTOMATIS ***
  if (!app2DbId) {
    Logger.log(`PERBAIKAN OTOMATIS: Kolom M kosong untuk ${sekolahID}. Memulai pembuatan DB App 2...`);
    
    // Butuh lock untuk mencegah 2 proses membuat DB yg sama
    const lock = LockService.getScriptLock();
    lock.waitLock(30000); // Tunggu 30 detik
    
    try {
      // Re-check, mungkin proses lain sudah mengisinya
      // (i + 2 karena data 0-based dan sheet 1-based + 1 header)
      const freshApp2DbId = sheetSekolah.getRange(targetRowIndex + 2, 13).getValue();
      if (freshApp2DbId) {
          Logger.log(`PERBAIKAN OTOMATIS: Proses lain sudah memperbaiki. Menggunakan ${freshApp2DbId}.`);
          return freshApp2DbId;
      }

      const namaSekolah = rowData[1]; // Kolom B
      const emailAdmin = rowData[3]; // Kolom D
      
      if (!namaSekolah || !emailAdmin) {
        throw new Error(`Data sekolah (Nama/Email) tidak lengkap untuk ${sekolahID}. Perbaikan otomatis gagal.`);
      }

      // 1. Buat DB App 2 baru
      const newSSID_App2 = buatDatabaseAplikasi2Baru(namaSekolah.toUpperCase());
      
      // 2. Tulis ID baru ke Kolom M
      sheetSekolah.getRange(targetRowIndex + 2, 13).setValue(newSSID_App2);
      
      // 3. Daftarkan ke Global App 2 (dengan dummy password)
      // Kita tidak bisa ambil password HASH, jadi buat dummy. Admin perlu edit manual jika ingin login ke App 2 sbg guru.
      const dummyPassword = "GANTI_PASSWORD_" + Math.random().toString(36).substring(2, 8);
      
      registerSchoolInApp2(sekolahID, namaSekolah.toUpperCase());
      registerAdminAsGuruInApp2(emailAdmin, namaSekolah.toUpperCase(), sekolahID, dummyPassword);
      
      Logger.log(`PERBAIKAN OTOMATIS: Sukses. DB App 2 Dibuat: ${newSSID_App2}. Admin ${emailAdmin} didaftarkan dengan password dummy.`);
      
      // 4. Bersihkan cache master
      clearMasterSheetCache();
      
      // 5. Kembalikan ID baru
      app2DbId = newSSID_App2;

    } catch (e) {
        Logger.log(`PERBAIKAN OTOMATIS: Gagal. Error: ${e.message}`);
        throw new Error(`Gagal memperbaiki tautan database secara otomatis: ${e.message}`);
    } finally {
        lock.releaseLock();
    }
  }
  // *** AKHIR LOGIKA PERBAIKAN OTOMATIS ***

  return app2DbId;
}

function getTahunAjaranSheet(ss_app2) {
  let sheet = ss_app2.getSheetByName('db_tahun_ajaran');
  if (!sheet) {
    sheet = ss_app2.insertSheet('db_tahun_ajaran');
    sheet.appendRow(["id_tahun_ajaran", "deskripsi", "status_kunci"]);
    const currentYear = new Date().getFullYear();
    const nextYear = currentYear + 1;
    const defaultTaDeskripsi = `${currentYear}/${nextYear}`;
    const defaultTaId = `TA-${currentYear}-${nextYear}`;
    sheet.appendRow([defaultTaId, defaultTaDeskripsi, false]); 
    sheet.setFrozenRows(1);
  }
  return sheet;
}

// --- FUNGSI BARU ---
// Helper to get/create db_enrollment sheet in App2 DB
function getEnrollmentSheet_App2(ss_app2) {
  let sheet = ss_app2.getSheetByName('db_enrollment');
  if (!sheet) {
    sheet = ss_app2.insertSheet('db_enrollment');
    sheet.appendRow(["id_enrollment", "nomor_ujian", "id_sekolah", "id_tahun_ajaran", "ruang_ujian"]);
    sheet.setFrozenRows(1);
    sheet.getRange("B:B").setNumberFormat('@'); // Format Nomor Ujian sebagai Teks
  }
  return sheet;
}


function getMapelSheet_App2(ss_app2) {
  let sheet = ss_app2.getSheetByName('db_mapel');
  if (!sheet) {
    sheet = ss_app2.insertSheet('db_mapel');
    sheet.appendRow(["email_guru", "mapel", "id_tahun_ajaran", "singkatan", "kelas_json", "isUS", "isUP"]);
    sheet.setFrozenRows(1);
  } else {
    const header = sheet.getRange(1, 6).getValue();
    if (header !== "isUS") {
      sheet.getRange(1, 6).setValue("isUS");
      sheet.getRange(1, 7).setValue("isUP");
    }
  }
  return sheet;
}

function getSiswaSheet_App2(ss_app2) {
  let sheet = ss_app2.getSheetByName('db_siswa');
  if (!sheet) {
    sheet = ss_app2.insertSheet('db_siswa');
    sheet.appendRow(["nomor_ujian", "nama", "nisn", "kelas"]);
    sheet.setFrozenRows(1);
    sheet.getRange("A:A").setNumberFormat('@');
    sheet.getRange("C:C").setNumberFormat('@');
  } else {
    if (sheet.getRange(1, 3).getValue() !== "nisn") {
      sheet.getRange(1, 3).setValue("nisn");
      sheet.getRange(1, 4).setValue("kelas");
      sheet.getRange("C:C").setNumberFormat('@');
    }
  }
  return sheet;
}

// GANTI FUNGSI INI di aplikasi1/Kode.gs.html

function getTahunAjaran(token) {
  try {
    // 1. Dapatkan database Aplikasi 2
    const app2DbId = getApp2DatabaseId(token);
    const ss_app2 = SpreadsheetApp.openById(app2DbId);
    
    // 2. Ambil data T.A. (db_tahun_ajaran)
    const sheet = getTahunAjaranSheet(ss_app2); // Ini db_tahun_ajaran
    
    if (sheet.getLastRow() <= 1) {
      return { status: "sukses", data: [] }; // Kosong
    }
    
    const data = sheet.getRange(2, 1, sheet.getLastRow() - 1, 3).getValues();
    
    // --- AWAL MODIFIKASI: Pengecekan 'isUsed' ganda ---
    
    // 3. Cek dari 'db_status_kirim' (Status Nilai Terkirim)
    const statusKirimSheet = ss_app2.getSheetByName('db_status_kirim');
    const usedByStatusIds = new Set();
    if (statusKirimSheet && statusKirimSheet.getLastRow() > 1) {
      // Kolom B (index 1) adalah id_tahun_ajaran
      const statusData = statusKirimSheet.getRange(2, 2, statusKirimSheet.getLastRow() - 1, 1).getValues();
      statusData.forEach(row => {
        if(row[0]) usedByStatusIds.add(row[0]);
      });
    }
    
    // 4. Cek dari 'db_enrollment' (Siswa Ditempatkan)
    const enrollmentSheet = getEnrollmentSheet_App2(ss_app2); 
    const usedByEnrollmentIds = new Set();
    if (enrollmentSheet && enrollmentSheet.getLastRow() > 1) {
      // Kolom D (index 3) adalah id_tahun_ajaran
      const enrollmentData = enrollmentSheet.getRange(2, 4, enrollmentSheet.getLastRow() - 1, 1).getValues();
      enrollmentData.forEach(row => {
        if(row[0]) usedByEnrollmentIds.add(row[0]);
      });
    }
    // --- AKHIR MODIFIKASI ---

    // 5. Buat daftar T.A.
    const taList = data.map(row => {
      const id_ta = row[0];
      const isManuallyLocked = row[2] === true; // Kuncian manual dari checkbox
      
      // --- PERUBAHAN LOGIKA 'isUsed' ---
      // Dianggap "digunakan" jika ada di 'status' ATAU 'enrollment'
      const isUsed = usedByStatusIds.has(id_ta) || usedByEnrollmentIds.has(id_ta);
      // --- AKHIR PERUBAHAN ---

      return {
        id: id_ta,
        deskripsi: row[1],
        isLocked: isManuallyLocked, // Status checkbox
        isUsed: isUsed // Status data (ada/tidaknya siswa atau nilai)
      };
    }).filter(item => item.id && item.deskripsi); // Filter baris kosong
    
    return { status: "sukses", data: taList };
    
  } catch (e) {
    Logger.log(`getTahunAjaran error: ${e.message}`);
    return { status: "gagal", message: e.message };
  }
}

// --- FUNGSI BARU ---
// API baru untuk HANYA mengambil list T.A. (untuk dropdown)
function getTahunAjaranList(token) {
  try {
    const app2DbId = getApp2DatabaseId(token);
    const ss_app2 = SpreadsheetApp.openById(app2DbId);
    const sheet = getTahunAjaranSheet(ss_app2);
    
    if (sheet.getLastRow() <= 1) {
      return { status: "sukses", taList: [] }; // Kosong
    }
    
    const data = sheet.getRange(2, 1, sheet.getLastRow() - 1, 3).getValues();
    const taList = data.map(row => {
      return {
        id: row[0],
        deskripsi: row[1],
        isLocked: row[2] === true
      };
    }).filter(item => item.id && item.deskripsi)
      .sort((a, b) => b.deskripsi.localeCompare(a.deskripsi)); // Urutkan terbaru di atas
    
    return { status: "sukses", taList: taList };
  } catch (e) {
    Logger.log(`getTahunAjaranList error: ${e.message}`);
    return { status: "gagal", message: e.message };
  }
}

/**
 * [API BARU] Mengambil semua data yang diperlukan untuk halaman "Kelola Penempatan".
 * Menggabungkan data dari Aplikasi 1 (Siswa, Mapel, Guru) dan Aplikasi 2 (Enrollment, Mapel Assignment).
 */
function getPenempatanData(token, id_tahun_ajaran) {
  try {
    const { sessionData, spreadsheetID: app1DbId } = validateAdminSession(token);
    const app2DbId = getApp2DatabaseId(token); // Helper yang sudah ada
    
    // 1. Buka kedua database
    const ss_app1 = SpreadsheetApp.openById(app1DbId);
    const ss_app2 = SpreadsheetApp.openById(app2DbId);
    
    // 2. Ambil Data Master dari Aplikasi 1
    
    // [MODIFIKASI] Ambil 'nisn' juga
    const siswaListApp1 = _getSiswaInternal(app1DbId, sessionData.sekolahID).map(s => ({
      id: s.id,
      nama: s.nama,
      kelas: s.kelas,
      nisn: s.nisn // <-- BARIS INI DITAMBAHKAN
    }));
    // [AKHIR MODIFIKASI]
    
    // Ambil Mapel (sudah di-cache server)
    const mapelListApp1 = _getMapelInternal(ss_app1, sessionData.sekolahID).map(m => ({
      id: m.id,
      nama: m.nama,
      isUS: m.isUS,
      isUP: m.isUP
    }));

    const mapelApp1Info = new Map(mapelListApp1.map(m => [m.id, { isUS: m.isUS, isUP: m.isUP }]));
    
    // Ambil Guru (baca langsung)
    const sheetGuruApp1 = getGuruSheet(ss_app1);
    const guruDataApp1 = sheetGuruApp1.getDataRange().getValues();
    guruDataApp1.shift();
    const guruListApp1 = guruDataApp1.map(row => ({
      email: row[0],
      nama: row[1]
    })).filter(g => g.email && g.nama);
    
    // Ambil data Kelas dari Aplikasi 1
    const sheetKelasApp1 = getKelasSheet(ss_app1);
    const kelasDataApp1 = sheetKelasApp1.getDataRange().getValues();
    kelasDataApp1.shift(); // Hapus header
    
    // Ambil juga status 'isLocked'
    const lockedKelasSet = getLockedKelasSet(ss_app1, sessionData.sekolahID);
    
    // Ubah dari array string menjadi array objek
    const kelasListApp1 = kelasDataApp1.map(row => {
      const namaKelas = row[0];
      if (!namaKelas) return null; // Filter baris kosong
      return {
        nama: namaKelas,
        isLocked: lockedKelasSet.has(namaKelas.toUpperCase())
      };
    }).filter(kelas => kelas !== null); // Hapus baris null
    
    // 3. Ambil Data Penempatan dari Aplikasi 2
    let enrolledSiswaMap = new Map();
    let mapelAssignments = [];
    let app2SiswaMap = new Map();

    if (id_tahun_ajaran) {
      // Ambil data db_enrollment
      const sheetEnrollment = getEnrollmentSheet_App2(ss_app2);
      if (sheetEnrollment.getLastRow() > 1) {
        const dataEnroll = sheetEnrollment.getDataRange().getValues();
        dataEnroll.shift();
        dataEnroll.forEach(row => {
          // row[3] = id_tahun_ajaran, row[0] = id_enrollment (SiswaID App 1)
          if (row[3] === id_tahun_ajaran) {
            enrolledSiswaMap.set(row[0], {
              id_enrollment_app2: row[0], // Ini ID Siswa App 1
              nomor_ujian_app2: row[1], // Ini Nomor Ujian App 2
              ruang_ujian: row[4] || ''
            });
          }
        });
      }
      
      // Ambil data db_mapel
      const sheetMapelApp2 = getMapelSheet_App2(ss_app2);
      if (sheetMapelApp2.getLastRow() > 1) {
        const dataMapel = sheetMapelApp2.getDataRange().getValues();
        dataMapel.shift();
        dataMapel.forEach(row => {
          if (row[2] === id_tahun_ajaran) {
            const mapelId = row[1];
            // Ambil info isUS/isUP dari Peta (Map)
            const app1Info = mapelApp1Info.get(mapelId) || { isUS: false, isUP: false }; 

            mapelAssignments.push({
              email_guru: row[0],
              mapel: mapelId,
              singkatan: row[3] || '',
              kelas_json: row[4] || '["*"]',
              isUS: app1Info.isUS, // <-- DATA BARU
              isUP: app1Info.isUP  // <-- DATA BARU
            });
          }
        });
      }

      // Ambil data db_siswa (App 2)
      const sheetSiswaApp2 = getSiswaSheet_App2(ss_app2);
      if (sheetSiswaApp2.getLastRow() > 1) {
        const dataSiswa = sheetSiswaApp2.getDataRange().getValues();
        dataSiswa.shift();
        dataSiswa.forEach(row => {
          app2SiswaMap.set(row[0], row[1]); // Map[nomor_ujian] = nama
        });
      }
    }
    
    // 4. Gabungkan Data Siswa
    const siswaDataGabungan = siswaListApp1.map(siswaApp1 => {
      const enrollmentInfo = enrolledSiswaMap.get(siswaApp1.id);
      const isEnrolled = !!enrollmentInfo;
      const nomorUjianApp2 = isEnrolled ? enrollmentInfo.nomor_ujian_app2 : null;
      
      return {
        ...siswaApp1, // Ini sekarang akan berisi id, nama, kelas, dan nisn
        isEnrolled: isEnrolled,
        nomor_ujian_app2: nomorUjianApp2,
        nama_app2: (isEnrolled && app2SiswaMap.has(nomorUjianApp2)) ? app2SiswaMap.get(nomorUjianApp2) : null, 
        ruang_ujian: isEnrolled ? enrollmentInfo.ruang_ujian : ''
      };
    });
    
    return {
      status: "sukses",
      siswaData: siswaDataGabungan,
      mapelList: mapelListApp1,
      guruList: guruListApp1,
      kelasList: kelasListApp1, 
      mapelAssignments: mapelAssignments
    };
    
  } catch (e) {
    Logger.log(`getPenempatanData error: ${e.message}`);
    return { status: "gagal", message: e.message };
  }
}

function saveSiswaEnrollment(token, id_tahun_ajaran, enrollmentData) {
  const lock = LockService.getDocumentLock();
  lock.waitLock(30000); 
  
  try {
    const { sessionData, spreadsheetID: app1DbId } = validateAdminSession(token);
    const app2DbId = getApp2DatabaseId(token);
    const ss_app2 = SpreadsheetApp.openById(app2DbId);
    
    const sheetEnroll = getEnrollmentSheet_App2(ss_app2);
    const sheetSiswa = getSiswaSheet_App2(ss_app2);
    
    const idSekolahApp1 = sessionData.sekolahID;
    
    // Ambil data App 1 (untuk info nisn/kelas/nama)
    const siswaDataApp1 = _getSiswaInternal(app1DbId, sessionData.sekolahID);
    const siswaInfoMapApp1 = new Map(siswaDataApp1.map(s => [s.id, { nisn: s.nisn, kelas: s.kelas, nama: s.nama }]));
    
    // --- Modifikasi Batch Dimulai ---

    // 1. Baca semua data LAMA dari db_siswa
    const siswaRange = sheetSiswa.getDataRange();
    const allSiswaData = siswaRange.getValues();
    const newSiswaData = [allSiswaData[0]]; // Mulai dengan header
    const siswaApp2Map = new Map(); // Kunci: no_ujian
    if (allSiswaData.length > 1) {
      allSiswaData.slice(1).forEach(row => {
        if(row[0]) siswaApp2Map.set(String(row[0]), { nama: row[1], nisn: row[2], kelas: row[3] });
      });
    }

    // 2. Baca semua data LAMA dari db_enrollment
    const enrollRange = sheetEnroll.getDataRange();
    const allEnrollData = enrollRange.getValues();
    const newEnrollData = [allEnrollData[0]]; // Mulai dengan header
    
    // 3. Salin data T.A. LAIN ke array baru
    if (allEnrollData.length > 1) {
      allEnrollData.slice(1).forEach(row => {
        if (String(row[3]) !== id_tahun_ajaran) { // row[3] = id_tahun_ajaran
          newEnrollData.push(row);
        }
      });
    }

    // 4. Proses data BARU dari client
    for (const item of enrollmentData) {
      const infoApp1 = siswaInfoMapApp1.get(item.id_siswa_app1) || { nisn: '', kelas: '', nama: `ID ${item.id_siswa_app1}` };
      
      if (item.isEnrolled) {
        // Siswa ini dicentang (isEnrolled: true)
        
        const noUjianBaru = String(item.nomor_ujian_app2).trim();
        if (!noUjianBaru) {
          throw new Error(`Nomor Ujian untuk siswa ${infoApp1.nama} tidak boleh kosong karena dicentang.`);
        }
        
        const namaBaru = infoApp1.nama;
        const nisnBaru = infoApp1.nisn || '';
        const kelasBaru = infoApp1.kelas || '';

        // Tambahkan ke array enrollment baru
        const newId = `enroll-${new Date().getTime()}-${Math.random().toString(36).substring(2, 7)}`;
        newEnrollData.push([
          newId,
          "'" + noUjianBaru,
          idSekolahApp1,
          id_tahun_ajaran,
          item.ruang_ujian || ''
        ]);
        
        // Update/Tambah ke Peta Siswa
        siswaApp2Map.set(noUjianBaru, { nama: namaBaru, nisn: nisnBaru, kelas: kelasBaru });
      }
      // Jika item.isEnrolled == false, kita tidak melakukan apa-apa.
      // Karena kita hanya menyalin data T.A. LAIN (langkah 3),
      // siswa yang tidak dicentang otomatis tidak akan masuk ke `newEnrollData`.
    }
    
    // 5. Ubah Peta Siswa kembali menjadi array
    siswaApp2Map.forEach((data, no_ujian) => {
      newSiswaData.push(["'" + no_ujian, data.nama, "'" + data.nisn, data.kelas]);
    });

    // 6. Hapus data lama dan Tulis data baru (db_siswa)
    if (allSiswaData.length > 1) {
      siswaRange.clearContent(); // Hapus semua (termasuk header)
    }
    sheetSiswa.getRange(1, 1, newSiswaData.length, 4).setValues(newSiswaData);
    
    // 7. Hapus data lama dan Tulis data baru (db_enrollment)
    if (allEnrollData.length > 1) {
      enrollRange.clearContent(); // Hapus semua
    }
    sheetEnroll.getRange(1, 1, newEnrollData.length, 5).setValues(newEnrollData);
    
    // --- Akhir Modifikasi Batch ---
    
    SpreadsheetApp.flush(); 
    
    return { status: "sukses" };
    
  } catch (e) {
    Logger.log(`saveSiswaEnrollment error: ${e.message} \nStack: ${e.stack}`);
    return { status: "gagal", message: e.message };
  } finally {
    if (lock) lock.releaseLock();
  }
}

function saveMapelAssignment(token, id_tahun_ajaran, assignmentsToSave) {
  const lock = LockService.getDocumentLock();
  lock.waitLock(15000);
  
  try {
    const app2DbId = getApp2DatabaseId(token);
    const ss_app2 = SpreadsheetApp.openById(app2DbId);
    const sheetMapel = getMapelSheet_App2(ss_app2);
    
    if (!id_tahun_ajaran) {
      throw new Error("ID Tahun Ajaran tidak valid.");
    }
    
    let allData = [];
    if (sheetMapel.getLastRow() > 1) {
      allData = sheetMapel.getDataRange().getValues();
      allData.shift(); // Hapus header
    }
    
    // 1. Filter data: simpan data dari T.A. LAIN
    const dataLain = allData.filter(row => row[2] !== id_tahun_ajaran);
    
    // 2. Siapkan data baru
    const dataBaru = assignmentsToSave.map(item => [
      item.email_guru,
      item.mapel,
      id_tahun_ajaran,
      item.singkatan || '',
      item.kelas_json || '["*"]',
      item.isUS === true, // Kolom F (isUS)
      item.isUP === true  // Kolom G (isUP)
    ]);
    
    // 3. Gabungkan data T.A. lain dengan data baru
    const dataFinal = dataLain.concat(dataBaru);
    
    // 4. Hapus semua data (kecuali header)
    if (sheetMapel.getLastRow() > 1) {
      sheetMapel.deleteRows(2, sheetMapel.getLastRow() - 1);
    }
    
    // 5. Tulis ulang data gabungan
    if (dataFinal.length > 0) {
      // [MODIFIKASI] Mengubah jumlah kolom menjadi 7
      sheetMapel.getRange(2, 1, dataFinal.length, 7).setValues(dataFinal);
    }
    
    return { status: "sukses" };
    
  } catch (e) {
    Logger.log(`saveMapelAssignment error: ${e.message}`);
    return { status: "gagal", message: e.message };
  } finally {
    lock.releaseLock();
  }
}

// New API function: saveTahunAjaran
function saveTahunAjaran(token, dataToSave) {
  const lock = LockService.getDocumentLock(); // Gunakan lock pada DB App 2
  lock.waitLock(15000);
  
  try {
    const app2DbId = getApp2DatabaseId(token);
    const ss_app2 = SpreadsheetApp.openById(app2DbId);
    const sheet = getTahunAjaranSheet(ss_app2);
    
    // 1. Dapatkan data T.A. yang ada dan status 'isUsed'
    const currentDataResponse = getTahunAjaran(token); // Panggil fungsi internal
    if (currentDataResponse.status !== 'sukses') {
      throw new Error(currentDataResponse.message);
    }
    const currentDataMap = new Map();
    currentDataResponse.data.forEach(item => {
      currentDataMap.set(item.id, { isUsed: item.isUsed, isLocked: item.isLocked });
    });
    
    const newDataSet = new Set();
    const dataToSet = [];
    
    // 2. Validasi data baru
    for (const item of dataToSave) {
      if (!item.id || !item.deskripsi) {
        throw new Error("Data tidak valid. ID dan Deskripsi wajib diisi.");
      }
      
      const id_upper = item.id.toUpperCase();
      if (newDataSet.has(id_upper)) {
        throw new Error(`ID Tahun Ajaran duplikat: '${item.id}'. ID harus unik.`);
      }
      newDataSet.add(id_upper);
      
      const existing = currentDataMap.get(item.id);
      
      // Jika T.A. ini sudah dipakai (ada nilai/status)
      if (existing && existing.isUsed) {
        // Cek apakah user mencoba MENGUNCI T.A. yang sudah dipakai
        if (item.isLocked === true && existing.isLocked === false) {
          // Ini boleh, user sedang mengunci T.A.
        } 
        // Cek apakah user mencoba MENGUBAH ID/DESKRIPSI T.A. yang sudah dipakai
        else if (existing.isLocked === true && item.isLocked === false) {
          throw new Error(`ID '${item.id}' tidak bisa dibuka kuncinya karena sudah terpakai.`);
        }
      }
      
      dataToSet.push([item.id, item.deskripsi, item.isLocked === true]);
    }
    
    // 3. Validasi Hapus
    for (const [id, data] of currentDataMap.entries()) {
      if (data.isUsed && !newDataSet.has(id.toUpperCase())) {
        throw new Error(`Tahun Ajaran '${id}' tidak dapat dihapus karena sudah memiliki data nilai.`);
      }
    }
    
    // 4. Hapus dan Tulis Ulang
    if (sheet.getLastRow() > 1) {
      sheet.deleteRows(2, sheet.getLastRow() - 1);
    }
    
    if (dataToSet.length > 0) {
      sheet.getRange(2, 1, dataToSet.length, 3).setValues(dataToSet);
    }
    
    return { status: "sukses" };
    
  } catch (e) {
    Logger.log(`saveTahunAjaran error: ${e.message}`);
    return { status: "gagal", message: e.message };
  } finally {
    lock.releaseLock();
  }
}

/**
 * [BARU-MODIFIKASI] Mendaftarkan sekolah baru di database Aplikasi 2 (GLOBAL).
 * Fungsi ini membuka DB App 2 global dan menambahkan baris di 'db_sekolah'.
 */
function registerSchoolInApp2(sekolahID, namaSekolah) {
  try {
    const ss_app2 = SpreadsheetApp.openById(ID_SPREADSHEET_APLIKASI_2); // Buka DB App 2 Global
    const sheetSekolah_app2 = ss_app2.getSheetByName('db_sekolah');
    if (!sheetSekolah_app2) throw new Error("Sheet 'db_sekolah' di Aplikasi 2 (Global) tidak ditemukan.");

    // Cek duplikat
    const data = sheetSekolah_app2.getDataRange().getValues();
    for (let i = 1; i < data.length; i++) {
      if (data[i][0] == sekolahID) {
        Logger.log(`Sekolah ${sekolahID} sudah ada di App 2 (Global).`);
        return; 
      }
    }
    
    // Tambah data sekolah ini ke 'db_sekolah' GLOBAL
    sheetSekolah_app2.appendRow([
      sekolahID,          // id_sekolah (pakai ID dari App 1)
      namaSekolah,        // nama_sekolah
      'Belum Diatur',     // tempat_ttd (Kolom C)
      'Belum Diatur',     // kepala_sekolah (Kolom D)
      '-',                // nip_kepsek (Kolom E)
      'ID_TEMPLATE_HARUS_DIISI_MANUAL_OLEH_SA', // template_id (Kolom F)
      null,               // tanggal_sistem (Kolom G)
      '',                 // template_rekap (Kolom H)
      ''                  // pengumuman (Kolom I)
    ]);
    Logger.log(`Data sekolah ${namaSekolah} (ID: ${sekolahID}) berhasil didaftarkan di App 2 (Global).`);

  } catch (e) {
    Logger.log(`GAGAL mendaftarkan data sekolah ${namaSekolah} di App 2 (Global): ${e.message}`);
  }
}

// GANTI FUNGSI INI di aplikasi1/Kode.gs.html

/**
 * [MODIFIKASI] Mendaftarkan admin sekolah sebagai 'guru' di App 2 (GLOBAL)
 * Sekarang menyimpan HASH dan SALT.
 */
function registerAdminAsGuruInApp2(email, namaSekolah, sekolahID, plainPassword) {
  try {
    const ss_app2 = SpreadsheetApp.openById(ID_SPREADSHEET_APLIKASI_2); // Buka DB App 2 Global
    const sheetGuru_app2 = ss_app2.getSheetByName('db_guru');
    if (!sheetGuru_app2) throw new Error("Sheet 'db_guru' di Aplikasi 2 (Global) tidak ditemukan.");

    // Cek duplikat
    const data = sheetGuru_app2.getDataRange().getValues();
    for (let i = 1; i < data.length; i++) {
      if (data[i][0].toLowerCase() == email.toLowerCase()) {
        Logger.log(`Guru ${email} sudah ada di App 2 (Global).`);
        return; // Guru sudah ada
      }
    }
    
    // --- PERUBAHAN LOGIKA PENYIMPANAN ---
    const newSalt = generateSalt();
    const newHash = hashPassword(plainPassword, newSalt);
    
    // Tambah guru baru (sebagai 'guru' biasa) ke 'db_guru' GLOBAL
    sheetGuru_app2.appendRow([
      email,
      newHash,            // Kolom B (HashedPassword)
      `Admin ${namaSekolah}`, // Kolom C (Nama)
      sekolahID,          // Kolom D (id_sekolah)
      'guru',             // Kolom E (role)
      newSalt             // Kolom F (Salt)
    ]);
    // --- AKHIR PERUBAHAN ---
    
    Logger.log(`Admin ${email} berhasil didaftarkan sebagai guru di App 2 (Global).`);

  } catch (e) {
    Logger.log(`GAGAL mendaftarkan admin ${email} di App 2 (Global): ${e.message}`);
  }
}

// GANTI FUNGSI INI di aplikasi1/Kode.gs.html

/**
 * [MODIFIKASI] Helper: Menambah/Memperbarui guru di db_guru global (Aplikasi 2)
 * Sekarang menyimpan HASH, SALT, dan NIP.
 */
function addOrUpdateGuruInApp2(email, plainPassword, nama, sekolahID, role, nip) { // <-- TAMBAHKAN 'nip'
  try {
    const ss_app2 = SpreadsheetApp.openById(ID_SPREADSHEET_APLIKASI_2);
    const sheetGuru_app2 = ss_app2.getSheetByName('db_guru');
    if (!sheetGuru_app2) throw new Error("db_guru global tidak ditemukan.");
    
    const data = sheetGuru_app2.getDataRange().getValues();
    const emailLower = email.toLowerCase();
    let foundRowIndex = -1;

    // Cari baris berdasarkan email
    for (let i = 1; i < data.length; i++) {
      if (data[i][0].toLowerCase() === emailLower) {
        foundRowIndex = i + 1; // 1-based index
        break;
      }
    }
    
    // --- PERUBAHAN LOGIKA PENYIMPANAN ---
    // Selalu buat hash baru. Jika password tidak berubah, hash-nya akan sama.
    // Jika password di-reset (misal admin lupa), hash-nya akan jadi baru.
    // Jika plainPassword kosong (misal edit nama saja), kita harus ambil hash lama.
    
    let hashToSave, saltToSave;

    if (plainPassword) {
      // Jika password DIKIRIM (saat tambah baru atau reset)
      saltToSave = generateSalt();
      hashToSave = hashPassword(plainPassword, saltToSave);
    } else if (foundRowIndex > -1) {
      // Jika password TIDAK dikirim (edit nama) DAN guru sudah ada
      // Ambil hash & salt LAMA agar tidak terhapus
      hashToSave = data[foundRowIndex - 1][1]; // Kolom B
      saltToSave = data[foundRowIndex - 1][5]; // Kolom F
    } else {
      // Skenario aneh: tambah baru tanpa password. Buat password dummy.
      Logger.log(`Peringatan: addOrUpdateGuruInApp2 dipanggil untuk ${email} tanpa password. Membuat hash dummy.`);
      saltToSave = generateSalt();
      hashToSave = hashPassword("PasswordDefault123!", saltToSave);
    }

    // [MODIFIKASI] Siapkan data baris (7 kolom: A-G)
    const rowData = [
      email,
      hashToSave,            // Kolom B (HashedPassword)
      nama,                 // Kolom C (Nama)
      sekolahID,          // Kolom D (id_sekolah)
      role,                 // Kolom E (role)
      saltToSave,           // Kolom F (Salt)
      nip || ""             // <-- TAMBAHKAN NIP (Kolom G)
    ];
    // --- AKHIR PERUBAHAN ---

    if (foundRowIndex > -1) {
      // Ditemukan -> Update baris yang ada (Kolom A-G)
      sheetGuru_app2.getRange(foundRowIndex, 1, 1, 7).setValues([rowData]); // <-- UBAH KE 7
      Logger.log(`Sinkronisasi Update (App 2): Guru ${emailLower} diperbarui.`);
    } else {
      // Tidak ditemukan -> Tambah baris baru
      sheetGuru_app2.appendRow(rowData); // appendRow akan otomatis menangani 7 kolom
      Logger.log(`Sinkronisasi Tambah (App 2): Guru ${emailLower} ditambahkan.`);
    }
  } catch (e) {
    // Catat error tapi jangan gagalkan operasi utama
    Logger.log(`Peringatan: Gagal sinkronisasi 'addOrUpdateGuruInApp2' (App 2) untuk ${email}: ${e.message}`);
  }
}

/**
 * [BARU] Helper: Menghapus guru dari db_guru global (Aplikasi 2)
 * Fungsi ini akan dipanggil oleh deleteGuru.
 */
function deleteGuruFromApp2(email) {
  try {
    const ss_app2 = SpreadsheetApp.openById(ID_SPREADSHEET_APLIKASI_2);
    const sheetGuru_app2 = ss_app2.getSheetByName('db_guru');
    if (!sheetGuru_app2) throw new Error("db_guru global tidak ditemukan.");

    const data = sheetGuru_app2.getDataRange().getValues();
    const emailLower = email.toLowerCase();
    let rowsToDelete = [];

    // Loop dari BAWAH ke ATAS saat menghapus
    for (let i = data.length - 1; i >= 1; i--) { 
      if (data[i][0].toLowerCase() === emailLower) {
        rowsToDelete.push(i + 1); // 1-based index
      }
    }

    if (rowsToDelete.length > 0) {
      // Hapus baris yang ditemukan
      rowsToDelete.forEach(rowNum => sheetGuru_app2.deleteRow(rowNum));
      Logger.log(`Sinkronisasi Hapus (App 2): Guru ${emailLower} dihapus.`);
    }
  } catch (e) {
    Logger.log(`Peringatan: Gagal sinkronisasi 'deleteGuruFromApp2' (App 2) untuk ${email}: ${e.message}`);
  }
}

/**
 * [BARU] Menghasilkan template Excel untuk Penempatan Siswa.
 */
function getPenempatanTemplateData(token, kelasFilter) {
  let tempSpreadsheetId = null;
  try {
    const { sessionData, spreadsheetID } = validateAdminSession(token);
    const namaSekolah = sessionData.namaSekolah;
    
    // 1. Ambil data siswa yang sudah di-cache server
    const siswaList = _getSiswaInternal(spreadsheetID, sessionData.sekolahID);
    
    // 2. Filter berdasarkan pilihan kelas
    const filteredSiswa = (kelasFilter === 'semua') 
      ? siswaList 
      : siswaList.filter(s => s.kelas === kelasFilter);
      
    if (filteredSiswa.length === 0) {
      return { status: "gagal", message: `Tidak ada siswa di kelas '${kelasFilter}'.` };
    }
    
    // 3. Buat file Excel sementara
    const timestamp = Utilities.formatDate(new Date(), Session.getScriptTimeZone(), "yyyyMMdd_HHmmss");
    const tempFileName = `[TEMP] Template Penempatan - ${namaSekolah} - ${timestamp}`;
    const ss = SpreadsheetApp.create(tempFileName);
    tempSpreadsheetId = ss.getId();
    
    const sheet = ss.getActiveSheet();
    sheet.setName('Data Penempatan');
    
    // 4. Tulis Header
    const headers = ["Nama Siswa", "NISN", "Kelas", "Nomor Ujian (App 2)", "Ruang Ujian (App 2)"];
    sheet.getRange(1, 1, 1, headers.length).setValues([headers]).setFontWeight('bold');
    
    // 5. Tulis Data Siswa
    const dataSiswaRows = filteredSiswa.map(s => [
      s.nama, 
      "'" + s.nisn, // Paksa NISN jadi teks
      s.kelas,
      '', // Kolom Nomor Ujian (kosong)
      ''  // Kolom Ruang Ujian (kosong)
    ]);
    sheet.getRange(2, 1, dataSiswaRows.length, headers.length).setValues(dataSiswaRows);
    
    // 6. Format & Proteksi
    sheet.getRange("B:B").setNumberFormat('@'); // Format NISN sebagai Teks
    sheet.setFrozenRows(1);
    sheet.autoResizeColumns(1, headers.length);
    
    // Proteksi 3 kolom pertama
    const protection = sheet.getRange("A:C").protect();
    protection.setDescription('Data Siswa (Jangan Diubah)');
    protection.setWarningOnly(true); // Hanya beri peringatan
    
    // 7. Ekspor sebagai Base64 (menggunakan helper yang sudah ada)
    SpreadsheetApp.flush();
    const blob = generateExcelBlobFromSheet(ss); // Helper dari export ijazah
    
    const fileNameOutput = `template_penempatan_siswa_${kelasFilter}.xlsx`;
    
    return { 
      status: "sukses", 
      base64: Utilities.base64Encode(blob.getBytes()), 
      mimeType: MimeType.MICROSOFT_EXCEL, 
      fileName: fileNameOutput 
    };
    
  } catch (e) {
    return { status: "gagal", message: "Gagal membuat template: " + e.message };
  } finally {
    if (tempSpreadsheetId) DriveApp.getFileById(tempSpreadsheetId).setTrashed(true);
  }
}

// GANTI FUNGSI INI di aplikasi1/Kode.gs.html
function prosesUploadPenempatanSiswa(token, fileData, id_tahun_ajaran) {
  let tempExcelFileId = null;
  let tempConvertedSheetId = null;
  const lock = LockService.getDocumentLock(); 
  lock.waitLock(30000); 

  try {
    const { sessionData, spreadsheetID: app1DbId } = validateAdminSession(token);
    const app2DbId = getApp2DatabaseId(token);
    const ss_app2 = SpreadsheetApp.openById(app2DbId);
    const sheetEnroll = getEnrollmentSheet_App2(ss_app2);
    const sheetSiswa = getSiswaSheet_App2(ss_app2);
    const idSekolahApp1 = sessionData.sekolahID;

    // 1. Ambil data siswa App 1 (untuk validasi NISN DAN mengambil SiswaID, NISN, KELAS)
    const siswaList = _getSiswaInternal(app1DbId, sessionData.sekolahID);
    const nisnToSiswaIdMap = new Map(siswaList.map(s => [String(s.nisn), s.id]));
    // [MODIFIKASI] Ambil NAMA, NISN, KELAS dari App 1
    const siswaIdToInfoMap = new Map(siswaList.map(s => [s.id, { nama: s.nama, nisn: s.nisn, kelas: s.kelas }])); 

    // 2. Konversi file
    const { base64, mimeType, fileName } = fileData;
    const decodedData = Utilities.base64Decode(base64.split(',')[1]);
    const blob = Utilities.newBlob(decodedData, mimeType, fileName);
    const tempExcelFile = DriveApp.createFile(blob);
    tempExcelFileId = tempExcelFile.getId();
    const conversionResource = { title: `[TEMP] Upload Penempatan - ${fileName}`, mimeType: MimeType.GOOGLE_SHEETS };
    const convertedFile = Drive.Files.copy(conversionResource, tempExcelFileId, { convert: true });
    tempConvertedSheetId = convertedFile.id;
    
    // 3. Baca data Excel
    const tempSheet = SpreadsheetApp.openById(tempConvertedSheetId);
    const dataSheet = tempSheet.getSheets()[0];
    const excelData = dataSheet.getDataRange().getValues();
    if (excelData.length <= 1) throw new Error("File Excel kosong.");
    
    const headers = excelData.shift(); 
    const nisnIndex = headers.findIndex(h => h.toLowerCase().includes("nisn"));
    const noUjianIndex = headers.findIndex(h => h.toLowerCase().includes("nomor ujian"));
    const ruangIndex = headers.findIndex(h => h.toLowerCase().includes("ruang ujian"));
    if (nisnIndex === -1 || noUjianIndex === -1 || ruangIndex === -1) throw new Error("Header kolom tidak valid.");
    
    // 4. Ambil data database App 2
    const siswaApp2Map = new Map();
    if (sheetSiswa.getLastRow() > 1) {
      const siswaData = sheetSiswa.getRange(2, 1, sheetSiswa.getLastRow() - 1, 4).getValues(); // Baca 4 kolom
      siswaData.forEach((row, index) => {
         if(row[0]) siswaApp2Map.set(String(row[0]), { nama: row[1], nisn: row[2], kelas: row[3], sheetRow: index + 2 });
      });
    }
    const enrollMap = new Map();
    if (sheetEnroll.getLastRow() > 1) {
      const allEnrollData = sheetEnroll.getDataRange().getValues();
      allEnrollData.shift();
      allEnrollData.forEach((row, index) => {
        if (row[3] === id_tahun_ajaran) {
          enrollMap.set(row[0], { sheetRow: index + 2, nomor_ujian: String(row[1]), ruang_ujian: row[4] });
        }
      });
    }

    // 5. Siapkan batch
    const siswaBaruUntuk_db_siswa = new Map();
    const siswaUntukUpdate_db_siswa = []; 
    const enrollBaruUntuk_db_enroll = [];
    const enrollUntukUpdate_db_enroll = [];
    const gagalList = [];
    let berhasilCount = 0;
    
    // 6. Proses data Excel
    for (let i = 0; i < excelData.length; i++) {
      const row = excelData[i];
      const barisKe = i + 2;
      const nisn = (row[nisnIndex] ? String(row[nisnIndex]) : '').trim();
      const no_ujian_baru = (row[noUjianIndex] ? String(row[noUjianIndex]) : '').trim();
      const ruang_baru = (row[ruangIndex] ? String(row[ruangIndex]) : '').trim();

      if (!nisn) { gagalList.push({ baris: barisKe, nisn: nisn, alasan: "NISN kosong." }); continue; }
      const siswaIdApp1 = nisnToSiswaIdMap.get(nisn);
      if (!siswaIdApp1) { gagalList.push({ baris: barisKe, nisn: nisn, alasan: "NISN tidak terdaftar di data siswa App 1." }); continue; }
      if (!no_ujian_baru) { gagalList.push({ baris: barisKe, nisn: nisn, alasan: "Nomor Ujian (App 2) kosong." }); continue; }

      // [MODIFIKASI] Ambil data lengkap dari App 1
      const infoApp1 = siswaIdToInfoMap.get(siswaIdApp1);
      const namaBaru = infoApp1.nama;
      const nisnBaru = infoApp1.nisn || '';
      const kelasBaru = infoApp1.kelas || '';
      
      const existingEnroll = enrollMap.get(siswaIdApp1);

      if (existingEnroll) {
        // === UPDATE PATH ===
        const noUjianLama = String(existingEnroll.nomor_ujian);
        if (noUjianLama !== no_ujian_baru || existingEnroll.ruang_ujian !== ruang_baru) {
          enrollUntukUpdate_db_enroll.push({ row: existingEnroll.sheetRow, nomor_ujian: no_ujian_baru, ruang_ujian: ruang_baru });
        }
        const siswaLamaData = siswaApp2Map.get(noUjianLama);
        if (noUjianLama !== no_ujian_baru) {
          if (siswaLamaData) {
            siswaUntukUpdate_db_siswa.push({ row: siswaLamaData.sheetRow, no_ujian: no_ujian_baru, nama: namaBaru, nisn: nisnBaru, kelas: kelasBaru });
            siswaApp2Map.delete(noUjianLama);
            siswaApp2Map.set(no_ujian_baru, { nama: namaBaru, nisn: nisnBaru, kelas: kelasBaru, sheetRow: siswaLamaData.sheetRow });
          } else if (!siswaApp2Map.has(no_ujian_baru)) {
            siswaBaruUntuk_db_siswa.set(no_ujian_baru, { nama: namaBaru, nisn: nisnBaru, kelas: kelasBaru });
            siswaApp2Map.set(no_ujian_baru, { nama: namaBaru, nisn: nisnBaru, kelas: kelasBaru, sheetRow: -1 });
          }
        } else if (siswaLamaData && (siswaLamaData.nama !== namaBaru || siswaLamaData.nisn !== nisnBaru || siswaLamaData.kelas !== kelasBaru)) {
          siswaUntukUpdate_db_siswa.push({ row: siswaLamaData.sheetRow, no_ujian: no_ujian_baru, nama: namaBaru, nisn: nisnBaru, kelas: kelasBaru });
          siswaApp2Map.set(no_ujian_baru, { nama: namaBaru, nisn: nisnBaru, kelas: kelasBaru, sheetRow: siswaLamaData.sheetRow });
        }
      } else {
        // === INSERT PATH ===
        enrollBaruUntuk_db_enroll.push([ siswaIdApp1, no_ujian_baru, idSekolahApp1, id_tahun_ajaran, ruang_baru ]);
        if (!siswaApp2Map.has(no_ujian_baru)) {
           siswaBaruUntuk_db_siswa.set(no_ujian_baru, { nama: namaBaru, nisn: nisnBaru, kelas: kelasBaru });
           siswaApp2Map.set(no_ujian_baru, { nama: namaBaru, nisn: nisnBaru, kelas: kelasBaru, sheetRow: -1 }); 
        }
      }
      berhasilCount++;
    } // end for loop
    
    // 7. Eksekusi Batch
    enrollUntukUpdate_db_enroll.forEach(item => { sheetEnroll.getRange(item.row, 2).setValue("'" + item.nomor_ujian); sheetEnroll.getRange(item.row, 5).setValue(item.ruang_ujian); });
    
    if (enrollBaruUntuk_db_enroll.length > 0) {
      enrollBaruUntuk_db_enroll.forEach(row => row[1] = "'" + row[1]);
      sheetEnroll.getRange(sheetEnroll.getLastRow() + 1, 1, enrollBaruUntuk_db_enroll.length, 5).setValues(enrollBaruUntuk_db_enroll);
    }
    
    siswaUntukUpdate_db_siswa.forEach(item => { sheetSiswa.getRange(item.row, 1, 1, 4).setValues([["'" + item.no_ujian, item.nama, "'" + item.nisn, item.kelas]]); });
    
    const siswaBaruArray = Array.from(siswaBaruUntuk_db_siswa.entries()).map(([no_ujian, data]) => ["'" + no_ujian, data.nama, "'" + data.nisn, data.kelas]);
    if (siswaBaruArray.length > 0) {
      sheetSiswa.getRange(sheetSiswa.getLastRow() + 1, 1, siswaBaruArray.length, 4).setValues(siswaBaruArray);
    }
    
    SpreadsheetApp.flush();
    
    // 8. Hapus file sementara
    DriveApp.getFileById(tempExcelFileId).setTrashed(true);
    DriveApp.getFileById(tempConvertedSheetId).setTrashed(true);
    
    // 9. Kembalikan respons
    return {
      status: "sukses",
      totalDiProses: excelData.length,
      berhasilDisimpan: berhasilCount,
      gagalDisimpan: gagalList.length,
      dataGagal: gagalList
    };
    
  } catch (e) {
    if (tempExcelFileId) { try { DriveApp.getFileById(tempExcelFileId).setTrashed(true); } catch (err) {} }
    if (tempConvertedSheetId) { try { DriveApp.getFileById(tempConvertedSheetId).setTrashed(true); } catch (err) {} }
    return { status: "gagal", message: "Terjadi error: " + e.message };
  } finally {
    if (lock) lock.releaseLock();
  }
}

/**
 * [UTILITAS PERBAIKAN]
 * Jalankan fungsi ini SATU KALI SECARA MANUAL dari editor Apps Script
 * untuk memperbaiki sekolah yang dibuat oleh Superadmin (Kolom M kosong).
 */
function PERBAIKI_SEKOLAH_ADMIN_LAMA() {
  const lock = LockService.getScriptLock();
  lock.waitLock(30000);
  try {
    const masterSS = SpreadsheetApp.openById(MASTER_SHEET_ID);
    const sheetSekolah = masterSS.getSheetByName('Sheet_Sekolah');
    // Pastikan membaca sampai Kolom M (13 kolom)
    const dataRange = sheetSekolah.getRange("A2:M" + sheetSekolah.getLastRow());
    const data = dataRange.getValues();
    let perbaikanDilakukan = 0;

    for (let i = 0; i < data.length; i++) {
      const row = data[i];
      const sekolahID = row[0]; // Kolom A
      const namaSekolah = row[1]; // Kolom B
      const emailAdmin = row[3]; // Kolom D
      const app2DbId = row[12]; // Kolom M
      
      // Jika Kolom M kosong DAN ada SekolahID
      if (sekolahID && namaSekolah && !app2DbId) {
        Logger.log(`Memperbaiki ${namaSekolah} (ID: ${sekolahID})...`);
        
        // 1. Buat DB App 2 baru
        const newSSID_App2 = buatDatabaseAplikasi2Baru(namaSekolah.toUpperCase());
        
        // 2. Tulis ID baru ke Kolom M
        // i + 2 (karena data 0-based dan sheet 1-based + 1 header)
        // 13 (karena Kolom M adalah kolom ke-13)
        sheetSekolah.getRange(i + 2, 13).setValue(newSSID_App2);
        
        // 3. Daftarkan ke Global App 2
        // Kita tidak punya plain password. Admin sekolah ini harus diinfokan
        // untuk "lupa password" atau Superadmin harus mengeditnya manual.
        // Kita daftarkan dengan password acak/dummy agar datanya ada.
        const dummyPassword = "GANTI_PASSWORD_" + Math.random().toString(36).substring(2, 8);
        
        registerSchoolInApp2(sekolahID, namaSekolah.toUpperCase());
        registerAdminAsGuruInApp2(emailAdmin, namaSekolah.toUpperCase(), sekolahID, dummyPassword);
        
        Logger.log(`   -> DB App 2 Dibuat: ${newSSID_App2}`);
        Logger.log(`   -> Terdaftar di Global (password: ${dummyPassword})`);
        perbaikanDilakukan++;
      }
    }
    
    clearMasterSheetCache();
    SpreadsheetApp.flush();
    
    if (perbaikanDilakukan > 0) {
      Browser.msgBox(`Perbaikan Selesai. ${perbaikanDilakukan} sekolah telah diperbarui dengan database Aplikasi 2. Admin dari sekolah tersebut mungkin perlu me-reset password mereka (via Superadmin Edit) jika login guru gagal.`);
    } else {
      Browser.msgBox("Pemeriksaan Selesai. Tidak ada sekolah dengan Kolom M kosong yang ditemukan.");
    }
    
  } catch (e) {
    Logger.log(`Error saat perbaikan: ${e.message}`);
    Browser.msgBox(`Error: ${e.message}`);
  } finally {
    lock.releaseLock();
  }
}

/**
 * [HELPER BARU] Mengubah blob gambar menjadi Data URL Base64.
 * Ini adalah perbaikan untuk bug preview kop surat.
 */
function _getImageAsBase64DataUrl(fileId) {
  try {
    if (!fileId) return null;
    const file = DriveApp.getFileById(fileId);
    const blob = file.getBlob();
    const contentType = blob.getContentType();
    
    // Pastikan ini adalah gambar
    if (!contentType || !contentType.startsWith('image/')) {
      Logger.log(`File ID ${fileId} bukan gambar, tapi ${contentType}.`);
      return null;
    }
    
    const base64Data = Utilities.base64Encode(blob.getBytes());
    return `data:${contentType};base64,${base64Data}`;
    
  } catch (e) {
    Logger.log(`Gagal mengonversi gambar (ID: ${fileId}) ke Base64. Error: ${e.message}`);
    return null; // Gagal, kembalikan null
  }
}

// GANTI FUNGSI INI di aplikasi1/Kode.gs.html

function getPengaturanCetak(token) {
  try {
    const { sessionData } = validateAdminSession(token);
    const masterSS = SpreadsheetApp.openById(MASTER_SHEET_ID);
    const sheetSekolah = masterSS.getSheetByName('Sheet_Sekolah');
    const data = sheetSekolah.getDataRange().getValues();

    // --- [MODIFIKASI] Ambil Konfigurasi Default ---
    const config = getMasterConfig();
    // --- [AKHIR MODIFIKASI] ---

    let pengaturan = {
      tanggalCetak: "",
      kopSuratFileId: null,
      kopSuratUrl: null, 
      tempatTTD: "",
      tanggalTtdMode: "otomatis",
      // --- [MODIFIKASI] Tambahkan field baru ---
      templateDocID: config.DEFAULT_TEMPLATE_DOC_ID || "",
      templateRekapID: config.DEFAULT_TEMPLATE_REKAP_ID || "",
      defaultTemplateDocID: config.DEFAULT_TEMPLATE_DOC_ID || "",
      defaultTemplateRekapID: config.DEFAULT_TEMPLATE_REKAP_ID || "",
      exampleLinkDoc: config.EXAMPLE_LINK_TEMPLATE_DOC || "#",
      exampleLinkRekap: config.EXAMPLE_LINK_TEMPLATE_REKAP || "#"
      // --- [AKHIR MODIFIKASI] ---
    };

    // Cari baris sekolah
    for (let i = 1; i < data.length; i++) {
      if (data[i][0] === sessionData.sekolahID) {
        
        const tanggal = data[i][16]; // Kolom Q
        if (tanggal instanceof Date) {
          pengaturan.tanggalCetak = Utilities.formatDate(tanggal, Session.getScriptTimeZone(), "yyyy-MM-dd");
        }
        
        pengaturan.tempatTTD = data[i][19] || ""; // Kolom T
        pengaturan.tanggalTtdMode = data[i][20] || "otomatis"; // Kolom U

        // --- [MODIFIKASI] Baca ID Template Kustom ---
        pengaturan.templateDocID = data[i][17] || config.DEFAULT_TEMPLATE_DOC_ID || ""; // Kolom R
        pengaturan.templateRekapID = data[i][18] || config.DEFAULT_TEMPLATE_REKAP_ID || ""; // Kolom S
        // --- [AKHIR MODIFIKASI] ---

        const fileId = data[i][15]; // Kolom P
        if (fileId) {
          pengaturan.kopSuratFileId = fileId;
          try {
            pengaturan.kopSuratUrl = _getImageAsBase64DataUrl(fileId);
          } catch (e) {
            Logger.log("Gagal mendapatkan URL Kop Surat: " + e.message);
          }
        }
        break;
      }
    }
    return { status: "sukses", data: pengaturan };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

// GANTI FUNGSI INI di aplikasi1/Kode.gs.html

function savePengaturanCetak(token, tanggalCetak, fileData, tempatTTD, tanggalTtdMode, templateDocID, templateRekapID) {
  const lock = LockService.getScriptLock();
  lock.waitLock(15000);
  try {
    const { sessionData } = validateAdminSession(token);
    
    // Validasi Sisi Server
    if (!tempatTTD || tempatTTD.trim().length === 0) {
      throw new Error("Tempat Tanda Tangan wajib diisi.");
    }
    if (tanggalTtdMode === 'manual' && !tanggalCetak) {
      throw new Error("Tanggal Tanda Tangan wajib diisi jika mode 'Manual' dipilih.");
    }
    if (tanggalTtdMode !== 'manual' && tanggalTtdMode !== 'otomatis') {
      throw new Error("Mode tanggal tidak valid.");
    }

    const masterSS = SpreadsheetApp.openById(MASTER_SHEET_ID);
    const sheetSekolah = masterSS.getSheetByName('Sheet_Sekolah');
    const data = sheetSekolah.getDataRange().getValues();

    // --- [MODIFIKASI] Ambil Konfigurasi Default ---
    const config = getMasterConfig();
    // --- [AKHIR MODIFIKASI] ---

    let rowToUpdate = -1;
    let mainFolderId = null;
    let oldFileId = null;
    let donasiStatus = "NONE"; // <-- [BARU]

    // 1. Cari baris dan data folder
    for (let i = 1; i < data.length; i++) {
      if (data[i][0] === sessionData.sekolahID) {
        rowToUpdate = i + 1;
        donasiStatus = data[i][8] || "NONE"; // Kolom I <-- [BARU]
        mainFolderId = data[i][13]; // Kolom N
        oldFileId = data[i][15];   // Kolom P
        break;
      }
    }
    if (rowToUpdate === -1) throw new Error("Data sekolah tidak ditemukan.");
    if (!mainFolderId) throw new Error("Folder utama (MainFolderID) sekolah tidak terdaftar.");

    const folder = DriveApp.getFolderById(mainFolderId);
    let newFileId = oldFileId;
    let newFileUrl = null; 

    // 2. Proses file jika ada
    if (fileData) {
      if (fileData.base64) {
        if (oldFileId) {
          try { DriveApp.getFileById(oldFileId).setTrashed(true); } catch(e) {}
        }
        const decodedData = Utilities.base64Decode(fileData.base64.split(',')[1]);
        const blob = Utilities.newBlob(decodedData, fileData.mimeType, `KOP_SURAT - ${sessionData.namaSekolah}`);
        const newFile = folder.createFile(blob);
        newFileId = newFile.getId();
        newFileUrl = _getImageAsBase64DataUrl(newFileId);
        
      } else if (fileData.delete === true) {
        if (oldFileId) {
          try { DriveApp.getFileById(oldFileId).setTrashed(true); } catch(e) {}
        }
        newFileId = null;
        newFileUrl = null;
      }
    }

    // 3. Update Sheet_Sekolah
    const formattedDate = (tanggalTtdMode === 'manual' && tanggalCetak) ? new Date(tanggalCetak) : null;
    
    // --- [MODIFIKASI] Validasi Status Donasi ---
    if (donasiStatus === "APPROVED") {
      // Premium: Simpan ID kustom (atau default jika dikosongkan)
      sheetSekolah.getRange(rowToUpdate, 18).setValue(templateDocID || config.DEFAULT_TEMPLATE_DOC_ID);     // Kolom R (TemplateDocID)
      sheetSekolah.getRange(rowToUpdate, 19).setValue(templateRekapID || config.DEFAULT_TEMPLATE_REKAP_ID); // Kolom S (TemplateRekapID)
    } else {
      // Non-Premium: Paksa simpan ID default, abaikan input user
      sheetSekolah.getRange(rowToUpdate, 18).setValue(config.DEFAULT_TEMPLATE_DOC_ID);
      sheetSekolah.getRange(rowToUpdate, 19).setValue(config.DEFAULT_TEMPLATE_REKAP_ID);
    }
    // --- [AKHIR MODIFIKASI] ---
    
    sheetSekolah.getRange(rowToUpdate, 16).setValue(newFileId);     // Kolom P (KopSuratFileID)
    sheetSekolah.getRange(rowToUpdate, 17).setValue(formattedDate); // Kolom Q (TanggalCetak)
    sheetSekolah.getRange(rowToUpdate, 20).setValue(tempatTTD);     // Kolom T (TempatTTD)
    sheetSekolah.getRange(rowToUpdate, 21).setValue(tanggalTtdMode); // Kolom U (TanggalTtdMode)

    clearMasterSheetCache(); 

    if (fileData && !fileData.base64 && !fileData.delete && !newFileUrl && newFileId) {
      newFileUrl = _getImageAsBase64DataUrl(newFileId);
    }

    return { status: "sukses", message: "Pengaturan berhasil disimpan.", newUrl: newFileUrl };

  } catch (e) {
    Logger.log("Gagal savePengaturanCetak: " + e.message);
    return { status: "gagal", message: e.message };
  } finally {
    lock.releaseLock();
  }
}

/**
 * [UTILITAS PERBAIKAN]
 * Jalankan fungsi ini SATU KALI SECARA MANUAL dari editor Apps Script
 * untuk menambahkan kolom TemplateDocID (R), TemplateRekapID (S), TempatTTD (T), dan TanggalTtdMode (U).
 */
function _PERBAIKI_HEADER_SHEET_SEKOLAH() {
  try {
    const masterSS = SpreadsheetApp.openById(MASTER_SHEET_ID);
    const sheet = masterSS.getSheetByName('Sheet_Sekolah');
    if (!sheet) {
      throw new Error("Sheet_Sekolah tidak ditemukan.");
    }

    const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];

    let headerR_OK = false;
    let headerS_OK = false;
    let headerT_OK = false;
    let headerU_OK = false; // <-- TAMBAHKAN INI

    if (headers[17]) { // Index 17 (Kolom R)
      if (headers[17] == "TemplateDocID") {
        headerR_OK = true;
      }
    }
    if (headers[18]) { // Index 18 (Kolom S)
      if (headers[18] == "TemplateRekapID") {
        headerS_OK = true;
      }
    }
    if (headers[19]) { // Index 19 (Kolom T)
      if (headers[19] == "TempatTTD") {
        headerT_OK = true;
      }
    }
    if (headers[20]) { // Index 20 (Kolom U) <-- TAMBAHKAN BLOK INI
      if (headers[20] == "TanggalTtdMode") {
        headerU_OK = true;
      }
    }

    if (headerR_OK && headerS_OK && headerT_OK && headerU_OK) { // <-- TAMBAHKAN INI
       Browser.msgBox("Header sudah lengkap (R, S, T, U sudah ada). Tidak ada perubahan.");
       return;
    }

    if (!headerR_OK) {
       sheet.getRange(1, 18).setValue("TemplateDocID"); // Kolom R
    }
    if (!headerS_OK) {
       sheet.getRange(1, 19).setValue("TemplateRekapID"); // Kolom S
    }
    if (!headerT_OK) {
       sheet.getRange(1, 20).setValue("TempatTTD"); // Kolom T
    }
    if (!headerU_OK) { // <-- TAMBAHKAN BLOK INI
       sheet.getRange(1, 21).setValue("TanggalTtdMode"); // Kolom U
    }

    Browser.msgBox("BERHASIL! Header 'TemplateDocID' (R), 'TemplateRekapID' (S), 'TempatTTD' (T), dan 'TanggalTtdMode' (U) telah ditambahkan.");

  } catch (e) {
    Logger.log("Gagal menjalankan _PERBAIKI_HEADER_SHEET_SEKOLAH: " + e.message);
    Browser.msgBox("Gagal: " + e.message);
  }
}

// -----------------------------------------------------------------------------
// --- TAMBAHKAN FUNGSI BARU DI BAWAH INI (UNTUK MEMPERBAIKI PERIZINAN) ---
// -----------------------------------------------------------------------------

/**
 * [FUNGSI PERBAIKAN PERIZINAN]
 * Jalankan fungsi ini SATU KALI untuk memberikan izin Google Docs pada skrip.
 */
function _AKTIFKAN_PERIZINAN_DOKUMEN() {
  try {
    // Baris ini akan memicu permintaan izin Google Docs
    const doc = DocumentApp.create("Template Izin - Hapus Saja Nanti");
    const docId = doc.getId();
    DriveApp.getFileById(docId).setTrashed(true); // Langsung hapus
    
    Logger.log("Izin Dokumen berhasil diminta dan file sementara dihapus.");
    Browser.msgBox("BERHASIL!", "Izin Google Documents telah berhasil diaktifkan. Anda sekarang dapat melanjutkan ke Langkah 2.", Browser.Buttons.OK);
  } catch (e) {
    Logger.log("Gagal mengaktifkan izin: " + e.message);
    Browser.msgBox("Gagal: " + e.message + ". Pastikan Anda mengklik 'Allow' pada pop-up izin.");
  }
}

// GANTI FUNGSI INI di aplikasi1/Kode.gs.html

/**
 * [MODIFIKASI] Mengambil konfigurasi default dari sheet Master_Config.
 * Menggunakan cache untuk performa dan menambahkan logging jika key tidak ditemukan.
 */
function getMasterConfig() {
  const cache = CacheService.getScriptCache();
  const CACHE_KEY = 'MASTER_CONFIG_V1';
  
  let cachedConfig = cache.get(CACHE_KEY);
  if (cachedConfig != null) {
    return JSON.parse(cachedConfig);
  }
  
  Logger.log("CACHE MISS: getMasterConfig (Membaca dari Master Sheet...)");
  
  try {
    const masterSS = SpreadsheetApp.openById(MASTER_SHEET_ID);
    const configSheet = masterSS.getSheetByName('Master_Config');
    if (!configSheet) {
      Logger.log("Error: Sheet 'Master_Config' tidak ditemukan.");
      return {};
    }
    
    const data = configSheet.getRange(2, 1, configSheet.getLastRow() - 1, 2).getValues();
    const config = {};
    
    data.forEach(row => {
      if (row[0]) {
        config[row[0]] = row[1];
      }
    });
    
    // --- [TAMBAHAN] Pengecekan Kunci ---
    const expectedKeys = [
      'DEFAULT_TEMPLATE_DOC_ID',
      'DEFAULT_TEMPLATE_REKAP_ID',
      'EXAMPLE_LINK_TEMPLATE_DOC',
      'EXAMPLE_LINK_TEMPLATE_REKAP'
    ];
    
    expectedKeys.forEach(key => {
      if (!config[key]) {
        Logger.log(`Peringatan (Master_Config): Key '${key}' tidak ditemukan atau nilainya kosong di Kolom B.`);
      }
    });
    // --- [AKHIR TAMBAHAN] ---
    
    cache.put(CACHE_KEY, JSON.stringify(config), 21600); // Cache 6 jam
    return config;
    
  } catch (e) {
    Logger.log("Gagal total mengambil getMasterConfig: " + e.message);
    return {}; // Kembalikan objek kosong jika gagal
  }
}

/**
 * [FUNGSI PERBAIKAN SEMENTARA]
 * Jalankan fungsi ini SATU KALI SECARA MANUAL dari editor Apps Script
 * untuk membersihkan cache Master_Config yang macet.
 */
function HAPUS_CACHE_CONFIG_MANUAL() {
  try {
    const cache = CacheService.getScriptCache();
    cache.remove('MASTER_CONFIG_V1'); // Hapus cache yang salah
    Logger.log("BERHASIL: Cache 'MASTER_CONFIG_V1' telah dihapus.");
    Browser.msgBox("BERHASIL!", "Cache 'MASTER_CONFIG_V1' telah dihapus. Silakan refresh dan coba lagi tombol 'Reset' di aplikasi.", Browser.Buttons.OK);
  } catch (e) {
    Logger.log("Gagal hapus cache: " + e.message);
    Browser.msgBox("Gagal: " + e.message);
  }
}

// TAMBAHKAN FUNGSI INI di aplikasi2/Kode.gs.html

/**
 * [FUNGSI PERBAIKAN MANUAL]
 * Jalankan fungsi ini SATU KALI SECARA MANUAL dari editor Apps Script
 * untuk menambahkan kolom "NIP" (Kolom G) ke sheet 'db_guru' di Aplikasi 2.
 */
function _MIGRASI_TambahKolomNIPGuru() {
  try {
    const ss = SpreadsheetApp.openById(ID_SPREADSHEET_APLIKASI_2); // Buka DB Global
    const sheet = ss.getSheetByName('db_guru');
    if (!sheet) {
      Logger.log("Sheet 'db_guru' tidak ditemukan. Batal.");
      Browser.msgBox("Sheet 'db_guru' tidak ditemukan. Batal.");
      return;
    }

    const header = sheet.getRange(1, 7).getValue(); // Cek Kolom G

    if (header === "NIP") {
      Logger.log("Kolom 'NIP' sudah ada di Kolom G.");
      Browser.msgBox("Kolom 'NIP' sudah ada di Kolom G. Tidak ada perubahan.");
      return;
    }
    
    // Cek apakah kolom G kosong (atau header lain yang salah)
    if (header === "") {
      // Kolom G kosong, cukup tambahkan header
      sheet.getRange(1, 7).setValue("NIP");
      Logger.log("BERHASIL! Header 'NIP' ditambahkan ke Kolom G.");
      Browser.msgBox("BERHASIL! Header 'NIP' ditambahkan ke Kolom G.");
    } else {
      // Kolom G terisi data lain (seharusnya tidak terjadi, tapi untuk keamanan)
      sheet.insertColumnAfter(6); // Sisipkan kolom baru setelah F (Salt)
      sheet.getRange(1, 7).setValue("NIP"); // Set header di Kolom G baru
      Logger.log("BERHASIL! Kolom baru 'NIP' disisipkan di Kolom G.");
      Browser.msgBox("BERHASIL! Kolom baru 'NIP' disisipkan di Kolom G.");
    }
    
  } catch (e) {
    Logger.log("Gagal migrasi 'db_guru': " + e.message);
    Browser.msgBox("Gagal migrasi 'db_guru': " + e.message);
  }
}

function getPendingTeacherScores(token) {
  try {
    const { app2DbId, sekolahID } = validateAdminSession(token);
    const ss_app2 = SpreadsheetApp.openById(app2DbId);

    const statusSheet = ss_app2.getSheetByName('db_status_kirim');
    if (!statusSheet) {
      return { status: "sukses", pendingScores: [] };
    }

    const guruMap = new Map();
    try {
      const ss_app2_global = SpreadsheetApp.openById(ID_SPREADSHEET_APLIKASI_2);
      const guruSheetGlobal = ss_app2_global.getSheetByName('db_guru');
      const guruDataGlobal = guruSheetGlobal.getDataRange().getValues().slice(1);
      guruDataGlobal.forEach(row => {
        if (row[3] == sekolahID) {
          guruMap.set(row[0].toLowerCase(), row[2]);
        }
      });
    } catch (e) {
      Logger.log("Gagal mengambil nama guru global: " + e.message);
    }
    
    const taMap = new Map();
    try {
      const taSheet = ss_app2.getSheetByName('db_tahun_ajaran');
      const taData = taSheet.getDataRange().getValues().slice(1);
      taData.forEach(row => taMap.set(row[0], row[1]));
    } catch (e) {
      Logger.log("Gagal mengambil nama TA: " + e.message);
    }

    const statusData = statusSheet.getDataRange().getValues().slice(1);
    const pendingScores = [];
    
    statusData.forEach(row => {
      const status = row[6];
      if (status === "PENDING") {
        const email = row[2].toLowerCase();
        pendingScores.push({
          key: row[0],
          id_ta: row[1],
          email_guru: row[2],
          nama_mapel: row[3],
          timestamp_kirim: row[4] instanceof Date ? row[4].toISOString() : row[4],
          nama_guru: guruMap.get(email) || email,
          deskripsi_ta: taMap.get(row[1]) || row[1]
        });
      }
    });

    return { status: "sukses", pendingScores: pendingScores };

  } catch (e) {
    Logger.log("getPendingTeacherScores Error: " + e.message);
    return { status: "gagal", message: e.message };
  }
}

function approveTeacherScore(token, submissionKey) {
  const lock = LockService.getDocumentLock();
  lock.waitLock(30000); 
  
  let app1DbId, app2DbId, sekolahID, spreadsheetID;

  try {
    const session = validateAdminSession(token);
    app1DbId = session.spreadsheetID;
    app2DbId = session.app2DbId;
    sekolahID = session.sekolahID;
    spreadsheetID = session.spreadsheetID;
    
    const ss_app1 = SpreadsheetApp.openById(app1DbId);
    const ss_app2 = SpreadsheetApp.openById(app2DbId);

    const statusSheetApp2 = getStatusKirimSheet(ss_app2);
    const statusDataApp2 = statusSheetApp2.getDataRange().getValues();
    
    let statusRowIndex = -1;
    let id_ta_app2, email_guru, nama_mapel_app2;
    
    for (let i = 1; i < statusDataApp2.length; i++) {
      if (statusDataApp2[i][0] === submissionKey) {
        if (statusDataApp2[i][6] !== "PENDING") {
          throw new Error("Status nilai ini bukan 'PENDING'. Mungkin sudah diproses.");
        }
        statusRowIndex = i + 1;
        id_ta_app2 = statusDataApp2[i][1];
        email_guru = statusDataApp2[i][2];
        nama_mapel_app2 = statusDataApp2[i][3];
        break;
      }
    }

    if (statusRowIndex === -1) {
      throw new Error("Data pengiriman tidak ditemukan. Mungkin sudah diproses.");
    }
    
    const sheetMapelApp1 = getMapelSheet(ss_app1);
    const dataMapelApp1 = sheetMapelApp1.getDataRange().getValues().slice(1);
    let mapelIdApp1 = null;
    let mapelInfoApp1 = null;
    
    for (const row of dataMapelApp1) {
      if (row[1] === nama_mapel_app2) {
        mapelIdApp1 = row[0];
        mapelInfoApp1 = { isUS: row[2] === true, isUP: row[3] === true };
        break;
      }
    }
    
    if (!mapelIdApp1) {
      throw new Error(`Mata pelajaran "${nama_mapel_app2}" tidak ditemukan di 'Mapel' Aplikasi 1. Pastikan nama mapel sama persis.`);
    }

    const enrollmentSheetApp2 = getEnrollmentSheet_App2(ss_app2);
    const enrollDataApp2 = enrollmentSheetApp2.getDataRange().getValues().slice(1);
    const enrollmentMap = new Map();
    enrollDataApp2.forEach(row => {
      if (row[3] === id_ta_app2) {
        enrollmentMap.set(String(row[1]), row[0]);
      }
    });
    
    if (enrollmentMap.size === 0) {
      throw new Error("Tidak ada siswa terdaftar (enrolled) di T.A. ini di Aplikasi 2.");
    }

    const taSheet_App2 = getTahunAjaranSheet(ss_app2);
    const taData_App2 = taSheet_App2.getDataRange().getValues().slice(1);
    const taMap = new Map(taData_App2.map(row => [row[0], row[1]]));
    const taDeskripsi = taMap.get(id_ta_app2);

    if (!taDeskripsi) {
      throw new Error(`Deskripsi Tahun Ajaran untuk ID '${id_ta_app2}' tidak ditemukan.`);
    }
    
    const nilaiSheetName = `db_nilai_${taDeskripsi.replace('/', '-')}`;
    const nilaiSheetApp2 = ss_app2.getSheetByName(nilaiSheetName);
    if (!nilaiSheetApp2) {
      throw new Error(`Sheet nilai '${nilaiSheetName}' tidak ditemukan di Aplikasi 2.`);
    }
    
    const nilaiDataApp2 = nilaiSheetApp2.getDataRange().getValues().slice(1);
    const nilaiMapApp2 = new Map();
    nilaiDataApp2.forEach(row => {
      if (row[2] === nama_mapel_app2) {
        nilaiMapApp2.set(String(row[1]), { ujian: row[3], praktek: row[4] });
      }
    });
    
    // --- Modifikasi Batch Dimulai ---
    
    const sheetNilaiApp1 = getNilaiUjianSheet(ss_app1);
    const rangeApp1 = sheetNilaiApp1.getDataRange();
    const valuesApp1 = rangeApp1.getValues(); // Baca semua data App 1 SEKALI
    
    // Buat Peta: "SiswaID_MapelID" -> index baris 0-based
    const nilaiApp1Map = new Map();
    for (let i = 1; i < valuesApp1.length; i++) { // Mulai dari 1 (skip header)
      const key = `${valuesApp1[i][0]}_${valuesApp1[i][1]}`;
      nilaiApp1Map.set(key, i); // Simpan 0-based index
    }
    
    const rowsToAppendApp1 = [];
    let copyCount = 0;
    
    for (const [nomor_ujian_app2, id_siswa_app1] of enrollmentMap.entries()) {
      const scores_app2 = nilaiMapApp2.get(nomor_ujian_app2) || { ujian: null, praktek: null };
      
      const umToSave = (mapelInfoApp1.isUS && scores_app2.ujian !== null && scores_app2.ujian !== undefined) ? scores_app2.ujian : null;
      const upToSave = (mapelInfoApp1.isUP && scores_app2.praktek !== null && scores_app2.praktek !== undefined) ? scores_app2.praktek : null;

      if (umToSave !== null || upToSave !== null) {
        copyCount++;
        
        const key = `${id_siswa_app1}_${mapelIdApp1}`;
        const existingRowIndex_0based = nilaiApp1Map.get(key);
        
        if (existingRowIndex_0based !== undefined) {
          // === UPDATE ===
          // Modifikasi array di memori
          valuesApp1[existingRowIndex_0based][2] = umToSave; // Kolom C (UjianMadrasah)
          valuesApp1[existingRowIndex_0based][3] = upToSave; // Kolom D (UjianPraktek)
        } else {
          // === INSERT ===
          // Kumpulkan di array baru
          rowsToAppendApp1.push([id_siswa_app1, mapelIdApp1, umToSave, upToSave]);
          // Tambahkan ke map agar tidak duplikat
          nilaiApp1Map.set(key, valuesApp1.length + rowsToAppendApp1.length - 1);
        }
      }
    }

    // Tulis semua perubahan sekaligus
    rangeApp1.setValues(valuesApp1); 
    
    if (rowsToAppendApp1.length > 0) {
      sheetNilaiApp1.getRange(sheetNilaiApp1.getLastRow() + 1, 1, rowsToAppendApp1.length, 4)
                   .setValues(rowsToAppendApp1);
    }
    // --- Akhir Modifikasi Batch ---

    statusSheetApp2.getRange(statusRowIndex, 7).setValue("APPROVED");
    statusSheetApp2.getRange(statusRowIndex, 8).setValue("");
    
    clearNilaiUjianCache(sekolahID, spreadsheetID); // <--- Kirim spreadsheetID
    CacheService.getScriptCache().put('IJAZAH_IS_DIRTY_' + sekolahID, 'true');

    return { status: "sukses", message: `Berhasil disetujui. ${copyCount} data nilai siswa disalin ke Nilai_Ujian.` };

  } catch (e) {
    Logger.log("approveTeacherScore Error: " + e.message + "\n" + e.stack);
    return { status: "gagal", message: e.message };
  } finally {
    lock.releaseLock();
  }
}

function rejectTeacherScore(token, submissionKey, reason) {
  const lock = LockService.getScriptLock();
  lock.waitLock(15000); 
  
  try {
    const { app2DbId } = validateAdminSession(token);
    const ss_app2 = SpreadsheetApp.openById(app2DbId);

    const statusSheetApp2 = ss_app2.getSheetByName('db_status_kirim');
    const statusDataApp2 = statusSheetApp2.getDataRange().getValues();
    
    let statusRowIndex = -1;
    for (let i = 1; i < statusDataApp2.length; i++) {
      if (statusDataApp2[i][0] === submissionKey) {
        if (statusDataApp2[i][6] !== "PENDING") {
          throw new Error("Status nilai ini bukan 'PENDING'. Mungkin sudah diproses.");
        }
        statusRowIndex = i + 1;
        break;
      }
    }

    if (statusRowIndex === -1) {
      throw new Error("Data pengiriman tidak ditemukan. Mungkin sudah diproses.");
    }
    
    if (!reason || reason.trim() === "") {
      throw new Error("Alasan penolakan wajib diisi.");
    }

    statusSheetApp2.getRange(statusRowIndex, 7).setValue("REJECTED");
    statusSheetApp2.getRange(statusRowIndex, 8).setValue(reason);
    
    return { status: "sukses", message: "Nilai berhasil ditolak dan notifikasi dikirim ke guru." };

  } catch (e) {
    Logger.log("rejectTeacherScore Error: " + e.message);
    return { status: "gagal", message: e.message };
  } finally {
    lock.releaseLock();
  }
}

function getTeacherSubmittedScores(token, submissionKey) {
  try {
    const { app2DbId, sekolahID } = validateAdminSession(token);
    const ss_app2 = SpreadsheetApp.openById(app2DbId);

    // 1. Get submission details from db_status_kirim
    const statusSheetApp2 = getStatusKirimSheet(ss_app2);
    const statusDataApp2 = statusSheetApp2.getDataRange().getValues();
    
    let id_ta_app2, email_guru, nama_mapel_app2;
    let found = false;
    for (let i = 1; i < statusDataApp2.length; i++) {
      if (statusDataApp2[i][0] === submissionKey) {
        id_ta_app2 = statusDataApp2[i][1];
        email_guru = statusDataApp2[i][2];
        nama_mapel_app2 = statusDataApp2[i][3];
        found = true;
        break;
      }
    }
    if (!found) throw new Error("Data pengiriman tidak ditemukan.");

    // 2. Get Mapel Info (isUS/isUP) from db_mapel (App 2)
    const sheetMapelApp2 = getMapelSheet_App2(ss_app2);
    const mapelDataApp2 = sheetMapelApp2.getDataRange().getValues().slice(1);
    let mapelInfo = null;
    for (const row of mapelDataApp2) {
      if (row[2] === id_ta_app2 && row[1] === nama_mapel_app2 && row[0].toLowerCase() === email_guru.toLowerCase()) {
        mapelInfo = { isUS: row[5] === true, isUP: row[6] === true };
        break;
      }
    }
    if (!mapelInfo) throw new Error("Info mapel (isUS/isUP) tidak ditemukan di db_mapel Aplikasi 2.");

    // 3. Get Student List for this TA
    // 3a. Get db_siswa (App 2)
    const sheetSiswaApp2 = getSiswaSheet_App2(ss_app2);
    const siswaDataApp2 = sheetSiswaApp2.getDataRange().getValues().slice(1);
    const siswaMap = new Map(siswaDataApp2.map(row => [row[0], { nama: row[1], kelas: row[3] || 'N/A' }])); // no_ujian -> {nama, kelas}
    
    // 3b. Get db_enrollment (App 2)
    const sheetEnrollment = getEnrollmentSheet_App2(ss_app2);
    const enrollDataApp2 = sheetEnrollment.getDataRange().getValues().slice(1);
    const enrolledSiswa = [];
    
    enrollDataApp2.forEach(row => {
      if (row[3] === id_ta_app2) { // row[3] = id_ta
        const no_ujian = String(row[1]);
        const siswaDetail = siswaMap.get(no_ujian);
        if (siswaDetail) {
          enrolledSiswa.push({
            no_ujian: no_ujian,
            nama: siswaDetail.nama,
            kelas: siswaDetail.kelas
          });
        }
      }
    });
    
    const allKelas = Array.from(new Set(enrolledSiswa.map(s => s.kelas)));
    
    // 4. Get Scores from db_nilai_... (App 2)
    const taSheet_App2 = getTahunAjaranSheet(ss_app2);
    const taData_App2 = taSheet_App2.getDataRange().getValues().slice(1);
    const taMap_App2 = new Map(taData_App2.map(row => [row[0], row[1]]));
    const taDeskripsi = taMap_App2.get(id_ta_app2);
    if (!taDeskripsi) throw new Error("Deskripsi Tahun Ajaran tidak ditemukan.");

    const nilaiSheetName = `db_nilai_${taDeskripsi.replace('/', '-')}`;
    const nilaiSheetApp2 = ss_app2.getSheetByName(nilaiSheetName);
    if (!nilaiSheetApp2) throw new Error(`Sheet nilai '${nilaiSheetName}' tidak ditemukan.`);
    
    const nilaiDataApp2 = nilaiSheetApp2.getDataRange().getValues().slice(1);
    const nilaiMap = new Map();
    nilaiDataApp2.forEach(row => {
      if (row[2] === nama_mapel_app2) { // row[2] = mapel
        nilaiMap.set(String(row[1]), { ujian: row[3], praktek: row[4] }); // no_ujian -> {ujian, praktek}
      }
    });

    // 5. Combine data
    const scoresList = enrolledSiswa
      .map(siswa => {
        const scores = nilaiMap.get(siswa.no_ujian) || { ujian: null, praktek: null };
        return {
          nama: siswa.nama,
          kelas: siswa.kelas,
          no_ujian: siswa.no_ujian,
          nilai_ujian: (scores.ujian === null || scores.ujian === "") ? "-" : scores.ujian,
          nilai_praktek: (scores.praktek === null || scores.praktek === "") ? "-" : scores.praktek
        };
      })
      .sort((a, b) => compareKelas_GS(a.kelas, b.kelas) || a.nama.localeCompare(b.nama)); // Sort by class, then name

    return { status: "sukses", scores: scoresList, mapelInfo: mapelInfo, allKelas: allKelas };
    
  } catch (e) {
    Logger.log("getTeacherSubmittedScores Error: " + e.message + "\n" + e.stack);
    return { status: "gagal", message: e.message };
  }
}

function getStatusKirimSheet(ss_sekolah) {
  const sheetName = 'db_status_kirim';
  let sheet = ss_sekolah.getSheetByName(sheetName);

  if (!sheet) {
    sheet = ss_sekolah.insertSheet(sheetName);
    const headers = [
      "key", "id_tahun_ajaran", "email_guru", "nama_mapel", 
      "timestamp_kirim", "tanggal_ttd", "status_approval", "alasan_tolak"
    ];
    sheet.appendRow(headers);
    sheet.getRange("A1:H1").setFontWeight("bold");
    sheet.setFrozenRows(1);
  } else {
    const headerStatus = sheet.getRange(1, 7).getValue();
    if (headerStatus !== "status_approval") {
      sheet.getRange(1, 7).setValue("status_approval");
      sheet.getRange(1, 8).setValue("alasan_tolak");
    }
  }
  return sheet;
}

function romanToInt_GS(s) {
  if (!s) return 0;
  const map = { 'I': 1, 'V': 5, 'X': 10 };
  let num = 0;
  try {
    for (let i = 0; i < s.length; i++) {
      const curr = map[s[i].toUpperCase()];
      const next = (i + 1 < s.length) ? map[s[i+1].toUpperCase()] : 0;
      if (curr < next) {
        num -= curr;
      } else {
        num += curr;
      }
    }
  } catch(e) { return 0; }
  return num;
}

function getKelasSortValue_GS(className) {
  if (!className) return { type: 'string', value: 999, original: '' };
  
  const romanMatch = className.toUpperCase().match(/\b(XII|XI|X|IX|VIII|VII|VI|V|IV|III|II|I)\b/);
  if (romanMatch) {
    return { 
      type: 'number', 
      value: romanToInt_GS(romanMatch[0]), 
      original: className 
    };
  }
  
  const arabicMatch = className.match(/(\d+)/);
  if (arabicMatch) {
    return { 
      type: 'number', 
      value: parseInt(arabicMatch[0], 10), 
      original: className 
    };
  }
  
  return { type: 'string', value: 999, original: className };
}

function compareKelas_GS(a, b) {
  const valA = getKelasSortValue_GS(a);
  const valB = getKelasSortValue_GS(b);

  if (valA.type === 'number' && valB.type === 'string') return -1;
  if (valA.type === 'string' && valB.type === 'number') return 1;

  if (valA.type === 'number' && valB.type === 'number') {
    if (valA.value !== valB.value) {
      return valA.value - valB.value;
    }
  }
  
  return valA.original.localeCompare(b.original);
}
