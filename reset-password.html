<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
      /* --- CSS DASAR --- */
      :root {
        --primary-color: #0d6efd;
        --success-color: #198754;
        --danger-color: #dc3545;
        --text-muted: #6c757d;
        --border-color: #dee2e6;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        background-color: #f4f6f9;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        padding: 20px;
        box-sizing: border-box;
      }
      .card {
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        width: 100%;
        max-width: 420px;
        text-align: center;
        border: 1px solid var(--border-color);
      }
      h2 { color: #333; margin-top: 0; margin-bottom: 10px; }
      p.desc { font-size: 14px; color: var(--text-muted); margin-bottom: 25px; }
      
      /* --- FORM INPUT --- */
      .form-group { margin-bottom: 20px; text-align: left; position: relative; }
      label { font-size: 14px; font-weight: 500; margin-bottom: 5px; display: block; color: #333; }
      
      .input-wrapper { position: relative; }
      
      input {
        width: 100%; padding: 12px 40px 12px 12px; /* Space for icon */
        border: 1px solid var(--border-color);
        border-radius: 8px;
        box-sizing: border-box; font-size: 16px;
        transition: border-color 0.2s;
      }
      input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.15); }
      input.error { border-color: var(--danger-color); }

      /* --- TOMBOL --- */
      button {
        width: 100%; padding: 12px; background-color: var(--primary-color); color: white;
        border: none; border-radius: 8px; font-size: 16px; cursor: pointer;
        font-weight: bold; transition: 0.2s; display: flex; justify-content: center; align-items: center; gap: 8px;
      }
      button:hover { background-color: #0b5ed7; }
      button:disabled { background-color: #ccc; cursor: not-allowed; }

      /* --- IKON MATA --- */
      .toggle-password {
        position: absolute; right: 12px; top: 50%; transform: translateY(-50%);
        cursor: pointer; color: var(--text-muted); font-size: 16px; z-index: 2;
      }
      .toggle-password:hover { color: var(--primary-color); }

      /* --- TOOLTIP VALIDASI --- */
      .validation-box {
        background: #fff; border: 1px solid var(--border-color);
        border-radius: 8px; padding: 12px; margin-top: 5px; margin-bottom: 15px;
        text-align: left; font-size: 12px;
        display: none; /* Sembunyi default */
      }
      .validation-box.show { display: block; animation: fadeIn 0.3s; }
      .validation-box ul { list-style: none; padding: 0; margin: 0; }
      .validation-box li { margin-bottom: 4px; color: var(--danger-color); display: flex; align-items: center; gap: 8px; transition: color 0.2s; }
      .validation-box li.valid { color: var(--success-color); }
      .validation-box li i { width: 12px; }

      /* --- PESAN ERROR/SUKSES --- */
      .message-box { padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 14px; text-align: left; display: none; }
      .message-box.error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
      .message-box.success { background-color: #d1e7dd; color: #0f5132; border: 1px solid #badbcc; text-align: center; }

      .hidden { display: none !important; }
      
      @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
  </head>
  <body>
    <div class="card">
      
      <? if (valid) { ?>
        <div id="reset-container">
            <h2>Buat Password Baru</h2>
            <p class="desc">Silakan buat password baru yang aman untuk akun Anda.</p>
            
            <div id="global-message" class="message-box"></div>

            <form id="reset-form" onsubmit="handleReset(event)">
              
              <div class="form-group">
                <label>Password Baru</label>
                <div class="input-wrapper">
                  <input type="password" id="new-password" placeholder="Ketik password..." required autocomplete="new-password">
                  <i class="fas fa-eye toggle-password" onclick="togglePass('new-password', this)"></i>
                </div>
                
                <div id="password-rules" class="validation-box">
                  <div style="font-weight:600; margin-bottom:5px; color:#555;">Syarat Password:</div>
                  <ul>
                    <li id="rule-length"><i class="fas fa-circle-xmark"></i> Minimal 8 Karakter</li>
                    <li id="rule-lower"><i class="fas fa-circle-xmark"></i> Huruf Kecil (a-z)</li>
                    <li id="rule-upper"><i class="fas fa-circle-xmark"></i> Huruf Besar (A-Z)</li>
                    <li id="rule-number"><i class="fas fa-circle-xmark"></i> Angka (0-9)</li>
                    <li id="rule-symbol"><i class="fas fa-circle-xmark"></i> Simbol (!@#$...)</li>
                  </ul>
                </div>
              </div>

              <div class="form-group">
                <label>Konfirmasi Password</label>
                <div class="input-wrapper">
                  <input type="password" id="confirm-password" placeholder="Ketik ulang password..." required autocomplete="new-password">
                  <i class="fas fa-eye toggle-password" onclick="togglePass('confirm-password', this)"></i>
                </div>
                <small id="match-error" style="color: var(--danger-color); font-size: 12px; display: none; margin-top: 5px;">
                  <i class="fas fa-circle-exclamation"></i> Password tidak cocok
                </small>
              </div>

              <button type="submit" id="btn-submit" disabled>
                <i class="fas fa-save"></i> Simpan Password Baru
              </button>
            </form>
        </div>
        
        <div id="success-container" class="hidden">
          <i class="fas fa-check-circle" style="font-size: 60px; color: var(--success-color); margin-bottom: 20px;"></i>
          <h2 style="color: var(--success-color);">Berhasil!</h2>
          <p class="desc">Password Anda telah berhasil diperbarui.</p>
          <a href="<?= ScriptApp.getService().getUrl() ?>" target="_top" style="text-decoration: none;">
            <button type="button">Ke Halaman Login</button>
          </a>
        </div>

      <? } else { ?>
        <div class="message-box error" style="display: block; text-align: center;">
          <i class="fas fa-triangle-exclamation" style="font-size: 40px; margin-bottom: 10px;"></i><br>
          <strong>Link Tidak Valid</strong><br>
          <?= message ?>
        </div>
        <a href="<?= ScriptApp.getService().getUrl() ?>" target="_top" style="text-decoration: none;">
            <button type="button" style="background-color: var(--text-muted);">Kembali ke Login</button>
        </a>
      <? } ?>
    </div>

    <script>
      // --- LOGIKA UI ---
      
      // Toggle Lihat Password
      function togglePass(id, icon) {
        const input = document.getElementById(id);
        if (input.type === "password") {
          input.type = "text";
          icon.classList.remove('fa-eye');
          icon.classList.add('fa-eye-slash');
        } else {
          input.type = "password";
          icon.classList.remove('fa-eye-slash');
          icon.classList.add('fa-eye');
        }
      }

      // Validasi Real-time
      const newPassInput = document.getElementById('new-password');
      const confirmPassInput = document.getElementById('confirm-password');
      const rulesBox = document.getElementById('password-rules');
      const btnSubmit = document.getElementById('btn-submit');
      const matchError = document.getElementById('match-error');

      if (newPassInput) {
        newPassInput.addEventListener('focus', () => rulesBox.classList.add('show'));
        
        // Event Listener untuk Input Password Utama
        newPassInput.addEventListener('input', function() {
            validateForm();
        });

        // Event Listener untuk Input Konfirmasi
        confirmPassInput.addEventListener('input', function() {
            validateForm();
        });
      }

      function validateForm() {
          const val = newPassInput.value;
          const confirmVal = confirmPassInput.value;
          
          // 1. Cek Rules
          const rules = {
              length: val.length >= 8,
              lower: /[a-z]/.test(val),
              upper: /[A-Z]/.test(val),
              number: /\d/.test(val),
              symbol: /[^a-zA-Z0-9]/.test(val)
          };

          let allRulesValid = true;

          // Update UI List
          for (const [key, isValid] of Object.entries(rules)) {
              const li = document.getElementById(`rule-${key}`);
              const icon = li.querySelector('i');
              if (isValid) {
                  li.classList.add('valid');
                  icon.className = 'fas fa-check-circle';
              } else {
                  li.classList.remove('valid');
                  icon.className = 'fas fa-circle-xmark';
                  allRulesValid = false;
              }
          }

          // 2. Cek Kecocokan
          let matchValid = false;
          if (confirmVal.length > 0) {
              if (val !== confirmVal) {
                  matchError.style.display = 'block';
                  confirmPassInput.classList.add('error');
                  matchValid = false;
              } else {
                  matchError.style.display = 'none';
                  confirmPassInput.classList.remove('error');
                  matchValid = true;
              }
          } else {
              // Jika kosong, jangan error dulu, tapi jangan valid juga
              matchError.style.display = 'none';
              confirmPassInput.classList.remove('error');
              matchValid = false;
          }

          // 3. Enable/Disable Tombol
          btnSubmit.disabled = !(allRulesValid && matchValid);
      }

      // --- LOGIKA SUBMIT ---
      function handleReset(e) {
        e.preventDefault();
        
        // Validasi akhir sebelum kirim
        if (btnSubmit.disabled) return;

        const p1 = newPassInput.value;
        
        // UI Loading
        btnSubmit.disabled = true;
        btnSubmit.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menyimpan...';
        document.getElementById('global-message').style.display = 'none';
        
        google.script.run
          .withSuccessHandler(function(res) {
             if (res.status === 'sukses') {
               document.getElementById('reset-container').classList.add('hidden');
               document.getElementById('success-container').classList.remove('hidden');
             } else {
               showError(res.message);
               resetBtnState();
             }
          })
          .withFailureHandler(function(err) {
             showError("Terjadi kesalahan koneksi: " + err.message);
             resetBtnState();
          })
          .simpanPasswordBaruAdmin('<?= token ?>', p1);
      }

      function showError(text) {
        const el = document.getElementById('global-message');
        el.innerHTML = '<i class="fas fa-circle-exclamation"></i> ' + text;
        el.className = 'message-box error';
        el.style.display = 'block';
      }

      function resetBtnState() {
        btnSubmit.disabled = false;
        btnSubmit.innerHTML = '<i class="fas fa-save"></i> Simpan Password Baru';
      }
    </script>
  </body>
</html>
